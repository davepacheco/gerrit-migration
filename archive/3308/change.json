{"project":"joyent/manatee","branch":"master","id":"I6e802583f517e74f8e6c1ccab26b01ce2bbbf8f9","number":"3308","subject":"MANATEE-380 would like `manatee-adm promote` MANATEE-393 manatee-adm does not listen for PG errors after connecting MANATEE-417 Manatee should not use the master branch for its state machine dependency Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Approved ","owner":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"url":"https://cr.joyent.us/3308","commitMessage":"MANATEE-380 would like `manatee-adm promote`\nMANATEE-393 manatee-adm does not listen for PG errors after connecting\nMANATEE-417 Manatee should not use the master branch for its state machine dependency\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: Isaac Davis \u003cisaac.davis@joyent.com\u003e\nApproved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1518021806,"lastUpdated":1557250584,"open":false,"status":"MERGED","comments":[{"timestamp":1518021806,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 1."},{"timestamp":1518021836,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520296717,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(14 comments)\n\nI\u0027m sorry this has taken me so long to get to.\n\nMost of my feedback is around messaging and workflow for the operator."},{"timestamp":1521458978,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 2."},{"timestamp":1521459011,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1521459019,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 2:\n\n(14 comments)"},{"timestamp":1521583725,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(9 comments)"},{"timestamp":1523266970,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 3."},{"timestamp":1523266999,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1523267008,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 3:\n\n(8 comments)"},{"timestamp":1523888988,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 4."},{"timestamp":1523889019,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1523889037,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1523892815,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1525971100,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1526050969,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 5."},{"timestamp":1526051000,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n ./deps/javascriptlint/build/install/jsl --nologo --nosummary --conf\u003d./tools/jsl.node.conf ./sitter.js ./backupserver.js ./snapshotter.js ./lib/zfsClient.js ./lib/backupQueue.js ./lib/backupServer.js ./lib/shard.js ./lib/backupSender.js ./lib/snapShotter.js ./lib/confParser.js ./lib/adm.js ./lib/zookeeperMgr.js ./lib/statusServer.js ./lib/postgresMgr.js ./test/confParser.test.js ./test/zookeeperMgr.test.js ./test/testManatee.js ./test/tst.manateeAdm.js ./test/integ.test.js ./test/tst.manateeAdmUsage.js ./test/postgresMgrRepl.js bin/manatee-adm tools/mksitterconfig\n /tmp/repo/sitter.js\n /tmp/repo/backupserver.js\n /tmp/repo/snapshotter.js\n /tmp/repo/lib/zfsClient.js\n /tmp/repo/lib/backupQueue.js\n /tmp/repo/lib/backupServer.js\n /tmp/repo/lib/shard.js\n /tmp/repo/lib/backupSender.js\n /tmp/repo/lib/snapShotter.js\n /tmp/repo/lib/confParser.js\n /tmp/repo/lib/adm.js\n /tmp/repo/lib/zookeeperMgr.js\n /tmp/repo/lib/statusServer.js\n /tmp/repo/lib/postgresMgr.js\n /tmp/repo/test/confParser.test.js\n /tmp/repo/test/zookeeperMgr.test.js\n /tmp/repo/test/testManatee.js\n /tmp/repo/test/tst.manateeAdm.js\n /tmp/repo/test/integ.test.js\n /tmp/repo/test/tst.manateeAdmUsage.js\n /tmp/repo/test/postgresMgrRepl.js\n /tmp/repo/bin/manatee-adm\n /tmp/repo/tools/mksitterconfig\n json --validate -f etc/sitter.json\n json --validate -f etc/backupserver.json\n json --validate -f etc/snapshotter.json\n json --validate -f test/etc/sitter.json\n json --validate -f test/etc/backupserver.json\n json --validate -f test/etc/snapshotter.json\n json --validate -f test/etc/mdata.json\n json --validate -f test/etc/sample-sitter.json\n json --validate -f package.json\n ./deps/jsstyle/jsstyle -f ./tools/jsstyle.conf ./sitter.js ./backupserver.js ./snapshotter.js ./lib/zfsClient.js ./lib/backupQueue.js ./lib/backupServer.js ./lib/shard.js ./lib/backupSender.js ./lib/snapShotter.js ./lib/confParser.js ./lib/adm.js ./lib/zookeeperMgr.js ./lib/statusServer.js ./lib/postgresMgr.js ./test/confParser.test.js ./test/zookeeperMgr.test.js ./test/testManatee.js ./test/tst.manateeAdm.js ./test/integ.test.js ./test/tst.manateeAdmUsage.js ./test/postgresMgrRepl.js bin/manatee-adm tools/mksitterconfig\n Unescaped left brace in regex is deprecated, passed through in regex; marked by \u003c-- HERE in m/\\S{ \u003c-- HERE / at ./deps/jsstyle/jsstyle line 654.\n ./lib/adm.js: 1766: improper block comment\n ./lib/adm.js: 1766: indent by tabs instead of spaces\n Makefile.targ:209: recipe for target \u0027check-jsstyle\u0027 failed\n gmake: *** [check-jsstyle] Error 1"},{"timestamp":1526051160,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 6."},{"timestamp":1526051192,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1526051248,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 6:\n\n(2 comments)"},{"timestamp":1526410290,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6:\n\n(1 comment)\n\nThanks!  I had one more comment about the message.  Sorry to be nitty, but I\u0027m just thinking about operators using this in somewhat tense situations and I think anything we can do to streamline it and make things clear for them is worthwhile."},{"timestamp":1527695370,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 7."},{"timestamp":1527695401,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1527695531,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 7:\n\n(1 comment)\n\nPS7 includes a bump of node-verror from v1.6 to v1.10 which will affect the rest of Manatee. I\u0027m happy to flex a wider range of scenarios in Manatee during IA in order to reduce the risk of this version bump (though checking out CHANGE.md in node-verror didn\u0027t seem to show anything obvious)."},{"timestamp":1527716423,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 7: Code-Review+1\n\n(3 comments)"},{"timestamp":1527759085,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 7:\n\n(2 comments)"},{"timestamp":1529453123,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 7:\n\nI think we\u0027re just waiting on IA for this, right?  Is there an updated set of tests for the latest changes?"},{"timestamp":1529503377,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 8."},{"timestamp":1529503409,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529503597,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 8:\n\nYes, pretty much just IA now! Although I have pushed a change I reverted a while back around the time of the prompt changes. I removed the lagToIgnore flag as I figured the prompt would account for this, but in testing MANATEE-337 I found that I was still being warned that there was \"0m00s\" of lag! I\u0027ve re-introduced this lag-smoothing mechanism in PS8.\n\nMANATEE-337 has proved as a good testing ground for this change, and I indeed plan on writing up some testing notes. If you\u0027re happy to IA, I\u0027ll ping you when they\u0027re ready!"},{"timestamp":1530029243,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 9."},{"timestamp":1530029275,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1530029524,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 9:\n\nIt turns out the being able to tell whether there\u0027s byte lag _and_ time lag with the current ManateeClusterDetails implementation is awkward. Byte lag (sent/flush/etc) is reported on the sender, but time lag is reported by the receiver. This means that to compare them we\u0027d need to track upstream as we loop over peers and this just starts getting hacky.\n\nInstead, I\u0027ve changed this to just report a warning on time lag. This might be confusing in a shard not taking writes, but at least the operator can easily ignore at the prompt, and once MANATEE-356 is done then we\u0027d be able to more accurately determine byte lag (and maybe also ignore a specific amount).\n\nI\u0027d also like to pin the manatee-state-machine release in package.json to a specific hash, which I\u0027ll do after that is merged. I also need to rebase. I\u0027m finishing up some IA notes in the ticket and I\u0027ll ping when that\u0027s done."},{"timestamp":1530031437,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 9:\n\nOk, updated MANATEE-380 with testing notes!"},{"timestamp":1532049027,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 9: Code-Review+1\n\n(1 comment)"},{"timestamp":1532361340,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 10."},{"timestamp":1532361372,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1532361399,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 10:\n\n(1 comment)"},{"timestamp":1536139272,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 11."},{"timestamp":1536139303,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1536140118,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 11:\n\nPS 11 is a rebase against master as of 179a24faf5fac6c477d0459646c78c1fccf4fce8.\n\nA diff against PS 10 shows the changes from the rebase where the same files were changed underneath this change (though not the same lines), which I guess makes sense as the parent commit has changed, but makes it hard to compare. A diff against base doesn\u0027t show these rebased changes and shows just my changes against master."},{"timestamp":1537478266,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 11: Code-Review+1\n\nI only reviewed PS9 -\u003e PS10, assuming that PS11 is a straightforward rebase.  (If you want me to look at that as well, I can do that.)"},{"timestamp":1554800577,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 12: Patch Set 11 was rebased"},{"timestamp":1554800608,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12:\n\n\"make check\" passed ok"},{"timestamp":1554817442,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 13."},{"timestamp":1554817474,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 13: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1555019288,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 13: Code-Review+1"},{"timestamp":1556225121,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 14."},{"timestamp":1556225151,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 14: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556225376,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 14:\n\nI\u0027ve fixed up the copyright dates for the test/tst.manateeAdm* files in PS14.\n\nI also plan on importing manatee-state-machine in package.json with a git SHA (and update commit message with a ticket referencing it), but will do that with integration of the manatee-state-machine change. I\u0027ll be sure to include in a comment here once that\u0027s ready."},{"timestamp":1556225487,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 14: Code-Review+1"},{"timestamp":1556551076,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 15."},{"timestamp":1556551106,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 15: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556551398,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 15:\n\nPS15 imports the manatee-state-machine project via git SHA. I\u0027ve also updated the commit message with a ticket for this, though I haven\u0027t written up any testing notes for that specific part of the change."},{"timestamp":1556649086,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 15: Code-Review+1"},{"timestamp":1556905641,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 15: Integration-Approval+1"},{"timestamp":1557164844,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 15: Integration-Approval+1"},{"timestamp":1557250250,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 15: Integration-Approval+1"},{"timestamp":1557250560,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 16: Commit message was updated."},{"timestamp":1557250584,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Richard Bradley"}],"currentPatchSet":{"number":"16","revision":"6e802583f517e74f8e6c1ccab26b01ce2bbbf8f9","parents":["33b33433070e1c83622ca6a555b4bc38f1eec0e6"],"ref":"refs/changes/08/3308/16","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1557250560,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556551106,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556649086,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1556905641,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557164844,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557250250,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1557250584,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":13,"deletions":0},{"file":"bin/manatee-adm","type":"MODIFIED","insertions":107,"deletions":-35},{"file":"docs/man/manatee-adm.md","type":"MODIFIED","insertions":74,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":480,"deletions":-1},{"file":"man/man1/manatee-adm.1","type":"MODIFIED","insertions":89,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/tst.manateeAdmUsage.js","type":"MODIFIED","insertions":12,"deletions":-2}],"sizeInsertions":763,"sizeDeletions":-43},"patchSets":[{"number":"1","revision":"4acb16771735de18138de0d74cf4d492e695a74f","parents":["729d799b844630f8f6eb34dcbaf3ae7fdfd3bf7f"],"ref":"refs/changes/08/3308/1","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1518021806,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1518021836,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/manatee-adm","line":917,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Should we call this a \"request\" here?"},{"file":"bin/manatee-adm","line":917,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Yes, good point. I\u0027ve changed this to \"request\"."},{"file":"docs/man/manatee-adm.md","line":349,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"How about phrasing this as initiating a request to promote the specified peer, and that that request will be executed by the primary or sync?  Does the command wait for that to happen?\n\nI think it might be worth spelling out the impact: that if this is a sync or the first async, then the data path will be affected similarly to if the node in front of it had failed.\n\nIt might also be worth pointing out that in the sync case when the primary is deposed, it will have to be rebuilt, too.\n\nCould we add an example or two?\n\nI would also explain which combination of arguments are required -- and why.  As I understand it, --zonename and --role are required if this is a sync, and --asyncIndex is also required for an async, and the reason is to avoid any possible race between the operator\u0027s decision and the request to execute it."},{"file":"docs/man/manatee-adm.md","line":349,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Agreed here! I\u0027ve fleshed out this section a little more."},{"file":"docs/man/manatee-adm.md","line":349,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Thanks.  This new text looks great."},{"file":"docs/man/manatee-adm.md","line":366,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This is worth elaborating on.  I don\u0027t think operators know about this as an \"object\" -- it seems more like a request.  As an operator, I\u0027d want to know: under what conditions would I need to use this?  How do I know if I\u0027ve hit them?  How do I know this has succeeded?  And what\u0027s the impact, if any?"},{"file":"docs/man/manatee-adm.md","line":366,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Agreed in general about not referring to it as an \"object\". I\u0027ve re-worded this sentence and expanded on what this subcommand is used for."},{"file":"lib/adm.js","line":1642,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Missing parenthesis here?  Also \"Cluter\" should be \"Cluster\"."},{"file":"lib/adm.js","line":1642,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"},{"file":"lib/adm.js","line":1646,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Why does this mechanism use a different pattern than what\u0027s used elsewhere?"},{"file":"lib/adm.js","line":1646,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"It seems that this stems from older subcommands (e.g. \"manatee-adm status\") being able to obtain state of all shards under \"/manatee\" and display a single shard if need be (using the SHARD environment variable).\n\nWhen using the _getState and _putState functions in this file to write the state object to ZooKeeper, they work against a single shard. However, _getClusterStates, _addPostgresStatus, and the ManateeClusterDetails interface expect multiple shards in the argument that they pass around in this pipeline.\n\nIt\u0027s a little confusing because ManateeClusterDetails is a nice interface to Manatee\u0027s status and it will only pull details of a single shard anyway, but the various details that it requires (postgres status, shard state) are all obtained via _getShards, _addPostgresStatus, etc., which work against multiple shards. I believe they also mutate the original state object, meaning if we used the _putState helper we\u0027d put an object that contains things like PostgreSQL status, too.\n\nThe reason I\u0027m using a different mechanism here is because I want to make use of both paths: I want to use ManateeClusterDetails _and_ I want to get/put cluster state. It\u0027s not something that I\u0027m entirely happy with, and perhaps some refactoring is in order. If an operator needs to view state of other shards then we should provide tooling for that (MANTA-3164?)."},{"file":"lib/adm.js","line":1646,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Okay.  Thanks for the explanation."},{"file":"lib/adm.js","line":1685,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is asyncIndex always a number here, or is this relying on the fact that \"undefined \u003e\u003d 0\" being false?"},{"file":"lib/adm.js","line":1685,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"The cmdln options previous will ensure this is a number, but if they\u0027re not provided then this does indeed rely on your stated fact.\n\nI\u0027ve made this more explicit that we\u0027re not only checking for a number, but also that it\u0027s a positive value."},{"file":"lib/adm.js","line":1695,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Could we make this more explicit -- maybe something like \"asyncIndex cannot be specified with role \u0027$role\u0027\"?"},{"file":"lib/adm.js","line":1695,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"},{"file":"lib/adm.js","line":1755,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"We may want overrides for these, since you might want to promote something because its upstream isn\u0027t working."},{"file":"lib/adm.js","line":1755,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Agreed! I\u0027ll put something together to override these checks, as well as the replication one. I think it would be OK to class errors, warnings, and lag as ignorable issues.\n\nI\u0027m struggling a little bit with making sure all of this information gets to the user of the CLI in one go so that they don\u0027t accidentally ignore subsequent errors, but I\u0027ll see what I can put together."},{"file":"lib/adm.js","line":1755,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It looks like the current version doesn\u0027t prompt for confirmation, so it\u0027s possible to accidentally ignore the wrong errors.  Is there another one coming or is that deferred for now (or did I just miss it)?"},{"file":"lib/adm.js","line":1755,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"PS2\u0027s change to lib/adm.js (L1747) lumps all of these errors (warnings, errors and lag) into an \"errors\" list and passes this back to bin/manatee-adm, which subsequently prints each one individually with the intention that the operator can make an informed decision to ignore all of these errors.\n\nHowever, it\u0027s still possible to accidentally ignore the wrong errors as things can change between 2 runs of the CLI (with and without ignore flag).\n\nLet me know if this is what you had in mind in PS2. I\u0027d be happy to make this into a confirmation prompt instead (perhaps one per set of errors, warnings, or lag)."},{"file":"lib/adm.js","line":1755,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I\u0027d definitely prefer the prompt approach to avoid the race.  I\u0027m not sure if it\u0027s strictly required or not.  What do you think?"},{"file":"lib/adm.js","line":1755,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"No problem! I agree on the prompt, so I\u0027ve removed the additional \"ignore\" flags and simply provided the output in a prompt instead, which feels a bit better. The new prompt will be in PS6."},{"file":"lib/adm.js","line":1775,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Does this prevent promotion when there\u0027s any lag at all?  I think we might just want to warn the operator for these cases and ask for confirmation."},{"file":"lib/adm.js","line":1775,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Yes, this would prevent a promotion if there was non-zero byte lag (indicated by differing LSNs), but non-zero time lag where LSNs match wouldn\u0027t prevent a promotion.\n\nI\u0027ve included this in the override flag that I\u0027ve added, but if you\u0027d prefer to see this as an additional confirmation instead then I\u0027ll see what I can do!"},{"file":"lib/adm.js","line":1784,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It\u0027s very good that we mention this, but I wonder if we can make it a little more actionable.  Maybe mention that this operation may impact database service and the operator should consult the manual page for details?"},{"file":"lib/adm.js","line":1784,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Agreed! I\u0027ll refer to the man page here, where I\u0027ll add some sync and async promotion scenarios and expected consequences."},{"file":"lib/adm.js","line":1817,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"5 seconds seems a little too aggressive.  What about 30 seconds or a minute?  Can we make this a flag that can be overridden from the CLI?"},{"file":"lib/adm.js","line":1817,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I\u0027ve upped the expireTime to 30s, but not added a method of allowing the operator to supply this value just yet.\n\nTesting this has uncovered some fixes required in my joyent/manatee-state-machine change."},{"file":"lib/adm.js","line":1838,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"What do you think of this command continuing to monitor indefinitely, but maybe reporting a warning after 10 seconds (instead of stopping)?  My experience with a lot of these long-running commands is that when they just needed more time, or maybe needed my intervention, it\u0027s annoying when they\u0027ve bailed partway through.  And the operator can always kill it.  But it\u0027s still useful to notify the operator that it\u0027s unexpected, as you\u0027ve got here."},{"file":"lib/adm.js","line":1838,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"My comment in MANATEE-380 details where I really wanted this to be, but I felt it was taking too long to flesh out something that dealt with the many edge cases that can come up. I am planning on revisiting it separately with a more generic cluster watcher that\u0027ll report success when ManateeClusterDetails fits a certain set of expectations, which could also be used by other parts of the CLI.\n\nHappy to have this watch indefinitely for now."},{"file":"lib/adm.js","line":1881,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Probably should be \"C\".  We may want to flesh this out, too: \"Check logs for the manatee-sitter service for more information.\""},{"file":"lib/adm.js","line":1881,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done."},{"file":"lib/adm.js","line":2115,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Does `end()` at L2110 guarantee we won\u0027t get \u0027error\u0027 here?  If we get this error here, and the callback to query() hasn\u0027t been invoked yet, are we somehow guaranteed that it won\u0027t be invoked?\n\nI think Cody has looked into some of the node-pg behavior around fatal connection-level errors."},{"file":"lib/adm.js","line":2115,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Good point, and I don\u0027t know if this is guaranteed. Is this a case where it makes sense to use the \"once\" library?\n\nI\u0027ll also see about syncing up with Cody."},{"file":"lib/adm.js","line":2115,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"`\u0027once\u0027` might be appropriate for a case like this, though I usually prefer to just add an explicit boolean, if for no other reason than because `\u0027once\u0027` is so ripe for future abuse."},{"file":"lib/adm.js","line":2115,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"It looks like we actually already make use of the `once` library for this callback (L2089)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manatee-adm","type":"MODIFIED","insertions":85,"deletions":-1},{"file":"docs/man/manatee-adm.md","type":"MODIFIED","insertions":21,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":348,"deletions":-1},{"file":"man/man1/manatee-adm.1","type":"MODIFIED","insertions":21,"deletions":-1},{"file":"test/tst.manateeAdmUsage.js","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":486,"sizeDeletions":-5},{"number":"2","revision":"d8b8d62e5a8a906ec74a5dbebeaf9fbdeed3bf2a","parents":["729d799b844630f8f6eb34dcbaf3ae7fdfd3bf7f"],"ref":"refs/changes/08/3308/2","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1521458978,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1521459011,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/manatee-adm","line":866,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Should this include \"err\" as a cause?"},{"file":"bin/manatee-adm","line":866,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Possibly for completeness, but as this is the error that\u0027s passed back to cmdln, it would end up repeating information that has already been printed to stderr, and only on one line. This is what I was trying to avoid and expand on in the above section.\n\nHowever, I realise now that I\u0027ve been incorrectly working against verror@0.10 here, and 0.6 doesn\u0027t have the `errors()` or `errorForEach()` methods. What do you think about bumping the node-verror dependency version to 0.10 in this change? I\u0027d be happy to document specific testing around this, but it would affect the rest of manatee."},{"file":"bin/manatee-adm","line":866,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Seeing as I\u0027m already bending around the node-verror@0.6 API by reaching into jse_shortmsg, I\u0027ve changed this so that instead of calling `errors()` on the error I\u0027m calling ase_errors instead (`errors()` isn\u0027t available in 0.6).\n\nI don\u0027t really like doing this, but I think it\u0027s probably smaller in scope than upgrading to 0.10 across the project, and it would be good to get some node-verror changes in for more human-friendly message exploration before doing this kind of upgrade and testing."},{"file":"bin/manatee-adm","line":866,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Correction: the version numbers here should read 1.6 and 1.10 (not 0.6 and 0.10)."},{"file":"bin/manatee-adm","line":867,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Instead of all of this, can you just use something like:\n\n    VError.errorForEach(err, function (suberr) {\n            console.error(\u0027warn: %s\u0027, suberr.message);\n    });\n\nor is the problem that it might be one of the causes that\u0027s the MultiError instead of `err` itself?  Still, I wonder if we should add something to `verror` for this.  It wouldn\u0027t be a blocker here, but it feels like a gap if callers are required to do special things with MultiError."},{"file":"bin/manatee-adm","line":867,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"For context, I filed https://github.com/joyent/node-verror/issues/52 for this. Yes, the top level error here is a VError, and its cause is a MultiError.\n\nWhat I was trying to do here was avoid the \"first of 3 errors:\" summaries that are included in the \"message\" when looping over these errors because I want the operator to see all of them on the CLI. Arguably this should be going arbitrarily deep, but I believe 1 level is enough to at least prompt an operator to check for specific errors manually.\n\nI\u0027ve noted in a comment above how I was accidentally working against 0.10 here, so short of a version bump I think I\u0027m going to be in a little bit of pain trying to unravel these errors, but I\u0027m not sure of a better way of printing these errors without lib/adm.js printing to stderr directly."},{"file":"docs/man/manatee-adm.md","line":375,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think it\u0027s good that we can override this, but I think it\u0027d be worthwhile to allow for a small bit of lag without even issuing a warning, since I suspect in SPC there\u0027s probably always a bit of lag."},{"file":"docs/man/manatee-adm.md","line":375,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Agreed! I can do some research into SPC/JPC to see what kind of running lag we have there, but do you have any ideas on the amount we\u0027d be OK with? Presumably a percentage of some value makes sense given that varying workloads Manatee can see (Triton).\n\nWhen I tested this, I `pstop`\u0027d one of the sides of the WAL stream, which might actually be too aggressive. It might be the case that by comparing sent and flush (not replay) would be enough to allow us some level of lag, which in this case would be replay lag, not flush lag. I\u0027ll check this out!"},{"file":"docs/man/manatee-adm.md","line":375,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"While testing this I found that it appeared inconsistent on whether we could perform a promotion or not across subsequent attempts, when my shard was being stressed with manta-mdshovel. Sometimes we\u0027d see the LSN difference, sometimes we wouldn\u0027t, even with 0s lag.\n\nTo smooth this out I\u0027ve added an option to provide the amount of lag in seconds that we deem appropriate for this promotion, which defaults to 5s if no value is provided. SPC doesn\u0027t seem to see more than 0s of lag even if the LSNs differ, so adding a check for lag in seconds as well as LSN difference seems to work OK.\n\nIf we have any more than 5s of lag in a cluster that _also_ sees differing LSNs (i.e. it\u0027s actively taking writes, not idle) then we\u0027ll warn the operator and prompt for a specific value of lag to ignore. I\u0027ve also made it so that this class of errors are deemed separate from those ignored by `--ignoreWarnings`."},{"file":"docs/man/manatee-adm.md","line":413,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Extra \".\"."},{"file":"docs/man/manatee-adm.md","line":413,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"},{"file":"docs/man/manatee-adm.md","line":421,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I found this a little confusing.  Is this just talking about cases where some peers have not yet been updated?"},{"file":"docs/man/manatee-adm.md","line":421,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Yes, pretty much. I found this a little hard to explain and is probably a bad example.\n\nI\u0027ve removed this section and kept the single example above."},{"file":"lib/adm.js","line":1747,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"\"the\""},{"file":"lib/adm.js","line":1747,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manatee-adm","type":"MODIFIED","insertions":104,"deletions":-1},{"file":"docs/man/manatee-adm.md","type":"MODIFIED","insertions":76,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":361,"deletions":-1},{"file":"man/man1/manatee-adm.1","type":"MODIFIED","insertions":91,"deletions":-3},{"file":"test/tst.manateeAdmUsage.js","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":643,"sizeDeletions":-7},{"number":"3","revision":"19f41c11d34fb616959e527e2d6896fdc708e9e6","parents":["729d799b844630f8f6eb34dcbaf3ae7fdfd3bf7f"],"ref":"refs/changes/08/3308/3","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1523266970,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1523266999,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manatee-adm","type":"MODIFIED","insertions":104,"deletions":-1},{"file":"docs/man/manatee-adm.md","type":"MODIFIED","insertions":71,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":361,"deletions":-1},{"file":"man/man1/manatee-adm.1","type":"MODIFIED","insertions":86,"deletions":-3},{"file":"test/tst.manateeAdmUsage.js","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":633,"sizeDeletions":-7},{"number":"4","revision":"6bd2c2f631e747b7c99fbb52cce57214d30ae7c4","parents":["729d799b844630f8f6eb34dcbaf3ae7fdfd3bf7f"],"ref":"refs/changes/08/3308/4","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1523888988,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1523889019,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/manatee-adm","line":863,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think you can use `VError.cause()` here, which will work even if `err` is not a VError.  I think you may want to use `VError.errorForEach` rather than `ase_errors`, which is supposed to be private."},{"file":"bin/manatee-adm","line":863,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I admit that these changes weren\u0027t that great! I did it because `VError.cause()` was introduced in v1.7.0, and `VError.errorForEach()` in v1.10.0. joyent/manatee\u0027s node-verror dependency is v1.6.0.\n\nHowever, lib/adm.js now handles these messages in its new warnings prompt, so passing a MultiError back to bin/manatee-adm is no longer required in PS6."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manatee-adm","type":"MODIFIED","insertions":111,"deletions":-1},{"file":"docs/man/manatee-adm.md","type":"MODIFIED","insertions":80,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":371,"deletions":-1},{"file":"man/man1/manatee-adm.1","type":"MODIFIED","insertions":95,"deletions":-3},{"file":"test/tst.manateeAdmUsage.js","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":668,"sizeDeletions":-7},{"number":"5","revision":"1b5d393c5e7abffccf9d45b32b299cf342f79510","parents":["729d799b844630f8f6eb34dcbaf3ae7fdfd3bf7f"],"ref":"refs/changes/08/3308/5","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1526050969,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1526051000,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manatee-adm","type":"MODIFIED","insertions":85,"deletions":-1},{"file":"docs/man/manatee-adm.md","type":"MODIFIED","insertions":68,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":397,"deletions":-1},{"file":"man/man1/manatee-adm.1","type":"MODIFIED","insertions":83,"deletions":-3},{"file":"test/tst.manateeAdmUsage.js","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":644,"sizeDeletions":-7},{"number":"6","revision":"b5bdd60aef9abf0da1cdeffb162865dd524c1184","parents":["729d799b844630f8f6eb34dcbaf3ae7fdfd3bf7f"],"ref":"refs/changes/08/3308/6","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1526051160,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1526051192,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/adm.js","line":1782,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Can we quantify this in the message?"},{"file":"lib/adm.js","line":1782,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"This is quantified in each peer\u0027s lag VError on L1775. I realised thought that I was still squashing these messages behind VError\u0027s message property, but WError is cleaner for this. However, it required verror@1.10, so I\u0027ve gone ahead and bumped the version.\n\nHere\u0027s an example of what this would look like at PS7:\n\n    The cluster is currently experiencing a number of warnings and/or errors.  Review the following and determine if they can be ignored.\n     - cluster is exhibiting lag\n       - \"peer1-99283849-29e6-6da8-fd15-b6643a0ae439\" has 10s of lag to its downstream peer\n       - \"peer2-99283849-29e6-6da8-fd15-b6643a0ae439\" has 2682s of lag to its downstream peer\n       - \"peer3-99283849-29e6-6da8-fd15-b6643a0ae439\" has 2682s of lag to its downstream peer\n    Ignore warning(s)?: no:"},{"file":"lib/adm.js","line":1782,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Thanks.  I missed that this was in the existing errors.  That makes sense."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manatee-adm","type":"MODIFIED","insertions":85,"deletions":-1},{"file":"docs/man/manatee-adm.md","type":"MODIFIED","insertions":68,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":397,"deletions":-1},{"file":"man/man1/manatee-adm.1","type":"MODIFIED","insertions":83,"deletions":-3},{"file":"test/tst.manateeAdmUsage.js","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":644,"sizeDeletions":-7},{"number":"7","revision":"2be001b1b904270fe31d4816be05ba5afee2931a","parents":["729d799b844630f8f6eb34dcbaf3ae7fdfd3bf7f"],"ref":"refs/changes/08/3308/7","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1527695370,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527716423,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527695401,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/adm.js","line":1754,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Why make this a WError?  I thought that was mainly for APIs where you don\u0027t want to provide an internal message to an end user, but you still want to be able to log the full error."},{"file":"lib/adm.js","line":1754,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I\u0027ve used WError here because I know that the consumer of these errors (promptForWarnings on L1789) can handle VError\u0027s cause mechanism, and printVErrorIter does that in order to print a human-friendly message to the terminal. In this case, I\u0027m trying to avoid this section of node-verror: https://github.com/joyent/node-verror/blob/ecddeda07827742bd2c598033a02f4c42a6fdc26/lib/verror.js#L180-L187\n\nThe alternative is that the VErrors would be full of \"first of 3 errors: ...\" that populate the top-level error\u0027s message and would be repeated as the iterator makes its way down the nested VErrors. As far as I could tell, there was no way to get the \"shortmessage\" that we parse (short of abusing jse_shortmsg), and WError seemed like it suited this use case (to an extent).\n\nBasically, I\u0027m \"hiding\" the sub-errors with WError because I know that the consumer is VError-aware and will log/print the full error itself, if that makes sense?"},{"file":"lib/adm.js","line":2409,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This functionality looks really useful...it\u0027s just unfortunate that it has to be written here, since it\u0027s pretty general-purpose.  Maybe we should file a VError ticket for a similar utility function there?"},{"file":"lib/adm.js","line":2409,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Sounds good to me! I\u0027ve opened this as https://github.com/joyent/node-verror/issues/54."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manatee-adm","type":"MODIFIED","insertions":85,"deletions":-1},{"file":"docs/man/manatee-adm.md","type":"MODIFIED","insertions":68,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":427,"deletions":-1},{"file":"man/man1/manatee-adm.1","type":"MODIFIED","insertions":83,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/tst.manateeAdmUsage.js","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":675,"sizeDeletions":-8},{"number":"8","revision":"71c840ea41b57e79d1560397c082236096fcdf5d","parents":["729d799b844630f8f6eb34dcbaf3ae7fdfd3bf7f"],"ref":"refs/changes/08/3308/8","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1529503377,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529503409,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manatee-adm","type":"MODIFIED","insertions":93,"deletions":-1},{"file":"docs/man/manatee-adm.md","type":"MODIFIED","insertions":74,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":433,"deletions":-1},{"file":"man/man1/manatee-adm.1","type":"MODIFIED","insertions":89,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/tst.manateeAdmUsage.js","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":701,"sizeDeletions":-8},{"number":"9","revision":"eb1c402278f7206923aa94e46b632498eb66b803","parents":["729d799b844630f8f6eb34dcbaf3ae7fdfd3bf7f"],"ref":"refs/changes/08/3308/9","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1530029243,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1532049027,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530029275,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/adm.js","line":2454,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is this copied from somewhere?  Could it share code with the corresponding manatee-adm display code?"},{"file":"lib/adm.js","line":2454,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"It could! In PS10 I\u0027ve changed pgDuration to make use of this function and re-convert the number of seconds to the string format it defines. The multiple conversions are probably better than 2 parsers that do similar things.\n\nThere\u0027s a few bits from bin/manatee-adm that could make their way into lib/adm.js and be used this way (such as having lib/adm.js print the cluster summary directly), but I\u0027ve not really looked too hard at that and I think it would best be kept to a future change."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manatee-adm","type":"MODIFIED","insertions":93,"deletions":-1},{"file":"docs/man/manatee-adm.md","type":"MODIFIED","insertions":74,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":473,"deletions":-1},{"file":"man/man1/manatee-adm.1","type":"MODIFIED","insertions":89,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/tst.manateeAdmUsage.js","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":741,"sizeDeletions":-8},{"number":"10","revision":"b9326b40a3253bd25a777bdafea697f3353039cd","parents":["729d799b844630f8f6eb34dcbaf3ae7fdfd3bf7f"],"ref":"refs/changes/08/3308/10","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1532361340,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532361372,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manatee-adm","type":"MODIFIED","insertions":107,"deletions":-35},{"file":"docs/man/manatee-adm.md","type":"MODIFIED","insertions":74,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":479,"deletions":-1},{"file":"man/man1/manatee-adm.1","type":"MODIFIED","insertions":89,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/tst.manateeAdmUsage.js","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":761,"sizeDeletions":-42},{"number":"11","revision":"2634743964b36feea25041d2f5d6c597dd23fbbc","parents":["179a24faf5fac6c477d0459646c78c1fccf4fce8"],"ref":"refs/changes/08/3308/11","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1536139272,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1537478266,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536139303,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manatee-adm","type":"MODIFIED","insertions":107,"deletions":-35},{"file":"docs/man/manatee-adm.md","type":"MODIFIED","insertions":74,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":479,"deletions":0},{"file":"man/man1/manatee-adm.1","type":"MODIFIED","insertions":89,"deletions":-3},{"file":"test/tst.manateeAdmUsage.js","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":760,"sizeDeletions":-40},{"number":"12","revision":"36d31dd06b09d20c6acf0a5a9e1dc795b3358668","parents":["33b33433070e1c83622ca6a555b4bc38f1eec0e6"],"ref":"refs/changes/08/3308/12","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1554800577,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1537478266,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536139303,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manatee-adm","type":"MODIFIED","insertions":107,"deletions":-35},{"file":"docs/man/manatee-adm.md","type":"MODIFIED","insertions":74,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":479,"deletions":0},{"file":"man/man1/manatee-adm.1","type":"MODIFIED","insertions":89,"deletions":-3},{"file":"test/tst.manateeAdmUsage.js","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":760,"sizeDeletions":-40},{"number":"13","revision":"7ffce100bcee37f00d54a1090715ed998473be99","parents":["33b33433070e1c83622ca6a555b4bc38f1eec0e6"],"ref":"refs/changes/08/3308/13","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1554817442,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555019288,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1554817474,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manatee-adm","type":"MODIFIED","insertions":107,"deletions":-35},{"file":"docs/man/manatee-adm.md","type":"MODIFIED","insertions":74,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":480,"deletions":-1},{"file":"man/man1/manatee-adm.1","type":"MODIFIED","insertions":89,"deletions":-3},{"file":"test/tst.manateeAdm.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/tst.manateeAdmUsage.js","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":762,"sizeDeletions":-42},{"number":"14","revision":"4d2b4ffa32077e19f25c1b6b86c96f878c9648cd","parents":["33b33433070e1c83622ca6a555b4bc38f1eec0e6"],"ref":"refs/changes/08/3308/14","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1556225121,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556225487,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556225151,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manatee-adm","type":"MODIFIED","insertions":107,"deletions":-35},{"file":"docs/man/manatee-adm.md","type":"MODIFIED","insertions":74,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":480,"deletions":-1},{"file":"man/man1/manatee-adm.1","type":"MODIFIED","insertions":89,"deletions":-3},{"file":"test/tst.manateeAdmUsage.js","type":"MODIFIED","insertions":12,"deletions":-2}],"sizeInsertions":762,"sizeDeletions":-42},{"number":"15","revision":"47a2857ae50ffe19352d85940d0d90838339697a","parents":["33b33433070e1c83622ca6a555b4bc38f1eec0e6"],"ref":"refs/changes/08/3308/15","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1556551076,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556649086,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557164844,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557250250,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556551106,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1556905641,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"bin/manatee-adm","type":"MODIFIED","insertions":107,"deletions":-35},{"file":"docs/man/manatee-adm.md","type":"MODIFIED","insertions":74,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":480,"deletions":-1},{"file":"man/man1/manatee-adm.1","type":"MODIFIED","insertions":89,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/tst.manateeAdmUsage.js","type":"MODIFIED","insertions":12,"deletions":-2}],"sizeInsertions":763,"sizeDeletions":-43},{"number":"16","revision":"6e802583f517e74f8e6c1ccab26b01ce2bbbf8f9","parents":["33b33433070e1c83622ca6a555b4bc38f1eec0e6"],"ref":"refs/changes/08/3308/16","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1557250560,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556649086,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557164844,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557250250,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556551106,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1557250584,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1556905641,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":13,"deletions":0},{"file":"bin/manatee-adm","type":"MODIFIED","insertions":107,"deletions":-35},{"file":"docs/man/manatee-adm.md","type":"MODIFIED","insertions":74,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":480,"deletions":-1},{"file":"man/man1/manatee-adm.1","type":"MODIFIED","insertions":89,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/tst.manateeAdmUsage.js","type":"MODIFIED","insertions":12,"deletions":-2}],"sizeInsertions":763,"sizeDeletions":-43}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}]}