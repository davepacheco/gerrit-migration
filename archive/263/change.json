{"project":"joyent/sdc-cnapi","branch":"master","id":"I15d7956333e5c34bfdf8fd6f827ae03043f6174c","number":"263","subject":"CNAPI-662 CNAPI-663 add support for paging to server ticket list","owner":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"url":"https://cr.joyent.us/263","commitMessage":"CNAPI-662 CNAPI-663 add support for paging to server ticket list\n","createdOn":1470821272,"lastUpdated":1472852548,"open":false,"status":"MERGED","comments":[{"timestamp":1470821272,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 1."},{"timestamp":1470821305,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1470846758,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 2."},{"timestamp":1470846791,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1470958355,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 3."},{"timestamp":1470958392,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1471293597,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 4."},{"timestamp":1471293631,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1471294533,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 5."},{"timestamp":1471294569,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1471300464,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1471367099,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 7."},{"timestamp":1471367132,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1471371179,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 6:\n\n(14 comments)"},{"timestamp":1471389928,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 6:\n\n(11 comments)"},{"timestamp":1471449610,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 6:\n\n(3 comments)"},{"timestamp":1471450072,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 7:\n\n(1 comment)"},{"timestamp":1471450358,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 7:\n\nAlso, just to make sure: what are the clients of the endpoint that lists waitlist tickets? Is it only operators running \"sdc-cnapi /servers/server-uuid/tickets\" manually? If so, then there\u0027s no client to update and it\u0027s fine. If not there\u0027ll be clients that need to be updated.\n\nnode-sdc-clients doesn\u0027t seem to have an API to list waitlist tickets, so that part should be fine."},{"timestamp":1471451532,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 7:\n\nAs discussed previously, ideally the ListTickets endpoint would use a marker instead of an offset, but support for an offset seems to be a good improvement provided that:\n\n1. Having the ListTickets endpoint return duplicate entries is not critical.\n\n2. We don\u0027t expect the set of tickets to be included in the response to be very large: the performance of using an offset instead of a marker based on an indexed attribute is much poorer on a large dataset."},{"timestamp":1471908193,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 8."},{"timestamp":1471908231,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1472066200,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 8:\n\n(3 comments)"},{"timestamp":1472165447,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 9."},{"timestamp":1472165479,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1472233574,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 9: Code-Review+1\n\n(8 comments)\n\nI\u0027ve added some more comments. I think this is overall a good improvement and most of my remaining concerns can be addressed in followup tickets."},{"timestamp":1472465830,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 10."},{"timestamp":1472465911,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1472497266,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 11."},{"timestamp":1472497329,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1472748186,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 11: Code-Review+1\n\n(2 comments)"},{"timestamp":1472844716,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 12."},{"timestamp":1472844760,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1472845839,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 12: Code-Review+1"},{"timestamp":1472852544,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 12: Integration-Approval+1\n\n(1 comment)"},{"timestamp":1472852548,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Orlando Vazquez"}],"currentPatchSet":{"number":"12","revision":"15d7956333e5c34bfdf8fd6f827ae03043f6174c","parents":["550a06b14033adfa74a0ff5d2035180df7d1f744"],"ref":"refs/changes/63/263/12","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1472844716,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472844760,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1472845839,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1472852544,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"SUBM","value":"1","grantedOn":1472852548,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"docs/index.md","type":"MODIFIED","insertions":22,"deletions":-3},{"file":"docs/index/index.md.ejs","type":"MODIFIED","insertions":12,"deletions":-3},{"file":"docs/static.md","type":"MODIFIED","insertions":10,"deletions":0},{"file":"lib/endpoints/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/endpoints/waitlist.js","type":"MODIFIED","insertions":74,"deletions":-18},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":190,"deletions":-37},{"file":"lib/validation/endpoints.js","type":"MODIFIED","insertions":25,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":6,"deletions":-5},{"file":"test/waitlist/test-waitlist.js","type":"MODIFIED","insertions":318,"deletions":-8}],"sizeInsertions":660,"sizeDeletions":-78},"patchSets":[{"number":"1","revision":"cc43f67df43689cce39881789ec265f579190457","parents":["550a06b14033adfa74a0ff5d2035180df7d1f744"],"ref":"refs/changes/63/263/1","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1470821272,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1470821305,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/waitlist/test-waitlist.js","line":459,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/endpoints/waitlist.js","type":"MODIFIED","insertions":40,"deletions":-17},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":35,"deletions":-8},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/waitlist/test-waitlist.js","type":"MODIFIED","insertions":134,"deletions":-8}],"sizeInsertions":212,"sizeDeletions":-36},{"number":"2","revision":"cf3378c2718c875736d64621c878f19b1d2640e9","parents":["550a06b14033adfa74a0ff5d2035180df7d1f744"],"ref":"refs/changes/63/263/2","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1470846758,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1470846791,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/endpoints/waitlist.js","type":"MODIFIED","insertions":40,"deletions":-17},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":35,"deletions":-8},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/waitlist/test-waitlist.js","type":"MODIFIED","insertions":135,"deletions":-8}],"sizeInsertions":213,"sizeDeletions":-36},{"number":"3","revision":"d31afe8b684dbb22169c1fe2d58374a9438dfb8c","parents":["550a06b14033adfa74a0ff5d2035180df7d1f744"],"ref":"refs/changes/63/263/3","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1470958355,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1470958392,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/endpoints/waitlist.js","type":"MODIFIED","insertions":41,"deletions":-18},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":35,"deletions":-8},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/waitlist/test-waitlist.js","type":"MODIFIED","insertions":135,"deletions":-8}],"sizeInsertions":214,"sizeDeletions":-37},{"number":"4","revision":"2948e4e7c037b290b8bc13a9a3e481665ae4cf15","parents":["550a06b14033adfa74a0ff5d2035180df7d1f744"],"ref":"refs/changes/63/263/4","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1471293597,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1471293631,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/endpoints/waitlist.js","type":"MODIFIED","insertions":41,"deletions":-18},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":172,"deletions":-26},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/waitlist/test-waitlist.js","type":"MODIFIED","insertions":252,"deletions":-8}],"sizeInsertions":468,"sizeDeletions":-55},{"number":"5","revision":"18ac6360ff75e6855d4a6eb15d6d1534933af545","parents":["550a06b14033adfa74a0ff5d2035180df7d1f744"],"ref":"refs/changes/63/263/5","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1471294533,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1471294569,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/endpoints/waitlist.js","type":"MODIFIED","insertions":41,"deletions":-18},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":172,"deletions":-26},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/waitlist/test-waitlist.js","type":"MODIFIED","insertions":247,"deletions":-8}],"sizeInsertions":463,"sizeDeletions":-55},{"number":"6","revision":"fbdad2a7f4678860808981076e00e56dd28142a5","parents":["550a06b14033adfa74a0ff5d2035180df7d1f744"],"ref":"refs/changes/63/263/6","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1471300464,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1471294569,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/endpoints/waitlist.js","line":64,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is there some validation done on these request parameters?"},{"file":"lib/endpoints/waitlist.js","line":64,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Will add."},{"file":"lib/models/waitlist.js","line":352,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Does that mean that there\u0027s no limit on that deleteMany moray request? If so it may be worth it to add a comment, and/or to explicitly set the \"limit\" property of that \"opts\" object to a value that means \"unlimited\"."},{"file":"lib/models/waitlist.js","line":352,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Actually, I don\u0027t need this particular change, it was something I was trying on the side that snuck in. It\u0027ll be gone. I do think using a special \"unlimited\" limit to highlight how the behaviour deviates from moray\u0027s normal mode of operation would be cool though."},{"file":"lib/models/waitlist.js","line":352,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Yes, I think we should either set \"noLimit\" true in the \"options\" parameter for the \"deleteMany\" call, or run through as many iterations needed to delete all tickets that match the filter \"filter\"."},{"file":"lib/models/waitlist.js","line":440,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Thinking out loud: could that code that manually copies properties from \"params\" to \"queryOpts\" be replaced by the usage of \"jsprim.deepCopy\" from https://www.npmjs.com/package/jsprim?"},{"file":"lib/models/waitlist.js","line":440,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Yeah, I don\u0027t like this boilerplate to pass along a subset of similarly named keys. I guess what I was trying to do here was only allow the keys limit, offset, order, attribute to be propagated to \u0027ModelWaitlist.query\u0027. What\u0027d be ideal is if jsprim.deepClone was able to clone just a subset of an object\u0027s properties."},{"file":"lib/models/waitlist.js","line":440,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Ah OK, I see now that \"params\" has a \"server_uuid\" property that we don\u0027t want to end up in \"queryOpts\"."},{"file":"lib/models/waitlist.js","line":476,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is it OK to modify the input parameter \"findOpts\" in this case, or should \"ModelWaitlist.query\" clone \"findOpts\" before modifying the clone?"},{"file":"lib/models/waitlist.js","line":476,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Yeah, if we\u0027re good citizens we should be making our own copy of the options object."},{"file":"lib/models/waitlist.js","line":480,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Thinking out loud:\n\nIf \"findOpts\" was cloned to e.g \"findParams\" so that \"findOpts\" is left intact in the caller function, then the whole thing could become:\n\nvar findParams \u003d jsprim.deepCopy(findOpts);\nfindParams.sort \u003d defaultSort;\nif (findOpts.sort.order) {\n  findParams.sort.order \u003d findOpts.sort.order;\n}\netc.\n\nThis way findOpts is left intact in the caller, and the code might be simpler to read and a bit more concise."},{"file":"lib/models/waitlist.js","line":480,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Yeah, I think this is a good suggestion which I\u0027ll do."},{"file":"lib/models/waitlist.js","line":1314,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What does it mean to get a \"UniqueAttributeError\" in this case?"},{"file":"lib/models/waitlist.js","line":1314,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"I ended up cleaning up a lot of this code, it was copied and pasted from something which worked similarly but needed not to clobber in the case of etag conflicts. In this case it\u0027s fine since we\u0027re doing a destructive operation anyway."},{"file":"lib/models/waitlist.js","line":1323,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is \"emptyServerQueue\" retried indefinitely? Is it possible to get to a pathological situation when the putObject always fails with one of these two errors?"},{"file":"lib/models/waitlist.js","line":1323,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Yeah this kind of code should have an associated MAX_ATTEMPTS or other bail-out logic."},{"file":"lib/models/waitlist.js","line":1328,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is the error not passed to \"wfcb\" on purpose here? Does that mean that all errors other than EtagConflictError and UniqueAttributeError can be ignored safely?"},{"file":"lib/models/waitlist.js","line":1328,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"This is a good point and I noticed this pattern is repeated in a few different places in this file, so I will need to create a separate ticket to address that."},{"file":"lib/models/waitlist.js","line":1359,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is the need for more than one iteration here due to deleteMany having a 1000 limit by default? If so, would it make sense to pass an \"unlimited\" limit instead?"},{"file":"lib/models/waitlist.js","line":1359,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Yes, if there are more than 1000 items in the bucket, only the first 1000 get deleted. Who would be honouring the \"unlimited\" limit here, `deleteMany`? Or deleteAllTickets would check for that value and take different action based on what it held?\n\nIf you mean passing in a special limit value of \"unlimited\" to deleteAllTickets to highlight the differences with deleteMany, that seems reasonable."},{"file":"lib/models/waitlist.js","line":1359,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I meant passing in a special value to \"deleteMany\". I think passing \"noLimit: true\" in the options object would delete all entries, not just a maximum of 1000 entries, and would not require multiple iterations. I\u0027m not sure if that would have an impact on robustness or performance though, so it\u0027s fine to leave it as it is if it doesn\u0027t make things easier."},{"file":"lib/models/waitlist.js","line":1413,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Can the \"end\" event be emitted after an \"error\" event? If so, then I would suggest either removing the \"end\" event listener from the \"error\" event listener\u0027s callback (and vice versa), or using the \"once\" npm module to wrap the callback so that it\u0027s effectively called only once.\n\nOtherwise there\u0027s a risk of calling \"callback\" more than once."},{"file":"lib/models/waitlist.js","line":1413,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"I\u0027m not sure about the actual mechanics of the error and end sequence, but I think your suggestion of using `once` here is sound."},{"file":"test/waitlist/test-waitlist.js","line":445,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Shouldn\u0027t this assertion be moved to where the test tickets are created? I don\u0027t understand why the length of ticketUuids is assert here since this code seems like it doesn\u0027t change it."},{"file":"test/waitlist/test-waitlist.js","line":445,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"You\u0027re right, I was doing some refactoring here and this was left in by accident. Good catch!"},{"file":"test/waitlist/test-waitlist.js","line":446,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Typo: \"as\" -\u003e \"has\"?"},{"file":"test/waitlist/test-waitlist.js","line":498,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should the assertion be that the number of tickets is equal to \"count\". Otherwise it seems that sometimes we might not be trying to delete \"count\" tickets, but a smaller number."},{"file":"test/waitlist/test-waitlist.js","line":580,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is the error ignored on purpose?"},{"file":"test/waitlist/test-waitlist.js","line":580,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Should be being checked one line 569?"},{"file":"test/waitlist/test-waitlist.js","line":580,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Ah OK, so it will be marked as a test failure but not propagated to the \"onFinish\" callback, which I think is fine."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/endpoints/waitlist.js","type":"MODIFIED","insertions":41,"deletions":-18},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":172,"deletions":-26},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/waitlist/test-waitlist.js","type":"MODIFIED","insertions":247,"deletions":-8}],"sizeInsertions":463,"sizeDeletions":-55},{"number":"7","revision":"60407eb2505343b9517471db7544c4e919ad66e6","parents":["550a06b14033adfa74a0ff5d2035180df7d1f744"],"ref":"refs/changes/63/263/7","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1471367099,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1471367132,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"lib/endpoints/waitlist.js","type":"MODIFIED","insertions":41,"deletions":-18},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":159,"deletions":-26},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/waitlist/test-waitlist.js","type":"MODIFIED","insertions":245,"deletions":-8}],"sizeInsertions":448,"sizeDeletions":-56},{"number":"8","revision":"25589a1fd6d5d9855da1e39b0c3fd678f056871f","parents":["550a06b14033adfa74a0ff5d2035180df7d1f744"],"ref":"refs/changes/63/263/8","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1471908193,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1471908231,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/endpoints/waitlist.js","line":61,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Does `isNumberType` consider negative values as invalid? For limit and offset, I think it should. It might be useful to add some tests for these use cases to, at least just to make sure that code is not blowing up unexpectedly on invalid input, and to prevent future regressions."},{"file":"lib/models/waitlist.js","line":487,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"We might want to jsprim.deepCopy defaultSort into findParams.sort instead of just assigning a reference to it to avoid mutating defaultSort, but it might not matter to much for now."},{"file":"test/waitlist/test-waitlist.js","line":424,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Isn\u0027t this assertion useful only once after all the tickets were created? The ticketsUuids list doesn\u0027t change in this function, so it seems not useful to assert on its length for every iteration of the loop. What I meant last time was to move this assertion to the first function of the async workflow, after line 382."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"docs/index.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"docs/static.md","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/endpoints/waitlist.js","type":"MODIFIED","insertions":54,"deletions":-18},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":155,"deletions":-38},{"file":"package.json","type":"MODIFIED","insertions":6,"deletions":-5},{"file":"test/waitlist/test-waitlist.js","type":"MODIFIED","insertions":245,"deletions":-8}],"sizeInsertions":473,"sizeDeletions":-72},{"number":"9","revision":"3475a55c299f3fa880ebc51bbf468e48fad5eae2","parents":["550a06b14033adfa74a0ff5d2035180df7d1f744"],"ref":"refs/changes/63/263/9","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1472165447,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472165479,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1472233574,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"comments":[{"file":"docs/index.md","line":601,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"That reminds me that it might be useful to actually consider a limit \u003e 1000 to be invalid to prevent the server to send large JSON strings that could make it crash, slow it down and in general just degrade the service. This is what is done in VMAPI if I remember correctly. But I think it would be fine to do that in another ticket, as it\u0027s not the exact purpose of CNAPI-662 and CNAPI-663."},{"file":"docs/index.md","line":604,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"There is another caveat which is that it\u0027s possible to have one or more  existing tickets missing from the output if one ore more tickets are deleted while paging through results. For isntance, if the set of ticket when paging starts is [A, B, C] and the first page is requested using a limit of 2, then the first page of results is [A, B]. Then ticket B is deleted, and the set of tickets is now [A, C]. The second page of result is requested with offset\u003d2. That request\u0027s response will _not_ include C since it\u0027s now in second position.\n\nAlso, as long as the sorting order is by creation time ascending, adding a new ticket to the set will not make paging through tickets miss any existing ticket. That will happen only if the sort order chosen is different, or if the creation time of new tickets can be older than the creation time of previous tickets.\n\nSo the caveats are a bit subtle, and it\u0027s not easy to summarize them in a clear and concise way. I think we should at least mention the possibility of missing tickets in addition to what this change already mentions."},{"file":"docs/static.md","line":606,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same comments than for the similar paragraph in index.md, although I think one is generated from the other, so it should be fine."},{"file":"lib/endpoints/waitlist.js","line":64,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Not necessarily a significant problem, but would a string such as \u00270123\u0027 be considered a valid offset and/or limit since it matches this regular expression? From the implementation of \"isNumberGreaterThanEqualZeroType\", it seems that the string \u00270123\u0027 would considered to be greater or equal than zero. I don\u0027t know to which value it would be converted by the code that would actually use that value.\n\nIt might be worth it to change that regular expression to ^[1-9][0-9]*$."},{"file":"lib/endpoints/waitlist.js","line":69,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same comment as above regarding the regular expression."},{"file":"lib/models/waitlist.js","line":486,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"is the \"|| jsprim.deepCopy(defaultSort)\" part useful if \"findParams.sort\" is overriden with the \"sort\" object properties only for those that are defined?"},{"file":"lib/validation/endpoints.js","line":166,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: \"was not greater or equal\"."},{"file":"test/waitlist/test-waitlist.js","line":369,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What does happen when an empty string is sent, e.g with \u0027limit\u003d\u0027?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"docs/index.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"docs/static.md","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/endpoints/waitlist.js","type":"MODIFIED","insertions":62,"deletions":-18},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":190,"deletions":-37},{"file":"lib/validation/endpoints.js","type":"MODIFIED","insertions":12,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":6,"deletions":-5},{"file":"test/waitlist/test-waitlist.js","type":"MODIFIED","insertions":318,"deletions":-8}],"sizeInsertions":601,"sizeDeletions":-71},{"number":"10","revision":"e7836d39dcf4e050d3464f373dd141a70ba0a0e2","parents":["550a06b14033adfa74a0ff5d2035180df7d1f744"],"ref":"refs/changes/63/263/10","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1472465830,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472465911,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"docs/index.md","type":"MODIFIED","insertions":10,"deletions":0},{"file":"docs/index/index.md.ejs","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"docs/static.md","type":"MODIFIED","insertions":10,"deletions":0},{"file":"lib/endpoints/waitlist.js","type":"MODIFIED","insertions":74,"deletions":-18},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":190,"deletions":-37},{"file":"lib/validation/endpoints.js","type":"MODIFIED","insertions":25,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":6,"deletions":-5},{"file":"test/waitlist/test-waitlist.js","type":"MODIFIED","insertions":318,"deletions":-8}],"sizeInsertions":646,"sizeDeletions":-73},{"number":"11","revision":"a6db3e4b7e44eb19fa8a62af97966d1f4cad0690","parents":["550a06b14033adfa74a0ff5d2035180df7d1f744"],"ref":"refs/changes/63/263/11","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1472497266,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472497329,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1472748186,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"comments":[{"file":"docs/index/index.md.ejs","line":23,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Typo in \"or lose having them lost\"?"},{"file":"lib/endpoints/waitlist.js","line":73,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should this regular expression be the same as the one above?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"docs/index.md","type":"MODIFIED","insertions":10,"deletions":0},{"file":"docs/index/index.md.ejs","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"docs/static.md","type":"MODIFIED","insertions":10,"deletions":0},{"file":"lib/endpoints/waitlist.js","type":"MODIFIED","insertions":74,"deletions":-18},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":190,"deletions":-37},{"file":"lib/validation/endpoints.js","type":"MODIFIED","insertions":25,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":6,"deletions":-5},{"file":"test/waitlist/test-waitlist.js","type":"MODIFIED","insertions":318,"deletions":-8}],"sizeInsertions":646,"sizeDeletions":-73},{"number":"12","revision":"15d7956333e5c34bfdf8fd6f827ae03043f6174c","parents":["550a06b14033adfa74a0ff5d2035180df7d1f744"],"ref":"refs/changes/63/263/12","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1472844716,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472844760,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1472845839,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1472852544,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"SUBM","value":"1","grantedOn":1472852548,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"docs/index.md","type":"MODIFIED","insertions":22,"deletions":-3},{"file":"docs/index/index.md.ejs","type":"MODIFIED","insertions":12,"deletions":-3},{"file":"docs/static.md","type":"MODIFIED","insertions":10,"deletions":0},{"file":"lib/endpoints/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/endpoints/waitlist.js","type":"MODIFIED","insertions":74,"deletions":-18},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":190,"deletions":-37},{"file":"lib/validation/endpoints.js","type":"MODIFIED","insertions":25,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":6,"deletions":-5},{"file":"test/waitlist/test-waitlist.js","type":"MODIFIED","insertions":318,"deletions":-8}],"sizeInsertions":660,"sizeDeletions":-78}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}]}