From f540516677836d7e0f5018b4b811e6af14076ac9 Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Fri, 9 Mar 2018 23:26:47 +0000
Subject: [PATCH] TOOLS-2026 Update node-moray-sandbox to use Moray client v3

---
 lib/sandbox.js | 5 ++++-
 package.json   | 8 ++++----
 2 files changed, 8 insertions(+), 5 deletions(-)

diff --git a/lib/sandbox.js b/lib/sandbox.js
index dbbf0cd..61ded9e 100644
--- a/lib/sandbox.js
+++ b/lib/sandbox.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2016, Joyent, Inc.
+ * Copyright (c) 2018 Joyent, Inc.
  */
 
 /*
@@ -73,6 +73,7 @@ function mkMorayConfig(log, port, connstr) {
             datacenter: 'sandbox',
             standalone: {
                 pg: {
+                    maxQueueLength: 2000,
                     maxConnections: 5
                 },
                 url: connstr
@@ -198,6 +199,8 @@ MoraySandbox.prototype._startMoray = function startMoray(opts, callback) {
                 return;
             }
 
+            pg.setRequestId(opts.req_id);
+
             var q = pg.query(mkTableSQL);
 
             q.once('error', function (err) {
diff --git a/package.json b/package.json
index 22fd206..3cf2cc9 100644
--- a/package.json
+++ b/package.json
@@ -2,7 +2,7 @@
   "name": "moray-sandbox",
   "description": "Library for managing temporary, sandboxed Moray instances",
   "main": "./lib/index.js",
-  "version": "0.1.3",
+  "version": "0.2.0",
   "keywords": [ "moray" ],
   "repository": {
     "type": "git",
@@ -14,7 +14,7 @@
     "clone": "1.0.2",
     "forkexec": "1.1.0",
     "jsprim": "1.4.0",
-    "moray-server": "git+https://github.com/joyent/moray.git#3e9f411",
+    "moray-server": "git+https://github.com/joyent/moray.git#7b8c682",
     "uuid": "3.0.0",
     "vasync": "1.6.4",
     "verror": "1.9.0",
@@ -22,7 +22,7 @@
   },
   "devDependencies": {
     "dashdash": "1.14.1",
-    "moray": "^2.0.0",
+    "moray": "^3.0.0",
     "faucet": "0.0.1",
     "istanbul": "^0.4.0",
     "tape": "3.0.3",
@@ -30,7 +30,7 @@
     "eslint-plugin-joyent": "1.0.1"
   },
   "peerDependencies": {
-    "moray": "^2.0.0"
+    "moray": "^3.0.0"
   },
   "license": "MPL-2.0"
 }
-- 
2.21.0

