{"project":"joyent/node-cueball","branch":"master","id":"Id9cc7d41af2b20839d94c13a5e1be0e02944c264","number":"1819","subject":"joyent/node-cueball#108 crash: unhandled smgr state transition Reviewed by: David Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/1819","commitMessage":"joyent/node-cueball#108 crash: unhandled smgr state transition\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1492736903,"lastUpdated":1493251754,"open":false,"status":"MERGED","comments":[{"timestamp":1492736903,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1492736926,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1492736978,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1492737046,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1492789589,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1492797923,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1492801845,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1492817508,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2: Code-Review-1\n\nthis doesn\u0027t solve the whole problem"},{"timestamp":1493061918,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1493062008,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1493066682,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3: -Code-Review"},{"timestamp":1493071419,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)"},{"timestamp":1493072424,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1493251674,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1493251678,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1493251679,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1493251686,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"},{"timestamp":1493251754,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"5","revision":"e4d95162ec433c847cdb699f66f7f03b20eb944d","parents":["2bb4c72468b6247275ad99f279fe718f5a7f134e"],"ref":"refs/changes/19/1819/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1493251678,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1493062008,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493071419,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1493251679,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1493251686,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":25,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/pool.test.js","type":"MODIFIED","insertions":60,"deletions":0}],"sizeInsertions":86,"sizeDeletions":-10},"patchSets":[{"number":"1","revision":"a68809cd3469bc2164c82570476f7b0256ba0fe1","parents":["753461e4dbcfa3e6b224526108dd2409571652ee"],"ref":"refs/changes/19/1819/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1492736903,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1492736926,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/pool.test.js","line":783,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: variable is declared but never referenced: timer"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":17,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/pool.test.js","type":"MODIFIED","insertions":61,"deletions":0}],"sizeInsertions":79,"sizeDeletions":-1},{"number":"2","revision":"8c77b0c22191016090b8be21e76c36d306b4be54","parents":["753461e4dbcfa3e6b224526108dd2409571652ee"],"ref":"refs/changes/19/1819/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1492736978,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1492801845,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1492817508,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1492737046,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/connection-fsm.js","line":964,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Why is that?"},{"file":"lib/connection-fsm.js","line":964,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Because the previous state we were in (busy) can only be entered and then come to here (from idle) by having received all async events up to state \"connected\" in the smgr. We check isInState against the async state we acted on there, so we know we came to rest. That means that the stateChanged event for \u0027connected\u0027 cannot possibly still be queued up (we already received on it and double-checked)."},{"file":"lib/connection-fsm.js","line":968,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is this an accurate restatement: normally, it wouldn\u0027t make sense to get a state-change event to the same state that the smgr started in.  That can happen if a sequence of state changes led to the slot reaching \u0027retrying\u0027 on the same tick that the smgr transitions, and the latter transition\u0027s event is queued behind Node\u0027s processing of the slot\u0027s state change.  In this case, the slot will see the updated smgr state, even though it hasn\u0027t seen the event that transitioned to it yet.\n\nIs it also accurate to say that this can only happen if \"first\" \u003d\u003d \"closed\" at line 958?  Would it make sense to assert (or check) that?  If it could happen with other states, it\u0027s not obvious to me that it would be correct to ignore the state change."},{"file":"lib/connection-fsm.js","line":968,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"You can get a \u0027stateChanged\u0027 to the same state twice -- if the state itself does S.gotoState(\u0027this_state\u0027).\n\nThis can happen with first \u003d\u003d\u003d \"closed\" or first \u003d\u003d\u003d \"error\". In both these cases, ignoring it here is the correct thing to do. We have already called .retry() on the smgr by entering this state, we should not re-enter and call it again.\n\nIf we go through \u0027backoff\u0027, though, we can come back to \u0027error\u0027 that way as well, which is why it\u0027s handled in the switch() below this."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":17,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/pool.test.js","type":"MODIFIED","insertions":60,"deletions":0}],"sizeInsertions":78,"sizeDeletions":-1},{"number":"3","revision":"d9cc7d41af2b20839d94c13a5e1be0e02944c264","parents":["753461e4dbcfa3e6b224526108dd2409571652ee"],"ref":"refs/changes/19/1819/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1493061918,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493071419,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1493062008,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/connection-fsm.js","line":1081,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Should we keep track of this across all states so that we don\u0027t somehow wind up inconsistent because we weren\u0027t \u0027connected\u0027 when we got here?"},{"file":"lib/connection-fsm.js","line":1081,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"We can only move into \u0027idle\u0027 when we actually got the \u0027connected\u0027 async event already (so it\u0027s been emitted). We can only get to \u0027busy\u0027 from \u0027idle\u0027.\n\nWhen we enter \u0027busy\u0027, we synchronously check the state of smgr (see below) to decide whether we call accept() or reject() here. If the smgr is not still in \u0027connected\u0027 still when we get into state_busy, we will immediately transition and this handler will never get a chance to be used.\n\nSo basically, we\u0027re completely synced up with the smgr at this point anyway (because of the requirement that we not accept() without a socket), and can safely just always use \u0027connected\u0027 here."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":25,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/pool.test.js","type":"MODIFIED","insertions":60,"deletions":0}],"sizeInsertions":86,"sizeDeletions":-10},{"number":"4","revision":"a749aeffb4c34bf6dcc28368b129bb2114b1799b","parents":["753461e4dbcfa3e6b224526108dd2409571652ee"],"ref":"refs/changes/19/1819/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1493251674,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493071419,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1493062008,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":25,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/pool.test.js","type":"MODIFIED","insertions":60,"deletions":0}],"sizeInsertions":86,"sizeDeletions":-10},{"number":"5","revision":"e4d95162ec433c847cdb699f66f7f03b20eb944d","parents":["2bb4c72468b6247275ad99f279fe718f5a7f134e"],"ref":"refs/changes/19/1819/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1493251678,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493071419,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1493251679,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1493251686,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1493062008,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":25,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/pool.test.js","type":"MODIFIED","insertions":60,"deletions":0}],"sizeInsertions":86,"sizeDeletions":-10}],"allReviewers":[{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}