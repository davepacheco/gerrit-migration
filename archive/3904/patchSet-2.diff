From 4a55e9ebed239280e9295d73360522cc9d27073e Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Thu, 3 May 2018 21:22:19 +0000
Subject: [PATCH] TRITON-365 NAPI ping endpoint broken by TRITON-269

---
 lib/endpoints/ping.js                      | 17 ++++-------------
 lib/napi.js                                |  1 -
 test/unit/migration-1.2.0-networks.test.js | 20 +++++++++++++++++++-
 3 files changed, 23 insertions(+), 15 deletions(-)

diff --git a/lib/endpoints/ping.js b/lib/endpoints/ping.js
index 5d7f231..b344938 100644
--- a/lib/endpoints/ping.js
+++ b/lib/endpoints/ping.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -37,25 +37,16 @@ function ping(req, res, next) {
         status: 'OK'
     };
 
-    if (!req.app.initialDataLoaded) {
-        stats.status = 'loading initial data';
-        stats.healthy = false;
-    }
-
-    if (req.app.moray) {
-        if (!req.app.morayConnected) {
+    if (req.app.isInState('init')) {
+        if (req.app.isInState('init.moray')) {
             stats.services.moray = 'offline';
-            stats.status = 'moray not connected';
-            stats.healthy = false;
         }
-    } else {
-        stats.services.moray = 'offline';
         stats.status = 'initializing';
         stats.healthy = false;
     }
 
     res.send(200, stats);
-    return next();
+    next();
 }
 
 
diff --git a/lib/napi.js b/lib/napi.js
index 3adac09..3f6ae21 100644
--- a/lib/napi.js
+++ b/lib/napi.js
@@ -64,7 +64,6 @@ function NAPI(opts) {
     var self = this;
     this.log = opts.log;
     this.config = opts.config;
-    this.initialDataLoaded = false;
     constants.UFDS_ADMIN_UUID = opts.config.ufdsAdminUuid;
 
     if (opts.config.overlay.enabled) {
diff --git a/test/unit/migration-1.2.0-networks.test.js b/test/unit/migration-1.2.0-networks.test.js
index 3103b7e..44263b0 100644
--- a/test/unit/migration-1.2.0-networks.test.js
+++ b/test/unit/migration-1.2.0-networks.test.js
@@ -563,12 +563,30 @@ test('setup', function (t) {
                     t.end();
                     return;
                 }
-                NAPI = res;
+                NAPI = res.client;
                 t2.ok(NAPI, 'have NAPI client object');
                 t2.end();
             });
         });
     });
+
+
+    t.test('server ping should no longer be initializing', function (t2) {
+        NAPI.ping(function (err, status) {
+            t2.ifError(err, 'ping() error');
+            t2.deepEqual(status, {
+                config: {
+                    fabrics_enabled: true
+                },
+                healthy: true,
+                services: {
+                    moray: 'online'
+                },
+                status: 'OK'
+            });
+            t2.end();
+        });
+    });
 });
 
 test('networks', function (t) {
-- 
2.21.0

