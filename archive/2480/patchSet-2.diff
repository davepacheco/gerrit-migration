commit ed8827f63b09b47b425463ddbe38e1a840d43d39 (refs/changes/80/2480/2)
Author: Jan Wyszynski <jan.wyszynski@joyent.com>
Date:   2017-09-02T00:27:03+00:00 (2 years, 1 month ago)
    
    MANTA-3367 MPU commit invokes mako-finalize if "parts" array is missing

diff --git a/lib/uploads/commit.js b/lib/uploads/commit.js
index ded74d8..61f39ae 100644
--- a/lib/uploads/commit.js
+++ b/lib/uploads/commit.js
@@ -222,9 +222,9 @@ function validateParts(req, res, next) {
     log.debug('validating parts for upload');
 
     if (!parts) {
-        req.body.parts = [];
-        log.debug('empty parts array');
-        next();
+        log.debug('undefined parts array');
+        next(new MultipartUploadCreateError('missing parts array in ' +
+                    'request body'));
         return;
     } else if (parts.length > uploadsCommon.MAX_NUM_PARTS) {
         next(new MultipartUploadInvalidArgumentError(id,
diff --git a/test/mpu/commit.test.js b/test/mpu/commit.test.js
index d968219..938f680 100644
--- a/test/mpu/commit.test.js
+++ b/test/mpu/commit.test.js
@@ -13,6 +13,7 @@ var uuid = require('node-uuid');
 var path = require('path');
 var vasync = require('vasync');
 var verror = require('verror');
+var util = require('util');
 
 if (require.cache[path.join(__dirname, '/../helper.js')])
     delete require.cache[path.join(__dirname, '/../helper.js')];
@@ -70,6 +71,30 @@ test('commit upload: zero parts', function (t) {
     });
 });
 
+test('commit upload: zero parts 0 content length', function (t) {
+    var self = this;
+    self.createUpload(self.path, null, function (err) {
+        self.commitUpload(self.uploadId, [], function (err2) {
+            if (ifErr(t, err2, 'commit upload error')) {
+                t.end();
+                return;
+            }
+
+            self.client.info(self.path, function (err3, info) {
+                if (ifErr(t, err3, 'minfo target object error')) {
+                    t.end();
+                    return;
+                }
+                t.ok(info);
+                if (info) {
+                    var headers = info.headers || {};
+                    t.equal(headers['content-length'], 0);
+                }
+                t.end();
+            });
+        });
+    });
+});
 
 test('commit upload: one part', function (t) {
     var self = this;
@@ -757,3 +782,18 @@ test('commit upload: non-existent id', function (t) {
         t.end();
     });
 });
+
+test('commit upload: error on undefined parts array', function (t) {
+    var self = this;
+    self.createUpload(self.path, null, function (err) {
+        self.commitUpload(self.uploadId, undefined, function (err2) {
+            t.ok(err2);
+            if (!err2) {
+                return (t.end());
+            }
+            t.ok(verror.hasCauseWithName(err2,
+                    'MultipartUploadInvalidArgumentError'));
+            t.end();
+        });
+    });
+});
