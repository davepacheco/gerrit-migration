From b819ab1a644af8a8df8b4fda7daae94da51479e4 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Mon, 11 Dec 2017 21:04:40 +0000
Subject: [PATCH] OS-6514 lx /proc/mounts should filter unknown mount options

---
 .../uts/common/brand/lx/procfs/lx_prvnops.c   | 31 ++++++++++++++++---
 .../uts/common/brand/lx/syscall/lx_mount.c    | 18 +++++++++++
 2 files changed, 44 insertions(+), 5 deletions(-)

diff --git a/usr/src/uts/common/brand/lx/procfs/lx_prvnops.c b/usr/src/uts/common/brand/lx/procfs/lx_prvnops.c
index 619613063b..bbbd09df49 100644
--- a/usr/src/uts/common/brand/lx/procfs/lx_prvnops.c
+++ b/usr/src/uts/common/brand/lx/procfs/lx_prvnops.c
@@ -2030,6 +2030,25 @@ static int lxpr_zfs_fstype = -1;
 #define	LXPR_ROOT_MOUNT_ID	15
 #define	LXPR_MNT_OPT_CHUNK	128
 
+/* List of native, non-Linux mount options we should omit. */
+static char *lx_invalid_mnt_opts[] = {
+	"xattr",
+	NULL
+};
+
+/* First see if we should omit this option */
+static boolean_t
+lxpr_skip_mntopt(char *s)
+{
+	uint_t i;
+
+	for (i = 0; lx_invalid_mnt_opts[i] != NULL; i++) {
+		if (strcmp(s, lx_invalid_mnt_opts[i]) == 0)
+			return (B_TRUE);
+	}
+	return (B_FALSE);
+}
+
 static void
 lxpr_append_mntopt(lxpr_mount_entry_t *lme, char *s)
 {
@@ -2081,11 +2100,13 @@ lxpr_get_mntopts(vfs_t *vfsp, lxpr_mount_entry_t *lme)
 		    strcmp(mop->mo_name, "nodevices") == 0)
 			have_nodev = B_TRUE;
 
-		lxpr_append_mntopt(lme, ",");
-		lxpr_append_mntopt(lme, mop->mo_name);
-		if (mop->mo_arg != NULL) {
-			lxpr_append_mntopt(lme, "=");
-			lxpr_append_mntopt(lme, mop->mo_arg);
+		if (!lxpr_skip_mntopt(mop->mo_name)) {
+			lxpr_append_mntopt(lme, ",");
+			lxpr_append_mntopt(lme, mop->mo_name);
+			if (mop->mo_arg != NULL) {
+				lxpr_append_mntopt(lme, "=");
+				lxpr_append_mntopt(lme, mop->mo_arg);
+			}
 		}
 	}
 
diff --git a/usr/src/uts/common/brand/lx/syscall/lx_mount.c b/usr/src/uts/common/brand/lx/syscall/lx_mount.c
index 46d16030d5..3a5e0da37d 100644
--- a/usr/src/uts/common/brand/lx/syscall/lx_mount.c
+++ b/usr/src/uts/common/brand/lx/syscall/lx_mount.c
@@ -132,6 +132,17 @@ static mount_opt_t lx_autofs_options[] = {
 	{ NULL,			MOUNT_OPT_INVALID }
 };
 
+static char *lx_common_mnt_opts[] = {
+	"exec",
+	"noexec",
+	"devices",
+	"nodevices",
+	"dev",
+	"nodev",
+	"suid",
+	"nosuid",
+	NULL
+};
 
 /*
  * Check the mount options.
@@ -183,6 +194,12 @@ lx_mnt_opt_verify(char *opts, mount_opt_t *mop)
 	for (;;) {
 		opt_len = strlen(opt);
 
+		/* Check common options we support on all filesystems */
+		for (i = 0; lx_common_mnt_opts[i] != NULL; i++) {
+			if (strcmp(opt, lx_common_mnt_opts[i]) == 0)
+				goto next_opt;
+		}
+
 		/* Check for matching option/value pair. */
 		for (i = 0; mop[i].mo_name != NULL; i++) {
 			char	*ovalue;
@@ -259,6 +276,7 @@ lx_mnt_opt_verify(char *opts, mount_opt_t *mop)
 		if (last)
 			break;
 
+next_opt:
 		*tp = ',';
 		opt = tp + 1;
 		for (tp = opt; *tp != ',' && *tp != '\0'; tp++)
-- 
2.21.0

