{"project":"joyent/illumos-joyent","branch":"master","id":"Ic37f2add620eca8f16500acbaa21c6d11eb4eea0","number":"5979","subject":"OS-XXXX bhyve should not hold HMA registration with no running VMs","owner":{"name":"Andy Fiddaman","email":"omnios@citrus-it.co.uk","username":"citrus-it"},"url":"https://cr.joyent.us/5979","commitMessage":"OS-XXXX bhyve should not hold HMA registration with no running VMs\n","createdOn":1553001488,"lastUpdated":1571867565,"open":true,"status":"NEW","comments":[{"timestamp":1553001488,"reviewer":{"name":"Andy Fiddaman","email":"omnios@citrus-it.co.uk","username":"citrus-it"},"message":"Uploaded patch set 1."},{"timestamp":1553001546,"reviewer":{"name":"Andy Fiddaman","email":"omnios@citrus-it.co.uk","username":"citrus-it"},"message":"Patch Set 1:\n\ntheeo# mdb -ke \u0027hma_registrations::walk list | ::print -t hma_reg_t hr_name\u0027\ntheeo# zoneadm -z bloody boot\ntheeo# mdb -ke \u0027hma_registrations::walk list | ::print -t hma_reg_t hr_name\u0027\nconst char *hr_name \u003d 0xfffffffff83e590a \"bhyve\"\ntheeo# VBoxHeadless -s test\nOracle VM VirtualBox Headless Interface 5.2.26\n(C) 2008-2019 Oracle Corporation\nAll rights reserved.\n\n19/03/2019 12:54:28 Listening for VNC connections on TCP port 5900\n19/03/2019 12:54:28 Listening for VNC connections on TCP6 port 5900\nVRDE server is listening on port 5900.\nError: failed to start machine. Error message: VT-x is being used by another hypervisor (VERR_VMX_IN_VMX_ROOT_MODE).\nVirtualBox can\u0027t operate in VMX root mode. Please close all other virtualization programs. (VERR_VMX_IN_VMX_ROOT_MODE)\n19/03/2019 12:54:28 listenerRun: error in select: Bad file number\n\ntheeo# zoneadm -z bloody halt\ntheeo# mdb -ke \u0027hma_registrations::walk list | ::print -t hma_reg_t hr_name\u0027\ntheeo# VBoxHeadless -s test \u0026\nOracle VM VirtualBox Headless Interface 5.2.26\n(C) 2008-2019 Oracle Corporation\nAll rights reserved.\n\n19/03/2019 12:55:57 Listening for VNC connections on TCP port 5900\n19/03/2019 12:55:57 Listening for VNC connections on TCP6 port 5900\nVRDE server is listening on port 5900.\ntheeo# mdb -ke \u0027hma_registrations::walk list | ::print -t hma_reg_t hr_name\u0027\nconst char *hr_name \u003d 0xfffffffff7fb2abe \"VirtualBox HostDrv\"\n\ntheeo# zoneadm -z bloody boot\ntheeo# zoneadm list -vc\n  ID NAME             STATUS     PATH                           BRAND    IP\n   0 global           running    /                              ipkg     shared\n   - bloody           installed  /data/zone/bloody              bhyve    excl\ntheeo# dmesg | tail | grep HMA\nMar 19 12:56:31 theeo vmm: [ID 799464 kern.warning] WARNING: bhyve HMA registration failed.\n\ntheeo# cat /data/zone/bloody/root/tmp/init.log\nINFO:root:Zone UUID: 4d17cdc5-e409-4cb4-a70a-8ed866c19551\nINFO:root:/usr/sbin/bhyve -U 4d17cdc5-e409-4cb4-a70a-8ed866c19551 -A -H -B 1,product\u003dOmniOS HVM -c 2 -m 1G -l bootrom,/usr/share/bhyve/firmware/BHYVE_CSM.fd -s 0,hostbridge,model\u003di440fx -s 1,lpc -l com1,/dev/zconsole -s 4:0,virtio-blk,/dev/zvol/rdsk/data/hdd-bloody -s 6:0,virtio-net-viona,bloody0 bloody\nINFO:root:Starting bhyve\nINFO:root:Bhyve exited 4\nERROR:root:Error b\u0027vm_create: No such device or address\\n\u0027\nDEBUG:root:Output b\u0027\u0027\n\ntheeo# fg\n[1]  + running    VBoxHeadless -s test\n^C\ntheeo#\ntheeo# mdb -ke \u0027hma_registrations::walk list | ::print -t hma_reg_t hr_name\u0027\ntheeo# zoneadm -z bloody boot\ntheeo# mdb -ke \u0027hma_registrations::walk list | ::print -t hma_reg_t hr_name\u0027\nconst char *hr_name \u003d 0xfffffffff83e590a \"bhyve\"\ntheeo# zoneadm -z kbloody boot\ntheeo# mdb -ke \u0027hma_registrations::walk list | ::print -t hma_reg_t hr_name\u0027\nconst char *hr_name \u003d 0xfffffffff83e590a \"bhyve\"\nconst char *hr_name \u003d 0xfffffffff7d0d361 \"SmartOS KVM\""},{"timestamp":1554978532,"reviewer":{"name":"Andy Fiddaman","email":"omnios@citrus-it.co.uk","username":"citrus-it"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1557240029,"reviewer":{"name":"Andy Fiddaman","email":"omnios@citrus-it.co.uk","username":"citrus-it"},"message":"Patch Set 3: Patch Set 2 was rebased"},{"timestamp":1571863218,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3:\n\nIs this still current?"},{"timestamp":1571867565,"reviewer":{"name":"Andy Fiddaman","email":"omnios@citrus-it.co.uk","username":"citrus-it"},"message":"Patch Set 3:\n\nYes, and it\u0027s the same patch we have had in OmniOS since r151030\n(as we want to allow easy switching between virtualbox and bhyve, which need to be exclusive)."}],"currentPatchSet":{"number":"3","revision":"d26569e77a542d1c15b707d63008ae7b06c56306","parents":["7909161cccf1283e5c7a7057bb9c7f305a30e55a"],"ref":"refs/changes/79/5979/3","uploader":{"name":"Andy Fiddaman","email":"omnios@citrus-it.co.uk","username":"citrus-it"},"createdOn":1557240029,"author":{"name":"Andy Fiddaman","email":"omnios@citrus-it.co.uk","username":"citrus-it"},"isDraft":false,"kind":"TRIVIAL_REBASE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":53,"deletions":-12}],"sizeInsertions":53,"sizeDeletions":-12},"patchSets":[{"number":"1","revision":"c88fb8842d873ea9b78d1f31b403826873526053","parents":["aa83f7866d4ccccbf9e96c81fbcdada05e180700"],"ref":"refs/changes/79/5979/1","uploader":{"name":"Andy Fiddaman","email":"omnios@citrus-it.co.uk","username":"citrus-it"},"createdOn":1553001488,"author":{"name":"Andy Fiddaman","email":"omnios@citrus-it.co.uk","username":"citrus-it"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":53,"deletions":-12}],"sizeInsertions":53,"sizeDeletions":-12},{"number":"2","revision":"c37f2add620eca8f16500acbaa21c6d11eb4eea0","parents":["26dd5a91c086ec5f65eaaa39f0651013e22d28e9"],"ref":"refs/changes/79/5979/2","uploader":{"name":"Andy Fiddaman","email":"omnios@citrus-it.co.uk","username":"citrus-it"},"createdOn":1554978532,"author":{"name":"Andy Fiddaman","email":"omnios@citrus-it.co.uk","username":"citrus-it"},"isDraft":false,"kind":"TRIVIAL_REBASE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":53,"deletions":-12}],"sizeInsertions":53,"sizeDeletions":-12},{"number":"3","revision":"d26569e77a542d1c15b707d63008ae7b06c56306","parents":["7909161cccf1283e5c7a7057bb9c7f305a30e55a"],"ref":"refs/changes/79/5979/3","uploader":{"name":"Andy Fiddaman","email":"omnios@citrus-it.co.uk","username":"citrus-it"},"createdOn":1557240029,"author":{"name":"Andy Fiddaman","email":"omnios@citrus-it.co.uk","username":"citrus-it"},"isDraft":false,"kind":"TRIVIAL_REBASE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":53,"deletions":-12}],"sizeInsertions":53,"sizeDeletions":-12}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Andy Fiddaman","email":"omnios@citrus-it.co.uk","username":"citrus-it"},{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}]}