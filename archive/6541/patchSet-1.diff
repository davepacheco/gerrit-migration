From 1e0ef8bee55139c04a137f6b7433048b282ad6c3 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Tue, 2 Jul 2019 20:18:02 +0200
Subject: [PATCH] TRITON-1791 Allow disabling manatee-ha setup during sdcadm
 tests

---
 test/manatee.test.js | 16 +++++++++++-----
 test/runtests        |  2 +-
 2 files changed, 12 insertions(+), 6 deletions(-)

diff --git a/test/manatee.test.js b/test/manatee.test.js
index 29db524..65a291d 100644
--- a/test/manatee.test.js
+++ b/test/manatee.test.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2018, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 /*
@@ -34,6 +34,9 @@ var instances = [];
 var zkHost;
 var zkInitialStateRaw;
 
+// Allow to skip ha-manatee setup
+const SKIP_HA = process.env.NO_MANATEE_HA;
+
 function getServers(t, cb) {
     var cmd = 'sdc-cnapi /servers?setup=true|json -H -j';
     exec(cmd, function (err, stderr, stdout) {
@@ -68,7 +71,7 @@ test('setup', function (t) {
 });
 
 test('get initial zk-state', function (t) {
-    if (instances.length > 1) {
+    if (instances.length > 1 || SKIP_HA) {
         t.end();
         return;
     }
@@ -167,7 +170,6 @@ test('update non-HA', function (t) {
         });
         t.end();
     });
-
 });
 
 
@@ -194,7 +196,7 @@ test('post-setup w/o servers', function (t) {
 
 test('post-setup OK', function (t) {
     // Skip of not into ONWM initially
-    if (instances.length > 1) {
+    if (instances.length > 1 || SKIP_HA) {
         t.end();
         return;
     }
@@ -225,6 +227,10 @@ test('post-setup OK', function (t) {
 });
 
 test('update HA', function (t) {
+    if (SKIP_HA) {
+        t.end();
+        return;
+    }
     var command = 'sdcadm up manatee -y --force-same-image';
     exec(command, function (err, stdout, stderr) {
         t.ifError(err, 'Execution error');
@@ -250,7 +256,7 @@ test('update HA', function (t) {
 });
 
 test('teardown', function (t) {
-    if (instances.length > 1) {
+    if (instances.length > 1 || SKIP_HA) {
         t.end();
         return;
     }
diff --git a/test/runtests b/test/runtests
index 8104423..e354ae3 100755
--- a/test/runtests
+++ b/test/runtests
@@ -135,7 +135,7 @@ set +o errexit
 for file in $test_files; do
     test_file=$(basename $file)
     echo "# $test_file"
-    PATH=$NODE_INSTALL/bin:$PATH $TAPE $file \
+    NO_MANATEE_HA=1 PATH=$NODE_INSTALL/bin:$PATH $TAPE $file \
         | tee $RESULTS/$test_file.tap
     retval=$?
     if [[ "${retval}" != "0" ]]; then
-- 
2.21.0

