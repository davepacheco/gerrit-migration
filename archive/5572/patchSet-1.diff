From ccd73e8fc8d16c8293793365a0a295b888e88142 Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Tue, 12 Feb 2019 22:31:48 +0000
Subject: [PATCH] MANTA-2948 mako's tombstone grace period should be
 configurable

---
 bin/mako_gc.sh                       | 3 ++-
 sapi_manifests/mako_gc/manifest.json | 5 +++++
 sapi_manifests/mako_gc/template      | 3 +++
 3 files changed, 10 insertions(+), 1 deletion(-)
 create mode 100644 sapi_manifests/mako_gc/manifest.json
 create mode 100644 sapi_manifests/mako_gc/template

diff --git a/bin/mako_gc.sh b/bin/mako_gc.sh
index 3e4dfa6..0246493 100755
--- a/bin/mako_gc.sh
+++ b/bin/mako_gc.sh
@@ -46,7 +46,8 @@ PID_FILE=/tmp/mako_gc.pid
 TOMB_DATE=$(date "+%Y-%m-%d")
 TOMB_ROOT=/manta/tombstone
 TOMB_DIR=$TOMB_ROOT/$TOMB_DATE
-TOMB_DIRS_TO_KEEP=21
+TOMB_DIRS_TO_KEEP=$(json -f /var/run/mako_gc_metadata.json \
+    storage_max_tombstone_directories)
 
 
 # Mutables
diff --git a/sapi_manifests/mako_gc/manifest.json b/sapi_manifests/mako_gc/manifest.json
new file mode 100644
index 0000000..6de0b8e
--- /dev/null
+++ b/sapi_manifests/mako_gc/manifest.json
@@ -0,0 +1,5 @@
+{
+    "name": "mako_gc",
+    "path": "/var/run/mako_gc_metadata.json",
+    "master": true
+}
diff --git a/sapi_manifests/mako_gc/template b/sapi_manifests/mako_gc/template
new file mode 100644
index 0000000..b2870cb
--- /dev/null
+++ b/sapi_manifests/mako_gc/template
@@ -0,0 +1,3 @@
+{
+    "storage_max_tombstone_directories": {{#STORAGE_MAX_TOMBSTONE_DIRECTORIES}}{{STORAGE_MAX_TOMBSTONE_DIRECTORIES}}{{/STORAGE_MAX_TOMBSTONE_DIRECTORIES}}{{^STORAGE_MAX_TOMBSTONE_DIRECTORIES}}21{{/STORAGE_MAX_TOMBSTONE_DIRECTORIES}}
+}
-- 
2.21.0

