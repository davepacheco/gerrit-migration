From 112cc36477ef0aa88619f4aa65a2936ae831111a Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Tue, 16 Oct 2018 21:39:53 +0200
Subject: [PATCH] TRITON-883 `sdcadm up SVC` should update image_uuid
 associated with the service

---
 lib/procedures/index.js           |  3 +++
 lib/procedures/update-agent-v1.js | 19 +++++++++++++++++++
 2 files changed, 22 insertions(+)

diff --git a/lib/procedures/index.js b/lib/procedures/index.js
index 5070756..fbed497 100644
--- a/lib/procedures/index.js
+++ b/lib/procedures/index.js
@@ -742,6 +742,9 @@ function coordinatePlan(opts, cb) {
 
                 var svcInsts = [];
                 if (change.type === 'update-service') {
+                    if (!opts.servers || !opts.servers.length) {
+                        change.update_sapi_image = true;
+                    }
                     svcInsts = instsFromSvcName[change.service.name] || [];
                     // If we have a given set of servers, just filter instances
                     // present on the given list:
diff --git a/lib/procedures/update-agent-v1.js b/lib/procedures/update-agent-v1.js
index e611040..08401f5 100644
--- a/lib/procedures/update-agent-v1.js
+++ b/lib/procedures/update-agent-v1.js
@@ -26,6 +26,7 @@ var common = require('../common');
 var steps = require('../steps');
 
 var Procedure = require('./procedure').Procedure;
+var s = require('./shared');
 
 /**
  * Procedure for updating the different agent services.
@@ -147,6 +148,24 @@ UpdateAgentV1.prototype.execute = function uaExecute(opts, callback) {
                     }
                 });
             },
+
+            /*
+             * We will bump Service Image only when a request to update the
+             * agent in all the servers have been made
+             */
+            function updateSapiSvcImage(_, next) {
+                if (!change.update_sapi_image) {
+                    next();
+                    return;
+                }
+                s.updateSapiSvc({
+                    change: change,
+                    opts: {
+                        sdcadm: sdcadm,
+                        progress: progress
+                    }
+                }, next);
+            },
             /*
              * Unless CNAPI has been updated to a version newer than
              * MIN_CNAPI_VERSION, tell the user about the CNAPI version
-- 
2.21.0

