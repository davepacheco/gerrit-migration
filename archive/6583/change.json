{"project":"joyent/illumos-joyent","branch":"master","id":"I1025f015b784ee62cc7b2380f2f7e15b8aefbd56","number":"6583","subject":"OS-7882 nvmeadm attach/detach of ignored namespace causes panic Reviewed by: Robert Mustacchi \u003crm+illumos@fingolfin.org\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"url":"https://cr.joyent.us/6583","commitMessage":"OS-7882 nvmeadm attach/detach of ignored namespace causes panic\nReviewed by: Robert Mustacchi \u003crm+illumos@fingolfin.org\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1562751481,"lastUpdated":1568053331,"open":false,"status":"MERGED","comments":[{"timestamp":1562751481,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 1."},{"timestamp":1562789593,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1562867240,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 1:\n\nI have no additional review notes beyond Robert\u0027s comments."},{"timestamp":1563791737,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1563811843,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1: Code-Review+1\n\n(1 comment)"},{"timestamp":1564685172,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 1: Code-Review+1 Integration-Approval+1"},{"timestamp":1565606828,"reviewer":{"name":"Andy Fiddaman","email":"omnios@citrus-it.co.uk","username":"citrus-it"},"message":"Patch Set 1:\n\nFWIW, I\u0027ve verified that this fix fixes a panic I was experiencing on OmniOS when using an NVME device formatted under Linux with an unsupported namespace."},{"timestamp":1567771050,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 2."},{"timestamp":1567771230,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 2:\n\nI had to manually rebase this because of a merge conflict in the copyrights, and thus the previous reviews and IA from Robert and Jordan were removed by gerrit."},{"timestamp":1567785183,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1568048049,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1"},{"timestamp":1568053144,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1568053322,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1568053331,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Hans Rosenfeld"}],"currentPatchSet":{"number":"4","revision":"b0dbab4410d7472fc05021b3e954c506b64b4190","parents":["b36aca9fee0db2b4336b9f6ee7835a8f3fbfe9c9"],"ref":"refs/changes/83/6583/4","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1568053322,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1567785183,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1568048049,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1568048049,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1568053331,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/io/nvme/nvme.c","type":"MODIFIED","insertions":11,"deletions":0}],"sizeInsertions":11,"sizeDeletions":0},"patchSets":[{"number":"1","revision":"4bcdf77a46d38729edacc72ccc07d4f2c1350219","parents":["b2382a9d2ac444201a28feadb8bc8a1870ffbcde"],"ref":"refs/changes/83/6583/1","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1562751481,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/nvme/nvme.c","line":3861,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is a corresponding sanity check for a non-NULL handle worthwhile here?"},{"file":"usr/src/uts/common/io/nvme/nvme.c","line":3861,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"I don\u0027t think thats necessary. The driver guarantees that any namespace that isn\u0027t ignored also has a valid handle. It is either allocated at nvme_attach() time for each usable namespace, or in nvme_ioctl_attach() when a namespace first becomes usable after a FORMAT. It\u0027s only ever freed when nvme detaches itself."},{"file":"usr/src/uts/common/io/nvme/nvme.c","line":3861,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK, fair enough. While I often think having those sanity checks is useful, I can understand why you\u0027d rather not."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/nvme/nvme.c","type":"MODIFIED","insertions":12,"deletions":-1}],"sizeInsertions":12,"sizeDeletions":-1},{"number":"2","revision":"fb11aefdcd9238a92c734d3e68a7f342ed53efb5","parents":["1cc204b97b9317e681958da0e91abeb27bcc6f82"],"ref":"refs/changes/83/6583/2","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1567771050,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1567785183,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1568048049,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1568048049,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/nvme/nvme.c","type":"MODIFIED","insertions":11,"deletions":0}],"sizeInsertions":11,"sizeDeletions":0},{"number":"3","revision":"1025f015b784ee62cc7b2380f2f7e15b8aefbd56","parents":["1cc204b97b9317e681958da0e91abeb27bcc6f82"],"ref":"refs/changes/83/6583/3","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1568053144,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1567785183,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1568048049,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1568048049,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/io/nvme/nvme.c","type":"MODIFIED","insertions":11,"deletions":0}],"sizeInsertions":11,"sizeDeletions":0},{"number":"4","revision":"b0dbab4410d7472fc05021b3e954c506b64b4190","parents":["b36aca9fee0db2b4336b9f6ee7835a8f3fbfe9c9"],"ref":"refs/changes/83/6583/4","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1568053322,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1567785183,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1568048049,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1568048049,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1568053331,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/io/nvme/nvme.c","type":"MODIFIED","insertions":11,"deletions":0}],"sizeInsertions":11,"sizeDeletions":0}],"allReviewers":[{"name":"Andy Fiddaman","email":"omnios@citrus-it.co.uk","username":"citrus-it"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}]}