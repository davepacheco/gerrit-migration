{"project":"joyent/triton","branch":"master","id":"I65074b7790297c74ed3421fa54f38665b7804c9e","number":"4828","subject":"QA-311 Want vminfod troubleshooting document Reviewed by: Cody Peter Mello \u003cmelloc@writev.io\u003e Approved by: Angela Fong \u003cangela.fong@joyent.com\u003e","owner":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"url":"https://cr.joyent.us/4828","commitMessage":"QA-311 Want vminfod troubleshooting document\nReviewed by: Cody Peter Mello \u003cmelloc@writev.io\u003e\nApproved by: Angela Fong \u003cangela.fong@joyent.com\u003e\n","createdOn":1536776539,"lastUpdated":1537568508,"open":false,"status":"MERGED","comments":[{"timestamp":1536776539,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 1."},{"timestamp":1536776542,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1536776543,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 7369893ffa9210f42e1ff831d1bacd1dde869067\n    \n    initial commit"},{"timestamp":1537306893,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1537378992,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1537379010,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 2."},{"timestamp":1537379013,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1537379014,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 3f9c522be314079f929617627b942516716cc264\n    \n    angela review"},{"timestamp":1537382946,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"Patch Set 2: Code-Review+1\n\nIt\u0027ll be good for folks working on Triton to also review this (they are the ones who need the troubleshooting guide the most)."},{"timestamp":1537396480,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1537478107,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3:\n\n(11 comments)"},{"timestamp":1537563166,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3:\n\n(11 comments)"},{"timestamp":1537563187,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 4."},{"timestamp":1537563190,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1537563191,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit e1607ad8d98c413dcfbdf9b8f3c5243c91ecf7f7\n    \n    cody review"},{"timestamp":1537567540,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1537568327,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1537568494,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1537568508,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dave Eddy"}],"currentPatchSet":{"number":"5","revision":"65074b7790297c74ed3421fa54f38665b7804c9e","parents":["e0430961d64fa2f229aa737583d1e1e5307b505a"],"ref":"refs/changes/28/4828/5","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1537568494,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1537563190,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1537567540,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1537568327,"by":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"}},{"type":"SUBM","value":"1","grantedOn":1537568508,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"docs/operator-guide/vminfod/intro.md","type":"ADDED","insertions":43,"deletions":0},{"file":"docs/operator-guide/vminfod/troubleshooting.md","type":"ADDED","insertions":517,"deletions":0}],"sizeInsertions":560,"sizeDeletions":0},"patchSets":[{"number":"1","revision":"c7162295409aada8d2a12185f49e200c163d68bc","parents":["e0430961d64fa2f229aa737583d1e1e5307b505a"],"ref":"refs/changes/28/4828/1","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1536776539,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536776542,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":217,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"This should be \"# vminfo status\"."},{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":217,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"ah, good catch!"},{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":345,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"It may be helpful to indicate what happens if vmapi has different information from vminfod. This is not a new thing (vmapi and vmadm go out of sync from time to time) but I think it\u0027ll be a common question asked. And people will probably conflate that with vminfod issues. Currently we run `GET vmapi /vms/\u003cvm_uuid\u003e?sync\u003dtrue` to put vmapi back in sync. I believe this will be no different in the new world of vminfod."},{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":345,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"ah, sounds good.  I\u0027ll add a section for vminfod having different information than vmapi."},{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":375,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"Are there situations when manually restarting vminfod to hasten a full refresh is warranted? As an operator I\u0027ll be tempted to do so to quickly resolve a customer issue caused by a missed event. But the restart may have other undesirable side effects. It\u0027ll be good to understand the impact."},{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":375,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"So, this is a tricky question that I hadn\u0027t thought too much about.  Most agents have retry logic to handle vminfod restarting, but some daemons may restart on their own if vminfod goes down.\n\nIt *should* be possible to do this but I actually don\u0027t know if this will impact any other services or areas negatively.\n\nHowever, a possible solution for this may be for me to add an endpoint to do this manually.  Perhaps something like:\n\n POST /cmd/refreshCache\n\n(I just made that naming up, i\u0027m not married to it).  Having a `vminfo` subcommand like:\n\n # vminfo refresh\n\nMay be a nice addition for operators to trigger a full refresh if they suspect an event has been missed.  Events *shouldn\u0027t* be missed, but if someone is considering restarting vminfod, this command will be a good first step before rushing to that solution."},{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":488,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"s/its/it is/"},{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":488,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/operator-guide/vminfod/intro.md","type":"ADDED","insertions":45,"deletions":0},{"file":"docs/operator-guide/vminfod/troubleshooting.md","type":"ADDED","insertions":498,"deletions":0}],"sizeInsertions":543,"sizeDeletions":0},{"number":"2","revision":"b6944b22655c25a08b37e21808c01921e6c528d0","parents":["e0430961d64fa2f229aa737583d1e1e5307b505a"],"ref":"refs/changes/28/4828/2","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1537379010,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1537379013,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1537382946,"by":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/operator-guide/vminfod/intro.md","type":"ADDED","insertions":45,"deletions":0},{"file":"docs/operator-guide/vminfod/troubleshooting.md","type":"ADDED","insertions":514,"deletions":0}],"sizeInsertions":559,"sizeDeletions":0},{"number":"3","revision":"7d73837897346c7b9a7cb17d2f23c382467a3684","parents":["e0430961d64fa2f229aa737583d1e1e5307b505a"],"ref":"refs/changes/28/4828/3","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1537396480,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1537379013,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1537382946,"by":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"}}],"comments":[{"file":"docs/operator-guide/vminfod/intro.md","line":4,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"\"crash course/1000 foot view\""},{"file":"docs/operator-guide/vminfod/intro.md","line":4,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"\"foot of view\" omg.  good catch."},{"file":"docs/operator-guide/vminfod/intro.md","line":13,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Maybe call them instances?"},{"file":"docs/operator-guide/vminfod/intro.md","line":13,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"So, I choose VM here for a couple of reasons.\n\n1. The RFD talks about the \"VM\" abstraction wrt vminfod: https://github.com/joyent/rfd/tree/master/rfd/0039\n2. \"vminfod\" being the VM Information Daemon."},{"file":"docs/operator-guide/vminfod/intro.md","line":19,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"How about phrasing this as:\n\n    On a system that has `vminfod`, read-only `vmadm` actions like\n    `vmadm list`, `vmadm lookup`, and `vmadm get` are\n    thin wrappers around HTTP requests to the daemon."},{"file":"docs/operator-guide/vminfod/intro.md","line":19,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Good call. I\u0027ll get read of the \"will\" and replace it with \"does\" effectively - i.e. drop the future tense."},{"file":"docs/operator-guide/vminfod/intro.md","line":33,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I think this would sound better as:\n\n    This works by long-polling the `/events` endpoint, which\n    sends newline-separate JSON objects each time a change is\n    made to the system; for example, when a VM is created,\n    deleted, or one of its properties is modified."},{"file":"docs/operator-guide/vminfod/intro.md","line":33,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"docs/operator-guide/vminfod/intro.md","line":42,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"(Triton, its agents, etc.)"},{"file":"docs/operator-guide/vminfod/intro.md","line":42,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"docs/operator-guide/vminfod/intro.md","line":45,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"\"modifying `vmadm` itself, in which case you should be able to find examples and comments throughout the source to help you out.\""},{"file":"docs/operator-guide/vminfod/intro.md","line":45,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":205,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"a JavaScript syntax error."},{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":205,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":290,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Things become concerning when these values start getting into the seconds or even minutes range, indicating that vminfod is taking a long time to do what should be quick work."},{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":290,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"+1"},{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":360,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"\"the result of a race between the two commands and a third command updating the system,\""},{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":360,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"+1"},{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":370,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"with `vmapi`, `vm-agent`"},{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":370,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":475,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Should you add something like:\n\n    right when a command is executed, in which case it might be 1 or 2. Subsequent ones should show that it\u0027s been processed, and the value is again 0."},{"file":"docs/operator-guide/vminfod/troubleshooting.md","line":475,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"docs/operator-guide/vminfod/intro.md","type":"ADDED","insertions":45,"deletions":0},{"file":"docs/operator-guide/vminfod/troubleshooting.md","type":"ADDED","insertions":514,"deletions":0}],"sizeInsertions":559,"sizeDeletions":0},{"number":"4","revision":"47e1ac4544a1e1cc2f431cd8ec53eb2d26047643","parents":["e0430961d64fa2f229aa737583d1e1e5307b505a"],"ref":"refs/changes/28/4828/4","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1537563187,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1537567540,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1537563190,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1537568327,"by":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"docs/operator-guide/vminfod/intro.md","type":"ADDED","insertions":43,"deletions":0},{"file":"docs/operator-guide/vminfod/troubleshooting.md","type":"ADDED","insertions":517,"deletions":0}],"sizeInsertions":560,"sizeDeletions":0},{"number":"5","revision":"65074b7790297c74ed3421fa54f38665b7804c9e","parents":["e0430961d64fa2f229aa737583d1e1e5307b505a"],"ref":"refs/changes/28/4828/5","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1537568494,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1537567540,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1537563190,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1537568327,"by":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"}},{"type":"SUBM","value":"1","grantedOn":1537568508,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"docs/operator-guide/vminfod/intro.md","type":"ADDED","insertions":43,"deletions":0},{"file":"docs/operator-guide/vminfod/troubleshooting.md","type":"ADDED","insertions":517,"deletions":0}],"sizeInsertions":560,"sizeDeletions":0}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}]}