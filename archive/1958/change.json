{"project":"joyent/sdc-manta","branch":"master","id":"Id165f72f81882e39e63f50410819a0aba974ac98","number":"1958","subject":"RFD 84 Support additional properties in update config","owner":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"url":"https://cr.joyent.us/1958","commitMessage":"RFD 84 Support additional properties in update config\n","createdOn":1494926996,"lastUpdated":1494930580,"open":true,"status":"NEW","comments":[{"timestamp":1494926996,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 1."},{"timestamp":1494927047,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1494930580,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 1: Code-Review-1\n\nThis change allows `manta-adm` to make use of the new config layout defined in RFD 84. A few notes that are likely worth adding to the RFD:\n\n- Default untrusted networks are defined in the config by omitting the \"untrusted_networks\" property\n- Where a service would usually get a default untrusted network (marlin, loadbalancer), no untrusted networks can be defined as an empty array (\"untrusted_networks: []\")\n- Service always gets NICs on trusted networks (\"admin\" and \"manta\"), which cannot be modified in the config\n- When using `show -js`, if the service has any untrusted networks, all will be displayed, including any that would otherwise be skipped due to them being the default. Likewise, in `update`, if an additional network is required on top of the defaults, all networks must be defined. I can clarify this with an example if it helps\n\nThe \"defaults\" in this case are made a little kludgy because they\u0027re defined in SAPI for a service as the names of the networks. I don\u0027t know of a good way for an operator to see what default networks a service should have, other than a SAPI call. I\u0027m sure this could be added to `manta-adm` somewhere, however. I\u0027m also uncertain about how versioning Manta states would work with my change, as if someday we support the operation of changing the default networks, this would not be reflected in configuration files prior to that kind of modification. The alternative is to always show any untrusted networks in the config, which is the version I used in SPC.\n\nNo modifications to existing zones are made with this change; zones must be deprovisioned/provisioned to change their untrusted_networks. I can get this to work and I want to support it, but I\u0027m not happy with the method I have at the moment.\n\nLastly, I\u0027ve not found a good way of supporting multiple versions of the config, either when used with `update` or `show -js`. I wanted to support updating using v1 in case there is tooling that still generates that type of config (or for rollbacks to pre-v2 config), but I\u0027ve found the code to get quite hacky. With `show -js`, I need to somehow get the required version into maAdm before loadInstances is called, but it feels like the best way to do this would be to have maAdm (lib/adm.js) support an \"options\" object instead of the current \"log\" object.\n\nI\u0027ve used this code with `genconfig --from-file` using the spc-ams data and it generates a sane-looking configuration file for each AZ. I\u0027ve also used a version of this change to deploy loadbalancers into SPC. I\u0027ve performed some minor testing on this change, but I would certainly like to make use of this in a bigger environment once any code changes settle down."}],"currentPatchSet":{"number":"1","revision":"d165f72f81882e39e63f50410819a0aba974ac98","parents":["b4abfc8d0002640430e9beabb19f9de6a9b13607"],"ref":"refs/changes/58/1958/1","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1494926996,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1494927047,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1494930580,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":119,"deletions":-27},{"file":"lib/deploy.js","type":"MODIFIED","insertions":56,"deletions":-7},{"file":"lib/services.js","type":"MODIFIED","insertions":45,"deletions":-6}],"sizeInsertions":220,"sizeDeletions":-40},"patchSets":[{"number":"1","revision":"d165f72f81882e39e63f50410819a0aba974ac98","parents":["b4abfc8d0002640430e9beabb19f9de6a9b13607"],"ref":"refs/changes/58/1958/1","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1494926996,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1494927047,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1494930580,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":119,"deletions":-27},{"file":"lib/deploy.js","type":"MODIFIED","insertions":56,"deletions":-7},{"file":"lib/services.js","type":"MODIFIED","insertions":45,"deletions":-6}],"sizeInsertions":220,"sizeDeletions":-40}],"allReviewers":[{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}]}