From a339603f3a440f239b38024d7e2f0116b024466a Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Mon, 10 Apr 2017 23:19:55 +0000
Subject: [PATCH] DAPI-340 Allow VMs to provide NIC tag alternatives

---
 lib/endpoints/allocations.js | 12 ++++++++++++
 package.json                 |  2 +-
 2 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/lib/endpoints/allocations.js b/lib/endpoints/allocations.js
index 695daac..7238203 100644
--- a/lib/endpoints/allocations.js
+++ b/lib/endpoints/allocations.js
@@ -34,6 +34,7 @@ var ALLOC_VALIDATION_RULES = {
     package:  ['optional', 'isObjectType'],
     image:    ['isObjectType'],
     vm:       ['isObjectType'],
+    nic_tag_requirements: ['optional', 'isArrayType'],
     nic_tags: ['isArrayType']
 };
 
@@ -94,6 +95,7 @@ Allocations.allocate = function handlerAllocationsAllocate(req, res, next) {
     var img     = params.image;
     var pkg     = params.package;
     var vm      = params.vm;
+    var tagreqs = params.nic_tag_requirements;
     var tags    = params.nic_tags;
 
     err = Designation.validations.validateImage(img);
@@ -126,6 +128,16 @@ Allocations.allocate = function handlerAllocationsAllocate(req, res, next) {
         }
     }
 
+    if (tagreqs) {
+        err = Designation.validations.validateNicTagRequirements(tagreqs);
+        if (err) {
+            invalid('nic_tag_requirements', err, res, next);
+            return;
+        }
+    }
+
+    vm.nic_tag_requirements = tagreqs;
+
     for (i = 0; i !== tags.length; i++) {
         if (typeof (tags[i]) !== 'string') {
             invalid('nic_tags', 'invalid nic_tag', res, next);
diff --git a/package.json b/package.json
index 37e6a7d..bcbabf3 100644
--- a/package.json
+++ b/package.json
@@ -9,7 +9,7 @@
     "assert-plus": "1.0.0",
     "async": "1.5.2",
     "bunyan": "1.8.5",
-    "dapi": "git+https://github.com/joyent/sdc-designation.git#f66ba1897f0eafcc3439d0af39555a3bdaebce4c",
+    "dapi": "git+https://github.com/joyent/sdc-designation.git#DAPI-340",
     "deep-equal": "1.0.1",
     "dox": "0.4.1",
     "effluent-logger": "git+https://github.com/joshwilsdon/effluent-logger.git#d662f161a07f94045ad2afb45442931511c40e51",
-- 
2.21.0

