{"project":"joyent/muppet","branch":"master","id":"Ifce275d57fa59b896acd9543d10dc717bdc7f0e0","number":"2074","subject":"MANTA-2038 muppet: haproxies get restarted when new LBs are deployed (should only be when new muskies are deployed) MANTA-3240 muppet tests are broken Reviewed by: Dave Pacheco \u003cdap@joyent.com\u003e Approved by: Dave Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"url":"https://cr.joyent.us/2074","commitMessage":"MANTA-2038 muppet: haproxies get restarted when new LBs are deployed (should only be when new muskies are deployed)\nMANTA-3240 muppet tests are broken\nReviewed by: Dave Pacheco \u003cdap@joyent.com\u003e\nApproved by: Dave Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1497258028,"lastUpdated":1497626978,"open":false,"status":"MERGED","comments":[{"timestamp":1497258028,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 1."},{"timestamp":1497258057,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1497304725,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1497345679,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 2."},{"timestamp":1497345708,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1497346047,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 2:\n\n(2 comments)\n\nThanks for the feedback!"},{"timestamp":1497546903,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2: Code-Review+1\n\nThanks!  That all makes sense."},{"timestamp":1497547190,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2: Integration-Approval+1\n\nI\u0027m assuming the latest patchset is still `make prepush` clean."},{"timestamp":1497620852,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 2:\n\nYep, `make prepush` is clean with the latest patch set."},{"timestamp":1497621174,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1497626978,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Richard Bradley"}],"currentPatchSet":{"number":"3","revision":"fce275d57fa59b896acd9543d10dc717bdc7f0e0","parents":["8f7f4752a0af68ff5d73eb1443167cdc37805c65"],"ref":"refs/changes/74/2074/3","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1497621174,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1497345708,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1497546903,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1497547190,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1497626978,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/watch.js","type":"MODIFIED","insertions":30,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":0},{"file":"test/helper.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/watch.test.js","type":"MODIFIED","insertions":5,"deletions":-1}],"sizeInsertions":40,"sizeDeletions":-10},"patchSets":[{"number":"1","revision":"979d3ea51a73b7b5b6d5646b4328efc4f3db3afa","parents":["8f7f4752a0af68ff5d73eb1443167cdc37805c65"],"ref":"refs/changes/74/2074/1","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1497258028,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1497258057,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/helper.js","line":54,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Do we know for sure why this was necessary?  It seems really odd that this would just have been omitted before."},{"file":"test/helper.js","line":54,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I don\u0027t know for certain, and I can\u0027t say I like the answer, but it seems that MANTA-550 bumped the version of node-zkplus and added the \"connect()\" call to main.js, but not to the test suite. If this is true then it means the test suite would have been failing since that change (unless for some reason someone had local changes to their suite and didn\u0027t check them in), or possibly had old dependencies.\n\nLooking at node-zkplus for the versions in the above change (from 2f0667c to b12cc44), the docs don\u0027t change, but the test suite does:\n\nhttps://github.com/mcavage/node-zkplus/blob/2f0667c5d78009aa70f0084f7452b6b8e9aa1561/test/client.test.js\n\nhttps://github.com/mcavage/node-zkplus/blob/b12cc445062d52a8fffd88e40158fc495b19fc5a/test/client.test.js\n\nYou can see in b12cc44 that the node-zkplus test suite explicitly calls \"connect()\".\n\nLastly, in 2f0667c, we can see that \"connect()\" is called by node-zkplus if \"options.connect\" is set (https://github.com/mcavage/node-zkplus/blob/2f0667c5d78009aa70f0084f7452b6b8e9aa1561/lib/client.js#L100-L101). This comes from createClient in lib/index.js, where if \"options.connect\" at that point is undefined we set it to true (https://github.com/mcavage/node-zkplus/blob/2f0667c5d78009aa70f0084f7452b6b8e9aa1561/lib/index.js#L34-L35). This is not the case in b12cc44, where (from what I can tell) it must be explicitly called by the consumer of the library."},{"file":"test/watch.test.js","line":69,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Thanks for digging into the test suite failures.  I do think we should probably understand and fix the underlying problem instead of adding the timeout here."},{"file":"test/watch.test.js","line":69,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"The underlying problem here is that we\u0027ll emit \"hosts\" on connect, and the \"create watch\" test was successful only because the \"watch()\" method was successful. We then proceed to the \"host addition\" test, but the Watch in that test was firing on the emitted \"hosts\" event from \"create watch\", not from its own test.\n\nI think a nicer answer in this case is to only pass on a \"hosts\" event in \"create watch\", as opposed to passing on \"watch()\" being successful. This is addressed in PS2."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/watch.js","type":"MODIFIED","insertions":30,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":0},{"file":"test/helper.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/watch.test.js","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":38,"sizeDeletions":-10},{"number":"2","revision":"0c0d1ed51f10daceae375e8d42dfeb6e981305ca","parents":["8f7f4752a0af68ff5d73eb1443167cdc37805c65"],"ref":"refs/changes/74/2074/2","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1497345679,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1497546903,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1497547190,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1497345708,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/watch.js","type":"MODIFIED","insertions":30,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":0},{"file":"test/helper.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/watch.test.js","type":"MODIFIED","insertions":5,"deletions":-1}],"sizeInsertions":40,"sizeDeletions":-10},{"number":"3","revision":"fce275d57fa59b896acd9543d10dc717bdc7f0e0","parents":["8f7f4752a0af68ff5d73eb1443167cdc37805c65"],"ref":"refs/changes/74/2074/3","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1497621174,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1497546903,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1497547190,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1497345708,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1497626978,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/watch.js","type":"MODIFIED","insertions":30,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":0},{"file":"test/helper.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/watch.test.js","type":"MODIFIED","insertions":5,"deletions":-1}],"sizeInsertions":40,"sizeDeletions":-10}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}]}