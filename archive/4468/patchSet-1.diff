From f576bb4c9f5214b890bcc6c78052259e9427a756 Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Mon, 2 Jul 2018 23:00:05 +0000
Subject: [PATCH] MORAY-457 Moray getObject() request hangs (prevent new
 queries)

---
 lib/pg.js | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

diff --git a/lib/pg.js b/lib/pg.js
index 02b25cc..e91df39 100644
--- a/lib/pg.js
+++ b/lib/pg.js
@@ -247,6 +247,18 @@ PGClient.prototype.query = function clientQuery(sql, args) {
     var self = this;
     var timer;
 
+    if (self._moray_had_err !== null) {
+        /*
+         * If we've hit a connection error, then we need to make sure to
+         * avoid calling the node-postgres .query() method, since it won't
+         * emit anything.
+         */
+        setImmediate(function () {
+            res.emit('error', self._moray_had_err);
+        });
+        return res;
+    }
+
     /*
      * Moray will periodically issue the query 'SELECT NOW() AS when' to
      * available PGClients as a health checking facility (see pgCheck).
@@ -377,7 +389,7 @@ PGClient.prototype.query = function clientQuery(sql, args) {
         args: args
     }, 'pg.query: started');
 
-    return (res);
+    return res;
 };
 
 
-- 
2.21.0

