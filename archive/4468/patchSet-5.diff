commit c7bfe5adb88f274bb79d94999fc710c259600cf8 (refs/changes/68/4468/5)
Author: Cody Peter Mello <cody.mello@joyent.com>
Date:   2018-07-23T22:57:33+00:00 (1 year, 3 months ago)
    
    MORAY-483 Prevent new queries when Postgres client has emitted an error
    Reviewed by: Jan Wyszynski <jan.wyszynski@joyent.com>
    Approved by: Jan Wyszynski <jan.wyszynski@joyent.com>

diff --git a/lib/pg.js b/lib/pg.js
index c1d6949..f3a43b7 100644
--- a/lib/pg.js
+++ b/lib/pg.js
@@ -247,6 +247,18 @@ PGClient.prototype.query = function clientQuery(sql, args) {
     var self = this;
     var timer;
 
+    if (self._moray_had_err !== null) {
+        /*
+         * If we've hit a connection error, then we need to make sure to
+         * avoid calling the node-postgres .query() method, since it won't
+         * emit anything.
+         */
+        setImmediate(function () {
+            res.emit('error', self._moray_had_err);
+        });
+        return res;
+    }
+
     /*
      * Moray will periodically issue the query 'SELECT NOW() AS when' to
      * available PGClients as a health checking facility (see pgCheck).
@@ -274,7 +286,7 @@ PGClient.prototype.query = function clientQuery(sql, args) {
             return ([reqid, sql, err.toString()]);
         });
 
-        done('error', err);
+        setImmediate(done, 'error', err);
     }
 
     req = new pg.Query(sql, args);
@@ -377,7 +389,7 @@ PGClient.prototype.query = function clientQuery(sql, args) {
         args: args
     }, 'pg.query: started');
 
-    return (res);
+    return res;
 };
 
 
