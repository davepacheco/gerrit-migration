From 10d14237d0442934fb56029e04f91203df782f7e Mon Sep 17 00:00:00 2001
From: Mike Zeller <mike.zeller@joyent.com>
Date: Thu, 28 Sep 2017 12:00:25 -0700
Subject: [PATCH] NAPI-433 listNetworkIPs schema should accept owner_uuid

---
 lib/models/ip/index.js       |  1 +
 test/integration/ips.test.js | 40 +++++++++++++++++++++++++++++++-----
 2 files changed, 36 insertions(+), 5 deletions(-)

diff --git a/lib/models/ip/index.js b/lib/models/ip/index.js
index fdc850a..35b9a67 100644
--- a/lib/models/ip/index.js
+++ b/lib/models/ip/index.js
@@ -62,6 +62,7 @@ var LIST_SCHEMA = {
     optional: {
         belongs_to_type: validate.string,
         belongs_to_uuid: validate.UUID,
+        owner_uuid: validate.UUID,
         limit: validate.limit,
         offset: validate.offset
     }
diff --git a/test/integration/ips.test.js b/test/integration/ips.test.js
index 86df88c..27f7d73 100644
--- a/test/integration/ips.test.js
+++ b/test/integration/ips.test.js
@@ -41,6 +41,7 @@ var napi = h.createNAPIclient();
 var state = {};
 var uuids = {
     admin: config.server.ufdsAdminUuid,
+    owner: 'c5897cd3-afc7-470d-bc32-dd88277742ac',
     a: '564d69b1-a178-07fe-b36f-dfe5fa3602e2'
 };
 
@@ -121,7 +122,7 @@ test('GET /networks/:uuid/ips/:ip (free IP)', function (t) {
 test('PUT /networks/:uuid/ips/:ip', function (t) {
     var params = {
         reserved: true,
-        owner_uuid: uuids.admin,
+        owner_uuid: uuids.owner,
         belongs_to_type: 'zone',
         belongs_to_uuid: uuids.a
     };
@@ -177,10 +178,39 @@ test('GET /networks/:uuid/ips', function (t) {
         reserved: false
     };
 
-    mod_ip.list(t, {
-        deepEqual: true,
-        net: state.networks[0].uuid,
-        present: [ before, state.ip, after, broadcastIP ]
+    t.test('no filters', function (t2) {
+        mod_ip.list(t2, {
+            deepEqual: true,
+            net: state.networks[0].uuid,
+            present: [ before, state.ip, after, broadcastIP ]
+        });
+    });
+
+    t.test('filter by owner_uuid', function (t2) {
+        mod_ip.list(t2, {
+            deepEqual: true,
+            net: state.networks[0].uuid,
+            params: { owner_uuid: uuids.owner },
+            present: [ state.ip ]
+        });
+    });
+
+    t.test('filter by belongs_to_type', function (t2) {
+        mod_ip.list(t2, {
+            deepEqual: true,
+            net: state.networks[0].uuid,
+            params: { belongs_to_type: 'other' },
+            present: [ broadcastIP ]
+        });
+    });
+
+    t.test('filter by belongs_to_uuid', function (t2) {
+        mod_ip.list(t2, {
+            deepEqual: true,
+            net: state.networks[0].uuid,
+            params: { belongs_to_uuid: uuids.admin },
+            present: [ broadcastIP ]
+        });
     });
 });
 
-- 
2.21.0

