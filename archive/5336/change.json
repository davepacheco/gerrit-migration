{"project":"joyent/smartos-live","branch":"master","id":"Id6c6378954b02d3b39c64e198d811afcd9cc1081","number":"5336","subject":"OS-6721 vmadm info doesn\u0027t work with bhyve Reviewed by: Dylan Yep \u003cdylan.yep@joyent.com\u003e Reviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e Approved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e","owner":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"url":"https://cr.joyent.us/5336","commitMessage":"OS-6721 vmadm info doesn\u0027t work with bhyve\nReviewed by: Dylan Yep \u003cdylan.yep@joyent.com\u003e\nReviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\nApproved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\n","createdOn":1547049746,"lastUpdated":1547219916,"open":false,"status":"MERGED","comments":[{"timestamp":1547049746,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 1."},{"timestamp":1547049800,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1547050815,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 2."},{"timestamp":1547050869,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1547050900,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(1 comment)\n\nTest output looks like:\n\n# Running tests/test-info.js\nAlready have \"imgapi\" image source \"https://images.joyent.com\", no change\nAlready have \"docker\" image source \"https://docker.io\", no change\nTAP version 13\n# bhyve info\nok 1 test matches BRAND_INFO runtime_info\nok 2 VM created with uuid ef4aed42-3a90-eeb8-a4db-bd221852e99a\nok 3 VM loaded uuid ef4aed42-3a90-eeb8-a4db-bd221852e99a\nok 4 VM is running\nok 5 all1 returns expected keys: vnc\nok 6 all2 returns expected keys: vnc\nok 7 all3 returns expected keys: vnc\nok 8 some returns expected keys: vnc\nok 9 spice: expected error \"unknown info type\", got error: unknown info type spice\nok 10 bogus: expected error \"unknown info type\", got error: unknown info type bogus\n# kvm info\nok 11 test matches BRAND_INFO runtime_info\nok 12 VM created with uuid 5ca60e57-bca1-e138-e04b-ddf5b0fad1b6\nok 13 VM loaded uuid 5ca60e57-bca1-e138-e04b-ddf5b0fad1b6\nok 14 VM is running\nok 15 all1 returns expected keys: block, blockstats, chardev, cpus, kvm, pci, spice, status, version, vnc\nok 16 all2 returns expected keys: block, blockstats, chardev, cpus, kvm, pci, spice, status, version, vnc\nok 17 all3 returns expected keys: block, blockstats, chardev, cpus, kvm, pci, spice, status, version, vnc\nok 18 some returns expected keys: block, blockstats, chardev\nok 19 blurp: expected error \"unknown info type\", got error: unknown info type blurp\nok 20 bogus: expected error \"unknown info type\", got error: unknown info type bogus\n\n1..20\n# tests 20\n# pass  20\n\n# ok\n#\n# tests/test-info.js TEST COMPLETE IN 11 SECONDS, SUMMARY:\n#\n# PASS: 20 / 20\n#"},{"timestamp":1547112918,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1547133410,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\n(1 comment)\n\nOther than the issue with for in loop already mentioned by Dylan, LGTM."},{"timestamp":1547142686,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1547142697,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 3."},{"timestamp":1547142750,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1547145950,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1547219731,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1\n\nI assume tests keep passing"},{"timestamp":1547219852,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1547219863,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1547219875,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Mike Gerdts"},{"timestamp":1547219916,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"5","revision":"6c1f3983a964960d8f988414267c278a0f000c92","parents":["ee456f59269a611450b84f25799322baedcb721e"],"ref":"refs/changes/36/5336/5","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1547219863,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1547142750,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547145950,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547219731,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547219731,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1547219875,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"src/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":27,"deletions":-33},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":1,"deletions":-8},{"file":"src/vm/sbin/vmadmd.js","type":"MODIFIED","insertions":52,"deletions":-31},{"file":"src/vm/tests/test-info.js","type":"ADDED","insertions":225,"deletions":0}],"sizeInsertions":312,"sizeDeletions":-76},"patchSets":[{"number":"1","revision":"cef6604e3687fab11f621684dd80a61d59ded366","parents":["8f1e83bbc31331e3df3195a73ce4aff4797d60fe"],"ref":"refs/changes/36/5336/1","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1547049746,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1547049800,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":28,"deletions":-33},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":1,"deletions":-8},{"file":"src/vm/sbin/vmadmd.js","type":"MODIFIED","insertions":53,"deletions":-32},{"file":"src/vm/tests/test-info.js","type":"ADDED","insertions":213,"deletions":0}],"sizeInsertions":302,"sizeDeletions":-77},{"number":"2","revision":"6914b6730f61cecb3b65a1ef2f03cc3ba4905840","parents":["8f1e83bbc31331e3df3195a73ce4aff4797d60fe"],"ref":"refs/changes/36/5336/2","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1547050815,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1547050869,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/vm/node_modules/VM.js","line":17706,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Nit: This probably won\u0027t be an issue, but the for-in construct is generally used to enumerate over object properties. The potential issue with using it to iterate over an array is that it includes inherited properties. So, for example, if\n\n```\nArray.prototype.foo \u003d \u0027foo\u0027;\n```\nwas defined somewhere\n\n```\nfor (type in types)\n```\n\nwould include \u0027foo\u0027\n\nA for loop is the safest bet."},{"file":"src/vm/node_modules/VM.js","line":17706,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"+1 on this!"},{"file":"src/vm/node_modules/VM.js","line":17706,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Just moved this code from a different place, but will change as you suggest."},{"file":"src/vm/sbin/vmadm.js","line":372,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"The valid types vary by brand.  We don\u0027t know the brand yet, so we can\u0027t do an accurate check.  Best to avoid gratuitous VM.load() here and just deal with any errors from vmadmd."},{"file":"src/vm/sbin/vmadmd.js","line":1471,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"%s/fileds/fields"},{"file":"src/vm/sbin/vmadmd.js","line":1471,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"src/vm/tests/test-info.js","line":66,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Maybe use vmadm for these tests instead of VM.js? There was talk here \n\nhttps://chat.joyent.us/joyent/pl/eq5qjm1d4inrdg1d9noz8yo1fo\n\nabout avoiding the use of VM.js directly."},{"file":"src/vm/tests/test-info.js","line":66,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"The tests do generate logs under /var/log/vm/logs due to VM.*() calling ensureLogging().  logadm causes these to appear (possibly with modification?) in /var/log/vm/*VM.log when it is run on an hourly basis.\n\nDuring development, I regularly use the following to view the log for the test I just ran.\n\n  bunyan --color \"$(ls -rt /var/log/vm/logs/* | tail -1)\" | less -R\n\nReplacing calls to VM.foo with vmadm foo would just make it harder to get the full story of a test failure because there would be no easy way to figure out which of the logs in /var/vm/logs are relevant.\n\nThere are many things we could do to improve testing observability.  I think that creating more ephemeral log files that lack a way to understand the relationship between them is not one of them.  Specific suggested improvements are in OS-7502."},{"file":"src/vm/tests/test-info.js","line":114,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Since this ticket is meant to add functionality to vmadm, should we should test vmadm directly? A function wrapping vmadm is exported here\n\nhttps://github.com/joyent/smartos-live/blob/master/src/vm/tests/common.js#L33"},{"file":"src/vm/tests/test-info.js","line":114,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":27,"deletions":-33},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":1,"deletions":-8},{"file":"src/vm/sbin/vmadmd.js","type":"MODIFIED","insertions":53,"deletions":-32},{"file":"src/vm/tests/test-info.js","type":"ADDED","insertions":213,"deletions":0}],"sizeInsertions":301,"sizeDeletions":-77},{"number":"3","revision":"d6c6378954b02d3b39c64e198d811afcd9cc1081","parents":["8f1e83bbc31331e3df3195a73ce4aff4797d60fe"],"ref":"refs/changes/36/5336/3","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1547142697,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1547142750,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547219731,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547219731,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547145950,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":27,"deletions":-33},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":1,"deletions":-8},{"file":"src/vm/sbin/vmadmd.js","type":"MODIFIED","insertions":52,"deletions":-31},{"file":"src/vm/tests/test-info.js","type":"ADDED","insertions":225,"deletions":0}],"sizeInsertions":312,"sizeDeletions":-76},{"number":"4","revision":"9adbca41868f3e17e63c465855236419fda25ef5","parents":["8f1e83bbc31331e3df3195a73ce4aff4797d60fe"],"ref":"refs/changes/36/5336/4","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1547219852,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1547142750,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547219731,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547219731,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547145950,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"src/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":27,"deletions":-33},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":1,"deletions":-8},{"file":"src/vm/sbin/vmadmd.js","type":"MODIFIED","insertions":52,"deletions":-31},{"file":"src/vm/tests/test-info.js","type":"ADDED","insertions":225,"deletions":0}],"sizeInsertions":312,"sizeDeletions":-76},{"number":"5","revision":"6c1f3983a964960d8f988414267c278a0f000c92","parents":["ee456f59269a611450b84f25799322baedcb721e"],"ref":"refs/changes/36/5336/5","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1547219863,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1547142750,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547219731,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547219731,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1547219875,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547145950,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"src/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":27,"deletions":-33},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":1,"deletions":-8},{"file":"src/vm/sbin/vmadmd.js","type":"MODIFIED","insertions":52,"deletions":-31},{"file":"src/vm/tests/test-info.js","type":"ADDED","insertions":225,"deletions":0}],"sizeInsertions":312,"sizeDeletions":-76}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}]}