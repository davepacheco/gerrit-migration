From e309691d92d05393e0ff771cc9562a2744aedc27 Mon Sep 17 00:00:00 2001
From: David Pacheco <dap@joyent.com>
Date: Thu, 11 Aug 2016 20:43:03 -0700
Subject: [PATCH] MORAY-347 moray testing process could be improved, documented

---
 Makefile           | 17 ++-------
 README.md          | 10 +----
 package.json       |  3 --
 test/helper.js     | 54 --------------------------
 test/long_run.js   | 94 ----------------------------------------------
 test/manta-1987.js | 50 ------------------------
 test/moray-199.js  | 78 --------------------------------------
 7 files changed, 5 insertions(+), 301 deletions(-)
 delete mode 100644 test/helper.js
 delete mode 100644 test/long_run.js
 delete mode 100644 test/manta-1987.js
 delete mode 100755 test/moray-199.js

diff --git a/Makefile b/Makefile
index 3ce51ab..4011839 100644
--- a/Makefile
+++ b/Makefile
@@ -5,7 +5,7 @@
 #
 
 #
-# Copyright (c) 2014, Joyent, Inc.
+# Copyright (c) 2016, Joyent, Inc.
 #
 
 #
@@ -25,13 +25,12 @@
 #
 # Tools
 #
-NODEUNIT		:= ./node_modules/.bin/nodeunit
 NPM			:= npm
 
 #
 # Files
 #
-JS_FILES	:= $(shell find lib test -name '*.js')
+JS_FILES	:= $(shell find lib -name '*.js')
 JSL_CONF_NODE	 = tools/jsl.node.conf
 JSL_FILES_NODE   = $(JS_FILES)
 JSSTYLE_FILES	 = $(JS_FILES)
@@ -45,18 +44,8 @@ include ./tools/mk/Makefile.smf.defs
 # Repo-specific targets
 #
 .PHONY: all
-all: $(NODEUNIT) $(REPO_DEPS)
+all: $(REPO_DEPS)
 	$(NPM) rebuild
 
-$(NODEUNIT): | $(NPM_EXEC)
-	$(NPM) install
-
-CLEAN_FILES += $(NODEUNIT) ./node_modules/nodeunit
-
-.PHONY: test
-test: $(NODEUNIT)
-	echo "write some tests"
-	#$(NODEUNIT) test/*.test.js
-
 include ./tools/mk/Makefile.deps
 include ./tools/mk/Makefile.targ
diff --git a/README.md b/README.md
index 15c3f3b..b1f5428 100644
--- a/README.md
+++ b/README.md
@@ -23,11 +23,5 @@ For usage information, visit the Moray docs.
 
 # Testing
 
-To test this Moray client:
-
-- Clone the Moray server repo.
-- Use "make" to build the Moray server repo.
-- Use "npm ln" to link your client repo into the server repo for the "moray"
-  dependency (e.g., "cd /path/to/server/repo; npm ln /path/to/client/repo").
-- Follow the instructions in the Moray server repo to test it.  Since it's using
-  your client, this will exercise the test suite using your client.
+To test this Moray client, see the separate
+[moray-test-suite](https://github.com/joyent/moray-test-suite) repository.
diff --git a/package.json b/package.json
index 97d7079..ae045bc 100644
--- a/package.json
+++ b/package.json
@@ -25,8 +25,5 @@
         "bin": "./bin",
         "lib": "./lib"
     },
-    "devDependencies": {
-        "nodeunit": "0.8.1"
-    },
     "license": "MPL-2.0"
 }
diff --git a/test/helper.js b/test/helper.js
deleted file mode 100644
index e51bd97..0000000
--- a/test/helper.js
+++ /dev/null
@@ -1,54 +0,0 @@
-/*
- * This Source Code Form is subject to the terms of the Mozilla Public
- * License, v. 2.0. If a copy of the MPL was not distributed with this
- * file, You can obtain one at http://mozilla.org/MPL/2.0/.
- */
-
-/*
- * Copyright (c) 2014, Joyent, Inc.
- */
-
-///--- Exports
-
-module.exports = {
-
-    after: function after(teardown) {
-        module.parent.exports.tearDown = function _teardown(callback) {
-            try {
-                teardown.call(this, callback);
-            } catch (e) {
-                console.error('after:\n' + e.stack);
-                process.exit(1);
-            }
-        };
-    },
-
-    before: function before(setup) {
-        module.parent.exports.setUp = function _setup(callback) {
-            try {
-                setup.call(this, callback);
-            } catch (e) {
-                console.error('before:\n' + e.stack);
-                process.exit(1);
-            }
-        };
-    },
-
-    test: function test(name, tester) {
-        module.parent.exports[name] = function _(t) {
-            var _done = false;
-            t.end = function end() {
-                if (!_done) {
-                    _done = true;
-                    t.done();
-                }
-            };
-            t.notOk = function notOk(ok, message) {
-                return (t.ok(!ok, message));
-            };
-
-            tester.call(this, t);
-        };
-    }
-
-};
\ No newline at end of file
diff --git a/test/long_run.js b/test/long_run.js
deleted file mode 100644
index 1c96748..0000000
--- a/test/long_run.js
+++ /dev/null
@@ -1,94 +0,0 @@
-/*
- * This Source Code Form is subject to the terms of the Mozilla Public
- * License, v. 2.0. If a copy of the MPL was not distributed with this
- * file, You can obtain one at http://mozilla.org/MPL/2.0/.
- */
-
-/*
- * Copyright (c) 2014, Joyent, Inc.
- */
-
-var assert = require('assert-plus');
-var bunyan = require('bunyan');
-var libuuid = require('libuuid');
-
-var moray = require('../lib');
-
-
-
-///--- Globals
-
-var BUCKET = 't' + libuuid.create().substr(0, 7);
-var CONFIG = {
-    index: {
-        foo: {
-            type: 'string'
-        }
-    }
-};
-
-
-
-///--- Mainline
-(function main() {
-    var client = moray.createClient({
-        connectTimeout: 1000,
-        dns: {
-            checkInterval: 2000,
-            // resolvers: ['10.99.99.201'],
-            timeout: 500
-        },
-        log: bunyan.createLogger({
-            name: 'moray_client',
-            level: process.env.LOG_LEVEL || 'info',
-            stream: process.stdout
-        }),
-        maxConnections: 100,
-        retry: {retries: 2},
-        url: process.env.MORAY_URL || 'tcp://127.0.0.1:2020'
-    });
-
-    client.once('connect', function () {
-        client.putBucket(BUCKET, CONFIG, function (init_err) {
-            assert.ifError(init_err);
-
-            var MAX = 25000;
-            function run() {
-                var done = 0;
-                function cb(err) {
-                    if (err) {
-                        console.error('put failed: %s',
-                                      err.toString());
-                    }
-
-                    if (++done === MAX) {
-                        function d_cb(derr) {
-                            assert.ifError(derr);
-                            client.close();
-                        }
-                        client.deleteBucket(BUCKET,
-                                            d_cb);
-                    }
-                }
-
-                function put(k, v) {
-                    function p_cb(err) {
-                        assert.ifError(err);
-                        client.getObject(BUCKET, k, cb);
-                    }
-                    client.putObject(BUCKET, k, v, p_cb);
-                }
-
-                for (var i = 0; i < MAX; i++) {
-                    var _k = libuuid.create();
-                    var _v = {
-                        foo: '' + i
-                    };
-                    put(_k, _v);
-                }
-            }
-
-            run();
-        });
-    });
-})();
diff --git a/test/manta-1987.js b/test/manta-1987.js
deleted file mode 100644
index 4297836..0000000
--- a/test/manta-1987.js
+++ /dev/null
@@ -1,50 +0,0 @@
-/*
- * This Source Code Form is subject to the terms of the Mozilla Public
- * License, v. 2.0. If a copy of the MPL was not distributed with this
- * file, You can obtain one at http://mozilla.org/MPL/2.0/.
- */
-
-/*
- * Copyright (c) 2014, Joyent, Inc.
- */
-
-var assert = require('assert-plus');
-var bunyan = require('bunyan');
-var moray = require('moray');
-
-var client = moray.createClient({
-    dns: {
-        resolvers: ['10.77.77.6']
-    },
-    host: '1.moray.coal.joyent.us',
-    port: 2020,
-    log: bunyan.createLogger({
-        name: 'moray',
-        level: process.env.LOG_LEVEL || 'trace',
-        stream: process.stdout,
-        serializers: bunyan.stdSerializers
-    }),
-    src: true
-});
-
-client.on('error', function (err) {
-    console.error(err.stack);
-    process.exit(1);
-});
-
-client.on('connect', function () {
-    console.log('starting...');
-    (function run() {
-        var res = client.find('manta', '_id=1091');
-        res.once('error', function (err) {
-            console.error(err.stack);
-            if (err.name !== 'NoConnectionError' &&
-                err.name !== 'ConnectionClosedError') {
-                process.exit(1);
-            } else {
-                run();
-            }
-        });
-        res.once('end', run);
-    })();
-});
diff --git a/test/moray-199.js b/test/moray-199.js
deleted file mode 100755
index 26e72e1..0000000
--- a/test/moray-199.js
+++ /dev/null
@@ -1,78 +0,0 @@
-#!/usr/bin/env node
-/*
- * This Source Code Form is subject to the terms of the Mozilla Public
- * License, v. 2.0. If a copy of the MPL was not distributed with this
- * file, You can obtain one at http://mozilla.org/MPL/2.0/.
- */
-
-/*
- * Copyright (c) 2014, Joyent, Inc.
- */
-
-var assert = require('assert');
-var bunyan = require('bunyan');
-var libuuid = require('libuuid');
-var moray = require('./lib');
-
-var client = moray.createClient({
-    dns: {
-        resolvers: ['10.99.99.11']
-    },
-    host: 'moray.coal.joyent.us',
-    log: bunyan.createLogger({
-        name: 'moray',
-        level: process.env.LOG_LEVEL || 'fatal',
-        stream: process.stdout,
-        serializers: bunyan.stdSerializers
-    }),
-    port: 2020
-});
-
-client.once('connect', function () {
-    client.getBucket('ufds_o_smartdc', function (err, cfg) {
-        assert.ifError(err);
-
-        console.log('starting...');
-
-        var errors = 0;
-        var map = {};
-        var success = 0;
-        var total = 0;
-        (function run() {
-            var id = libuuid.create();
-
-            function next(_err) {
-                delete map[id];
-
-                if (_err) {
-                    assert.ok(_err.name === 'ConnectionClosedError' ||
-                              _err.name === 'NoConnectionError');
-                    errors++;
-                } else {
-                    success++;
-                }
-
-                if (++total < 10000) {
-                    if (total % 1000 === 0)
-                        console.log(total);
-
-                    setImmediate(run);
-                } else {
-                    assert.ok((success + errors) === total);
-                    assert.ok(Object.keys(map).length === 0);
-                    console.log('done');
-                    client.close();
-                }
-            }
-
-            var res = client.find('ufds_o_smartdc', 'login=*');
-
-            map[id] = true;
-            res.once('error', next);
-            res.once('end', next);
-            res.on('record', function (r) {
-                assert.ok(r);
-            });
-        })();
-    });
-});
-- 
2.21.0

