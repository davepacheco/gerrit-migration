{"project":"joyent/smartos-live","branch":"master","id":"I0cd6bbfd50c8804d52a2f581cf4e5cb593250ded","number":"306","subject":"OS-5587 still possible for mdata to get 0 descriptor back from node-zsock Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/306","commitMessage":"OS-5587 still possible for mdata to get 0 descriptor back from node-zsock\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\n","createdOn":1471390494,"lastUpdated":1471562662,"open":false,"status":"MERGED","comments":[{"timestamp":1471390494,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1471390531,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1471390912,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1471414926,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(1 comment)\n\nI\u0027ve run through the /usr/vm and vm-agent tests and had all tests pass with this change hot-patched into a test system.\n\nI also was able to reproduce this behaviour earlier with a test where I created 128 zones and repeatedly reset them in a way similar to marlin. I was able to reproduce this issue there within 30 minutes, and after applying this change (and the OS-5594 fix) I have not had any cores."},{"timestamp":1471415403,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1471454424,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1471489665,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1471496943,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 2."},{"timestamp":1471496972,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n\"make check\" exited with status 2\n\n /tmp/repo/src/vm/node_modules/vmload/vmload-xml.js\n /tmp/repo/src/vm/node_modules/vmload/vmload-zoneadm.js\n /tmp/repo/src/vm/node_modules/vmload/vmload-zoneinfo.js\n /tmp/repo/src/vm/node_modules/sysevent-stream.js\n /tmp/repo/src/img/lib/IMG.js\n /tmp/repo/src/img/lib/cli.js\n /tmp/repo/src/img/lib/common.js\n /tmp/repo/src/img/lib/configuration.js\n /tmp/repo/src/img/lib/database.js\n /tmp/repo/src/img/lib/errors.js\n /tmp/repo/src/img/lib/imgadm.js\n /tmp/repo/src/img/lib/magic.js\n /tmp/repo/src/img/lib/upgrade.js\n /tmp/repo/src/img/sbin/imgadm\n /tmp/repo/src/vm/common/nictag.js\n /tmp/repo/src/vm/tests/test-alias.js\n /tmp/repo/src/vm/node_modules/nodeunit-plus/index.js\n /tmp/repo/src/vm/tests/test-cleanup-on-failure.js\n /tmp/repo/src/vm/tests/test-create.js\n /tmp/repo/src/vm/tests/test-create-filesystems.js\n /tmp/repo/src/vm/tests/test-docker.js\n /tmp/repo/src/vm/tests/test-defaults.js\n /tmp/repo/src/vm/tests/test-indestructible.js\n /tmp/repo/src/vm/tests/test-internal_metadata_namespaces.js\n /tmp/repo/src/vm/tests/test-lastexited.js\n /tmp/repo/src/vm/tests/test-openonerrlogger.js\n /tmp/repo/src/vm/tests/test-reboot.js\n /tmp/repo/src/vm/tests/test-reprovision.js\n /tmp/repo/src/vm/tests/test-snapshots.js\n /tmp/repo/src/vm/tests/test-spoof-opts.js\n /tmp/repo/src/vm/tests/test-tmpfs.js\n /tmp/repo/src/vm/tests/test-update.js\n /tmp/repo/src/vm/tests/test-vrrp-nics.js\n /tmp/repo/src/vm/lib/metadata/agent.js\n /tmp/repo/src/vm/lib/metadata/agent.js(654): warning: paren_after_args\n /tmp/repo/src/vm/lib/metadata/common.js\n /tmp/repo/src/vm/lib/metadata/crc32.js\n /tmp/repo/src/vm/lib/metadata/zwatch.js\n /tmp/repo/src/disklayout.js\n /tmp/repo/src/mkzpool.js\n /tmp/repo/src/ntp_config.js\n /tmp/repo/src/node_modules/disklayout.js\n \n 0 error(s), 1 warnings(s)\n Makefile:543: recipe for target \u0027check\u0027 failed\n make[1]: *** [check] Error 1\n make[1]: Leaving directory \u0027/tmp/repo/src\u0027\n Makefile:346: recipe for target \u0027check\u0027 failed\n gmake: *** [check] Error 2"},{"timestamp":1471497116,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 3."},{"timestamp":1471497158,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1471506521,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 4."},{"timestamp":1471506558,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1471542114,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4: Code-Review-1\n\n(1 comment)"},{"timestamp":1471543792,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 5."},{"timestamp":1471543839,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1471543839,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1471544206,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1471562571,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1471562650,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 6: Commit message was updated."},{"timestamp":1471562662,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Josh Wilsdon"}],"currentPatchSet":{"number":"6","revision":"d89e5505aba1e037562c9aa92c039b96c07d71a5","parents":["6ab7799a2fc1845d2f2da4237b5a559d6b05949e"],"ref":"refs/changes/06/306/6","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1471562650,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1471543839,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1471544206,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1471562571,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1471562662,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":57,"deletions":-9}],"sizeInsertions":57,"sizeDeletions":-9},"patchSets":[{"number":"1","revision":"8273ccad3db9d5a6bdb7598bb7cc408aef3169f8","parents":["6ab7799a2fc1845d2f2da4237b5a559d6b05949e"],"ref":"refs/changes/06/306/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1471390494,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1471390531,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/vm/lib/metadata/agent.js","line":1120,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Do we want to be using guessHandleType? Would using fs.fstat here be better to determine this is a pipe?"},{"file":"src/vm/lib/metadata/agent.js","line":1120,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I\u0027ll ping @misterdjules and see if he has an opinion. I believe it was his suggestion to use guessHandleType originally. Looking at the implementation in libuv it uses fstat internally anyway though so it seems that adding this will require us to duplicate logic that already exists in guessHandleType but have the same result.\n\nIf we want to investigate this as a separate issue that seems fine to me, but it doesn\u0027t seem necessary to change now in order to fix this bug."},{"file":"src/vm/lib/metadata/agent.js","line":1120,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I only mentioned this because it\u0027s a completely undocumented function that\u0027s not part of node\u0027s API that I can find any docs on."},{"file":"src/vm/lib/metadata/agent.js","line":1120,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Robert is right: guessHandleType is an undocumented, internal function that is not part of node\u0027s API. I shouldn\u0027t have been so quick to recommend we use it.\n\nAt the time it seemed to be the only API that was able to distinguish between a UNIX domain socket and another type of socket. fs.stat\u0027s results will indicate that the fd returned by node-zsock is a socket, but it could be any type of socket. If that info is sufficient to consider that this fd is valid, then we should just use fs.stat.\n\nIf not, I don\u0027t think there\u0027s any other API in node that allows to make that distinction, so to get rid of guessHandleType, we would need to use a third-party module or write our own native module."},{"file":"src/vm/lib/metadata/agent.js","line":1120,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Ok, thanks guys. I\u0027ve created OS-5602 to deal with this."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":21,"deletions":-9}],"sizeInsertions":21,"sizeDeletions":-9},{"number":"2","revision":"79d7ff9c4d0bcd746364a6a44e1b9513b741d62f","parents":["6ab7799a2fc1845d2f2da4237b5a559d6b05949e"],"ref":"refs/changes/06/306/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1471496943,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1471496972,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":49,"deletions":-9}],"sizeInsertions":49,"sizeDeletions":-9},{"number":"3","revision":"2d06397bbfacf7415b3d2e560b13625de91cd895","parents":["6ab7799a2fc1845d2f2da4237b5a559d6b05949e"],"ref":"refs/changes/06/306/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1471497116,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1471497158,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":49,"deletions":-9}],"sizeInsertions":49,"sizeDeletions":-9},{"number":"4","revision":"6d80f841c1535527055e41f1ba972450c02e982f","parents":["6ab7799a2fc1845d2f2da4237b5a559d6b05949e"],"ref":"refs/changes/06/306/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1471506521,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1471506558,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1471542114,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"comments":[{"file":"src/vm/lib/metadata/agent.js","line":1148,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"If the \"sockErr\" error object passed to \"_onCreateZsock\" is an actual error, and if in that case \"fd\" is not set, or was never created/initialized anyway because of that previous error, it seems this code would try to guess the type of a fd that was never created/initialized, which would overwrite the \"zsockErr\" that was set originally.\n\nWould writing this code such as:\n\nif (!zsockErr) {\n  handleType \u003d guessHandleType(fd);\n  if (handleType !\u003d\u003d \u0027PIPE\u0027) {\n    zsockErr \u003d ...\n  }\n}\n\nif (zsockErr) {\n  self.addDebug ...\n}\n\nfix that problem?"},{"file":"src/vm/lib/metadata/agent.js","line":1148,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Excellent point. Thanks!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":50,"deletions":-9}],"sizeInsertions":50,"sizeDeletions":-9},{"number":"5","revision":"0cd6bbfd50c8804d52a2f581cf4e5cb593250ded","parents":["6ab7799a2fc1845d2f2da4237b5a559d6b05949e"],"ref":"refs/changes/06/306/5","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1471543792,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1471543839,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1471562571,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1471544206,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":57,"deletions":-9}],"sizeInsertions":57,"sizeDeletions":-9},{"number":"6","revision":"d89e5505aba1e037562c9aa92c039b96c07d71a5","parents":["6ab7799a2fc1845d2f2da4237b5a559d6b05949e"],"ref":"refs/changes/06/306/6","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1471562650,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1471543839,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1471562571,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1471562662,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1471544206,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":57,"deletions":-9}],"sizeInsertions":57,"sizeDeletions":-9}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}]}