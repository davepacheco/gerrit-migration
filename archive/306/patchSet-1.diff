commit 8273ccad3db9d5a6bdb7598bb7cc408aef3169f8 (refs/changes/06/306/1)
Author: Josh Wilsdon <jwilsdon@joyent.com>
Date:   2016-08-16T16:34:52-07:00 (3 years, 2 months ago)
    
    OS-5587 still possible for mdata to get 0 descriptor back from node-zsock

diff --git a/src/vm/lib/metadata/agent.js b/src/vm/lib/metadata/agent.js
index 4176f572..16f5a88c 100644
--- a/src/vm/lib/metadata/agent.js
+++ b/src/vm/lib/metadata/agent.js
@@ -1116,18 +1116,34 @@ function createZoneSocket(zopts, callback) {
         }
 
         zsock.createZoneSocket(zopts, function _onCreateZsock(sockErr, fd) {
-            if (sockErr) {
-                self.addDebug(zopts.zone, 'last_zsock_create_failure', sockErr);
+            var zsockErr = sockErr;
+            var handleType = guessHandleType(fd);
 
-                zlog.warn({zonename: zopts.zone, err: sockErr},
-                    'failed to create zsock');
+            // If zsock gave us a bogus handle, we don't know what to do with
+            // that so we'll consider it an error. This is usually a bug in
+            // zsock so the warn message we output here will help us determine
+            // when these have been fixed.
+            if (handleType !== 'PIPE') {
+                zsockErr = new Error('zsock FD must be a pipe (got '
+                    + handleType + ')');
+            }
+
+            if (zsockErr) {
+                self.addDebug(zopts.zone, 'last_zsock_create_failure',
+                    zsockErr);
+
+                zlog.warn({
+                    zonename: zopts.zone,
+                    err: zsockErr,
+                    handleType: handleType
+                }, 'failed to create zsock');
 
                 // We were unable to create a zsock, but as with a directory
                 // creation error we've not created a real self.zoneConnections
                 // entry yet so we'll delete the placeholder and let the
                 // _checkNewZones() catch it on the next go-round.
                 delete self.zoneConnections[zopts.zone];
-                callback(sockErr);
+                callback(zsockErr);
                 return;
             }
 
@@ -1204,10 +1220,6 @@ function createZoneSocket(zopts, callback) {
                 delete self.zoneConnections[zopts.zone];
             });
 
-            // If zsock gave us a bogus handle, we don't know what to do with
-            // that so we'll try to get a core to figure out what that means.
-            assert(guessHandleType(fd) === 'PIPE', 'zsock FD must be a pipe');
-
             server.listen({fd: fd});
             zlog.info('listening on fd %d', fd);
             self.addDebug(zopts.zone, 'last_zsock_listen_success');
