From b6a752ace16e4a58057231eab53fa9211beda603 Mon Sep 17 00:00:00 2001
From: Tim Kordas <tim.kordas@joyent.com>
Date: Wed, 9 Aug 2017 17:11:06 -0700
Subject: [PATCH] MANTA-3187 Muskie logs object IDs incorrectly for PUTs
 Reviewed by: Jordan Hendricks <jordan.hendricks@joyent.com>

---
 lib/audit.js | 21 ++++++++++++++++++++-
 1 file changed, 20 insertions(+), 1 deletion(-)

diff --git a/lib/audit.js b/lib/audit.js
index 8876d61..f45fa40 100644
--- a/lib/audit.js
+++ b/lib/audit.js
@@ -246,8 +246,27 @@ function auditLogger(options) {
             secure: req.secure
         };
 
+        /*
+         * Muskie keeps a reference to the Moray metadata loaded for the
+         * request at req.metadata. In cases where a new object ID is
+         * generated (such as a PUT overwriting an existing object,) we
+         * want to differentiate between the new object ID for the
+         * object and the previous one (and supply both objectIds.)
+         */
         if (req.metadata && req.metadata.objectId) {
-            obj.objectId = req.metadata.objectId;
+            if (req.objectId && req.objectId !== req.metadata.objectId) {
+                obj.prevObjectId = req.metadata.objectId;
+                obj.objectId = req.objectId;
+            } else {
+                obj.objectId = req.metadata.objectId;
+            }
+        } else if (req.objectId) {
+            /*
+             * For a PUT which is creating a fresh object, the req.metadata
+             * will have no objectId, we still want to log its objectId, if
+             * available.
+             */
+            obj.objectId = req.objectId;
         }
         obj.sharksContacted = req.sharksContacted;
         obj.entryShard = req.entryShard;
-- 
2.21.0

