commit 7cf904cb8d8ed8e3b21e4d16d53527f55946ee18 (refs/changes/45/2345/4)
Author: Tim Kordas <tim.kordas@joyent.com>
Date:   2017-08-10T11:24:13-07:00 (2 years, 2 months ago)
    
    MANTA-3187 Muskie logs object IDs incorrectly for PUTs

diff --git a/lib/audit.js b/lib/audit.js
index d352464..872fa9e 100644
--- a/lib/audit.js
+++ b/lib/audit.js
@@ -227,8 +227,27 @@ function auditLogger(options) {
             secure: req.secure
         };
 
+        /*
+         * Muskie keeps a reference to the Moray metadata loaded for the
+         * request at req.metadata. In cases where a new object ID is
+         * generated (such as a PUT overwriting an existing object), we
+         * want to differentiate between the new object ID for the
+         * object and the previous one
+         */
         if (req.metadata && req.metadata.objectId) {
-            obj.objectId = req.metadata.objectId;
+            if (req.objectId && req.objectId !== req.metadata.objectId) {
+                obj.prevObjectId = req.metadata.objectId;
+                obj.objectId = req.objectId;
+            } else {
+                obj.objectId = req.metadata.objectId;
+            }
+        } else if (req.objectId) {
+            /*
+             * For a PUT which is creating a fresh object, the req.metadata
+             * will have no objectId, we still want to log its objectId, if
+             * available.
+             */
+            obj.objectId = req.objectId;
         }
         obj.sharksContacted = req.sharksContacted;
         obj.entryShard = req.entryShard;
