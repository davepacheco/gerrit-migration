{"project":"joyent/sdc-manta","branch":"master","id":"Iec766aa3c4056c934d016165184bd8fbc15c0c7a","number":"440","subject":"MANTA-2975 manta-factoryreset should not proceed without removing amon probes","owner":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"url":"https://cr.joyent.us/440","commitMessage":"MANTA-2975 manta-factoryreset should not proceed without removing amon probes\n","createdOn":1473428388,"lastUpdated":1475080909,"open":false,"status":"MERGED","comments":[{"timestamp":1473428388,"reviewer":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"message":"Uploaded patch set 1."},{"timestamp":1473428438,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(3 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1473437355,"reviewer":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"message":"Uploaded patch set 2."},{"timestamp":1473437394,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1473875955,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\n(2 comments)\n\nThanks for the change."},{"timestamp":1473876085,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1473936701,"reviewer":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"message":"Patch Set 2:\n\n\u003e (2 comments)\n \u003e \n \u003e Thanks for the change.\n\nIt is copied from _deleteInstances, at line 312.  I don\u0027t think there is much advantage to trying to refactor these types of functions into a unified function, seems more readable to repeat the existing pattern to me."},{"timestamp":1473936836,"reviewer":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1473937467,"reviewer":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"message":"Uploaded patch set 4."},{"timestamp":1473958857,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1473970721,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\n\u003e \u003e (2 comments)\n \u003e \u003e\n \u003e \u003e Thanks for the change.\n \u003e \n \u003e It is copied from _deleteInstances, at line 312.  I don\u0027t think\n \u003e there is much advantage to trying to refactor these types of\n \u003e functions into a unified function, seems more readable to repeat\n \u003e the existing pattern to me.\n\nThe existing tool for doing this is \"mantamon drop\", in the [mantamon repo](https://github.com/joyent/mantamon).  This repo already depends on that one.  Is there any reason not to use the same code?  I don\u0027t know how much this matters, to be honest.  Maybe Trent Mick could weigh in.\n\nIf we don\u0027t commonize this code, then I\u0027d strike the part of the comment that says \"since that\u0027s what the code I copied does\" and \"I currently have 277\".  That\u0027s useful context for reviewers, but doesn\u0027t need to be in the code itself."},{"timestamp":1474008517,"reviewer":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"message":"Uploaded patch set 5."},{"timestamp":1474008561,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1474008630,"reviewer":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"message":"Patch Set 4:\n\n(2 comments)\n\nComments removed.  Just trying to add what I learned while using a provided utility, not looking to rearchitect/replace the utility.  Thanks for the consideration."},{"timestamp":1474044693,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 5:\n\n(1 comment)\n\nAlright.\n\nI notice that the code in \"mantamon drop\" drops probes first, then probe groups, while the code here removes probe groups first, then probes.  It sounds from talking to Trent that this probably works, but isn\u0027t great because amon may have trouble handling faults when the referred-to group no longer exists.  What do you think about reordering those steps?\n\nHow did you test this?  Did you test resetting a deployment with no probes as well as one with probes?  And one that has nothing deployed at all (e.g., after having just run it)?\n\nThanks again for this!"},{"timestamp":1474046845,"reviewer":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"message":"Uploaded patch set 6."},{"timestamp":1474046903,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1474047990,"reviewer":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"message":"Patch Set 6:\n\nComment removed.\n\nI admit to not digging super deeply, but didn\u0027t see a schema for pools/pool groups, so glad to swap the ordering if that makes sense to y\u0027all.\n\nTesting:  I tested on my install, and retested after removing all probe/probe groups (verified it using commands similar to \"sdc-ufds search \u0027(\u0026(objectclass\u003damonprobe)(user\u003dc2814ec8-1a99-eb25-bce2-904d1f94c969))\u0027\" and \"sdc-ufds search \u0027(\u0026(objectclass\u003d*)(user\u003dc2814ec8-1a99-eb25-bce2-904d1f94c969))\u0027 ;  sdc-ufds search \u0027(\u0026(objectclass\u003d*)(owner\u003dc2814ec8-1a99-eb25-bce2-904d1f94c969))\u0027\").  That UUID is the UUID of my poseidon user.\n\nI have not done a manta install without amon probes, at least afaik, so testing that scenario was not done.  \n\nLooking now using \"sdc-amon /pub/poseidon/probes | json -H\" I see that I currently have no probes, so maybe before I get started with adding my docs into manta I can run a test for this scenario.  However, see below, interested in your and Trent\u0027s opinion, perhaps a re-architect is needed after all.\n\nI think I mentioned earlier in channel, that this fix does not complete the work needed to remove the poseidon user.  In my previous manta installation, there was still a \u0027fwrule\u0027 attributed to the poseidon user in ufds, which prevented me from completely removing manta using manta-factoryreset.  Fortunately for me, at least, I was able to successfully reinstall manta with the old user in place, and it seems things work.\n\nThe reason I did not address the fwrule in this fix is two-fold:\n\nFirst, that was not the scope of the bug, so I kept my fix specific and in-line with the existing code in the utility.\n\nSecond, there was no code for manipulating fwrules already included in sdc-manta, at least not that I saw.  I figured I\u0027d look at adding it, but now that you\u0027ve brought up the mantamon bits, if there is also shared code for fwrule manipulation, perhaps I should drop this patchset and look at integrating both sets of shared code."},{"timestamp":1474057483,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6: Code-Review+1\n\nI don\u0027t think there\u0027s anything in the Manta deployment tooling that manipulates firewall rules.  Is it possible this was something you added separately?\n\nI do think it would be worth testing the case where there are no amon probes or probegroups present, as people often deploy it that way in development."},{"timestamp":1474438864,"reviewer":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"message":"Patch Set 6:\n\nHere are the results of running these changes with no amon probes present: https://gist.github.com/pccowboy/218500b0c92ca73e3b37ffc757139eac\n\nAs you\u0027ll see, there is still an error deleting poseidon, but it is not related to the amon bits this time."},{"timestamp":1474502205,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6:\n\nIt looks to me like the dclocalconfig object you found is a result of having configured the default network for this user.  Is that something you did explicitly?\n\nI filed MANTA-2991 (https://smartos.org/bugview/MANTA%2d2991) to cover that issue."},{"timestamp":1474649016,"reviewer":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"message":"Patch Set 6:\n\nI don\u0027t recall having done this explicitly.  I am not even sure how I would do this, unless I did it through the UI somehow.  I combed my history lists and did not see anything.\n\nI\u0027ll take another look this weekend and get back to you.  I still have to figure out why manta provisioning did not setup the DNS entries for manta.usw1.pccowboy.com after I tested manta-factoryreset the last time.  I suspect it has to do with my thrashing earlier to reinstall, where I ran \"manta-adm genconfig lab\" and then changed my mind midstream, generated coal, and then made changes post-provision to the config.json for manta and then ran manta-adm update.  I rely too much on my history lists, triton is complex enough that I need to start writing down every step I take :-)"},{"timestamp":1474649927,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6: Integration-Approval+1\n\nNo problem.  I\u0027m going to go ahead and integrate this (assuming you\u0027re happy with it) because I don\u0027t see how it could have introduced or made worse the problem you saw.  Thanks for your patience with this one!"},{"timestamp":1475044431,"reviewer":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"message":"Patch Set 6:\n\nThanks!  I deleted that \u0027home\u0027 entry with sdc-ldap, and manta-factoryreset did run to completion.  I looked briefly at the sdc-clients ufds module, but it did not appear to have anticipated that type of entry, or I\u0027d make another PR.  Still not sure how that got into my ldap."},{"timestamp":1475072653,"reviewer":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"message":"Patch Set 6:\n\nI just did a couple more test deployments of manta, and the deploy process is definitely what adds the ldap entry for the \u0027dclocalconfig\u003dhome\u0027.\n\nShould I wait until this patchset lands in master to make a patchset for MANTA-2991, or should I work against the current state of master?"},{"timestamp":1475079418,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6:\n\nIf you\u0027re happy with this one, I\u0027m ready to integrate it."},{"timestamp":1475080118,"reviewer":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"message":"Patch Set 6:\n\nI am happy with this one, integrate away.  Do I need to take any action in gerrit?"},{"timestamp":1475080909,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by David Pacheco"}],"currentPatchSet":{"number":"6","revision":"ec766aa3c4056c934d016165184bd8fbc15c0c7a","parents":["d68b9c8696edf41772768ee7b22aaa429fa096dc"],"ref":"refs/changes/40/440/6","uploader":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"createdOn":1474046845,"author":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1474046903,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1474057483,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1474649927,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1475080909,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-factoryreset.js","type":"MODIFIED","insertions":97,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":7,"deletions":0}],"sizeInsertions":104,"sizeDeletions":0},"patchSets":[{"number":"1","revision":"cc89b1b3c6447e1c18d667fde08e69084ab94df4","parents":["d68b9c8696edf41772768ee7b22aaa429fa096dc"],"ref":"refs/changes/40/440/1","uploader":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"createdOn":1473428388,"author":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1473428438,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"cmd/manta-factoryreset.js","line":264,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"cmd/manta-factoryreset.js","line":413,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"cmd/manta-factoryreset.js","line":418,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-factoryreset.js","type":"MODIFIED","insertions":102,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":6,"deletions":0}],"sizeInsertions":108,"sizeDeletions":0},{"number":"2","revision":"574e4ec90110217a56cb44a996a4eaa280ad888e","parents":["d68b9c8696edf41772768ee7b22aaa429fa096dc"],"ref":"refs/changes/40/440/2","uploader":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"createdOn":1473437355,"author":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1473437394,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"/COMMIT_MSG","line":7,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Nit: There\u0027s an extra space here after the ticket number.  Also, the text of the synopsis should exactly match the ticket synopsis (\"manta-factoryreset should not proceed without removing amon probes\")."},{"file":"/COMMIT_MSG","line":7,"reviewer":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"message":"should be fixed in latest"},{"file":"cmd/manta-factoryreset.js","line":407,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Where was this code copied from?  Should we be using the same code instead of copying it?"},{"file":"lib/common.js","line":150,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Do we not need to close this client in finiSdcClients?"},{"file":"lib/common.js","line":150,"reviewer":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"message":"cusswords, good catch, thanks."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-factoryreset.js","type":"MODIFIED","insertions":105,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":6,"deletions":0}],"sizeInsertions":111,"sizeDeletions":0},{"number":"3","revision":"840abed5e80883946859f3695f4b7e8e130d5fdd","parents":["d68b9c8696edf41772768ee7b22aaa429fa096dc"],"ref":"refs/changes/40/440/3","uploader":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"createdOn":1473936836,"author":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1473437394,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-factoryreset.js","type":"MODIFIED","insertions":105,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":6,"deletions":0}],"sizeInsertions":111,"sizeDeletions":0},{"number":"4","revision":"525c606167af5f5bb524e66461e4e07e8e64efed","parents":["d68b9c8696edf41772768ee7b22aaa429fa096dc"],"ref":"refs/changes/40/440/4","uploader":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"createdOn":1473937467,"author":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1473958857,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-factoryreset.js","type":"MODIFIED","insertions":105,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":7,"deletions":0}],"sizeInsertions":112,"sizeDeletions":0},{"number":"5","revision":"11ac702ecf192fc7e5ba88638dd2c32e303e93dd","parents":["d68b9c8696edf41772768ee7b22aaa429fa096dc"],"ref":"refs/changes/40/440/5","uploader":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"createdOn":1474008517,"author":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1474008561,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"cmd/manta-factoryreset.js","line":441,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Can you strike this comment too?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-factoryreset.js","type":"MODIFIED","insertions":101,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":7,"deletions":0}],"sizeInsertions":108,"sizeDeletions":0},{"number":"6","revision":"ec766aa3c4056c934d016165184bd8fbc15c0c7a","parents":["d68b9c8696edf41772768ee7b22aaa429fa096dc"],"ref":"refs/changes/40/440/6","uploader":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"createdOn":1474046845,"author":{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1474057483,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1474649927,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1475080909,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1474046903,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-factoryreset.js","type":"MODIFIED","insertions":97,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":7,"deletions":0}],"sizeInsertions":104,"sizeDeletions":0}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"pccowboy","email":"dswift@tdl.com","username":"pccowboy"}]}