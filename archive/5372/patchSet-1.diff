From 3b5d2bfbd55752de6c12ab95d911909242d7cafe Mon Sep 17 00:00:00 2001
From: Hans Rosenfeld <hans.rosenfeld@joyent.com>
Date: Tue, 15 Jan 2019 16:29:40 +0100
Subject: [PATCH] OS-7508 mdb: assertion tripped in libvmm when bhyve VM halts
 while mdb is attached

---
 usr/src/cmd/mdb/intel/mdb/mdb_bhyve.c | 32 +++++++++++++++++++--------
 1 file changed, 23 insertions(+), 9 deletions(-)

diff --git a/usr/src/cmd/mdb/intel/mdb/mdb_bhyve.c b/usr/src/cmd/mdb/intel/mdb/mdb_bhyve.c
index 1bfd8416c4..5e70463809 100644
--- a/usr/src/cmd/mdb/intel/mdb/mdb_bhyve.c
+++ b/usr/src/cmd/mdb/intel/mdb/mdb_bhyve.c
@@ -911,8 +911,8 @@ bhyve_setflags(mdb_tgt_t *tgt, int flags)
 static void
 bhyve_activate(mdb_tgt_t *tgt)
 {
+	mdb_tgt_status_t *tsp = &tgt->t_status;
 	bhyve_data_t *bd = tgt->t_data;
-	mdb_tgt_status_t tsp;
 	const char *format;
 	char buf[BUFSIZ];
 
@@ -923,17 +923,17 @@ bhyve_activate(mdb_tgt_t *tgt)
 
 	vmm_stop(bd->bd_vmm);
 
-	if (mdb_tgt_status(tgt, &tsp) != 0)
+	if (mdb_tgt_status(tgt, tsp) != 0)
 		return;
 
-	if (tsp.st_pc != 0) {
+	if (tsp->st_pc != 0) {
 		if (mdb_dis_ins2str(mdb.m_disasm, mdb.m_target,
-		    MDB_TGT_AS_VIRT_I, buf, sizeof (buf), tsp.st_pc) !=
-		    tsp.st_pc)
+		    MDB_TGT_AS_VIRT_I, buf, sizeof (buf), tsp->st_pc) !=
+		    tsp->st_pc)
 			format = "target stopped at:\n%-#16a%8T%s\n";
 		else
 			format = "target stopped at %a:\n";
-		mdb_warn(format, tsp.st_pc, buf);
+		mdb_warn(format, tsp->st_pc, buf);
 	}
 }
 
@@ -943,6 +943,7 @@ bhyve_activate(mdb_tgt_t *tgt)
 static void
 bhyve_deactivate(mdb_tgt_t *tgt)
 {
+	mdb_tgt_status_t *tsp = &tgt->t_status;
 	bhyve_data_t *bd = tgt->t_data;
 	const mdb_tgt_regdesc_t *rd;
 	const mdb_dcmd_t *dc;
@@ -963,7 +964,11 @@ bhyve_deactivate(mdb_tgt_t *tgt)
 		if (mdb_module_remove_dcmd(tgt->t_module, dc->dc_name) == -1)
 			mdb_warn("failed to remove dcmd %s", dc->dc_name);
 
-	vmm_cont(bd->bd_vmm);
+	if (mdb_tgt_status(tgt, tsp) != 0)
+		return;
+
+	if (tsp->st_state == MDB_TGT_STOPPED)
+		vmm_cont(bd->bd_vmm);
 }
 
 /*
@@ -983,9 +988,13 @@ bhyve_name(mdb_tgt_t *tgt)
 static void
 bhyve_destroy(mdb_tgt_t *tgt)
 {
+	mdb_tgt_status_t *tsp = &tgt->t_status;
 	bhyve_data_t *bd = tgt->t_data;
 
-	vmm_cont(bd->bd_vmm);
+	if (mdb_tgt_status(tgt, tsp) == 0 &&
+	    tsp->st_state == MDB_TGT_STOPPED)
+		vmm_cont(bd->bd_vmm);
+
 	vmm_unmap(bd->bd_vmm);
 	vmm_close_vm(bd->bd_vmm);
 	mdb_free(bd, sizeof (bhyve_data_t));
@@ -1249,11 +1258,16 @@ bhyve_status(mdb_tgt_t *tgt, mdb_tgt_status_t *tsp)
 static void
 bhyve_sighdl(int sig, siginfo_t *sip, ucontext_t *ucp, mdb_tgt_t *tgt)
 {
+	mdb_tgt_status_t *tsp = &tgt->t_status;
 	bhyve_data_t *bd = tgt->t_data;
 
 	switch (sig) {
 	case SIGINT:
-		vmm_stop(bd->bd_vmm);
+		if (mdb_tgt_status(tgt, tsp) != 0)
+			return;
+
+		if (tsp->st_state == MDB_TGT_RUNNING)
+			vmm_stop(bd->bd_vmm);
 		break;
 	}
 }
-- 
2.21.0

