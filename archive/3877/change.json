{"project":"joyent/illumos-joyent","branch":"master","id":"I251cbf5a0f1ae5121e96585bf60d41d1101e7437","number":"3877","subject":"OS-6802 zoneadmd child process pollutes environment Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"url":"https://cr.joyent.us/3877","commitMessage":"OS-6802 zoneadmd child process pollutes environment\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1524763081,"lastUpdated":1525827550,"open":false,"status":"MERGED","comments":[{"timestamp":1524763081,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 1."},{"timestamp":1524763154,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1524843798,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1524852429,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 3."},{"timestamp":1524852443,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1524856984,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1524861305,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1524865550,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 4."},{"timestamp":1524865572,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1524866408,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1525797448,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1525804898,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4:\n\nUpdated OS-6802 with another test suggested by Patrick."},{"timestamp":1525820680,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1525827520,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5: Commit message was updated."},{"timestamp":1525827530,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1525827550,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Mike Gerdts"}],"currentPatchSet":{"number":"6","revision":"cd2e7e66ffa1c4b5f8d136fb0913699fbac5c6d8","parents":["28cd1d4864940265e40eecac8df838b0dd72ca5c"],"ref":"refs/changes/77/3877/6","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1525827530,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524866408,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525797448,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525820680,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1525827550,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/zoneadmd/log.c","type":"MODIFIED","insertions":36,"deletions":-1},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":75,"deletions":-8}],"sizeInsertions":111,"sizeDeletions":-9},"patchSets":[{"number":"1","revision":"42ff3244fd15fd774c4ff91d13c56a9f6a3e5bc7","parents":["77b57dc55fffa7007fdcbac3f84f00c7211e2754"],"ref":"refs/changes/77/3877/1","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1524763081,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/log.c","type":"MODIFIED","insertions":36,"deletions":-1},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":79,"deletions":-8}],"sizeInsertions":115,"sizeDeletions":-9},{"number":"2","revision":"cacdbc9aca7f3779d381c902adb16dd73bb56c41","parents":["77b57dc55fffa7007fdcbac3f84f00c7211e2754"],"ref":"refs/changes/77/3877/2","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1524763154,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","comments":[{"file":"usr/src/cmd/zoneadmd/log.c","line":329,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I\u0027m confused about when this happens."},{"file":"usr/src/cmd/zoneadmd/log.c","line":329,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"There\u0027s a small race with \u0027pkill -\u003cHUP|USR1\u003e zoneadmd\u0027. The atfork handler should set logging_poisoned in the child before the signal can be handled."},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":1046,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"\"revert to\""},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":1046,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":1127,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Seems like the only real situation this could happen is with EBADF, which would indicate a nasty bug; should we just assert() here maybe?"},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":1127,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/log.c","type":"MODIFIED","insertions":36,"deletions":-1},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":79,"deletions":-8}],"sizeInsertions":115,"sizeDeletions":-9},{"number":"3","revision":"9ff8b1784a7dcf4d922020d780eb8e9a8c54e60c","parents":["77b57dc55fffa7007fdcbac3f84f00c7211e2754"],"ref":"refs/changes/77/3877/3","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1524852429,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524856984,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"comments":[{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":1048,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"because"},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":1048,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":1083,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It says above that we shouldn\u0027t be calling zerror() in the child.  Should this call be fixed?"},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":1083,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"uh, yeah.  oops."},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":1117,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"If we\u0027re going to bail here, should we signal the child to exit, or is it fine to wait a while for that to occur?"},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":1117,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I think this is ok, as it is pretty much what happened before with pclose()."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/log.c","type":"MODIFIED","insertions":36,"deletions":-1},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":75,"deletions":-8}],"sizeInsertions":111,"sizeDeletions":-9},{"number":"4","revision":"251cbf5a0f1ae5121e96585bf60d41d1101e7437","parents":["77b57dc55fffa7007fdcbac3f84f00c7211e2754"],"ref":"refs/changes/77/3877/4","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1524865550,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525797448,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525820680,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524866408,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/log.c","type":"MODIFIED","insertions":36,"deletions":-1},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":75,"deletions":-8}],"sizeInsertions":111,"sizeDeletions":-9},{"number":"5","revision":"78a6607027afa86d440382a6d75930f471ce193f","parents":["77b57dc55fffa7007fdcbac3f84f00c7211e2754"],"ref":"refs/changes/77/3877/5","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1525827520,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525797448,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525820680,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524866408,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/zoneadmd/log.c","type":"MODIFIED","insertions":36,"deletions":-1},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":75,"deletions":-8}],"sizeInsertions":111,"sizeDeletions":-9},{"number":"6","revision":"cd2e7e66ffa1c4b5f8d136fb0913699fbac5c6d8","parents":["28cd1d4864940265e40eecac8df838b0dd72ca5c"],"ref":"refs/changes/77/3877/6","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1525827530,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525797448,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525820680,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1525827550,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524866408,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/zoneadmd/log.c","type":"MODIFIED","insertions":36,"deletions":-1},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":75,"deletions":-8}],"sizeInsertions":111,"sizeDeletions":-9}],"allReviewers":[{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}]}