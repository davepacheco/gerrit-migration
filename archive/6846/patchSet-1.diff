commit a728fdb275d9b2c7be91bb8805eaeb8a320ebb27
Author: Brian Bennett <brian.bennett@joyent.com>
Date:   2019-08-28T17:18:43-07:00 (6 weeks ago)
    
    OS-7795 libdiskmgt doesn't always list all disks

diff --git a/usr/src/uts/common/io/usb/scsa2usb/scsa2usb.c b/usr/src/uts/common/io/usb/scsa2usb/scsa2usb.c
index fc20795a8b..0f891e8d71 100644
--- a/usr/src/uts/common/io/usb/scsa2usb/scsa2usb.c
+++ b/usr/src/uts/common/io/usb/scsa2usb/scsa2usb.c
@@ -379,6 +379,10 @@ static struct blacklist {
 
 	/* Western Digital External HDD */
 	{MS_WD_VID, MS_WD_PID, 0,
+	    SCSA2USB_ATTRS_INQUIRY_EVPD},
+
+	/* QNAP TR-004 */
+	{MS_QNAP_VID, MS_QNAP_TR_004_PID, 0,
 	    SCSA2USB_ATTRS_INQUIRY_EVPD}
 };
 
@@ -1768,6 +1772,15 @@ scsa2usb_validate_attrs(scsa2usb_state_t *scsa2usbp)
 		}
 		scsa2usbp->scsa2usb_cmd_protocol |= SCSA2USB_UFI_CMDSET;
 	}
+	/*
+	 * QNAP TR-004 reports the enclosure SN for all disks.
+	 * This causes zfs to assign the same devid for all disks, confusing
+	 * libdiskmgt. A Let's try clearing it.
+	 */
+	if ((desc->idVendor == MS_QNAP_VID) &&
+	    (desc->idProduct == MS_QNAP_TR_004_PID)) {
+		scsa2usbp->scsa2usb_dev_data->dev_serial = 0x0;
+	}
 
 	if (scsa2usbp->scsa2usb_attrs != SCSA2USB_ALL_ATTRS) {
 		USB_DPRINTF_L2(DPRINT_MASK_SCSA,
diff --git a/usr/src/uts/common/sys/usb/scsa2usb/scsa2usb.h b/usr/src/uts/common/sys/usb/scsa2usb/scsa2usb.h
index 32de7e6eca..57bbb926b3 100644
--- a/usr/src/uts/common/sys/usb/scsa2usb/scsa2usb.h
+++ b/usr/src/uts/common/sys/usb/scsa2usb/scsa2usb.h
@@ -123,6 +123,9 @@ extern "C" {
 #define	MS_WD_VID	0x1058	/* Vendor ID of Western Digital */
 #define	MS_WD_PID   0x1001  /* PID for Western Digital USB External HDD */
 
+#define	MS_QNAP_VID		0x1c04 /* Vendor ID of QNAP */
+#define	MS_QNAP_TR_004_PID	0x0013 /* PID for QNAP TR-004 */
+
 /*
  * The AMI virtual floppy device is not a real USB storage device, but
  * emulated by the SP firmware shipped together with important Sun x86
