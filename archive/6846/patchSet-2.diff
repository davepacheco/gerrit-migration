commit d965808a58c0ed9803ff255dbb9eae4adc409f4b
Author: Brian Bennett <brian.bennett@joyent.com>
Date:   2019-08-28T17:36:14-07:00 (6 weeks ago)
    
    3

diff --git a/usr/src/uts/common/io/usb/scsa2usb/scsa2usb.c b/usr/src/uts/common/io/usb/scsa2usb/scsa2usb.c
index deddbda2f2..0f891e8d71 100644
--- a/usr/src/uts/common/io/usb/scsa2usb/scsa2usb.c
+++ b/usr/src/uts/common/io/usb/scsa2usb/scsa2usb.c
@@ -1772,6 +1772,15 @@ scsa2usb_validate_attrs(scsa2usb_state_t *scsa2usbp)
 		}
 		scsa2usbp->scsa2usb_cmd_protocol |= SCSA2USB_UFI_CMDSET;
 	}
+	/*
+	 * QNAP TR-004 reports the enclosure SN for all disks.
+	 * This causes zfs to assign the same devid for all disks, confusing
+	 * libdiskmgt. A Let's try clearing it.
+	 */
+	if ((desc->idVendor == MS_QNAP_VID) &&
+	    (desc->idProduct == MS_QNAP_TR_004_PID)) {
+		scsa2usbp->scsa2usb_dev_data->dev_serial = 0x0;
+	}
 
 	if (scsa2usbp->scsa2usb_attrs != SCSA2USB_ALL_ATTRS) {
 		USB_DPRINTF_L2(DPRINT_MASK_SCSA,
