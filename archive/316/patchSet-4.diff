From 966f67201e15eb1041fe09c2694c916e1db7aef9 Mon Sep 17 00:00:00 2001
From: Jordan Paige Hendricks <jordan.hendricks@joyent.com>
Date: Thu, 18 Aug 2016 20:17:30 +0000
Subject: [PATCH] MANTA-2744 after error, picker reports "reconnecting",
 actually doing nothing

---
 README.md     | 7 +++++++
 lib/picker.js | 3 +++
 main.js       | 2 +-
 3 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/README.md b/README.md
index a98bf4d..e493c55 100644
--- a/README.md
+++ b/README.md
@@ -34,6 +34,7 @@ prerequisites in your development environment:
    to Manta.  The manta-deployment zone includes a tool called add-dev-user that
    can be used to do this.  You can find it at
    /opt/smartdc/manta-deployment/tools/add-dev-user.
+   Note: You should not use the "poseidon" user for running the tests.
 2. The ssh key that you use to authenticate as this account should be
    passwordless.  It must also be stored locally, with the public key being
    called $HOME/.ssh/id\_rsa.pub.
@@ -124,6 +125,12 @@ check first before reporting problems:
 3. If a test fails with a message like "Error: MUSKIE\_SALT required", then
    check that you've specified the three MUSKIE environment variables described
    above.
+4. If a test fails due to authorization errors (perhaps while completing a job),
+   you may have an incorrect muskie configuration. Check that the MUSKIE\_ID,
+   MUSKIE\_KEY and MUSKIE\_IV attributes in your config.json match the environment
+   variables set for the user running the tests ($MANTA\_USER).
+
+
 
 If you're changing anything about the way muskie is deployed, configured, or
 started, you should definitely test creating a muskie image and deploying that
diff --git a/lib/picker.js b/lib/picker.js
index 34e5891..1965fc7 100644
--- a/lib/picker.js
+++ b/lib/picker.js
@@ -217,6 +217,9 @@ function poll() {
                 self.datacenters = dcs;
                 self.db = obj;
                 self.emit('topology', self.db);
+            } else {
+                self.log.warn('Picker::poll: could not find any minnow ' +
+                    'instances');
             }
 
             reschedule();
diff --git a/main.js b/main.js
index 87b4fb8..5b08a2a 100644
--- a/main.js
+++ b/main.js
@@ -214,7 +214,6 @@ function createPickerClient(cfg) {
     var client = app.picker.createClient(opts);
 
     function onConnect() {
-        client.removeListener('error', onError);
         LOG.info('picker connected %s', client.toString());
         PICKER = client;
 
@@ -225,6 +224,7 @@ function createPickerClient(cfg) {
             LOG.info('picker: reconnected %s', client.toString());
         });
         client.on('error', function (err) {
+            onError(err);
             LOG.warn(err, 'picker: error (reconnecting)');
         });
     }
-- 
2.21.0

