{"project":"joyent/illumos-joyent","branch":"master","id":"I6a175f35f25ea47a4b116ad2dd1a0600fdf5a2bc","number":"3756","subject":"OS-6864 bhyve should guard against going off-cpu OS-6865 bhyve could be lazy about FPU state Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Approved by: John Levon \u003cjohn.levon@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/3756","commitMessage":"OS-6864 bhyve should guard against going off-cpu\nOS-6865 bhyve could be lazy about FPU state\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nApproved by: John Levon \u003cjohn.levon@joyent.com\u003e\n","createdOn":1522708836,"lastUpdated":1522972223,"open":false,"status":"MERGED","comments":[{"timestamp":1522708836,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1522777765,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1522778272,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1522778439,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1522778481,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1522779065,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1522781843,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\nI\u0027ve added some perf-testing notes to the OS-6865 ticket."},{"timestamp":1522847985,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3:\n\n(2 comments)\n\nSorry, I only have spelling comments..."},{"timestamp":1522959262,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1522961198,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 5."},{"timestamp":1522961643,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1522961667,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1522961677,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5:\n\nWith the updates, the testing results using the dtrace script noted in the ticket are the same (lots of FPU save/restore calls eliminated)"},{"timestamp":1522966565,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1522972138,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1522972223,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"6","revision":"6a175f35f25ea47a4b116ad2dd1a0600fdf5a2bc","parents":["2a4abd31bb5e23749133489fd773b65cc6cb2ff1"],"ref":"refs/changes/56/3756/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1522972138,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522961667,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522966565,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522966565,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"SUBM","value":"1","grantedOn":1522972223,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/amd/svm.c","type":"MODIFIED","insertions":14,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":41,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":109,"deletions":-7},{"file":"usr/src/uts/i86pc/sys/vmm.h","type":"MODIFIED","insertions":9,"deletions":0}],"sizeInsertions":175,"sizeDeletions":-9},"patchSets":[{"number":"1","revision":"7b892f6f4d8d513e12ebbd71bd21137fce2bef84","parents":["89f28c29187081c8db00a633d949df9b5f2a403d"],"ref":"refs/changes/56/3756/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1522708836,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":2009,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Does the VTCS_FPU_RESTORED bit need to be cleared after the save call?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":2009,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"We are headed out of the function, but you\u0027re right, we could race in going off-cpu before the ctx handlers are pulled and repeat the action.\n\nNice catch."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/amd/svm.c","type":"MODIFIED","insertions":14,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":41,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":108,"deletions":-7},{"file":"usr/src/uts/i86pc/sys/vmm.h","type":"MODIFIED","insertions":9,"deletions":0}],"sizeInsertions":174,"sizeDeletions":-9},{"number":"2","revision":"311129d51ba8898995922703dc59cd8d23d4faff","parents":["89f28c29187081c8db00a633d949df9b5f2a403d"],"ref":"refs/changes/56/3756/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1522778439,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/amd/svm.c","type":"MODIFIED","insertions":14,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":41,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":109,"deletions":-7},{"file":"usr/src/uts/i86pc/sys/vmm.h","type":"MODIFIED","insertions":9,"deletions":0}],"sizeInsertions":175,"sizeDeletions":-9},{"number":"3","revision":"58b8044acd58f8781320432a957dd214dd467e65","parents":["7ab3f5348d729755d5a5fe1c679174b62ec4861e"],"ref":"refs/changes/56/3756/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1522778481,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522779065,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":271,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"\"CRITICAL\" ?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":271,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Fixed here and at all the reference points."},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":1827,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"\"elision\""},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":1827,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Some day I\u0027ll internalize the correct spelling for this.  (That or change vim to enable \u0027set spell\u0027 by default)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/amd/svm.c","type":"MODIFIED","insertions":14,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":41,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":109,"deletions":-7},{"file":"usr/src/uts/i86pc/sys/vmm.h","type":"MODIFIED","insertions":9,"deletions":0}],"sizeInsertions":175,"sizeDeletions":-9},{"number":"4","revision":"92ad3d290864a638426b34e0c1238a980b93aebf","parents":["2a4abd31bb5e23749133489fd773b65cc6cb2ff1"],"ref":"refs/changes/56/3756/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1522959262,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522779065,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/amd/svm.c","type":"MODIFIED","insertions":14,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":41,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":109,"deletions":-7},{"file":"usr/src/uts/i86pc/sys/vmm.h","type":"MODIFIED","insertions":9,"deletions":0}],"sizeInsertions":175,"sizeDeletions":-9},{"number":"5","revision":"0536177a00d799b479470f873205b2a2a691da22","parents":["2a4abd31bb5e23749133489fd773b65cc6cb2ff1"],"ref":"refs/changes/56/3756/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1522961198,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522961667,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522966565,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522966565,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/amd/svm.c","type":"MODIFIED","insertions":14,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":41,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":109,"deletions":-7},{"file":"usr/src/uts/i86pc/sys/vmm.h","type":"MODIFIED","insertions":9,"deletions":0}],"sizeInsertions":175,"sizeDeletions":-9},{"number":"6","revision":"6a175f35f25ea47a4b116ad2dd1a0600fdf5a2bc","parents":["2a4abd31bb5e23749133489fd773b65cc6cb2ff1"],"ref":"refs/changes/56/3756/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1522972138,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522961667,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1522972223,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522966565,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522966565,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/amd/svm.c","type":"MODIFIED","insertions":14,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":41,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":109,"deletions":-7},{"file":"usr/src/uts/i86pc/sys/vmm.h","type":"MODIFIED","insertions":9,"deletions":0}],"sizeInsertions":175,"sizeDeletions":-9}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}