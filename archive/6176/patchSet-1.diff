From 23aff53559476ef2ec5397521fdfc1cbc8a7a306 Mon Sep 17 00:00:00 2001
From: Kelly McLaughlin <kelly.mclaughlin@joyent.com>
Date: Mon, 29 Apr 2019 16:01:44 -0600
Subject: [PATCH] MANTA-4241 Cleanup node-boray API interface and code
 documentation

---
 lib/client.js | 251 ++++++++++++++++++++++++++++++--------------------
 lib/object.js |  14 +--
 2 files changed, 160 insertions(+), 105 deletions(-)

diff --git a/lib/client.js b/lib/client.js
index d208580..68566d4 100644
--- a/lib/client.js
+++ b/lib/client.js
@@ -542,13 +542,13 @@ BorayClient.prototype.releaseWhenDone = function releaseOnEnd(rpcctx, emitter) {
 /**
  * Creates a Bucket
  *
- * `cfg` allows you to pass in index information, as well as pre/post triggers.
- * See https://mo.joyent.com/docs/boray/master/#CreateBucket for more info.
+ * This function should be used when the virtual node for the bucket has already
+ * been determined.
  *
- * @param {String} b    - Bucket name
- * @param {Object} cfg  - configuration
- * @param {Object} opts - request parameters
- * @param {Function} cb - callback
+ * @param {String} owner  - Account owner
+ * @param {String} bucket - Bucket name
+ * @param {Number} vnode  - Virtual node identifier
+ * @param {Function} cb   - callback
  */
 BorayClient.prototype.createBucket =
     function createBucket(owner, bucket, vnode, cb) {
@@ -560,6 +560,16 @@ BorayClient.prototype.createBucket =
     }
 };
 
+/**
+ * Creates a Bucket
+ *
+ * This function should be used when the virtual node for the bucket has not yet
+ * been determined.
+ *
+ * @param {String} owner  - Account owner
+ * @param {String} bucket - Bucket name
+ * @param {Function} cb   - callback
+ */
 BorayClient.prototype.createBucketNoVnode =
     function createBucketNoVnode(owner, bucket, cb) {
 
@@ -574,19 +584,31 @@ BorayClient.prototype.createBucketNoVnode =
 /**
  * Fetches a Bucket
  *
- * See https://mo.joyent.com/docs/boray/master/#GetBucket for more info.
+ * This function should be used when the virtual node for the bucket has already
+ * been determined.
  *
- * @param {String} b    - Bucket name
- * @param {Object} opts - request parameters
- * @param {Function} cb - callback
+ * @param {String} owner  - Account owner
+ * @param {String} bucket - Bucket name
+ * @param {Number} vnode  - Virtual node identifier
  */
-BorayClient.prototype.getBucket = function getBucket(o, b, vnode, cb) {
+BorayClient.prototype.getBucket = function getBucket(owner, bucket, vnode, cb) {
     var rpcctx = this.ctxCreateForCallback(cb);
-    if (rpcctx)
-        buckets.getBucket(rpcctx, o, b, vnode, this.makeReleaseCb(rpcctx, cb));
+    if (rpcctx) {
+        buckets.getBucket(rpcctx, owner, bucket, vnode,
+            this.makeReleaseCb(rpcctx, cb));
+    }
 };
 
-
+/**
+ * Fetches a Bucket
+ *
+ * This function should be used when the virtual node for the bucket has not yet
+ * been determined.
+ *
+ * @param {String} owner  - Account owner
+ * @param {String} bucket - Bucket namez
+ * @param {Function} cb - callback
+ */
 BorayClient.prototype.getBucketNoVnode = function getBucketNoVnode(o, b, cb) {
     var rpcctx = this.ctxCreateForCallback(cb);
     if (rpcctx)
@@ -594,7 +616,10 @@ BorayClient.prototype.getBucketNoVnode = function getBucketNoVnode(o, b, cb) {
 };
 
 /**
- * Lists buckets
+ * Lists buckets for an account at a specific virtual node
+ *
+ * @param {String} owner  - Account owner
+ * @param {Number} vnode  - Virtual node identifier
  */
 BorayClient.prototype.listBuckets = function listBuckets(owner, vnode) {
     var rpcctx = this.ctxCreateForEmitter();
@@ -610,6 +635,11 @@ BorayClient.prototype.listBuckets = function listBuckets(owner, vnode) {
     return (rv);
 };
 
+/**
+ * Lists buckets for an account
+ *
+ * @param {String} owner  - Account owner
+ */
 BorayClient.prototype.listBucketsNoVnode = function listBucketsNoVnode(owner) {
     var rpcctx = this.ctxCreateForEmitter();
     var rv;
@@ -626,98 +656,68 @@ BorayClient.prototype.listBucketsNoVnode = function listBucketsNoVnode(owner) {
 
 
 /**
- * Updates an existing Bucket
+ * Deletes a bucket
  *
- * `cfg` allows you to pass in index information, as well as pre/post triggers.
- * See https://mo.joyent.com/docs/boray/master/#UpdateBucket for more info.
+ * This function should be used when the virtual node for the bucket has already
+ * been determined.
  *
- * @param {String} b    - Bucket name
- * @param {Object} cfg  - configuration
- * @param {Object} opts - request parameters
- * @param {Function} cb - callback
+ * @param {String} owner  - Account owner
+ * @param {String} bucket - Bucket name
+ * @param {Number} vnode  - Virtual node identifier
+ * @param {Function} cb   - callback
  */
-BorayClient.prototype.updateBucket = function updateBucket(b, cfg, opts, cb) {
-    if (typeof (opts) === 'function') {
-        cb = opts;
-        opts = {};
-    }
+BorayClient.prototype.deleteBucket = function deleteBucket(owner, bucket, vnode,
+    cb) {
     var rpcctx = this.ctxCreateForCallback(cb);
-    if (rpcctx)
-        buckets.updateBucket(rpcctx, b, cfg, opts,
+    if (rpcctx) {
+        buckets.deleteBucket(rpcctx, owner, bucket, vnode,
             this.makeReleaseCb(rpcctx, cb));
+    }
 };
 
 
 /**
- * Deletes a Bucket
+ * Deletes a bucket
  *
- * See https://mo.joyent.com/docs/boray/master/#DeleteBucket for more info.
+ * This function should be used when the virtual node for the bucket has not yet
+ * been determined.
  *
- * @param {String} b    - Bucket name
- * @param {Object} opts - request parameters
- * @param {Function} cb - callback
+ * @param {String} owner  - Account owner
+ * @param {String} bucket - Bucket name
+ * @param {Function} cb   - callback
  */
-BorayClient.prototype.deleteBucket = function deleteBucket(o, b, vnode, cb) {
-    var rpcctx = this.ctxCreateForCallback(cb);
-    if (rpcctx) {
-        buckets.deleteBucket(rpcctx, o, b, vnode,
-            this.makeReleaseCb(rpcctx, cb));
-    }
-};
-
-
 BorayClient.prototype.deleteBucketNoVnode =
-    function deleteBucketNoVnode(o, b, cb) {
+    function deleteBucketNoVnode(owner, bucket, cb) {
 
     var rpcctx = this.ctxCreateForCallback(cb);
     if (rpcctx) {
-        buckets.deleteBucketNoVnode(rpcctx, o, b,
+        buckets.deleteBucketNoVnode(rpcctx, owner, bucket,
             this.makeReleaseCb(rpcctx, cb));
     }
 };
 
 
 /**
- * Creates or replaces a Bucket.
- *
- * Note that this is actually just a client shim, and simply calls
- * get, followed by create || update.  This is not transactional,
- * and there are races, so you probably just want to call this once
- * at startup in your code.
- *
- * @param {String} b    - Bucket name
- * @param {Object} opts - request parameters
- * @param {Function} cb - callback
- */
-BorayClient.prototype.putBucket = function putBucket(b, cfg, opts, cb) {
-    assert.string(b, 'bucket');
-    assert.object(cfg, 'config');
-    if (typeof (opts) === 'function') {
-        cb = opts;
-        opts = {};
-    }
-    assert.object(opts, 'options');
-    assert.func(cb, 'callback');
-
-    var rpcctx = this.ctxCreateForCallback(cb);
-    if (rpcctx)
-        buckets.putBucket(rpcctx, b, cfg, opts, this.makeReleaseCb(rpcctx, cb));
-};
-
-/**
- * Idempotently Creates or Replaces an Object.
+ * Creates an object. If an object already exists at the key it is overwritten.
  *
- * See https://mo.joyent.com/docs/boray/master/#PutObject for more info.
+ * This function is used when the destination virtual node for the object has
+ * already been determined.
  *
- * @param {String} b    - Bucket name
- * @param {String} k    - Key name
- * @param {Object} v    - Value
- * @param {Object} opts - request parameters
- * @param {Function} cb - callback
+ * @param {String} owner           - Account owner
+ * @param {String} bucket_id       - Bucket id
+ * @param {String} name            - Object key name
+ * @param {Number} content_length  - The size of the object
+ * @param {String} content_md5     - MD5 digest of the object
+ * @param {String} content_type    - Content-Type of the object
+ * @param {Object} headers         - Value
+ * @param {Object} sharks          - Value
+ * @param {Object} props           - Value
+ * @param {Number} vnode           - Virtual node identifier
+ * @param {Function} cb            - callback
  */
-BorayClient.prototype.putObject = function putObject(owner, bucket_id, name,
-    content_length, content_md5, content_type, headers, sharks, props, vnode,
-    cb) {
+BorayClient.prototype.createObject = function createObject(owner, bucket_id,
+    name, content_length, content_md5, content_type, headers, sharks, props,
+    vnode, cb) {
     assert.string(owner, 'owner');
     assert.string(bucket_id, 'bucket_id');
     assert.string(name, 'name');
@@ -731,13 +731,31 @@ BorayClient.prototype.putObject = function putObject(owner, bucket_id, name,
 
     var rpcctx = this.ctxCreateForCallback(cb);
     if (rpcctx) {
-        objects.putObject(rpcctx, owner, bucket_id, name,
+        objects.createObject(rpcctx, owner, bucket_id, name,
             content_length, content_md5, content_type, headers, sharks, props,
             vnode, this.makeReleaseCb(rpcctx, cb));
     }
 };
 
-BorayClient.prototype.putObjectNoVnode = function putObjectNoVnode(owner,
+
+/**
+ * Creates an object. If an object already exists at the key it is overwritten.
+ *
+ * This function is intended to be used when the destination virtual node for an
+ * object has not been determined.
+ *
+ * @param {String} owner           - Account owner
+ * @param {String} bucket_id       - Bucket id
+ * @param {String} name            - Object key name
+ * @param {Number} content_length  - The size of the object
+ * @param {String} content_md5     - MD5 digest of the object
+ * @param {String} content_type    - Content-Type of the object
+ * @param {Object} headers         - Value
+ * @param {Object} sharks          - Value
+ * @param {Object} props           - Value
+ * @param {Function} cb            - callback
+ */
+BorayClient.prototype.createObjectNoVnode = function createObjectNoVnode(owner,
     bucket_id, name, content_length, content_md5, content_type, headers,
     sharks, props, cb) {
 
@@ -753,7 +771,7 @@ BorayClient.prototype.putObjectNoVnode = function putObjectNoVnode(owner,
 
     var rpcctx = this.ctxCreateForCallback(cb);
     if (rpcctx) {
-        objects.putObjectNoVnode(rpcctx, owner, bucket_id, name,
+        objects.createObjectNoVnode(rpcctx, owner, bucket_id, name,
             content_length, content_md5, content_type, headers, sharks, props,
             this.makeReleaseCb(rpcctx, cb));
     }
@@ -761,14 +779,16 @@ BorayClient.prototype.putObjectNoVnode = function putObjectNoVnode(owner,
 
 
 /**
- * Fetches an Object
+ * Fetches an object.
  *
- * See https://mo.joyent.com/docs/boray/master/#GetObject for more info.
+ * This function is intended to be used when the virtual node where the object
+ * resides has already been determined.
  *
- * @param {String} b    - Bucket name
- * @param {String} k    - Key name
- * @param {Object} opts - request parameters
- * @param {Function} cb - callback
+ * @param {String} owner           - Account owner
+ * @param {String} bucket_id       - Bucket id
+ * @param {String} name            - Object key name
+ * @param {Number} vnode           - Virtual node identifier
+ * @param {Function} cb            - callback
  */
 BorayClient.prototype.getObject =
     function getObject(owner, bucket_id, name, vnode, cb) {
@@ -786,6 +806,17 @@ BorayClient.prototype.getObject =
     }
 };
 
+/**
+ * Fetches an object.
+ *
+ * This function is intended to be used when the virtual node where the object
+ * resides has not been determined.
+ *
+ * @param {String} owner           - Account owner
+ * @param {String} bucket_id       - Bucket id
+ * @param {String} name            - Object key name
+ * @param {Function} cb            - callback
+ */
 BorayClient.prototype.getObjectNoVnode =
     function getObjectNoVnode(owner, bucket_id, name, cb) {
 
@@ -802,7 +833,12 @@ BorayClient.prototype.getObjectNoVnode =
 };
 
 /**
- * Lists objects
+ * Lists objects for the bucket belonging to the owner account at a particular
+ * virtual node.
+ *
+ * @param {String} owner           - Account owner
+ * @param {String} bucket_id       - Bucket id
+ * @param {Number} vnode           - Virtual node identifier
  */
 BorayClient.prototype.listObjects =
     function listObjects(owner, bucket_id, vnode) {
@@ -820,6 +856,12 @@ BorayClient.prototype.listObjects =
     return (rv);
 };
 
+/**
+ * Lists objects for the bucket belonging to the owner account.
+ *
+ * @param {String} owner           - Account owner
+ * @param {String} bucket_id       - Bucket id
+ */
 BorayClient.prototype.listObjectsNoVnode =
     function listObjectsNoVnode(owner, bucket_id) {
 
@@ -837,14 +879,16 @@ BorayClient.prototype.listObjectsNoVnode =
 };
 
 /**
- * Deletes an Object
+ * Deletes an object.
  *
- * See https://mo.joyent.com/docs/boray/master/#DeleteObject for more info.
+ * This function is intended to be used when the virtual node where the object
+ * resides has already been determined.
  *
- * @param {String} b    - Bucket name
- * @param {String} k    - Key name
- * @param {Object} opts - request parameters
- * @param {Function} cb - callback
+ * @param {String} owner           - Account owner
+ * @param {String} bucket_id       - Bucket id
+ * @param {String} name            - Object key name
+ * @param {Number} vnode           - Virtual node identifier
+ * @param {Function} cb            - callback
  */
 BorayClient.prototype.deleteObject =
     function deleteObject(owner, bucket_id, name, vnode, cb) {
@@ -862,6 +906,17 @@ BorayClient.prototype.deleteObject =
     }
 };
 
+/**
+ * Deletes an object.
+ *
+ * This function is intended to be used when the virtual node where the object
+ * resides has not been determined.
+ *
+ * @param {String} owner           - Account owner
+ * @param {String} bucket_id       - Bucket id
+ * @param {String} name            - Object key name
+ * @param {Function} cb            - callback
+ */
 BorayClient.prototype.deleteObjectNoVnode =
     function deleteObjectNoVnode(owner, bucket_id, name, cb) {
 
diff --git a/lib/object.js b/lib/object.js
index 9da2e28..26fe64c 100644
--- a/lib/object.js
+++ b/lib/object.js
@@ -27,8 +27,8 @@ var rpc = require('./rpc');
 
 ///--- API
 
-function putObject(rpcctx, owner, bucket_id, name, content_length, content_md5,
-    content_type, headers, sharks, props, vnode, callback) {
+function createObject(rpcctx, owner, bucket_id, name, content_length,
+    content_md5, content_type, headers, sharks, props, vnode, callback) {
     var opts, log;
 
     assert.object(rpcctx, 'rpcctx');
@@ -60,7 +60,7 @@ function putObject(rpcctx, owner, bucket_id, name, content_length, content_md5,
     rpc.rpcCommonBufferData({
         'rpcctx': rpcctx,
         'log': log,
-        'rpcmethod': 'putobject',
+        'rpcmethod': 'createobject',
         'rpcargs': [arg]
     }, function (err, data) {
         if (!err && data.length > 1) {
@@ -76,7 +76,7 @@ function putObject(rpcctx, owner, bucket_id, name, content_length, content_md5,
     });
 }
 
-function putObjectNoVnode(rpcctx, owner, bucket_id, name, content_length,
+function createObjectNoVnode(rpcctx, owner, bucket_id, name, content_length,
     content_md5, content_type, headers, sharks, props, callback) {
     var opts, log;
 
@@ -107,7 +107,7 @@ function putObjectNoVnode(rpcctx, owner, bucket_id, name, content_length,
     rpc.rpcCommonBufferData({
         'rpcctx': rpcctx,
         'log': log,
-        'rpcmethod': 'putobject',
+        'rpcmethod': 'createObject',
         'rpcargs': args
     }, function (err, data) {
         if (!err && data.length > 1) {
@@ -366,10 +366,10 @@ function makeOptions(options, value) {
 ///--- Exports
 
 module.exports = {
-    putObject: putObject,
+    createObject: createObject,
     getObject: getObject,
     deleteObject: deleteObject,
-    putObjectNoVnode: putObjectNoVnode,
+    createObjectNoVnode: createObjectNoVnode,
     getObjectNoVnode: getObjectNoVnode,
     deleteObjectNoVnode: deleteObjectNoVnode,
     listObjects: listObjects,
-- 
2.21.0

