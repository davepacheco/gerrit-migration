From 50b5485a9fa76c04953ea58e9002a6ffa1e7c2b2 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Fri, 10 Mar 2017 14:56:54 -0800
Subject: [PATCH] joyent/node-mname#19 infinite loop possible in readName()

---
 lib/dns-buffer.js     | 10 ++++++++--
 test/protocol.test.js | 22 +++++++++++++++++++++-
 2 files changed, 29 insertions(+), 3 deletions(-)

diff --git a/lib/dns-buffer.js b/lib/dns-buffer.js
index fbe1b94..62bfda2 100644
--- a/lib/dns-buffer.js
+++ b/lib/dns-buffer.js
@@ -92,7 +92,7 @@ DNSBuffer.prototype.readName = function () {
         var finalOff;
 
         rlen = this._buffer.readUInt8(off++);
-        while (rlen !== 0x00) {
+        while (rlen !== 0x00 && name.length < 256) {
                 var meta = rlen & NAME_META_MASK;
 
                 if (meta == NAME_STRING) {
@@ -108,7 +108,9 @@ DNSBuffer.prototype.readName = function () {
                         ptr = ptr | ((rlen & ~(0xC0)) << 8);
 
                         assert.ok(ptr < this._size,
-                            'invalid label pointer (off end of buf)');
+                            'Invalid label pointer (off end of buffer)');
+                        assert.ok(!(ptr >= this._offset && ptr <= off),
+                            'Invalid label pointer (causes a loop)');
 
                         if (finalOff === undefined)
                                 finalOff = off;
@@ -121,6 +123,10 @@ DNSBuffer.prototype.readName = function () {
                 rlen = this._buffer.readUInt8(off++);
         }
 
+        if (name.length > 255) {
+                throw (new Error('Invalid name (maximum length exceeded)'));
+        }
+
         if (finalOff === undefined)
                 finalOff = off;
         this._offset = finalOff;
diff --git a/test/protocol.test.js b/test/protocol.test.js
index 935b356..07bf5be 100644
--- a/test/protocol.test.js
+++ b/test/protocol.test.js
@@ -61,6 +61,26 @@ test('mname#12 regression test', function (t) {
         var b = new Buffer('GET / HTTP/1.1\r\n\r\n');
         t.throws(function () {
                 var decoded = protocol.decode(b, 'message');
-        });
+        }, /label length/i);
+        t.end();
+});
+
+test('mname#19 regression test (easy loop)', function (t) {
+        var b = new Buffer('3bb981000001000000000000' +
+                '047566647304636f616c066a6f79656e74027573c00c' +
+                '00010001', 'hex');
+        t.throws(function () {
+                var decoded = protocol.decode(b, 'message');
+        }, /label pointer/i);
+        t.end();
+});
+
+test('mname#19 regression test (harder loop)', function (t) {
+        var b = new Buffer('3bb981000001000000000005' +
+                '047566647304636f616c066a6f79656e74027573c00b' +
+                '00010001', 'hex');
+        t.throws(function () {
+                var decoded = protocol.decode(b, 'message');
+        }, /maximum length/i);
         t.end();
 });
-- 
2.21.0

