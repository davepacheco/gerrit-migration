From 893879dde459000053bffff9d259384231f6e6d3 Mon Sep 17 00:00:00 2001
From: Julien Gilli <julien.gilli@joyent.com>
Date: Tue, 13 Mar 2018 16:10:21 -0700
Subject: [PATCH] VOLAPI-90 UpdateVolume endpoint should return updated
 resource

---
 lib/endpoints/volumes.js    | 20 +++-----------------
 test/volumes-update.test.js | 22 +++++++++++++++++++---
 2 files changed, 22 insertions(+), 20 deletions(-)

diff --git a/lib/endpoints/volumes.js b/lib/endpoints/volumes.js
index 92ec16b..cf71299 100644
--- a/lib/endpoints/volumes.js
+++ b/lib/endpoints/volumes.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -552,22 +552,8 @@ function updateVolume(req, res, next) {
                 return;
             }
 
-            /*
-             * We purposedly do _not_ render the updated volume, as we would
-             * need to either:
-             *
-             * 1. render the original volume, which is not useful when we try to
-             *    update (change) it.
-             *
-             * 2. render the result of the update, which would require to load
-             *    the volume object from moray, adding more latency to the
-             *    request's response.
-             *
-             * Instead, we reply with a 204 HTTP status code (no content) and
-             * clients can send a GetVolume request if/when they want to get the
-             * representation of the modified volume.
-             */
-            res.send(204);
+            res.send(200, translateVolumeFromVolApi(volume));
+
             next();
         });
 }
diff --git a/test/volumes-update.test.js b/test/volumes-update.test.js
index 28e2e69..04c0cde 100644
--- a/test/volumes-update.test.js
+++ b/test/volumes-update.test.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
@@ -112,9 +112,17 @@ if (CONFIG.experimental_cloudapi_nfs_shared_volumes !== true) {
     test('updating newly-created volume\'s name should succeed', function (t) {
         CLIENT.post('/my/volumes/' + testVolume.id, {
             name: testVolumeSecondName
-        }, function onVolumeRenamed(volUpdateErr) {
+        }, function onVolumeRenamed(volUpdateErr, req, res, updatedVol) {
             t.ifErr(volUpdateErr, 'renaming volume ' + testVolumeName + ' to ' +
                 testVolumeSecondName + ' should succeed');
+
+            t.ok(updatedVol, 'response should not be empty');
+            if (updatedVol) {
+                t.equal(updatedVol.name, testVolumeSecondName,
+                    'name of updated volume should be: ' +
+                        testVolumeSecondName + ', got: ' + updatedVol.name);
+            }
+
             t.end();
         });
     });
@@ -145,9 +153,17 @@ if (CONFIG.experimental_cloudapi_nfs_shared_volumes !== true) {
     test('updating newly-created volume with no param should succeed',
         function (t) {
             CLIENT.post('/my/volumes/' + testVolume.id, {},
-                function onVolUpdated(volUpdateErr) {
+                function onVolUpdated(volUpdateErr, req, res, updatedVol) {
                     t.ifErr(volUpdateErr,
                         'updating volume with no param should succeed');
+
+                t.ok(updatedVol, 'response should not be empty');
+                if (updatedVol) {
+                    t.equal(updatedVol.name, testVolumeSecondName,
+                        'name of updated volume should be: ' +
+                            testVolumeSecondName + ', got: ' + updatedVol.name);
+                }
+
                     t.end();
                 });
         });
-- 
2.21.0

