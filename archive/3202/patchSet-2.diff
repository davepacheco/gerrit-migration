From 6375bfbd0404ece69837cb690215918f4f323358 Mon Sep 17 00:00:00 2001
From: Marsell Kukuljevic <marsell@joyent.com>
Date: Wed, 6 Dec 2017 16:09:10 +1300
Subject: [PATCH] TRITON-19: Triton equivalent to AWS' termination protection

---
 docs/index.md         | 11 +++++++----
 lib/endpoints/vms.js  | 11 +++++++++++
 lib/errors.js         | 28 +++++++++++++++++++++++++++-
 package.json          |  2 +-
 test/vms.full.test.js | 40 +++++++++++++++++++++++++++++++++-------
 5 files changed, 79 insertions(+), 13 deletions(-)

diff --git a/docs/index.md b/docs/index.md
index db32891..fa85754 100644
--- a/docs/index.md
+++ b/docs/index.md
@@ -1462,11 +1462,14 @@ has succeeded.
 
 ## DeleteVm (DELETE /vms/:uuid)
 
-Deletes a VM. If the VM exists and has a `server_uuid` that refers to an actual
-CN that is available, the VM will be physically destroyed and it will be marked
-as destroyed in the cache database.
+Deletes a VM. If the VM exists, has a `server_uuid` that refers to an actual
+CN that is available, and does not have the tag `triton.instance.protection` set
+true, the VM will be physically destroyed and it will be marked as destroyed in
+the cache database.
 
 If the VM doesn't have a `server_uuid`, the request will result in an error.
+Likewise, if the instance protection tag is true, the request will also result
+in an error -- in order to delete such a VM, the tag must be removed first.
 
 ### Inputs
 
@@ -1482,7 +1485,7 @@ If the VM doesn't have a `server_uuid`, the request will result in an error.
 | ---- | ---------------------------------------------------------------------------- | ------------------ |
 | 202  | New job created                                                              | VM response object |
 | 404  | VM Not Found. VM does not exist or VM does not belong to the specified owner | Error object       |
-| 409  | VM not allocated to a server yet                                             | Error object       |
+| 409  | VM not allocated to a server yet, or instance protection tag present         | Error object       |
 
 On a successful response, a [VM Job Response Object](#vm-job-response-object) is
 returned in the response body.
diff --git a/lib/endpoints/vms.js b/lib/endpoints/vms.js
index eda81b0..474e11b 100644
--- a/lib/endpoints/vms.js
+++ b/lib/endpoints/vms.js
@@ -42,6 +42,7 @@ var VALID_VM_ACTIONS = [
 
 var DEFAULT_LIST_VM_LIMIT = common.MAX_LIST_VMS_LIMIT;
 var DEFAULT_LIST_VM_OFFSET = 0;
+var INSTANCE_PROTECTION_TAG = 'triton.instance.protection';
 
 function validAction(action) {
     return VALID_VM_ACTIONS.indexOf(action) != -1;
@@ -828,6 +829,16 @@ function deleteVm(req, res, next) {
         req.params.sync = (sync === 'true' ? true : false);
     }
 
+    /*
+     * If an instance has this tag, we should not delete it. If a client wants
+     * to destroy this instance, they'll need to remove the tag first.
+     */
+    if (req.vm.tags[INSTANCE_PROTECTION_TAG]) {
+        var msg = 'Instance has "' + INSTANCE_PROTECTION_TAG + '" tag';
+        next(new errors.CannotDeleteInstanceError(msg));
+        return;
+    }
+
     /*
      * If the vm has no server_uuid, then starting a destroy workflow would fail
      * right after it starts, since the part of the workflow that would start
diff --git a/lib/errors.js b/lib/errors.js
index 4622e1d..e22f46e 100644
--- a/lib/errors.js
+++ b/lib/errors.js
@@ -90,6 +90,31 @@ BrandNotSupportedError.statusCode = 409;
 
 
 
+/*
+ * Return this error when attempting to destroy an instance that we aren't
+ * allowed to destroy.
+ */
+function CannotDeleteInstanceError(message) {
+    assert.string(message, 'message');
+
+    restify.RestError.call(this, {
+        restCode: this.constructor.restCode,
+        statusCode: this.constructor.statusCode,
+        message: message,
+        body: {
+            code: this.constructor.restCode,
+            message: message
+        }
+    });
+}
+
+util.inherits(CannotDeleteInstanceError, restify.RestError);
+CannotDeleteInstanceError.prototype.name = 'CannotDeleteInstanceError';
+CannotDeleteInstanceError.restCode = 'CannotDeleteInstanceError';
+CannotDeleteInstanceError.statusCode = 409;
+
+
+
 /*
  * Base function for validation errors
  */
@@ -229,6 +254,7 @@ exports.wfapiWrap = function (opts) {
 exports.UnallocatedVMError = UnallocatedVMError;
 exports.ValidationFailedError = ValidationFailedError;
 exports.BrandNotSupportedError = BrandNotSupportedError;
+exports.CannotDeleteInstanceError = CannotDeleteInstanceError;
 exports.VmNotRunningError = VmNotRunningError;
 
 function MorayBucketsNotSetupError(lastInitError) {
@@ -307,4 +333,4 @@ function InvalidDataMigrationFileNamesError(fileNames) {
     this.message = 'Invalid data migration file name: ' + fileNames.join(',');
 }
 util.inherits(InvalidDataMigrationFileNamesError, Error);
-exports.InvalidDataMigrationFileNamesError = InvalidDataMigrationFileNamesError;
\ No newline at end of file
+exports.InvalidDataMigrationFileNamesError = InvalidDataMigrationFileNamesError;
diff --git a/package.json b/package.json
index 4cb941d..06426d1 100644
--- a/package.json
+++ b/package.json
@@ -27,7 +27,7 @@
     "sprintf": "0.1.1",
     "strsplit": "1.0.0",
     "trace-event": "1.3.0",
-    "triton-tags": "^1.1.4",
+    "triton-tags": "git+https://github.com/joyent/node-triton-tags.git#45e436996c1bad20b5ddb9120a0457e47f8a798f",
     "vasync": "^1.6.3",
     "verror": "1.10.0",
     "wf-client": "0.2.1"
diff --git a/test/vms.full.test.js b/test/vms.full.test.js
index b237f3f..3ac4327 100644
--- a/test/vms.full.test.js
+++ b/test/vms.full.test.js
@@ -572,9 +572,15 @@ exports.create_vm_tags_not_ok = function (t) {
         callVmapi({ 'triton.cns.services': 'foo,$#foo.bar' }, msg, next);
     }
 
+    function checkBadTritonInstanceProtection(next) {
+        var msg = 'Triton tag "triton.instance.protection" value must be a ' +
+            'boolean: "true" (string)';
+        callVmapi({ 'triton.instance.protection': 'true' }, msg, next);
+    }
+
     async.series([
         checkBadTritonTag, checkBadTritonTagType1, checkBadTritonTagType2,
-        checkBadTritonDNS
+        checkBadTritonDNS, checkBadTritonInstanceProtection
     ], function () {
         t.done();
     });
@@ -1365,7 +1371,8 @@ exports.add_tags = function (t) {
 
     var query = {
         role: 'database',
-        group: 'deployment'
+        group: 'deployment',
+        'triton.instance.protection': true
     };
 
     var opts = createOpts(path, query);
@@ -1395,7 +1402,8 @@ exports.wait_new_tag_job = function (t) {
 exports.wait_new_tag = function (t) {
     var tags = {
         role: 'database',
-        group: 'deployment'
+        group: 'deployment',
+        'triton.instance.protection': true
     };
 
     waitForValue(vmLocation, 'tags', tags, {
@@ -1408,21 +1416,38 @@ exports.wait_new_tag = function (t) {
 
 
 exports.get_tag = function (t) {
-    var path = '/vms/' + newUuid + '/tags/role?owner_uuid=' + CUSTOMER;
+    var path = '/vms/' + newUuid +
+        '/tags/triton.instance.protection?owner_uuid=' + CUSTOMER;
 
     client.get(path, function (err, req, res, data) {
         common.ifError(t, err);
         t.equal(res.statusCode, 200, '200 OK');
         common.checkHeaders(t, res.headers);
-        t.ok(data);
-        t.equal(data, 'database');
+        t.equal(data, true);
+        t.done();
+    });
+};
+
+
+exports.cannot_destroy_vm_with_instance_protection = function (t) {
+    var opts = createOpts(vmLocation);
+
+    client.del(opts, function (err, req, res, body) {
+        t.ok(err, 'error expected');
+        t.equal(res.statusCode, 409, '409 Conflict');
+        t.deepEqual(body, {
+            code: 'CannotDeleteInstanceError',
+            message: 'Instance has "triton.instance.protection" tag'
+        }, 'error message');
         t.done();
     });
 };
 
 
+
 exports.delete_tag = function (t) {
-    var path = '/vms/' + newUuid + '/tags/role?owner_uuid=' + CUSTOMER;
+    var path = '/vms/' + newUuid +
+        '/tags/triton.instance.protection?owner_uuid=' + CUSTOMER;
 
     var opts = createOpts(path, { owner_uuid: CUSTOMER });
 
@@ -1450,6 +1475,7 @@ exports.wait_delete_tag_job = function (t) {
 
 exports.wait_delete_tag = function (t) {
     var tags = {
+        role: 'database',
         group: 'deployment'
     };
 
-- 
2.21.0

