{"project":"joyent/illumos-joyent","branch":"master","id":"Idda0e47c2badd728740bdd16c77d919042675909","number":"1440","subject":"OS-5938 pread/pwrite behave incorrectly on socket Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/1440","commitMessage":"OS-5938 pread/pwrite behave incorrectly on socket\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1486389423,"lastUpdated":1486409121,"open":false,"status":"MERGED","comments":[{"timestamp":1486389423,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1486395291,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1486395387,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1486401250,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1486401706,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1486408644,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Integration-Approval+1\n\nApproved, pending successful results from LTP \u0026 Co."},{"timestamp":1486409108,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1486409121,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"3","revision":"dda0e47c2badd728740bdd16c77d919042675909","parents":["6bfeede3df60d4fd8da846abf41d991b2b8063eb"],"ref":"refs/changes/40/1440/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1486409108,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486401706,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1486408644,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1486409121,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":14,"deletions":-27}],"sizeInsertions":14,"sizeDeletions":-27},"patchSets":[{"number":"1","revision":"f290f31c2536b755ccebdd673a0b6b4eb586f889","parents":["1b4b813ed495a619f8cfe67a9dd3105c38ffe3ce"],"ref":"refs/changes/40/1440/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1486389423,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","line":600,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"We should perhaps consider moving this logic into the lx_read_common/lx_write_common functions in order to disallow positioned IO on sockets and pipes.  Both pread/pwrite _and_ preadv/pwritev disallow such actions."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","line":600,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Confirmed with this little test program:\n\n#include \u003cstdio.h\u003e\n#include \u003csys/socket.h\u003e\n#include \u003csys/uio.h\u003e\n\nint main()\n{\n        int fds[2];\n        char buf[256] \u003d { 0 };\n        struct iovec vec;\n\n        vec.iov_base \u003d buf;\n        vec.iov_len \u003d sizeof (buf);\n\n        socketpair(AF_UNIX, SOCK_STREAM, 0, fds);\n        pwritev(fds[0], \u0026vec, 1, 0);\n}\n\nStrace result:\n\nsocketpair(AF_UNIX, SOCK_STREAM, 0, [3, 4]) \u003d 0\npwritev(3, [{iov_base\u003d\"\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\"..., iov_len\u003d256}], 1, 0) \u003d -1 ESPIPE (Illegal seek)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":5,"deletions":-3}],"sizeInsertions":5,"sizeDeletions":-3},{"number":"2","revision":"1ffff64ee968ce3a4f887ed7c3ee9f5ea1e37c8a","parents":["6bfeede3df60d4fd8da846abf41d991b2b8063eb"],"ref":"refs/changes/40/1440/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1486401250,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486401706,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1486408644,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":14,"deletions":-27}],"sizeInsertions":14,"sizeDeletions":-27},{"number":"3","revision":"dda0e47c2badd728740bdd16c77d919042675909","parents":["6bfeede3df60d4fd8da846abf41d991b2b8063eb"],"ref":"refs/changes/40/1440/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1486409108,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1486409121,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486401706,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1486408644,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":14,"deletions":-27}],"sizeInsertions":14,"sizeDeletions":-27}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}