From f290f31c2536b755ccebdd673a0b6b4eb586f889 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Mon, 6 Feb 2017 13:56:53 +0000
Subject: [PATCH] OS-5938 pread/pwrite behave incorrectly on socket

---
 usr/src/uts/common/brand/lx/syscall/lx_rw.c | 8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/usr/src/uts/common/brand/lx/syscall/lx_rw.c b/usr/src/uts/common/brand/lx/syscall/lx_rw.c
index 50d532ff51..24b2edbf9e 100644
--- a/usr/src/uts/common/brand/lx/syscall/lx_rw.c
+++ b/usr/src/uts/common/brand/lx/syscall/lx_rw.c
@@ -10,7 +10,7 @@
  */
 
 /*
- * Copyright 2016 Joyent, Inc.
+ * Copyright 2017 Joyent, Inc.
  */
 
 #include <sys/errno.h>
@@ -596,7 +596,8 @@ lx_pread(int fdes, void *cbuf, size_t ccount, off64_t offset)
 		 */
 		if (fileoff + count > MAXOFFSET_T)
 			count = (ssize_t)((offset_t)MAXOFFSET_T - fileoff);
-	} else if (fp->f_vnode->v_type == VFIFO) {
+	} else if (fp->f_vnode->v_type == VFIFO ||
+	    fp->f_vnode->v_type == VSOCK) {
 		error = ESPIPE;
 		goto out;
 	} else if (fp->f_vnode->v_type == VDIR) {
@@ -686,7 +687,8 @@ lx_pwrite(int fdes, void *cbuf, size_t ccount, off64_t offset)
 		}
 		if (fileoff + count > MAXOFFSET_T)
 			count = (ssize_t)((u_offset_t)MAXOFFSET_T - fileoff);
-	} else if (fp->f_vnode->v_type == VFIFO) {
+	} else if (fp->f_vnode->v_type == VFIFO ||
+	    fp->f_vnode->v_type == VSOCK) {
 		error = ESPIPE;
 		goto out;
 	}
-- 
2.21.0

