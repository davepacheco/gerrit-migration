{"project":"joyent/smartos-live","branch":"master","id":"I7ad56e8480e6f12f1a4c128774020400da87c86d","number":"1576","subject":"OS-5985 vmadm man page incorrectly states dns_domain property is associated with /etc/hosts","owner":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"url":"https://cr.joyent.us/1576","commitMessage":"OS-5985 vmadm man page incorrectly states dns_domain property is associated with /etc/hosts\n","createdOn":1488053195,"lastUpdated":1529516086,"open":true,"status":"NEW","comments":[{"timestamp":1488053195,"reviewer":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"message":"Uploaded patch set 1."},{"timestamp":1488053196,"reviewer":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 98a8cff271df8831101b81db9db61413736b008a\n    \n    OS-5985 vmadm man page incorrectly states dns_domain property is associated with /etc/hosts"},{"timestamp":1488053232,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1488053581,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1488066201,"reviewer":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1488168118,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 1:\n\n\u003e (1 comment)\n\nvmadm sets this up in the zone config that\u0027s passed to zoneinit, which then writes these files on the very first boot (and then deletes itself). Newer zoneinits don\u0027t actually use this file, though, instead they get the hostname + dns_domain out of metadata (in 02-config.sh)\n\nAs far as I know zoneinit is not checked into source control anywhere, and is handed down from image to image, so it\u0027s possible some versions don\u0027t do this all the same way.\n\nIn the latest and last few base-64 releases this logic is all there and works the way I have explained (hostname + \".\" + dns_domain becomes the FQDN of the new zone and is written out into /etc/nodename. There\u0027s an attempt to use \"sed\" to update /etc/hosts as well, unclear if that all works the way it\u0027s supposed to still)\n\nHow did you set this property on the JPC? None of these properties (hostname, dns_domain etc) can be set through cloudapi (they are not passed through at all)."},{"timestamp":1529432134,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\nzoneinit is on GitHub at least *now*.\n\nIt looks like at one time zoneinit *did* set hostname including dns_domain, but no longer:\nhttps://github.com/joyent/zoneinit/commit/33c8d8d123739569e649bdef32c924b224a45686\n\nThere *is* still the attempt to sed \"@DOMAINNAME@\" into files in /etc and /opt/local/etc here: https://github.com/joyent/zoneinit/blob/master/includes/11-files.sh#L13-L24\n\nHowever on a base-64 image at the time (70e3ae72-96b6-11e6-9056-9737fd4d0764  base-64  16.3.1), there are no hits for that:\n\n```\n[root@headnode (coal) /zones/70e3ae72-96b6-11e6-9056-9737fd4d0764/root/etc]# grep -r DOMAINNAME .\n./security/audit_event:59:AUE_SETDOMAINNAME:setdomainname(2):no\n[root@headnode (coal) /zones/70e3ae72-96b6-11e6-9056-9737fd4d0764/root/etc]# cd ../opt/local/etc\n[root@headnode (coal) /zones/70e3ae72-96b6-11e6-9056-9737fd4d0764/root/opt/local/etc]# grep -r DOMAINNAME .\n[root@headnode (coal) /zones/70e3ae72-96b6-11e6-9056-9737fd4d0764/root/opt/local/etc]#\n```\n\nSo AFAICT the only usage of `\u003cvm\u003e.dns_domain` is for setting the `search ...` line in /etc/resolv.conf, and of course for `mdata-get sdc:dns_domain`."},{"timestamp":1529432218,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1529508358,"reviewer":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"message":"Uploaded patch set 2."},{"timestamp":1529508358,"reviewer":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit ee3627b4704d1fa2180334f6751f7ac29471554d\n    \n    WIP\n    \n    commit 90514600486f6529a9caf55c9cbef164c8a92def\n    \n    OS-5985 vmadm man page incorrectly states dns_domain property is associated with /etc/hosts"},{"timestamp":1529508405,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529508850,"reviewer":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1529516086,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(1 comment)"}],"currentPatchSet":{"number":"2","revision":"7ad56e8480e6f12f1a4c128774020400da87c86d","parents":["6d232f498952cf009c7dbd046d99cf65acf6ef08"],"ref":"refs/changes/76/1576/2","uploader":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"createdOn":1529508358,"author":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529508405,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":3,"sizeDeletions":0},"patchSets":[{"number":"1","revision":"f2f83d9d62c9cb6400313cea6c3deda075d2344b","parents":["93cf21d1496f0afe67d89cbf870b22c27bb713bf"],"ref":"refs/changes/76/1576/1","uploader":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"createdOn":1488053195,"author":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1488053232,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/vm/man/vmadm.1m.md","line":953,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"It also specifies the suffix that will be appended to \"hostname\" to set the FQDN for the zone at create time. If it\u0027s not specified, we append \".local\" instead. This should be noted here."},{"file":"src/vm/man/vmadm.1m.md","line":953,"reviewer":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"message":"I based my description on the behavior of /lib/svc/method/mdata-fetch, since that\u0027s the only SMF method I see that references dns_domain from mdata. The other SMF methods all reference CONFIG_dns_domain. I didn\u0027t see what you describe in the code for mdata-fetch.\n\nI have an instance deployed in JPC 1 week ago on PI 20170105T023718Z, and here\u0027s the entirety of /etc/hosts:\n\n    ::1             localhost\n    127.0.0.1       localhost localhost.local loghost deploy-cache\n\nAs far as I can tell, what you\u0027re describing only happens in the global zone as part of identity:node. But, I may be missing something?"},{"file":"src/vm/man/vmadm.1m.md","line":954,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps this part could be clarified. From my testing in COAL, updating `dns_domain` on a VM will only propagate to /etc/resolv.conf if both (a) maintain_resolvers\u003dtrue *and* (b) there is a change to VM.resolvers."},{"file":"src/vm/man/vmadm.1m.md","line":954,"reviewer":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"message":"Should we just fix that in the PI then? If your resolvers are correct but you need to fix dns_domain, you would have to set resolvers to some wrong value, then set resolvers back to the correct value while also setting dns_domain. That behavior itself feels broken to me."},{"file":"src/vm/man/vmadm.1m.md","line":954,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"You are welcome to open a separate ticket and CR to change that if you like. For here I was suggesting just clarifying in the docs. I don\u0027t have a strong opinion as we don\u0027t expose changing dns_domain via cloudapi currently."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":3,"sizeDeletions":-2},{"number":"2","revision":"7ad56e8480e6f12f1a4c128774020400da87c86d","parents":["6d232f498952cf009c7dbd046d99cf65acf6ef08"],"ref":"refs/changes/76/1576/2","uploader":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"createdOn":1529508358,"author":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529508405,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":3,"sizeDeletions":0}],"allReviewers":[{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},{"name":"Joyent Automation","username":"joyent-automation"}]}