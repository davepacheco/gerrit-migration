{"project":"joyent/sdc-docker","branch":"master","id":"Id75efa79ca8f887db9b3b38324494db2d6d1248f","number":"2176","subject":"DOCKER-1073 Allow docker rm on a container that failed to provision","owner":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"url":"https://cr.joyent.us/2176","commitMessage":"DOCKER-1073 Allow docker rm on a container that failed to provision\n","createdOn":1498864502,"lastUpdated":1500572309,"open":false,"status":"MERGED","comments":[{"timestamp":1498864502,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 1."},{"timestamp":1498864503,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 2a1f82b9882558dc228d20eab05a66cf2e650605\n    \n    add test case for getVmInState, uses \u0027rewire\u0027 to mock the common.getVm function\n    \n    commit 29d2e39ac83fc7dfe412e6bd354816c2e046c736\n    \n    add a getVmInState restify helper"},{"timestamp":1498864533,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1498864729,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 1:\n\nThis first patchset implements a check for container state, to make sure we don\u0027t try to work on a provisioning container when we don\u0027t want to."},{"timestamp":1499206017,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 2."},{"timestamp":1499206019,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 58d3ac50c3eed7051cc65a703074124b4ab951af\n    \n    Use utils.getDockerIdFromVmObj() call to get the docker id from a vm."},{"timestamp":1499206048,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1499206083,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1499206085,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 8a49ea05491afa14eae872931b05a654b0d5f8d3\n    \n    Use utils.getDockerIdFromVmObj() call to get the docker id from a vm.\n    \n    commit 0c5c8eed8aa82df7d9999b353517f729b5718906\n    \n    add test case for getVmInState, uses \u0027rewire\u0027 to mock the common.getVm function\n    \n    commit f88ef0ebc8a751aef14567d3bcbce0e4698f57d7\n    \n    add a getVmInState restify helper"},{"timestamp":1499206119,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"},{"timestamp":1499383941,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3: Code-Review+1\n\n(5 comments)"},{"timestamp":1499727130,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 3:\n\n(5 comments)"},{"timestamp":1499727218,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 4."},{"timestamp":1499727220,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit cb3f8370b7ad1b862fdfdfb9d15cb88880983c61\n    \n    address cr comments"},{"timestamp":1499727250,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1500505793,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1500505881,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4: -Code-Review -Integration-Approval\n\nlooks like the changes in lib/common.js didn\u0027t take?"},{"timestamp":1500507580,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 5."},{"timestamp":1500507582,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 75ef2e08b5592d548db6bd9d9fa3eee011550b04\n    \n    add lib/common.js changes back (I accidentally reverted it)"},{"timestamp":1500507611,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1500531863,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1\n\nA+"},{"timestamp":1500572309,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Todd Whiteman"}],"currentPatchSet":{"number":"5","revision":"d75efa79ca8f887db9b3b38324494db2d6d1248f","parents":["edb2de0e0d5cbe79b5d78340e39527a3ed8b35ee"],"ref":"refs/changes/76/2176/5","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1500507580,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1500507611,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1500531863,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1500531863,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1500572309,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/backends/sdc/containers.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/backends/sdc/utils.js","type":"MODIFIED","insertions":19,"deletions":-12},{"file":"lib/common.js","type":"MODIFIED","insertions":67,"deletions":-3},{"file":"lib/endpoints/commit.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/endpoints/containers.js","type":"MODIFIED","insertions":13,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/unit/get-vm-in-state.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":240,"sizeDeletions":-26},"patchSets":[{"number":"1","revision":"0dd8ca0e27d6b5fa5caaf878d85f0c16177c0fca","parents":["524e07aabc9e93e908327d87bda471fdd6698600"],"ref":"refs/changes/76/2176/1","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1498864502,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1498864533,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":63,"deletions":-3},{"file":"lib/endpoints/commit.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/endpoints/containers.js","type":"MODIFIED","insertions":13,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/unit/get-vm-in-state.test.js","type":"ADDED","insertions":182,"deletions":0}],"sizeInsertions":264,"sizeDeletions":-13},{"number":"2","revision":"e5162da12e75fc792dfbc863c5199f75f0f81d2e","parents":["524e07aabc9e93e908327d87bda471fdd6698600"],"ref":"refs/changes/76/2176/2","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1499206017,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1499206048,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/backends/sdc/containers.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/backends/sdc/utils.js","type":"MODIFIED","insertions":19,"deletions":-12},{"file":"lib/common.js","type":"MODIFIED","insertions":63,"deletions":-3},{"file":"lib/endpoints/commit.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/endpoints/containers.js","type":"MODIFIED","insertions":13,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/unit/get-vm-in-state.test.js","type":"ADDED","insertions":182,"deletions":0}],"sizeInsertions":284,"sizeDeletions":-26},{"number":"3","revision":"d9618730069940ee749d0ce3a4e909cb98afef70","parents":["edb2de0e0d5cbe79b5d78340e39527a3ed8b35ee"],"ref":"refs/changes/76/2176/3","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1499206083,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1499206048,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1499383941,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"comments":[{"file":"lib/backends/sdc/utils.js","line":29,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Isn\u0027t this a 128-bit (16 byte) instead of 256-bit? A VM uuid should have 128 bits. Maybe you meant 32 characters?\n\nAlso: docker\u0027s fully ok with these intermediate-length Ids?\n\nSome places the fallback used to be the short Id (12 characters)"},{"file":"lib/backends/sdc/utils.js","line":29,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Thanks, I meant 32 character.\n\nDocker is okay with these lengths, it seems to only check that it\u0027s gets a string back. When necessary (e.g. for `docker ps` output) the Docker cli will truncate down to 12 chars."},{"file":"lib/backends/sdc/utils.js","line":458,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"This is changing from the short version of the Id (12 characters) to the 32 character half-Id version. Is that ok?"},{"file":"lib/backends/sdc/utils.js","line":458,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Yes, should be okay. The docker inspect command (at least for the docker CLI) doesn\u0027t care what it gets back, as long as it\u0027s a string.\n\nIf we\u0027ve been returning 12 characters before (instead of the full 64) then return 32 should be fine now."},{"file":"lib/common.js","line":624,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Should it be an error to pass both a list of allowedStates and disallowedStates? It seems that if you pass allowedStates, disallowedStates doesn\u0027t make any sense unless you both allow and disallow the same parameter (in which case it will be disallowed)."},{"file":"lib/common.js","line":624,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Hah - that it does - if passing both I will now trigger an assert."},{"file":"lib/common.js","line":661,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"should this be an Error object? Or are we ok calling next() variously with an error object (when getVm fails) and a string (when state is disallowed)?"},{"file":"lib/common.js","line":661,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Good catch - it should be an error object."},{"file":"lib/common.js","line":667,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"same question Re: error vs string."},{"file":"lib/common.js","line":667,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Good catch - it should be an error object."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/backends/sdc/containers.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/backends/sdc/utils.js","type":"MODIFIED","insertions":19,"deletions":-12},{"file":"lib/common.js","type":"MODIFIED","insertions":63,"deletions":-3},{"file":"lib/endpoints/commit.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/endpoints/containers.js","type":"MODIFIED","insertions":13,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/unit/get-vm-in-state.test.js","type":"ADDED","insertions":182,"deletions":0}],"sizeInsertions":284,"sizeDeletions":-26},{"number":"4","revision":"ec55cecf47178219fcebc07a6c8962f6d2c67a3e","parents":["edb2de0e0d5cbe79b5d78340e39527a3ed8b35ee"],"ref":"refs/changes/76/2176/4","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1499727218,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1499727250,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/backends/sdc/containers.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/backends/sdc/utils.js","type":"MODIFIED","insertions":19,"deletions":-12},{"file":"lib/common.js","type":"MODIFIED","insertions":63,"deletions":-3},{"file":"lib/endpoints/commit.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/endpoints/containers.js","type":"MODIFIED","insertions":13,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/unit/get-vm-in-state.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":236,"sizeDeletions":-26},{"number":"5","revision":"d75efa79ca8f887db9b3b38324494db2d6d1248f","parents":["edb2de0e0d5cbe79b5d78340e39527a3ed8b35ee"],"ref":"refs/changes/76/2176/5","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1500507580,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1500507611,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1500531863,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1500531863,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1500572309,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/backends/sdc/containers.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/backends/sdc/utils.js","type":"MODIFIED","insertions":19,"deletions":-12},{"file":"lib/common.js","type":"MODIFIED","insertions":67,"deletions":-3},{"file":"lib/endpoints/commit.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/endpoints/containers.js","type":"MODIFIED","insertions":13,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/unit/get-vm-in-state.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":240,"sizeDeletions":-26}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}]}