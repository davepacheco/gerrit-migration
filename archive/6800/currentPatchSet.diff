From bbf7b896a7eabb496567d80c3c1c9d6ee1fb26ef Mon Sep 17 00:00:00 2001
From: Mike Gerdts <mike.gerdts@joyent.com>
Date: Fri, 16 Aug 2019 13:34:00 +0000
Subject: [PATCH] =?UTF-8?q?TRITON-1873=20TRITON-1692=20broke=20linux-prepa?=
 =?UTF-8?q?re-image=20for=20Alpine=20Linux=20Reviewed=20by:=20Pedro=20Pala?=
 =?UTF-8?q?z=C3=B3n=20Candel=20<pedro@joyent.com>=20Approved=20by:=20Pedro?=
 =?UTF-8?q?=20Palaz=C3=B3n=20Candel=20<pedro@joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 tools/prepare-image/linux-prepare-image | 11 ++++++++---
 1 file changed, 8 insertions(+), 3 deletions(-)

diff --git a/tools/prepare-image/linux-prepare-image b/tools/prepare-image/linux-prepare-image
index 6e355ad..b6ab08a 100755
--- a/tools/prepare-image/linux-prepare-image
+++ b/tools/prepare-image/linux-prepare-image
@@ -98,9 +98,14 @@ function cleanup_root() {
     history -c
     history -w || true
 
-    # Remove or set password for root.  If root-password-hash is not set, this
-    # is equivalent to "passwd -d root".
-    usermod -p "$(mdata_get_pi root-password-hash)" root
+    # Set or remove the root password. prepare-image:root-password-hash is only
+    # supported on those distros that support "usermod -p <hash> <user>".
+    local pw="$(mdata_get_pi root-password-hash)"
+    if [[ -n "$pw" ]]; then
+        usermod -p "$pw" root
+    else
+        passwd -d root
+    fi
 
     # Clean up history, ssh keys, etc.
     cleanup_homedir /root
-- 
2.21.0

