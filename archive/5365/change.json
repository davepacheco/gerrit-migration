{"project":"joyent/illumos-joyent","branch":"master","id":"Ib02dac51d4252de91533d0834f97c39491cc8108","number":"5365","subject":"OS-7513 vioif should do TX reclaim without NOTIFY_ON_EMPTY Reviewed by: Jason King \u003cjbk@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/5365","commitMessage":"OS-7513 vioif should do TX reclaim without NOTIFY_ON_EMPTY\nReviewed by: Jason King \u003cjbk@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1547509598,"lastUpdated":1547664052,"open":false,"status":"MERGED","comments":[{"timestamp":1547509598,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1547575283,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(8 comments)"},{"timestamp":1547579869,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1547583290,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1547585585,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1547586883,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1547586934,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1547587309,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)\n\nIn general, I\u0027m happy with this. One minor thing that you can deal with if you\u0027d like."},{"timestamp":1547587503,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3."},{"timestamp":1547587529,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1547587610,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1547588993,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1547590025,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4."},{"timestamp":1547591713,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1547592910,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1547657086,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5:\n\nTest notes are going in the Jira ticket."},{"timestamp":1547659716,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1547661807,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1547663996,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1547664052,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"7","revision":"b02dac51d4252de91533d0834f97c39491cc8108","parents":["c3b7cc297694b7a5bba7008717a886c820db0d42"],"ref":"refs/changes/65/5365/7","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1547663996,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547592910,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547659716,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547659716,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1547664052,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/io/vioif/vioif.c","type":"MODIFIED","insertions":169,"deletions":-33}],"sizeInsertions":169,"sizeDeletions":-33},"patchSets":[{"number":"1","revision":"3b1df6afd495fd84df4f289771a5769734828dbb","parents":["3261980fc834080481df409165235747db001b84"],"ref":"refs/changes/65/5365/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1547509598,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/vioif/vioif.c","line":908,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Previously this was only ever called fron a single thread. However, now we can have our tx handler calling this at the same time as our 200ms task. What ensures that they don\u0027t race during this operation?\n\nWhile it looks like that virtio_pull_chain() is safe to be called from multiple threads at the same time, it\u0027s not immediately clear to me that the rest is guaranteed to be safe, though it looks like because the vq_entry knows the index it\u0027s a part of, it might be?\n\nA comment explaining the safety would be appreciated."},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":908,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Yeah, virtio_pull_chain() and virtio_free_chain() provide the safety here.  Each index should have its own buffers.  I\u0027ll look into adding a comment."},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":943,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is there a reason that we\u0027re doing a read of sc_tx_corked outside of the lock? Or is this an attempt to try and make it less likely to have to do so? If so, then how do we make sure it gets noticed?"},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":943,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I wanted to avoid pounding on the tx_lock when calling it in the vioif_tx hotpath.  I\u0027ll shuffle this around to make it more explicit"},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":984,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I would probably add a comment that says that we know this can\u0027t be scheduled through the vioif_tx() entry point because this is being called from mc_stop(9E), so it really shouldn\u0027t be called."},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":984,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":1018,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I personally like to use an explicit flag for these cases; however, what you have here seems correct based on the interleavings that I can run through in my head right now."},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":1018,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I\u0027ll add a flag to indicate that a drain is in progress, but I\u0027m going to leave this logic as-is, if that\u0027s alright?"},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":1018,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"That\u0027s fine."},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":1050,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why is it safe to read this without holding any locks?"},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":1050,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Called from vioif_stop(), we don\u0027t expect further transmit activity.  With the periodic reclaim stopped, and the TX interrupt disabled, the logic is effectively single-threaded."},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":1056,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"VERIFY3* please?"},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":1056,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I can.  It didn\u0027t seem like a place where quickly seeing the offending value was as important."},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":1313,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Do we always want to reclaim on every tx? Should we only worry about it when we\u0027re below a threshold? I suspect we\u0027re calling this fairly often."},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":1313,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The Linux driver does, although their locking model makes it a bit cheaper.  My initial performance tests indicate that our TX performance (using simple iperf) nearly doubles with this change."},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":1350,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why do we only do this if we\u0027ve started empty?"},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":1350,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The periodic reclaim halts itself if there are no outstanding frames.  I want it started again once we\u0027ve transmitted anything."},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":1350,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027m having trouble convincing myself that all the locking and interleaving guarantees that we can\u0027t hit a case where we didn\u0027t start empty, get unscheduled for a while allowing the timer to come in (maybe we just get unscheduled right around that moment), and then we end up finally doing transmits and we\u0027re actually empty, but the timer isn\u0027t running because it found that we had cleaned everything up."},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":1350,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Yeah, agreed. I made this unconditional and it didn\u0027t seem to affect TX performance."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/vioif/vioif.c","type":"MODIFIED","insertions":191,"deletions":-33}],"sizeInsertions":191,"sizeDeletions":-33},{"number":"2","revision":"646a58b66ab3a0edeba7f74d95232170d514c91e","parents":["3261980fc834080481df409165235747db001b84"],"ref":"refs/changes/65/5365/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1547586934,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547587309,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"comments":[{"file":"usr/src/uts/common/io/vioif/vioif.c","line":1029,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Seeing the assignment after the untimeout makes me feel a little nervous. I\u0027d probably move it to before the untimeout call so that way we can make sure if we fail and restart it, we can see the new id. Though maybe that\u0027s just me being paranoid and this is fine."},{"file":"usr/src/uts/common/io/vioif/vioif.c","line":1029,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/vioif/vioif.c","type":"MODIFIED","insertions":178,"deletions":-35}],"sizeInsertions":178,"sizeDeletions":-35},{"number":"3","revision":"da686654e7596e14da0b2a3001fd099959db8e6d","parents":["3261980fc834080481df409165235747db001b84"],"ref":"refs/changes/65/5365/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1547587503,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547587610,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"comments":[{"file":"usr/src/uts/common/io/vioif/vioif.c","line":948,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Upon further thought, this seems a lot like premature optimization and I\u0027m going to rip it (the \u0027speculative\u0027 option) out."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/vioif/vioif.c","type":"MODIFIED","insertions":178,"deletions":-35}],"sizeInsertions":178,"sizeDeletions":-35},{"number":"4","revision":"d565ee22fe224c3d3c81f72c5246812bea1fbbd4","parents":["3261980fc834080481df409165235747db001b84"],"ref":"refs/changes/65/5365/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1547590025,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/vioif/vioif.c","type":"MODIFIED","insertions":169,"deletions":-33}],"sizeInsertions":169,"sizeDeletions":-33},{"number":"5","revision":"09202282b055abb60ae3fe355d41a9c362116764","parents":["99086611bf7b78c5525448f56c91a381693a1b5c"],"ref":"refs/changes/65/5365/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1547591713,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547659716,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547659716,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547592910,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/vioif/vioif.c","type":"MODIFIED","insertions":169,"deletions":-33}],"sizeInsertions":169,"sizeDeletions":-33},{"number":"6","revision":"1a39c105c56e913dd5c187e204b7c3edf00b3cd2","parents":["c3b7cc297694b7a5bba7008717a886c820db0d42"],"ref":"refs/changes/65/5365/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1547661807,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547659716,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547659716,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547592910,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/vioif/vioif.c","type":"MODIFIED","insertions":169,"deletions":-33}],"sizeInsertions":169,"sizeDeletions":-33},{"number":"7","revision":"b02dac51d4252de91533d0834f97c39491cc8108","parents":["c3b7cc297694b7a5bba7008717a886c820db0d42"],"ref":"refs/changes/65/5365/7","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1547663996,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547659716,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547659716,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1547664052,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547592910,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/io/vioif/vioif.c","type":"MODIFIED","insertions":169,"deletions":-33}],"sizeInsertions":169,"sizeDeletions":-33}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}