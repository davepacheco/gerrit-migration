From b42d166a9c1a68a6edb18c7baa0019ea7cd652cc Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Thu, 19 Jan 2017 11:29:02 +0100
Subject: [PATCH] AGENT-1053 cn-agent agent_install task should support setup
 of new instances Reviewed by: Trent Mick <trent.mick@joyent.com>

---
 lib/tasks/agent_install.js | 46 +++++++++++++++++++++++++++++---------
 1 file changed, 35 insertions(+), 11 deletions(-)

diff --git a/lib/tasks/agent_install.js b/lib/tasks/agent_install.js
index 546def9..7545160 100644
--- a/lib/tasks/agent_install.js
+++ b/lib/tasks/agent_install.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright 2017 Joyent, Inc.
  */
 
 /*
@@ -554,6 +554,10 @@ function start(callback) {
     // cn-agent-update service (self_update = true):
     var do_update;
 
+    // In case we're installing the first instance of an agent, instead
+    // of updating an existing one:
+    var is_update = true;
+
     // If the task has been created by cn-agent and sent to cn-agent-update,
     // it will contain both, package_file and package_name from the previous
     // iteration:
@@ -581,7 +585,8 @@ function start(callback) {
                 package_name = name;
                 return cb();
             });
-        }, function enableCNAgentUpdate(cb) {
+        },
+        function enableCNAgentUpdate(cb) {
             do_update = (package_name !== 'cn-agent') ||
                 ((package_name === 'cn-agent') && self_update);
 
@@ -604,7 +609,8 @@ function start(callback) {
                 }, 'enable-cn-agent');
                 return cb();
             });
-        }, function sendCNUpdateAgentTask(cb) {
+        },
+        function sendCNUpdateAgentTask(cb) {
             if (do_update) {
                 return cb();
             }
@@ -638,8 +644,19 @@ function start(callback) {
 
             // We need to give time to the cn-agent-update service to come up:
             return setTimeout(sendTask, 5 * 1000);
-        }, function backupAgent(cb) {
-            if (!do_update) {
+        },
+        function isUpdate(cb) {
+            var agent_dir = '/opt/smartdc/agents/lib/node_modules/' +
+                            package_name;
+            fs.stat(agent_dir, function (er, st) {
+                if (er && er.code === 'ENOENT') {
+                    is_update = false;
+                }
+                return cb();
+            });
+        },
+        function backupAgent(cb) {
+            if (!do_update || !is_update) {
                 return cb();
             }
             var prefix = '/opt/smartdc/agents/lib/node_modules/';
@@ -663,7 +680,8 @@ function start(callback) {
                 }, 'backup agent');
                 return cb();
             });
-        }, function installPackage(cb) {
+        },
+        function installPackage(cb) {
             if (!do_update) {
                 return cb();
             }
@@ -674,6 +692,9 @@ function start(callback) {
                     self.log.error({
                         err: err
                     }, 'failed to install agent package');
+                    if (!is_update) {
+                        return cb(err);
+                    }
                     self.log.info('restoring agent backup');
                     var prefix = '/opt/smartdc/agents/lib/node_modules/';
                     var cmd = '/usr/bin/cp';
@@ -697,13 +718,14 @@ function start(callback) {
                             stdout: stdout,
                             stderr: stderr
                         }, 'restore agent backup');
-                        return cb();
+                        return cb(err);
                     });
                 }
                 return cb();
             });
-        }, function cleanupBackup(cb) {
-            if (!do_update) {
+        },
+        function cleanupBackup(cb) {
+            if (!do_update || !is_update) {
                 return cb();
             }
             // All good, update done, let's cleanup the backup:
@@ -729,7 +751,8 @@ function start(callback) {
                 return cb();
             });
 
-        }, function sendAgentsToCNAPI(cb) {
+        },
+        function sendAgentsToCNAPI(cb) {
             if (!do_update) {
                 return cb();
             }
@@ -744,7 +767,8 @@ function start(callback) {
                 }
                 return cb();
             });
-        }, function sendCNAgentTask(cb) {
+        },
+        function sendCNAgentTask(cb) {
             if (!do_update ||Â package_name !== 'cn-agent') {
                 return cb();
             }
-- 
2.21.0

