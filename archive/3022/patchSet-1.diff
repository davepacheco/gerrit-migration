From b5c2028863f864d6d576baf090af74e7fca63f3a Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Thu, 30 Nov 2017 18:19:23 -0800
Subject: [PATCH] MANTA-3508 invalid user added to "operators" group, mahi
 sadness ensues

---
 v1/lib/auth_cache.js | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/v1/lib/auth_cache.js b/v1/lib/auth_cache.js
index 0db302a..7231340 100644
--- a/v1/lib/auth_cache.js
+++ b/v1/lib/auth_cache.js
@@ -650,6 +650,14 @@ function addGroupMember(self, userdn, groupdn, cb) {
                                   groupdn.indexOf(','));
     var userUuid = userdn.substring(userdn.indexOf('=') + 1,
                                     userdn.indexOf(','));
+
+    if (userUuid === '') {
+        log.warn('ignoring attempt to add invalid user DN "%s" to group %s',
+            userdn, group);
+        cb();
+        return;
+    }
+
     log.info('adding user %s to group %s', userUuid, group);
     // get the login from uuid
     var loginKey = sprintf('/uuid/%s', userUuid);
@@ -670,7 +678,7 @@ function addGroupMember(self, userdn, groupdn, cb) {
                 return;
             }
             log.info({entry: payload}, 'got user entry from redis');
-            payload = JSON.parse(payload);
+            payload = JSON.parse(payload) || {};
             if (!payload.groups) {
                 payload.groups = {};
             }
-- 
2.21.0

