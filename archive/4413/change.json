{"project":"joyent/illumos-joyent","branch":"master","id":"I9d61057f7fe1fe7aa75aaff08c48fe66778261c6","number":"4413","subject":"OS-7034 ctxops should use stack ordering for save/restore Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/4413","commitMessage":"OS-7034 ctxops should use stack ordering for save/restore\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1529689641,"lastUpdated":1530026709,"open":false,"status":"MERGED","comments":[{"timestamp":1529689641,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1529689776,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\nThis ended up being more verbose of a change than I had hoped, but I tried to avoid \"cute\" tricks with the linked lists which would have cut down on the delta.\n\nUsing a list_t was unattractive here, since it would require changes to the asm which checks T_CTX as an optimization."},{"timestamp":1529698599,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1529698971,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1529700727,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1529702132,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\nWho knew usr/src/cmd/mdb/common/modules/genunix/ctxop.c existed - not me. But it needs fixing now."},{"timestamp":1529719805,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3."},{"timestamp":1529720091,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\nUpdated the ctxop walker so it works on the new code and old"},{"timestamp":1529720289,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\nTo test the walker, I tried it live via mdb -k on a system running the wad, plus old cores which featured the existing ctxop logic."},{"timestamp":1529743271,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)"},{"timestamp":1529929848,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1529938465,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4."},{"timestamp":1529938552,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1529938565,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1529939760,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1529948286,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1529948361,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5:\n\nTesting notes added to the ticket."},{"timestamp":1529953144,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1529953265,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5: Integration-Approval-1\n\nI\u0027m delaying integration until I address some testing concerns raised by Robert."},{"timestamp":1529972057,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5: -Integration-Approval"},{"timestamp":1530025756,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1530026588,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1530026644,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 7:\n\nIncluding jlevon\u0027s +1, since all that changed was a fix for his nit."},{"timestamp":1530026709,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"7","revision":"9d61057f7fe1fe7aa75aaff08c48fe66778261c6","parents":["8ab68c666d789a06197b083f2706504d44c84159"],"ref":"refs/changes/13/4413/7","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1530026588,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529939760,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529948286,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1529953144,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1530026709,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/ctxop.c","type":"MODIFIED","insertions":60,"deletions":-19},{"file":"usr/src/cmd/mdb/common/modules/genunix/ctxop.h","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/disp/thread.c","type":"MODIFIED","insertions":136,"deletions":-48},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/i86pc/ml/offsets.in","type":"MODIFIED","insertions":0,"deletions":-3}],"sizeInsertions":199,"sizeDeletions":-74},"patchSets":[{"number":"1","revision":"255d3d084979b0c0b2370de58aa26b2a4239db5e","parents":["acbebb967fadb0cc8c4d4a56e8751cd60c9fb1b5"],"ref":"refs/changes/13/4413/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1529689641,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/disp/thread.c","line":1064,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can you expand the comment just explaining the cyclical nature of the loops. At first glance the assigning of ctx-\u003enext/prev to itself was confusing."},{"file":"usr/src/uts/common/disp/thread.c","line":1064,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Sure, I\u0027ll add another \u0027graph about it."},{"file":"usr/src/uts/common/disp/thread.c","line":1252,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should exitctx and freectx do reverse traversal?"},{"file":"usr/src/uts/common/disp/thread.c","line":1252,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I don\u0027t think so?  Say that something like the FPU ops needed an exit handler too.  The \"upstack\" logic (like bhyve) would probably need to occur before the underlying FPU was finalized or freed."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/disp/thread.c","type":"MODIFIED","insertions":130,"deletions":-48},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/i86pc/ml/offsets.in","type":"MODIFIED","insertions":0,"deletions":-3}],"sizeInsertions":133,"sizeDeletions":-53},{"number":"2","revision":"6e65d05c785c303ac12a742ea7975a66d28f2d86","parents":["acbebb967fadb0cc8c4d4a56e8751cd60c9fb1b5"],"ref":"refs/changes/13/4413/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1529700727,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/disp/thread.c","type":"MODIFIED","insertions":136,"deletions":-48},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/i86pc/ml/offsets.in","type":"MODIFIED","insertions":0,"deletions":-3}],"sizeInsertions":139,"sizeDeletions":-53},{"number":"3","revision":"87dcd3ff22de358a3a28d7a2c7cc984823583502","parents":["acbebb967fadb0cc8c4d4a56e8751cd60c9fb1b5"],"ref":"refs/changes/13/4413/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1529719805,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529929848,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529743271,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"comments":[{"file":"usr/src/cmd/mdb/common/modules/genunix/ctxop.c","line":61,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"\"further\""},{"file":"usr/src/cmd/mdb/common/modules/genunix/ctxop.c","line":61,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/ctxop.c","type":"MODIFIED","insertions":60,"deletions":-19},{"file":"usr/src/cmd/mdb/common/modules/genunix/ctxop.h","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/disp/thread.c","type":"MODIFIED","insertions":136,"deletions":-48},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/i86pc/ml/offsets.in","type":"MODIFIED","insertions":0,"deletions":-3}],"sizeInsertions":199,"sizeDeletions":-74},{"number":"4","revision":"cc3b033f6bf236282f6e7421d08ae777e270b6ec","parents":["acbebb967fadb0cc8c4d4a56e8751cd60c9fb1b5"],"ref":"refs/changes/13/4413/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1529938465,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/ctxop.c","type":"MODIFIED","insertions":60,"deletions":-19},{"file":"usr/src/cmd/mdb/common/modules/genunix/ctxop.h","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/disp/thread.c","type":"MODIFIED","insertions":136,"deletions":-48},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/i86pc/ml/offsets.in","type":"MODIFIED","insertions":0,"deletions":-3}],"sizeInsertions":199,"sizeDeletions":-74},{"number":"5","revision":"86eb8bb5e3ec32167034470d14067a9c2cf6f3d6","parents":["ce7b55c99a83499aa24478410ef53728583326de"],"ref":"refs/changes/13/4413/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1529938565,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529948286,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529939760,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1529953144,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/ctxop.c","type":"MODIFIED","insertions":60,"deletions":-19},{"file":"usr/src/cmd/mdb/common/modules/genunix/ctxop.h","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/disp/thread.c","type":"MODIFIED","insertions":136,"deletions":-48},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/i86pc/ml/offsets.in","type":"MODIFIED","insertions":0,"deletions":-3}],"sizeInsertions":199,"sizeDeletions":-74},{"number":"6","revision":"7e682f29d581d7a6b63bb77bf894df2d78acd9c2","parents":["8ab68c666d789a06197b083f2706504d44c84159"],"ref":"refs/changes/13/4413/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1530025756,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529948286,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529939760,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1529953144,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/ctxop.c","type":"MODIFIED","insertions":60,"deletions":-19},{"file":"usr/src/cmd/mdb/common/modules/genunix/ctxop.h","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/disp/thread.c","type":"MODIFIED","insertions":136,"deletions":-48},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/i86pc/ml/offsets.in","type":"MODIFIED","insertions":0,"deletions":-3}],"sizeInsertions":199,"sizeDeletions":-74},{"number":"7","revision":"9d61057f7fe1fe7aa75aaff08c48fe66778261c6","parents":["8ab68c666d789a06197b083f2706504d44c84159"],"ref":"refs/changes/13/4413/7","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1530026588,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529948286,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529939760,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1529953144,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1530026709,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/ctxop.c","type":"MODIFIED","insertions":60,"deletions":-19},{"file":"usr/src/cmd/mdb/common/modules/genunix/ctxop.h","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/disp/thread.c","type":"MODIFIED","insertions":136,"deletions":-48},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/i86pc/ml/offsets.in","type":"MODIFIED","insertions":0,"deletions":-3}],"sizeInsertions":199,"sizeDeletions":-74}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}