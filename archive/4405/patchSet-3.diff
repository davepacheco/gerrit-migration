From 48688b032beba8f12104ef65b0b15d1be5023be9 Mon Sep 17 00:00:00 2001
From: Mike Gerdts <mike.gerdts@joyent.com>
Date: Thu, 21 Jun 2018 20:34:33 +0000
Subject: [PATCH] TRITON-536 prepare-image script lacks cloud-init cleanup

---
 tools/prepare-image/linux-prepare-image | 30 +++++++++++++++++++++----
 1 file changed, 26 insertions(+), 4 deletions(-)

diff --git a/tools/prepare-image/linux-prepare-image b/tools/prepare-image/linux-prepare-image
index 5d20076..eb3f06a 100755
--- a/tools/prepare-image/linux-prepare-image
+++ b/tools/prepare-image/linux-prepare-image
@@ -6,7 +6,7 @@
 #
 
 #
-# Copyright (c) 2015, Joyent, Inc.
+# Copyright (c) 2018, Joyent, Inc.
 #
 
 #
@@ -135,6 +135,26 @@ function cleanup_network_devices() {
     fi
 }
 
+function cleanup_cloud_init {
+    if [[ ! -x /usr/bin/cloud-init ]] ; then
+        return
+    fi
+    # Old versions of cloud-init did not have "cloud-init clean" so this may
+    # spit a bit of noise.
+    if ! cloud-init clean -ls; then
+        rm -f /var/log/cloud-init/instance
+        rm -rf /var/log/cloud-init/instances/*
+    fi
+    rm -f /var/log/cloud-init*
+
+    # Only clobber /etc/network/interfaces if cloud-init created it.
+    local comment="Automatically generated by cloud-init DataSourceSmartOS"
+    local eni=/etc/network/interfaces
+    if [[ -f $eni ]] && grep "$comment" "$eni" >/dev/null 2>&1; then
+        rm -f /etc/network/interfaces
+    fi
+}
+
 function prepare_centos() {
     # Cleaning up package cache.
     yum clean all 2>&1 >/dev/null
@@ -142,7 +162,7 @@ function prepare_centos() {
     # TODO: Remove this? Doesn't seem necessary
     # Make sure locale is set to prevent error when system is SSH'ed into.
     localedef --no-archive -i en_US -f UTF-8 en_US.UTF-8
-    
+
     # Remove hostname from /etc/sysconfig/network
     sed -i '/^HOSTNAME=/d' /etc/sysconfig/network
 }
@@ -160,9 +180,10 @@ function prepare_ubuntu() {
 # Makes sure that /lib/smartdc et al are sane.
 function prepare_lib_smartdc() {
     if [[ -d /lib/smartdc ]] ; then
-        # Per IMAGE-446 we need to remove the firstboot guard file for a new image.
+        # Per IMAGE-446 we need to remove the firstboot guard file for a new
+        # image.
         rm -f /lib/smartdc/.firstboot-complete-do-not-delete
-        
+
         # Note: Not sure this is currently necessary.
         chown -R root:root /lib/smartdc
     fi
@@ -211,6 +232,7 @@ cleanup_root
 cleanup_metadata
 cleanup_hostname
 cleanup_network_devices
+cleanup_cloud_init
 
 history -c
 history -w || true
-- 
2.21.0

