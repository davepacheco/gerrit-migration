From b159b9b5cd890f22a6af23dd73dbf3737c005df6 Mon Sep 17 00:00:00 2001
From: Mike Gerdts <mike.gerdts@joyent.com>
Date: Thu, 21 Jun 2018 20:34:33 +0000
Subject: [PATCH] TRITON-536 prepare-image script lacks cloud-init cleanup

---
 tools/prepare-image/linux-prepare-image | 26 +++++++++++++++++++++----
 1 file changed, 22 insertions(+), 4 deletions(-)

diff --git a/tools/prepare-image/linux-prepare-image b/tools/prepare-image/linux-prepare-image
index 5d20076..ca474aa 100755
--- a/tools/prepare-image/linux-prepare-image
+++ b/tools/prepare-image/linux-prepare-image
@@ -6,7 +6,7 @@
 #
 
 #
-# Copyright (c) 2015, Joyent, Inc.
+# Copyright (c) 2018, Joyent, Inc.
 #
 
 #
@@ -126,6 +126,10 @@ function cleanup_network_devices() {
         find /etc/sysconfig/network-scripts -name "ifcfg-eth*" | xargs rm -f
     fi
 
+    if [[ -f /etc/network/interfaces ]]; then
+        rm -f /etc/network/interfaces
+    fi
+
     if [[ -d /var/lib/dhcp3 ]] ; then
         find /var/lib/dhcp3 -type f -name "*.leases" | xargs rm -f
     elif [[ -d /var/lib/dhcp ]] ; then
@@ -135,6 +139,18 @@ function cleanup_network_devices() {
     fi
 }
 
+function cleanup_cloud_init {
+    if [[ ! -x /usr/bin/cloud-init ]] ; then
+        return
+    fi
+    # Old versions of cloud-init did not have "cloud-init clean" so this may
+    # spit a bit of noise.
+    cloud-init clean -ls || true
+
+    rm -rf /var/lib/cloud/*
+    rm -f /var/log/cloud-init*
+}
+
 function prepare_centos() {
     # Cleaning up package cache.
     yum clean all 2>&1 >/dev/null
@@ -142,7 +158,7 @@ function prepare_centos() {
     # TODO: Remove this? Doesn't seem necessary
     # Make sure locale is set to prevent error when system is SSH'ed into.
     localedef --no-archive -i en_US -f UTF-8 en_US.UTF-8
-    
+
     # Remove hostname from /etc/sysconfig/network
     sed -i '/^HOSTNAME=/d' /etc/sysconfig/network
 }
@@ -160,9 +176,10 @@ function prepare_ubuntu() {
 # Makes sure that /lib/smartdc et al are sane.
 function prepare_lib_smartdc() {
     if [[ -d /lib/smartdc ]] ; then
-        # Per IMAGE-446 we need to remove the firstboot guard file for a new image.
+        # Per IMAGE-446 we need to remove the firstboot guard file for a new
+        # image.
         rm -f /lib/smartdc/.firstboot-complete-do-not-delete
-        
+
         # Note: Not sure this is currently necessary.
         chown -R root:root /lib/smartdc
     fi
@@ -211,6 +228,7 @@ cleanup_root
 cleanup_metadata
 cleanup_hostname
 cleanup_network_devices
+cleanup_cloud_init
 
 history -c
 history -w || true
-- 
2.21.0

