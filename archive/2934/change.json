{"project":"joyent/illumos-joyent","branch":"master","id":"I758ae53701bec2fed98db901e5af051af2ac0c6d","number":"2934","subject":"OS-6436 lx_ptrace_detach() causes panic Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/2934","commitMessage":"OS-6436 lx_ptrace_detach() causes panic\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1510331821,"lastUpdated":1512416769,"open":false,"status":"MERGED","comments":[{"timestamp":1510331821,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1512065926,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1512072799,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nI think that we would be ok if the process was stopping, but not necessarily if it was exiting, so I think you\u0027re right, it would be best to cache the lock as is done elsewhere."},{"timestamp":1512072826,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1512232448,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Code-Review+1\n\n(2 comments)"},{"timestamp":1512394708,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1512394730,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\nI made the suggested changes."},{"timestamp":1512401478,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1512404147,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\nFor testing I\u0027ve run a bunch of things with strace (which obviously won\u0027t hit this code path but strace still works fine). I tried to reproduce the panic by have a process continuously make a syscall while another process continuously ptrace attached/detached to the first process, but I was never able to hit this either. We\u0027ve only seen this panic once during the Cassandra stress tests when I asked them to run strace there. However, I think that since the fix is modeled on the existing handling for exiting the tracer, the fix should be fine."},{"timestamp":1512415987,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1512416676,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1512416738,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1512416769,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"5","revision":"758ae53701bec2fed98db901e5af051af2ac0c6d","parents":["0d5719a2f0864296378787c96d12da889970c4e4"],"ref":"refs/changes/34/2934/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1512416738,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512401478,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1512415987,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1512416769,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","type":"MODIFIED","insertions":40,"deletions":-11}],"sizeInsertions":40,"sizeDeletions":-11},"patchSets":[{"number":"1","revision":"0a93f185f937f917b450f424e34e2ca7302eb049","parents":["b164e87ae56fcf64dbfbba90ada71d50466bece5"],"ref":"refs/changes/34/2934/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1510331821,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","line":2512,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Is there any risk that the process will be cleaned up while we\u0027re waiting here? (In other places, we cache the p_lock address in case the process is freed in the mean time)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","type":"MODIFIED","insertions":37,"deletions":-10}],"sizeInsertions":37,"sizeDeletions":-10},{"number":"2","revision":"71ed03f8793a49d91d3983836003586a724a6f2e","parents":["319ffd7b00d357d8bcc5a3ab337a6a870bf0faa6"],"ref":"refs/changes/34/2934/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1512072826,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512232448,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","line":2409,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"style nit: This definition could be constrained to the TRACEE_BUSY block below since the race is only important there."},{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","line":2513,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: The return value should be (void)-ed out, or alternatively we could choose to handle interruption."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","type":"MODIFIED","insertions":39,"deletions":-11}],"sizeInsertions":39,"sizeDeletions":-11},{"number":"3","revision":"cf05db12e978b3d52315e3a9c4fb867ae67f3865","parents":["3f77d0944006d98d130349a35d3bf65399df67b6"],"ref":"refs/changes/34/2934/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1512394708,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512401478,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1512415987,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","type":"MODIFIED","insertions":40,"deletions":-11}],"sizeInsertions":40,"sizeDeletions":-11},{"number":"4","revision":"e04c2239a0f9ce6423e189b511bf5e12fb0c047b","parents":["0d5719a2f0864296378787c96d12da889970c4e4"],"ref":"refs/changes/34/2934/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1512416676,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512401478,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1512415987,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","type":"MODIFIED","insertions":40,"deletions":-11}],"sizeInsertions":40,"sizeDeletions":-11},{"number":"5","revision":"758ae53701bec2fed98db901e5af051af2ac0c6d","parents":["0d5719a2f0864296378787c96d12da889970c4e4"],"ref":"refs/changes/34/2934/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1512416738,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1512416769,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512401478,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1512415987,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","type":"MODIFIED","insertions":40,"deletions":-11}],"sizeInsertions":40,"sizeDeletions":-11}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}