{"project":"joyent/sdcadm","branch":"master","id":"Ic68c437f3135a00570d11d24853ec53a2e5234c6","number":"21","subject":"TOOLS-1459 spring cleaning in sdcadm Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e","owner":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"url":"https://cr.joyent.us/21","commitMessage":"TOOLS-1459 spring cleaning in sdcadm\nReviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\n","createdOn":1467156605,"lastUpdated":1468029962,"open":false,"status":"MERGED","comments":[{"timestamp":1467156605,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 1."},{"timestamp":1467157326,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 2."},{"timestamp":1467907856,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1467914163,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\nblah blah, testing..."},{"timestamp":1467914219,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 2:\n\nblah blah received! ;)"},{"timestamp":1467928006,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 3."},{"timestamp":1467930332,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(5 comments)\n\nOkay... I stopped reviewing. There is a lot of stuff in patch set 3 that no longer feels like just spring cleaning."},{"timestamp":1467930645,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3:\n\n(1 comment)\n\nHey Trent,\n\nSo I think your review comments are actually on changes the happened between my original patch and my subsequent rebasing onto work that happened while I was looking away.  If you look at diff from \"Base\", you can see that the actual change I\u0027m making doesn\u0027t include those things -- they\u0027re already there."},{"timestamp":1467931107,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3:\n\nI think there might also have been some confusion induced by needing to update the \"master\" ref in gerrit, because there had been some pushes to Github in the meantime which induces split brain."},{"timestamp":1467933551,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\nHrm, okay. That rebasing thing is unfortunate. Makes it hard (impossible in general?) to be able to reliably look at \"the change since last review\".\n\nThis CR is already too big for me to review the whole thing again to see the possible one or two small updates you made."},{"timestamp":1467937374,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3:\n\n\u003e Uploaded patch set 3.\n\nNB: This was a rebase against master."},{"timestamp":1468029945,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3: Code-Review+2"},{"timestamp":1468029962,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Joshua M. Clulow"}],"currentPatchSet":{"number":"3","revision":"c68c437f3135a00570d11d24853ec53a2e5234c6","parents":["b786ee8926076728dbbd01a9ffdaba32776f947e"],"ref":"refs/changes/21/21/3","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1467928006,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"2","grantedOn":1468029945,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1468029962,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"comments":[{"file":"lib/cli/do_update_other.js","line":551,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Feels like this isUsbKeyMountd work would fit better in a separate ticket/commit."},{"file":"lib/cli/do_update_other.js","line":551,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Pedro snuck a few tickets in, so I had to rebase.  This is technically not in my change, but _is_ a difference from the last patchset I submitted.  If you look at the overall diff from start to finish it\u0027s not new code in this change."},{"file":"lib/history.js","line":33,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"/* style comments\n\ncall \"replacer\" something saying what it does. Bunyan calls its similar function \"safeCycles\".\n\n(curt because Gerrit lost my longer comment)"},{"file":"lib/history.js","line":41,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This is odd. This just makes all values beyond 29 keys (at any depth), be \"[Unknown]\". E.g.:\n\n```\no \u003d {sub: {}};\nfor (i \u003d 0; i \u003c 40; i++) {\n    o.sub[i.toString()] \u003d i;\n}\nconsole.log(JSON.stringify(o, replacer()));\nconsole.log(JSON.stringify(o));\n```\n\nResults in:\n\n```\n$ node repla.js\n{\"sub\":{\"0\":0,\"1\":1,\"2\":2,\"3\":3,\"4\":4,\"5\":5,\"6\":6,\"7\":7,\"8\":8,\"9\":9,\"10\":10,\"11\":11,\"12\":12,\"13\":13,\"14\":14,\"15\":15,\"16\":16,\"17\":17,\"18\":18,\"19\":19,\"20\":20,\"21\":21,\"22\":22,\"23\":23,\"24\":24,\"25\":25,\"26\":26,\"27\":\"[Unknown]\",\"28\":\"[Unknown]\",\"29\":\"[Unknown]\",\"30\":\"[Unknown]\",\"31\":\"[Unknown]\",\"32\":\"[Unknown]\",\"33\":\"[Unknown]\",\"34\":\"[Unknown]\",\"35\":\"[Unknown]\",\"36\":\"[Unknown]\",\"37\":\"[Unknown]\",\"38\":\"[Unknown]\",\"39\":\"[Unknown]\"}}\n{\"sub\":{\"0\":0,\"1\":1,\"2\":2,\"3\":3,\"4\":4,\"5\":5,\"6\":6,\"7\":7,\"8\":8,\"9\":9,\"10\":10,\"11\":11,\"12\":12,\"13\":13,\"14\":14,\"15\":15,\"16\":16,\"17\":17,\"18\":18,\"19\":19,\"20\":20,\"21\":21,\"22\":22,\"23\":23,\"24\":24,\"25\":25,\"26\":26,\"27\":27,\"28\":28,\"29\":29,\"30\":30,\"31\":31,\"32\":32,\"33\":33,\"34\":34,\"35\":35,\"36\":36,\"37\":37,\"38\":38,\"39\":39}}\n```"},{"file":"lib/history.js","line":45,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think you want to exclude non-object values here. Else you get this (after removing the \"[Unknown]\" handling):\n\n```\n$ node repla.js\n{\"sub\":{\"0\":0,\"1\":1,\"2\":2,\"3\":3,\"4\":4,\"5\":5,\"6\":6,\"7\":7,\"8\":8,\"9\":9,\"10\":\"[Circular]\",\"11\":\"[Circular]\",\"12\":\"[Circular]\",\"13\":\"[Circular]\",\"14\":\"[Circular]\",\"15\":\"[Circular]\",\"16\":\"[Circular]\",\"17\":\"[Circular]\",\"18\":\"[Circular]\",\"19\":\"[Circular]\",\"20\":\"[Circular]\",\"21\":\"[Circular]\",\"22\":\"[Circular]\",\"23\":\"[Circular]\",\"24\":\"[Circular]\",\"25\":\"[Circular]\",\"26\":\"[Circular]\",\"27\":\"[Circular]\",\"28\":\"[Circular]\",\"29\":\"[Circular]\",\"30\":\"[Circular]\",\"31\":\"[Circular]\",\"32\":\"[Circular]\",\"33\":\"[Circular]\",\"34\":\"[Circular]\",\"35\":\"[Circular]\",\"36\":\"[Circular]\",\"37\":\"[Circular]\",\"38\":\"[Circular]\",\"39\":\"[Circular]\"}}\n{\"sub\":{\"0\":0,\"1\":1,\"2\":2,\"3\":3,\"4\":4,\"5\":5,\"6\":6,\"7\":7,\"8\":8,\"9\":9,\"10\":0,\"11\":1,\"12\":2,\"13\":3,\"14\":4,\"15\":5,\"16\":6,\"17\":7,\"18\":8,\"19\":9,\"20\":0,\"21\":1,\"22\":2,\"23\":3,\"24\":4,\"25\":5,\"26\":6,\"27\":7,\"28\":8,\"29\":9,\"30\":0,\"31\":1,\"32\":2,\"33\":3,\"34\":4,\"35\":5,\"36\":6,\"37\":7,\"38\":8,\"39\":9}}\n```\n\nThe bunyan \u0027safeCycles\u0027 does this:\n\n```\n        if (!value || typeof (value) !\u003d\u003d \u0027object\u0027) {\n            return value;\n        }\n```\n\nSo, the full suggested replacement is:\n\n```\nfunction replacer() {\n    var i \u003d 0;\n    var objs \u003d [];\n    return function (key, value) {\n        if (!value || typeof (value) !\u003d\u003d \u0027object\u0027) {\n            return value;\n        }\n        if (objs.indexOf(value) !\u003d\u003d -1) {\n            return \u0027[Circular]\u0027;\n        } else {\n            objs.push(value);\n        }\n        return value;\n    };\n}\n```"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/channel.js","type":"MODIFIED","insertions":3,"deletions":-16},{"file":"lib/cli/do_avail.js","type":"MODIFIED","insertions":0,"deletions":-5},{"file":"lib/cli/do_cns.js","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":3,"deletions":-24},{"file":"lib/cli/index.js","type":"MODIFIED","insertions":3,"deletions":-10},{"file":"lib/common.js","type":"MODIFIED","insertions":3,"deletions":-15},{"file":"lib/dc-maint.js","type":"MODIFIED","insertions":3,"deletions":-15},{"file":"lib/default-fabric.js","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":-22},{"file":"lib/history.js","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"lib/logging.js","type":"MODIFIED","insertions":1,"deletions":-90},{"file":"lib/platform.js","type":"MODIFIED","insertions":4,"deletions":-8},{"file":"lib/post-setup/cloudapi.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/post-setup/common-external-nics.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/post-setup/dev-headnode-prov.js","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"lib/post-setup/dev-sample-data.js","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"lib/post-setup/fabrics.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/post-setup/ha-manatee.js","type":"MODIFIED","insertions":0,"deletions":-4},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":0,"deletions":-3},{"file":"lib/post-setup/underlay-nics.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/procedures/create-service-instance-v1.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/procedures/download-images.js","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":1,"deletions":-13},{"file":"lib/procedures/update-agent-v1.js","type":"MODIFIED","insertions":2,"deletions":-12},{"file":"lib/procedures/update-binder-v2.js","type":"MODIFIED","insertions":5,"deletions":-12},{"file":"lib/procedures/update-dockerlogger.js","type":"MODIFIED","insertions":4,"deletions":-9},{"file":"lib/procedures/update-mahi-v2.js","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":1,"deletions":-36},{"file":"lib/procedures/update-moray-v2.js","type":"MODIFIED","insertions":2,"deletions":-12},{"file":"lib/procedures/update-single-headnode-imgapi.js","type":"MODIFIED","insertions":3,"deletions":-10},{"file":"lib/procedures/update-single-hn-sapi-v1.js","type":"MODIFIED","insertions":2,"deletions":-11},{"file":"lib/procedures/update-stateless-services-v1.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/procedures/update-ufds-service-v1.js","type":"MODIFIED","insertions":2,"deletions":-11},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":4,"deletions":-6},{"file":"lib/svcadm.js","type":"MODIFIED","insertions":4,"deletions":-10},{"file":"lib/ur.js","type":"MODIFIED","insertions":0,"deletions":-4},{"file":"lib/vmadm.js","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":65,"sizeDeletions":-402},"patchSets":[{"number":"1","revision":"b35352821a2f30d18fa298f3474a65ec5cc881fa","parents":["dc7d9fa4a47b95c4bc0bdf18eb6d3e6481e45edc"],"ref":"refs/changes/21/21/1","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1467156605,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/channel.js","type":"MODIFIED","insertions":3,"deletions":-16},{"file":"lib/cli/do_avail.js","type":"MODIFIED","insertions":0,"deletions":-5},{"file":"lib/cli/do_cns.js","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":3,"deletions":-24},{"file":"lib/cli/index.js","type":"MODIFIED","insertions":3,"deletions":-10},{"file":"lib/common.js","type":"MODIFIED","insertions":3,"deletions":-15},{"file":"lib/dc-maint.js","type":"MODIFIED","insertions":3,"deletions":-15},{"file":"lib/default-fabric.js","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":-22},{"file":"lib/history.js","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"lib/logging.js","type":"MODIFIED","insertions":1,"deletions":-90},{"file":"lib/platform.js","type":"MODIFIED","insertions":4,"deletions":-8},{"file":"lib/post-setup/cloudapi.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/post-setup/common-external-nics.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/post-setup/dev-headnode-prov.js","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"lib/post-setup/dev-sample-data.js","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"lib/post-setup/fabrics.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/post-setup/ha-manatee.js","type":"MODIFIED","insertions":0,"deletions":-64},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":0,"deletions":-3},{"file":"lib/post-setup/underlay-nics.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/procedures/create-service-instance-v1.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/procedures/download-images.js","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":1,"deletions":-14},{"file":"lib/procedures/update-agent-v1.js","type":"MODIFIED","insertions":2,"deletions":-12},{"file":"lib/procedures/update-binder-v2.js","type":"MODIFIED","insertions":5,"deletions":-12},{"file":"lib/procedures/update-dockerlogger.js","type":"MODIFIED","insertions":4,"deletions":-9},{"file":"lib/procedures/update-mahi-v2.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":1,"deletions":-122},{"file":"lib/procedures/update-moray-v2.js","type":"MODIFIED","insertions":2,"deletions":-12},{"file":"lib/procedures/update-single-headnode-imgapi.js","type":"MODIFIED","insertions":4,"deletions":-10},{"file":"lib/procedures/update-single-hn-sapi-v1.js","type":"MODIFIED","insertions":2,"deletions":-11},{"file":"lib/procedures/update-stateless-services-v1.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/procedures/update-ufds-service-v1.js","type":"MODIFIED","insertions":2,"deletions":-11},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":4,"deletions":-6},{"file":"lib/svcadm.js","type":"MODIFIED","insertions":4,"deletions":-10},{"file":"lib/ur.js","type":"MODIFIED","insertions":0,"deletions":-4},{"file":"lib/vmadm.js","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":63,"sizeDeletions":-543},{"number":"2","revision":"b2f910609053d41842746223a94e46f8a56386d4","parents":["dc7d9fa4a47b95c4bc0bdf18eb6d3e6481e45edc"],"ref":"refs/changes/21/21/2","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1467157326,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1467907856,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"lib/procedures/create-service-instance-v1.js","line":59,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"what was the issue here?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/channel.js","type":"MODIFIED","insertions":3,"deletions":-16},{"file":"lib/cli/do_avail.js","type":"MODIFIED","insertions":0,"deletions":-5},{"file":"lib/cli/do_cns.js","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":3,"deletions":-24},{"file":"lib/cli/index.js","type":"MODIFIED","insertions":3,"deletions":-10},{"file":"lib/common.js","type":"MODIFIED","insertions":3,"deletions":-15},{"file":"lib/dc-maint.js","type":"MODIFIED","insertions":3,"deletions":-15},{"file":"lib/default-fabric.js","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":-22},{"file":"lib/history.js","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"lib/logging.js","type":"MODIFIED","insertions":1,"deletions":-90},{"file":"lib/platform.js","type":"MODIFIED","insertions":4,"deletions":-8},{"file":"lib/post-setup/cloudapi.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/post-setup/common-external-nics.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/post-setup/dev-headnode-prov.js","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"lib/post-setup/dev-sample-data.js","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"lib/post-setup/fabrics.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/post-setup/ha-manatee.js","type":"MODIFIED","insertions":0,"deletions":-64},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":0,"deletions":-3},{"file":"lib/post-setup/underlay-nics.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/procedures/create-service-instance-v1.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/procedures/download-images.js","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":1,"deletions":-14},{"file":"lib/procedures/update-agent-v1.js","type":"MODIFIED","insertions":2,"deletions":-12},{"file":"lib/procedures/update-binder-v2.js","type":"MODIFIED","insertions":5,"deletions":-12},{"file":"lib/procedures/update-dockerlogger.js","type":"MODIFIED","insertions":4,"deletions":-9},{"file":"lib/procedures/update-mahi-v2.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":1,"deletions":-122},{"file":"lib/procedures/update-moray-v2.js","type":"MODIFIED","insertions":2,"deletions":-12},{"file":"lib/procedures/update-single-headnode-imgapi.js","type":"MODIFIED","insertions":3,"deletions":-10},{"file":"lib/procedures/update-single-hn-sapi-v1.js","type":"MODIFIED","insertions":2,"deletions":-11},{"file":"lib/procedures/update-stateless-services-v1.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/procedures/update-ufds-service-v1.js","type":"MODIFIED","insertions":2,"deletions":-11},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":4,"deletions":-6},{"file":"lib/svcadm.js","type":"MODIFIED","insertions":4,"deletions":-10},{"file":"lib/ur.js","type":"MODIFIED","insertions":0,"deletions":-4},{"file":"lib/vmadm.js","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":62,"sizeDeletions":-543},{"number":"3","revision":"c68c437f3135a00570d11d24853ec53a2e5234c6","parents":["b786ee8926076728dbbd01a9ffdaba32776f947e"],"ref":"refs/changes/21/21/3","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1467928006,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"2","grantedOn":1468029945,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1468029962,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"comments":[{"file":"lib/cli/do_update_other.js","line":551,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Feels like this isUsbKeyMountd work would fit better in a separate ticket/commit."},{"file":"lib/cli/do_update_other.js","line":551,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Pedro snuck a few tickets in, so I had to rebase.  This is technically not in my change, but _is_ a difference from the last patchset I submitted.  If you look at the overall diff from start to finish it\u0027s not new code in this change."},{"file":"lib/history.js","line":33,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"/* style comments\n\ncall \"replacer\" something saying what it does. Bunyan calls its similar function \"safeCycles\".\n\n(curt because Gerrit lost my longer comment)"},{"file":"lib/history.js","line":41,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This is odd. This just makes all values beyond 29 keys (at any depth), be \"[Unknown]\". E.g.:\n\n```\no \u003d {sub: {}};\nfor (i \u003d 0; i \u003c 40; i++) {\n    o.sub[i.toString()] \u003d i;\n}\nconsole.log(JSON.stringify(o, replacer()));\nconsole.log(JSON.stringify(o));\n```\n\nResults in:\n\n```\n$ node repla.js\n{\"sub\":{\"0\":0,\"1\":1,\"2\":2,\"3\":3,\"4\":4,\"5\":5,\"6\":6,\"7\":7,\"8\":8,\"9\":9,\"10\":10,\"11\":11,\"12\":12,\"13\":13,\"14\":14,\"15\":15,\"16\":16,\"17\":17,\"18\":18,\"19\":19,\"20\":20,\"21\":21,\"22\":22,\"23\":23,\"24\":24,\"25\":25,\"26\":26,\"27\":\"[Unknown]\",\"28\":\"[Unknown]\",\"29\":\"[Unknown]\",\"30\":\"[Unknown]\",\"31\":\"[Unknown]\",\"32\":\"[Unknown]\",\"33\":\"[Unknown]\",\"34\":\"[Unknown]\",\"35\":\"[Unknown]\",\"36\":\"[Unknown]\",\"37\":\"[Unknown]\",\"38\":\"[Unknown]\",\"39\":\"[Unknown]\"}}\n{\"sub\":{\"0\":0,\"1\":1,\"2\":2,\"3\":3,\"4\":4,\"5\":5,\"6\":6,\"7\":7,\"8\":8,\"9\":9,\"10\":10,\"11\":11,\"12\":12,\"13\":13,\"14\":14,\"15\":15,\"16\":16,\"17\":17,\"18\":18,\"19\":19,\"20\":20,\"21\":21,\"22\":22,\"23\":23,\"24\":24,\"25\":25,\"26\":26,\"27\":27,\"28\":28,\"29\":29,\"30\":30,\"31\":31,\"32\":32,\"33\":33,\"34\":34,\"35\":35,\"36\":36,\"37\":37,\"38\":38,\"39\":39}}\n```"},{"file":"lib/history.js","line":45,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think you want to exclude non-object values here. Else you get this (after removing the \"[Unknown]\" handling):\n\n```\n$ node repla.js\n{\"sub\":{\"0\":0,\"1\":1,\"2\":2,\"3\":3,\"4\":4,\"5\":5,\"6\":6,\"7\":7,\"8\":8,\"9\":9,\"10\":\"[Circular]\",\"11\":\"[Circular]\",\"12\":\"[Circular]\",\"13\":\"[Circular]\",\"14\":\"[Circular]\",\"15\":\"[Circular]\",\"16\":\"[Circular]\",\"17\":\"[Circular]\",\"18\":\"[Circular]\",\"19\":\"[Circular]\",\"20\":\"[Circular]\",\"21\":\"[Circular]\",\"22\":\"[Circular]\",\"23\":\"[Circular]\",\"24\":\"[Circular]\",\"25\":\"[Circular]\",\"26\":\"[Circular]\",\"27\":\"[Circular]\",\"28\":\"[Circular]\",\"29\":\"[Circular]\",\"30\":\"[Circular]\",\"31\":\"[Circular]\",\"32\":\"[Circular]\",\"33\":\"[Circular]\",\"34\":\"[Circular]\",\"35\":\"[Circular]\",\"36\":\"[Circular]\",\"37\":\"[Circular]\",\"38\":\"[Circular]\",\"39\":\"[Circular]\"}}\n{\"sub\":{\"0\":0,\"1\":1,\"2\":2,\"3\":3,\"4\":4,\"5\":5,\"6\":6,\"7\":7,\"8\":8,\"9\":9,\"10\":0,\"11\":1,\"12\":2,\"13\":3,\"14\":4,\"15\":5,\"16\":6,\"17\":7,\"18\":8,\"19\":9,\"20\":0,\"21\":1,\"22\":2,\"23\":3,\"24\":4,\"25\":5,\"26\":6,\"27\":7,\"28\":8,\"29\":9,\"30\":0,\"31\":1,\"32\":2,\"33\":3,\"34\":4,\"35\":5,\"36\":6,\"37\":7,\"38\":8,\"39\":9}}\n```\n\nThe bunyan \u0027safeCycles\u0027 does this:\n\n```\n        if (!value || typeof (value) !\u003d\u003d \u0027object\u0027) {\n            return value;\n        }\n```\n\nSo, the full suggested replacement is:\n\n```\nfunction replacer() {\n    var i \u003d 0;\n    var objs \u003d [];\n    return function (key, value) {\n        if (!value || typeof (value) !\u003d\u003d \u0027object\u0027) {\n            return value;\n        }\n        if (objs.indexOf(value) !\u003d\u003d -1) {\n            return \u0027[Circular]\u0027;\n        } else {\n            objs.push(value);\n        }\n        return value;\n    };\n}\n```"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/channel.js","type":"MODIFIED","insertions":3,"deletions":-16},{"file":"lib/cli/do_avail.js","type":"MODIFIED","insertions":0,"deletions":-5},{"file":"lib/cli/do_cns.js","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":3,"deletions":-24},{"file":"lib/cli/index.js","type":"MODIFIED","insertions":3,"deletions":-10},{"file":"lib/common.js","type":"MODIFIED","insertions":3,"deletions":-15},{"file":"lib/dc-maint.js","type":"MODIFIED","insertions":3,"deletions":-15},{"file":"lib/default-fabric.js","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":-22},{"file":"lib/history.js","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"lib/logging.js","type":"MODIFIED","insertions":1,"deletions":-90},{"file":"lib/platform.js","type":"MODIFIED","insertions":4,"deletions":-8},{"file":"lib/post-setup/cloudapi.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/post-setup/common-external-nics.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/post-setup/dev-headnode-prov.js","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"lib/post-setup/dev-sample-data.js","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"lib/post-setup/fabrics.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/post-setup/ha-manatee.js","type":"MODIFIED","insertions":0,"deletions":-4},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":0,"deletions":-3},{"file":"lib/post-setup/underlay-nics.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/procedures/create-service-instance-v1.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/procedures/download-images.js","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":1,"deletions":-13},{"file":"lib/procedures/update-agent-v1.js","type":"MODIFIED","insertions":2,"deletions":-12},{"file":"lib/procedures/update-binder-v2.js","type":"MODIFIED","insertions":5,"deletions":-12},{"file":"lib/procedures/update-dockerlogger.js","type":"MODIFIED","insertions":4,"deletions":-9},{"file":"lib/procedures/update-mahi-v2.js","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":1,"deletions":-36},{"file":"lib/procedures/update-moray-v2.js","type":"MODIFIED","insertions":2,"deletions":-12},{"file":"lib/procedures/update-single-headnode-imgapi.js","type":"MODIFIED","insertions":3,"deletions":-10},{"file":"lib/procedures/update-single-hn-sapi-v1.js","type":"MODIFIED","insertions":2,"deletions":-11},{"file":"lib/procedures/update-stateless-services-v1.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/procedures/update-ufds-service-v1.js","type":"MODIFIED","insertions":2,"deletions":-11},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":4,"deletions":-6},{"file":"lib/svcadm.js","type":"MODIFIED","insertions":4,"deletions":-10},{"file":"lib/ur.js","type":"MODIFIED","insertions":0,"deletions":-4},{"file":"lib/vmadm.js","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":65,"sizeDeletions":-402}],"allReviewers":[{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}]}