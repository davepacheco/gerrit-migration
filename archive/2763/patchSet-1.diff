From 96f90b48e57374fe5b247d64fb2e5444b2b73f34 Mon Sep 17 00:00:00 2001
From: Brittany Wald <brittany.wald@joyent.com>
Date: Tue, 10 Oct 2017 00:47:18 +0000
Subject: [PATCH] MORAY-442 node-moray cli option for readOnlyOverride

---
 bin/sql              | 21 ++++++++++++++++-----
 docs/man/man1/sql.md | 14 +++++++++++---
 package.json         |  2 +-
 3 files changed, 28 insertions(+), 9 deletions(-)

diff --git a/bin/sql b/bin/sql
index 4656c0c..0255723 100755
--- a/bin/sql
+++ b/bin/sql
@@ -14,21 +14,32 @@ var cmdutil = require('cmdutil');
 var moray = require('../lib');
 var moraycli = require('../lib/cmd');
 
-var clientOptions, parser, sql, client;
+var clientOptions, parser, sql, client, opts;
 
 cmdutil.configure({
     'usageMessage': 'execute raw SQL on Moray-backed database',
-    'synopses': [ moraycli.commonUsage + ' SQL' ]
+    'synopses': [ moraycli.commonUsage + ' [-r readonlyoverride] SQL' ]
 });
 
 clientOptions = {};
+opts = {
+    readOnlyOverride: false
+};
+
 parser = moraycli.parseCliOptions({
     'argv': process.argv,
     'env': process.env,
     'errstream': process.stderr,
-    'extraOptStr': '',
+    'extraOptStr': 'r',
     'clientOptions': clientOptions,
-    'onUsage': cmdutil.usage
+    'onUsage': cmdutil.usage,
+    'onOption': function (option) {
+        if (option.option === 'r') {
+            opts.readOnlyOverride = true;
+        } else {
+            cmdutil.usage();
+        }
+    }
 });
 
 if (parser.optind() >= process.argv.length) {
@@ -39,7 +50,7 @@ sql = process.argv[parser.optind()];
 client = moray.createClient(clientOptions);
 client.on('error', cmdutil.fail);
 client.on('connect', function onConnect() {
-    var req = client.sql(sql);
+    var req = client.sql(sql, opts);
 
     req.once('error', cmdutil.fail);
 
diff --git a/docs/man/man1/sql.md b/docs/man/man1/sql.md
index b9ca66f..42b98c9 100644
--- a/docs/man/man1/sql.md
+++ b/docs/man/man1/sql.md
@@ -1,12 +1,12 @@
-# sql 1 "January 2017" Moray "Moray Client Tools"
+# sql 1 "October 2017" Moray "Moray Client Tools"
 
 ## NAME
 
-sql - check of a Moray server is functioning
+sql - check if a Moray server is functioning
 
 ## SYNOPSIS
 
-`sql [COMMON_OPTIONS] SQL`
+`sql [COMMON_OPTIONS] [-r] SQL`
 
 ## DESCRIPTION
 
@@ -21,6 +21,14 @@ be first-classed as specific Moray requests with associated tools.
 
 ## OPTIONS
 
+`-r`
+  *Only for use in electric-moray.*  Set the read-only override flag
+  (readOnlyOverride) to allow queries to run even if the vnode a particular
+  object hashes to has been marked read-only.  It is not possible in an
+  arbitrary case to know the reason a particular vnode has been set to
+  read-only, so it is important to note once again that *this is dangerous and
+  should ONLY be used by operators and developers while debugging*.
+
 See `moray(1)` for information about the `COMMON_OPTIONS`, which control
 the log verbosity and how to locate the remote server.
 
diff --git a/package.json b/package.json
index 9350762..4bb2a9d 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "moray",
     "description": "Moray client library",
-    "version": "3.3.0",
+    "version": "3.4.0",
     "author": "Joyent (joyent.com)",
     "keywords": [ "moray" ],
     "main": "./lib/index.js",
-- 
2.21.0

