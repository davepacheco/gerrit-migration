commit 3617c6ffd62dede822a6c266023ab3bd24423eeb (refs/changes/63/2763/2)
Author: Brittany Wald <brittany.wald@joyent.com>
Date:   2017-10-11T21:26:26+00:00 (2 years ago)
    
    MORAY-442 node-moray cli option for readOnlyOverride

diff --git a/bin/sql b/bin/sql
index 4656c0c..4e534fe 100755
--- a/bin/sql
+++ b/bin/sql
@@ -14,21 +14,32 @@ var cmdutil = require('cmdutil');
 var moray = require('../lib');
 var moraycli = require('../lib/cmd');
 
-var clientOptions, parser, sql, client;
+var clientOptions, parser, sql, client, opts;
 
 cmdutil.configure({
     'usageMessage': 'execute raw SQL on Moray-backed database',
-    'synopses': [ moraycli.commonUsage + ' SQL' ]
+    'synopses': [ moraycli.commonUsage + ' [-r] SQL' ]
 });
 
 clientOptions = {};
+opts = {
+    readOnlyOverride: false
+};
+
 parser = moraycli.parseCliOptions({
     'argv': process.argv,
     'env': process.env,
     'errstream': process.stderr,
-    'extraOptStr': '',
+    'extraOptStr': 'r',
     'clientOptions': clientOptions,
-    'onUsage': cmdutil.usage
+    'onUsage': cmdutil.usage,
+    'onOption': function (option) {
+        if (option.option === 'r') {
+            opts.readOnlyOverride = true;
+        } else {
+            cmdutil.usage();
+        }
+    }
 });
 
 if (parser.optind() >= process.argv.length) {
@@ -39,7 +50,7 @@ sql = process.argv[parser.optind()];
 client = moray.createClient(clientOptions);
 client.on('error', cmdutil.fail);
 client.on('connect', function onConnect() {
-    var req = client.sql(sql);
+    var req = client.sql(sql, opts);
 
     req.once('error', cmdutil.fail);
 
diff --git a/docs/man/man1/sql.md b/docs/man/man1/sql.md
index b9ca66f..d27120d 100644
--- a/docs/man/man1/sql.md
+++ b/docs/man/man1/sql.md
@@ -1,12 +1,12 @@
-# sql 1 "January 2017" Moray "Moray Client Tools"
+# sql 1 "October 2017" Moray "Moray Client Tools"
 
 ## NAME
 
-sql - check of a Moray server is functioning
+sql - execute raw SQL against Moray data
 
 ## SYNOPSIS
 
-`sql [COMMON_OPTIONS] SQL`
+`sql [COMMON_OPTIONS] [-r] SQL`
 
 ## DESCRIPTION
 
@@ -21,6 +21,15 @@ be first-classed as specific Moray requests with associated tools.
 
 ## OPTIONS
 
+`-r`
+  *Only for use in electric-moray.*  Ordinarily electric-moray will prohibit the
+  execution of raw SQL against any vnode that has been set to read-only mode in
+  order to avoid modifactions to the read-only metadata.  When this flag is set,
+  the check that prevents that execution is bypassed, so these queries will run
+  even if some vnodes have been marked read-only.  You are responsible for
+  vetting any query run with this command, since arbitrary SQL could cause many
+  problems noted above.
+
 See `moray(1)` for information about the `COMMON_OPTIONS`, which control
 the log verbosity and how to locate the remote server.
 
diff --git a/package.json b/package.json
index 9350762..4bb2a9d 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "moray",
     "description": "Moray client library",
-    "version": "3.3.0",
+    "version": "3.4.0",
     "author": "Joyent (joyent.com)",
     "keywords": [ "moray" ],
     "main": "./lib/index.js",
