From 00c810b4a4780f9c088521fcdf9c7e99d771ae62 Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Tue, 7 Feb 2017 01:55:10 +0000
Subject: [PATCH] MORAY-397 Remove query timeouts unless requested by client

---
 README.md                         |  1 +
 etc/config.coal.json              |  1 -
 etc/config.coal.manta.json        |  1 -
 etc/config.json.in                |  3 +--
 etc/config.lab.json               |  3 +--
 etc/config.local.json             |  1 -
 etc/config.standalone.json        |  3 +--
 lib/control.js                    |  4 +++-
 lib/pg.js                         | 22 +++++++++++++++++++++-
 sapi_manifests/moray/template     |  1 -
 sdc/sapi_manifests/moray/template |  1 -
 11 files changed, 28 insertions(+), 13 deletions(-)

diff --git a/README.md b/README.md
index d7fbc20..95a2ec7 100644
--- a/README.md
+++ b/README.md
@@ -183,6 +183,7 @@ Postgres database without using Manatee. A single function is exported,
 - `standalone`, an object specifying the standalone server's configuration:
     * `pg`, an object which specifies the Postgres client pool confguration:
         - `queryTimeout`, how long (in milliseconds) before a query is timed out
+          (defaults to 0, which disables the timeout)
         - `maxConnections`, the maximum number of connections to maintain
           to Postgres
     * `url`, a [pg](https://github.com/brianc/node-postgres) URL describing how
diff --git a/etc/config.coal.json b/etc/config.coal.json
index afd606a..fe0af01 100644
--- a/etc/config.coal.json
+++ b/etc/config.coal.json
@@ -20,7 +20,6 @@
             "checkInterval": 90000,
             "maxConnections": 15,
             "maxIdleTime": 270000,
-            "queryTimeout": 30000,
             "user": "moray"
         }
     },
diff --git a/etc/config.coal.manta.json b/etc/config.coal.manta.json
index 10cc8be..7973d66 100644
--- a/etc/config.coal.manta.json
+++ b/etc/config.coal.manta.json
@@ -26,7 +26,6 @@
       "checkInterval": 90000,
       "maxConnections": 16,
       "maxIdleTime": 270000,
-      "queryTimeout": 30000,
       "user": "moray"
     }
   },
diff --git a/etc/config.json.in b/etc/config.json.in
index 5f71eb6..99929de 100644
--- a/etc/config.json.in
+++ b/etc/config.json.in
@@ -22,8 +22,7 @@
             "connectTimeout": 3000,
             "maxConnections": 15,
             "maxIdleTime": 120000,
-            "checkInterval": 30000,
-            "queryTimeout": 30000
+            "checkInterval": 30000
         }
     },
     "cache": {
diff --git a/etc/config.lab.json b/etc/config.lab.json
index 04d4446..b9e8f49 100644
--- a/etc/config.lab.json
+++ b/etc/config.lab.json
@@ -14,8 +14,7 @@
                         "connectTimeout": 2000,
                         "maxConnections": 5,
                         "maxIdleTime": 30000,
-                        "checkInterval": 120000,
-                        "queryTimeout": 2000
+                        "checkInterval": 120000
                 },
                 "zk": {
                         "connectTimeout": 2000,
diff --git a/etc/config.local.json b/etc/config.local.json
index 8973f57..b48db65 100644
--- a/etc/config.local.json
+++ b/etc/config.local.json
@@ -19,7 +19,6 @@
                         "maxConnections": 15,
                         "maxIdleTime": 30000,
                         "checkInterval": 90000,
-                        "queryTimeout": 0,
                         "user": "postgres"
                 }
         },
diff --git a/etc/config.standalone.json b/etc/config.standalone.json
index c24d9ca..5d838fa 100644
--- a/etc/config.standalone.json
+++ b/etc/config.standalone.json
@@ -9,8 +9,7 @@
             "connectTimeout": 3000,
             "maxConnections": 15,
             "maxIdleTime": 120000,
-            "checkInterval": 30000,
-            "queryTimeout": 30000
+            "checkInterval": 30000
         },
         "url": "tcp://moray@10.99.99.16:5432/moray"
     },
diff --git a/lib/control.js b/lib/control.js
index 316fb38..fe22eb3 100644
--- a/lib/control.js
+++ b/lib/control.js
@@ -49,8 +49,10 @@ function _getPGHandleAfter(req, cb) {
             req.log.debug(startErr, '%s: no DB handle', req.route);
             cb(startErr);
         } else {
-            if (req.opts.timeout)
+            if (req.opts.hasOwnProperty('timeout')) {
                 pg.setTimeout(req.opts.timeout);
+            }
+
             req.pg = pg;
             cb(null);
         }
diff --git a/lib/pg.js b/lib/pg.js
index 796bbd9..48dfb38 100644
--- a/lib/pg.js
+++ b/lib/pg.js
@@ -226,6 +226,23 @@ function pgSetup(options) {
             cb(err);
         }
 
+        /*
+         * Don't time out the final "COMMIT" query. Sending back a
+         * QueryTimeoutError would needlessly complicate things for
+         * the consumer and for us, since Postgres would still be
+         * processing the query after we give up on it, and possibly
+         * succeed or fail. Handling this would make proper management
+         * of our PG connections more complicated.
+         *
+         * Given that "timeout" doesn't actually introduce an
+         * upper-bound on the overall Moray RPC but instead controls
+         * how long we wait for a response to each of the SQL queries
+         * we make, clients who actually want an upper-bound on how
+         * long an RPC takes should implement the appropriate logic
+         * on their end.
+         */
+        client.setTimeout(0);
+
         var q = client.query('COMMIT');
         q.once('error', _cb);
         q.once('end', function () {
@@ -508,6 +525,9 @@ PGPool.prototype.checkout = function checkout(callback) {
             // MANTA-1458 - hack!
             client._defaultTimeout = client._queryTimeout;
             client.setTimeout = function setTimeout(t) {
+                assert.finite(t, 't is finite');
+                assert.ok(t >= 0, 't >= 0');
+
                 client._queryTimeout = t;
             };
             callback(null, client);
@@ -641,7 +661,7 @@ module.exports = {
         number('connectTimeout', 1000);
         number('maxIdleTime', 120000);
         number('maxConnections', 5);
-        number('queryTimeout', 30000);
+        number('queryTimeout', 0);
 
         return (new PGPool(opts));
     },
diff --git a/sapi_manifests/moray/template b/sapi_manifests/moray/template
index 6cf4fbb..939d73c 100644
--- a/sapi_manifests/moray/template
+++ b/sapi_manifests/moray/template
@@ -24,7 +24,6 @@
       "checkInterval": 90000,
       "maxConnections": {{MORAY_MAX_PG_CONNS}},
       "maxIdleTime": 270000,
-      "queryTimeout": 30000,
       "user": "moray"
     }
   },
diff --git a/sdc/sapi_manifests/moray/template b/sdc/sapi_manifests/moray/template
index a21f367..89ee0eb 100644
--- a/sdc/sapi_manifests/moray/template
+++ b/sdc/sapi_manifests/moray/template
@@ -24,7 +24,6 @@
       "checkInterval": 90000,
       "maxConnections": {{MORAY_MAX_PG_CONNS}},
       "maxIdleTime": 270000,
-      "queryTimeout": 30000,
       "user": "moray"
     }
   },
-- 
2.21.0

