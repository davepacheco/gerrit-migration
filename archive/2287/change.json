{"project":"joyent/moray","branch":"master","topic":"MORAY-397","id":"I6ac62d1967cb5aff71fe8cdda9346bf1a72f7e7b","number":"2287","subject":"MORAY-397 Remove query timeouts unless requested by client Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Approved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e","owner":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"url":"https://cr.joyent.us/2287","commitMessage":"MORAY-397 Remove query timeouts unless requested by client\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1501107292,"lastUpdated":1504655950,"open":false,"status":"MERGED","comments":[{"timestamp":1501107292,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 1."},{"timestamp":1501107309,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Topic set to MORAY-397"},{"timestamp":1501107318,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1501630771,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1501630807,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1501782806,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\n(2 comments)\n\nThe code itself looks good, but I have some questions about the intended semantics."},{"timestamp":1503355214,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1503514104,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1503521421,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 3."},{"timestamp":1503521453,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1503521681,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 4."},{"timestamp":1503521702,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1503521788,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1503619223,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1504647305,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1504650014,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1504655950,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Cody Peter Mello"}],"currentPatchSet":{"number":"5","revision":"6ac62d1967cb5aff71fe8cdda9346bf1a72f7e7b","parents":["46b2c391785792e1cad779e104f296857da0863d"],"ref":"refs/changes/87/2287/5","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1504650014,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1503521788,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503619223,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504647305,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1504655950,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":1,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.coal.manta.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.json.in","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"etc/config.lab.json","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"etc/config.local.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.standalone.json","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"lib/control.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/pg.js","type":"MODIFIED","insertions":21,"deletions":-1},{"file":"sapi_manifests/moray/template","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"sdc/sapi_manifests/moray/template","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":28,"sizeDeletions":-13},"patchSets":[{"number":"1","revision":"6d4a8755808437bb5ce368c620d7cd8169c4b737","parents":["babef57ae733136084b7c72d28c365a038cb4f46"],"ref":"refs/changes/87/2287/1","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1501107292,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1501107318,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":1,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.coal.manta.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.json.in","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"etc/config.lab.json","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"etc/config.local.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.standalone.json","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"lib/control.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/pg.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"sapi_manifests/moray/template","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"sdc/sapi_manifests/moray/template","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":15,"sizeDeletions":-13},{"number":"2","revision":"29fb593a4b660c3ed9ec59b33504217545c2dcc6","parents":["ea7c40cca0d6e8df6887e87f11208fddcf9bb0e6"],"ref":"refs/changes/87/2287/2","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1501630771,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1501107318,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/control.js","line":53,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Can we assert that this is a positive number here?"},{"file":"lib/control.js","line":53,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"The JSON schema checks that it\u0027s an integer with a minimum of 0. Is that sufficient, or would you also like an assert here like:\n\n    assert.ok(req.opts.timeout \u003e 0, \u0027req.opts.timeout \u003e 0\u0027);"},{"file":"lib/control.js","line":53,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Given the way functions like setTimeout() handle invalid values, I think an assertion here is well worth it.  It should assert whatever the real condition is."},{"file":"lib/control.js","line":53,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I\u0027ve added some assertions to this method to make sure the value is finite and greater than or equal to 0."},{"file":"lib/pg.js","line":234,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It seems like the real reason for not timing out here is that cancelling it here isn\u0027t really meaningful since it may still be ongoing (in addition to possibly succeeding).  That is, if we did allow the RPC to time out here, but PostgreSQL was still working on the query, then we\u0027d have this new state for PG connections which is \"in use executing a query for an already-aborted RPC\".  I think that just adds complexity for no reason, since a client can always abort the RPC on their side if that\u0027s what they want (knowing that the server is still processing it).\n\n(I\u0027m not sure I buy the argument about a misleading response.  I think the nature of QueryTimeoutError means the client cannot assume anything about whether the operation succeeded or not. Â That should be okay because there are always cases where the client won\u0027t be able to tell from the response they got whether the query succeeded (e.g., a TCP connection timeout), and they need to handle such cases.)\n\nThat said, if we\u0027re not going to apply the timeout during this phase, what\u0027s the point of having the timeout at all?  I think most people would expect \"timeout\" to specify the longest period that an RPC may be outstanding, assuming a healthy network.  I guess here it specifies a best effort, and consumers must be prepared for the query to take arbitrarily longer than that.  I wonder how we avoid people specifying timeouts thinking they\u0027ll limit the RPC to that long, and then being surprised to see a query having taken much longer than that with a healthy network (which feels pretty likely to happen)?"},{"file":"lib/pg.js","line":234,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"\u003e I think most people would expect \"timeout\" to specify the longest period that an RPC may be outstanding, assuming a healthy network. I guess here it specifies a best effort, and consumers must be prepared for the query to take arbitrarily longer than that.\n\nThe timeout is on each SQL query made, so it\u0027s possible for an RPC to take much longer than the timeout if every single query takes just under the timeout length to receive a reply from Postgres.\n\nHow does this update sound:\n\n        /* \n         * Don\u0027t time out the final \"COMMIT\" query. The query may                                                      \n         * still succeed at some point in the future, so sending                                                       \n         * back a QueryTimeoutError would needlessly complicate                                                        \n         * things for the consumer.\n         *                                                                                                             \n         * Given that \"timeout\" doesn\u0027t actually introduce an                                                          \n         * upper-bound on the overall Moray RPC but instead                                                            \n         * controls how long we wait for a response to each of                                                         \n         * the SQL queries we make, clients who actually want an                                                       \n         * upper bound on how long an RPC takes should implement                                                       \n         * the appropriate logic on their end.                                                                         \n         */"},{"file":"lib/pg.js","line":234,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"That sounds good.  What do you think about adding to the first paragraph: \"Additionally, PostgreSQL would still be processing the query even if we gave up on it. This would make proper management of our PG connections much more complicated.\"\n\nThe behavior does make me wonder if we should really support this at all.  I understand we probably can\u0027t get rid of it, but I wonder if we should explicit discourage it."},{"file":"lib/pg.js","line":234,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I\u0027ve added the comment, along with your addition.\n\n\u003e The behavior does make me wonder if we should really support this at all. I understand we probably can\u0027t get rid of it, but I wonder if we should explicit discourage it.\n\nI think we should definitely push people to avoid using it, since I don\u0027t think it\u0027s ever really what people want. It looks like the docs do suggest that people avoid it today:\n\nhttps://mo.joyent.com/docs/moray/master/#timeout"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":1,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.coal.manta.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.json.in","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"etc/config.lab.json","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"etc/config.local.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.standalone.json","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"lib/control.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/pg.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"sapi_manifests/moray/template","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"sdc/sapi_manifests/moray/template","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":15,"sizeDeletions":-13},{"number":"3","revision":"dd0401dfe543749781788d435c1ea71d1a852233","parents":["ea7c40cca0d6e8df6887e87f11208fddcf9bb0e6"],"ref":"refs/changes/87/2287/3","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1503521421,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1503521453,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":1,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.coal.manta.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.json.in","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"etc/config.lab.json","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"etc/config.local.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.standalone.json","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"lib/control.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/pg.js","type":"MODIFIED","insertions":21,"deletions":-1},{"file":"sapi_manifests/moray/template","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"sdc/sapi_manifests/moray/template","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":28,"sizeDeletions":-13},{"number":"4","revision":"00c810b4a4780f9c088521fcdf9c7e99d771ae62","parents":["ea7c40cca0d6e8df6887e87f11208fddcf9bb0e6"],"ref":"refs/changes/87/2287/4","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1503521681,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503619223,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504647305,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1503521788,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":1,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.coal.manta.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.json.in","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"etc/config.lab.json","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"etc/config.local.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.standalone.json","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"lib/control.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/pg.js","type":"MODIFIED","insertions":21,"deletions":-1},{"file":"sapi_manifests/moray/template","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"sdc/sapi_manifests/moray/template","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":28,"sizeDeletions":-13},{"number":"5","revision":"6ac62d1967cb5aff71fe8cdda9346bf1a72f7e7b","parents":["46b2c391785792e1cad779e104f296857da0863d"],"ref":"refs/changes/87/2287/5","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1504650014,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503619223,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1504655950,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504647305,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1503521788,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":1,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.coal.manta.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.json.in","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"etc/config.lab.json","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"etc/config.local.json","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"etc/config.standalone.json","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"lib/control.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/pg.js","type":"MODIFIED","insertions":21,"deletions":-1},{"file":"sapi_manifests/moray/template","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"sdc/sapi_manifests/moray/template","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":28,"sizeDeletions":-13}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}]}