From a151f6a842202f714282d7c93334e871a4ee84fb Mon Sep 17 00:00:00 2001
From: Marsell Kukuljevic <marsell@joyent.com>
Date: Sun, 4 Mar 2018 23:33:30 +1100
Subject: [PATCH] TRITON-206 vmapi isn't checking free capacity when resizing
 non-HVM VMs upwards

---
 lib/common/validation.js | 22 +++++++++-------------
 1 file changed, 9 insertions(+), 13 deletions(-)

diff --git a/lib/common/validation.js b/lib/common/validation.js
index 0a42d1c..f766a4d 100644
--- a/lib/common/validation.js
+++ b/lib/common/validation.js
@@ -1377,14 +1377,6 @@ exports.validateUpdateVmParams = function (vmapi, vm, obj, callback) {
     // manually done
     params.subtask = getSubtask();
 
-    // Validate resize. Not allowed for bhyve or kvm at the moment
-    if (params.subtask === 'resize' &&
-        ['bhyve', 'kvm'].indexOf(vm.brand) !== -1) {
-
-        errs.push(errors.invalidParamErr('brand', 'Cannot resize a ' +
-            vm.brand + ' VM'));
-    }
-
     // Async validations
     var asyncFns = [];
     if (params.alias) {
@@ -1393,11 +1385,15 @@ exports.validateUpdateVmParams = function (vmapi, vm, obj, callback) {
     if (params.billing_id) {
         asyncFns.push(validatePackage);
     }
-    if (params.subtask === 'resize' &&
-        ['bhyve', 'kvm'].indexOf(vm.brand) !== -1) {
-
-        asyncFns.push(validateResize);
-        asyncFns.push(validateCapacity);
+    if (params.subtask === 'resize') {
+        if (['bhyve', 'kvm'].indexOf(vm.brand) === -1) {
+            asyncFns.push(validateResize);
+            asyncFns.push(validateCapacity);
+        } else {
+            // Not allowed for bhyve or kvm at the moment
+            errs.push(errors.invalidParamErr('brand', 'Cannot resize a ' +
+                vm.brand + ' VM'));
+        }
     }
 
     function validateAlias(next) {
-- 
2.21.0

