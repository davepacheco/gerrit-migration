From 0f057ae9cba7a7d04cd159c24b0366dfe4a672b1 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Thu, 25 Jan 2018 17:20:25 -0800
Subject: [PATCH] TRITON-86 booter should allow .local override for
 packetOpts.file

---
 lib/dhcpd.js | 24 +++++++++++++++++++++++-
 package.json |  2 +-
 2 files changed, 24 insertions(+), 2 deletions(-)

diff --git a/lib/dhcpd.js b/lib/dhcpd.js
index 25d3a78..32f328c 100755
--- a/lib/dhcpd.js
+++ b/lib/dhcpd.js
@@ -23,6 +23,7 @@ var mod_boot_files = require('./boot-files');
 var mod_bootparams = require('./bootparams');
 var mod_cache = require('./cache');
 var mod_clients = require('./clients');
+var path = require('path');
 var sprintf = require('sprintf').sprintf;
 var uuid = require('node-uuid');
 
@@ -129,9 +130,30 @@ DHCPD.prototype.handleMessage = function (msg, peer) {
     }
 
 
-
     var _sendReplyWithParams = function (params) {
+        var localFile;
         var packetOpts = self.buildPacketOpts(packet, params.bootParams, log);
+
+        // Allow local override of boot files, for testing
+        if (packetOpts.file && self.config.tftpRoot) {
+            localFile = packetOpts.file + '.local';
+
+            log.trace({
+                fileOpt: packetOpts.file,
+                mac: mac,
+                tftpRoot: self.config.tftpRoot
+            }, 'checking for local override');
+
+            if (fs.existsSync(path.join(self.config.tftpRoot, localFile))) {
+                log.warn({
+                    generatedFile: packetOpts.file,
+                    mac: mac,
+                    overrideFile: localFile
+                }, 'local override exists, using instead of generated file');
+                packetOpts.file = localFile;
+            }
+        }
+
         self.sendReply(packet, packetOpts, log, function (sendErr) {
             if (sendErr) {
                 log.error(sendErr, 'Error sending reply');
diff --git a/package.json b/package.json
index 06eff60..2d73ae2 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "booter",
   "description": "DHCP server for booting SDC compute nodes",
-  "version": "1.3.0",
+  "version": "1.3.1",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

