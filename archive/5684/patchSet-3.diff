From cd5fec287895cc3c491d66c8405ebacb6d193b49 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Mon, 4 Mar 2019 19:30:42 +0100
Subject: [PATCH] TRITON-1272 sdcadm test failures due to outdated tape version

---
 package.json                 |  4 ++--
 test/instances.test.js       | 12 +++++++++++-
 test/update-gz-tools.test.js |  7 ++++++-
 3 files changed, 19 insertions(+), 4 deletions(-)

diff --git a/package.json b/package.json
index 523b192..7f450fe 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "sdcadm",
   "description": "Administer a SmartDataCenter (SDC) standup",
-  "version": "1.24.6",
+  "version": "1.24.7",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
@@ -26,7 +26,7 @@
     "semver": "5.4.1",
     "strsplit": "1.0.0",
     "tabula": "1.9.0",
-    "tape": "3.5.0",
+    "tape": "4.10.1",
     "triton-netconfig": "1.0.0",
     "ufds": "1.3.0",
     "urclient": "1.2.0",
diff --git a/test/instances.test.js b/test/instances.test.js
index 8e3981f..2006695 100644
--- a/test/instances.test.js
+++ b/test/instances.test.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2018 Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 
@@ -57,8 +57,18 @@ function checkInstancesDetails(t, instancesDetails) {
             version: item[3],
             alias: item[4]
         });
+    }).filter(function (inst) {
+        // Versions for these components are not the using the traditional
+        // branch-releasedate-gitsha approach, which will make the img version
+        // vs. inst version check fail
+        return [
+            'mockcloud',
+            'grafana',
+            'prometheus']
+        .indexOf(inst.service) === -1;
     });
 
+
     common.checkInsts(t, {
         inputs: instancesDetails,
         serviceNamesFromUUID: serviceNamesFromUUID,
diff --git a/test/update-gz-tools.test.js b/test/update-gz-tools.test.js
index 17072f1..336c1bf 100644
--- a/test/update-gz-tools.test.js
+++ b/test/update-gz-tools.test.js
@@ -108,7 +108,6 @@ test('update-gz-tools --latest --just-download', function (t) {
     exec(cmd, function (err, stdout, stderr) {
         t.ifError(err, 'Update gz-tools error');
         var findStrings = [
-            'Downloading gz-tools',
             'Using channel',
             'Updated gz-tools successfully'
         ];
@@ -118,6 +117,12 @@ test('update-gz-tools --latest --just-download', function (t) {
                 util.format('check just-download string present %s', str));
         });
 
+        if (stdout.indexOf('Downloading gz-tools') === -1) {
+            t.notEqual(stdout.indexOf('from previous download'), -1,
+                util.format('check just-download string present %s',
+                    'from previous download'));
+        }
+
         var findNotStrings = [
             'Decompressing gz-tools tarball',
             'Validating gz-tools tarball files',
-- 
2.21.0

