commit fc782623707989b6b5a6fbd1b1224665ea094790 (refs/changes/32/2432/1)
Author: Jan Wyszynski <jan.wyszynski@joyent.com>
Date:   2017-08-18T23:00:08+00:00 (2 years, 2 months ago)
    
    MANTA-3220 MPU shark selection should try to connect to several sets of sharks

diff --git a/lib/uploads/create.js b/lib/uploads/create.js
index 5b35117..e239e51 100644
--- a/lib/uploads/create.js
+++ b/lib/uploads/create.js
@@ -16,6 +16,7 @@ var path = require('path');
 var restify = require('restify');
 var util = require('util');
 var verror = require('verror');
+var vasync = require('vasync');
 
 var auth = require('../auth');
 var common = require('../common');
@@ -39,7 +40,7 @@ var sprintf = util.format;
  * the durability-level and the content-length headers, respectively, or
  * set to a default value.
  */
-function chooseSharks(req, size, copies, cb) {
+function chooseSharks(req, res, size, copies, cb) {
     assert.object(req, 'req');
     assert.number(size, 'size');
     assert.number(copies, 'copies');
@@ -59,10 +60,53 @@ function chooseSharks(req, size, copies, cb) {
             if (err) {
                 cb(err);
             } else {
-                log.debug({
-                    sharks: sharks[0]
-                }, 'upload: sharks chosen');
-                cb(null, sharks[0]);
+                var ndx = 0;
+                var attempted = [];
+                log.info({
+                    sharks: sharks
+                }, 'mpu-create : sharks given');
+                (function attempt(inputs) {
+                    vasync.forEachParallel({
+                        func: function (shark, callback) {
+                            var pool = req.sharkAgent.getPool(
+                                shark.manta_storage_id);
+                            if (pool === undefined) {
+                                pool = req.sharkAgent.createPool(
+                                    shark.manta_storage_id);
+                            }
+                            var options = {
+                                timeout: req.sharkConfig.connectTimeout,
+                                errOnEmpty: true
+                            };
+                            pool.claim(options, function (err2, handle) {
+                                if (err) {
+                                    callback(err2, shark);
+                                } else {
+                                    handle.release();
+                                    callback(null, shark);
+                                }
+                            });
+                        },
+                        inputs: inputs
+                    }, function (err2, results) {
+                        if (err || results.successes.length < copies) {
+                            attempted.concat(results.successes);
+                            if (ndx < sharks.length) {
+                                attempt(sharks[ndx++]);
+                            } else {
+                                cb(new SharksExhaustedError(res), null);
+                            }
+                            return;
+                        }
+                        log.info({
+                            sharks: attempted
+                        }, 'mpu-create : unsuccessfully attempted sharks');
+                        log.debug({
+                            sharks: results.successes
+                        }, 'mpu-create: sharks chosen');
+                        cb(null, results.successes);
+                    });
+                })(sharks[ndx++]);
             }
         });
     }
@@ -285,7 +329,7 @@ function createUpload(req, res, next) {
     var s = req.upload.mpuSize;
     var c = req.upload.mpuCopies;
 
-    chooseSharks(req, s, c, function (err, sharks) {
+    chooseSharks(req, res, s, c, function (err, sharks) {
         if (err) {
             next(err);
         } else {
