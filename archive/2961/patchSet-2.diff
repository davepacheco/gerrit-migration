From 3617eb05f00e83820e4ea294bb29f4c388d96c2b Mon Sep 17 00:00:00 2001
From: Brian Bennett <brian.bennett@joyent.com>
Date: Thu, 16 Nov 2017 17:32:08 -0800
Subject: [PATCH] joyent/manta-thoth#157 building in manta is broken

---
 Makefile                   |  3 +--
 tools/build-release.sh     | 11 ++++++++++-
 tools/manta-thoth-build.sh |  2 +-
 3 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/Makefile b/Makefile
index 41021fd..9292fe7 100644
--- a/Makefile
+++ b/Makefile
@@ -11,10 +11,9 @@ release: thoth-$(UNAME)-$(VER).tar.gz
 publish: release
 	./tools/publish.sh "$(VER)"
 
-thoth-$(UNAME)-$(VER).tar.gz: node_modules
+thoth-$(UNAME)-$(VER).tar.gz:
 	./tools/build-release.sh
 
 clean:
 	rm -rf node_modules opt
 	rm -f thoth-$(UNAME)-$(VER).tar.gz
-	rm -rf node-v*-$(UNAME)-*
diff --git a/tools/build-release.sh b/tools/build-release.sh
index 8abe455..2078e51 100755
--- a/tools/build-release.sh
+++ b/tools/build-release.sh
@@ -20,6 +20,10 @@ node_dir="node-v${node_ver}-${uname}-${node_arch}"
 node_tar="${node_dir}.tar.gz"
 node_location="https://nodejs.org/download/release/v${node_ver}"
 
+base="$PWD"
+proto=$(mktemp -d -t thoth-build.XXXXXX)
+cd "$proto"
+
 curl -#LOC - "${node_location}/${node_tar}"
 tar zxf "$node_tar"
 
@@ -29,6 +33,11 @@ if [[ $uname == sunos ]]; then
     cp /opt/local/gcc47/lib/libstdc++.so.6 opt/custom/thoth/lib
     cp /opt/local/gcc47/lib/libgcc_s.so.1 opt/custom/thoth/lib
 fi
-cp -r node_modules opt/custom/thoth
+(
+    cd opt/custom/thoth
+    npm install smartdc thoth
+)
 
 tar zcf "$tar" opt
+mv "$tar" "$base"
+#rm -rf "$proto"
diff --git a/tools/manta-thoth-build.sh b/tools/manta-thoth-build.sh
index 64bbc0e..f2bd9d6 100755
--- a/tools/manta-thoth-build.sh
+++ b/tools/manta-thoth-build.sh
@@ -3,7 +3,7 @@
 set -o errexit
 
 job=$(
-mjob create --close -m 'set -o errexit ;
+mjob create --close -r 'set -o errexit ;
 cd /var/tmp ;
 git clone https://github.com/joyent/manta-thoth ;
 cd manta-thoth ;
-- 
2.21.0

