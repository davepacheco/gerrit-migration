{"project":"joyent/mountain-gorilla","branch":"master","topic":"lullaby-phase4","id":"I5501983ea22bf779923b55097fbd33ddb8a33ffb","number":"6092","subject":"TOOLS-2229 MG\u0027s launch-build script needs to adapt to lullaby-phase4 OS-7453 convert platform build to engbld framework Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e Approved by: Trent Mick \u003ctrent.mick@joyent.com\u003e","owner":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"url":"https://cr.joyent.us/6092","commitMessage":"TOOLS-2229 MG\u0027s launch-build script needs to adapt to lullaby-phase4\nOS-7453 convert platform build to engbld framework\nReviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\nApproved by: Trent Mick \u003ctrent.mick@joyent.com\u003e\n","createdOn":1554989196,"lastUpdated":1557953047,"open":false,"status":"MERGED","comments":[{"timestamp":1554989196,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 1."},{"timestamp":1554989484,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Topic set to lullaby-phase4"},{"timestamp":1555949639,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1556105053,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\n(4 comments)\n\nThanks for the review. I\u0027ll address these problems in the next patchset."},{"timestamp":1556105383,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1556110304,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 2."},{"timestamp":1556110365,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1556110410,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 3:\n\nThe changes here consist of:\n\nFix Makefile mismerge\nReorg launch-build code and remove \u0027timf-*\u0027 targets\nls-missing-release builds should add -F args for platform build flavor"},{"timestamp":1556318241,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1\n\n(2 comments)"},{"timestamp":1556544487,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 4."},{"timestamp":1556544735,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 5."},{"timestamp":1556544820,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 3:\n\n(2 comments)\n\nI\u0027ve pushed these changes to Patch set 5. An additional change included\nthere (only partly fixed in patch set 4), is that the format of the \u0027configure-projects\u0027 file has changed, such that it\u0027s now a 3-fields-per-line flat file.\n\nSee https://cr.joyent.us/#/c/6094/ for the discussion."},{"timestamp":1556890117,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 6."},{"timestamp":1556890203,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 6:\n\n\u003e Uploaded patch set 6.\n\nThe fixes here are to adapt to the forthcoming sdc-headnode build change, where we need to pass the CONFIGURE_BRANCHES parameter so that we use the correct artifacts when assembling the headnode build."},{"timestamp":1557786109,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6:\n\n(3 comments)"},{"timestamp":1557825843,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 6:\n\n(2 comments)"},{"timestamp":1557825849,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 7."},{"timestamp":1557862918,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 7: Code-Review+1 Integration-Approval+1"},{"timestamp":1557952267,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 8: Commit message was updated."},{"timestamp":1557953035,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 9: Patch Set 8 was rebased"},{"timestamp":1557953047,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Tim Foster"}],"currentPatchSet":{"number":"9","revision":"15da41a7b25fc67c4f344b2a560b295fa845544a","parents":["bb99da75b1f1ec198015a2b43dcb42bfa42085be"],"ref":"refs/changes/92/6092/9","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1557953035,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557862918,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557862918,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1557953047,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"tools/launch-build","type":"MODIFIED","insertions":55,"deletions":-12},{"file":"tools/ls-missing-release-builds","type":"MODIFIED","insertions":28,"deletions":-4},{"file":"tools/smartos-index","type":"DELETED","insertions":0,"deletions":-19},{"file":"tools/smartos-release","type":"DELETED","insertions":0,"deletions":-91}],"sizeInsertions":83,"sizeDeletions":-126},"patchSets":[{"number":"1","revision":"3e7a27d654420de2ddc065eec463416d38c7bdee","parents":["bb99da75b1f1ec198015a2b43dcb42bfa42085be"],"ref":"refs/changes/92/6092/1","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1554989196,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","comments":[{"file":"Makefile","line":2894,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This was an accidental change?"},{"file":"Makefile","line":2894,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Och, yes, thanks - will revert this."},{"file":"tools/launch-build","line":98,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: I would move this block up to just after line 87 where `BUILD_PARAM` is also being set/worked-on.\n\nThen the CRUMB_URL and CRUMB-setting lines will be next to each other as well."},{"file":"tools/launch-build","line":98,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Yep, will do."},{"file":"tools/launch-build","line":113,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is there still work to come for headnode[-joyent] launching? I\u0027m not sure if from the current state of https://jenkins.joyent.us/view/lullaby-phase4/job/timf-headnode-joyent/build?delay\u003d0sec whether you are adding a \"CONFIGURE_BRANCHES\" param to *headnode* builds as well."},{"file":"tools/launch-build","line":113,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"No, there\u0027s nothing additional needed here. The default of an empty CONFIGURE_BRANCHES parameter causes the build to use the value of $BRANCH to create the default build.spec.local file with the contents:\n\n{\"bits-branch\": \"$BRANCH\"}\n\nFor release builds where all components ought to be built from the same branch, this is all we need."},{"file":"tools/ls-missing-release-builds","line":90,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"The original intent (not sure if still used) was that the output of this tool would be runnable bash script. That\u0027s why the output of line 86 is prefixed with `#` to be a shell comment.\n\nAlso a nit: you have mixed tabs and spaces for indentation here."},{"file":"tools/ls-missing-release-builds","line":90,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Ah ok. Sounds like I should have the script error out on platform builds so that the user can run the launch-build script by hand with the correct -F argument to correspond to whatever type of release we\u0027re spinning.\n\nI\u0027ll fix the tabs vs. spaces problem too."},{"file":"tools/ls-missing-release-builds","line":90,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Actually, that\u0027s just making the user play fetch-a-rock. Better would be to have this script take an argument to denote a smartos-only build, and have it add the correct platform flavour argument by default."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/launch-build","type":"MODIFIED","insertions":53,"deletions":-12},{"file":"tools/ls-missing-release-builds","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"tools/smartos-index","type":"DELETED","insertions":0,"deletions":-19},{"file":"tools/smartos-release","type":"DELETED","insertions":0,"deletions":-91}],"sizeInsertions":59,"sizeDeletions":-125},{"number":"2","revision":"a8e1fd32aea57f2f4b5e0dfccc90c0b473ce9627","parents":["813a12eb0e7c72084fd2ecca91f2e111166348ef"],"ref":"refs/changes/92/6092/2","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1556110304,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"tools/launch-build","type":"MODIFIED","insertions":53,"deletions":-12},{"file":"tools/ls-missing-release-builds","type":"MODIFIED","insertions":28,"deletions":-4},{"file":"tools/smartos-index","type":"DELETED","insertions":0,"deletions":-19},{"file":"tools/smartos-release","type":"DELETED","insertions":0,"deletions":-91}],"sizeInsertions":81,"sizeDeletions":-126},{"number":"3","revision":"c75a6f4633903cb17a08164ff2e67b8e19f456d0","parents":["813a12eb0e7c72084fd2ecca91f2e111166348ef"],"ref":"refs/changes/92/6092/3","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1556110365,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556318241,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1556318241,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"tools/launch-build","line":53,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Still tim-y in here, if that matters. If it helps your dev, then fine with me."},{"file":"tools/launch-build","line":53,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Oops, no, at this point these can go. Thanks."},{"file":"tools/ls-missing-release-builds","line":63,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"tabs again in a spaces-kinda-file. Unfortunate that we have some in this repo using one and some the other."},{"file":"tools/ls-missing-release-builds","line":63,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Yep, will fix these."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"tools/launch-build","type":"MODIFIED","insertions":53,"deletions":-12},{"file":"tools/ls-missing-release-builds","type":"MODIFIED","insertions":28,"deletions":-4},{"file":"tools/smartos-index","type":"DELETED","insertions":0,"deletions":-19},{"file":"tools/smartos-release","type":"DELETED","insertions":0,"deletions":-91}],"sizeInsertions":81,"sizeDeletions":-126},{"number":"4","revision":"22f61e4905122f66ea0043206ad6d8f83fb4def4","parents":["813a12eb0e7c72084fd2ecca91f2e111166348ef"],"ref":"refs/changes/92/6092/4","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1556544487,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"tools/launch-build","type":"MODIFIED","insertions":80,"deletions":-12},{"file":"tools/ls-missing-release-builds","type":"MODIFIED","insertions":28,"deletions":-4},{"file":"tools/smartos-index","type":"DELETED","insertions":0,"deletions":-19},{"file":"tools/smartos-release","type":"DELETED","insertions":0,"deletions":-91}],"sizeInsertions":108,"sizeDeletions":-126},{"number":"5","revision":"cfd37dce3ae769ac15436c35ab3fc4ba041db7ff","parents":["813a12eb0e7c72084fd2ecca91f2e111166348ef"],"ref":"refs/changes/92/6092/5","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1556544735,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"tools/launch-build","type":"MODIFIED","insertions":81,"deletions":-12},{"file":"tools/ls-missing-release-builds","type":"MODIFIED","insertions":28,"deletions":-4},{"file":"tools/smartos-index","type":"DELETED","insertions":0,"deletions":-19},{"file":"tools/smartos-release","type":"DELETED","insertions":0,"deletions":-91}],"sizeInsertions":109,"sizeDeletions":-126},{"number":"6","revision":"fb8f13952f76833531623ce901baeef7bb62fbb4","parents":["813a12eb0e7c72084fd2ecca91f2e111166348ef"],"ref":"refs/changes/92/6092/6","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1556890117,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","comments":[{"file":"tools/launch-build","line":42,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Feel free to assert ye olde English and use `FLAVOUR`. ;)"},{"file":"tools/launch-build","line":93,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I don\u0027t understand the issue here.\n\n... oh. Is the issue that calling Jenkins simply with BRANCH\u003d$BRANCH would result in just using the $BRANCH of smartos-live and still using branch \"master\" for the other constituent repos? And less about whether it is the long-form branch string \"refs/remotes/origin/$BRANCH\" rather than the short-form \"$BRANCH\"?"},{"file":"tools/launch-build","line":93,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"No, that would be fine, but you\u0027re in the right ballpark.\n\nHere I\u0027m really lamenting that we have to pass this parameter from launch-build at all.\n\nI\u0027m trying to say that it\u0027d be nice if we could just have the smartos-live Jenkins job be configured to set \"CONFIGURE_PROJECTS\" to a value that simply references \u0027${BRANCH}\u0027, which would work fine when called from launch-build, but not for jobs users might start from the Jenkins user interface.\n\nThe problem is that while \"release-20190514\" is likely to be unambiguous for release builds, \"master\" is probably ambiguous, given \u0027cr\u0027 and \u0027origin\u0027 remotes, and so for Jenkins jobs, we must default \u0027BRANCH\u0027 to \u0027refs/remotes/origin/master\u0027\n\nSo in https://jenkins.joyent.us/view/lullaby-phase4/job/timf-platform/build , CONFIGURE_PROJECTS must default to \n\nillumos-extra: master: origin\nillumos: master: origin\nlocal/kvm-cmd: master: origin\nlocal/kvm: master: origin\nlocal/mdata-client: master: origin\nlocal/ur-agent: master: origin\n\nCallers have to separately set $BRANCH and $CONFIGURE_PROJECTS\n\nI\u0027ll modify the comment to try to explain better."},{"file":"tools/launch-build","line":155,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Accidentally duplicated this whole block?"},{"file":"tools/launch-build","line":155,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Och, sorry, yes."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"tools/launch-build","type":"MODIFIED","insertions":85,"deletions":-12},{"file":"tools/ls-missing-release-builds","type":"MODIFIED","insertions":28,"deletions":-4},{"file":"tools/smartos-index","type":"DELETED","insertions":0,"deletions":-19},{"file":"tools/smartos-release","type":"DELETED","insertions":0,"deletions":-91}],"sizeInsertions":113,"sizeDeletions":-126},{"number":"7","revision":"a099322a5d88232804da5835b7c6ac3c70e6059a","parents":["813a12eb0e7c72084fd2ecca91f2e111166348ef"],"ref":"refs/changes/92/6092/7","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1557825849,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557862918,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557862918,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"tools/launch-build","type":"MODIFIED","insertions":55,"deletions":-12},{"file":"tools/ls-missing-release-builds","type":"MODIFIED","insertions":28,"deletions":-4},{"file":"tools/smartos-index","type":"DELETED","insertions":0,"deletions":-19},{"file":"tools/smartos-release","type":"DELETED","insertions":0,"deletions":-91}],"sizeInsertions":83,"sizeDeletions":-126},{"number":"8","revision":"5501983ea22bf779923b55097fbd33ddb8a33ffb","parents":["813a12eb0e7c72084fd2ecca91f2e111166348ef"],"ref":"refs/changes/92/6092/8","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1557952267,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557862918,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557862918,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"tools/launch-build","type":"MODIFIED","insertions":55,"deletions":-12},{"file":"tools/ls-missing-release-builds","type":"MODIFIED","insertions":28,"deletions":-4},{"file":"tools/smartos-index","type":"DELETED","insertions":0,"deletions":-19},{"file":"tools/smartos-release","type":"DELETED","insertions":0,"deletions":-91}],"sizeInsertions":83,"sizeDeletions":-126},{"number":"9","revision":"15da41a7b25fc67c4f344b2a560b295fa845544a","parents":["bb99da75b1f1ec198015a2b43dcb42bfa42085be"],"ref":"refs/changes/92/6092/9","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1557953035,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557862918,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557862918,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1557953047,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"tools/launch-build","type":"MODIFIED","insertions":55,"deletions":-12},{"file":"tools/ls-missing-release-builds","type":"MODIFIED","insertions":28,"deletions":-4},{"file":"tools/smartos-index","type":"DELETED","insertions":0,"deletions":-19},{"file":"tools/smartos-release","type":"DELETED","insertions":0,"deletions":-91}],"sizeInsertions":83,"sizeDeletions":-126}],"allReviewers":[{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}]}