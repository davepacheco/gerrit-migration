commit 8f72c41d32cbeb3c64ec79ca79fd5de102bdf478 (refs/changes/08/4008/2)
Author: Josh Wilsdon <josh@wilsdon.ca>
Date:   2018-05-25T11:24:32-07:00 (1 year, 4 months ago)
    
    TRITON-432 cn-agent should ignore non-log entries in stdio.log

diff --git a/lib/backends/smartos/lib/docker-stdio.js b/lib/backends/smartos/lib/docker-stdio.js
index 9a6289f..023e0cf 100644
--- a/lib/backends/smartos/lib/docker-stdio.js
+++ b/lib/backends/smartos/lib/docker-stdio.js
@@ -1304,7 +1304,9 @@ function runContainerLogsCommand(container, params, socket) {
     });
 
     lstream.on('readable', function runContainerLogsCommandOnReadable() {
+        var data;
         var line;
+        var rec;
 
         while ((line = lstream.read()) != null) {
             line = line.trim();
@@ -1318,20 +1320,21 @@ function runContainerLogsCommand(container, params, socket) {
                 break;
             }
 
-            var rec = JSON.parse(line);
-            var data;
-            if (params.Timestamps) {
-                data = rec.time + ' ' + rec.log;
-            } else {
-                data = rec.log;
-            }
+            rec = JSON.parse(line);
+            if (rec.log) { // only include entries that are stdio logs
+                if (params.Timestamps) {
+                    data = rec.time + ' ' + rec.log;
+                } else {
+                    data = rec.log;
+                }
 
-            writeData({
-                log: log,
-                streamType: rec.stream,
-                stream: socket,
-                chunk: data.toString()
-            });
+                writeData({
+                    log: log,
+                    streamType: rec.stream,
+                    stream: socket,
+                    chunk: data.toString()
+                });
+            }
         }
     });
 
diff --git a/package.json b/package.json
index fe64b85..83bc438 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "cn-agent",
   "description": "Triton Compute Node Agent",
-  "version": "2.1.1",
+  "version": "2.1.2",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
