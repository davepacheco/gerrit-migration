From c5e8bed1f0781b5296a5fb282615d19f2511ed91 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Fri, 25 May 2018 11:13:07 -0700
Subject: [PATCH] TRITON-432 cn-agent should ignore non-log entries in
 stdio.log

---
 lib/backends/smartos/lib/docker-stdio.js | 29 +++++++++++++-----------
 1 file changed, 16 insertions(+), 13 deletions(-)

diff --git a/lib/backends/smartos/lib/docker-stdio.js b/lib/backends/smartos/lib/docker-stdio.js
index 9a6289f..023e0cf 100644
--- a/lib/backends/smartos/lib/docker-stdio.js
+++ b/lib/backends/smartos/lib/docker-stdio.js
@@ -1304,7 +1304,9 @@ function runContainerLogsCommand(container, params, socket) {
     });
 
     lstream.on('readable', function runContainerLogsCommandOnReadable() {
+        var data;
         var line;
+        var rec;
 
         while ((line = lstream.read()) != null) {
             line = line.trim();
@@ -1318,20 +1320,21 @@ function runContainerLogsCommand(container, params, socket) {
                 break;
             }
 
-            var rec = JSON.parse(line);
-            var data;
-            if (params.Timestamps) {
-                data = rec.time + ' ' + rec.log;
-            } else {
-                data = rec.log;
-            }
+            rec = JSON.parse(line);
+            if (rec.log) { // only include entries that are stdio logs
+                if (params.Timestamps) {
+                    data = rec.time + ' ' + rec.log;
+                } else {
+                    data = rec.log;
+                }
 
-            writeData({
-                log: log,
-                streamType: rec.stream,
-                stream: socket,
-                chunk: data.toString()
-            });
+                writeData({
+                    log: log,
+                    streamType: rec.stream,
+                    stream: socket,
+                    chunk: data.toString()
+                });
+            }
         }
     });
 
-- 
2.21.0

