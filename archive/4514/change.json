{"project":"joyent/sdc-napi-ufds-watcher","branch":"master","id":"I0770da9c1e1a0d831814fdb544a620c3ca78be2f","number":"4514","subject":"TRITON-170 napi-ufds-watcher should retry when failing to list default VLAN Reviewed by: Marsell Kukuljevic \u003cmarsell@joyent.com\u003e Approved by: Marsell Kukuljevic \u003cmarsell@joyent.com\u003e","owner":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"url":"https://cr.joyent.us/4514","commitMessage":"TRITON-170 napi-ufds-watcher should retry when failing to list default VLAN\nReviewed by: Marsell Kukuljevic \u003cmarsell@joyent.com\u003e\nApproved by: Marsell Kukuljevic \u003cmarsell@joyent.com\u003e\n","createdOn":1531496875,"lastUpdated":1532643776,"open":false,"status":"MERGED","comments":[{"timestamp":1531496875,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Uploaded patch set 1."},{"timestamp":1531496902,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1531858864,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Uploaded patch set 2."},{"timestamp":1531858894,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1531920058,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 2:\n\n(4 comments)\n\nLGTM. Just some trivial bikeshedding."},{"timestamp":1532125882,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Patch Set 2:\n\n(4 comments)\n\nHey, thanks for taking look. Made the suggested changes."},{"timestamp":1532126211,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Uploaded patch set 3."},{"timestamp":1532126237,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1532190168,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 3:\n\n(3 comments)\n\nDetails about testing?"},{"timestamp":1532383491,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Patch Set 3:\n\n(3 comments)\n\nThanks for taking a look. Left a note about my suspicions regarding the XXX-comment. Will push code soon-ish."},{"timestamp":1532385121,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Patch Set 3:\n\n(1 comment)\n\nRequest for clarification ;)"},{"timestamp":1532385970,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Uploaded patch set 4."},{"timestamp":1532385996,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1532467410,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Patch Set 4:\n\nJust an update: added brief testing note to JIRA ticket."},{"timestamp":1532509480,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1532643606,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Patch Set 5: Commit message was updated."},{"timestamp":1532643776,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Nick Zivkovic"}],"currentPatchSet":{"number":"5","revision":"2332b5cc82d4064888e86c69979ad52df3a10cff","parents":["c41edaa852414a628e41ae6b133db08e9700ab4b"],"ref":"refs/changes/14/4514/5","uploader":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"createdOn":1532643606,"author":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532385996,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1532509480,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1532509480,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"SUBM","value":"1","grantedOn":1532643776,"by":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/default-fabric-setup.js","type":"MODIFIED","insertions":109,"deletions":-67}],"sizeInsertions":109,"sizeDeletions":-67},"patchSets":[{"number":"1","revision":"ea17ea54431cae31988429a45be46f03027de414","parents":["c41edaa852414a628e41ae6b133db08e9700ab4b"],"ref":"refs/changes/14/4514/1","uploader":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"createdOn":1531496875,"author":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1531496902,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/default-fabric-setup.js","line":178,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/default-fabric-setup.js","type":"MODIFIED","insertions":100,"deletions":-49}],"sizeInsertions":100,"sizeDeletions":-49},{"number":"2","revision":"382ffcafad33c592d861fd5b8dd6e8a03c510402","parents":["c41edaa852414a628e41ae6b133db08e9700ab4b"],"ref":"refs/changes/14/4514/2","uploader":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"createdOn":1531858864,"author":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1531858894,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/default-fabric-setup.js","line":51,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"This appears seven times in this func. I\u0027d prolly assign it to its own var."},{"file":"lib/default-fabric-setup.js","line":51,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Done"},{"file":"lib/default-fabric-setup.js","line":78,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Why not \"var defaultVlanList \u003d ...\"?"},{"file":"lib/default-fabric-setup.js","line":78,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Because then the line goes over 80 columns, and this variant looks better (to me) than breaking the line at the function-definition."},{"file":"lib/default-fabric-setup.js","line":103,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"This could be replaced with:\n\n    if (defaultVlanList.length \u003d\u003d\u003d 0) {\n        self.log.info({ user: _opts.uuid },\n            \u0027Default vlan does not exist for user\u0027);\n    } else {\n        assert.ok(defaultVlanList.length \u003d\u003d\u003d 1);\n        _opts.defaultVlan \u003d defaultVlanList[0];\n        self.log.info({ vlan: _opts.defaultVlan, user: _opts.uuid },\n            \u0027Default vlan exists for user\u0027);\n    }\n\n    cb();\n    return;"},{"file":"lib/default-fabric-setup.js","line":103,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Done"},{"file":"lib/default-fabric-setup.js","line":150,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Same comments for findDetfaultVlan() apply to this function."},{"file":"lib/default-fabric-setup.js","line":150,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/default-fabric-setup.js","type":"MODIFIED","insertions":102,"deletions":-49}],"sizeInsertions":102,"sizeDeletions":-49},{"number":"3","revision":"b1c7fbb4420f421187497e3751d15f4dfe5d202a","parents":["c41edaa852414a628e41ae6b133db08e9700ab4b"],"ref":"refs/changes/14/4514/3","uploader":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"createdOn":1532126211,"author":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532126237,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/default-fabric-setup.js","line":50,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Trivial: inconsistent local casing.\n\nuser_uuid, but also defaultVlanList?"},{"file":"lib/default-fabric-setup.js","line":50,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Done"},{"file":"lib/default-fabric-setup.js","line":50,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Not sure what you mean with regard to defaultVlanList. It follows the casing conventions present in the code before I started modifying it. That said, the napi-client methods use VLAN instead of Vlan, so maybe that\u0027s what you\u0027re referring to?"},{"file":"lib/default-fabric-setup.js","line":64,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Trivial: could get rid of a bunch of selfs in self.log by assigning to \u0027log\u0027 in DefaultFabricSetupStream()s prologue, if you\u0027re so inclined."},{"file":"lib/default-fabric-setup.js","line":64,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Done"},{"file":"lib/default-fabric-setup.js","line":182,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Elaborate?"},{"file":"lib/default-fabric-setup.js","line":182,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"This comment was in the original code. I myself am not completely sure what was meant by the original author. It was added in commit 0e71e67b, in 2015. In that same commit, there was another analogous comment for VLANs, which has since been deleted. It was deleted in commit 2b92c0bf.  That commit split the createDefaultNetwork function into findDefaultNetwork and createDefaultNetwork. Notably, it made the creation retry-able. Ditto for VLANs. I suspect that this comment is no longer valid for networks either, and was simply forgotten there. I will remove it, since it seems vestigial."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/default-fabric-setup.js","type":"MODIFIED","insertions":105,"deletions":-63}],"sizeInsertions":105,"sizeDeletions":-63},{"number":"4","revision":"0770da9c1e1a0d831814fdb544a620c3ca78be2f","parents":["c41edaa852414a628e41ae6b133db08e9700ab4b"],"ref":"refs/changes/14/4514/4","uploader":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"createdOn":1532385970,"author":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532385996,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1532509480,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1532509480,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/default-fabric-setup.js","type":"MODIFIED","insertions":109,"deletions":-67}],"sizeInsertions":109,"sizeDeletions":-67},{"number":"5","revision":"2332b5cc82d4064888e86c69979ad52df3a10cff","parents":["c41edaa852414a628e41ae6b133db08e9700ab4b"],"ref":"refs/changes/14/4514/5","uploader":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"createdOn":1532643606,"author":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532385996,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1532643776,"by":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1532509480,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1532509480,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/default-fabric-setup.js","type":"MODIFIED","insertions":109,"deletions":-67}],"sizeInsertions":109,"sizeDeletions":-67}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"}]}