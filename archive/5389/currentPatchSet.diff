From d3c3ea81fffb0df23d22ede731d2e6bdd7384073 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Fri, 18 Jan 2019 14:30:44 -0800
Subject: [PATCH] TRITON-1082 hermes-proxy should not run itself out of files
 and memory Reviewed by: Trent Mick <trentm@gmail.com> Approved by: Trent Mick
 <trentm@gmail.com>

---
 lib/proxy_server.js | 12 +++++++++++-
 package.json        |  2 +-
 2 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/lib/proxy_server.js b/lib/proxy_server.js
index 232222b..fc66e09 100644
--- a/lib/proxy_server.js
+++ b/lib/proxy_server.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2017 Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 var mod_assert = require('assert-plus');
@@ -275,10 +275,19 @@ _make_conn(name, port, callback)
 		log.warn('socket timeout; destroying');
 		conn.destroy();
 	});
+
 	conn.on('error', function (err) {
 		log.warn({
 			err: err
 		}, 'connection error');
+
+		/*
+		 * Clear the timeout since we'll try again immediately and
+		 * don't want the setTimeout callback to *also* try again for
+		 * this same connection.
+		 */
+		clearTimeout(to);
+
 		conn.removeAllListeners();
 
 		/*
@@ -286,6 +295,7 @@ _make_conn(name, port, callback)
 		 */
 		self._make_conn(name, port, callback);
 	});
+
 	conn.on('close', function (had_error) {
 		log.debug({
 			had_error: had_error
diff --git a/package.json b/package.json
index 7eadcfa..c058c03 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "hermes",
-  "version": "0.3.0",
+  "version": "0.3.1",
   "description": "Centralised tool to upload SDC logs to Manta",
   "main": "hermes.js",
   "author": "Joshua M. Clulow <jmc@joyent.com>",
-- 
2.21.0

