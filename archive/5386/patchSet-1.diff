From 00c03b7a44bee8052969b97944e3606b4adea844 Mon Sep 17 00:00:00 2001
From: Rui Loura <rui@joyent.com>
Date: Fri, 18 Jan 2019 15:39:42 -0500
Subject: [PATCH] TRITON-1094 isNet() functions should be more compatible with
 network pools

---
 CHANGES.md              |  4 +++
 lib/index.js            | 33 ++++++++++++++++++--
 package.json            |  2 +-
 test/unit/main.test.js  | 29 ++++++++++++++++++
 test/unit/testdata.json | 67 +++++++++++++++++++++++++++++++++++++++++
 5 files changed, 131 insertions(+), 4 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index e710887..3239c8b 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -4,6 +4,10 @@
 
 (nothing yet)
 
+## 1.2.0
+
+* TRITON-1094 isNet() functions should be more compatible with network pools
+
 ## 1.1.0
 
 * TRITON-1073 adminIpFromNicsArray in node-triton-netconfig
diff --git a/lib/index.js b/lib/index.js
index 3fbc6ce..fd99cb0 100644
--- a/lib/index.js
+++ b/lib/index.js
@@ -46,6 +46,33 @@ function _isNetNicCommon(nic, network) {
     return re.test(nic.nic_tag);
 }
 
+function _isNetCommon(net, name) {
+    if (net.name === name) {
+        return true;
+    }
+
+    if (_isNetNicCommon(net, name)) {
+        return true;
+    }
+
+    if (net.nic_tags_present) {
+        if (net.nic_tags_present.indexOf(name) !== -1) {
+            return true;
+        }
+
+        var re = new RegExp('^' + name + RACK_RE, 'i');
+        var tagsLen = net.nic_tags_present.length;
+
+        for (var i = 0; i < tagsLen; i++) {
+            if (re.test(net.nic_tags_present[i])) {
+                return true;
+            }
+        }
+    }
+
+    return false;
+}
+
 // ---- Exports
 
 /*
@@ -136,15 +163,15 @@ function isNicExternal(nic) {
 // ---- isNet
 
 function isNetAdmin(net) {
-    return _isNetNicCommon(net, ADMIN_NAME);
+    return _isNetCommon(net, ADMIN_NAME);
 }
 
 function isNetExternal(net) {
-    return _isNetNicCommon(net, EXTERNAL_NAME);
+    return _isNetCommon(net, EXTERNAL_NAME);
 }
 
 function isNetInternal(net) {
-    return _isNetNicCommon(net, INTERNAL_NAME);
+    return _isNetCommon(net, INTERNAL_NAME);
 }
 
 module.exports = {
diff --git a/package.json b/package.json
index 17e6138..051280c 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "triton-netconfig",
-  "version": "1.1.0",
+  "version": "1.2.0",
   "description": "Common methods for managing Triton network configuration",
   "repository": {
     "type": "git",
diff --git a/test/unit/main.test.js b/test/unit/main.test.js
index 115d57b..3485d5e 100644
--- a/test/unit/main.test.js
+++ b/test/unit/main.test.js
@@ -1,4 +1,5 @@
 /*
+ * d
  * This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/.
@@ -16,6 +17,7 @@ const jsprim = require('jsprim');
 
 const VMS = data['vms'];
 const NETS = data['nets'];
+const POOLS = data['pools'];
 const SYSINFO = data['sysinfo'];
 const NICS = data['nics'];
 
@@ -42,6 +44,33 @@ tap.test('nets', function (tt) {
     tt.end();
 });
 
+tap.test('pools', function (tt) {
+    tt.test('isNet', function (t) {
+        const basic = POOLS['basic_external'];
+        const rack_reg_external = POOLS['rack_with_reg_pool'];
+        const tags_present = POOLS['tags_present_external'];
+        const rack_tags_present = POOLS['tags_present_rack_external'];
+        const not_external = POOLS['not_external'];
+
+        t.ok(netconf.isNetExternal(basic));
+        t.ok(netconf.isNetExternal(rack_reg_external));
+        t.ok(netconf.isNetExternal(tags_present));
+        t.ok(netconf.isNetExternal(rack_tags_present));
+
+        t.notOk(netconf.isNetAdmin(basic));
+        t.notOk(netconf.isNetAdmin(rack_reg_external));
+        t.notOk(netconf.isNetAdmin(tags_present));
+        t.notOk(netconf.isNetAdmin(rack_tags_present));
+
+        t.notOk(netconf.isNetExternal(not_external));
+        t.notOk(netconf.isNetInternal(basic));
+
+        t.end();
+    });
+
+    tt.end();
+});
+
 tap.test('vms', function (tt) {
     tt.test('main', function (t) {
         const main_vm = VMS['main'];
diff --git a/test/unit/testdata.json b/test/unit/testdata.json
index e2a4c13..901554c 100644
--- a/test/unit/testdata.json
+++ b/test/unit/testdata.json
@@ -426,6 +426,73 @@
             }
         }
     },
+    "pools": {
+      "rack_with_reg_pool": {
+        "family": "ipv4",
+        "uuid": "ff4e2059-dfec-44ea-a735-c9efdded98c6",
+        "name": "external",
+        "networks": [
+          "2c606372-fa8d-452d-a93c-e4e98b98bda5",
+          "f769454f-31f1-4e4b-b191-c2876b6814bb"
+        ],
+        "nic_tags_present": [
+          "external",
+          "external_rack_e50"
+        ],
+        "nic_tag": "external"
+      },
+      "basic_external": {
+        "family": "ipv4",
+        "uuid": "5065943d-fa70-4eb3-8b74-2b1ecbbfe51e",
+        "name": "sdc_nat",
+        "networks": [
+          "2c606372-fa8d-452d-a93c-e4e98b98bda5"
+        ],
+        "nic_tags_present": [
+          "external"
+        ],
+        "nic_tag": "external"
+      },
+      "tags_present_external": {
+        "family": "ipv4",
+        "uuid": "5065943d-fa70-4eb3-8b74-2b1ecbbfe51e",
+        "name": "sdc_nat",
+        "networks": [
+          "2c606372-fa8d-452d-a93c-e4e98b98bda5"
+        ],
+        "nic_tags_present": [
+          "foo",
+          "external"
+        ],
+        "nic_tag": "foo"
+      },
+      "tags_present_rack_external": {
+        "family": "ipv4",
+        "uuid": "5065943d-fa70-4eb3-8b74-2b1ecbbfe51e",
+        "name": "sdc_nat",
+        "networks": [
+          "2c606372-fa8d-452d-a93c-e4e98b98bda5"
+        ],
+        "nic_tags_present": [
+          "foo",
+          "external_rack_e20"
+        ],
+        "nic_tag": "foo"
+      },
+      "not_external": {
+        "family": "ipv4",
+        "uuid": "5065943d-fa70-4eb3-8b74-2b1ecbbfe51e",
+        "name": "sdc_nat",
+        "networks": [
+          "2c606372-fa8d-452d-a93c-e4e98b98bda5"
+        ],
+        "nic_tags_present": [
+          "foo",
+          "rack_e20"
+        ],
+        "nic_tag": "foo"
+      }
+    },
     "nets": {
         "external_mainnet": {
             "family": "ipv4",
-- 
2.21.0

