From 0f611b196acb6517fd95e26a391257b5e05f2b52 Mon Sep 17 00:00:00 2001
From: Rui Loura <rui@joyent.com>
Date: Fri, 18 Jan 2019 15:39:42 -0500
Subject: [PATCH] TRITON-1094 isNet() functions should be more compatible with
 network pools

---
 CHANGES.md              |  4 ++
 lib/index.js            | 45 +++++++++++++++++++++--
 package.json            |  2 +-
 test/unit/main.test.js  | 32 ++++++++++++++++
 test/unit/testdata.json | 81 +++++++++++++++++++++++++++++++++++++++++
 5 files changed, 159 insertions(+), 5 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index e710887..3239c8b 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -4,6 +4,10 @@
 
 (nothing yet)
 
+## 1.2.0
+
+* TRITON-1094 isNet() functions should be more compatible with network pools
+
 ## 1.1.0
 
 * TRITON-1073 adminIpFromNicsArray in node-triton-netconfig
diff --git a/lib/index.js b/lib/index.js
index 3fbc6ce..583ffbf 100644
--- a/lib/index.js
+++ b/lib/index.js
@@ -46,6 +46,39 @@ function _isNetNicCommon(nic, network) {
     return re.test(nic.nic_tag);
 }
 
+/*
+ * Ideally we'd use RFD117 traits here, but until then this function will
+ * return true if one or more of the folllowing conditions are met:
+ *
+ *    1. Network name is the same as the network being tested.
+ *    2. nic_tag matches the form "<network name>_rack_<rack id>"
+ *       (see RACK_RE above).
+ *    3. If it is a network pool and one of the nictags in the nic_tags_present
+ *       array matches the RACK_RE.
+ */
+function _isNetCommon(net, name) {
+    if (net.name === name) {
+        return true;
+    }
+
+    if (_isNetNicCommon(net, name)) {
+        return true;
+    }
+
+    if (net.nic_tags_present) {
+        var re = new RegExp('^' + name + RACK_RE, 'i');
+        var tagsLen = net.nic_tags_present.length;
+
+        for (var i = 0; i < tagsLen; i++) {
+            if (re.test(net.nic_tags_present[i])) {
+                return true;
+            }
+        }
+    }
+
+    return false;
+}
+
 // ---- Exports
 
 /*
@@ -78,7 +111,11 @@ function adminNicFromSysinfo(sysinfo) {
 }
 
 /*
- * Given a CN's sysinfo in JSON format return the admin IP.
+ * Given a CN's sysinfo in JSON format return the admin IP.  Methods for
+ * determing the admin IP in order of preference below:
+ *
+ *     1. If the 'Admin IP' property is present use that.
+ *     2. Find the admin IP the legacy way, from the list of interfaces.
  */
 function adminIpFromSysinfo(sysinfo) {
     if (sysinfo['Admin IP']) {
@@ -136,15 +173,15 @@ function isNicExternal(nic) {
 // ---- isNet
 
 function isNetAdmin(net) {
-    return _isNetNicCommon(net, ADMIN_NAME);
+    return _isNetCommon(net, ADMIN_NAME);
 }
 
 function isNetExternal(net) {
-    return _isNetNicCommon(net, EXTERNAL_NAME);
+    return _isNetCommon(net, EXTERNAL_NAME);
 }
 
 function isNetInternal(net) {
-    return _isNetNicCommon(net, INTERNAL_NAME);
+    return _isNetCommon(net, INTERNAL_NAME);
 }
 
 module.exports = {
diff --git a/package.json b/package.json
index 17e6138..051280c 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "triton-netconfig",
-  "version": "1.1.0",
+  "version": "1.2.0",
   "description": "Common methods for managing Triton network configuration",
   "repository": {
     "type": "git",
diff --git a/test/unit/main.test.js b/test/unit/main.test.js
index 115d57b..a02b709 100644
--- a/test/unit/main.test.js
+++ b/test/unit/main.test.js
@@ -16,6 +16,7 @@ const jsprim = require('jsprim');
 
 const VMS = data['vms'];
 const NETS = data['nets'];
+const POOLS = data['pools'];
 const SYSINFO = data['sysinfo'];
 const NICS = data['nics'];
 
@@ -42,6 +43,36 @@ tap.test('nets', function (tt) {
     tt.end();
 });
 
+tap.test('pools', function (tt) {
+    tt.test('isNet', function (t) {
+        const basic = POOLS['basic_external'];
+        const rack_reg_external = POOLS['rack_with_reg_pool'];
+        const tags_present = POOLS['tags_present_external'];
+        const rack_tags_present = POOLS['tags_present_rack_external'];
+        const not_external = POOLS['not_external'];
+        const admin_rack = POOLS['admin_rack'];
+
+        t.ok(netconf.isNetExternal(basic));
+        t.ok(netconf.isNetExternal(rack_reg_external));
+        t.ok(netconf.isNetExternal(tags_present));
+        t.ok(netconf.isNetExternal(rack_tags_present));
+        t.notOk(netconf.isNetExternal(admin_rack));
+
+        t.ok(netconf.isNetAdmin(admin_rack));
+        t.notOk(netconf.isNetAdmin(basic));
+        t.notOk(netconf.isNetAdmin(rack_reg_external));
+        t.notOk(netconf.isNetAdmin(tags_present));
+        t.notOk(netconf.isNetAdmin(rack_tags_present));
+
+        t.notOk(netconf.isNetExternal(not_external));
+        t.notOk(netconf.isNetInternal(basic));
+
+        t.end();
+    });
+
+    tt.end();
+});
+
 tap.test('vms', function (tt) {
     tt.test('main', function (t) {
         const main_vm = VMS['main'];
@@ -152,6 +183,7 @@ tap.test('sysinfo', function (tt) {
 
         t.end();
     });
+
     tt.end();
 });
 
diff --git a/test/unit/testdata.json b/test/unit/testdata.json
index e2a4c13..65a1adf 100644
--- a/test/unit/testdata.json
+++ b/test/unit/testdata.json
@@ -426,6 +426,87 @@
             }
         }
     },
+    "pools": {
+      "rack_with_reg_pool": {
+        "family": "ipv4",
+        "uuid": "ff4e2059-dfec-44ea-a735-c9efdded98c6",
+        "name": "external",
+        "networks": [
+          "2c606372-fa8d-452d-a93c-e4e98b98bda5",
+          "f769454f-31f1-4e4b-b191-c2876b6814bb"
+        ],
+        "nic_tags_present": [
+          "external",
+          "external_rack_e50"
+        ],
+        "nic_tag": "external"
+      },
+      "basic_external": {
+        "family": "ipv4",
+        "uuid": "5065943d-fa70-4eb3-8b74-2b1ecbbfe51e",
+        "name": "sdc_nat",
+        "networks": [
+          "2c606372-fa8d-452d-a93c-e4e98b98bda5"
+        ],
+        "nic_tags_present": [
+          "external"
+        ],
+        "nic_tag": "external"
+      },
+      "tags_present_external": {
+        "family": "ipv4",
+        "uuid": "5065943d-fa70-4eb3-8b74-2b1ecbbfe51e",
+        "name": "sdc_nat",
+        "networks": [
+          "2c606372-fa8d-452d-a93c-e4e98b98bda5"
+        ],
+        "nic_tags_present": [
+          "foo",
+          "external"
+        ],
+        "nic_tag": "foo"
+      },
+      "tags_present_rack_external": {
+        "family": "ipv4",
+        "uuid": "5065943d-fa70-4eb3-8b74-2b1ecbbfe51e",
+        "name": "sdc_nat",
+        "networks": [
+          "2c606372-fa8d-452d-a93c-e4e98b98bda5"
+        ],
+        "nic_tags_present": [
+          "foo",
+          "external_rack_e20"
+        ],
+        "nic_tag": "foo"
+      },
+      "not_external": {
+        "family": "ipv4",
+        "uuid": "5065943d-fa70-4eb3-8b74-2b1ecbbfe51e",
+        "name": "sdc_nat",
+        "networks": [
+          "2c606372-fa8d-452d-a93c-e4e98b98bda5"
+        ],
+        "nic_tags_present": [
+          "foo",
+          "rack_e20"
+        ],
+        "nic_tag": "foo"
+      },
+      "admin_rack": {
+        "family": "ipv4",
+        "uuid": "7dfa5ff8-2c59-4c7b-bfa4-d2c243e098af",
+        "name": "admin",
+        "networks": [
+          "0a4d08a1-8e7f-48aa-9a68-91bdf2edd93e",
+          "ef5461db-7a70-4920-b6fb-e5c4b9918de2"
+        ],
+        "nic_tags_present": [
+          "admin",
+          "admin_rack_e50"
+        ],
+        "nic_tag": "admin"
+      }
+    },
     "nets": {
         "external_mainnet": {
             "family": "ipv4",
-- 
2.21.0

