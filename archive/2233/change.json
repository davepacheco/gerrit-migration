{"project":"joyent/manatee","branch":"master","id":"Id04c4c89ca05a6cd22dba5e311e5290a0fa3ab88","number":"2233","subject":"MANATEE-304 manatee doesn\u0027t always come up with very large datasets","owner":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"url":"https://cr.joyent.us/2233","commitMessage":"MANATEE-304 manatee doesn\u0027t always come up with very large datasets\n","createdOn":1500479461,"lastUpdated":1571214608,"open":false,"status":"ABANDONED","comments":[{"timestamp":1500479461,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 1."},{"timestamp":1500479494,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1500479648,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 1: Code-Review-1\n\nI\u0027m marking this -1 as it\u0027s not complete (see below) but at least acts as a place for people to comment if there are other opinions.\n\nAs mentioned in MANATEE-304, we need to assert that the ZFS dataset is mounted prior to attempting to \"rm -rf\" the directory so that a `manatee-adm rebuild` will always perform a full restore, but this change doesn\u0027t yet include that piece."},{"timestamp":1500635622,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 2."},{"timestamp":1500635652,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1500650458,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 2: -Code-Review"},{"timestamp":1501661252,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 2:\n\nTo confirm: I now consider this ready for review (see notes in MANATEE-304)."},{"timestamp":1504081224,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 3."},{"timestamp":1504081255,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1504132237,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3:\n\n(4 comments)"},{"timestamp":1504165945,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 4."},{"timestamp":1504165976,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1504166901,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 4:\n\n(4 comments)"},{"timestamp":1505386069,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 5."},{"timestamp":1505386100,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1505386301,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1507803409,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1571214608,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Abandoned\n\nThe prefaulter has obviated this particular solution. It\u0027s probably something we still want, but it hasn\u0027t been an issue in practice for some time."}],"currentPatchSet":{"number":"5","revision":"d04c4c89ca05a6cd22dba5e311e5290a0fa3ab88","parents":["c525bc705fff52644471bd5c9ab7286ca368dbfb"],"ref":"refs/changes/33/2233/5","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1505386069,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505386100,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":18,"deletions":-6},{"file":"lib/postgresMgr.js","type":"MODIFIED","insertions":2,"deletions":-6}],"sizeInsertions":20,"sizeDeletions":-12},"patchSets":[{"number":"1","revision":"9acaf3feb0ebd0987945bd6663f379491ecd1613","parents":["c525bc705fff52644471bd5c9ab7286ca368dbfb"],"ref":"refs/changes/33/2233/1","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1500479461,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1500479494,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1500479648,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/postgresMgr.js","type":"MODIFIED","insertions":1,"deletions":-5}],"sizeInsertions":1,"sizeDeletions":-5},{"number":"2","revision":"ee08379760b72108e1f0298a8b4da9fdf051dcc4","parents":["c525bc705fff52644471bd5c9ab7286ca368dbfb"],"ref":"refs/changes/33/2233/2","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1500635622,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1500635652,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":17,"deletions":-6},{"file":"lib/postgresMgr.js","type":"MODIFIED","insertions":1,"deletions":-5}],"sizeInsertions":18,"sizeDeletions":-11},{"number":"3","revision":"997569ce18ad109d3456675ac443f9c5ab84c448","parents":["c525bc705fff52644471bd5c9ab7286ca368dbfb"],"ref":"refs/changes/33/2233/3","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1504081224,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1504081255,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/adm.js","line":1473,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"actually"},{"file":"lib/adm.js","line":1473,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"},{"file":"lib/adm.js","line":1477,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think ticket references like this are generally something of an anti-pattern, and I\u0027d trim this one out here.\n\nIt\u0027s best if the comment itself stands alone, providing all of the context necessary, which I think this comment already does.  Folks will be able to see this change in the source history if they need to track it back to a ticket."},{"file":"lib/adm.js","line":1477,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Understood, I can agree with this. I\u0027ve trimmed the comment.\n\nThanks for the pointer!"},{"file":"lib/adm.js","line":1482,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Could we not simply remove the dataset itself?  It feels like that would be much quicker than removing the _contents_, and would save the need to mount it entirely."},{"file":"lib/adm.js","line":1482,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Quite possibly, I\u0027ll look into that! I think that would definitely be a cleaner approach, as I understand the manatee-sitter service would simply recreate this dataset on start.\n\nI guess some initial concerns to me are:\n\n1. Removal of any non-standard ZFS attributes if the dataset is deleted. This is likely unsupported anyway, but I\u0027m not sure how things like compression are changed over the lifetime of a manatee instance (I think we\u0027ve done this in JPC?)\n\n2. By only removing the contents, do we retain some form of rollback capability given the snapshots we\u0027re taking with snapShotter.js? I don\u0027t know if this is true today anyway (surely this would bloat the dataset\u0027s USED size). Rollback in this scenario might not be a big deal given our huge warning when starting a rebuild\n\nI\u0027ll take a look at answering those questions. Let me know if anything else comes to mind!"},{"file":"lib/adm.js","line":1482,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I think removing the dataset forfeits us the recovery options that helped in SCI-211. That is, we rolled back to a snapshot on the dataset when it appears that we ran a rebuild command on the wrong peer.\n\nNot only that, but when sitter runs assertDataset when starting as a standby peer, it will re-create the dataset if it doesn\u0027t exist, and the restore functionality will move this empty dataset to a dataset with a UUID. This won\u0027t be of any use as it doesn\u0027t have any snapshots.\n\nI don\u0027t have particularly strong feelings here, but given the potential changes around rebuilds (MANATEE-366) then this might end up changing further in the future anyway."},{"file":"lib/postgresMgr.js","line":1417,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It seems like that goal is for this message to result in an alarm of some sort?  Should it, therefore, be an ERROR-level message?  I\u0027m not sure what levels are included in the automatic log-scanning based AMON probes today; it\u0027s possible that WARN is sufficient, but I\u0027m not sure."},{"file":"lib/postgresMgr.js","line":1417,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Thanks for catching that. I think a WARN is most applicable to what\u0027s happening here (postgres could genuinely be taking a long time to start), but I\u0027ll check in with the AMON probes to see what needs to be done there."},{"file":"lib/postgresMgr.js","line":1417,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I\u0027ve upped this to ERROR in PS5. Speaking with Dave, ERROR is an alarm-worthy log level, and in this case I do think it is applicable as postgres is taking longer than what we have configured manatee to expect (opsTimeout)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":19,"deletions":-6},{"file":"lib/postgresMgr.js","type":"MODIFIED","insertions":1,"deletions":-5}],"sizeInsertions":20,"sizeDeletions":-11},{"number":"4","revision":"80cc05cbb7aa3e6db333707e077b1616ffbb8c29","parents":["c525bc705fff52644471bd5c9ab7286ca368dbfb"],"ref":"refs/changes/33/2233/4","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1504165945,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1504165976,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":18,"deletions":-6},{"file":"lib/postgresMgr.js","type":"MODIFIED","insertions":1,"deletions":-5}],"sizeInsertions":19,"sizeDeletions":-11},{"number":"5","revision":"d04c4c89ca05a6cd22dba5e311e5290a0fa3ab88","parents":["c525bc705fff52644471bd5c9ab7286ca368dbfb"],"ref":"refs/changes/33/2233/5","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1505386069,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505386100,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":18,"deletions":-6},{"file":"lib/postgresMgr.js","type":"MODIFIED","insertions":2,"deletions":-6}],"sizeInsertions":20,"sizeDeletions":-12}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}]}