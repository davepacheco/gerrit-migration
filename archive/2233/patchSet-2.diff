From ee08379760b72108e1f0298a8b4da9fdf051dcc4 Mon Sep 17 00:00:00 2001
From: Richard Bradley <richard.bradley@joyent.com>
Date: Fri, 21 Jul 2017 11:06:50 +0000
Subject: [PATCH] MANATEE-304 manatee doesn't always come up with very large
 datasets

---
 lib/adm.js         | 23 +++++++++++++++++------
 lib/postgresMgr.js |  6 +-----
 2 files changed, 18 insertions(+), 11 deletions(-)

diff --git a/lib/adm.js b/lib/adm.js
index dd822ef..1f687a5 100644
--- a/lib/adm.js
+++ b/lib/adm.js
@@ -1312,6 +1312,13 @@ function stateBackfill(opts, cb) {
 function rebuild(opts, cb) {
     vasync.pipeline({ funcs: [
         _createZkClient,
+        function _createZfsClient(_, _cb) {
+            var zfsClientCfg = _.config.postgresMgrCfg.zfsClientCfg;
+            zfsClientCfg.log = LOG;
+            zfsClientCfg.dbUser = _.config.postgresMgrCfg.dbUser;
+            _.zfsClient = new zfs(zfsClientCfg);
+            return (_cb());
+        },
         _getShards,
         function _findShard(_, _cb) {
             _.shard = path.basename(_.config.shardPath);
@@ -1459,14 +1466,18 @@ function rebuild(opts, cb) {
             }
             checkZkActive();
         },
-        function _deleteDataDir(_, _cb) {
-            console.error('Attempting to remove ZFS dataset\'s contents');
+        function _assertDataset(_, _cb) {
+            console.error('Ensuring dataset is mounted');
             /*
-             * If sitter hasn't started since our zone booted then this
-             * directory will not be the dataset we expect. However, this
-             * is handled by sitter, where a restore is not always required
-             * (see postgresMgr._standby for details).
+             * It's possible that the dataset isn't mounted at this point, so
+             * the subsequent "rm -rf" command won't actaully delete any local
+             * PostgreSQL data (it'll run the command against an empty
+             * directory). See MANATEE-304 for details.
              */
+            _.zfsClient.assertDataset(_cb);
+        },
+        function _deleteDataDir(_, _cb) {
+            console.error('Removing ZFS dataset\'s contents');
             var cmd = 'rm -rf ' + _.config.postgresMgrCfg.dataDir + '/*';
             exec(cmd, _cb);
         },
diff --git a/lib/postgresMgr.js b/lib/postgresMgr.js
index 4efe456..b51b6af 100644
--- a/lib/postgresMgr.js
+++ b/lib/postgresMgr.js
@@ -1419,11 +1419,7 @@ PostgresMgr.prototype._start = function _start(cb) {
                         opsTimeout: self._opsTimeout,
                         postgresPath: self._postgresPath,
                         dataDir: self._dataDir
-                    }, 'PostgresMgr.start: start timeout');
-
-                    self._stop(function () {
-                        return callback(err, postgres);
-                    });
+                    }, 'PostgresMgr.start: start is taking a long time');
                 }
             } else {
                 log.info({
-- 
2.21.0

