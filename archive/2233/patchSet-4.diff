commit 80cc05cbb7aa3e6db333707e077b1616ffbb8c29 (refs/changes/33/2233/4)
Author: Richard Bradley <richard.bradley@joyent.com>
Date:   2017-08-31T07:46:35+00:00 (2 years, 1 month ago)
    
    MANATEE-304 manatee doesn't always come up with very large datasets

diff --git a/lib/adm.js b/lib/adm.js
index dd822ef..92381a0 100644
--- a/lib/adm.js
+++ b/lib/adm.js
@@ -1312,6 +1312,13 @@ function stateBackfill(opts, cb) {
 function rebuild(opts, cb) {
     vasync.pipeline({ funcs: [
         _createZkClient,
+        function _createZfsClient(_, _cb) {
+            var zfsClientCfg = _.config.postgresMgrCfg.zfsClientCfg;
+            zfsClientCfg.log = LOG;
+            zfsClientCfg.dbUser = _.config.postgresMgrCfg.dbUser;
+            _.zfsClient = new zfs(zfsClientCfg);
+            return (_cb());
+        },
         _getShards,
         function _findShard(_, _cb) {
             _.shard = path.basename(_.config.shardPath);
@@ -1459,14 +1466,19 @@ function rebuild(opts, cb) {
             }
             checkZkActive();
         },
-        function _deleteDataDir(_, _cb) {
-            console.error('Attempting to remove ZFS dataset\'s contents');
+        function _assertDataset(_, _cb) {
+            console.error('Ensuring dataset is mounted');
             /*
-             * If sitter hasn't started since our zone booted then this
-             * directory will not be the dataset we expect. However, this
-             * is handled by sitter, where a restore is not always required
-             * (see postgresMgr._standby for details).
+             * It's possible that the ZFS dataset isn't mounted at this point,
+             * so the subsequent "rm -rf" command won't actually delete any
+             * local PostgreSQL data (it'll run the command against an empty
+             * directory). To avoid this we ensure that the dataset is mounted
+             * prior to attempting to delete the data.
              */
+            _.zfsClient.assertDataset(_cb);
+        },
+        function _deleteDataDir(_, _cb) {
+            console.error('Removing ZFS dataset\'s contents');
             var cmd = 'rm -rf ' + _.config.postgresMgrCfg.dataDir + '/*';
             exec(cmd, _cb);
         },
diff --git a/lib/postgresMgr.js b/lib/postgresMgr.js
index 4efe456..5e2ba16 100644
--- a/lib/postgresMgr.js
+++ b/lib/postgresMgr.js
@@ -1419,11 +1419,7 @@ PostgresMgr.prototype._start = function _start(cb) {
                         opsTimeout: self._opsTimeout,
                         postgresPath: self._postgresPath,
                         dataDir: self._dataDir
-                    }, 'PostgresMgr.start: start timeout');
-
-                    self._stop(function () {
-                        return callback(err, postgres);
-                    });
+                    }, 'PostgresMgr.start: db is taking a long time to start');
                 }
             } else {
                 log.info({
