From 13c7b1525582deb4389d24b3b3190b719b07aee4 Mon Sep 17 00:00:00 2001
From: Mike Gerdts <mike.gerdts@joyent.com>
Date: Tue, 8 Oct 2019 21:17:36 +0000
Subject: [PATCH] replace node-lockfd with node-fs-ext

---
 node_modules/locker.js | 8 +++++---
 package.json           | 2 +-
 2 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/node_modules/locker.js b/node_modules/locker.js
index 85fb7dd..0d618aa 100755
--- a/node_modules/locker.js
+++ b/node_modules/locker.js
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2015, Joyent, Inc. All rights reserved.
+ * Copyright 2019 Joyent, Inc.
  */
 // vim: set sts=4 sw=4 et:
 
@@ -7,7 +7,7 @@ var mod_path = require('path');
 var mod_fs = require('fs');
 var mod_assert = require('assert');
 
-var mod_lockfd = require('lockfd');
+var fcntl = require('fs-ext').fcntl;
 
 // If we fail to lock (i.e. the call to fcntl() in node-lockfd), and
 // the errno is in this list, then we should back off for some delay
@@ -123,7 +123,9 @@ function lockfile_to_locking(lf) {
 
         // Attempt to get an exclusive lock on the file via our file
         // descriptor:
-        mod_lockfd.lockfd(lf.lf_fd, function __lockfdcb(_err) {
+        fcntl(lf.lf_fd, 'setlkw', constants.F_WRLCK,
+            function __lockfdcb(_err) {
+
             mod_assert.strictEqual(lf.lf_state, 'LOCKING');
 
             if (_err) {
diff --git a/package.json b/package.json
index 52664b5..395290f 100644
--- a/package.json
+++ b/package.json
@@ -13,11 +13,11 @@
     "cueball": "2.7.1",
     "digest-stream": "0.2.2",
     "forkexec": "1.1.0",
+    "fs-ext": "1.3.0",
     "imgmanifest": "3.1.0",
     "jsprim": "2.0.0",
     "kstat": "1.0.1",
     "lazy-property": "1.0.0",
-    "lockfd": "1.2.0",
     "lstream": "0.0.4",
     "mkdirp": "^0.3.4",
     "nodeunit": "0.9.1",
-- 
2.17.2 (Apple Git-113)

