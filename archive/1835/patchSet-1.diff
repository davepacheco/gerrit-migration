From 14e868bb878ab6850d706d74cc4cf6e0a2d22350 Mon Sep 17 00:00:00 2001
From: Hans Rosenfeld <hans.rosenfeld@joyent.com>
Date: Thu, 20 Apr 2017 17:44:15 +0200
Subject: [PATCH] OS-6075 kernel panic in apix:apic_timer_init

---
 usr/src/uts/i86pc/io/apix/apix.c     | 7 +++++--
 usr/src/uts/i86pc/io/pcplusmp/apic.c | 3 +++
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/usr/src/uts/i86pc/io/apix/apix.c b/usr/src/uts/i86pc/io/apix/apix.c
index 062dca64b9..5c03136ad7 100644
--- a/usr/src/uts/i86pc/io/apix/apix.c
+++ b/usr/src/uts/i86pc/io/apix/apix.c
@@ -263,8 +263,11 @@ apix_probe()
 		/* check if x2APIC mode is supported */
 		if ((apix_supported_hw & APIX_SUPPORT_X2APIC) ==
 		    APIX_SUPPORT_X2APIC) {
-			if (!((apic_local_mode() == LOCAL_X2APIC) ||
-			    apic_detect_x2apic())) {
+			if (apic_local_mode() == LOCAL_X2APIC) {
+				/* x2APIC mode activated by BIOS, switch ops */
+				apic_mode = LOCAL_X2APIC;
+				apic_change_ops();
+			} else if (!apic_detect_x2apic()) {
 				/* x2APIC mode is not supported in the hw */
 				apix_enable = 0;
 			}
diff --git a/usr/src/uts/i86pc/io/pcplusmp/apic.c b/usr/src/uts/i86pc/io/pcplusmp/apic.c
index d65e4db941..05d55d1ef0 100644
--- a/usr/src/uts/i86pc/io/pcplusmp/apic.c
+++ b/usr/src/uts/i86pc/io/pcplusmp/apic.c
@@ -248,6 +248,9 @@ apic_probe(void)
 	/* check if apix is initialized */
 	if (apix_enable && apix_loaded())
 		return (PSM_FAILURE);
+	else if (apic_local_mode() == LOCAL_X2APIC)
+		/* x2APIC mode activated by BIOS, bail out */
+		return (PSM_FAILURE);
 	else
 		apix_enable = 0; /* continue using pcplusmp PSM */
 
-- 
2.21.0

