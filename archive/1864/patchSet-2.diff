From ade66ab19311619ed1f15f2705d0f4140b51f8e3 Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Thu, 27 Apr 2017 23:50:16 +0000
Subject: [PATCH] MORAY-416 Ship newer CLI tools and their manual pages in
 Moray zones

---
 boot/setup.sh | 9 +++++++--
 package.json  | 2 +-
 2 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/boot/setup.sh b/boot/setup.sh
index 6bc05b6..62eaeac 100755
--- a/boot/setup.sh
+++ b/boot/setup.sh
@@ -7,7 +7,7 @@
 #
 
 #
-# Copyright (c) 2015, Joyent, Inc.
+# Copyright (c) 2017, Joyent, Inc.
 #
 
 export PS4='[\D{%FT%TZ}] ${BASH_SOURCE}:${LINENO}: ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
@@ -184,9 +184,11 @@ function sdc_moray_setup {
         -keyout /opt/smartdc/$role/ssl/key.pem \
         -out /opt/smartdc/$role/ssl/cert.pem -days 3650
 
-    # Add build/node/bin and node_modules/.bin to PATH
+    # Add node and CLI tools to PATH, and manual pages to MANPATH
     echo "" >>/root/.profile
     echo "export PATH=\$PATH:/opt/smartdc/$role/build/node/bin:/opt/smartdc/$role/node_modules/.bin:/opt/smartdc/$role/node_modules/$role/bin" >>/root/.profile
+    echo "export MANPATH=/opt/smartdc/$role/node_modules/moray/man:\$MANPATH" >> /root/.profile
+
 
     # Log Rotation FTW
     # What about manta/haproxy?
@@ -203,6 +205,9 @@ function manta_setup_moray_config {
     echo 'function req() { grep "$@" `svcs -L moray` | bunyan ;}' >> $PROFILE
     echo 'export PATH=/opt/smartdc/moray/bin:$PATH' >> $PROFILE
 
+    # Add manual pages to MANPATH
+    echo "export MANPATH=/opt/smartdc/$role/node_modules/moray/man:\$MANPATH" >> /root/.profile
+
     local moray_cfg=$SVC_ROOT/etc/config.json
     local svc_name=$(json -f ${METADATA} SERVICE_NAME)
     [[ $? -eq 0 ]] || fatal "Unable to retrieve service name"
diff --git a/package.json b/package.json
index 80a3b15..00ea56b 100644
--- a/package.json
+++ b/package.json
@@ -20,7 +20,7 @@
         "lru-cache": "2.5.0",
         "node-manatee": "git+https://github.com/joyent/node-manatee.git#c2ad9ae",
         "manatee": "git+https://github.com/joyent/manatee.git#86ae52d",
-        "moray": "git+https://github.com/joyent/node-moray.git#fd5781b",
+        "moray": "3.1.1",
         "microtime": "0.5.1",
         "once": "1.3.0",
         "panic": "0.2.1",
-- 
2.21.0

