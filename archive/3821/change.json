{"project":"joyent/illumos-joyent","branch":"master","id":"I7f4cce258636ed577f781c39e1dac133a2d745b2","number":"3821","subject":"OS-6738 bhyve ppt should not use /dev/mem Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"url":"https://cr.joyent.us/3821","commitMessage":"OS-6738 bhyve ppt should not use /dev/mem\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1523866913,"lastUpdated":1524572171,"open":false,"status":"MERGED","comments":[{"timestamp":1523866913,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 1."},{"timestamp":1523903059,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(9 comments)"},{"timestamp":1523973952,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 2."},{"timestamp":1523973997,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1:\n\n(9 comments)"},{"timestamp":1523974962,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1523975063,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1524062305,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 3."},{"timestamp":1524062372,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1524062689,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1524063944,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1524067047,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1524154057,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1524163600,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1524231947,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1524560646,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1524567661,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1524572171,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Hans Rosenfeld"}],"currentPatchSet":{"number":"5","revision":"7f4cce258636ed577f781c39e1dac133a2d745b2","parents":["4d8ab6bf8248efd00a0524249c9faf28c7109eae"],"ref":"refs/changes/21/3821/5","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1524567661,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524062689,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524063944,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524163600,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1524231947,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1524572171,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_passthru.c","type":"MODIFIED","insertions":1,"deletions":-18},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","type":"MODIFIED","insertions":64,"deletions":-5}],"sizeInsertions":65,"sizeDeletions":-23},"patchSets":[{"number":"1","revision":"50ea37a375ecdf25ec031c986331aaa28b943197","parents":["99dda62835ffd7e81816de700276a4ec1420691e"],"ref":"refs/changes/21/3821/1","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1523866913,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":333,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This should be checked against PCI_EINVAL32 and return -1 in case we get a bad read."},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":333,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":340,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why isn\u0027t the offset and length being checked at all here? What would happen if userland asked to map well beyond the length of the bar? Shouldn\u0027t we be checking that the offset and length make sense in the context of this bar? Otherwise, couldn\u0027t I use this to basically map arbitrary parts of memory?"},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":340,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"The offset is always relative to the BAR, and both length and offset will be checked in npe_bus_map() (usr/src/uts/i86pc/io/pciex/npe.c:631)."},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":340,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK. As long as we\u0027re confident that all possible nexus drivers under this will always sanity check this. It looks like both npe and pci will."},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":355,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This should use ddi_model_convert_from(9F). I also don\u0027t think you need the __amd64 guards in that case."},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":355,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"I removed the guards. I\u0027m not sure it\u0027s worth the hassle to deal with ddi_model_convert_from(9F) since this interface is only for use by bhyve, which always is a 64bit binary."},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":355,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"DDI_MODEL_MASK is private and undocumented. The manual page examples for this suggested using ddi_model_convert_from(), hence the suggestion."},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":355,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":357,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Probably want to check that off isn\u0027t negative before doing this. As off is a signed quantity."},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":357,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":363,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"While I know why it\u0027s \u0027bar + 1\u0027 based on how we do the IEEE 1275 properties, others probably don\u0027t know that the register set is offset by one because the first entry descries other bits as per pci(5). I\u0027d ad a comment here to make that clear."},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":363,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":364,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"The ppt_attr here suggests different cacheability than you\u0027re granting with the I/O memory just before it. While I understand that that field is currently ignored by devmap_devmem_setup(), it seems odd to have the two disagree."},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":364,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I don\u0027t believe that we want to offer PROT_EXEC to this memory region."},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":364,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":364,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":366,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should maplen be set on failure?"},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":366,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":593,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why were these changed?"},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":593,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Because of this statement in the manpage:\n\nAs a result of a mmap(2) system call, the system calls the devmap() entry point during the mapping setup when D_DEVMAP is set in the cb_flag field of the cb_ops(9S) structure, and any of the following conditions apply:\n\no      ddi_devmap_segmap(9F) is used as the segmap(9E) entry point.\no      segmap(9E) entry point is set to NULL.\no      mmap(9E) entry point is set to NULL."},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":593,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Thanks, I missed that in devmap(9E)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_passthru.c","type":"MODIFIED","insertions":1,"deletions":-18},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","type":"MODIFIED","insertions":55,"deletions":-5}],"sizeInsertions":56,"sizeDeletions":-23},{"number":"2","revision":"61e0774ac392c3a229c33cc1e1647c5c0cf3cebc","parents":["99dda62835ffd7e81816de700276a4ec1420691e"],"ref":"refs/changes/21/3821/2","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1523973952,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":106,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I don\u0027t see this new member being used anywhere. Am I missing it?"},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":106,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_passthru.c","type":"MODIFIED","insertions":1,"deletions":-18},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","type":"MODIFIED","insertions":63,"deletions":-5}],"sizeInsertions":64,"sizeDeletions":-23},{"number":"3","revision":"d90131435aac87720a047029eea56900318ddb4c","parents":["99dda62835ffd7e81816de700276a4ec1420691e"],"ref":"refs/changes/21/3821/3","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1524062305,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524062689,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524063944,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1524231947,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524163600,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/cmd/bhyve/pci_passthru.c","line":550,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Would it make sense to use something like PAGESIZE here?  (without resorting to all the sysconf nonsense)"},{"file":"usr/src/cmd/bhyve/pci_passthru.c","line":550,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Not sure it makes that much sense. Yes, technically it\u0027s PAGESIZE (which boils down to sysconf anyway), but I\u0027d rather leave it as is to not introduce more differences from FreeBSD."},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":372,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Do we need to verify the bounds on \u0027off\u0027 and \u0027len\u0027 prior to the map call, or will the devmap abstraction take care of that for us?  (If that\u0027s the case, perhaps add a little comment about it?)"},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","line":372,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"The nexus drivers (in this case: npe) does the bounds checking on the offset and length, see npe_bus_map()."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_passthru.c","type":"MODIFIED","insertions":1,"deletions":-18},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","type":"MODIFIED","insertions":64,"deletions":-5}],"sizeInsertions":65,"sizeDeletions":-23},{"number":"4","revision":"0feb4188a06e170ee431595a9828f622e83c5668","parents":["4d8ab6bf8248efd00a0524249c9faf28c7109eae"],"ref":"refs/changes/21/3821/4","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1524560646,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524062689,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524063944,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1524231947,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524163600,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_passthru.c","type":"MODIFIED","insertions":1,"deletions":-18},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","type":"MODIFIED","insertions":64,"deletions":-5}],"sizeInsertions":65,"sizeDeletions":-23},{"number":"5","revision":"7f4cce258636ed577f781c39e1dac133a2d745b2","parents":["4d8ab6bf8248efd00a0524249c9faf28c7109eae"],"ref":"refs/changes/21/3821/5","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1524567661,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524062689,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524063944,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1524231947,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524163600,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1524572171,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_passthru.c","type":"MODIFIED","insertions":1,"deletions":-18},{"file":"usr/src/uts/i86pc/io/vmm/io/ppt.c","type":"MODIFIED","insertions":64,"deletions":-5}],"sizeInsertions":65,"sizeDeletions":-23}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}]}