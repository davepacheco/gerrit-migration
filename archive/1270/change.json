{"project":"joyent/sdc-headnode","branch":"master","id":"I35d5fe9620d1033dab0b9d347d0b4b7a59c4e003","number":"1270","subject":"HEAD-2343 allow headnode setup to work on a CN being converted to a headnode Reviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e Approved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e","owner":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"url":"https://cr.joyent.us/1270","commitMessage":"HEAD-2343 allow headnode setup to work on a CN being converted to a headnode\nReviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\nApproved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\n","createdOn":1484701174,"lastUpdated":1484782786,"open":false,"status":"MERGED","comments":[{"timestamp":1484701174,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 1."},{"timestamp":1484701175,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 38817fe18e3146f3e2afbd79f2a803c26ee9e0fa\n    \n    headnode setup script fixes for CN conversion to headnode"},{"timestamp":1484701509,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484704204,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1484707817,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1484762715,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 2."},{"timestamp":1484762716,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit ef8298d116485e7c27fa96d96301d2bfd2ae2922\n    \n    update with some feedback from joshw"},{"timestamp":1484762756,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n deps/javascriptlint/build/install/jsl --nologo --nosummary --conf\u003dbuildtools/jsl.node.conf scripts/build-payload.js scripts/sdc-init.js scripts/sdc-deploy.js tools/cmd/sdc-usbkey.js tools/lib/oscmds.js tools/lib/common.js tools/lib/usbkey.js tools/bin/sdc-heartbeatsnoop tools/bin/sdc-rabbitstat tools/bin/sdc-server\n /tmp/repo/scripts/build-payload.js\n /tmp/repo/scripts/sdc-init.js\n /tmp/repo/scripts/sdc-deploy.js\n /tmp/repo/tools/cmd/sdc-usbkey.js\n /tmp/repo/tools/lib/oscmds.js\n /tmp/repo/tools/lib/common.js\n /tmp/repo/tools/lib/usbkey.js\n /tmp/repo/tools/bin/sdc-heartbeatsnoop\n /tmp/repo/tools/bin/sdc-rabbitstat\n /tmp/repo/tools/bin/sdc-server\n deps/jsstyle/jsstyle -o indent\u003d4,doxygen,unparenthesized-return\u003d0 scripts/build-payload.js scripts/sdc-init.js scripts/sdc-deploy.js tools/cmd/sdc-usbkey.js tools/lib/oscmds.js tools/lib/common.js tools/lib/usbkey.js tools/bin/sdc-heartbeatsnoop tools/bin/sdc-rabbitstat tools/bin/sdc-server\n Unescaped left brace in regex is deprecated, passed through in regex; marked by \u003c-- HERE in m/\\S{ \u003c-- HERE / at deps/jsstyle/jsstyle line 652.\n bash -n scripts/headnode.sh\n scripts/headnode.sh: line 854: syntax error near unexpected token `fi\u0027\n scripts/headnode.sh: line 854: `fi\u0027\n buildtools/mk/Makefile.targ:175: recipe for target \u0027scripts/headnode.sh.bashchk\u0027 failed\n gmake: *** [scripts/headnode.sh.bashchk] Error 2"},{"timestamp":1484764982,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 3."},{"timestamp":1484764983,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit b114f750052fc0935b99228cf2bfd6a2b0496c8f\n    \n    fix if-block syntax error\n    \n    commit 07bb4b6948df56ce304e46e0aea30930c45e56ba\n    \n    update with some feedback from joshw\n    \n    commit bd370bda0c133936137cc8328aa9508468fd1ba3\n    \n    headnode setup script fixes for CN conversion to headnode"},{"timestamp":1484765136,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484780865,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 4."},{"timestamp":1484780866,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 38e3bffd26d23de27181c12bdf141cfdbd553777\n    \n    \u0027zpool list\u0027 is better to programattically get zpool health"},{"timestamp":1484781036,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484781153,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1\n\n(2 comments)\n\nlgtm"},{"timestamp":1484782283,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 5."},{"timestamp":1484782285,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 8872555aefa02546efa85082c10e32d364a5b7e4\n    \n    copyright year"},{"timestamp":1484782358,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1484782463,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484782786,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Trent Mick"}],"currentPatchSet":{"number":"5","revision":"35d5fe9620d1033dab0b9d347d0b4b7a59c4e003","parents":["f39941fdcad6d1192b9d3ec612fa5ba79911803f"],"ref":"refs/changes/70/1270/5","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1484782283,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484782358,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484782358,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484782463,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1484782786,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"scripts/headnode.sh","type":"MODIFIED","insertions":51,"deletions":-8},{"file":"scripts/joysetup.sh","type":"MODIFIED","insertions":1,"deletions":-11}],"sizeInsertions":52,"sizeDeletions":-19},"patchSets":[{"number":"1","revision":"a60e59f7055c69465bf937996243ffedb20f2c3b","parents":["de727f6b99b2b095d3b0ad7c2464fbc5c4f0d42f"],"ref":"refs/changes/70/1270/1","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1484701174,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484701509,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"scripts/headnode.sh","line":163,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Perhaps we should verify that the pools is mounted and there are *other* datasets? If something were wrong will the pool and it didn\u0027t mount for some reason, I guess we\u0027d get to \"fatal\" and not reboot, but it might be good to catch that earlier so we can have a more specific message that the pool is missing?"},{"file":"scripts/headnode.sh","line":163,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"You mean, perhaps check that \u0027state: ONLINE\u0027 from \u0027zpool status zones\u0027? Though, yah, we would hit an error in \u0027zfs create\u0027 if there was a fatal problem with the zpool."},{"file":"scripts/headnode.sh","line":767,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Maybe make this an \u0026\u0026 instead of two separate else\u0027s? then you avoid:\n\n    if \u003ca\u003e; then\n    if \u003cb\u003e; then\n        # Code\n    fi\n    fi\n\nwhich might be confusing and/or distasteful. Though what\u0027s here will also work, so up to you."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"scripts/headnode.sh","type":"MODIFIED","insertions":44,"deletions":-6},{"file":"scripts/joysetup.sh","type":"MODIFIED","insertions":0,"deletions":-10}],"sizeInsertions":44,"sizeDeletions":-16},{"number":"2","revision":"c762a116fa8ab47dcc2c90396195ba5192d40906","parents":["f39941fdcad6d1192b9d3ec612fa5ba79911803f"],"ref":"refs/changes/70/1270/2","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1484762715,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1484762756,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"scripts/headnode.sh","type":"MODIFIED","insertions":51,"deletions":-7},{"file":"scripts/joysetup.sh","type":"MODIFIED","insertions":0,"deletions":-10}],"sizeInsertions":51,"sizeDeletions":-17},{"number":"3","revision":"2cfc758ab09402a7f9bc1bef7a669e74c6faf9bf","parents":["f39941fdcad6d1192b9d3ec612fa5ba79911803f"],"ref":"refs/changes/70/1270/3","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1484764982,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484765136,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"scripts/headnode.sh","type":"MODIFIED","insertions":50,"deletions":-7},{"file":"scripts/joysetup.sh","type":"MODIFIED","insertions":0,"deletions":-10}],"sizeInsertions":50,"sizeDeletions":-17},{"number":"4","revision":"31aeac4d8fa328a4a086182f56de27a38b2b79fc","parents":["f39941fdcad6d1192b9d3ec612fa5ba79911803f"],"ref":"refs/changes/70/1270/4","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1484780865,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484781036,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484781153,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484781153,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"comments":[{"file":"scripts/headnode.sh","line":9,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"2017"},{"file":"scripts/joysetup.sh","line":9,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"2017"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"scripts/headnode.sh","type":"MODIFIED","insertions":50,"deletions":-7},{"file":"scripts/joysetup.sh","type":"MODIFIED","insertions":0,"deletions":-10}],"sizeInsertions":50,"sizeDeletions":-17},{"number":"5","revision":"35d5fe9620d1033dab0b9d347d0b4b7a59c4e003","parents":["f39941fdcad6d1192b9d3ec612fa5ba79911803f"],"ref":"refs/changes/70/1270/5","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1484782283,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484782463,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1484782786,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484782358,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484782358,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"scripts/headnode.sh","type":"MODIFIED","insertions":51,"deletions":-8},{"file":"scripts/joysetup.sh","type":"MODIFIED","insertions":1,"deletions":-11}],"sizeInsertions":52,"sizeDeletions":-19}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}]}