commit 87a348c9e042d150405c3ed1da29619cef4d1697 (refs/changes/27/427/2)
Author: Orlando Vazquez <ovazquez@gmail.com>
Date:   2016-09-07T11:04:49-07:00 (3 years, 1 month ago)
    
    CNAPI-667 CNAPI dying with: TypeError: Cannot read property 'limit' of undefined
    Reviewed by: Pedro Palaz√≥n Candel <pedro@joyent.com>

diff --git a/lib/endpoints/waitlist.js b/lib/endpoints/waitlist.js
index d91ec28..c034881 100644
--- a/lib/endpoints/waitlist.js
+++ b/lib/endpoints/waitlist.js
@@ -70,7 +70,7 @@ ControllerWaitlist.list = function (req, res, next) {
         'offset': [
             'optional',
             'isNumberGreaterThanEqualZeroType',
-            ['regex', RegExp('^[1-9][0-9]*$')]
+            ['regex', RegExp('^([1-9][0-9]*|0)$')]
         ],
         'attribute': ['optional', 'isStringType', 'isTrim'],
         'server_uuid': ['isStringType', 'isTrim'],
diff --git a/lib/models/waitlist.js b/lib/models/waitlist.js
index 6a92aeb..5e3f332 100644
--- a/lib/models/waitlist.js
+++ b/lib/models/waitlist.js
@@ -487,7 +487,7 @@ ModelWaitlist.query = function (filter, findOpts, callback) {
     }
 
     var findParams = jsprim.deepCopy(findOpts);
-    var sort = findParams.sort;
+    var sort = findParams.sort || {};
     findParams.sort = jsprim.deepCopy(defaultSort);
 
     if (sort.limit) {
diff --git a/test/waitlist/test-waitlist.js b/test/waitlist/test-waitlist.js
index 075d82f..d29684a 100644
--- a/test/waitlist/test-waitlist.js
+++ b/test/waitlist/test-waitlist.js
@@ -366,13 +366,13 @@ function testLimitOffsetValidation(test) {
         'offset=-1',
         'limit=pizzacake',
         'limit=1up',
-        'limit=bad1'
+        'limit=bad1',
+        'limit=0'
     ];
 
     var goodopts = [
         'limit=1',
         'offset=1',
-        'limit=0',
         'offset=0'
     ];
 
