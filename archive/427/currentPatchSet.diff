From 87a348c9e042d150405c3ed1da29619cef4d1697 Mon Sep 17 00:00:00 2001
From: Orlando Vazquez <ovazquez@gmail.com>
Date: Wed, 7 Sep 2016 11:04:49 -0700
Subject: [PATCH] =?UTF-8?q?CNAPI-667=20CNAPI=20dying=20with:=20TypeError:?=
 =?UTF-8?q?=20Cannot=20read=20property=20'limit'=20of=20undefined=20Review?=
 =?UTF-8?q?ed=20by:=20Pedro=20Palaz=C3=B3n=20Candel=20<pedro@joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 lib/endpoints/waitlist.js      | 2 +-
 lib/models/waitlist.js         | 2 +-
 test/waitlist/test-waitlist.js | 4 ++--
 3 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/lib/endpoints/waitlist.js b/lib/endpoints/waitlist.js
index d91ec28..c034881 100644
--- a/lib/endpoints/waitlist.js
+++ b/lib/endpoints/waitlist.js
@@ -70,7 +70,7 @@ ControllerWaitlist.list = function (req, res, next) {
         'offset': [
             'optional',
             'isNumberGreaterThanEqualZeroType',
-            ['regex', RegExp('^[1-9][0-9]*$')]
+            ['regex', RegExp('^([1-9][0-9]*|0)$')]
         ],
         'attribute': ['optional', 'isStringType', 'isTrim'],
         'server_uuid': ['isStringType', 'isTrim'],
diff --git a/lib/models/waitlist.js b/lib/models/waitlist.js
index 6a92aeb..5e3f332 100644
--- a/lib/models/waitlist.js
+++ b/lib/models/waitlist.js
@@ -487,7 +487,7 @@ ModelWaitlist.query = function (filter, findOpts, callback) {
     }
 
     var findParams = jsprim.deepCopy(findOpts);
-    var sort = findParams.sort;
+    var sort = findParams.sort || {};
     findParams.sort = jsprim.deepCopy(defaultSort);
 
     if (sort.limit) {
diff --git a/test/waitlist/test-waitlist.js b/test/waitlist/test-waitlist.js
index 075d82f..d29684a 100644
--- a/test/waitlist/test-waitlist.js
+++ b/test/waitlist/test-waitlist.js
@@ -366,13 +366,13 @@ function testLimitOffsetValidation(test) {
         'offset=-1',
         'limit=pizzacake',
         'limit=1up',
-        'limit=bad1'
+        'limit=bad1',
+        'limit=0'
     ];
 
     var goodopts = [
         'limit=1',
         'offset=1',
-        'limit=0',
         'offset=0'
     ];
 
-- 
2.21.0

