From 514fb62795a0e37247dcf620290b7907c9c2e311 Mon Sep 17 00:00:00 2001
From: Marsell Kukuljevic <marsell@joyent.com>
Date: Tue, 29 Nov 2016 23:48:37 +1300
Subject: [PATCH] PUBAPI-1291: primaryIp's logic could be better

---
 lib/machines.js         | 25 +++++++++++++++----------
 test/machines/common.js |  4 ++++
 2 files changed, 19 insertions(+), 10 deletions(-)

diff --git a/lib/machines.js b/lib/machines.js
index 201dc98..9ab90bf 100644
--- a/lib/machines.js
+++ b/lib/machines.js
@@ -164,17 +164,22 @@ function translate(machine, req)  {
             }
         });
 
-        msg.primaryIp = machine.nics.reduce(function (acc, nic) {
-            return (nic.nic_tag === 'external') ? nic.ip : acc;
-        }, '');
-
-        // PUBAPI-727: If a machine has only internal networks, use that
-        // as the primary IP
-        if (msg.primaryIp === '') {
-            msg.primaryIp = machine.nics.reduce(function (acc, nic) {
-                return (nic.nic_tag === 'internal') ? nic.ip : acc;
-            }, '');
+        var primaryNic = machine.nics.filter(function (nic) {
+            return nic.primary;
+        })[0];
+
+        // For backwards-compat. Some old VMs don't have a primary
+        // attribute set on their nics, but have an 'external' nic tag.
+        if (!primaryNic) {
+            primaryNic = machine.nics.filter(function (nic) {
+                return nic.nic_tag === EXTERNAL_NIC_TAG;
+            }).pop();
         }
+
+        // if we found nothing yet, just pick any NIC
+        primaryNic = primaryNic || machine.nics[0];
+
+        msg.primaryIp = primaryNic ? primaryNic.ip : '';
     }
 
     if (credentials && machine.internal_metadata &&
diff --git a/test/machines/common.js b/test/machines/common.js
index 58a0765..d3fd836 100644
--- a/test/machines/common.js
+++ b/test/machines/common.js
@@ -81,6 +81,10 @@ function checkMachine(t, m) {
     t.ok(m.metadata, 'checkMachine metadata ok');
     t.notOk(m.docker, 'checkMachine docker attr not set');
 
+    if (m.state === 'running') {
+        t.ok(m.primaryIp, 'checkMachine primaryIp ok');
+    }
+
     // Sometimes test suites from other applications create zones with a
     // 00000000-0000-0000-0000-000000000000 billing_id, which is changed by
     // cloudapi to '' since it's not an actual package UUID. Alas, we work
-- 
2.21.0

