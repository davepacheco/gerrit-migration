{"project":"joyent/illumos-joyent","branch":"master","id":"Iff1603a29d41ea115360ea42106b5881d604c113","number":"5757","subject":"OS-7648 dmake could support -C Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Kody Kantor \u003ckody.kantor@joyent.com\u003e","owner":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"url":"https://cr.joyent.us/5757","commitMessage":"OS-7648 dmake could support -C\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Kody Kantor \u003ckody.kantor@joyent.com\u003e\n","createdOn":1552325478,"lastUpdated":1554490058,"open":false,"status":"MERGED","comments":[{"timestamp":1552325478,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 1."},{"timestamp":1552412519,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1552932828,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1552934070,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1553027233,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 2."},{"timestamp":1553027237,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1553027806,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1553193016,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(5 comments)"},{"timestamp":1553698822,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 3."},{"timestamp":1553698823,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(5 comments)"},{"timestamp":1553702500,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1553798258,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1554489039,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1554489630,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1554490052,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1554490058,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Mustacchi"}],"currentPatchSet":{"number":"5","revision":"ff1603a29d41ea115360ea42106b5881d604c113","parents":["6aaf159ea324821122771dc6552e8ed77cc1f8fe"],"ref":"refs/changes/57/5757/5","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1554490052,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553702500,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553798258,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554489039,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"SUBM","value":"1","grantedOn":1554490058,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/make/bin/globals.cc","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/make/bin/main.cc","type":"MODIFIED","insertions":47,"deletions":-6},{"file":"usr/src/cmd/make/bin/misc.cc","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/cmd/make/include/mk/defs.h","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/man/man1/make.1","type":"MODIFIED","insertions":17,"deletions":-4}],"sizeInsertions":84,"sizeDeletions":-12},"patchSets":[{"number":"1","revision":"a7eb7f3fc12f104000ee8a7ac97229888c58fd18","parents":["7e3d90a64c293c5a7a722cf739fb36461f13ff0f"],"ref":"refs/changes/57/5757/1","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1552325478,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/make/bin/main.cc","line":372,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"nit, shouldn\u0027t need to compare booleans against literals..."},{"file":"usr/src/cmd/make/bin/main.cc","line":372,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/cmd/make/bin/main.cc","line":377,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"nit, this will leak a previously set current_path?"},{"file":"usr/src/cmd/make/bin/main.cc","line":377,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Not sure I follow 100%. Do you mean that the fact the previous static value that was strdup\u0027d in get_current_path() will be leaked?"},{"file":"usr/src/cmd/make/bin/main.cc","line":377,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Yes. I guess you mentioned that we leak anyway so we shouldn\u0027t care much?"},{"file":"usr/src/cmd/make/bin/main.cc","line":377,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"So, just to clarify what\u0027s happening here. get_current_path() caches a value that it hands out. It does the duplication. Callers of get_current_path() themselves don\u0027t receive yet another duplicate of the data. So, it\u0027s true that the current way I\u0027ve implemented this, there is a slight leak of the original version when we reset it, but that I see as being at worst once per -C invocation and probably simpler than trying to cut through the rest of the code here."},{"file":"usr/src/cmd/make/bin/main.cc","line":1014,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"no change here?"},{"file":"usr/src/cmd/make/bin/main.cc","line":1014,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I wasn\u0027t intending to originally, but seems like that\u0027s simpler than trying to get it not to exist."},{"file":"usr/src/cmd/make/bin/main.cc","line":2550,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Why don\u0027t you just set current_path to NULL (free()ing anything already set) ? That seems like it would have the same effect?"},{"file":"usr/src/cmd/make/bin/main.cc","line":2550,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Sorry, I\u0027m not sure I follow exactly. Are you suggesting that we change get_current_path() to not have a function static value that it strdup\u0027s out so we can NULL it out?\n\nPart of the reason I was afraid to call free was because I wasn\u0027t convinced I\u0027d have caught all the uses that were invalid and then used elsewhere."},{"file":"usr/src/cmd/make/bin/main.cc","line":2550,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I suppose I\u0027d just missed that current_path was static there. This seems fine."},{"file":"usr/src/cmd/make/bin/main.cc","line":2550,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027ve added a comment about this in the caller to make it clear that there is a leak here."},{"file":"usr/src/man/man1/make.1","line":71,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I don\u0027t see your code disabling -C for this make version?"},{"file":"usr/src/man/man1/make.1","line":71,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"It wasn\u0027t in the getopt string, so in theory nothing should trigger it; however, that didn\u0027t work in practice, so I guess I\u0027ll go back and add it here."},{"file":"usr/src/man/man1/make.1","line":446,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I think you need to add -C here?"},{"file":"usr/src/man/man1/make.1","line":446,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I guess you\u0027re right."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/make/bin/globals.cc","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/make/bin/main.cc","type":"MODIFIED","insertions":47,"deletions":-4},{"file":"usr/src/cmd/make/bin/misc.cc","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/cmd/make/include/mk/defs.h","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/man/man1/make.1","type":"MODIFIED","insertions":16,"deletions":-3}],"sizeInsertions":76,"sizeDeletions":-9},{"number":"2","revision":"71267494753458a8ccb5e734d17ded4b523a175b","parents":["c33a1acb9de8b5fce4525488909de95b5ab558bf"],"ref":"refs/changes/57/5757/2","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1553027233,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553027806,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"comments":[{"file":"usr/src/cmd/make/bin/main.cc","line":345,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"At least clean up the definition of this too?  I won\u0027t suggest that it needs to go as far as cleansing all references to sccs_dir_path too, but that would be an option."},{"file":"usr/src/cmd/make/bin/main.cc","line":345,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"We still call this. Just after we redo the -C stuff. See +390 in version 2. I don\u0027t think I should clean it up yet."},{"file":"usr/src/cmd/make/bin/main.cc","line":386,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Why set this, since it\u0027s part of the conditional?"},{"file":"usr/src/cmd/make/bin/main.cc","line":386,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I guess we don\u0027t need to yeah. Removed."},{"file":"usr/src/cmd/make/bin/main.cc","line":387,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: empty line?"},{"file":"usr/src/cmd/make/bin/main.cc","line":387,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/cmd/make/bin/misc.cc","line":258,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"append comma"},{"file":"usr/src/cmd/make/bin/misc.cc","line":258,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/cmd/make/bin/misc.cc","line":259,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"append comma"},{"file":"usr/src/cmd/make/bin/misc.cc","line":259,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/make/bin/globals.cc","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/make/bin/main.cc","type":"MODIFIED","insertions":49,"deletions":-6},{"file":"usr/src/cmd/make/bin/misc.cc","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/cmd/make/include/mk/defs.h","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/man/man1/make.1","type":"MODIFIED","insertions":17,"deletions":-4}],"sizeInsertions":86,"sizeDeletions":-12},{"number":"3","revision":"0cb792dc1efccca7409d06ded2d6acee68200490","parents":["5ffb784f5a3c76e1a0dfe2349748d3a9a8f33082"],"ref":"refs/changes/57/5757/3","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1553698822,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553798258,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554489039,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553702500,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/make/bin/globals.cc","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/make/bin/main.cc","type":"MODIFIED","insertions":47,"deletions":-6},{"file":"usr/src/cmd/make/bin/misc.cc","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/cmd/make/include/mk/defs.h","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/man/man1/make.1","type":"MODIFIED","insertions":17,"deletions":-4}],"sizeInsertions":84,"sizeDeletions":-12},{"number":"4","revision":"3a19036dde38e8de08f9e42f55f9cafc4b4e44fd","parents":["6aaf159ea324821122771dc6552e8ed77cc1f8fe"],"ref":"refs/changes/57/5757/4","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1554489630,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553798258,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554489039,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553702500,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/make/bin/globals.cc","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/make/bin/main.cc","type":"MODIFIED","insertions":47,"deletions":-6},{"file":"usr/src/cmd/make/bin/misc.cc","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/cmd/make/include/mk/defs.h","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/man/man1/make.1","type":"MODIFIED","insertions":17,"deletions":-4}],"sizeInsertions":84,"sizeDeletions":-12},{"number":"5","revision":"ff1603a29d41ea115360ea42106b5881d604c113","parents":["6aaf159ea324821122771dc6552e8ed77cc1f8fe"],"ref":"refs/changes/57/5757/5","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1554490052,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1554490058,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553798258,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554489039,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553702500,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/make/bin/globals.cc","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/make/bin/main.cc","type":"MODIFIED","insertions":47,"deletions":-6},{"file":"usr/src/cmd/make/bin/misc.cc","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/cmd/make/include/mk/defs.h","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/man/man1/make.1","type":"MODIFIED","insertions":17,"deletions":-4}],"sizeInsertions":84,"sizeDeletions":-12}],"allReviewers":[{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}]}