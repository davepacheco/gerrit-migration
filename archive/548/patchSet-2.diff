commit 253cdf8548886b27ffebdad2e524643e1727b7b0 (refs/changes/48/548/2)
Author: Alex Wilson <alex.wilson@joyent.com>
Date:   2016-09-29T14:12:02-07:00 (3 years ago)
    
    joyent/node-cueball#27 dynamic resolver mode broken
    joyent/node-cueball#28 cbresolve broken in 0.5.0

diff --git a/bin/cbresolve b/bin/cbresolve
index 21d6d18..8f355be 100755
--- a/bin/cbresolve
+++ b/bin/cbresolve
@@ -208,8 +208,13 @@ function main()
 	cbrResolver.on('removed', cbrPrintRemoved);
 
 	if (!cbrFollow) {
-		cbrResolver.onState('running', cbrRunning);
-		cbrResolver.onState('failed', cbrFailed);
+		cbrResolver.on('stateChanged', function (st) {
+			if (st === 'running') {
+				cbrRunning();
+			} else if (st === 'failed') {
+				cbrFailed();
+			}
+		});
 		process.on('exit', function (code) {
 			if (code === 0) {
 				mod_assert.ok(cbrDone, 'premature exit');
diff --git a/lib/resolver.js b/lib/resolver.js
index 0b7bb66..85e208a 100644
--- a/lib/resolver.js
+++ b/lib/resolver.js
@@ -304,13 +304,14 @@ CueBallDNSResolver.prototype.state_check_ns = function (S) {
 		this.r_bootstrap =
 		    CueBallDNSResolver.bootstrapResolvers[notIp[0]];
 		if (this.r_bootstrap === undefined) {
-			this.r_bootstrap = new CueBallDNSResolver({
+			var res = new CueBallDNSResolver({
 				domain: notIp[0],
 				service: '_dns._udp',
 				defaultPort: 53,
 				log: this.r_log,
 				recovery: this.r_recovery
 			});
+			this.r_bootstrap = res.r_fsm;
 			CueBallDNSResolver.bootstrapResolvers[notIp[0]] =
 			    this.r_bootstrap;
 		}
diff --git a/package.json b/package.json
index 9448f88..ad16a87 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "cueball",
-  "version": "0.5.0",
+  "version": "0.5.1",
   "description": "",
   "main": "lib/index.js",
   "dependencies": {
