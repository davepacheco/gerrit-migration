From 39c3ef300677aa5a6d9ca87d3ce0e01b05a2ec33 Mon Sep 17 00:00:00 2001
From: Gordon Ross <gwr@nexenta.com>
Date: Mon, 28 Aug 2017 21:50:05 +0000
Subject: [PATCH] OS-6297 SMB server ioctls should be appropriately sized

---
 usr/src/uts/common/fs/smbsrv/smb_init.c | 19 ++++++++++---------
 1 file changed, 10 insertions(+), 9 deletions(-)

diff --git a/usr/src/uts/common/fs/smbsrv/smb_init.c b/usr/src/uts/common/fs/smbsrv/smb_init.c
index 2843537ada..26ac1c2a5e 100644
--- a/usr/src/uts/common/fs/smbsrv/smb_init.c
+++ b/usr/src/uts/common/fs/smbsrv/smb_init.c
@@ -261,18 +261,20 @@ smb_drv_ioctl(dev_t drv, int cmd, intptr_t argp, int flags, cred_t *cred,
 	boolean_t	copyout = B_FALSE;
 	int		rc = 0;
 
-	if (ddi_copyin((const void *)argp, &ioc_hdr, sizeof (smb_ioc_header_t),
-	    flags) || (ioc_hdr.version != SMB_IOC_VERSION))
+	if (ddi_copyin((void *)argp, &ioc_hdr, sizeof (ioc_hdr), flags))
 		return (EFAULT);
+	if (ioc_hdr.version != SMB_IOC_VERSION ||
+	    ioc_hdr.len > sizeof (smb_ioc_t))
+		return (EINVAL);
 
 	crc = ioc_hdr.crc;
 	ioc_hdr.crc = 0;
 	if (smb_crc_gen((uint8_t *)&ioc_hdr, sizeof (ioc_hdr)) != crc)
-		return (EFAULT);
+		return (EINVAL);
 
-	ioc = kmem_alloc(ioc_hdr.len, KM_SLEEP);
-	if (ddi_copyin((const void *)argp, ioc, ioc_hdr.len, flags)) {
-		kmem_free(ioc, ioc_hdr.len);
+	ioc = kmem_zalloc(sizeof (*ioc), KM_SLEEP);
+	if (ddi_copyin((void *)argp, ioc, ioc_hdr.len, flags)) {
+		kmem_free(ioc, sizeof (*ioc));
 		return (EFAULT);
 	}
 
@@ -325,11 +327,10 @@ smb_drv_ioctl(dev_t drv, int cmd, intptr_t argp, int flags, cred_t *cred,
 		break;
 	}
 	if ((rc == 0) && copyout) {
-		if (ddi_copyout((const void *)ioc, (void *)argp, ioc_hdr.len,
-		    flags))
+		if (ddi_copyout(ioc, (void *)argp, ioc_hdr.len, flags))
 			rc = EFAULT;
 	}
-	kmem_free(ioc, ioc_hdr.len);
+	kmem_free(ioc, sizeof (*ioc));
 	return (rc);
 }
 
-- 
2.21.0

