{"project":"joyent/illumos-joyent","branch":"master","id":"Ic6f905766eb40c4295246520607032b0d63fe48f","number":"4678","subject":"OS-7124 ::xcall would be useful Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"url":"https://cr.joyent.us/4678","commitMessage":"OS-7124 ::xcall would be useful\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1534240502,"lastUpdated":1534517715,"open":false,"status":"MERGED","comments":[{"timestamp":1534240502,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 1."},{"timestamp":1534240506,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit dd3f2b22123452fa5ef8742c316ebfadc30a1725\n    \n    m\n    \n    commit 5999c1a5fbd928222e97d55d35e6358c580369eb\n    \n    m\n    \n    commit 41da68411860da0521380cae4c3707e931534822\n    \n    m\n    \n    commit e31810a18d14cd002a2cbe3270b478b984bf4fd7\n    \n    m\n    \n    commit c9891c912aa645698793907179d50fb3f58e4b46\n    \n    m"},{"timestamp":1534244073,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 2."},{"timestamp":1534244085,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit b6b5b16b3ecceb2caf47d25297b8a1dfb77ff277\n    \n    m"},{"timestamp":1534261522,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(4 comments)\n\nThanks for putting this together."},{"timestamp":1534262814,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1534284613,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nThis looks good to me, I don\u0027t have anything to add beyond Robert\u0027s comments. I\u0027m fine with the trailing commas if you want to leave it that way."},{"timestamp":1534285125,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1534333626,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1534333876,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 3."},{"timestamp":1534333890,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 3fbe4ac5a1878993c5d2b14628a6205aa5465a42\n    \n    m\n    \n    commit 809826f22eeab1fdc6c24a8beaa20839437b878a\n    \n    m\n    \n    commit 1516501891d564b50ac9453373f8e410e3383d2c\n    \n    m\n    \n    commit 8eedce0fdb0df26d384de4ca63848322e61a474e\n    \n    m\n    \n    commit a244aa83b04a1ee153c1eef81462ad4dc35410b9\n    \n    m\n    \n    commit 4ae0b46eea6da07548ff3e8a2c3da37320a6193f\n    \n    m\n    \n    commit 71aa4a4f852e88ade3c5034819a7c265e64978d2\n    \n    m\n    \n    commit 673bfff39025c32723195ea742b3dff2a46b7565\n    \n    m"},{"timestamp":1534335209,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1534463628,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1534510192,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1534510625,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1534510628,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 5a49448dcbd5564af9f70bb39d9e75316e7b0027\n    \n    m\n    \n    commit 3008ddbdd627b63b00351a2aff9237578d81c20a\n    \n    m\n    \n    commit 457844ab96b8e60da2143bac4544c8e58a3b9269\n    \n    m\n    \n    commit f91e3fba2323a69a82cc32fcaf38b948b421bd76\n    \n    m\n    \n    commit 6c83a6ebb65e5fa9f2b27260fb74d91e8835e13d\n    \n    m\n    \n    commit 35cfc758294f7652098f1789579198f9759f70f5\n    \n    m\n    \n    commit a2f713f9652e0ffbb917f8d5ffb7a423bd3f3b0d\n    \n    m\n    \n    commit 495bc5a67d95ad5cc31fc74f6ede02867f6f4fde\n    \n    m"},{"timestamp":1534517715,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by John Levon"}],"currentPatchSet":{"number":"5","revision":"c6f905766eb40c4295246520607032b0d63fe48f","parents":["b024317c8de8fc6aa55e87767b0e084ba5941ce7"],"ref":"refs/changes/78/4678/5","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1534510625,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534335209,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534463628,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534463628,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1534517715,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/unix.c","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/xcall.c","type":"ADDED","insertions":237,"deletions":0},{"file":"usr/src/cmd/mdb/i86xpv/modules/unix/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/i86pc/os/x_call.c","type":"MODIFIED","insertions":35,"deletions":-35},{"file":"usr/src/uts/i86pc/sys/machcpuvar.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/sys/x_call.h","type":"MODIFIED","insertions":9,"deletions":-5}],"sizeInsertions":314,"sizeDeletions":-61},"patchSets":[{"number":"1","revision":"10a48d39252a1d5f088994af077087fef8be09c3","parents":["b50884db8d84f652919a0d7b6fd6dd3d28fb035e"],"ref":"refs/changes/78/4678/1","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1534240502,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","type":"MODIFIED","insertions":16,"deletions":-11},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/unix.c","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/xcall.c","type":"ADDED","insertions":247,"deletions":0},{"file":"usr/src/cmd/mdb/i86xpv/modules/unix/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/i86pc/os/intr.c","type":"MODIFIED","insertions":8,"deletions":-12},{"file":"usr/src/uts/i86pc/os/x_call.c","type":"MODIFIED","insertions":35,"deletions":-35},{"file":"usr/src/uts/i86pc/sys/machcpuvar.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/i86pc/sys/x_call.h","type":"MODIFIED","insertions":9,"deletions":-5}],"sizeInsertions":332,"sizeDeletions":-74},{"number":"2","revision":"782cf77a1803ac3ef44388b3820be2d10df13489","parents":["b50884db8d84f652919a0d7b6fd6dd3d28fb035e"],"ref":"refs/changes/78/4678/2","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1534244073,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","line":1666,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027m pro this not being a UM_GC, but think about the case where this is happening inside of something like a ::stacks and someone hits ctrl+c. Will we end up leaking that state because we escape out?"},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","line":1666,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uh, I actually have no idea how this is supposed to work, though of course this is not the only instance. I\u0027ll go investigate?"},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","line":1666,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Indeed, if we happen to get a ^C in between the alloc+free here, we\u0027ll longjmp back up to the top of our state, and leak the buffer.\n\nIf we happen to generate enough errors to hit the pager, though, then it can leak, and even wrapping in mdb_intr_disable/enable() won\u0027t help this case.\n\nIt\u0027s tempting to insert explicit GC calls. Unfortunately, that ends up zapping the walk state too.\n\nI suppose we could probably introduce a new alloc flag and store those buffers on a new list, then have mdb_gc() only clean up UM_EXPLICIT_GC buffers?\n\nI\u0027m just not sure it\u0027s worth the added complexity. The problem seems prevalent all over MDB already, the window seems pretty small, and it hasn\u0027t seemed to be an issue yet."},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/xcall.c","line":20,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Please use new header in prototypes/"},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/xcall.c","line":112,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is there a reason there\u0027s nothing after the comma?"},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/xcall.c","line":112,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Probably a little stylistic tick of mine? To me it translates as \"oh, and zero the rest of the struct too\". But no problem removing comma if you\u0027d prefer."},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/xcall.c","line":112,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I see. As long as compilers are fine with it. I guess I\u0027m used to Studio in the day always being angry about trailing commas in arrays."},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/xcall.c","line":184,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Same question about trailing commas."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/unix.c","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/xcall.c","type":"ADDED","insertions":247,"deletions":0},{"file":"usr/src/cmd/mdb/i86xpv/modules/unix/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/i86pc/os/intr.c","type":"MODIFIED","insertions":8,"deletions":-12},{"file":"usr/src/uts/i86pc/os/x_call.c","type":"MODIFIED","insertions":35,"deletions":-35},{"file":"usr/src/uts/i86pc/sys/machcpuvar.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/i86pc/sys/x_call.h","type":"MODIFIED","insertions":9,"deletions":-5}],"sizeInsertions":333,"sizeDeletions":-74},{"number":"3","revision":"21a7c086bcd3753ba12ca2a48865c67af7eacffe","parents":["4f3af6ac0e7bc423c116341136c1757ff948a506"],"ref":"refs/changes/78/4678/3","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1534333876,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534463628,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534463628,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534335209,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/unix.c","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/xcall.c","type":"ADDED","insertions":237,"deletions":0},{"file":"usr/src/cmd/mdb/i86xpv/modules/unix/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/i86pc/os/x_call.c","type":"MODIFIED","insertions":35,"deletions":-35},{"file":"usr/src/uts/i86pc/sys/machcpuvar.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/sys/x_call.h","type":"MODIFIED","insertions":9,"deletions":-5}],"sizeInsertions":314,"sizeDeletions":-61},{"number":"4","revision":"6615e586f1f53a7a1a71092f025371f5640daa2e","parents":["b024317c8de8fc6aa55e87767b0e084ba5941ce7"],"ref":"refs/changes/78/4678/4","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1534510192,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534463628,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534463628,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534335209,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/unix.c","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/xcall.c","type":"ADDED","insertions":237,"deletions":0},{"file":"usr/src/cmd/mdb/i86xpv/modules/unix/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/i86pc/os/x_call.c","type":"MODIFIED","insertions":35,"deletions":-35},{"file":"usr/src/uts/i86pc/sys/machcpuvar.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/sys/x_call.h","type":"MODIFIED","insertions":9,"deletions":-5}],"sizeInsertions":314,"sizeDeletions":-61},{"number":"5","revision":"c6f905766eb40c4295246520607032b0d63fe48f","parents":["b024317c8de8fc6aa55e87767b0e084ba5941ce7"],"ref":"refs/changes/78/4678/5","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1534510625,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534463628,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534463628,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534335209,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1534517715,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/unix.c","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"usr/src/cmd/mdb/i86pc/modules/unix/xcall.c","type":"ADDED","insertions":237,"deletions":0},{"file":"usr/src/cmd/mdb/i86xpv/modules/unix/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/i86pc/os/x_call.c","type":"MODIFIED","insertions":35,"deletions":-35},{"file":"usr/src/uts/i86pc/sys/machcpuvar.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/sys/x_call.h","type":"MODIFIED","insertions":9,"deletions":-5}],"sizeInsertions":314,"sizeDeletions":-61}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}]}