{"project":"joyent/sdc-amon","branch":"master","id":"Ic50f0c906f8b7489ab881f5703bc264e0309ce69","number":"3275","subject":"TRITON-85 log-scan probe plugin does not work for SMF services that run multiple instances per zone","owner":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"url":"https://cr.joyent.us/3275","commitMessage":"TRITON-85 log-scan probe plugin does not work for SMF services that run multiple instances per zone\n","createdOn":1517244983,"lastUpdated":1526062831,"open":false,"status":"MERGED","comments":[{"timestamp":1517244983,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 1."},{"timestamp":1517244985,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 5234aca4ad7cc2986ce3601d6b535209c18d1931\n    \n    TRITON-85 log-scan probe plugin does not work for SMF services that run multiple instances per zone"},{"timestamp":1517245015,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1518051203,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1519749610,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 2."},{"timestamp":1519749612,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit ba24881bcc16b9723cca51f16d0be05c3d09e7b6\n    \n    Rename _pathCache to _pathsCache and make it an array"},{"timestamp":1519749900,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1519751178,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n(3 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1519751667,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\nkelly, Thanks! Are you able to push a fix for the \u0027make check\u0027 failures quickly, and then I can look."},{"timestamp":1519752226,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 3."},{"timestamp":1519752228,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit fd642e0a30ed243879c772fd4b7299442c748a65\n    \n    Fix make check issues"},{"timestamp":1519752254,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1519753692,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\n\u003e kelly, Thanks! Are you able to push a fix for the \u0027make check\u0027\n \u003e failures quickly, and then I can look.\n\nDone, thanks."},{"timestamp":1525991689,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(2 comments)\n\nKelly,\n\nSorry for the ridiculous delay in reviewing this!\n\nHere is a suggestion for tweaking the _getMessage for those two probes: https://gist.github.com/trentm/47f24679787b1ccc7f6951aea48b382f\nThoughts on including that?\n\nAside: this also needs a rebase on master."},{"timestamp":1526060249,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 4."},{"timestamp":1526060251,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit a30eccd06ba6d4c28546f8fd6ddeae7c8c429c7e\n    \n    Updates from review feedback\n    \n    commit d57aeb6f62df819f465325cb624760d5004a3809\n    \n    Fix make check issues\n    \n    commit 94f5e911373a3ca3fab7f2d6919785d9ab40d90f\n    \n    Rename _pathCache to _pathsCache and make it an array\n    \n    commit d767328af9da1ca02edd04630057ec2672dabf5d\n    \n    TRITON-85 log-scan probe plugin does not work for SMF services that run multiple instances per zone"},{"timestamp":1526060278,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1526060801,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1526062831,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Kelly McLaughlin"}],"currentPatchSet":{"number":"4","revision":"c50f0c906f8b7489ab881f5703bc264e0309ce69","parents":["cb3a4e3f48c7ef75e4986e7630b25d7975c48223"],"ref":"refs/changes/75/3275/4","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1526060249,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1526060278,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1526060801,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1526060801,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1526062831,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"plugins/lib/bunyan-log-scan.js","type":"MODIFIED","insertions":12,"deletions":-7},{"file":"plugins/lib/log-scan.js","type":"MODIFIED","insertions":28,"deletions":-22}],"sizeInsertions":40,"sizeDeletions":-29},"patchSets":[{"number":"1","revision":"e1e8918e99f14a72ae9bc784955a94b9bc201d7e","parents":["ec495e5dcaa3ae0282de015be9e425b7f318cc5d"],"ref":"refs/changes/75/3275/1","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1517244983,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517245015,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"plugins/lib/log-scan.js","line":176,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I don\u0027t think this works as expected. The multiple space-separated paths will be set as a single argv entry in the spawned process. E.g. when I tried this in my CNAPI zone:\n\n```\n[root@bdf72750-a40d-41e9-8605-2d245de04ac1 (nightly-1:cnapi0) /opt/amon-agent]# ./build/node/bin/node\n\u003e var child_process \u003d require(\u0027child_process\u0027),\n...     spawn \u003d child_process.spawn,\n...     execFile \u003d child_process.execFile;\nundefined\n\u003e path \u003d \"smartdc-site-cnapi:default.log smartdc-agent-amon-agent:default.log\"\n\u0027smartdc-site-cnapi:default.log smartdc-agent-amon-agent:default.log\u0027\n\u003e var tail \u003d spawn(\u0027/usr/bin/tail\u0027, [\u0027-1cF\u0027, path]);\nundefined\n\u003e tail.stdout.on(\u0027data\u0027, function (chunk) {\n...     console.log(\u0027DATA: \u0027 + chunk);\n... });\n\u003e\n\u003e tail.on(\u0027exit\u0027, function (code) {\n...     console.log(\u0027EXIT\u0027);\n... });\n\u003e\n```\n\nThe process spawned is this:\n\n```\n[root@bdf72750-a40d-41e9-8605-2d245de04ac1 (nightly-1:cnapi0) ~]# ptree 30398\n7961  zsched\n  30360 /usr/bin/login -z global -f root\n    30361 -bash\n      30398 ./build/node/bin/node\n        30499 /usr/bin/tail -1cF smartdc-site-cnapi:default.log smartdc-agent-amon-agent:defa\n[root@bdf72750-a40d-41e9-8605-2d245de04ac1 (nightly-1:cnapi0) ~]# pargs 30499\n30499:  /usr/bin/tail -1cF smartdc-site-cnapi:default.log smartdc-agent-amon-agent:defa\nargv[0]: /usr/bin/tail\nargv[1]: -Fc-1\nargv[2]: smartdc-site-cnapi:default.log smartdc-agent-amon-agent:default.log\n```\n\nargv[2] is a file that will never get changes, so the tail never sees content.\n\nHow about changing _pathCache to _pathsCache (plural), and make it an array. Then it can be concatted with the other argv entries for the spawn call.\n\n(Eventually the log-scan probe could be updated to support taking one or more paths, but that could be for a separate ticket.)"},{"file":"plugins/lib/log-scan.js","line":176,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Thanks for the feedback! Sorry it took me a while to address it, but I pushed the suggested changes. I pasted an example of the output from amon using these changes in the Jira ticket."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"plugins/lib/log-scan.js","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":2,"sizeDeletions":-2},{"number":"2","revision":"2d11f5d93269bced59650753daa5dbdb96d6394d","parents":["ec495e5dcaa3ae0282de015be9e425b7f318cc5d"],"ref":"refs/changes/75/3275/2","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1519749610,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1519751178,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"plugins/lib/bunyan-log-scan.js","line":189,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"plugins/lib/log-scan.js","line":126,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"plugins/lib/log-scan.js","line":128,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"plugins/lib/bunyan-log-scan.js","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"plugins/lib/log-scan.js","type":"MODIFIED","insertions":20,"deletions":-19}],"sizeInsertions":24,"sizeDeletions":-23},{"number":"3","revision":"3b2062a5868de8bd95dc3a583129b8bb9d3aa9ed","parents":["ec495e5dcaa3ae0282de015be9e425b7f318cc5d"],"ref":"refs/changes/75/3275/3","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1519752226,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1519752254,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"plugins/lib/bunyan-log-scan.js","line":8,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"update copyright year"},{"file":"plugins/lib/log-scan.js","line":8,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"update copyright year"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"plugins/lib/bunyan-log-scan.js","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"plugins/lib/log-scan.js","type":"MODIFIED","insertions":22,"deletions":-19}],"sizeInsertions":28,"sizeDeletions":-23},{"number":"4","revision":"c50f0c906f8b7489ab881f5703bc264e0309ce69","parents":["cb3a4e3f48c7ef75e4986e7630b25d7975c48223"],"ref":"refs/changes/75/3275/4","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1526060249,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1526060278,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1526060801,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1526060801,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1526062831,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"plugins/lib/bunyan-log-scan.js","type":"MODIFIED","insertions":12,"deletions":-7},{"file":"plugins/lib/log-scan.js","type":"MODIFIED","insertions":28,"deletions":-22}],"sizeInsertions":40,"sizeDeletions":-29}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}]}