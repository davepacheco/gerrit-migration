{"project":"joyent/sdcadm","branch":"master","id":"I78af5307d8239e94f4b00b70c3c8b5664ccd3c6c","number":"4438","subject":"TRITON-537 `sdcadm post-setup ha-manatee` fails creating manatee2 Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/4438","commitMessage":"TRITON-537 `sdcadm post-setup ha-manatee` fails creating manatee2\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1530038180,"lastUpdated":1530264252,"open":false,"status":"MERGED","comments":[{"timestamp":1530038180,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1530038185,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit fc6d34e9718add3b748d3db05da7c98c5b5c9837\n    \n    TRITON-537 `sdcadm post-setup ha-manatee` fails creating manatee2"},{"timestamp":1530038215,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1530039556,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1530119226,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1530119231,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 8f9ead4d4f88c2eef8530a39818a6c4057f1736f\n    \n    TRITON-537 `sdcadm post-setup ha-manatee` fails creating manatee2"},{"timestamp":1530119261,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1530119364,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\n(4 comments)\n\nI\u0027d say we should open an issue for the owner_uuid think across the whole sdcadm source, since that pretty much affects every file."},{"timestamp":1530141202,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2: Code-Review+1\n\n(2 comments)\n\nI\u0027d be a little more comfortable given a ticket on workflow that wf-runner cannot just get stuck if it happens to fail to talk to moray that once (assuming I understood the logs correctly in my notes on the ticket)."},{"timestamp":1530183151,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\n(2 comments)\n\n\u003e (2 comments)\n \u003e \n \u003e I\u0027d be a little more comfortable given a ticket on workflow that\n \u003e wf-runner cannot just get stuck if it happens to fail to talk to\n \u003e moray that once (assuming I understood the logs correctly in my\n \u003e notes on the ticket).\n\nhttps://jira.joyent.us/browse/TRITON-559 it is.\n\nDone with the other issue + a little explanation of the leading * requirements :) Thanks!"},{"timestamp":1530183269,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3."},{"timestamp":1530183273,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 8e7c6cf63cfcd7bc5cbb2c4609e1e90d5b918cd4\n    \n    TRITON-537 `sdcadm post-setup ha-manatee` fails creating manatee2"},{"timestamp":1530183303,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1530209419,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1\n\nCould be this to be explicit:\n\n```\n[root@0cf6d95b-a8c1-4c4d-828c-20edd31e1adb (nightly-1:moray0) ~]# svcs -L svc:/smartdc/application/moray:*\n/var/svc/log/smartdc-application-moray:moray-2024.log\n/var/svc/log/smartdc-application-moray:moray-2023.log\n/var/svc/log/smartdc-application-moray:moray-2022.log\n/var/svc/log/smartdc-application-moray:moray-2021.log\n```\n\n;)  but it\u0027s fine. Thanks for the explanation!"},{"timestamp":1530264172,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1530264215,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1530264224,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"},{"timestamp":1530264252,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"5","revision":"fea83b339f6fdf3be7f16d09541446c73aee7bdd","parents":["c906dedd438b26a23c20ba9a0261bc15cdb03884"],"ref":"refs/changes/38/4438/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1530264215,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530183303,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530209419,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530209419,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1530264224,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/post-setup/ha-manatee.js","type":"MODIFIED","insertions":85,"deletions":0},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/steps/binder.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/steps/zookeeper.js","type":"MODIFIED","insertions":6,"deletions":-3}],"sizeInsertions":109,"sizeDeletions":-13},"patchSets":[{"number":"1","revision":"bcdaa117f799bb16441b253179d256eb97a55a05","parents":["ea39aeca8a39b78bfecea2864c9e2a4cd8502249"],"ref":"refs/changes/38/4438/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1530038180,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530038215,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/post-setup/ha-manatee.js","line":448,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Should include owner_uuid\u003d$admin, I think."},{"file":"lib/post-setup/ha-manatee.js","line":448,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"If that\u0027s the case, we should go through the whole sdcadm code and modify it for everything using VMAPI to fetch core VMs using smartdc_role tag."},{"file":"lib/post-setup/ha-manatee.js","line":448,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Yes, probably. SdcAdm.prototype.listInsts already does this.\nThat others do it wrong isn\u0027t a reason not to do it correctly here."},{"file":"lib/post-setup/ha-manatee.js","line":448,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done for everything using it w/o admin UUID. Moving forward"},{"file":"lib/post-setup/ha-manatee.js","line":463,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Should include owner_uuid\u003d$admin, I think."},{"file":"lib/post-setup/ha-manatee.js","line":463,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Ditto"},{"file":"lib/post-setup/ha-manatee.js","line":670,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps \u0027moray-*\u0027 so we don\u0027t need to know about the port prefix used in Moray. Also... this reaching into Moray is pretty gross. :)"},{"file":"lib/post-setup/ha-manatee.js","line":670,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/post-setup/ha-manatee.js","line":686,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Why did you find this was necessary?\n\nBasically this having to restart various services by reaching into them for a manatee topology change should be considered a bug in those services, right? At least a bug that *workflow* needs to be poked for this.  I\u0027m not sure if we should expect that the Moray service needs a poke for these changes or not."},{"file":"lib/post-setup/ha-manatee.js","line":686,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"As we commented yesterday through chat, this is more about speeding up the reconnection: I\u0027ve seen these services reconnect successfully given them enough time but, considering we usually perform consecutive sdcadm tasks, the faster we return the system to its healthier state, the better. Therefore the restart of these services instead of being waiting for whatever it\u0027s the timestamp set for the next re-connection attempt."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/post-setup/ha-manatee.js","type":"MODIFIED","insertions":83,"deletions":0}],"sizeInsertions":83,"sizeDeletions":0},{"number":"2","revision":"ded7591e9f8fbd3a761a19ac55641645bf28d53b","parents":["ea39aeca8a39b78bfecea2864c9e2a4cd8502249"],"ref":"refs/changes/38/4438/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1530119226,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530119261,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530141202,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"lib/procedures/update-manatee-v2.js","line":1132,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Nit: I\u0027m not sure if the leading \"*\" is a good idea. It is fine though. I suppose you can tell me there are bigger fish to fry than a random SMF manifest named \"foomoray\" showing up.\n\nOh, I hadn\u0027t realized the existing code already does this."},{"file":"lib/procedures/update-manatee-v2.js","line":1132,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"There\u0027s a reason for the leading *, the manifest name isn\u0027t \"moray-xxxx\" but svc:/smartdc/application/moray:moray-XXXX, therefore:\n\n[root@1e03a6c1-e35d-4777-92ec-a0ea896c9ffa (coal:moray0) ~]# svcs -L moray*\nsvcs: Pattern \u0027svc:/moray*\u0027 doesn\u0027t match any instances\n[root@1e03a6c1-e35d-4777-92ec-a0ea896c9ffa (coal:moray0) ~]# svcs -L *moray*\n/var/svc/log/smartdc-application-moray:moray-2024.log\n/var/svc/log/smartdc-application-moray:moray-2023.log\n/var/svc/log/smartdc-application-moray:moray-2022.log\n/var/svc/log/smartdc-application-moray:moray-2021.log"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/post-setup/ha-manatee.js","type":"MODIFIED","insertions":83,"deletions":0},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":85,"sizeDeletions":-2},{"number":"3","revision":"2dba7ac6c5765b8f2f3f798b1d0d6b17e0cc258b","parents":["ea39aeca8a39b78bfecea2864c9e2a4cd8502249"],"ref":"refs/changes/38/4438/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1530183269,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530183303,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530209419,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530209419,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/post-setup/ha-manatee.js","type":"MODIFIED","insertions":85,"deletions":0},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/steps/binder.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/steps/zookeeper.js","type":"MODIFIED","insertions":6,"deletions":-3}],"sizeInsertions":109,"sizeDeletions":-13},{"number":"4","revision":"78af5307d8239e94f4b00b70c3c8b5664ccd3c6c","parents":["ea39aeca8a39b78bfecea2864c9e2a4cd8502249"],"ref":"refs/changes/38/4438/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1530264172,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530183303,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530209419,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530209419,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/post-setup/ha-manatee.js","type":"MODIFIED","insertions":85,"deletions":0},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/steps/binder.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/steps/zookeeper.js","type":"MODIFIED","insertions":6,"deletions":-3}],"sizeInsertions":109,"sizeDeletions":-13},{"number":"5","revision":"fea83b339f6fdf3be7f16d09541446c73aee7bdd","parents":["c906dedd438b26a23c20ba9a0261bc15cdb03884"],"ref":"refs/changes/38/4438/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1530264215,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530183303,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530209419,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530209419,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1530264224,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/post-setup/ha-manatee.js","type":"MODIFIED","insertions":85,"deletions":0},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/steps/binder.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/steps/zookeeper.js","type":"MODIFIED","insertions":6,"deletions":-3}],"sizeInsertions":109,"sizeDeletions":-13}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}