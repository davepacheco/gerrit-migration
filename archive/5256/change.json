{"project":"joyent/pgstatsmon","branch":"master","id":"Ifdf3247a3963384f2104e88e9169b0e90f188ad0","number":"5256","subject":"joyent/pgstatsmon#23 Negative byte lag calculated from pgstatsmon metrics after shard rebuild","owner":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"url":"https://cr.joyent.us/5256","commitMessage":"joyent/pgstatsmon#23 Negative byte lag calculated from pgstatsmon metrics after shard rebuild\n","createdOn":1545080509,"lastUpdated":1558030978,"open":true,"status":"NEW","comments":[{"timestamp":1545080509,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 1."},{"timestamp":1545080516,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1545081173,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 2."},{"timestamp":1545081180,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1545081367,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1545164776,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1545242896,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1555344684,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 3."},{"timestamp":1555344713,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1558030947,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 4."},{"timestamp":1558030956,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1558030978,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"4","revision":"fdf3247a3963384f2104e88e9169b0e90f188ad0","parents":["b91156b38250b071a1f812f112a61ff829070808"],"ref":"refs/changes/56/5256/4","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1558030947,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558030978,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":7,"deletions":0},{"file":"bin/dtrace/walstat.d","type":"MODIFIED","insertions":46,"deletions":-12},{"file":"docs/migrating.md","type":"ADDED","insertions":76,"deletions":0},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/queries.js","type":"MODIFIED","insertions":7,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":139,"sizeDeletions":-21},"patchSets":[{"number":"1","revision":"012fae009cec99d49309d383d0a3161876a5d0ae","parents":["84c687ce7178f92097929bfff560c470ceefd83a"],"ref":"refs/changes/56/5256/1","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1545080509,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1545080516,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/migrating.md","line":37,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Why is `pg_recovery_wal_received_bytes` not susceptible to the same problem of being a counter? Couldn\u0027t that value also decrease in the case of a role change?"},{"file":"docs/migrating.md","line":37,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"That\u0027s a good question. I didn\u0027t test this. I assumed that it wouldn\u0027t be affected in the same way.\n\nI think the key issue is that most of the pg_stat_replication stats report on the _downstream_ PG, which can change at any time. The pg_recovery set of stats only report on the PG being queried (and not a downstream server), so I think they shouldn\u0027t change... but I need to test that and will update with a comment in the GitHub issue when I have results."},{"file":"docs/migrating.md","line":37,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I finally got around to testing this. It appears that the stats we get from the WAL position administrative functions (like pg_current_xlog_flush_location() and friends) can safely operate as counters. I did a role change while running\n\n    select pg_last_xlog_receive_location() as recv, pg_last_xlog_replay_location() as repl;\n\nin a .2 second \\watch and the values continued to increment. I think this makes sense. In order for the value returned by the first function to decrease the upstream server would have to re-send WAL segments that have already been received by the downstream server. For the second function to have its value decrease the local server would have to re-replay previous WAL segments. I don\u0027t think either of these things happens.\n\nHowever, there _is_ a problem here. All of these leave around garbage after a sync gets promoted to primary because of pgstatsmon#22.\n\nAlso, I notice that I mention pgstatsmon#22 instead of pgstatsmon#23 in this migrating.md file. pgstatsmon#22 isn\u0027t fixed yet. I\u0027ll correct that issue."},{"file":"lib/queries.js","line":140,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"The \u0027pg\u0027 module interprets 8-byte \u0027numeric\u0027 typed values as a strings. When these were counters that wasn\u0027t an issue because pgstatsmon would perform math on these values to convert them into the difference since the query was last run. Gauge fields have their values passed directly into node-artedi which will assert that the thing being passed in is actually a number and not a string.\n\nTo avoid casting _everything_ as a number in the main pgstatsmon code I figured we could be deliberate and cast only the things that we know will be cast to strings by the \u0027pg\u0027 module.\n\nThis is probably a bug that should be fixed in node-artedi too, since node-artedi should be able to observe data points greater than MAX_SAFE_INTEGER, at least for the gauge type where no arithmetic is needed (usually)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":7,"deletions":0},{"file":"docs/migrating.md","type":"ADDED","insertions":76,"deletions":0},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/queries.js","type":"MODIFIED","insertions":7,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":93,"sizeDeletions":-9},{"number":"2","revision":"84286f50c75b524c97b69d5f409cea75e6c1c346","parents":["84c687ce7178f92097929bfff560c470ceefd83a"],"ref":"refs/changes/56/5256/2","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1545081173,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1545081180,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":7,"deletions":0},{"file":"docs/migrating.md","type":"ADDED","insertions":76,"deletions":0},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/queries.js","type":"MODIFIED","insertions":7,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":93,"sizeDeletions":-9},{"number":"3","revision":"5c7441accf42db7bf29cdb25e254664f14f8f4b6","parents":["b91156b38250b071a1f812f112a61ff829070808"],"ref":"refs/changes/56/5256/3","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1555344684,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1555344713,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":7,"deletions":0},{"file":"bin/dtrace/walstat.d","type":"MODIFIED","insertions":46,"deletions":-12},{"file":"docs/migrating.md","type":"ADDED","insertions":76,"deletions":0},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/queries.js","type":"MODIFIED","insertions":7,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":139,"sizeDeletions":-21},{"number":"4","revision":"fdf3247a3963384f2104e88e9169b0e90f188ad0","parents":["b91156b38250b071a1f812f112a61ff829070808"],"ref":"refs/changes/56/5256/4","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1558030947,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558030978,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":7,"deletions":0},{"file":"bin/dtrace/walstat.d","type":"MODIFIED","insertions":46,"deletions":-12},{"file":"docs/migrating.md","type":"ADDED","insertions":76,"deletions":0},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/queries.js","type":"MODIFIED","insertions":7,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":139,"sizeDeletions":-21}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}]}