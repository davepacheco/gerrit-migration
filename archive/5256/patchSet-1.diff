commit 012fae009cec99d49309d383d0a3161876a5d0ae
Author: Kody A Kantor <kody@kkantor.com>
Date:   2018-12-17T21:00:57+00:00 (10 months ago)
    
    joyent/pgstatsmon#22 Stale metrics reported after shard changes state

diff --git a/CHANGES.md b/CHANGES.md
index 2ef4314..1dba0e5 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -3,6 +3,13 @@
 ## Not yet released
 None
 
+## 2.0.0
+* #22 Stale metrics reported after shard changes state
+  - This is a breaking change since pgstatsmon now returns gauges instead of
+    counters for the pg_stat_replication table data. This also moves pgstatsmon
+    to node-artedi 2.0.0, which includes a breaking histogram bucket change.
+    See [docs/migrating.md](./docs/migrating.md) for more information.
+
 ## 1.1.0
 * #18 pgstatsmon shouldn't try to create functions that depend on missing functions
 * #17 pgstatsmon should support discovering backend IPs via nic_tag regex
diff --git a/docs/migrating.md b/docs/migrating.md
new file mode 100644
index 0000000..b36c0de
--- /dev/null
+++ b/docs/migrating.md
@@ -0,0 +1,76 @@
+# Migrating from pgstatsmon v1.x to v2.x
+
+pgstatsmon#22 intoduced a pair of breaking changes:
+- Data retrieved from pg_stat_replication is now intepreted as a set of gauges
+  rather than counters.
+- Updated the node-artedi dependency from v1.4.0 to v2.0.0.
+
+We'll cover below how to overcome these two breaking changes.
+
+## pg_stat_replication change
+
+In short, this change modifies the pg_stat_replication data from representing
+the number of WAL bytes written since the backend was discovered to representing
+the number of WAL bytes written since the beginning of the backend's existence.
+
+How this change affects your systems depends on how you're using the
+pg_stat_replication data. If your monitoring system is currently measuring these
+data points in relation to other data points within the pg_stat_replication data
+it is likely no change is necessary for your monitoring system. For example, if
+you are trying to monitor a downstream peer's apply lag in bytes, today you
+might use a query like this:
+
+```
+pg_stat_replication_wal_sent_bytes - pg_stat_replication_replica_wal_replayed_bytes
+```
+
+Good news! Queries like that will now be more accurate and no change is
+necessary to get the benefits of the #22 bug fix.
+
+However, if your monitoring system measures pg_stat_replication values against
+non-pg_stat_replication data, the result of the query will likely be drastically
+different in pgstatsmon v2. Take this example which is a query for trying to
+track WAL receive lag between the upstream and downstream peers in a Postgres
+deployment:
+
+```
+pg_stat_replication_wal_sent_bytes - pg_recovery_wal_received_bytes
+```
+
+In this example we are comparing two different data types, which is a problem.
+The first is a gauge type and the second is a counter type. In pgstatsmon v1
+both were counter types, so this was valid (though the data probably wasn't
+accurate).
+
+## node-artedi update
+
+The node-artedi change only affects histogram types. Currently the histogram
+type is only used by the 'querytime' set of metrics. These metrics measure the
+amount of time it took to execute each statistics gathering query against each
+backend. If you aren't consuming the querytime metrics then this breaking
+change does not apply.
+
+If your monitoring system consumes the querytime metrics, note that two changes
+were made:
+- query times are now reported in seconds rather than milliseconds.
+- the buckets used are now the 'standard' Prometheus histogram buckets instead
+  of a snowflake set of node-artedi buckets.
+
+This document is a good place to start to read about the breaking node-artedi
+change:
+https://github.com/joyent/node-artedi/blob/54b21b7631fbd6ea3f0ce48490f00c649596022e/docs/migrating.md
+
+To reduce the technical debt carried by pgstatsmon we've decided to shift the
+load of this change from pgstatsmon to the monitoring system. We recommend you
+do the following if you want to continue consuming the querytime metrics:
+
+- duplicate your querytime queries and graphs to consume both the
+  millisecond- and second-based querytime stats in your monitoring system.
+  - to fully avoid a breaking change each of the second-based statistics will
+    need to be multiplied by 1000 to convert them back into milliseconds.
+- update all pgstatsmon instances.
+- the (old) millisecond- and (new) second-based querytime stats should appear in
+  sequence together.
+- you can choose to keep both versions of the querytime queries in your
+  monitoring system, or drop the millisecond-based queries after the data has
+  passed through your metric data retention policy period.
diff --git a/lib/pgstatsmon.js b/lib/pgstatsmon.js
index 95d506f..ee78831 100644
--- a/lib/pgstatsmon.js
+++ b/lib/pgstatsmon.js
@@ -927,10 +927,10 @@ PgMon.prototype.tickPgQuery = function (pi, qi, cb)
 		timer = {
 			'attr': 'querytime',
 			'help': 'time to run stat query',
-			'unit': 'ms'
+			'unit': 'seconds'
 		};
 		mon.emitTimer(mon.qstatname(pi, qi, null, timer),
-		    mod_jsprim.hrtimeMillisec(time));
+		    mod_jsprim.hrtimeMillisec(time) / 1000);
 		mon.pm_state[pi][qi] = null;
 		setImmediate(cb);
 	});
diff --git a/lib/queries.js b/lib/queries.js
index e844ce4..7ed7f83 100644
--- a/lib/queries.js
+++ b/lib/queries.js
@@ -131,16 +131,17 @@ function getQueries(config) {
 	     'sql': [ /* this only works on Postgres 9.4+ */
 	         'SELECT ',
 	         'sync_state, ',
-	         'sent_location - CAST (\'0/0\' AS pg_lsn) AS wal_sent, ',
-	         'write_location - CAST (\'0/0\' AS pg_lsn) ',
+	         '(sent_location - CAST (\'0/0\' AS pg_lsn))::bigint ',
+	         'AS wal_sent, ',
+	         '(write_location - CAST (\'0/0\' AS pg_lsn))::bigint ',
 	         'AS replica_wal_written, ',
-	         'flush_location - CAST (\'0/0\' AS pg_lsn) ',
+	         '(flush_location - CAST (\'0/0\' AS pg_lsn))::bigint ',
 	         'AS replica_wal_flushed, ',
-	         'replay_location - CAST (\'0/0\' AS pg_lsn) AS ',
-	         'replica_wal_replayed ',
+	         '(replay_location - CAST (\'0/0\' AS pg_lsn))::bigint ',
+	         'AS replica_wal_replayed ',
 	         'FROM get_stat_replication();'
 	     ].join('\n'),
-	     'counters': [
+	     'gauges': [
 	         { 'attr': 'wal_sent',
 	           'help': 'wal bytes sent to replica', 'unit': 'bytes' },
 	         { 'attr': 'replica_wal_written',
diff --git a/package.json b/package.json
index 64be016..8b21643 100644
--- a/package.json
+++ b/package.json
@@ -7,7 +7,7 @@
 	},
 	"dependencies": {
 		"ajv": "5.5.1",
-		"artedi": "1.4.0",
+		"artedi": "2.0.0",
 		"assert-plus": "1.0.0",
 		"backoff": "2.5.0",
 		"bunyan": "1.8.10",
