From 9b9c019c49ec7102ab0cd54aad21b954cf25d1a5 Mon Sep 17 00:00:00 2001
From: Orlando Vazquez <ovazquez@gmail.com>
Date: Fri, 9 Dec 2016 12:42:00 -0800
Subject: [PATCH] AGENT-1047 cn-agent should use node v4.x

---
 Makefile               |  8 ++++----
 lib/task_agent/task.js |  3 +--
 npm/preinstall.sh      | 24 ++++++++++++++++++++++++
 package.json           | 28 ++++++++++++++--------------
 4 files changed, 43 insertions(+), 20 deletions(-)
 create mode 100755 npm/preinstall.sh

diff --git a/Makefile b/Makefile
index 798c3c8..3033115 100644
--- a/Makefile
+++ b/Makefile
@@ -5,7 +5,7 @@
 #
 
 #
-# Copyright 2015 Joyent, Inc.
+# Copyright 2016 Joyent, Inc.
 #
 
 #
@@ -37,10 +37,10 @@ JSSTYLE_FLAGS =		-o indent=4,doxygen,unparenthesized-return=0
 # doesn't know about (@@ENABLED@@)
 # SMF_MANIFESTS_IN = smf/manifests/cn-agent.xml.in
 
-NODE_PREBUILT_VERSION =	v0.10.26
+NODE_PREBUILT_VERSION =	v4.6.1
 NODE_PREBUILT_TAG =	gz
 ifeq ($(shell uname -s),SunOS)
-NODE_PREBUILT_IMAGE =	fd2cc906-8938-11e3-beab-4359c665ac99
+NODE_PREBUILT_IMAGE =	18b094b0-eb01-11e5-80c1-175dac7ddf02
 endif
 
 # Included definitions
@@ -106,7 +106,7 @@ test:
 test-coal:
 	./tools/rsync-to coal
 	ssh $(COAL) 'cd /opt/smartdc/agents/lib/node_modules/cn-agent \
-	    && /usr/node/bin/node \
+	    && /opt/smartdc/agents/lib/node_modules/cn-agent/node/bin/node \
 	    /opt/smartdc/agents/lib/node_modules/cn-agent/node_modules/.bin/nodeunit \
 	    --reporter default'
 
diff --git a/lib/task_agent/task.js b/lib/task_agent/task.js
index bd54454..5c4a050 100644
--- a/lib/task_agent/task.js
+++ b/lib/task_agent/task.js
@@ -5,14 +5,13 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2016, Joyent, Inc.
  */
 
 var EventEmitter = require('events').EventEmitter;
 var util = require('util');
 var fs = require('fs');
 var path = require('path');
-var JSV = require('JSV').JSV;
 var smartdc_config = require('./smartdc-config');
 var common = require('./common');
 var spawn = require('child_process').spawn;
diff --git a/npm/preinstall.sh b/npm/preinstall.sh
new file mode 100755
index 0000000..1e0e982
--- /dev/null
+++ b/npm/preinstall.sh
@@ -0,0 +1,24 @@
+#!/bin/bash
+#
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+#
+
+#
+# Copyright 2016 Joyent, Inc.
+#
+
+if [[ "${SDC_AGENT_SKIP_LIFECYCLE:-no}" = "yes" ]]; then
+    printf 'Running during package build; skipping lifecycle script.\n' >&2
+    exit 0
+fi
+
+# min-platform is now 20141030T081701Z, so refuse to install if someone is
+# trying to load on something older.
+if [[ $(uname -v | cut -d '_' -f2 | tr -d '[A-Z]') -lt 20141030081701 ]]; then
+    echo "FATAL: min-platform for this agent is 20141030T081701Z" >&2
+    exit 2
+fi
+
+exit 0
diff --git a/package.json b/package.json
index 0b817b7..5665617 100644
--- a/package.json
+++ b/package.json
@@ -5,33 +5,32 @@
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-    "JSV": "3.5.0",
-    "assert-plus": "0.1.5",
-    "async": "0.9.0",
-    "bunyan": "1.3.4",
+    "assert-plus": "1.0.0",
+    "async": "1.5.2",
+    "bunyan": "1.8.5",
     "ctype": "0.5.4",
     "digest-stream": "0.2.2",
     "docker-file-parser": "git+https://github.com/joyent/node-docker-file-parser.git#ba6b4ce0e09a1432b200a55851d2899109d68ae2",
     "effluent-logger": "git+https://github.com/joshwilsdon/effluent-logger.git#d662f161a07f94045ad2afb45442931511c40e51",
-    "kstat": "0.5.0",
+    "kstat": "1.0.1",
     "lazy-property": "1.0.0",
-    "libuuid": "0.1.4",
-    "lockfd": "git+https://github.com/joyent/node-lockfd.git#eeec5216dd493b44a870d0369872f56ab0788d0f",
+    "libuuid": "0.2.1",
+    "lockfd": "1.2.0",
     "mkdirp": "^0.3.4",
     "nodeunit": "0.9.1",
     "once": "1.3.0",
-    "pty.js": "git+https://github.com/joshwilsdon/pty.js.git#exitStatus",
-    "restify": "4.0.0",
+    "pty.js": "0.3.1",
+    "restify": "4.3.0",
     "rimraf": "2.4.3",
-    "sdc-clients": "~9.1",
-    "sdc-docker-build": "git+https://github.com/joyent/sdc-docker-build.git#e53ca2aeb2772a527457580e8759372286b7ab50",
+    "sdc-clients": "10.0.3",
+    "sdc-docker-build": "git+https://github.com/joyent/sdc-docker-build.git#af8bd3e",
     "semver": "2.2.1",
     "shell-escape": "^0.2.0",
-    "sprintf": "0.1.1",
+    "sprintf": "0.1.5",
     "trace-event": "git+https://github.com/joyent/node-trace-event.git#9f7d00b8c3594def9ef534f68c16c215c3dba9f2",
     "tracker": "git+https://github.com/joyent/node-tracker.git#3a139906c9eb8d8684ac54cf54cd010315856042",
-    "vasync": "^1.6.3",
-    "verror": "1.6.0",
+    "vasync": "1.6.4",
+    "verror": "1.9.0",
     "vmadm": "git+https://github.com/joyent/node-vmadm.git#94e95c6b96c2c5947281a5ea3df763928a65219c",
     "zfs": "git+https://github.com/joyent/node-zfs.git#657a90d9424c45066e3e0919dfe9b34f5636e0e9"
   },
@@ -43,6 +42,7 @@
   },
   "scripts": {
     "test": "./test.sh",
+    "preinstall": "./npm/preinstall.sh",
     "postinstall": "./npm/postinstall.sh",
     "postuninstall": "./npm/postuninstall.sh"
   },
-- 
2.21.0

