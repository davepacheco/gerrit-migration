{"project":"joyent/waferlock","branch":"master","topic":"MANTA-4305","id":"Iad4740c4d20fa19190ec9b5f5c5eaf3bdbbc1719","number":"6381","subject":"MANTA-4305 want a waferlock that uses pg_hba.conf instead of ipfilter Reviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e Approved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/6381","commitMessage":"MANTA-4305 want a waferlock that uses pg_hba.conf instead of ipfilter\nReviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\nApproved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1559339768,"lastUpdated":1560977091,"open":false,"status":"MERGED","comments":[{"timestamp":1559339768,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1559339789,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1559342313,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 1:\n\n(11 comments)"},{"timestamp":1559344282,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1559344296,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1559344302,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1559594030,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 2: Code-Review+1\n\nThanks for the changes!"},{"timestamp":1559617910,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 2: Integration-Approval+1\n\nTesting notes in the ticket look good!  I approve."},{"timestamp":1559674141,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3: Commit message was updated."},{"timestamp":1559674145,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"},{"timestamp":1560977091,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Topic set to MANTA-4305"}],"currentPatchSet":{"number":"3","revision":"a73c5494acc683def0b60ac0dbb2c86b3b4d2a08","parents":["a5895ce355188184172796f3f1904c678ebbbcfa"],"ref":"refs/changes/81/6381/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1559674141,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559344302,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559594030,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559617910,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1559674145,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"etc/config.json.example","type":"MODIFIED","insertions":6,"deletions":0},{"file":"etc/ipf.conf","type":"DELETED","insertions":0,"deletions":-24},{"file":"etc/pg_hba.conf","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/ipf.js","type":"DELETED","insertions":0,"deletions":-347},{"file":"lib/pg_hba.js","type":"ADDED","insertions":283,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/waferlock/template","type":"MODIFIED","insertions":7,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":40,"deletions":-96}],"sizeInsertions":367,"sizeDeletions":-469},"patchSets":[{"number":"1","revision":"ebf55024af32a55f974082d61f765ef218ed0424","parents":["a5895ce355188184172796f3f1904c678ebbbcfa"],"ref":"refs/changes/81/6381/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1559339768,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559339789,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"etc/pg_hba.conf","line":0,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Maybe we should strip out all the boiler plate documentation and just put a more obvious HEY KIDS IT\u0027S WAFERLOCK! banner up the top?"},{"file":"lib/pg_hba.js","line":8,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As per standard Copyright style now:\n\n    Copyright 2019 Joyent, Inc."},{"file":"lib/pg_hba.js","line":20,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Why is this a \"pool\"?"},{"file":"lib/pg_hba.js","line":20,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"It\u0027s a pool of IP addresses allowed to access postgres. I think the terminology still works."},{"file":"lib/pg_hba.js","line":40,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Would it not be easier to have everything be a String and use +\u003d rather than an array of Buffers?"},{"file":"lib/pg_hba.js","line":163,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Check that it\u0027s a number?"},{"file":"lib/pg_hba.js","line":182,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Use \"process.kill()\" for this?"},{"file":"lib/pg_hba.js","line":241,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Date.now() ?"},{"file":"lib/pg_hba.js","line":242,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Is this ... to make it round units of 5 seconds?"},{"file":"lib/pg_hba.js","line":242,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Yes, the idea being to make a bunch of expiry timers go off at once so the debouncing can catch as many as possible. It\u0027s probably not as important for this as it was for the IPF backend (I copy-pasted most of this code)."},{"file":"server.js","line":23,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Should we remove lib/ipf* now too?"},{"file":"server.js","line":116,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I can never remember, but ... do you have to pass anything to this to make sure the file is interpreted as UTF-8 and returned as a string instead of a buffer?"},{"file":"server.js","line":116,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"I was deliberately letting this return a buffer and passing a buffer through. I\u0027ll change it to a string to address your other feedback about just using +\u003d instead of Buffer.concat."},{"file":"server.js","line":216,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Ipf?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":0},{"file":"etc/config.json.example","type":"MODIFIED","insertions":6,"deletions":0},{"file":"etc/pg_hba.conf","type":"ADDED","insertions":100,"deletions":0},{"file":"lib/pg_hba.js","type":"ADDED","insertions":286,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/waferlock/template","type":"MODIFIED","insertions":7,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":36,"deletions":-92}],"sizeInsertions":437,"sizeDeletions":-93},{"number":"2","revision":"ad4740c4d20fa19190ec9b5f5c5eaf3bdbbc1719","parents":["a5895ce355188184172796f3f1904c678ebbbcfa"],"ref":"refs/changes/81/6381/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1559344282,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559594030,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559617910,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559344302,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"etc/config.json.example","type":"MODIFIED","insertions":6,"deletions":0},{"file":"etc/ipf.conf","type":"DELETED","insertions":0,"deletions":-24},{"file":"etc/pg_hba.conf","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/ipf.js","type":"DELETED","insertions":0,"deletions":-347},{"file":"lib/pg_hba.js","type":"ADDED","insertions":283,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/waferlock/template","type":"MODIFIED","insertions":7,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":40,"deletions":-96}],"sizeInsertions":367,"sizeDeletions":-469},{"number":"3","revision":"a73c5494acc683def0b60ac0dbb2c86b3b4d2a08","parents":["a5895ce355188184172796f3f1904c678ebbbcfa"],"ref":"refs/changes/81/6381/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1559674141,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1559674145,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559594030,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559617910,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559344302,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"etc/config.json.example","type":"MODIFIED","insertions":6,"deletions":0},{"file":"etc/ipf.conf","type":"DELETED","insertions":0,"deletions":-24},{"file":"etc/pg_hba.conf","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/ipf.js","type":"DELETED","insertions":0,"deletions":-347},{"file":"lib/pg_hba.js","type":"ADDED","insertions":283,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/waferlock/template","type":"MODIFIED","insertions":7,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":40,"deletions":-96}],"sizeInsertions":367,"sizeDeletions":-469}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}