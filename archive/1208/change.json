{"project":"joyent/manta-mackerel","branch":"master","id":"Ic2982ccd047e920e02bb3289bc550013d2a47868","number":"1208","subject":"MANTA-3069 metering-storage-hourly reducer hits Node heap limit MANTA-3074 mackerel \"make check\" is broken Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Approved by: David Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"url":"https://cr.joyent.us/1208","commitMessage":"MANTA-3069 metering-storage-hourly reducer hits Node heap limit\nMANTA-3074 mackerel \"make check\" is broken\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1483600490,"lastUpdated":1483825032,"open":false,"status":"MERGED","comments":[{"timestamp":1483600490,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 1."},{"timestamp":1483600506,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n curl: (22) The requested URL returned error: 404 Not Found\n json -nf etc/config.json\n json: error: unknown option \u0027-n\u0027\n Makefile:81: recipe for target \u0027mycheck\u0027 failed\n gmake: *** [mycheck] Error 1"},{"timestamp":1483600841,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 2."},{"timestamp":1483600880,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483631285,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1483651975,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1483652154,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1"},{"timestamp":1483825011,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1483825032,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Joshua M. Clulow"}],"currentPatchSet":{"number":"3","revision":"c2982ccd047e920e02bb3289bc550013d2a47868","parents":["51192ba4f437d461841949ba71fff2e5e3c376bb"],"ref":"refs/changes/08/1208/3","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1483825011,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483600880,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483652154,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1483652154,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1483825032,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"assets/bin/storage-reduce1","type":"MODIFIED","insertions":22,"deletions":-2}],"sizeInsertions":24,"sizeDeletions":-4},"patchSets":[{"number":"1","revision":"4bd0015a2ed5ddcc788bac313b58b240cda8c186","parents":["51192ba4f437d461841949ba71fff2e5e3c376bb"],"ref":"refs/changes/08/1208/1","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1483600490,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1483600506,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"assets/bin/storage-reduce1","type":"MODIFIED","insertions":22,"deletions":-2}],"sizeInsertions":22,"sizeDeletions":-2},{"number":"2","revision":"c5d8a9e289d78d11693c34daaa83ac63fd90bc3c","parents":["51192ba4f437d461841949ba71fff2e5e3c376bb"],"ref":"refs/changes/08/1208/2","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1483600841,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483652154,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1483652154,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483600880,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"Makefile","line":80,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Do you know why this \"mycheck\" exists?\n\nThere are some targets in modern Makefile.targ from eng.git so that you should only need to specify JSON_FILES\u003d... and it will check them with \"json --validate\" for you.  It\u0027s up to you if you think it\u0027s worth updating to that here."},{"file":"Makefile","line":80,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I\u0027d like to avoid doing that for now.  Either mackerel will see a bunch of work soon and I\u0027ll update things then, or it\u0027ll be deprecated, depending on how the RFD 16 work goes."},{"file":"assets/bin/storage-reduce1","line":29,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"From your analysis in the ticket, it looked like the Node process was running at about 700-800MB when it started to slow down.  Do we know how much of that was native heap vs. JavaScript heap?  The only thing I\u0027m worried about here is if we increase the JavaScript heap to 1.3GB, and we also have a hefty native heap (since I\u0027d expect we\u0027d have a lot of Buffers in use from reading all that input), then will we get too close to the 2GB zone limit?"},{"file":"assets/bin/storage-reduce1","line":29,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I ran \"pmap -x\" periodically while the program was running, and the \"[ heap ]\" segment only grew to about 8MB and was pretty constant for the entire run.  I suspect the buffers are getting recycled relatively quickly, as the program is growing in size the entire time it runs, and the Buffer objects are probably repeatedly collected in minor GC operations."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"assets/bin/storage-reduce1","type":"MODIFIED","insertions":22,"deletions":-2}],"sizeInsertions":24,"sizeDeletions":-4},{"number":"3","revision":"c2982ccd047e920e02bb3289bc550013d2a47868","parents":["51192ba4f437d461841949ba71fff2e5e3c376bb"],"ref":"refs/changes/08/1208/3","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1483825011,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483652154,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1483652154,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1483825032,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483600880,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"assets/bin/storage-reduce1","type":"MODIFIED","insertions":22,"deletions":-2}],"sizeInsertions":24,"sizeDeletions":-4}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}]}