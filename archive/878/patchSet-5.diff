From 3a3640122b1f898bab1a5e7361aee8e9a60c38fc Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Fri, 18 Nov 2016 18:42:57 +0000
Subject: [PATCH] OS-5770 enhance disklayout for no cache, number of spares and
 raidz3

---
 man/src/disklayout.1m.md             |  28 +-
 src/disklayout.js                    |  33 ++-
 src/node_modules/disklayout.js       | 366 ++++++++++++++++++++-------
 src/test/disklayout/1.di.0s.out      |  12 +
 src/test/disklayout/1.di.1s.out      |   1 +
 src/test/disklayout/1s.di.0s.out     |  21 ++
 src/test/disklayout/1s.di.1s.out     |   1 +
 src/test/disklayout/2.di.0s.out      |  24 ++
 src/test/disklayout/2.di.1s.out      |   1 +
 src/test/disklayout/2s.di.0s.out     |  33 +++
 src/test/disklayout/2s.di.1s.out     |   1 +
 src/test/disklayout/3.di.0s.out      |  31 +++
 src/test/disklayout/3.di.1s.out      |  33 +++
 src/test/disklayout/3s.di.0s.out     |  40 +++
 src/test/disklayout/3s.di.1s.out     |  42 +++
 src/test/disklayout/4.di.0s.out      |  38 +++
 src/test/disklayout/4.di.1s.out      |  40 +++
 src/test/disklayout/43s.di.0s.out    |   1 +
 src/test/disklayout/43s.di.1s.out    | 347 +++++++++++++++++++++++++
 src/test/disklayout/4s.di.0s.out     |  47 ++++
 src/test/disklayout/4s.di.1s.out     |  49 ++++
 src/test/disklayout/5.di.0s.out      |  45 ++++
 src/test/disklayout/5.di.1s.out      |  47 ++++
 src/test/disklayout/5s.di.0s.out     |  54 ++++
 src/test/disklayout/5s.di.1s.out     |  56 ++++
 src/test/disklayout/6.di.0s.out      |  57 +++++
 src/test/disklayout/6.di.1s.out      |  54 ++++
 src/test/disklayout/6s.di.0s.out     |  66 +++++
 src/test/disklayout/6s.di.1s.out     |  63 +++++
 src/test/disklayout/7.di.0s.out      |  59 +++++
 src/test/disklayout/7.di.1s.out      |  66 +++++
 src/test/disklayout/7s.di.0s.out     |  68 +++++
 src/test/disklayout/7s.di.1s.out     |  75 ++++++
 src/test/disklayout/8.di             |   9 +
 src/test/disklayout/8.di.0s.out      |  81 ++++++
 src/test/disklayout/8.di.1s.out      |  68 +++++
 src/test/disklayout/8.di.out         |  78 ++++++
 src/test/disklayout/README           |   7 +-
 src/test/disklayout/insane.di.0s.out | 138 ++++++++++
 src/test/disklayout/insane.di.1s.out | 135 ++++++++++
 src/test/disklayout/insane.di.c.out  | 119 +++++++++
 src/test/disklayout/insane.di.c0.out | 122 +++++++++
 src/test/disklayout/insane.di.c1.out | 119 +++++++++
 src/test/disklayout/ms2.di.0s.out    | 284 +++++++++++++++++++++
 src/test/disklayout/ms2.di.1s.out    |   1 +
 src/test/disklayout/run              | 112 ++++++++
 src/test/disklayout/s10.di           |  11 +
 src/test/disklayout/s10.di.0s.out    |  80 ++++++
 src/test/disklayout/s10.di.1s.out    |  82 ++++++
 src/test/disklayout/s10.di.out       |  80 ++++++
 src/test/disklayout/s11.di           |  12 +
 src/test/disklayout/s11.di.0s.out    |  87 +++++++
 src/test/disklayout/s11.di.1s.out    |  89 +++++++
 src/test/disklayout/s11.di.out       |  87 +++++++
 src/test/disklayout/s12.di           |  13 +
 src/test/disklayout/s12.di.0s.out    |  94 +++++++
 src/test/disklayout/s12.di.1s.out    |  96 +++++++
 src/test/disklayout/s12.di.out       |  96 +++++++
 src/test/disklayout/s16.di           |  17 ++
 src/test/disklayout/s16.di.0s.out    | 127 ++++++++++
 src/test/disklayout/s16.di.1s.out    | 144 +++++++++++
 src/test/disklayout/s16.di.m.out     | 154 +++++++++++
 src/test/disklayout/s16.di.m0.out    | 157 ++++++++++++
 src/test/disklayout/s16.di.out       | 129 ++++++++++
 src/test/disklayout/s16.di.z1-0.out  | 137 ++++++++++
 src/test/disklayout/s16.di.z1.out    | 139 ++++++++++
 src/test/disklayout/s16.di.z2-0.out  | 127 ++++++++++
 src/test/disklayout/s16.di.z2.out    | 129 ++++++++++
 src/test/disklayout/s16.di.z3-0.out  |   1 +
 src/test/disklayout/s16.di.z3.out    | 124 +++++++++
 src/test/disklayout/s17.di           |  17 ++
 src/test/disklayout/s17.di.0s.out    |   1 +
 src/test/disklayout/s17.di.1s.out    | 136 ++++++++++
 src/test/disklayout/s17.di.out       | 136 ++++++++++
 src/test/disklayout/s6.di.0s.out     |  57 +++++
 src/test/disklayout/s6.di.1s.out     |  54 ++++
 src/test/disklayout/s8.di            |   9 +
 src/test/disklayout/s8.di.0s.out     |  66 +++++
 src/test/disklayout/s8.di.1s.out     |  68 +++++
 src/test/disklayout/s8.di.m.out      |  78 ++++++
 src/test/disklayout/s8.di.m0.out     |  81 ++++++
 src/test/disklayout/s8.di.out        |  66 +++++
 src/test/disklayout/s8.di.z1.out     |  73 ++++++
 src/test/disklayout/s8.di.z2.out     |  66 +++++
 src/test/disklayout/s8.di.z3.out     |  66 +++++
 src/test/disklayout/s9.di            |  10 +
 src/test/disklayout/s9.di.0s.out     |  73 ++++++
 src/test/disklayout/s9.di.1s.out     |  75 ++++++
 src/test/disklayout/s9.di.out        |  73 ++++++
 src/test/disklayout/tl-a.di.0s.out   | 144 +++++++++++
 src/test/disklayout/tl-a.di.1s.out   | 156 ++++++++++++
 src/test/disklayout/tl-ars.di.0s.out |  54 ++++
 src/test/disklayout/tl-ars.di.1s.out |  56 ++++
 src/test/disklayout/tl-b.di.0s.out   | 103 ++++++++
 src/test/disklayout/tl-b.di.1s.out   | 105 ++++++++
 src/test/disklayout/tl-c.di.0s.out   |  73 ++++++
 src/test/disklayout/tl-c.di.1s.out   |  75 ++++++
 src/test/disklayout/tl-c.di.out      |  27 +-
 98 files changed, 7252 insertions(+), 130 deletions(-)
 create mode 100644 src/test/disklayout/1.di.0s.out
 create mode 100644 src/test/disklayout/1.di.1s.out
 create mode 100644 src/test/disklayout/1s.di.0s.out
 create mode 100644 src/test/disklayout/1s.di.1s.out
 create mode 100644 src/test/disklayout/2.di.0s.out
 create mode 100644 src/test/disklayout/2.di.1s.out
 create mode 100644 src/test/disklayout/2s.di.0s.out
 create mode 100644 src/test/disklayout/2s.di.1s.out
 create mode 100644 src/test/disklayout/3.di.0s.out
 create mode 100644 src/test/disklayout/3.di.1s.out
 create mode 100644 src/test/disklayout/3s.di.0s.out
 create mode 100644 src/test/disklayout/3s.di.1s.out
 create mode 100644 src/test/disklayout/4.di.0s.out
 create mode 100644 src/test/disklayout/4.di.1s.out
 create mode 100644 src/test/disklayout/43s.di.0s.out
 create mode 100644 src/test/disklayout/43s.di.1s.out
 create mode 100644 src/test/disklayout/4s.di.0s.out
 create mode 100644 src/test/disklayout/4s.di.1s.out
 create mode 100644 src/test/disklayout/5.di.0s.out
 create mode 100644 src/test/disklayout/5.di.1s.out
 create mode 100644 src/test/disklayout/5s.di.0s.out
 create mode 100644 src/test/disklayout/5s.di.1s.out
 create mode 100644 src/test/disklayout/6.di.0s.out
 create mode 100644 src/test/disklayout/6.di.1s.out
 create mode 100644 src/test/disklayout/6s.di.0s.out
 create mode 100644 src/test/disklayout/6s.di.1s.out
 create mode 100644 src/test/disklayout/7.di.0s.out
 create mode 100644 src/test/disklayout/7.di.1s.out
 create mode 100644 src/test/disklayout/7s.di.0s.out
 create mode 100644 src/test/disklayout/7s.di.1s.out
 create mode 100644 src/test/disklayout/8.di
 create mode 100644 src/test/disklayout/8.di.0s.out
 create mode 100644 src/test/disklayout/8.di.1s.out
 create mode 100644 src/test/disklayout/8.di.out
 create mode 100644 src/test/disklayout/insane.di.0s.out
 create mode 100644 src/test/disklayout/insane.di.1s.out
 create mode 100644 src/test/disklayout/insane.di.c.out
 create mode 100644 src/test/disklayout/insane.di.c0.out
 create mode 100644 src/test/disklayout/insane.di.c1.out
 create mode 100644 src/test/disklayout/ms2.di.0s.out
 create mode 100644 src/test/disklayout/ms2.di.1s.out
 create mode 100755 src/test/disklayout/run
 create mode 100644 src/test/disklayout/s10.di
 create mode 100644 src/test/disklayout/s10.di.0s.out
 create mode 100644 src/test/disklayout/s10.di.1s.out
 create mode 100644 src/test/disklayout/s10.di.out
 create mode 100644 src/test/disklayout/s11.di
 create mode 100644 src/test/disklayout/s11.di.0s.out
 create mode 100644 src/test/disklayout/s11.di.1s.out
 create mode 100644 src/test/disklayout/s11.di.out
 create mode 100644 src/test/disklayout/s12.di
 create mode 100644 src/test/disklayout/s12.di.0s.out
 create mode 100644 src/test/disklayout/s12.di.1s.out
 create mode 100644 src/test/disklayout/s12.di.out
 create mode 100644 src/test/disklayout/s16.di
 create mode 100644 src/test/disklayout/s16.di.0s.out
 create mode 100644 src/test/disklayout/s16.di.1s.out
 create mode 100644 src/test/disklayout/s16.di.m.out
 create mode 100644 src/test/disklayout/s16.di.m0.out
 create mode 100644 src/test/disklayout/s16.di.out
 create mode 100644 src/test/disklayout/s16.di.z1-0.out
 create mode 100644 src/test/disklayout/s16.di.z1.out
 create mode 100644 src/test/disklayout/s16.di.z2-0.out
 create mode 100644 src/test/disklayout/s16.di.z2.out
 create mode 100644 src/test/disklayout/s16.di.z3-0.out
 create mode 100644 src/test/disklayout/s16.di.z3.out
 create mode 100644 src/test/disklayout/s17.di
 create mode 100644 src/test/disklayout/s17.di.0s.out
 create mode 100644 src/test/disklayout/s17.di.1s.out
 create mode 100644 src/test/disklayout/s17.di.out
 create mode 100644 src/test/disklayout/s6.di.0s.out
 create mode 100644 src/test/disklayout/s6.di.1s.out
 create mode 100644 src/test/disklayout/s8.di
 create mode 100644 src/test/disklayout/s8.di.0s.out
 create mode 100644 src/test/disklayout/s8.di.1s.out
 create mode 100644 src/test/disklayout/s8.di.m.out
 create mode 100644 src/test/disklayout/s8.di.m0.out
 create mode 100644 src/test/disklayout/s8.di.out
 create mode 100644 src/test/disklayout/s8.di.z1.out
 create mode 100644 src/test/disklayout/s8.di.z2.out
 create mode 100644 src/test/disklayout/s8.di.z3.out
 create mode 100644 src/test/disklayout/s9.di
 create mode 100644 src/test/disklayout/s9.di.0s.out
 create mode 100644 src/test/disklayout/s9.di.1s.out
 create mode 100644 src/test/disklayout/s9.di.out
 create mode 100644 src/test/disklayout/tl-a.di.0s.out
 create mode 100644 src/test/disklayout/tl-a.di.1s.out
 create mode 100644 src/test/disklayout/tl-ars.di.0s.out
 create mode 100644 src/test/disklayout/tl-ars.di.1s.out
 create mode 100644 src/test/disklayout/tl-b.di.0s.out
 create mode 100644 src/test/disklayout/tl-b.di.1s.out
 create mode 100644 src/test/disklayout/tl-c.di.0s.out
 create mode 100644 src/test/disklayout/tl-c.di.1s.out

diff --git a/man/src/disklayout.1m.md b/man/src/disklayout.1m.md
index 0bc432cb..4c93030b 100644
--- a/man/src/disklayout.1m.md
+++ b/man/src/disklayout.1m.md
@@ -2,7 +2,7 @@
 
 ## SYNOPSIS
 
-    disklayout [-f file] [layout]
+    disklayout [-c] [-f file] [-s spares] [layout]
 
 
 ## DESCRIPTION
@@ -36,19 +36,19 @@ inventory.  If there are inadequate devices to do this, disklayout will
 attempt to define a functional pool with redundancy.  If there is a
 single device, disklayout will define a pool with that single device.
 
-When at least 5 primary storage devices are available, disklayout always
-allocates at least one spare.  Additional spares may be allocated as the
-total number of primary storage devices increases and/or if the number
-of available primary storage devices does not divide evenly by the
-number of devices per vdev with enough left over to provide the minimum
+If the number of spares has not been explicitly specified with the **-s**
+option, then when at least 5 primary storage devices are available,
+disklayout tries to allocate at least one spare. Additional spares may be
+allocated as the total number of primary storage devices increases and/or
+if the number of available primary storage devices does not divide evenly
+by the number of devices per vdev with enough left over to provide the minimum
 number of spares.
 
 When constructing RAIDZ-type layouts, disklayout will consider a range
 of stripe widths (i.e., number of leaf devices per RAIDZ-n vdev).  The
 number of leaf devices per vdev will be at least 3 for RAIDZ, at least 5
 for RAIDZ-2, and at least 7 for RAIDZ-3.  Some versions of this utility
-may consider only stripes wider than the limits documented here.  This
-utility may not support all RAIDZ-n layouts.
+may consider only stripes wider than the limits documented here.
 
 Other than as described here, the heuristics used to select layouts and
 to optimise allocation of devices are not an interface and are subject
@@ -56,12 +56,20 @@ to change at any time without notice.
 
 ## OPTIONS
 
+**-c**
+
+Prevent disklayout from allocating any disks as cache devices.
+
 **-f file**
 
 Use **file** as the source of information about available disks.  The
 running system will not be interrogated; in this mode, the utility may
 be used in a zone if desired.
 
+**-s spares**
+
+Specify **spares** as the number of disks to be be allocated as spares.
+
 **layout**
 
 Specify the class of pool layout to generate.  By default, disklayout
@@ -69,8 +77,8 @@ selects a pool layout class based on the type, number, and size of
 available storage devices.  If you specify a layout class, it will
 generate a configuration of that class instead.  If it is not possible
 to do so given the available devices, an error will occur; see ERRORS
-below.  The set of supported layouts includes at least "single",
-"mirror", and "raidz2", and will be listed if you specify an unsupported
+below.  The set of supported layouts includes "single", "mirror", "raidz1",
+"raidz2" and "raidz3", and will be listed if you specify an unsupported
 layout.
 
 
diff --git a/src/disklayout.js b/src/disklayout.js
index 14880dc9..bf799a88 100644
--- a/src/disklayout.js
+++ b/src/disklayout.js
@@ -1,7 +1,7 @@
 #! /usr/node/bin/node
 
 /*
- * Copyright 2012 Joyent, Inc.  All rights reserved.
+ * Copyright 2016 Joyent, Inc.
  */
 
 var fs = require('fs');
@@ -19,14 +19,15 @@ fatal(msg)
 function
 usage()
 {
-	console.log('usage: ' + process.argv[0] + ' [-f file] <layout>');
+	console.log('usage: ' + process.argv[0] +
+	    ' [-c] [-f file] [-s spares] [<layout>]');
 	console.log('supported layouts:\n\t' +
 	    disklayout.list_supported().join('\n\t'));
 	process.exit(-1);
 }
 
 function
-dolayout(disks, layout)
+dolayout(disks, layout, nspares, enable_cache)
 {
 	var config;
 	var mnttab = fs.readFileSync('/etc/mnttab', 'utf8');
@@ -37,20 +38,38 @@ dolayout(disks, layout)
 		return (true);
 	});
 
-	config = disklayout.compute(disks, layout);
+	config = disklayout.compute(disks, layout, nspares, enable_cache);
+	if (config.error !== undefined) {
+		fatal(config.error);
+	}
 	console.log(JSON.stringify(config, null, '\t'));
 }
 
 var g_layout;
+var g_enable_cache = true;
 var opt_f;
+var opt_s;
 var option;
-var parser = new getopt.BasicParser('f:', process.argv);
+var parser = new getopt.BasicParser('cf:s:', process.argv);
 
 while ((option = parser.getopt()) !== undefined && !option.error) {
 	switch (option.option) {
+	case 'c':
+		g_enable_cache = false;
+		break;
 	case 'f':
 		opt_f = option.optarg;
 		break;
+	case 's':
+		opt_s = parseInt(option.optarg, 10);
+		/* Number of spares must be a positive number */
+		if (opt_s != option.optarg || isNaN(opt_s) ||
+		    !isFinite(opt_s) || opt_s < 0) {
+			console.log('invalid value for number of spares: ' +
+			    option.optarg);
+			usage();
+		}
+		break;
 	default:
 		usage();
 		break;
@@ -85,13 +104,13 @@ if (opt_f) {
 				});
 			}
 		});
-		dolayout(disks, g_layout);
+		dolayout(disks, g_layout, opt_s, g_enable_cache);
 	});
 } else {
 	zfs.zpool.listDisks(function (err, disks) {
 		if (err) {
 			fatal(err);
 		}
-		dolayout(disks, g_layout);
+		dolayout(disks, g_layout, opt_s, g_enable_cache);
 	});
 }
diff --git a/src/node_modules/disklayout.js b/src/node_modules/disklayout.js
index 78a5fabe..da6baa8d 100644
--- a/src/node_modules/disklayout.js
+++ b/src/node_modules/disklayout.js
@@ -1,8 +1,20 @@
 /*
- * Copyright 2012 Joyent, Inc.  All rights reserved.
+ * Copyright 2016 Joyent, Inc.
  */
 
-require('/usr/node/node_modules/platform_node_version').assert();
+var assert = require('assert');
+
+/*
+ * Constants for the minimum and maximum stripe width we want to allow for
+ * the various types of raidz, although raidz2 and raidz3 can override to
+ * go narrower in some cases.
+ */
+var Z1_MIN = 3;
+var Z1_MAX = 6;
+var Z2_MIN = 7;
+var Z2_MAX = 12;
+var Z3_MIN = 9;
+var Z3_MAX = 15;
 
 /*
  * Returns the rounded-off capacity in GB.  The purpose of this is to
@@ -133,7 +145,7 @@ xform_bucket(bucket)
  * which case the largest devices will be used as primary storage.
  */
 function
-assign_roles(inv)
+assign_roles(inv, enable_cache)
 {
 	var typedescs = Object.keys(inv);
 	var ssddescs;
@@ -167,14 +179,16 @@ assign_roles(inv)
 		roles.storage = xform_bucket(inv[largest]);
 	}
 
-	rustdescs.forEach(function (typedesc) {
-		var role = xform_bucket(inv[typedesc]);
+	if (enable_cache) {
+		rustdescs.forEach(function (typedesc) {
+			var role = xform_bucket(inv[typedesc]);
 
-		if (roles.cache)
-			roles.cache = roles.cache.concat(role);
-		else
-			roles.cache = role;
-	});
+			if (roles.cache)
+				roles.cache = roles.cache.concat(role);
+			else
+				roles.cache = role;
+		});
+	}
 
 	if (ssddescs.length === 0)
 		return (roles);
@@ -193,21 +207,30 @@ assign_roles(inv)
 		ssddescs.shift();
 	}
 
-	ssddescs.forEach(function (typedesc) {
-		var role = xform_bucket(inv[typedesc]);
-		if (roles.cache)
-			roles.cache = roles.cache.concat(role);
-		else
-			roles.cache = role;
-	});
+	if (enable_cache) {
+		ssddescs.forEach(function (typedesc) {
+			var role = xform_bucket(inv[typedesc]);
+			if (roles.cache)
+				roles.cache = roles.cache.concat(role);
+			else
+				roles.cache = role;
+		});
+	}
 
 	return (roles);
 }
 
 function
-do_single(disks)
+do_single(disks, nspares)
 {
-	var config = { vdevs: [] };
+	var config = {};
+
+	if (nspares !== undefined && nspares !== 0) {
+		config.error = 'spares are not allowed for a single disk pool';
+		return (config);
+	}
+
+	config.vdevs = [];
 	config.vdevs[0] = disks[0];
 	config.capacity = disks[0].size;
 
@@ -215,7 +238,7 @@ do_single(disks)
 }
 
 function
-do_mirror(disks)
+do_mirror(disks, nspares)
 {
 	var spares;
 	var config = {};
@@ -226,11 +249,16 @@ do_mirror(disks)
 		return (config);
 	}
 
-	if (disks.length === 2 || disks.length === 4) {
-		spares = 0;
+	if (nspares === undefined) {
+		if (disks.length === 2 || disks.length === 4) {
+			spares = 0;
+		} else {
+			spares = Math.ceil(disks.length / 16);
+			spares += (disks.length - spares) % 2;
+		}
 	} else {
-		spares = Math.ceil(disks.length / 16);
-		spares += (disks.length - spares) % 2;
+		assert.ok(nspares < disks.length);
+		spares = nspares;
 	}
 
 	/*
@@ -257,30 +285,35 @@ do_mirror(disks)
 }
 
 function
-do_raidz1(disks)
+raidz_common(disks, rtype, minwidth, maxwidth, spares, fixedspares)
 {
-	var MINWIDTH = 3;
-	var MAXWIDTH = 6;
 	var config = {};
-	var spares;
 	var width;
+	var nparity;
 	var capacity;
 
-	spares = Math.min(2, Math.floor(disks.length / 7));
-
-	while (disks.length - spares >= MINWIDTH) {
-		for (width = MINWIDTH; width <= MAXWIDTH; width++) {
+	while (disks.length - spares >= minwidth) {
+		for (width = minwidth; width <= maxwidth; width++) {
 			if ((disks.length - spares) % width === 0)
 				break;
 		}
-		if (width <= MAXWIDTH)
+		if (width <= maxwidth)
 			break;
+
+		if (fixedspares) {
+			config.error = 'no acceptable ' + rtype +
+			    ' layout is possible with ' + disks.length +
+			    ' disks and ' + spares +
+			    (spares == 1 ? ' spare' : ' spares');
+			return (config);
+		}
+
 		++spares;
 	}
 
-	if (disks.length - spares < MINWIDTH) {
-		config.error = 'no acceptable raidz1 layout is possible with ' +
-		    disks.length + ' disks';
+	if (disks.length - spares < minwidth) {
+		config.error = 'no acceptable ' + rtype + ' layout is ' +
+		    'possible with ' + disks.length + ' disks';
 		return (config);
 	}
 
@@ -291,13 +324,24 @@ do_raidz1(disks)
 	if (spares > 0)
 		config.spares = disks.splice(disks.length - spares, spares);
 
+	if (rtype === 'raidz') {
+		nparity = 1;
+	} else if (rtype === 'raidz2') {
+		nparity = 2;
+	} else if (rtype === 'raidz3') {
+		nparity = 3;
+	} else {
+		config.error = 'invalid raid type: ' + rtype;
+		return (config);
+	}
+
 	config.vdevs = [];
 	capacity = 0;
 	while (disks.length) {
 		var vdev = {};
 
-		capacity += (width - 1) * disks[0].size;
-		vdev.type = 'raidz';
+		capacity += (width - nparity) * disks[0].size;
+		vdev.type = rtype;
 		vdev.devices = disks.splice(0, width);
 		config.vdevs.push(vdev);
 	}
@@ -307,70 +351,94 @@ do_raidz1(disks)
 	return (config);
 }
 
+
 function
-do_raidz2(disks)
+do_raidz1(disks, nspares)
 {
-	var MINWIDTH = 7;
-	var MAXWIDTH = 12;
-	var config = {};
+	var minwidth = Z1_MIN;
+	var maxwidth = Z1_MAX;
 	var spares;
-	var width;
-	var capacity;
+	var fixedspares;
+
+	if (nspares === undefined) {
+		spares = Math.min(2, Math.floor(disks.length / 7));
+		fixedspares = false;
+	} else {
+		assert.ok(nspares < disks.length);
+		spares = nspares;
+		fixedspares = true;
+	}
+
+	return (raidz_common(disks, 'raidz', minwidth, maxwidth, spares,
+	    fixedspares));
+}
+
+function
+do_raidz2(disks, nspares)
+{
+	var minwidth = Z2_MIN;
+	var maxwidth = Z2_MAX;
+	var spares;
+	var fixedspares;
 
 	/*
 	 * Special case.  This configuration is supported but strongly
 	 * discouraged.  The lack of spares is relatively unimportant since
-	 * there are 2 parity devices, but this will perform very poorly.
+	 * there are 2 parity devices, but this will perform very poorly on
+	 * non-SSD disks.
 	 */
 	if (disks.length === 5 || disks.length === 6)
-		MINWIDTH = MAXWIDTH = disks.length;
-
-	spares = Math.min(2, Math.floor(disks.length / 12));
+		minwidth = maxwidth = disks.length;
 
-	while (disks.length - spares >= MINWIDTH) {
-		for (width = MINWIDTH; width <= MAXWIDTH; width++) {
-			if ((disks.length - spares) % width === 0)
-				break;
-		}
-		if (width <= MAXWIDTH)
-			break;
-		++spares;
+	if (nspares === undefined) {
+		spares = Math.min(2, Math.floor(disks.length / Z2_MAX));
+		fixedspares = false;
+	} else {
+		assert.ok(nspares < disks.length);
+		spares = nspares;
+		fixedspares = true;
 	}
 
-	if (disks.length - spares < MINWIDTH) {
-		config.error = 'no acceptable raidz2 layout is ' +
-		    'possible with ' + disks.length + ' disks';
-		return (config);
-	}
+	return (raidz_common(disks, 'raidz2', minwidth, maxwidth, spares,
+	    fixedspares));
+}
+
+function
+do_raidz3(disks, nspares)
+{
+	var minwidth = Z3_MIN;
+	var maxwidth = Z3_MAX;
+	var spares;
+	var fixedspares;
 
 	/*
-	 * The largest devices can spare for any others.  Not so for the
-	 * smaller ones.
+	 * Special case.  This configuration is supported but strongly
+	 * discouraged.  The lack of spares is relatively unimportant since
+	 * there are 3 parity devices, but this will perform very poorly on
+	 * non-SSD disks.
 	 */
-	if (spares > 0)
-		config.spares = disks.splice(disks.length - spares, spares);
-
-	config.vdevs = [];
-	capacity = 0;
-	while (disks.length) {
-		var vdev = {};
+	if (disks.length === 7 || disks.length === 8)
+		minwidth = maxwidth = disks.length;
 
-		capacity += (width - 2) * disks[0].size;
-		vdev.type = 'raidz2';
-		vdev.devices = disks.splice(0, width);
-		config.vdevs.push(vdev);
+	if (nspares === undefined) {
+		spares = Math.min(2, Math.floor(disks.length / 15));
+		fixedspares = false;
+	} else {
+		assert.ok(nspares < disks.length);
+		spares = nspares;
+		fixedspares = true;
 	}
 
-	config.capacity = capacity;
-
-	return (config);
+	return (raidz_common(disks, 'raidz3', minwidth, maxwidth, spares,
+	    fixedspares));
 }
 
 var LAYOUTS = {
 	single: do_single,
 	mirror: do_mirror,
 	raidz1: do_raidz1,
-	raidz2: do_raidz2
+	raidz2: do_raidz2,
+	raidz3: do_raidz3
 };
 
 function
@@ -387,13 +455,122 @@ list_supported()
 	return (Object.keys(LAYOUTS));
 }
 
+/*
+ * This function does some basic validation and can be extended to catch more
+ * issues with invalid input parameter combinations.
+ */
+function
+is_valid(config, disks, nspares)
+{
+	var i;
+	var ndisks;
+	var PRIMES = [ 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67 ];
+
+	if (nspares !== undefined) {
+		ndisks = disks.length - nspares;
+		if (nspares > 0 && ndisks < 2) {
+			config.error = 'too many spares (' +
+			    nspares + ') for this disk configuration';
+			return (false);
+		}
+
+		/*
+		 * When we have a fixed number of spares and a prime number of
+		 * disks that is greater than the maxwidth of a raidz3 then we
+		 * cannot construct a valid configuration.
+		 */
+		for (i = 0; i < PRIMES.length; i++) {
+			if (ndisks == PRIMES[i]) {
+				config.error = 'invalid number of spares (' +
+				    nspares + ') for this disk configuration';
+				return (false);
+			}
+		}
+	}
+
+	return (true);
+}
+
+/*
+ * Encode our heuristics that automatically select a layout for large or
+ * complex input not handled by the simple switch in compute_layout.
+ */
+function
+complex_layout(diskroles, navail, nspares)
+{
+	var i;
+
+	if (navail > 16 ||
+	    navail > Z2_MIN && diskroles.storage[0].size > 1500 * 1000000000) {
+		if (nspares === undefined)
+			return ('raidz2');
+
+		/*
+		 * We can't vary the number of spares. See if a raidz2 will
+		 * work or if we have to fallback to raidz1.
+		 */
+		for (i = Z2_MIN; i <= Z2_MAX; i++) {
+ 			if ((navail % i) === 0)
+				return ('raidz2');
+		}
+
+		/*
+		 * A special case to handle the navail > Z2_MIN with a fixed
+		 * number of spares that can't work on raidz1.
+		 */
+		if (navail == 13)
+			return ('raidz3');
+
+		return ('raidz1');
+	}
+
+	if (navail < Z2_MAX && diskroles.storage[0].solid_state) {
+		if (navail > Z1_MAX)
+			return ('raidz2');
+		return ('raidz1');
+	}
+
+	/* An odd number of disks, < 16 */
+	if ((navail % 2) != 0) {
+		/* For an odd number of disks we want mirrors and spares */
+		if (nspares === undefined)
+			return ('mirror');
+
+		if (navail < 6)
+			return ('raidz1');
+
+		/*
+		 * When we have 15 disks and can't vary spares then make a set
+		 * of narrow raidz1 vdevs.
+		 */
+		if (navail == 15 && nspares !== undefined)
+			return ('raidz1');
+
+		/*
+		 * When we have 13 disks and can't vary spares then this
+		 * exceeds the maxwidth of a single raidz2.
+		 */
+		if (navail == 13 && nspares !== undefined)
+			return ('raidz3');
+
+		/* We're in the acceptable range for raidz2 */
+		return ('raidz2');
+	}
+
+	/* We have an even number of disks <= 16 */
+	return ('mirror');
+}
+
 function
-compute_layout(disks, layout)
+compute_layout(disks, layout, nspares, enable_cache)
 {
 	var disktypes = {};
 	var diskroles;
 	var config = {};
 
+	assert.ok(typeof (nspares) === 'number' || nspares === undefined);
+	assert.ok(typeof (enable_cache) === 'boolean');
+
 	config.input = disks;
 	config.layout = layout;
 
@@ -422,15 +599,27 @@ compute_layout(disks, layout)
 
 	merge_types(disktypes);
 	shrink(disktypes);
-	diskroles = assign_roles(disktypes);
+	diskroles = assign_roles(disktypes, enable_cache);
 
 	if (!diskroles.storage) {
 		config.error = 'no primary storage disks available';
 		return (config);
 	}
 
+	if (!is_valid(config, diskroles.storage, nspares)) {
+		return (config);
+	}
+
 	if (!layout) {
-		switch (diskroles.storage.length) {
+		var navail;
+
+		if (nspares === undefined) {
+			navail = diskroles.storage.length;
+		} else {
+			navail = diskroles.storage.length - nspares;
+		}
+
+		switch (navail) {
 		case 1:
 			layout = 'single';
 			break;
@@ -443,21 +632,14 @@ compute_layout(disks, layout)
 			break;
 		case 5:
 		case 6:
-			if (diskroles.storage[0].solid_state)
+			if (diskroles.storage[0].solid_state ||
+			    nspares !== undefined)
 				layout = 'raidz1';
 			else
 				layout = 'raidz2';
 			break;
 		default:
-			if (diskroles.storage.length > 16 ||
-			    diskroles.storage.length > 7 &&
-			    diskroles.storage[0].size > 1500 * 1000000000)
-				layout = 'raidz2';
-			else if (diskroles.storage.length < 12 &&
-			    diskroles.storage[0].solid_state)
-				layout = 'raidz1';
-			else
-				layout = 'mirror';
+			layout = complex_layout(diskroles, navail, nspares);
 			break;
 		}
 	}
@@ -467,7 +649,7 @@ compute_layout(disks, layout)
 		return (config);
 	}
 
-	config = LAYOUTS[layout](diskroles.storage);
+	config = LAYOUTS[layout](diskroles.storage, nspares);
 	config.logs = diskroles.slog;
 	config.cache = diskroles.cache;
 
diff --git a/src/test/disklayout/1.di.0s.out b/src/test/disklayout/1.di.0s.out
new file mode 100644
index 00000000..3d8f80e9
--- /dev/null
+++ b/src/test/disklayout/1.di.0s.out
@@ -0,0 +1,12 @@
+{
+	"vdevs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	],
+	"capacity": "600127266816"
+}
diff --git a/src/test/disklayout/1.di.1s.out b/src/test/disklayout/1.di.1s.out
new file mode 100644
index 00000000..21d7ce71
--- /dev/null
+++ b/src/test/disklayout/1.di.1s.out
@@ -0,0 +1 @@
+fatal error: too many spares (1) for this disk configuration
diff --git a/src/test/disklayout/1s.di.0s.out b/src/test/disklayout/1s.di.0s.out
new file mode 100644
index 00000000..cf2d01bb
--- /dev/null
+++ b/src/test/disklayout/1s.di.0s.out
@@ -0,0 +1,21 @@
+{
+	"vdevs": [
+		{
+			"name": "disk1",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	],
+	"capacity": "600127266816",
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/1s.di.1s.out b/src/test/disklayout/1s.di.1s.out
new file mode 100644
index 00000000..21d7ce71
--- /dev/null
+++ b/src/test/disklayout/1s.di.1s.out
@@ -0,0 +1 @@
+fatal error: too many spares (1) for this disk configuration
diff --git a/src/test/disklayout/2.di.0s.out b/src/test/disklayout/2.di.0s.out
new file mode 100644
index 00000000..2ab92fe5
--- /dev/null
+++ b/src/test/disklayout/2.di.0s.out
@@ -0,0 +1,24 @@
+{
+	"vdevs": [
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 600127266816
+}
diff --git a/src/test/disklayout/2.di.1s.out b/src/test/disklayout/2.di.1s.out
new file mode 100644
index 00000000..21d7ce71
--- /dev/null
+++ b/src/test/disklayout/2.di.1s.out
@@ -0,0 +1 @@
+fatal error: too many spares (1) for this disk configuration
diff --git a/src/test/disklayout/2s.di.0s.out b/src/test/disklayout/2s.di.0s.out
new file mode 100644
index 00000000..89265720
--- /dev/null
+++ b/src/test/disklayout/2s.di.0s.out
@@ -0,0 +1,33 @@
+{
+	"vdevs": [
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 600127266816,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/2s.di.1s.out b/src/test/disklayout/2s.di.1s.out
new file mode 100644
index 00000000..21d7ce71
--- /dev/null
+++ b/src/test/disklayout/2s.di.1s.out
@@ -0,0 +1 @@
+fatal error: too many spares (1) for this disk configuration
diff --git a/src/test/disklayout/3.di.0s.out b/src/test/disklayout/3.di.0s.out
new file mode 100644
index 00000000..6bc3b4c0
--- /dev/null
+++ b/src/test/disklayout/3.di.0s.out
@@ -0,0 +1,31 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 1200254533632
+}
diff --git a/src/test/disklayout/3.di.1s.out b/src/test/disklayout/3.di.1s.out
new file mode 100644
index 00000000..d23b3c2d
--- /dev/null
+++ b/src/test/disklayout/3.di.1s.out
@@ -0,0 +1,33 @@
+{
+	"spares": [
+		{
+			"name": "disk2",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 600127266816
+}
diff --git a/src/test/disklayout/3s.di.0s.out b/src/test/disklayout/3s.di.0s.out
new file mode 100644
index 00000000..ba79dd63
--- /dev/null
+++ b/src/test/disklayout/3s.di.0s.out
@@ -0,0 +1,40 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 1200254533632,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/3s.di.1s.out b/src/test/disklayout/3s.di.1s.out
new file mode 100644
index 00000000..85f8d67c
--- /dev/null
+++ b/src/test/disklayout/3s.di.1s.out
@@ -0,0 +1,42 @@
+{
+	"spares": [
+		{
+			"name": "disk3",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 600127266816,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/4.di.0s.out b/src/test/disklayout/4.di.0s.out
new file mode 100644
index 00000000..7d49cdd2
--- /dev/null
+++ b/src/test/disklayout/4.di.0s.out
@@ -0,0 +1,38 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 1800381800448
+}
diff --git a/src/test/disklayout/4.di.1s.out b/src/test/disklayout/4.di.1s.out
new file mode 100644
index 00000000..487fc56f
--- /dev/null
+++ b/src/test/disklayout/4.di.1s.out
@@ -0,0 +1,40 @@
+{
+	"spares": [
+		{
+			"name": "disk3",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 1200254533632
+}
diff --git a/src/test/disklayout/43s.di.0s.out b/src/test/disklayout/43s.di.0s.out
new file mode 100644
index 00000000..665906cd
--- /dev/null
+++ b/src/test/disklayout/43s.di.0s.out
@@ -0,0 +1 @@
+fatal error: invalid number of spares (0) for this disk configuration
diff --git a/src/test/disklayout/43s.di.1s.out b/src/test/disklayout/43s.di.1s.out
new file mode 100644
index 00000000..0dd03231
--- /dev/null
+++ b/src/test/disklayout/43s.di.1s.out
@@ -0,0 +1,347 @@
+{
+	"spares": [
+		{
+			"name": "disk9",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk10",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk11",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk12",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk13",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk14",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk15",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk16",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk17",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk18",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk19",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk20",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk21",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk22",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk23",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk24",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk25",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk26",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk27",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk28",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk29",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk30",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk31",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk32",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk33",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk34",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk35",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk36",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk37",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk38",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk39",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk40",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk41",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk42",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk43",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk6",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk7",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk8",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 18003818004480,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/4s.di.0s.out b/src/test/disklayout/4s.di.0s.out
new file mode 100644
index 00000000..b41ab99a
--- /dev/null
+++ b/src/test/disklayout/4s.di.0s.out
@@ -0,0 +1,47 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 1800381800448,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/4s.di.1s.out b/src/test/disklayout/4s.di.1s.out
new file mode 100644
index 00000000..4354e72e
--- /dev/null
+++ b/src/test/disklayout/4s.di.1s.out
@@ -0,0 +1,49 @@
+{
+	"spares": [
+		{
+			"name": "disk4",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 1200254533632,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/5.di.0s.out b/src/test/disklayout/5.di.0s.out
new file mode 100644
index 00000000..6f344a70
--- /dev/null
+++ b/src/test/disklayout/5.di.0s.out
@@ -0,0 +1,45 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 2400509067264
+}
diff --git a/src/test/disklayout/5.di.1s.out b/src/test/disklayout/5.di.1s.out
new file mode 100644
index 00000000..a9fcb133
--- /dev/null
+++ b/src/test/disklayout/5.di.1s.out
@@ -0,0 +1,47 @@
+{
+	"spares": [
+		{
+			"name": "disk4",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 1800381800448
+}
diff --git a/src/test/disklayout/5s.di.0s.out b/src/test/disklayout/5s.di.0s.out
new file mode 100644
index 00000000..7c02760b
--- /dev/null
+++ b/src/test/disklayout/5s.di.0s.out
@@ -0,0 +1,54 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 2400509067264,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/5s.di.1s.out b/src/test/disklayout/5s.di.1s.out
new file mode 100644
index 00000000..109220d9
--- /dev/null
+++ b/src/test/disklayout/5s.di.1s.out
@@ -0,0 +1,56 @@
+{
+	"spares": [
+		{
+			"name": "disk5",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 1800381800448,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/6.di.0s.out b/src/test/disklayout/6.di.0s.out
new file mode 100644
index 00000000..aa44b151
--- /dev/null
+++ b/src/test/disklayout/6.di.0s.out
@@ -0,0 +1,57 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 2400509067264
+}
diff --git a/src/test/disklayout/6.di.1s.out b/src/test/disklayout/6.di.1s.out
new file mode 100644
index 00000000..422d404e
--- /dev/null
+++ b/src/test/disklayout/6.di.1s.out
@@ -0,0 +1,54 @@
+{
+	"spares": [
+		{
+			"name": "disk5",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 2400509067264
+}
diff --git a/src/test/disklayout/6s.di.0s.out b/src/test/disklayout/6s.di.0s.out
new file mode 100644
index 00000000..5e26ef3e
--- /dev/null
+++ b/src/test/disklayout/6s.di.0s.out
@@ -0,0 +1,66 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk6",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 2400509067264,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/6s.di.1s.out b/src/test/disklayout/6s.di.1s.out
new file mode 100644
index 00000000..7b3c5573
--- /dev/null
+++ b/src/test/disklayout/6s.di.1s.out
@@ -0,0 +1,63 @@
+{
+	"spares": [
+		{
+			"name": "disk6",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 2400509067264,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/7.di.0s.out b/src/test/disklayout/7.di.0s.out
new file mode 100644
index 00000000..4701fb67
--- /dev/null
+++ b/src/test/disklayout/7.di.0s.out
@@ -0,0 +1,59 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk6",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 3000636334080
+}
diff --git a/src/test/disklayout/7.di.1s.out b/src/test/disklayout/7.di.1s.out
new file mode 100644
index 00000000..c7c2e4c2
--- /dev/null
+++ b/src/test/disklayout/7.di.1s.out
@@ -0,0 +1,66 @@
+{
+	"spares": [
+		{
+			"name": "disk6",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 2400509067264
+}
diff --git a/src/test/disklayout/7s.di.0s.out b/src/test/disklayout/7s.di.0s.out
new file mode 100644
index 00000000..c1cb6186
--- /dev/null
+++ b/src/test/disklayout/7s.di.0s.out
@@ -0,0 +1,68 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk6",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk7",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 3000636334080,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/7s.di.1s.out b/src/test/disklayout/7s.di.1s.out
new file mode 100644
index 00000000..8d37c9b5
--- /dev/null
+++ b/src/test/disklayout/7s.di.1s.out
@@ -0,0 +1,75 @@
+{
+	"spares": [
+		{
+			"name": "disk7",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk6",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 2400509067264,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/8.di b/src/test/disklayout/8.di
new file mode 100644
index 00000000..7deaad96
--- /dev/null
+++ b/src/test/disklayout/8.di
@@ -0,0 +1,9 @@
+SCSI	disk0	MFG	DISK	600127266816	no	no
+SCSI	disk1	MFG	DISK	600127266816	no	no
+SCSI	disk2	MFG	DISK	600127266816	no	no
+SCSI	disk3	MFG	DISK	600127266816	no	no
+SCSI	disk4	MFG	DISK	600127266816	no	no
+SCSI	disk5	MFG	DISK	600127266816	no	no
+SCSI	disk6	MFG	DISK	600127266816	no	no
+SCSI	disk7	MFG	DISK	600127266816	no	no
+USB	key0	USBMFG	USB Key	15737028608	yes	no
diff --git a/src/test/disklayout/8.di.0s.out b/src/test/disklayout/8.di.0s.out
new file mode 100644
index 00000000..65a09951
--- /dev/null
+++ b/src/test/disklayout/8.di.0s.out
@@ -0,0 +1,81 @@
+{
+	"vdevs": [
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk6",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk7",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 2400509067264
+}
diff --git a/src/test/disklayout/8.di.1s.out b/src/test/disklayout/8.di.1s.out
new file mode 100644
index 00000000..8b00774b
--- /dev/null
+++ b/src/test/disklayout/8.di.1s.out
@@ -0,0 +1,68 @@
+{
+	"spares": [
+		{
+			"name": "disk7",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk6",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 3000636334080
+}
diff --git a/src/test/disklayout/8.di.out b/src/test/disklayout/8.di.out
new file mode 100644
index 00000000..4623f629
--- /dev/null
+++ b/src/test/disklayout/8.di.out
@@ -0,0 +1,78 @@
+{
+	"spares": [
+		{
+			"name": "disk6",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "600127266816",
+			"solid_state": false
+		},
+		{
+			"name": "disk7",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 1800381800448
+}
diff --git a/src/test/disklayout/README b/src/test/disklayout/README
index f5b1089d..fb493f01 100644
--- a/src/test/disklayout/README
+++ b/src/test/disklayout/README
@@ -1,9 +1,8 @@
 You cannot technically run this on the build machine, because you won't
-get the correct platform node and modules.  However, in general, you
-want something like:
-
-$ for f in *.di; do disklayout -f $f > /var/tmp/$f.out; diff -u $f.out /var/tmp/$f.out; rm -f /var/tmp/$f.out; done
+get the correct platform node and modules.
 
 If you insist on trying on the build machine, first do:
 
 # mount -o ro -O -F lofs src/node_modules/disklayout.js /usr/node/0.10/node_modules/disklayout.js
+
+The 'run' script will run all of the tests.
diff --git a/src/test/disklayout/insane.di.0s.out b/src/test/disklayout/insane.di.0s.out
new file mode 100644
index 00000000..20664ad1
--- /dev/null
+++ b/src/test/disklayout/insane.di.0s.out
@@ -0,0 +1,138 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk10",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk11",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk12",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk13",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk14",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk15",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk16",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk6",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk7",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk8",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk9",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 30001272668160,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	],
+	"cache": [
+		{
+			"name": "disk1",
+			"vid": "MFG2",
+			"pid": "DISK2",
+			"size": "600127266816",
+			"solid_state": false
+		},
+		{
+			"name": "disk2",
+			"vid": "MFG2",
+			"pid": "DISK2",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	]
+}
diff --git a/src/test/disklayout/insane.di.1s.out b/src/test/disklayout/insane.di.1s.out
new file mode 100644
index 00000000..e542c20e
--- /dev/null
+++ b/src/test/disklayout/insane.di.1s.out
@@ -0,0 +1,135 @@
+{
+	"spares": [
+		{
+			"name": "disk9",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "3000127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz3",
+			"devices": [
+				{
+					"name": "disk10",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk11",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk12",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk13",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk14",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk15",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk16",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk6",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk7",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk8",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 30001272668160,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	],
+	"cache": [
+		{
+			"name": "disk1",
+			"vid": "MFG2",
+			"pid": "DISK2",
+			"size": "600127266816",
+			"solid_state": false
+		},
+		{
+			"name": "disk2",
+			"vid": "MFG2",
+			"pid": "DISK2",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	]
+}
diff --git a/src/test/disklayout/insane.di.c.out b/src/test/disklayout/insane.di.c.out
new file mode 100644
index 00000000..207c8e6d
--- /dev/null
+++ b/src/test/disklayout/insane.di.c.out
@@ -0,0 +1,119 @@
+{
+	"spares": [
+		{
+			"name": "disk8",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "3000127266816",
+			"solid_state": false
+		},
+		{
+			"name": "disk9",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "3000127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk10",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk11",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk12",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk13",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk14",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk15",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk16",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk6",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk7",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 30001272668160,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/insane.di.c0.out b/src/test/disklayout/insane.di.c0.out
new file mode 100644
index 00000000..c3da069e
--- /dev/null
+++ b/src/test/disklayout/insane.di.c0.out
@@ -0,0 +1,122 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk10",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk11",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk12",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk13",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk14",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk15",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk16",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk6",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk7",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk8",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk9",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 30001272668160,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/insane.di.c1.out b/src/test/disklayout/insane.di.c1.out
new file mode 100644
index 00000000..70253ab9
--- /dev/null
+++ b/src/test/disklayout/insane.di.c1.out
@@ -0,0 +1,119 @@
+{
+	"spares": [
+		{
+			"name": "disk9",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "3000127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz3",
+			"devices": [
+				{
+					"name": "disk10",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk11",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk12",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk13",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk14",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk15",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk16",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk6",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk7",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk8",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "3000127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 30001272668160,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/ms2.di.0s.out b/src/test/disklayout/ms2.di.0s.out
new file mode 100644
index 00000000..2171009f
--- /dev/null
+++ b/src/test/disklayout/ms2.di.0s.out
@@ -0,0 +1,284 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk10",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk11",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk12",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk13",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk14",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk15",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk16",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk17",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk18",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk19",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk20",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk21",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk22",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk23",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk24",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk25",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk26",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk27",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk28",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk29",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk30",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk31",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk32",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk33",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk34",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk35",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk6",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk7",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk8",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk9",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 100000000000000,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "8000000000",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/ms2.di.1s.out b/src/test/disklayout/ms2.di.1s.out
new file mode 100644
index 00000000..be1bda46
--- /dev/null
+++ b/src/test/disklayout/ms2.di.1s.out
@@ -0,0 +1 @@
+fatal error: no acceptable raidz layout is possible with 35 disks and 1 spare
diff --git a/src/test/disklayout/run b/src/test/disklayout/run
new file mode 100755
index 00000000..6ab8419f
--- /dev/null
+++ b/src/test/disklayout/run
@@ -0,0 +1,112 @@
+#!/bin/sh
+
+for f in *.di
+do
+    disklayout -f $f > /var/tmp/$f.out
+    printf "%-16s " $f.out
+    diff -u $f.out /var/tmp/$f.out
+    rm -f /var/tmp/$f.out
+done
+
+echo
+echo "no spares"
+for f in *.di
+do
+    disklayout -f $f -s 0 > /var/tmp/$f.out
+    printf "%-16s " $f.out
+    diff -u $f.0s.out /var/tmp/$f.out
+    rm -f /var/tmp/$f.out
+done
+
+echo
+echo "1 spare"
+for f in *.di
+do
+    disklayout -f $f -s 1 > /var/tmp/$f.out
+    printf "%-16s " $f.out
+    diff -u $f.1s.out /var/tmp/$f.out
+    rm -f /var/tmp/$f.out
+done
+
+echo
+echo "standalone tests"
+
+disklayout -f insane.di -c > /var/tmp/insane.out
+printf "%-16s " insanec.out
+diff -u insane.di.c.out /var/tmp/insane.out
+rm -f /var/tmp/insane.out
+
+disklayout -f insane.di -c -s 0 > /var/tmp/insane.out
+printf "%-16s " insanec0.out
+diff -u insane.di.c0.out /var/tmp/insane.out
+rm -f /var/tmp/insane.out
+
+disklayout -f insane.di -c -s 1 > /var/tmp/insane.out
+printf "%-16s " insanec1.out
+diff -u insane.di.c1.out /var/tmp/insane.out
+rm -f /var/tmp/insane.out
+
+disklayout -f s8.di mirror > /var/tmp/s8.out
+printf "%-16s " 8mirror.out
+diff -u s8.di.m.out /var/tmp/s8.out
+rm -f /var/tmp/s8.out
+
+disklayout -f s8.di raidz1 > /var/tmp/s8.out
+printf "%-16s " 8z1.out
+diff -u s8.di.z1.out /var/tmp/s8.out
+rm -f /var/tmp/s8.out
+
+disklayout -f s8.di raidz2 > /var/tmp/s8.out
+printf "%-16s " 8z2.out
+diff -u s8.di.z2.out /var/tmp/s8.out
+rm -f /var/tmp/s8.out
+
+disklayout -f s8.di raidz3 > /var/tmp/s8.out
+printf "%-16s " 8z3.out
+diff -u s8.di.z3.out /var/tmp/s8.out
+rm -f /var/tmp/s8.out
+
+disklayout -f s8.di -s 0 mirror > /var/tmp/s8.out
+printf "%-16s " 8mirror0.out
+diff -u s8.di.m0.out /var/tmp/s8.out
+rm -f /var/tmp/s8.out
+
+disklayout -f s16.di mirror > /var/tmp/s16.out
+printf "%-16s " 16mirror.out
+diff -u s16.di.m.out /var/tmp/s16.out
+rm -f /var/tmp/s16.out
+
+disklayout -f s16.di raidz1 > /var/tmp/s16.out
+printf "%-16s " 16z1.out
+diff -u s16.di.z1.out /var/tmp/s16.out
+rm -f /var/tmp/s16.out
+
+disklayout -f s16.di raidz2 > /var/tmp/s16.out
+printf "%-16s " 16z2.out
+diff -u s16.di.z2.out /var/tmp/s16.out
+rm -f /var/tmp/s16.out
+
+disklayout -f s16.di raidz3 > /var/tmp/s16.out
+printf "%-16s " 16z3.out
+diff -u s16.di.z3.out /var/tmp/s16.out
+rm -f /var/tmp/s16.out
+
+disklayout -f s16.di -s 0 mirror > /var/tmp/s16.out
+printf "%-16s " 16mirror0.out
+diff -u s16.di.m0.out /var/tmp/s16.out
+rm -f /var/tmp/s16.out
+
+disklayout -f s16.di -s 0 raidz1 > /var/tmp/s16.out
+printf "%-16s " 16z1-0.out
+diff -u s16.di.z1-0.out /var/tmp/s16.out
+rm -f /var/tmp/s16.out
+
+disklayout -f s16.di -s 0 raidz2 > /var/tmp/s16.out
+printf "%-16s " 16z2-0.out
+diff -u s16.di.z2-0.out /var/tmp/s16.out
+rm -f /var/tmp/s16.out
+
+disklayout -f s16.di -s 0 raidz3 > /var/tmp/s16.out
+printf "%-16s " 16z3-0.out
+diff -u s16.di.z3-0.out /var/tmp/s16.out
+rm -f /var/tmp/s16.out
diff --git a/src/test/disklayout/s10.di b/src/test/disklayout/s10.di
new file mode 100644
index 00000000..b2ad16d1
--- /dev/null
+++ b/src/test/disklayout/s10.di
@@ -0,0 +1,11 @@
+SCSI	disk0	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk1	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk2	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk3	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk4	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk5	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk6	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk7	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk8	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk9	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+USB	key0	USBMFG	USB Key	15737028608	yes	no
diff --git a/src/test/disklayout/s10.di.0s.out b/src/test/disklayout/s10.di.0s.out
new file mode 100644
index 00000000..f44da003
--- /dev/null
+++ b/src/test/disklayout/s10.di.0s.out
@@ -0,0 +1,80 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 12802570518528
+}
diff --git a/src/test/disklayout/s10.di.1s.out b/src/test/disklayout/s10.di.1s.out
new file mode 100644
index 00000000..d5ebdf7f
--- /dev/null
+++ b/src/test/disklayout/s10.di.1s.out
@@ -0,0 +1,82 @@
+{
+	"spares": [
+		{
+			"name": "disk9",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 11202249203712
+}
diff --git a/src/test/disklayout/s10.di.out b/src/test/disklayout/s10.di.out
new file mode 100644
index 00000000..f44da003
--- /dev/null
+++ b/src/test/disklayout/s10.di.out
@@ -0,0 +1,80 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 12802570518528
+}
diff --git a/src/test/disklayout/s11.di b/src/test/disklayout/s11.di
new file mode 100644
index 00000000..673ff4dc
--- /dev/null
+++ b/src/test/disklayout/s11.di
@@ -0,0 +1,12 @@
+SCSI	disk0	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk1	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk2	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk3	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk4	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk5	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk6	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk7	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk8	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk9	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	diska	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+USB	key0	USBMFG	USB Key	15737028608	yes	no
diff --git a/src/test/disklayout/s11.di.0s.out b/src/test/disklayout/s11.di.0s.out
new file mode 100644
index 00000000..7234d609
--- /dev/null
+++ b/src/test/disklayout/s11.di.0s.out
@@ -0,0 +1,87 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 14402891833344
+}
diff --git a/src/test/disklayout/s11.di.1s.out b/src/test/disklayout/s11.di.1s.out
new file mode 100644
index 00000000..a7b2eef9
--- /dev/null
+++ b/src/test/disklayout/s11.di.1s.out
@@ -0,0 +1,89 @@
+{
+	"spares": [
+		{
+			"name": "diska",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 12802570518528
+}
diff --git a/src/test/disklayout/s11.di.out b/src/test/disklayout/s11.di.out
new file mode 100644
index 00000000..7234d609
--- /dev/null
+++ b/src/test/disklayout/s11.di.out
@@ -0,0 +1,87 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 14402891833344
+}
diff --git a/src/test/disklayout/s12.di b/src/test/disklayout/s12.di
new file mode 100644
index 00000000..192f4d48
--- /dev/null
+++ b/src/test/disklayout/s12.di
@@ -0,0 +1,13 @@
+SCSI	disk0	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk1	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk2	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk3	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk4	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk5	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk6	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk7	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk8	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk9	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	diska	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	diskb	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+USB	key0	USBMFG	USB Key	15737028608	yes	no
diff --git a/src/test/disklayout/s12.di.0s.out b/src/test/disklayout/s12.di.0s.out
new file mode 100644
index 00000000..95e50ef2
--- /dev/null
+++ b/src/test/disklayout/s12.di.0s.out
@@ -0,0 +1,94 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskb",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 16003213148160
+}
diff --git a/src/test/disklayout/s12.di.1s.out b/src/test/disklayout/s12.di.1s.out
new file mode 100644
index 00000000..b960bdfc
--- /dev/null
+++ b/src/test/disklayout/s12.di.1s.out
@@ -0,0 +1,96 @@
+{
+	"spares": [
+		{
+			"name": "diskb",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 14402891833344
+}
diff --git a/src/test/disklayout/s12.di.out b/src/test/disklayout/s12.di.out
new file mode 100644
index 00000000..b960bdfc
--- /dev/null
+++ b/src/test/disklayout/s12.di.out
@@ -0,0 +1,96 @@
+{
+	"spares": [
+		{
+			"name": "diskb",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 14402891833344
+}
diff --git a/src/test/disklayout/s16.di b/src/test/disklayout/s16.di
new file mode 100644
index 00000000..19d32f74
--- /dev/null
+++ b/src/test/disklayout/s16.di
@@ -0,0 +1,17 @@
+SCSI	disk0	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk1	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk2	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk3	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk4	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk5	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk6	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk7	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk8	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk9	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	diska	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	diskb	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	diskc	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	diskd	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	diske	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	diskf	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+USB	key0	USBMFG	USB Key	15737028608	yes	no
diff --git a/src/test/disklayout/s16.di.0s.out b/src/test/disklayout/s16.di.0s.out
new file mode 100644
index 00000000..ff8ebf14
--- /dev/null
+++ b/src/test/disklayout/s16.di.0s.out
@@ -0,0 +1,127 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskb",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskc",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskd",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diske",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskf",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 19203855777792
+}
diff --git a/src/test/disklayout/s16.di.1s.out b/src/test/disklayout/s16.di.1s.out
new file mode 100644
index 00000000..1b5ebcb7
--- /dev/null
+++ b/src/test/disklayout/s16.di.1s.out
@@ -0,0 +1,144 @@
+{
+	"spares": [
+		{
+			"name": "diskf",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskb",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "diskc",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskd",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diske",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 16003213148160
+}
diff --git a/src/test/disklayout/s16.di.m.out b/src/test/disklayout/s16.di.m.out
new file mode 100644
index 00000000..643254ad
--- /dev/null
+++ b/src/test/disklayout/s16.di.m.out
@@ -0,0 +1,154 @@
+{
+	"spares": [
+		{
+			"name": "diske",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		},
+		{
+			"name": "diskf",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskb",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "diskc",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskd",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 11202249203712
+}
diff --git a/src/test/disklayout/s16.di.m0.out b/src/test/disklayout/s16.di.m0.out
new file mode 100644
index 00000000..bcbd6960
--- /dev/null
+++ b/src/test/disklayout/s16.di.m0.out
@@ -0,0 +1,157 @@
+{
+	"vdevs": [
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskb",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "diskc",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskd",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "diske",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskf",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 12802570518528
+}
diff --git a/src/test/disklayout/s16.di.out b/src/test/disklayout/s16.di.out
new file mode 100644
index 00000000..addf204b
--- /dev/null
+++ b/src/test/disklayout/s16.di.out
@@ -0,0 +1,129 @@
+{
+	"spares": [
+		{
+			"name": "diske",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		},
+		{
+			"name": "diskf",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskb",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskc",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskd",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 16003213148160
+}
diff --git a/src/test/disklayout/s16.di.z1-0.out b/src/test/disklayout/s16.di.z1-0.out
new file mode 100644
index 00000000..df45c21a
--- /dev/null
+++ b/src/test/disklayout/s16.di.z1-0.out
@@ -0,0 +1,137 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskb",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "diskc",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskd",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diske",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskf",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 19203855777792
+}
diff --git a/src/test/disklayout/s16.di.z1.out b/src/test/disklayout/s16.di.z1.out
new file mode 100644
index 00000000..364602bf
--- /dev/null
+++ b/src/test/disklayout/s16.di.z1.out
@@ -0,0 +1,139 @@
+{
+	"spares": [
+		{
+			"name": "diskc",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		},
+		{
+			"name": "diskd",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		},
+		{
+			"name": "diske",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		},
+		{
+			"name": "diskf",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskb",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 12802570518528
+}
diff --git a/src/test/disklayout/s16.di.z2-0.out b/src/test/disklayout/s16.di.z2-0.out
new file mode 100644
index 00000000..ff8ebf14
--- /dev/null
+++ b/src/test/disklayout/s16.di.z2-0.out
@@ -0,0 +1,127 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskb",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskc",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskd",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diske",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskf",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 19203855777792
+}
diff --git a/src/test/disklayout/s16.di.z2.out b/src/test/disklayout/s16.di.z2.out
new file mode 100644
index 00000000..addf204b
--- /dev/null
+++ b/src/test/disklayout/s16.di.z2.out
@@ -0,0 +1,129 @@
+{
+	"spares": [
+		{
+			"name": "diske",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		},
+		{
+			"name": "diskf",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskb",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskc",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskd",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 16003213148160
+}
diff --git a/src/test/disklayout/s16.di.z3-0.out b/src/test/disklayout/s16.di.z3-0.out
new file mode 100644
index 00000000..1da168bd
--- /dev/null
+++ b/src/test/disklayout/s16.di.z3-0.out
@@ -0,0 +1 @@
+fatal error: no acceptable raidz3 layout is possible with 16 disks and 0 spares
diff --git a/src/test/disklayout/s16.di.z3.out b/src/test/disklayout/s16.di.z3.out
new file mode 100644
index 00000000..cf0836f0
--- /dev/null
+++ b/src/test/disklayout/s16.di.z3.out
@@ -0,0 +1,124 @@
+{
+	"spares": [
+		{
+			"name": "diskf",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz3",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskb",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskc",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskd",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diske",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 19203855777792
+}
diff --git a/src/test/disklayout/s17.di b/src/test/disklayout/s17.di
new file mode 100644
index 00000000..def4c2e8
--- /dev/null
+++ b/src/test/disklayout/s17.di
@@ -0,0 +1,17 @@
+SCSI	disk0	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk1	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk2	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk3	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk4	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk5	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk6	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk7	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk8	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk9	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	diska	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	diskb	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	diskc	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	diskd	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	diske	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	diskf	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk10	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
diff --git a/src/test/disklayout/s17.di.0s.out b/src/test/disklayout/s17.di.0s.out
new file mode 100644
index 00000000..665906cd
--- /dev/null
+++ b/src/test/disklayout/s17.di.0s.out
@@ -0,0 +1 @@
+fatal error: invalid number of spares (0) for this disk configuration
diff --git a/src/test/disklayout/s17.di.1s.out b/src/test/disklayout/s17.di.1s.out
new file mode 100644
index 00000000..e53371d3
--- /dev/null
+++ b/src/test/disklayout/s17.di.1s.out
@@ -0,0 +1,136 @@
+{
+	"spares": [
+		{
+			"name": "diskf",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk10",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskb",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskc",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskd",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diske",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 19203855777792
+}
diff --git a/src/test/disklayout/s17.di.out b/src/test/disklayout/s17.di.out
new file mode 100644
index 00000000..e53371d3
--- /dev/null
+++ b/src/test/disklayout/s17.di.out
@@ -0,0 +1,136 @@
+{
+	"spares": [
+		{
+			"name": "diskf",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk10",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskb",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskc",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskd",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diske",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 19203855777792
+}
diff --git a/src/test/disklayout/s6.di.0s.out b/src/test/disklayout/s6.di.0s.out
new file mode 100644
index 00000000..1e3e0d4f
--- /dev/null
+++ b/src/test/disklayout/s6.di.0s.out
@@ -0,0 +1,57 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "MFG",
+					"pid": "SSD",
+					"size": "600127266816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "SSD",
+					"size": "600127266816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "SSD",
+					"size": "600127266816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "SSD",
+					"size": "600127266816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "SSD",
+					"size": "600127266816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "SSD",
+					"size": "600127266816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 2400509067264
+}
diff --git a/src/test/disklayout/s6.di.1s.out b/src/test/disklayout/s6.di.1s.out
new file mode 100644
index 00000000..993b9295
--- /dev/null
+++ b/src/test/disklayout/s6.di.1s.out
@@ -0,0 +1,54 @@
+{
+	"spares": [
+		{
+			"name": "disk5",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "600127266816",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "MFG",
+					"pid": "SSD",
+					"size": "600127266816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "SSD",
+					"size": "600127266816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "SSD",
+					"size": "600127266816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "SSD",
+					"size": "600127266816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "SSD",
+					"size": "600127266816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 2400509067264
+}
diff --git a/src/test/disklayout/s8.di b/src/test/disklayout/s8.di
new file mode 100644
index 00000000..28cf32bf
--- /dev/null
+++ b/src/test/disklayout/s8.di
@@ -0,0 +1,9 @@
+SCSI	disk0	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk1	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk2	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk3	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk4	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk5	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk6	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk7	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+USB	key0	USBMFG	USB Key	15737028608	yes	no
diff --git a/src/test/disklayout/s8.di.0s.out b/src/test/disklayout/s8.di.0s.out
new file mode 100644
index 00000000..668dc53e
--- /dev/null
+++ b/src/test/disklayout/s8.di.0s.out
@@ -0,0 +1,66 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 9601927888896
+}
diff --git a/src/test/disklayout/s8.di.1s.out b/src/test/disklayout/s8.di.1s.out
new file mode 100644
index 00000000..24eb2b45
--- /dev/null
+++ b/src/test/disklayout/s8.di.1s.out
@@ -0,0 +1,68 @@
+{
+	"spares": [
+		{
+			"name": "disk7",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 8001606574080
+}
diff --git a/src/test/disklayout/s8.di.m.out b/src/test/disklayout/s8.di.m.out
new file mode 100644
index 00000000..20d98f87
--- /dev/null
+++ b/src/test/disklayout/s8.di.m.out
@@ -0,0 +1,78 @@
+{
+	"spares": [
+		{
+			"name": "disk6",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		},
+		{
+			"name": "disk7",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 4800963944448
+}
diff --git a/src/test/disklayout/s8.di.m0.out b/src/test/disklayout/s8.di.m0.out
new file mode 100644
index 00000000..3707fb19
--- /dev/null
+++ b/src/test/disklayout/s8.di.m0.out
@@ -0,0 +1,81 @@
+{
+	"vdevs": [
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 6401285259264
+}
diff --git a/src/test/disklayout/s8.di.out b/src/test/disklayout/s8.di.out
new file mode 100644
index 00000000..668dc53e
--- /dev/null
+++ b/src/test/disklayout/s8.di.out
@@ -0,0 +1,66 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 9601927888896
+}
diff --git a/src/test/disklayout/s8.di.z1.out b/src/test/disklayout/s8.di.z1.out
new file mode 100644
index 00000000..0348e3d1
--- /dev/null
+++ b/src/test/disklayout/s8.di.z1.out
@@ -0,0 +1,73 @@
+{
+	"spares": [
+		{
+			"name": "disk6",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		},
+		{
+			"name": "disk7",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 6401285259264
+}
diff --git a/src/test/disklayout/s8.di.z2.out b/src/test/disklayout/s8.di.z2.out
new file mode 100644
index 00000000..668dc53e
--- /dev/null
+++ b/src/test/disklayout/s8.di.z2.out
@@ -0,0 +1,66 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 9601927888896
+}
diff --git a/src/test/disklayout/s8.di.z3.out b/src/test/disklayout/s8.di.z3.out
new file mode 100644
index 00000000..fffb2c54
--- /dev/null
+++ b/src/test/disklayout/s8.di.z3.out
@@ -0,0 +1,66 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz3",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 8001606574080
+}
diff --git a/src/test/disklayout/s9.di b/src/test/disklayout/s9.di
new file mode 100644
index 00000000..38ffdcdc
--- /dev/null
+++ b/src/test/disklayout/s9.di
@@ -0,0 +1,10 @@
+SCSI	disk0	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk1	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk2	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk3	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk4	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk5	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk6	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk7	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+SCSI	disk8	ATA	INTEL SSDSC2BX01	1600321314816	no	yes
+USB	key0	USBMFG	USB Key	15737028608	yes	no
diff --git a/src/test/disklayout/s9.di.0s.out b/src/test/disklayout/s9.di.0s.out
new file mode 100644
index 00000000..c3adfdb0
--- /dev/null
+++ b/src/test/disklayout/s9.di.0s.out
@@ -0,0 +1,73 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 11202249203712
+}
diff --git a/src/test/disklayout/s9.di.1s.out b/src/test/disklayout/s9.di.1s.out
new file mode 100644
index 00000000..fa6c6b2a
--- /dev/null
+++ b/src/test/disklayout/s9.di.1s.out
@@ -0,0 +1,75 @@
+{
+	"spares": [
+		{
+			"name": "disk8",
+			"vid": "ATA",
+			"pid": "INTEL SSDSC2BX01",
+			"size": "1600321314816",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 9601927888896
+}
diff --git a/src/test/disklayout/s9.di.out b/src/test/disklayout/s9.di.out
new file mode 100644
index 00000000..c3adfdb0
--- /dev/null
+++ b/src/test/disklayout/s9.di.out
@@ -0,0 +1,73 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 11202249203712
+}
diff --git a/src/test/disklayout/tl-a.di.0s.out b/src/test/disklayout/tl-a.di.0s.out
new file mode 100644
index 00000000..79e4a704
--- /dev/null
+++ b/src/test/disklayout/tl-a.di.0s.out
@@ -0,0 +1,144 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "c0t5000CCA02203E181d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c10t5000CCA02203E355d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c11t5000CCA02200C695d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "c13t5000CCA016011879d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c14t5000CCA016010FBDd0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c15t5000CCA02203D63Dd0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "c1t5000CCA022040715d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c2t5000CCA022015A91d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c3t5000CCA02203D151d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "c4t5000CCA02203E2D1d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c5t5000CCA022016F69d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c6t5000CCA02203D20Dd0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "c7t5000CCA022040AB5d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c8t5000CCA022016ADDd0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c9t5000CCA02203E3A9d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 6001272668160,
+	"logs": [
+		{
+			"name": "c12t5000CCA0490428ADd0",
+			"vid": "HGST",
+			"pid": "HUSMH8010BSS204",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/tl-a.di.1s.out b/src/test/disklayout/tl-a.di.1s.out
new file mode 100644
index 00000000..ce7e957d
--- /dev/null
+++ b/src/test/disklayout/tl-a.di.1s.out
@@ -0,0 +1,156 @@
+{
+	"spares": [
+		{
+			"name": "c9t5000CCA02203E3A9d0",
+			"vid": "HITACHI",
+			"pid": "HUC109060CSS600",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "c0t5000CCA02203E181d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c10t5000CCA02203E355d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "c11t5000CCA02200C695d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c13t5000CCA016011879d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "c14t5000CCA016010FBDd0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c15t5000CCA02203D63Dd0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "c1t5000CCA022040715d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c2t5000CCA022015A91d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "c3t5000CCA02203D151d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c4t5000CCA02203E2D1d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "c5t5000CCA022016F69d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c6t5000CCA02203D20Dd0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "mirror",
+			"devices": [
+				{
+					"name": "c7t5000CCA022040AB5d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c8t5000CCA022016ADDd0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 4200890867712,
+	"logs": [
+		{
+			"name": "c12t5000CCA0490428ADd0",
+			"vid": "HGST",
+			"pid": "HUSMH8010BSS204",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/tl-ars.di.0s.out b/src/test/disklayout/tl-ars.di.0s.out
new file mode 100644
index 00000000..e5f57055
--- /dev/null
+++ b/src/test/disklayout/tl-ars.di.0s.out
@@ -0,0 +1,54 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "c0t5000CCA02203E181d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c1t5000CCA022040715d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c2t5000CCA022015A91d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c3t5000CCA02203D151d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c4t5000CCA02203E2D1d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 2400509067264,
+	"logs": [
+		{
+			"name": "c12t5000CCA0490428ADd0",
+			"vid": "HGST",
+			"pid": "HUSMH8010BSS204",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/tl-ars.di.1s.out b/src/test/disklayout/tl-ars.di.1s.out
new file mode 100644
index 00000000..c465012a
--- /dev/null
+++ b/src/test/disklayout/tl-ars.di.1s.out
@@ -0,0 +1,56 @@
+{
+	"spares": [
+		{
+			"name": "c4t5000CCA02203E2D1d0",
+			"vid": "HITACHI",
+			"pid": "HUC109060CSS600",
+			"size": "600127266816",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz",
+			"devices": [
+				{
+					"name": "c0t5000CCA02203E181d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c1t5000CCA022040715d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c2t5000CCA022015A91d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "c3t5000CCA02203D151d0",
+					"vid": "HITACHI",
+					"pid": "HUC109060CSS600",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 1800381800448,
+	"logs": [
+		{
+			"name": "c12t5000CCA0490428ADd0",
+			"vid": "HGST",
+			"pid": "HUSMH8010BSS204",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/tl-b.di.0s.out b/src/test/disklayout/tl-b.di.0s.out
new file mode 100644
index 00000000..1f4f5128
--- /dev/null
+++ b/src/test/disklayout/tl-b.di.0s.out
@@ -0,0 +1,103 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk10",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk11",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk12",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk6",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk7",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk8",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk9",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 40000000000000,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/tl-b.di.1s.out b/src/test/disklayout/tl-b.di.1s.out
new file mode 100644
index 00000000..7a1a666a
--- /dev/null
+++ b/src/test/disklayout/tl-b.di.1s.out
@@ -0,0 +1,105 @@
+{
+	"spares": [
+		{
+			"name": "disk9",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "4000000000000",
+			"solid_state": false
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk1",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk10",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk11",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk12",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk2",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk3",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk4",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk5",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk6",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk7",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				},
+				{
+					"name": "disk8",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "4000000000000",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 36000000000000,
+	"logs": [
+		{
+			"name": "disk0",
+			"vid": "MFG",
+			"pid": "SSD",
+			"size": "100030242816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/tl-c.di.0s.out b/src/test/disklayout/tl-c.di.0s.out
new file mode 100644
index 00000000..6291ee4a
--- /dev/null
+++ b/src/test/disklayout/tl-c.di.0s.out
@@ -0,0 +1,73 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 5600000000000
+}
diff --git a/src/test/disklayout/tl-c.di.1s.out b/src/test/disklayout/tl-c.di.1s.out
new file mode 100644
index 00000000..a7c5bc28
--- /dev/null
+++ b/src/test/disklayout/tl-c.di.1s.out
@@ -0,0 +1,75 @@
+{
+	"spares": [
+		{
+			"name": "disk8",
+			"vid": "INTEL",
+			"pid": "DCS3700",
+			"size": "800000000000",
+			"solid_state": true
+		}
+	],
+	"vdevs": [
+		{
+			"type": "raidz2",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 4800000000000
+}
diff --git a/src/test/disklayout/tl-c.di.out b/src/test/disklayout/tl-c.di.out
index b8bcc3a3..6291ee4a 100644
--- a/src/test/disklayout/tl-c.di.out
+++ b/src/test/disklayout/tl-c.di.out
@@ -1,16 +1,7 @@
 {
-	"spares": [
-		{
-			"name": "disk8",
-			"vid": "INTEL",
-			"pid": "DCS3700",
-			"size": "800000000000",
-			"solid_state": true
-		}
-	],
 	"vdevs": [
 		{
-			"type": "raidz",
+			"type": "raidz2",
 			"devices": [
 				{
 					"name": "disk0",
@@ -39,12 +30,7 @@
 					"pid": "DCS3700",
 					"size": "800000000000",
 					"solid_state": true
-				}
-			]
-		},
-		{
-			"type": "raidz",
-			"devices": [
+				},
 				{
 					"name": "disk4",
 					"vid": "INTEL",
@@ -72,9 +58,16 @@
 					"pid": "DCS3700",
 					"size": "800000000000",
 					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "INTEL",
+					"pid": "DCS3700",
+					"size": "800000000000",
+					"solid_state": true
 				}
 			]
 		}
 	],
-	"capacity": 4800000000000
+	"capacity": 5600000000000
 }
-- 
2.21.0

