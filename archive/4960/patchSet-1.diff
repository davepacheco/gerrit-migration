From 7f672f6c25a34c3590c8b2343816270b5c5a2e3f Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Mon, 15 Oct 2018 10:16:45 -0700
Subject: [PATCH] TRITON-878 net-agent broke on old non-vminfod platforms

---
 lib/watcher-fsm.js | 6 +++---
 package.json       | 2 +-
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/lib/watcher-fsm.js b/lib/watcher-fsm.js
index abcfb78..9b00490 100644
--- a/lib/watcher-fsm.js
+++ b/lib/watcher-fsm.js
@@ -73,8 +73,6 @@ function currentMillis() {
 function ZoneEventFSM(opts) {
     assert.object(opts, 'opts');
     assert.object(opts.log, 'opts.log');
-    assert.ok(['object', 'function']
-        .indexOf(typeof (opts.vmadm)) !== -1, 'opts.vmadm');
 
     this.log = opts.log.child({
         component: 'zoneevent'
@@ -83,7 +81,6 @@ function ZoneEventFSM(opts) {
     this.proc = null;
     this.stdout = null;
     this.stderr = null;
-    this.vmadm = opts.vmadm;
 
     mod_mooremachine.FSM.call(this, 'init');
 }
@@ -179,12 +176,15 @@ ZoneEventFSM.prototype.stop = function () {
 function WatcherFSM(opts) {
     assert.object(opts, 'opts');
     assert.object(opts.app, 'opts.app');
+    assert.ok(['object', 'function']
+        .indexOf(typeof (opts.vmadm)) !== -1, 'opts.vmadm');
 
     this.app = opts.app;
     this.log = opts.app.log.child({
         component: 'watcher'
     }, true);
 
+    this.vmadm = opts.vmadm;
     this.zoneevent = new ZoneEventFSM({ log: opts.app.log });
 
     /*
diff --git a/package.json b/package.json
index 00d495a..334bbaf 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "net-agent",
     "description": "Triton Network Agent",
-    "version": "2.2.0",
+    "version": "2.2.1",
     "author": "Joyent (joyent.com)",
     "private": true,
     "dependencies": {
-- 
2.21.0

