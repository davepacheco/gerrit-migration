{"project":"joyent/sdc-vmapi","branch":"master","id":"I237cb9c76700c95caf7862eac7c97ea7d75cb160","number":"3251","subject":"TRITON-59 check that instances mounting NFS volumes are provisioned on networks on which volumes are reachable Reviewed by: Josh Wilsdon \u003cjwilsdon@joyent.com\u003e Approved by: Josh Wilsdon \u003cjwilsdon@joyent.com\u003e","owner":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"url":"https://cr.joyent.us/3251","commitMessage":"TRITON-59 check that instances mounting NFS volumes are provisioned on networks on which volumes are reachable\nReviewed by: Josh Wilsdon \u003cjwilsdon@joyent.com\u003e\nApproved by: Josh Wilsdon \u003cjwilsdon@joyent.com\u003e\n","createdOn":1516677225,"lastUpdated":1516902983,"open":false,"status":"MERGED","comments":[{"timestamp":1516677225,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 1."},{"timestamp":1516677255,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516677518,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\nI\u0027ll add testing notes shortly."},{"timestamp":1516678844,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1: Code-Review+1\n\n(4 comments)\n\nThe code itself I think is fine. I do have a few higher-level questions though:\n\n1) is network.ipv4_uuid matching always sufficient to guarantee two instances can talk to each other?\n2) related to #1: do we care if there are firewall rules which would prevent the volume from working?\n3) again related to #1: is it possible for a customer to setup custom routes that would cause problems for volumes? Do we need to care about that? Or at least document that you can shoot yourself when using that feature?"},{"timestamp":1516771368,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\nGreat questions as always!\n\n\u003e 1) is network.ipv4_uuid matching always sufficient to guarantee two instances can talk to each other?\n\nnetwork.ipv4_uuid matching is not _sufficient_ but it is _necessary_: if a VM tries to mount a volume that is unreachable, the failure mode goes from stalling forever (docker VMs will stall in dockerinit retrying to mount the volume forever) to transitioning the VM to a failed state (for non-docker machines).\n\n\u003e related to #1: do we care if there are firewall rules which would prevent the volume from working?\n\nFirewall rules will definitely affect VMs that mount volumes. I think it might be possible at provisioning time to check whether the current set of firewall rules would not block traffic between the machine to be provisioned and the mounted volumes, but it seems it could get quite complex. Would it make sense to investigate that further in a follow-up ticket that would *not* be part of the MVP milestone?\n\nIn the meantime we could document that in a follow-up ticket as part of the MVP milestone.\n\n\u003e  again related to #1: is it possible for a customer to setup custom routes that would cause problems for volumes?\n\nI would think so. \n\n\u003e Do we need to care about that?\n\nI don\u0027t know, since it seems users could also break inter-machines connectivity by setting up custom routes, unless I\u0027m missing something.\n\n\u003e Or at least document that you can shoot yourself when using that feature?\n\nDocumenting it in a followup ticket seems to make sense to me.\n\nHow does that sound?"},{"timestamp":1516771515,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 2."},{"timestamp":1516771544,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1516771545,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516771585,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1\n\nI think moving things to new tickets is fine."},{"timestamp":1516902975,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3: Commit message was updated."},{"timestamp":1516902983,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Julien Gilli"}],"currentPatchSet":{"number":"3","revision":"3ce6a7de61610641325f0bb6cccca27104c5ecc2","parents":["1bdd286fcb7c7168e43a425c8ccb100d4b38d3f1"],"ref":"refs/changes/51/3251/3","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1516902975,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516771545,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516771585,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516771585,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1516902982,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":103,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":34,"deletions":-2},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":153,"sizeDeletions":-6},"patchSets":[{"number":"1","revision":"cc65855967b940305728abeffeb312d239dd7b81","parents":["1bdd286fcb7c7168e43a425c8ccb100d4b38d3f1"],"ref":"refs/changes/51/3251/1","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1516677225,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516677255,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516678844,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"comments":[{"file":"lib/endpoints/vms.js","line":8,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"It\u0027s 2018 already! Can you believe it? Me neither."},{"file":"lib/endpoints/vms.js","line":8,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/errors.js","line":8,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"2018 for almost 22 whole days!"},{"file":"lib/errors.js","line":8,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/vmapi.js","line":8,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Babies born in 2017 are all more than 3 weeks old!"},{"file":"lib/vmapi.js","line":8,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"server.js","line":8,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"2017 was not an Olympic year, but 2018 is!"},{"file":"server.js","line":8,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":102,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":33,"deletions":-1},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":10,"deletions":0}],"sizeInsertions":149,"sizeDeletions":-2},{"number":"2","revision":"237cb9c76700c95caf7862eac7c97ea7d75cb160","parents":["1bdd286fcb7c7168e43a425c8ccb100d4b38d3f1"],"ref":"refs/changes/51/3251/2","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1516771515,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516771545,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516771585,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516771585,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":103,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":34,"deletions":-2},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":153,"sizeDeletions":-6},{"number":"3","revision":"3ce6a7de61610641325f0bb6cccca27104c5ecc2","parents":["1bdd286fcb7c7168e43a425c8ccb100d4b38d3f1"],"ref":"refs/changes/51/3251/3","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1516902975,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516771545,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516771585,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516771585,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1516902982,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":103,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":34,"deletions":-2},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":153,"sizeDeletions":-6}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}]}