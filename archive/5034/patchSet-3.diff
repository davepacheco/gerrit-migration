From d62fdbd78bcf9c86273d6ea0c362219d1322dc47 Mon Sep 17 00:00:00 2001
From: Jason King <jason.king@joyent.com>
Date: Sun, 16 Sep 2018 04:21:25 +0000
Subject: [PATCH] OS-7345 Add support to mdb for anonymous/unnamed structs and
 unions.

---
 usr/src/cmd/mdb/common/mdb/mdb_ctf.c   | 25 ++++++++++++++++++++++++-
 usr/src/cmd/mdb/common/mdb/mdb_print.c | 14 ++++++++++----
 2 files changed, 34 insertions(+), 5 deletions(-)

diff --git a/usr/src/cmd/mdb/common/mdb/mdb_ctf.c b/usr/src/cmd/mdb/common/mdb/mdb_ctf.c
index 534c92f5dc..68ee5d80b0 100644
--- a/usr/src/cmd/mdb/common/mdb/mdb_ctf.c
+++ b/usr/src/cmd/mdb/common/mdb/mdb_ctf.c
@@ -838,6 +838,7 @@ static int
 member_info_cb(const char *name, mdb_ctf_id_t id, ulong_t off, void *data)
 {
 	mbr_info_t *mbrp = data;
+	int kind, ret;
 
 	if (strcmp(name, mbrp->mbr_member) == 0) {
 		if (mbrp->mbr_offp != NULL)
@@ -848,7 +849,29 @@ member_info_cb(const char *name, mdb_ctf_id_t id, ulong_t off, void *data)
 		return (1);
 	}
 
-	return (0);
+	/*
+	 * C11 as well as earlier GNU extensions allow an embedded struct
+	 * or union to be unnamed as long as there are no unambiguous member
+	 * names.  If we encounter a SOU member with a 0-length name,
+	 * recurse into it and see if any of them match.
+	 */
+	if (strlen(name) != 0)
+		return (0);
+
+	kind = mdb_ctf_type_kind(id);
+	if (kind == CTF_ERR)
+		return (-1);
+	if (kind != CTF_K_STRUCT && kind != CTF_K_UNION)
+		return (0);
+
+	ret = mdb_ctf_member_iter(id, member_info_cb, mbrp);
+	if (ret == -1)
+		return (-1);
+	if (ret == 0)
+		return (0);
+
+	mbrp->mbr_offp += off;
+	return (1);
 }
 
 int
diff --git a/usr/src/cmd/mdb/common/mdb/mdb_print.c b/usr/src/cmd/mdb/common/mdb/mdb_print.c
index fe74265b68..8f05669188 100644
--- a/usr/src/cmd/mdb/common/mdb/mdb_print.c
+++ b/usr/src/cmd/mdb/common/mdb/mdb_print.c
@@ -25,7 +25,7 @@
 
 /*
  * Copyright (c) 2012, 2014 by Delphix. All rights reserved.
- * Copyright 2015 Joyent, Inc.
+ * Copyright 2018 Joyent, Inc.
  * Copyright (c) 2014 Nexenta Systems, Inc. All rights reserved.
  */
 
@@ -1699,8 +1699,12 @@ elt_print(const char *name, mdb_ctf_id_t id, mdb_ctf_id_t base,
 	}
 
 	if (depth != 0 ||
-	    ((pap->pa_flags & PA_SHOWNAME) && pap->pa_prefix != NULL))
-		mdb_printf("%s ", pap->pa_flags & PA_SHOWVAL ? " =" : "");
+	    ((pap->pa_flags & PA_SHOWNAME) && pap->pa_prefix != NULL)) {
+		size_t len = strlen(name);
+
+		mdb_printf("%s%s ", (len == 0) ? "(anon)" : "",
+		    pap->pa_flags & PA_SHOWVAL ? " =" : "");
+	}
 
 	if (depth == 0 && pap->pa_prefix != NULL)
 		name = pap->pa_prefix;
@@ -2420,8 +2424,10 @@ cmd_print(uintptr_t addr, uint_t flags, int argc, const mdb_arg_t *argv)
 				kind = mdb_ctf_type_kind(rid);
 				if (last_deref && IS_SOU(kind)) {
 					char *end;
+					size_t len = strlen(member);
 					(void) mdb_snprintf(buf, sizeof (buf),
-					    "%s", member);
+					    "%s", (len == 0) ?
+					    "<anon>" : member);
 					end = strrchr(buf, '[');
 					*end = '\0';
 					pa.pa_suffix = "->";
-- 
2.21.0

