{"project":"joyent/illumos-joyent","branch":"master","id":"Ib118ac96296ecb7740c933bfe013b565a00b56c5","number":"5034","subject":"OS-7345 Add support to mdb for anonymous/unnamed structs and unions. Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Approved by: Dan McDonald \u003cdanmcd@joyent.com\u003e","owner":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"url":"https://cr.joyent.us/5034","commitMessage":"OS-7345 Add support to mdb for anonymous/unnamed structs and unions.\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nApproved by: Dan McDonald \u003cdanmcd@joyent.com\u003e\n","createdOn":1541532162,"lastUpdated":1543379151,"open":false,"status":"MERGED","comments":[{"timestamp":1541532162,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 1."},{"timestamp":1541700203,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)\n\nIn general, this looks good."},{"timestamp":1541703957,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 2."},{"timestamp":1541715883,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Code-Review+1\n\nThanks!"},{"timestamp":1541796650,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1542056316,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 4."},{"timestamp":1542056471,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 4:\n\nAdditional testing from when it was originally written a couple months ago found a bug w/ nesting and a minor formatting nit.  Updated, testing of updated version (patch 4) has been added to JIRA as well."},{"timestamp":1542059411,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1542070433,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1542070439,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 5."},{"timestamp":1542218422,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1542223657,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1542470338,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1542497153,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 6."},{"timestamp":1542663922,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 6: Code-Review+1\n\nIt still feels a bit weird to only handle one or the other, but I think that\u0027s probably just differences in personal takes. Thanks for the comments."},{"timestamp":1543349222,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 6: Code-Review+1\n\nCode looks good.  But before I\u0027d IA, I\u0027d like a few more tests:\n\n- Using modifiers to ::print like -a and/or -t.\n- Anonymous structs (you have anonymous unions covered).\n- Nested anonymous entities, in particular I\u0027d like to see something like:\n\n    union {\n           uint32_t this_ports;\n           struct {\n                 uint16_t this_lport;\n                 uint16_t this_fport;\n           };\n     };"},{"timestamp":1543354405,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 6: Integration-Approval+1\n\nThanks for the updated tests \u0026 results."},{"timestamp":1543354627,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1543356458,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 8: Patch Set 7 was rebased."},{"timestamp":1543379151,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jason King"}],"currentPatchSet":{"number":"8","revision":"b118ac96296ecb7740c933bfe013b565a00b56c5","parents":["6466dea896ec0283655f3eb5820688dd3a3e7ff2"],"ref":"refs/changes/34/5034/8","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1543356458,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542663922,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543349222,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543354405,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"SUBM","value":"1","grantedOn":1543379151,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","type":"MODIFIED","insertions":56,"deletions":-2},{"file":"usr/src/cmd/mdb/common/mdb/mdb_print.c","type":"MODIFIED","insertions":52,"deletions":-3}],"sizeInsertions":108,"sizeDeletions":-5},"patchSets":[{"number":"1","revision":"ec4942761b3c797e8e70464eef562466572a3d5d","parents":["85face0b82dd8468c97810dc191e2d4c9b14c81a"],"ref":"refs/changes/34/5034/1","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1541532162,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","line":860,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Minor nit, but can the rest of this file doesn\u0027t do C99 style assignments, can we keep this with the traditional style and declare these at the top?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","type":"MODIFIED","insertions":23,"deletions":-1},{"file":"usr/src/cmd/mdb/common/mdb/mdb_print.c","type":"MODIFIED","insertions":10,"deletions":-4}],"sizeInsertions":33,"sizeDeletions":-5},{"number":"2","revision":"2e264bee70bd1fa9e168d51d1243434baac1141a","parents":["85face0b82dd8468c97810dc191e2d4c9b14c81a"],"ref":"refs/changes/34/5034/2","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1541703957,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541715883,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","type":"MODIFIED","insertions":24,"deletions":-1},{"file":"usr/src/cmd/mdb/common/mdb/mdb_print.c","type":"MODIFIED","insertions":10,"deletions":-4}],"sizeInsertions":34,"sizeDeletions":-5},{"number":"3","revision":"d62fdbd78bcf9c86273d6ea0c362219d1322dc47","parents":["c1a6a5e6fc3b706d4bb590f9ef8984da3507ab8c"],"ref":"refs/changes/34/5034/3","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1541796650,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541715883,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","type":"MODIFIED","insertions":24,"deletions":-1},{"file":"usr/src/cmd/mdb/common/mdb/mdb_print.c","type":"MODIFIED","insertions":10,"deletions":-4}],"sizeInsertions":34,"sizeDeletions":-5},{"number":"4","revision":"a9660f995a3bea8d05a69589febec7f6700c0ddc","parents":["c1a6a5e6fc3b706d4bb590f9ef8984da3507ab8c"],"ref":"refs/changes/34/5034/4","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1542056316,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","line":873,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Hmm.. I missed this could be NULL (none of the current consumers ever call this with `offp \u003d\u003d NULL`, but it does appear it\u0027s allowed)."},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","line":884,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why do we need to initialize this now? Shouldn\u0027t we only be changing this if it\u0027s successful and only using it if it\u0027s successful? Shouldn\u0027t we be consistent with typep as well being in the same state?"},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","line":884,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"All the existing consumers pass a pointer to uninitialized memory for `offp` and `typep`, so it\u0027s not clear there\u0027s any expectations on their contents on failure (and no documentation I could find that might clarify things).\n\nThat said, it\u0027s not a big deal to only modify `offp` on success to make a bit of a stronger guarantee.  I\u0027ll update it accordingly."},{"file":"usr/src/cmd/mdb/common/mdb/mdb_print.c","line":1701,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I have to be honest, I know why you\u0027re using the macro construct here, but for some reason it leads me to feel like there\u0027s something odd about having it. Probably worth a comment about the complex condition."},{"file":"usr/src/cmd/mdb/common/mdb/mdb_print.c","line":1701,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Looking at this some more, I think moving this up to line 1683 might make more sense -- let me post an update (along with a long explanation in the comments), and see if that works better."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","type":"MODIFIED","insertions":26,"deletions":-1},{"file":"usr/src/cmd/mdb/common/mdb/mdb_print.c","type":"MODIFIED","insertions":13,"deletions":-4}],"sizeInsertions":39,"sizeDeletions":-5},{"number":"5","revision":"c29754435ec009a25f1de2d77c4a60084d3c219c","parents":["c1a6a5e6fc3b706d4bb590f9ef8984da3507ab8c"],"ref":"refs/changes/34/5034/5","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1542070439,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","line":888,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Honestly, what was there before your change seemed fine. I just was confused by the addition of the initialization. Again, we should have offp and typep be consistent. If we\u0027re going to do this to offp, we should do it to typep."},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","line":888,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"I guess I\u0027m confused about what you find inconsistent -- the CTF type id of the member is not dependent on anything else, so it\u0027s assigned when found.\n\nFor the member offset though, it\u0027s different when an unnamed sou is present.  When we find the member, what we have is `offsetof(\u003canon\u003e, member)`, but we need `offsetof(outer, \u003canon\u003e) + offsetof(\u003canon\u003e, member)`.  This can potentially recurse if there are no ambiguities.  Initializing the offset to 0 means we can just always add of the offsets as we recurse instead of \u0027assign on first call, add on recursive calls\u0027.\n\nWould a comment help make it clearer?"},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","line":888,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"There were two things that seemed odd when I first saw it. The first was that I didn\u0027t understand the intent of why it needed to be zeored in what you had. That basically wasn\u0027t clear until your most recent comment here. That explains why we want to zero offp initially so we can make the surrounding logic and offsets clearer. Thanks. It probably is worth a short comment.\n\nThe second thing was that it seemed odd that we\u0027re going to assume that offp may be NULL and shouldn\u0027t be assigned, but we\u0027re not going to assume the same of typep. It seems like the two should be thought of as being the same from a viability of dereferencing perspective. If we think it\u0027s unsafe to initialize and derefence offp and check against NULL in the end, then that should probably be true of typep.  It\u0027s not clear to me why one of them is safer or less safe to dereference."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","type":"MODIFIED","insertions":31,"deletions":-2},{"file":"usr/src/cmd/mdb/common/mdb/mdb_print.c","type":"MODIFIED","insertions":52,"deletions":-3}],"sizeInsertions":83,"sizeDeletions":-5},{"number":"6","revision":"2941e4e679070c84115cfcdf1023d60a42b5e8f6","parents":["c1a6a5e6fc3b706d4bb590f9ef8984da3507ab8c"],"ref":"refs/changes/34/5034/6","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1542497153,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542663922,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543349222,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543354405,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","type":"MODIFIED","insertions":56,"deletions":-2},{"file":"usr/src/cmd/mdb/common/mdb/mdb_print.c","type":"MODIFIED","insertions":52,"deletions":-3}],"sizeInsertions":108,"sizeDeletions":-5},{"number":"7","revision":"558d19716f0059b1e7aadb5afca8275bcfed6271","parents":["c1a6a5e6fc3b706d4bb590f9ef8984da3507ab8c"],"ref":"refs/changes/34/5034/7","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1543354627,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542663922,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543349222,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543354405,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","type":"MODIFIED","insertions":56,"deletions":-2},{"file":"usr/src/cmd/mdb/common/mdb/mdb_print.c","type":"MODIFIED","insertions":52,"deletions":-3}],"sizeInsertions":108,"sizeDeletions":-5},{"number":"8","revision":"b118ac96296ecb7740c933bfe013b565a00b56c5","parents":["6466dea896ec0283655f3eb5820688dd3a3e7ff2"],"ref":"refs/changes/34/5034/8","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1543356458,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542663922,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1543379151,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543349222,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543354405,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/mdb/common/mdb/mdb_ctf.c","type":"MODIFIED","insertions":56,"deletions":-2},{"file":"usr/src/cmd/mdb/common/mdb/mdb_print.c","type":"MODIFIED","insertions":52,"deletions":-3}],"sizeInsertions":108,"sizeDeletions":-5}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}]}