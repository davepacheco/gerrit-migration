From 6d0dae598bcb9f90df658e4ff8aa1192fbbc1240 Mon Sep 17 00:00:00 2001
From: Tim Foster <tim.foster@joyent.com>
Date: Fri, 14 Jun 2019 16:23:17 +0100
Subject: [PATCH] OS-7833 smartos-live build artifacts should include gitstatus
 and changelog

---
 Makefile         | 7 ++++---
 tools/build_live | 3 ++-
 2 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/Makefile b/Makefile
index cd4bd761..578393db 100644
--- a/Makefile
+++ b/Makefile
@@ -10,7 +10,7 @@
 #
 
 #
-# Copyright (c) 2019, Joyent, Inc.
+# Copyright 2019 Joyent, Inc.
 #
 
 #
@@ -506,6 +506,9 @@ common-platform-publish:
 	    fi; \
 	done
 	echo $(PLATFORM_STAMP) > latest-build-stamp
+	./tools/build_changelog
+	cp output/gitstatus.json $(PLATFORM_BITS_DIR)
+	cp output/changelog.txt $(PLATFORM_BITS_DIR)
 
 .PHONY: triton-platform-publish
 triton-platform-publish: common-platform-publish
@@ -582,7 +585,6 @@ platform-bits-upload-latest:
 #
 .PHONY: smartos-build
 smartos-build:
-	./tools/build_changelog
 	./tools/build_boot_image -I -r $(ROOT)
 	./tools/build_boot_image -r $(ROOT)
 	./tools/build_vmware -r $(ROOT)
@@ -591,7 +593,6 @@ smartos-build:
 smartos-publish:
 	@echo "# Publish SmartOS platform $(PLATFORM_TIMESTAMP) images"
 	mkdir -p $(PLATFORM_BITS_DIR)
-	cp output/changelog.txt $(PLATFORM_BITS_DIR)
 	cp output/platform-$(PLATFORM_TIMESTAMP)/root.password \
 	    $(PLATFORM_BITS_DIR)/SINGLE_USER_ROOT_PASSWORD.txt
 	cp output-iso/platform-$(PLATFORM_TIMESTAMP).iso \
diff --git a/tools/build_live b/tools/build_live
index 816c3a6b..df2c185d 100755
--- a/tools/build_live
+++ b/tools/build_live
@@ -11,7 +11,7 @@
 #
 
 #
-# Copyright (c) 2018, Joyent, Inc.
+# Copyright 2019 Joyent, Inc.
 #
 
 #
@@ -423,6 +423,7 @@ function bi_gen_etcrelease
 	    >"$bi_archive.gitstatus"; then
 		fail "could not generate gitstatus file"
 	fi
+	cp "$bi_archive.gitstatus" "$bi_out_dir/gitstatus.json"
 
 	bi_emit_done
 }
-- 
2.21.0

