From 9d1edd906539ba2a683416c7d6f7ac0d9e5ce094 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Thu, 15 Sep 2016 17:59:03 -0700
Subject: [PATCH] joyent/node-cueball#22 ConnectionFSM states 'error' and
 'idle' do not handle 'closeAsserted'

---
 lib/pool.js  | 7 +++++++
 package.json | 4 ++--
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/lib/pool.js b/lib/pool.js
index 905bf5a..9043e32 100644
--- a/lib/pool.js
+++ b/lib/pool.js
@@ -258,6 +258,12 @@ ConnectionFSM.prototype.state_closed = function (on) {
 
 ConnectionFSM.prototype.state_error = function (on, once, timeout) {
 	this.validTransitions(['delay', 'closed']);
+
+	var self = this;
+	on(this, 'closeAsserted', function () {
+		self.gotoState('closed');
+	});
+
 	if (this.cf_conn && this.cf_conn.destroy)
 		this.cf_conn.destroy();
 	this.cf_conn = undefined;
@@ -367,6 +373,7 @@ ConnectionFSM.prototype.state_idle = function (on, once, timeout) {
 		this.cf_closeAfter = false;
 		this.cf_lastError = undefined;
 		this.gotoState('closed');
+		on(this, 'closeAsserted', function () { });
 		return;
 	}
 
diff --git a/package.json b/package.json
index f602dff..92efc2c 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "cueball",
-  "version": "0.4.0",
+  "version": "0.4.1",
   "description": "",
   "main": "lib/index.js",
   "dependencies": {
@@ -9,7 +9,7 @@
     "cmdutil": ">=1.0.0 <2.0.0",
     "extsprintf": ">=1.3.0 <2.0.0",
     "ipaddr.js": ">=1.1.0 <2.0.0",
-    "mooremachine": ">=1.4.0 <2.0.0",
+    "mooremachine": ">=1.4.2 <2.0.0",
     "named-client": "git+https://github.com/arekinath/node-named-client.git#v0.3.5",
     "node-uuid": ">=1.4.7 <2.0.0",
     "posix-getopt": ">=1.2.0 <2.0.0",
-- 
2.21.0

