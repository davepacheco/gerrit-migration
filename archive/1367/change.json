{"project":"joyent/illumos-joyent","branch":"master","id":"Idda1f9a81f5e81013b6df1dd838f8a23774ed0b5","number":"1367","subject":"OS-5845 lx aio performance improvements and move into kernel Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: Bryan Cantrill \u003cbryan@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/1367","commitMessage":"OS-5845 lx aio performance improvements and move into kernel\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: Bryan Cantrill \u003cbryan@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1485561563,"lastUpdated":1487802070,"open":false,"status":"MERGED","comments":[{"timestamp":1485561563,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1485561654,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nI have more tests to write, but this passes my aio perf tests, the existing io_* test suite and LTP. I\u0027m looking for initial input while I write more tests."},{"timestamp":1485625022,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1485625053,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nFixed a mistake I thought of this morning."},{"timestamp":1485892080,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(18 comments)"},{"timestamp":1485897074,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(16 comments)\n\nI accepted most of the input. There is one high level question on exactly how closely we have to match Linux on submit. If we want to be 100% then I will rewrite the code as discussed."},{"timestamp":1485991933,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1485991997,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\nI\u0027m working on some testing notes to add to the ticket and I\u0027ll be pushing my expanded aio tests, although our current code will fail on that."},{"timestamp":1486043737,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4."},{"timestamp":1486043793,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\nI realized we had an underlying lx bug which was making the aio changes more complex. Fixed that bug, added it to this set of changes and streamlined the aio code."},{"timestamp":1486056057,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5."},{"timestamp":1486056093,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5:\n\nOne last fix from another new test case, should be ready for detailed review now."},{"timestamp":1486075069,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5:\n\n(6 comments)"},{"timestamp":1486158395,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 6."},{"timestamp":1486158479,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 6:\n\n(2 comments)\n\nThe latest CR does not yet have any changes for the getf/releasef issue or the gcore issue. In regards to the FSYNC question, since that won\u0027t work at all on Linux I am not sure what any actual error code would be so I think the current handling is fine."},{"timestamp":1486164667,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6:\n\n(7 comments)"},{"timestamp":1486388887,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 6:\n\n(7 comments)"},{"timestamp":1486388895,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 7."},{"timestamp":1486492107,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 8."},{"timestamp":1486492163,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 8:\n\nI have added the gcore fix and made the changes to hold the file pointer and pass it along to one of the worker threads."},{"timestamp":1486501935,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 8:\n\n(4 comments)"},{"timestamp":1486502926,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 8:\n\n(4 comments)"},{"timestamp":1486507788,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 9."},{"timestamp":1486509335,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 9:\n\n(1 comment)"},{"timestamp":1486511595,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 10."},{"timestamp":1486577636,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 10:\n\n(19 comments)"},{"timestamp":1486581808,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 10:\n\n(15 comments)"},{"timestamp":1486582826,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 10:\n\n(1 comment)"},{"timestamp":1486598154,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 11."},{"timestamp":1486598167,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 10:\n\n(2 comments)"},{"timestamp":1486645240,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 12."},{"timestamp":1486645263,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 10:\n\n(1 comment)"},{"timestamp":1486653480,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 10:\n\n(1 comment)"},{"timestamp":1486655393,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 10:\n\n(1 comment)"},{"timestamp":1486657185,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 13."},{"timestamp":1487384933,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 13:\n\n(22 comments)\n\nTook a pass over lx_aio.c. Still need to review the rest. The issue with the releasef() is the most pressing -- though I also wonder if an alloca() for small values of min_nr would be a win in the hot paths..."},{"timestamp":1487535598,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 13:\n\n(8 comments)\n\nI will address all of the comment suggestions and the other items I noted in my responses."},{"timestamp":1487691033,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 13:\n\nI did notice one issue related to my use of \u0027set_active_fd\u0027 on a debug build and today I was able to trigger the ASSERT in that function. I don\u0027t know why I wasn\u0027t triggering that ASSERT on my earlier DEBUG build runs, but I did make the change to initialize the array with a set_active_fd(-1) call on each thread that might call set_active_fd without using getf."},{"timestamp":1487691056,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 14."},{"timestamp":1487693249,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 14:\n\n(4 comments)"},{"timestamp":1487696744,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 14:\n\n(3 comments)\n\nI\u0027ll wait for any further input from Bryan before I update the CR again."},{"timestamp":1487709779,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 14:\n\n(3 comments)\n\nLooks good; some additional comments."},{"timestamp":1487712631,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 15."},{"timestamp":1487712738,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 15:\n\nI dug through the mysql src and updated the big theory comment with some info about mysql. It always uses a context size of 256. I would be ok increasing MAX_ALLOC_ON_STACK to 256 for the submit path since that is only 2k on the stack, but it would use 6k on the stack in the getevents path and that makes me nervous, so I left things at 128 for now."},{"timestamp":1487713428,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 15:\n\nI miscalculated the getevents size. It is currently 4k on the stack and would go to 8k with a getevents of 256. After discussion with Patrick I will just pull that alloca out for now."},{"timestamp":1487714255,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 16."},{"timestamp":1487791860,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 16: Code-Review+1"},{"timestamp":1487795977,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 16:\n\n(4 comments)\n\nSorry to be so nitty about this -- but I think it\u0027s a subtle issue and want to make sure that it\u0027s clear from the code what\u0027s happening.  Almost there! ;)"},{"timestamp":1487796940,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 17."},{"timestamp":1487798145,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 17:\n\n(1 comment)"},{"timestamp":1487799856,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 17: Code-Review+1\n\nLooks great -- thank you!"},{"timestamp":1487799904,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 17: Code-Review+1"},{"timestamp":1487801126,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 17: Integration-Approval+1"},{"timestamp":1487801313,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 18: Patch Set 17 was rebased."},{"timestamp":1487801572,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 19: Commit message was updated."},{"timestamp":1487802070,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"19","revision":"dda1f9a81f5e81013b6df1dd838f8a23774ed0b5","parents":["f8fc8f4b458c9b816775f6a3e1673719a05bf84c"],"ref":"refs/changes/67/1367/19","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1487801572,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487799856,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487799904,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487801126,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1487802070,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":95,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":1127,"deletions":-17},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":30,"deletions":-10},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/fs/proc/prsubr.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1352,"sizeDeletions":-811},"patchSets":[{"number":"1","revision":"723ed0752b98b53a8e7697e02b94e6f3f31a81b9","parents":["c6f48adc748c5507279a550ec38b3545c1e8a07b"],"ref":"refs/changes/67/1367/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1485561563,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":37,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":910,"deletions":-16},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1021,"sizeDeletions":-785},{"number":"2","revision":"814df1a87c05d82dfde22dd0eae8e5d10b2394a3","parents":["c6f48adc748c5507279a550ec38b3545c1e8a07b"],"ref":"refs/changes/67/1367/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1485625022,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":36,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"s/\u0026/and/"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":36,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":44,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Perhaps qualify this as \"general approach here\"?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":44,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":62,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"s/lwp\u0027s/LWPs/"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":62,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":64,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"LWPs"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":64,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":82,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I would omit the graph."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":82,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":115,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Assuming these are derived from Linux constants, I would include a comment stating so (to differentiate them from our own internal constants)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":179,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I seem to recall the native read/write functions having some subtle differences when compared to the expected LX behavior.  It may be relevant only to an LWP doing real syscall work vs a worker thread, but it\u0027s still worth investigating.  Exposing and using the lx_read_common/lx_write_common functions might be an easier path forward there?  (Especially if we cache a file_t* for CBs rather than an FD)  If we choose to implement the readv/writev versions, the shared code for handling LX iovec copyin would also come in handy there."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":179,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"If I change the code in response to some of the other comments then yes, it would make sense to use that utility function too."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":263,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"While the use of cv_signal() is a nice way to avoid a potential thundering herd when notifying io_event waiters, I think there\u0027s a potential for an ugly undue-wait condition here.  Say several threads are doing an io_getevents on a given context, some of which using a high min_nr.  If we cv_signal() to wake only one of them, it may be a thread which has a higher min_nr that the others.  In this case, while another thread may have been satisfied by the number of completed events in the list, it will not be woken.\n\nIn the applications you\u0027ve examined while developing this, are multiple waiters common?  It might be that cv_broadcast() is cheap for this specific case."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":263,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"From what I have seen, apps will use different contexts to support different threads which are waiting. However, my experience is limited. Since Linux makes no claims about multiple waiters on the same context, I think the only time a real app would do that in any sensible way is with all of them having the same min_nr and it being 0 or 1. I don\u0027t see a good reason to change the current behavior here."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":415,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"While I agree with Bryan/rm that these threads should not be hidden from the native system, I think we should consider masking them from lx_proc.  I suspect their visibility there would be a surprise from a Linux compatibility standpoint.  \n\nSomething like a flag in the lwp brand data might achieve that conveniently?  It would also give us an easy method to filter in/out threads which are part of AIO contexts.\n\nAlso on that topic, would it make sense to store lwp_t/kthread_t references to the contained threads in the aio context?  It might be nice to have that to sort through worker threads rather than needing to consult their stacks."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":415,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I can add a tag to the lwp data and filter that out in procfs. I don\u0027t think we need a separate list, especially if we have a tag which we can see in debugging."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":416,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Is it advisable to ignore a possible failure here?  Even if it\u0027s possible with current code paths, it might be worth defending against the condition should later changes alter the LWP creation process."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":416,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":453,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I would consider abstracting this patterin into some sort of lx_io_ctx_hold() function which handled all the checking.  Then it wouldn\u0027t need to be repeated in each of the io_ syscalls.  (And perhaps define an lx_io_ctx_rele() as well, to take care of the atomic_dec_32() ?)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":453,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":492,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Checking only the first CB doesn\u0027t seem to match how Linux accomplishes this task."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":492,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I know this doesn\u0027t match Linux exactly. Since we can always get an error when the operation is performed, we still have to handle errors there, so I was trying to avoid the overhead of copying in each CB at submit time. However, if you think we should match Linux exactly here, I can add that. At that point I agree that we would use the file_t * and change the worker code to use our internal helper function instead of the regular pread/pwrite code."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":508,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Since adding this is much more doable in an IKE context, it would be nice to get a follow-up ticket open so we don\u0027t forget about it."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":508,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I will do that"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":550,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Looking at how Linux implements io_submit, it appears to grab file holds on all FDs submitted in the CBs.  It would probably make sense to store a file_t reference in the record which we\u0027re placing on the pending work queue to match this behavior.\n\n(This is even more relevant when considering the earlier comment about iterating through all CBs when performing a submit)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":550,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"this is related to my earlier response"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":567,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Contrary to the possible problem with cv_signal() and io_getevents, this looks like a great case to prevent contention when waking a worker thread."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":578,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It appears that on Linux, if some number of the CBs are successfully submitted, it will those rather than an error."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":578,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"currently only the first one can error but if I change the code to copyin all of the control blocks, then yes, this will have to change too"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":860,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"If context locking is refactored into hold/rele functions, we could perhaps add a cv to wake the destroying thread when the last reference holder is on its way out."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":860,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I have made a bug fix which is related to this code so that approach is not exactly applicable"},{"file":"usr/src/uts/common/os/lwp.c","line":1733,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I like the addition of this hook.  Perhaps consider naming it simply b_exitlwps?"},{"file":"usr/src/uts/common/os/lwp.c","line":1733,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":37,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":914,"deletions":-16},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1025,"sizeDeletions":-785},{"number":"3","revision":"d692b3d2a1f37ec32331848d8ef2ee81433239c3","parents":["c6f48adc748c5507279a550ec38b3545c1e8a07b"],"ref":"refs/changes/67/1367/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1485991933,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":88,"deletions":-10},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":10,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":1094,"deletions":-17},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1261,"sizeDeletions":-798},{"number":"4","revision":"a7129e91b1e8ecd012977cd1195ccc653ff4fc5a","parents":["c6f48adc748c5507279a550ec38b3545c1e8a07b"],"ref":"refs/changes/67/1367/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1486043737,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":88,"deletions":-10},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":10,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":951,"deletions":-17},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1120,"sizeDeletions":-798},{"number":"5","revision":"bfd2eb3029cedc2bfdc504f2ce6f1a24cde045cf","parents":["c6f48adc748c5507279a550ec38b3545c1e8a07b"],"ref":"refs/changes/67/1367/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1486056057,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":177,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I would make this a function, even though it\u0027s only one line.  (Makes it easier for tracing, among other things)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":364,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"With the added protection around lwp_create() errors, I would nix this comment."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":383,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Exposing the io context to the rest of the system before the setup below has completed makes me a little nervous.  While we haven\u0027t communicated the cid out to userspace, a malicious actor could choose to make syscalls against a cid which they predict is undergoing this setup.\n\nWould it maybe make sense to make the state tracking (lxioctx_shutdown) a little richer and support a few different conditions where it\u0027s inaccessible to threads attempting a _hold()?  Something like lxioctx_state could be set to LXIOCTX_INIT while the threads are still being spun up, to be updated to something like LXIOCTX_RUN once it\u0027s ready. (And LXIOCTX_SHUTDOWN when it\u0027s being cleaned up.)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":383,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":576,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Have you checked if the FSYNC/FDSYNC operations toss EINVAL for directories?  Looking at the source, it looks like they might be allowed."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":576,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":593,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Jerry and I chatted about this a little bit.  I suggested that we perhaps maintain the getf() hold, calling clear_active_fd() to keep this thread state appropriately synced.  By making set_active_fd() visible like it\u0027s counterpart, the worker thread which later acts upon the fd/file_t could bring its own active_fd state into compliance before issuing the releasef()."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":864,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"If we make the context state tracking more expressive (as discussed above) this could potentially be simplified.  Attempting to shutdown a context that is already in its shutting-down state could result in an immediate return, rather than several threads waiting on the same resource."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":88,"deletions":-10},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":10,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":954,"deletions":-17},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1123,"sizeDeletions":-798},{"number":"6","revision":"46bda81492698661707669bbd53486fe8d5abe7f","parents":["c6f48adc748c5507279a550ec38b3545c1e8a07b"],"ref":"refs/changes/67/1367/6","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1486158395,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":115,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Now that the mapping for dereferencing the context_id constraints this size, we should include a note about it. (In case someone went and jacked this up beyond a page worth of ctx_ids)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":115,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":476,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Might be nice to wrap these conversions (both cid-\u003eaddr and addr-\u003ecid) into macros"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":476,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":550,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Since we may have failed on the nth lwp_create, I think \u0027single\u0027 is potentially dishonest here."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":550,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"The comment is correct since the conditional is only for the first thread."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":557,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Other code modifies this value in a non-atomic fashion.  They should be made consistent so there isn\u0027t a possibility of a race."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":557,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":977,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Wouldn\u0027t it make sense to pull the context out of the process-wide array so it is no longer reachable via lx_io_cp_hold?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":977,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"this is done in the rele code path and asserted there"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":985,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Since it looks like all of the lxioctx_in_use values are going to be protected by the process-wide io_ctx_lock, why not include some cv in the lx_proc_data struct by which a cv_wait can be done in the loop below?  Then lx_io_cp_rele could choose to ping the cv on its way out and the manual delay logic wouldn\u0027t be necessary."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":985,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done. this will mean a wakeup for each worker thread that exits, but in the end is probably still be faster"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":1010,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Shouldn\u0027t it be unmapped, too?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":1010,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I don\u0027t see any reason. Most processes will exec and this will be unmapped at that time. If the process does not exec, then there is simply a single shared read-only page still in its address space, but no additional anonymous memory is being consumed."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":88,"deletions":-10},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":1038,"deletions":-17},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1208,"sizeDeletions":-798},{"number":"7","revision":"818ff2f54d3b94b3aaab711274cf3e4b6d78cea8","parents":["1b4b813ed495a619f8cfe67a9dd3105c38ffe3ce"],"ref":"refs/changes/67/1367/7","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1486388895,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":87,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":1040,"deletions":-17},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1210,"sizeDeletions":-797},{"number":"8","revision":"2c4a7c568683c82e5f8be9c83e37ff3ab240ed07","parents":["fee98a3b8f015b17a4769a5be463eb01425da23a"],"ref":"refs/changes/67/1367/8","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1486492107,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":283,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Release FD holds?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":283,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Yes, I had actually caught that and fixed it after uploaded the last CR."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":377,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I would suggest doing this as part of the lwp_create() loop.  The LWPs could be created as TS_STOPPED rather than TS_RUN.  Once the proper TP_KTHREAD bit had been set, then lwp_create_done() could be used to set it running.  This eliminates the small window where the LWP could be more easily chosen via prchoose().\n\n(Suspended threads are lowest in the priority list, so until it\u0027s started running, the thread making the syscall will take precedence.)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":377,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I will explore that."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":946,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"If we\u0027re still holding the FD for this operation, don\u0027t we need to releasef() it?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":946,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Yes, I had missed this one, I will fix it."},{"file":"usr/src/uts/common/sys/thread.h","line":404,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Something like \"in-kernel worker thread for process\" might be more descriptive.  I\u0027m not sure if it fits on the line."},{"file":"usr/src/uts/common/sys/thread.h","line":404,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I\u0027ll try some different wording that still fits"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":87,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":1041,"deletions":-14},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":30,"deletions":-10},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/fs/proc/prsubr.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1248,"sizeDeletions":-806},{"number":"9","revision":"4549b18a65f8d079240e3ba514e251d13ce0f119","parents":["fee98a3b8f015b17a4769a5be463eb01425da23a"],"ref":"refs/changes/67/1367/9","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1486507788,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":1036,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I\u0027m not thrilled that we\u0027re leaving this mapped, even though a forked process is likely to immediately exec and get a fresh AS anyways.  One argument for this existing approach is that the context of this function call during getproc() is not conducive to clearly performing the unmap.\n\nFor now, how about a comment about how the page will be leaked into the AS should the child avoid exec()? (Especially bad if it goes on to perform some AIO of its own.)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":87,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":1059,"deletions":-17},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":30,"deletions":-10},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/fs/proc/prsubr.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1266,"sizeDeletions":-809},{"number":"10","revision":"522acf8b3b815e73cdd2dbc774353208e32e244d","parents":["fee98a3b8f015b17a4769a5be463eb01425da23a"],"ref":"refs/changes/67/1367/10","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1486511595,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","line":1016,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This should be cleaned up out of lib/brand/lx/lx_brand/sys/lx_syscall.h too."},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","line":5428,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Should we be removing this short-circuit?"},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","line":5428,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"yes, the new lxpr_count_tasks function has that check now."},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","line":5860,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It looks like there might be a small window for us to race with an lwp_exit() call.  If the thread under examination were to call lwp_exit() and progress right to the point where it drops p_lock in order to do the un-branding, we could then acquire the PR_LOCK and locate the thread in the mean time.  By the time we arrive to this verification, the lwp may no longer possess brand data.\n\nI\u0027m not sure if this is something we need to investigate more broadly, but at least in this specific case, it appears to be a risk."},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","line":5860,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I will investigate this"},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","line":5860,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I believe I have a fix for this which addresses the potential race. It looks like this is a pre-existing issue in at least a couple of places in lx proc but I have not attempted to fix those other issues."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":190,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"These should probably receive a file attribution like their colleagues below."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":190,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"added"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":351,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Maybe use straight panic()?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":351,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"this seems fine as-is since we already validated all of the ops"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":415,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"If we\u0027re already adequately limited by AIO_MAX_NR, why not keep it unsigned?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":415,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"changed"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":479,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I would be inclined to move this inside the preceding \u0027else\u0027 block, since it applies only to that case."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":479,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"moved"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":496,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"For the purpose of clarity, it might be nice to separate the variable which is used to identify the chosen context slot from all of the other setup iteration below."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":496,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"changed"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":505,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"There\u0027s nothing potential about the visibility."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":505,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I think the wording is correct, since no thread will have obtained a context ID for this context yet, so only a malicious thread could find this context."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":657,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It\u0027s possible that between this check and the real list insertion below, that the free_cnt drops to zero, resulting in no IOs being successfully queued.  This error should probably be implemented as a check after the below for-loop, verifying that at least one IO was successfully submitted."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":657,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I will add that check."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":659,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"While \u0027nr\u0027 is implicitly bounded to a reasonable value, the comparison of an \u0027int\u0027 against a \u0027long\u0027 makes me a little uneasy."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":685,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Yet!"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":725,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Did you test VCHR as well?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":725,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I will write a test for that."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":725,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I confirmed that VCHR is accepted on Linux and fixed this."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":725,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"After further testing I\u0027ve found that the situation on Linux is more complex and I will need to do more work to handle this."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":877,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Is dropping the lock here safe if we\u0027re attempting to fulfill a request for min_nr events?  It might be prudent to have an on-stack list head into which we dequeued all the to-be-emitted IOs.  Should some fail to copyout, we could insert them back onto the done list."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":877,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I will try to determine how Linux handles a fault on copyout but I suspect that if an app is passing us a short buffer than this will be the least of their problems."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":877,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"My primary concern is about two simultaneous io_getevents calls coming both coming up short on the number of results they return, relative to min_nr.\n\nFrom what I can tell from the Linux source, if EFAULT is encountered during an io_getevents, the results for the completed IOs are not \"consumed\" by the operation, but are still available to fetch from the context with a proper io_getevents() call."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":877,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Right now this doesn\u0027t seem to be worth spending time on since the application is already broken, no matter how many threads are involved. I\u0027d rather focus on closing our gaps where applications are using functionality we\u0027re missing. As an aside, the apps I have seen (mysql and scylla) never have multiple threads accessing the same context. They always do this per-thread (although that has nothing to do with an app being broken). However, I\u0027ll obviously change this if it is needed to get approval."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":877,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This sounds like an acceptable compromise for now.  We can circle back to cases like this later, if needed."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":884,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Same minor concern over \u0027int\u0027 vs \u0027long\u0027"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":920,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"If Linux is emitting some number of events less than \u0027nr\u0027, does it copyout() zeroed entries up to \u0027nr\u0027?  If not, we would want to constrain this to \u0027i\u0027."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":920,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"changed"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":946,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"We should look to gather some data about how often io_cancel is used by real workloads.  If it\u0027s frequent at all, this O(N) loop might be a problem.  (If it\u0027s rare, then this is probably fine.)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":946,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I have seen no usage from mysql or scylla"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":989,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Perhaps add a VERIFY that lxioctx_maxn \u003c\u003d lxzd_aio_nr?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":989,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/sys/brand.h","line":203,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Please add this to the comment above."},{"file":"usr/src/uts/common/sys/brand.h","line":203,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":87,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":1065,"deletions":-17},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":30,"deletions":-10},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/fs/proc/prsubr.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1272,"sizeDeletions":-809},{"number":"11","revision":"1142031604c93087270ea55042f7321226fda4e3","parents":["a9a5731324812252a67cf8da58a97d8818f69ebb"],"ref":"refs/changes/67/1367/11","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1486598154,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":95,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":1075,"deletions":-17},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":30,"deletions":-10},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/fs/proc/prsubr.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1300,"sizeDeletions":-811},{"number":"12","revision":"51a3d0c1c613e2810692828e77032404863af8bf","parents":["a9a5731324812252a67cf8da58a97d8818f69ebb"],"ref":"refs/changes/67/1367/12","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1486645240,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":95,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":1076,"deletions":-17},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":30,"deletions":-10},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/fs/proc/prsubr.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1301,"sizeDeletions":-811},{"number":"13","revision":"f16a0dab62edc5871164ca04ce01a2cf9d5eb389","parents":["a9a5731324812252a67cf8da58a97d8818f69ebb"],"ref":"refs/changes/67/1367/13","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1486657185,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":31,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"This sounds terrible! I would be curious about more detail here -- what is it hoping to do with this memory?!"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":31,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I assumes that there is a kernel data structure visible at that address that it can use for \"optimization\". Since our page is always 0, we are always ok. I can post a gist of the code next scrum for your entertainment. :-)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":37,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Total nit, but should be \"that\" (it\u0027s a restrictive clause)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":41,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Nit: should be \"in the I/O paths\" or \"during I/O\" (but the former is much better). Also, might this be more accurately expressed as \"in the paths that enqueue I/O\"?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":46,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Nit: Should be \"that\""},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":49,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"I think this paragraph should move; see notes for L69-L78, below."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":52,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Should be \"that\""},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":70,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Should be \"that\" ;)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":71,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Nit: \"LWP\u0027s\" (or \"LWPs\" -- but should be caps to stay consistent with L69"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":79,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"I think that the block comment that currently starts at L45 should be here part of this paragraph."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":146,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Use tab stops to align the comments for the members, and add a comment for each member."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":292,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Stylistic nit, but for each of these loops, I would pull the assignment in the \"while\" condition (e.g. \"while ((ep \u003d list_remove_head(\u0026cp-\u003elxioctx_free)) !\u003d NULL) {\" for the first one).  This makes the code slightly more concise in my mind, but use your own judgement/style."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":360,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"How does this not hit the assertion in clear_active_fd() as called by releasef()?  While this fd is held, it\u0027s not active for the worker, so it seems that the assertion will be tripped.  Am I missing something here?  (If you haven\u0027t been doing it, may be worth running all tests with a DEBUG kernel.)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":360,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I do run this with DEBUG. What happens is that we call clear_active_fd in the submit path so we can return from the syscall without doing a releasef. Once this thread takes over the fd, it calls set_active_fd above at line 317 so that we then own it and can releasef() it when we\u0027re done."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":376,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Can we safely look at this without holding lxioctx_p_lock?  Given that we grab it on the next line, should that be hoisted out of the loop?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":376,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"All we ever do for this value in the context is set the value one time when the context is shutting down, so I think it is safe to look at without holding the lock"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":398,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Same question here: is it safe to look at this without the lock held?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":454,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"I think this should be a VERIFY -- this is not a hot path, and the consequences of this not being true could be dire."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":454,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"will do"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":628,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Is the nr \u003d\u003d 0 case defined to check the validity of cid?  If so, please comment -- if not, do this check before the lx_io_cp_hold() and eliminate the lx_io_cp_rele() in the error path?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":628,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"This is the order we need to pass LTP"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":638,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Two questions: why a KM_NOSLEEP here?  And should this be an alloca() for small values of nr?  (That seems to be the common case.) Though perhaps the performance win from that is too small to measure..."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":638,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I was doing a NOSLEEP here since I wanted to keep the submit path as fast as possible and not incur the sleep. EAGAIN is the normal return if we don\u0027t have the resources to queue anything right away. I will go ahead and change the code to use alloca for for small submissions."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":729,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"No caps"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":753,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Should be \"preceding\""},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":868,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Same question here: why is this a KM_SLEEP when the submit code path is KM_NOSLEEP?  And should this be an alloca() for small values of nr?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":868,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Since getevents can normally block until the results are available, KM_SLEEP seems ok here vs. the submit path which I wanted to ensure doesn\u0027t block."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":872,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"It seems like the min_nr of 0 case is a hotpath for ScyllaDB; worth pruning that code path to e.g. not grab and drop the lock unnecessarily?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":872,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"will do"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":1065,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Should be \"its\""}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":95,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":1095,"deletions":-17},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":30,"deletions":-10},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/fs/proc/prsubr.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1320,"sizeDeletions":-811},{"number":"14","revision":"1652fb6bf3e9e91e87a481b5bc26ffcf095c2444","parents":["384c07167202f048489a38c1fd2a2f8ac5a082bd"],"ref":"refs/changes/67/1367/14","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1487691056,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":381,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"I would like a longer comment here -- the comment in getf() doesn\u0027t totally cover it.  So perhaps a longer comment here explaining what we\u0027re doing that can be referred to elsewhere..."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":625,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Given all of the sizing logic which depends on this, would it be unreasonable to define it \u0027const\u0027?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":625,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"It is not a const on Linux but I don\u0027t see any reason we couldn\u0027t do that here. I could also use a const variable for \"nr * sizeof (uintptr_t)\" instead of having that appear in several places."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":647,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Given that we\u0027re immediately copyin()ing over this, a zeroed alloc seems unnecessary."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":654,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Is there an accepted convention about when to use alloca() for small bounded on-stack allocations vs a statically defined array? (e.g., recvmsg() in uts/common/fs/sockfs/socksyscalls.c using IOV_MAX_STACK)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":654,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I am not aware of any convention, although the local declaration of a fixed size array will burn stack space even when it is unused, so it seems less desirable. Obviously wasting that stack space is ok or it wouldn\u0027t be valid for the cases when it is used, but it still seems slightly off to me. However, there is also really no other usage of alloca in the kernel that I could find, so maybe that is a bad approach."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":654,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"I can go either way on this. I think we would assume that in most cases, nr would be less than MAX_CBP_ON_STACK, and that there would be no additional stack space consumed.  When this isn\u0027t the case, the additional stack space is essentially free -- greatest effect might be increasing the risk of D-cache displacement flushes, which is definitely down in the weeds."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":883,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"What kind of \u0027nr\u0027 values did you see coming from Scylla during normal operation?  If its requests are relatively small, this might be another case where on-stack buffers save us a little time for small values of \u0027nr\u0027."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":883,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"scylla sets up a context with a max of 128 and it issues getevents calls with a range of 1-128. I could do an alloca on the stack for up to 128 which would burn 3k of stack space, but since this function doesn\u0027t do anything deep on the stack, its probably ok."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":890,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Okay, I confess this goto isn\u0027t sitting right. ;)  Could we instead brace and indent the code between L891 and L918?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":95,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":1115,"deletions":-17},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":30,"deletions":-10},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/fs/proc/prsubr.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1340,"sizeDeletions":-811},{"number":"15","revision":"2f95404a9b7eb19cdee5dc4f5f4de80c6e97cbae","parents":["384c07167202f048489a38c1fd2a2f8ac5a082bd"],"ref":"refs/changes/67/1367/15","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1487712631,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":95,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":1133,"deletions":-17},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":30,"deletions":-10},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/fs/proc/prsubr.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1358,"sizeDeletions":-811},{"number":"16","revision":"a7bff8d6e120c80a4bb21e49ab148f3268dfb244","parents":["384c07167202f048489a38c1fd2a2f8ac5a082bd"],"ref":"refs/changes/67/1367/16","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1487714255,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487791860,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":74,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"I think this comment should be in-line at the first call of set_active_fd(-1), and then the second call to set_active_fd(-1) can refer t the comment in the first."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":79,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Should be \"that\" ;)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":299,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"I think the comment from the Big Theory Statement should be here instead; see previous comment."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":392,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"This comment can then refer the reader to the larger comment in lx_io_cp_rele()"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":95,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":1125,"deletions":-17},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":30,"deletions":-10},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/fs/proc/prsubr.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1350,"sizeDeletions":-811},{"number":"17","revision":"e47669aa70e466087323076dc18b9584ddea5c79","parents":["384c07167202f048489a38c1fd2a2f8ac5a082bd"],"ref":"refs/changes/67/1367/17","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1487796940,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487799856,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487799904,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487801126,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":295,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"s/syscall/io_submit()/ maybe?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":95,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":1127,"deletions":-17},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":30,"deletions":-10},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/fs/proc/prsubr.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1352,"sizeDeletions":-811},{"number":"18","revision":"21de5cec1779a7da49c4e4b06f9cb3e58a293baa","parents":["f8fc8f4b458c9b816775f6a3e1673719a05bf84c"],"ref":"refs/changes/67/1367/18","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1487801313,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487799856,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487799904,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487801126,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":95,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":1127,"deletions":-17},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":30,"deletions":-10},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/fs/proc/prsubr.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1352,"sizeDeletions":-811},{"number":"19","revision":"dda1f9a81f5e81013b6df1dd838f8a23774ed0b5","parents":["f8fc8f4b458c9b816775f6a3e1673719a05bf84c"],"ref":"refs/changes/67/1367/19","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1487801572,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487799856,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}},{"type":"SUBM","value":"1","grantedOn":1487802070,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487799904,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487801126,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/brand/lx/lx_brand/common/aio.c","type":"DELETED","insertions":0,"deletions":-612},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_aio.h","type":"DELETED","insertions":0,"deletions":-80},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_proc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":95,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":1127,"deletions":-17},{"file":"usr/src/uts/common/brand/lx/syscall/lx_close.c","type":"MODIFIED","insertions":2,"deletions":-29},{"file":"usr/src/uts/common/brand/lx/syscall/lx_rw.c","type":"MODIFIED","insertions":30,"deletions":-10},{"file":"usr/src/uts/common/brand/sn1/sn1_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/brand/solaris10/s10_brand.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/fs/proc/prsubr.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/lwp.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/brand.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/thread.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":1352,"sizeDeletions":-811}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}