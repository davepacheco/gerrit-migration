From 491322e3c9eac69f73d04ff5089c28e96d1b74db Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Fri, 7 Oct 2016 14:01:34 +0000
Subject: [PATCH] OS-5702 NFS mount differences when nfs-common pkg is not
 installed

---
 usr/src/lib/brand/lx/lx_brand/common/mount.c | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/usr/src/lib/brand/lx/lx_brand/common/mount.c b/usr/src/lib/brand/lx/lx_brand/common/mount.c
index d06379555a..fda4b12927 100644
--- a/usr/src/lib/brand/lx/lx_brand/common/mount.c
+++ b/usr/src/lib/brand/lx/lx_brand/common/mount.c
@@ -381,6 +381,7 @@ lx_mount(uintptr_t p1, uintptr_t p2, uintptr_t p3, uintptr_t p4,
 	char			*sdataptr = NULL;
 	int			sdatalen = 0;
 	int			vers;
+	struct stat		sb;
 
 	/* Initialize illumos mount arguments. */
 	sflags = MS_OPTIONSTR;
@@ -400,6 +401,19 @@ lx_mount(uintptr_t p1, uintptr_t p2, uintptr_t p3, uintptr_t p4,
 	if ((rv == -1) || (rv == sizeof (fstype)))
 		return (-EFAULT);
 
+	/*
+	 * This test causes us to match the behavior on Linux. If the package
+	 * which delivers NFS support (e.g. nfs-common on Ubuntu, nfs-utils on
+	 * Centos, etc.) is not installed, then the kernel will return EINVAL
+	 * when an NFS mount is attempted. We reproduce the checks from the
+	 * generic mount command, checking for the mount.nfs helper command,
+	 * to emulate this behavior.
+	 */
+	if (stat("/sbin/mount.nfs", &sb) == -1 &&
+	    stat("/sbin/fs.d/mount.nfs", &sb) == -1 &&
+	    stat("/sbin/fs/mount.nfs", &sb) == -1)
+		return (-EINVAL);
+
 	lx_debug("\tlinux mount source: %s", source);
 	lx_debug("\tlinux mount target: %s", target);
 	lx_debug("\tlinux mount fstype: %s", fstype);
-- 
2.21.0

