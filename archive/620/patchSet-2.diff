From 776ecf6d97622ba126ad6f708fadfd72ef42be3f Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Fri, 7 Oct 2016 15:53:35 +0000
Subject: [PATCH] OS-5702 NFS mount differences when nfs-common pkg is not
 installed

---
 usr/src/lib/brand/lx/lx_brand/common/mount_nfs.c | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/usr/src/lib/brand/lx/lx_brand/common/mount_nfs.c b/usr/src/lib/brand/lx/lx_brand/common/mount_nfs.c
index 7c5826b4b5..f93caf65ed 100644
--- a/usr/src/lib/brand/lx/lx_brand/common/mount_nfs.c
+++ b/usr/src/lib/brand/lx/lx_brand/common/mount_nfs.c
@@ -2269,6 +2269,7 @@ convert_nfs_arg_str(char *srcp, char *mntopts)
 	char tmpbuf[MAX_MNTOPT_STR];
 	char *tbp = tmpbuf;
 	boolean_t no_sec = B_TRUE;
+	boolean_t no_addr = B_TRUE;
 
 	(void) strlcpy(tmpbuf, mntopts, sizeof (tmpbuf));
 	*mntopts = '\0';
@@ -2298,6 +2299,8 @@ convert_nfs_arg_str(char *srcp, char *mntopts)
 				(void) snprintf(srcp,
 				    MAXPATHLEN + LX_NMD_MAXHOSTNAMELEN + 1,
 				    "%s:%s", val, pp);
+
+				no_addr = B_FALSE;
 			} else if (strcmp(key, "clientaddr") == 0) {
 				/*
 				 * Ignore, this is an artifact of the
@@ -2339,6 +2342,17 @@ convert_nfs_arg_str(char *srcp, char *mntopts)
 		}
 	}
 
+	if (no_addr) {
+		/*
+		 * This test causes us to match the behavior on Linux. If the
+		 * package which delivers NFS support (e.g. nfs-common on
+		 * Ubuntu, nfs-utils on  Centos, etc.) is not installed, then
+		 * the generic mount command will not implicitly pass in the
+		 * 'addr' option and the kernel will return EINVAL.
+		 */
+		return (-EINVAL);
+	}
+
 	if (no_sec) {
 		/*
 		 * XXX Temporarily work around missing DES auth by defaulting
-- 
2.21.0

