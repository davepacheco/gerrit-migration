{"project":"joyent/illumos-joyent","branch":"master","id":"Ia5234b87b6c7541ff952fa658e22fd1f78e36a12","number":"6919","subject":"OS-7991 port_get() and port_getn() implementation disagrees with documentation","owner":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"url":"https://cr.joyent.us/6919","commitMessage":"OS-7991 port_get() and port_getn() implementation disagrees with documentation\n","createdOn":1568823832,"lastUpdated":1569947455,"open":true,"status":"NEW","comments":[{"timestamp":1568823832,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 1."},{"timestamp":1568824064,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 2."},{"timestamp":1568900372,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(3 comments)\n\nThis looks good aside from the copyright nits."},{"timestamp":1568903507,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1568903555,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 3."},{"timestamp":1568903611,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1568986578,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1569253374,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 4."},{"timestamp":1569281217,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4: Code-Review+1\n\nEven though I gave +1, I\u0027m curious to hear if you have an answer for John\u0027s question?"},{"timestamp":1569500950,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1569512807,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4:\n\nThanks for the explanation. It seems reasonable not to try to touch port_getn(), it\u0027s certainly written in a pretty obtuse way. Do you mind adding a comment though with your analysis (and why it\u0027s different to the n \u003e 1 case?)"},{"timestamp":1569942486,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 5."},{"timestamp":1569947400,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 5: Code-Review+1\n\nThanks"},{"timestamp":1569947455,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5: Code-Review+1"}],"currentPatchSet":{"number":"5","revision":"a5234b87b6c7541ff952fa658e22fd1f78e36a12","parents":["1cc204b97b9317e681958da0e91abeb27bcc6f82"],"ref":"refs/changes/19/6919/5","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1569942486,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569947400,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569947455,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/head/port.h","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"usr/src/lib/libc/port/gen/event_port.c","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/uts/common/fs/portfs/port.c","type":"MODIFIED","insertions":15,"deletions":-1}],"sizeInsertions":26,"sizeDeletions":-7},"patchSets":[{"number":"1","revision":"ec9d3b52038c046a283c4b01eabeb3d58e696e99","parents":["1cc204b97b9317e681958da0e91abeb27bcc6f82"],"ref":"refs/changes/19/6919/1","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1568823832,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/head/port.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/lib/libc/port/gen/event_port.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/fs/portfs/port.c","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":8,"sizeDeletions":-4},{"number":"2","revision":"ee4c1b58d19a53cddd41e8446bb7a5dd65c67f19","parents":["1cc204b97b9317e681958da0e91abeb27bcc6f82"],"ref":"refs/changes/19/6919/2","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1568824064,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/head/port.h","line":27,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"This isn\u0027t the current copyright style. We should drop the (c) and comma after the year."},{"file":"usr/src/head/port.h","line":27,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/lib/libc/port/gen/event_port.c","line":27,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"same problem here"},{"file":"usr/src/lib/libc/port/gen/event_port.c","line":27,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/common/fs/portfs/port.c","line":28,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"and here"},{"file":"usr/src/uts/common/fs/portfs/port.c","line":28,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done. Shall I also remove the \"All rights reserved.\", or is that still ok?"},{"file":"usr/src/uts/common/fs/portfs/port.c","line":618,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I\u0027m trying to follow this condition and why it differs from the nget \u003e 1 case. Is it that near the end of port_getn(), when we do port_get_timer() again, that resets the ETIME return back to 0 ?\n\nI\u0027m sure this is correct, it just seems weird that port_getn(nget \u003d\u003d 1) doesn\u0027t itself return with ETIME when the timer times out."},{"file":"usr/src/uts/common/fs/portfs/port.c","line":618,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"The cases that I have observed skip setting the error in port_getn():\n- an event is immediately available, and the code proceeds to portnowait.  Then we cannot copy out the event because the callback fails and return it to the queue, but we still return no error.\n- an all-zero timespec indicates that the code shouldn\u0027t block, so it also proceeds to portnowait. If no events are available we just return with no error.\n\nThis does also happen for nget \u003e 1, but since in that case the user called port_getn(3C) he is supposed to check nget anyway and no problem exists.\n\nI thought about changing the logic in port_getn() to set errno earlier, but I\u0027d prefer not to as I find the logic a bit convoluted and don\u0027t want to accidentally change its behavior. As this really only affects port_get(3C), fixing it here seems more appropriate."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/head/port.h","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"usr/src/lib/libc/port/gen/event_port.c","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/uts/common/fs/portfs/port.c","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":15,"sizeDeletions":-7},{"number":"3","revision":"f6843c8ba58291464657ce0151a9cf9f03016839","parents":["1cc204b97b9317e681958da0e91abeb27bcc6f82"],"ref":"refs/changes/19/6919/3","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1568903555,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/fs/portfs/port.c","line":28,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Sorry, yes, \"all rights reserved\" is no longer part of our standard copyright."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/head/port.h","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"usr/src/lib/libc/port/gen/event_port.c","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/uts/common/fs/portfs/port.c","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":15,"sizeDeletions":-7},{"number":"4","revision":"e8ca64c9181e83f77a26f216e68e0ad8407a94c0","parents":["1cc204b97b9317e681958da0e91abeb27bcc6f82"],"ref":"refs/changes/19/6919/4","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1569253374,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569281217,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/head/port.h","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"usr/src/lib/libc/port/gen/event_port.c","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/uts/common/fs/portfs/port.c","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":15,"sizeDeletions":-7},{"number":"5","revision":"a5234b87b6c7541ff952fa658e22fd1f78e36a12","parents":["1cc204b97b9317e681958da0e91abeb27bcc6f82"],"ref":"refs/changes/19/6919/5","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1569942486,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569947455,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569947400,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/head/port.h","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"usr/src/lib/libc/port/gen/event_port.c","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/uts/common/fs/portfs/port.c","type":"MODIFIED","insertions":15,"deletions":-1}],"sizeInsertions":26,"sizeDeletions":-7}],"allReviewers":[{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}]}