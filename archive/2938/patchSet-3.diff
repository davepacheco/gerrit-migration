From 6cdc012a7cc5aec297c1af51792b2bda3299c4ec Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Sat, 11 Nov 2017 02:10:06 +0000
Subject: [PATCH] MANTA-3284 want operator-configurable throttle on muskie
 requests

---
 docs/operator-guide.md | 58 ++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 58 insertions(+)

diff --git a/docs/operator-guide.md b/docs/operator-guide.md
index 873be61..3f0ab35 100644
--- a/docs/operator-guide.md
+++ b/docs/operator-guide.md
@@ -348,6 +348,7 @@ handles PUT/GET/DELETE requests to the front door, including requests to:
 * create compute jobs, submit input, end input, fetch inputs, fetch outputs,
   fetch errors, and cancel jobs
 
+
 ### Objects and directories
 
 Requests for objects and directories involve:
@@ -1845,6 +1846,63 @@ account, even though there is only a single set of copies of the objects.
 Metering also rounds up small objects to a minimum object size.
 
 
+## Request Throttling
+
+Manta provides a coarse request throttle intended to be used when the system is
+under extreme load and is sufferring availability problems that cannot be
+isolated to a single Manta component. When the throttle is enabled and muskie
+has reached its configured capacity, the throttle will cause muskie to drop new
+requests and notify clients their requests have been throttled by sending a
+response with HTTP status code 503. The throttle is disabled by default.
+
+The throttle is "coarse" because its capacity is a function of all requests to
+the system, regardless of their originating user, IP address, or API operation.
+Any type of request can be throttled.
+
+The request throttle is implemented on a per-process level, with each "muskie"
+process in a "webapi" zone having its own throttle. The throttle exposes three
+tunables:
+
+| Tunable Name                      | Default Value | Description                           |
+| --------------------------------- | ------------- | ------------------------------------- |
+| `MUSKIE_THROTTLE_ENABLED`         | false         | whether the throttle enabled          |
+| `MUSKIE_THROTTLE_CONCURRENCY`     | 50            | number of allowed concurrent requests |
+| `MUSKIE_THROTTLE_QUEUE_TOLERANCE` | 25            | number of allowed queued requests     |
+
+These tunables can be modified with commands of the following form:
+
+```
+$ sapiadm update $(sdc-sapi /services?name=webapi | json -Ha uuid) \
+	metadata."MUSKIE_THROTTLE_ENABLED"=true
+```
+
+Muskies must be restarted to use the new configuration:
+
+```
+$ manta-oneach -s webapi 'svcadm restart "*muskie-*"'
+```
+
+Requests are throttled when the muskie process has exhausted all slots available
+for concurrent requests and reached its queue threshold.
+
+### Throttle Parameter Trade-offs
+
+In general, higher concurrency values will result in a busier muskie process
+that handles more requests at once. Lower concurrency values will limit the
+number of requests the muskie will handle at once. Lower concurrency values
+should be set to limit the load on Manta.
+
+Higher queue tolerance values will decrease the likelihood of requests being
+rejected when Manta is under high load but may increase the average latency of
+queued requests. This latency increase can be the result of longer queues
+inducing longer delays before dispatch.
+
+Lower queue tolerance values will make requests more likely to be throttled
+quickly under load. Lower queue tolerance values should be used when high
+latency is not acceptable and the application is likely to retry on receipt of
+a 503.
+
+
 # Debugging: general tasks
 
 ## Locating servers
-- 
2.21.0

