From 1fe4c0556071ab50d506b029b828d783772d5cde Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Sat, 11 Nov 2017 02:10:06 +0000
Subject: [PATCH] MANTA-3284 want operator-configurable throttle on muskie
 requests

---
 docs/operator-guide.md | 55 ++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 55 insertions(+)

diff --git a/docs/operator-guide.md b/docs/operator-guide.md
index 873be61..0af1ba7 100644
--- a/docs/operator-guide.md
+++ b/docs/operator-guide.md
@@ -348,6 +348,7 @@ handles PUT/GET/DELETE requests to the front door, including requests to:
 * create compute jobs, submit input, end input, fetch inputs, fetch outputs,
   fetch errors, and cancel jobs
 
+
 ### Objects and directories
 
 Requests for objects and directories involve:
@@ -1845,6 +1846,60 @@ account, even though there is only a single set of copies of the objects.
 Metering also rounds up small objects to a minimum object size.
 
 
+## Throttling
+
+Each "muskie" process in a "webapi" zone is equipped with its own coarse request
+throttle. The throttle treats all requests equally, not distinguishing between
+different operations (reads and writes), or different originating users or IPs.
+The throttle is disabled by default and should be used when Manta is under
+extreme load and availability issues cannot be isolated to a single component.
+
+Muskie throttles requests by sending an HTTP status code 503 to the client.
+
+The coarse request throttle exposes three tunables, which are configurable via
+SAPI. Changes to these tunables will require restarting muskie to take effect.
+The names of the SAPI tunables are:
+
+| Tunable Name                      | Default Value | Description                 |
+| --------------------------------- | ------------- | --------------------------- |
+| `MUSKIE_THROTTLE_ENABLED`         | false         | is the throttle enabled     |
+| `MUSKIE_THROTTLE_CONCURRENCY`     | 50            | allowed concurrent requests |
+| `MUSKIE_THROTTLE_QUEUE_TOLERANCE` | 25            | allowed queued requests     |
+
+These tunables can be modified with commands of the following form:
+
+```
+$ sapiadm update $(sdc-sapi /services?name=webapi | json -Ha uuid) \
+	metadata."MUSKIE_THROTTLE_ENABLED"=true
+```
+
+Changes can be made to take affect with:
+
+```
+$ manta-oneach -s webapi 'svcadm restart "*muskie-*"'
+```
+
+Requests are throttled when the muskie process has exhausted all slots available
+for concurrent requests and reached its queue threshold.
+
+### Throttle Parameter Trade-offs
+
+In general, higher concurrency values will result in a busier muskie that handles
+more requests at once. Lower concurrency values will limit the number of requests
+the muskie will handle at once. Lower concurrency values should be set to limit
+the load on Manta.
+
+Higher queue tolerance values will decrease the likelihood of requests being
+rejected when Manta is under high load but may increase the average latency of
+queued requests. This latency increase can be the result of longer queues
+inducing longer delays before dispatch.
+
+Lower queue tolerance values will make requests more likely to be throttled
+quickly under load. Lower queue tolerance values should be used when high
+latency is not acceptable and the application is likely to retry on receipt of
+a 503 anyway.
+
+
 # Debugging: general tasks
 
 ## Locating servers
-- 
2.21.0

