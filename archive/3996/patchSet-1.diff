From b026ac9afc2e88390f906e88d6235900bd179fcf Mon Sep 17 00:00:00 2001
From: Robert Bogart <robert.bogart@joyent.com>
Date: Wed, 23 May 2018 22:50:08 +0000
Subject: [PATCH] MANTA-3596 binder could export metrics via artedi

---
 lib/zk.js    |  6 +++++-
 main.js      | 44 ++++++++++++++++++++++----------------------
 package.json |  2 +-
 3 files changed, 28 insertions(+), 24 deletions(-)

diff --git a/lib/zk.js b/lib/zk.js
index 52bef67..fd588e0 100644
--- a/lib/zk.js
+++ b/lib/zk.js
@@ -20,13 +20,17 @@ function ZKCache(options) {
         mod_assert.object(options, 'options');
         mod_assert.object(options.log, 'options.log');
         mod_assert.string(options.domain, 'options.domain');
+        mod_assert.object(options.metrics, 'options.metrics');
+
+        this.ca_collector = options.metrics.collector;
 
         this.ca_treeNodes = {};
         this.ca_zk = new mod_zkstream.Client({
                 address: process.env.ZK_HOST || '127.0.0.1',
                 port: 2181,
                 log: options.log,
-                sessionTimeout: 30000
+                sessionTimeout: 30000,
+                collector: this.ca_collector
         });
         this.ca_domain = options.domain;
         this.ca_log = options.log;
diff --git a/main.js b/main.js
index 2124b84..d391934 100644
--- a/main.js
+++ b/main.js
@@ -131,13 +131,34 @@ function safeUnlink(socketPath) {
 
 
 function run(opts) {
+        var metricsManager = createMetricsManager({
+                address: '0.0.0.0',
+                log: LOG,
+                staticLabels: {
+                        datacenter: opts.datacenterName,
+                        instance: opts.instance_uuid,
+                        server: opts.server_uuid,
+                        service: opts.service_name,
+                        port: opts.port
+                },
+                /*
+                 * A recommended convention for deriving the port number to be
+                 * used by the corresponding metrics server is to add 1000 to
+                 * the service port number.
+                 */
+                 port: opts.port + 1000,
+                 restify: restify
+        });
+        metricsManager.listen(function () {});
+
         vasync.pipeline({
                 'arg': {},
                 'funcs': [
                         function initZk(_, subcb) {
                                 _.zkCache = new core.ZKCache({
                                         log: LOG,
-                                        domain: opts.dnsDomain
+                                        domain: opts.dnsDomain,
+                                        metrics: metricsManager
                                 });
                                 subcb();
                         },
@@ -180,27 +201,6 @@ function run(opts) {
                                 setImmediate(subcb);
                         },
                         function initServer(_, subcb) {
-                                var metricsManager = createMetricsManager({
-                                        address: '0.0.0.0',
-                                        log: LOG,
-                                        staticLabels: {
-                                                datacenter: opts.datacenterName,
-                                                instance: opts.instance_uuid,
-                                                server: opts.server_uuid,
-                                                service: opts.service_name,
-                                                port: opts.port
-                                        },
-                                        /*
-                                         * A recommended convention for deriving
-                                         * the port number to be used by the
-                                         * corresponding metrics server is to
-                                         * add 1000 to the service port number.
-                                         */
-                                        port: opts.port + 1000,
-                                        restify: restify
-                                });
-                                metricsManager.listen(function () {});
-
                                 _.server = core.createServer({
                                         name: NAME,
                                         log: LOG,
diff --git a/package.json b/package.json
index 626ea08..5a03060 100644
--- a/package.json
+++ b/package.json
@@ -21,7 +21,7 @@
     "vasync": "2.1.0",
     "verror": "^1.10.0",
     "xtend": "1.0.3",
-    "zkstream": "0.9.0"
+    "zkstream": "http://github.com/joyent/node-zkstream#MANTA-3596-zkstream"
   },
   "engines": {
     "node": ">=0.8"
-- 
2.21.0

