{"project":"joyent/node-docker-registry-client","branch":"master","id":"I14957339caa60faf68d2d756deffd4174d00a441","number":"683","subject":"DOCKER-950 docker pull fails on registry that does not use authentication Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"url":"https://cr.joyent.us/683","commitMessage":"DOCKER-950 docker pull fails on registry that does not use authentication\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1476393154,"lastUpdated":1476732181,"open":false,"status":"MERGED","comments":[{"timestamp":1476393154,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 1."},{"timestamp":1476393206,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476393276,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 1:\n\nThis stops the setting of the authentication header if there is no authentication info. All existing tests pass."},{"timestamp":1476478699,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(1 comment)\n\nI\u0027ve confirmed your changes fix it for me, without the need for the first case"},{"timestamp":1476490306,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 2."},{"timestamp":1476490340,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476490453,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 2:\n\n@Trent - what about this approach instead - having a function that populates the headers object. I liked this as it centralizes the setting of headers.authorization to the one place, and then all the auth code paths go through the same (one) function."},{"timestamp":1476491766,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(5 comments)\n\nSounds good having that shared \"_setAuth...\" function."},{"timestamp":1476502395,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 3."},{"timestamp":1476502419,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 3:\n\n(5 comments)"},{"timestamp":1476502446,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476731135,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 4."},{"timestamp":1476731188,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476731998,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1476732181,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Todd Whiteman"}],"currentPatchSet":{"number":"4","revision":"14957339caa60faf68d2d756deffd4174d00a441","parents":["d9b946d4f68611cc2c30a080984f9998796ab31a"],"ref":"refs/changes/83/683/4","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1476731135,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476731188,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1476731998,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1476731998,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1476732181,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"lib/registry-client-v2.js","type":"MODIFIED","insertions":43,"deletions":-28},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":49,"sizeDeletions":-30},"patchSets":[{"number":"1","revision":"11a450c378bb3af6f56babbe8e88fe682b0d3c6c","parents":["d9b946d4f68611cc2c30a080984f9998796ab31a"],"ref":"refs/changes/83/683/1","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1476393154,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476393206,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/registry-client-v2.js","line":679,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Wondering about having this explicitly err if authHeader is undefined. I.e. `opts.authInfo` was *given*, but it obviously wasn\u0027t in a form we expected. That\u0027s a programmer error?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/registry-client-v2.js","type":"MODIFIED","insertions":20,"deletions":-10}],"sizeInsertions":20,"sizeDeletions":-10},{"number":"2","revision":"8ee479a33344da4e0b851e2b8bc16d0602efad5f","parents":["d9b946d4f68611cc2c30a080984f9998796ab31a"],"ref":"refs/changes/83/683/2","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1476490306,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476490340,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/registry-client-v2.js","line":71,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"drop \"appropriate\", it is always the \"Authorization\" header."},{"file":"lib/registry-client-v2.js","line":71,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done."},{"file":"lib/registry-client-v2.js","line":75,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"update comment to say the key is deleted"},{"file":"lib/registry-client-v2.js","line":75,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done."},{"file":"lib/registry-client-v2.js","line":80,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"A subtle change below when calling here is that an empty password results in no authorization header being set. I think we should drop the \"\u0026\u0026 authInfo.password\" part of this check."},{"file":"lib/registry-client-v2.js","line":80,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Yes, they were inconsistent before, so keeping it the same (by just checking the username) works better.\n\nDone."},{"file":"lib/registry-client-v2.js","line":190,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"could also drop the \"\u0026\u0026 opts.password\" guard here (see note above)"},{"file":"lib/registry-client-v2.js","line":190,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done."},{"file":"lib/registry-client-v2.js","line":683,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This one should be stricter. Either in _setAuthHeaderFromAuthInfo -- by passing it a strict\u003dtrue option, or just have a `assert.ok(headers.authorization, ...)` after that call."},{"file":"lib/registry-client-v2.js","line":683,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/registry-client-v2.js","type":"MODIFIED","insertions":25,"deletions":-20}],"sizeInsertions":25,"sizeDeletions":-20},{"number":"3","revision":"02653a1d6a7cd95cb3fb54e08241f228da288fed","parents":["d9b946d4f68611cc2c30a080984f9998796ab31a"],"ref":"refs/changes/83/683/3","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1476502395,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476502446,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"lib/registry-client-v2.js","type":"MODIFIED","insertions":31,"deletions":-33},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":37,"sizeDeletions":-35},{"number":"4","revision":"14957339caa60faf68d2d756deffd4174d00a441","parents":["d9b946d4f68611cc2c30a080984f9998796ab31a"],"ref":"refs/changes/83/683/4","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1476731135,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476731188,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1476731998,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1476731998,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1476732181,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"lib/registry-client-v2.js","type":"MODIFIED","insertions":43,"deletions":-28},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":49,"sizeDeletions":-30}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}]}