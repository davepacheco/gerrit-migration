{"project":"joyent/illumos-joyent","branch":"master","id":"I4dae3ebd73596b3ad87cb2e26db5cafbe2c3b053","number":"3792","subject":"OS-6874 viona should untangle status and flags OS-6883 viona needs design prose Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Approved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/3792","commitMessage":"OS-6874 viona should untangle status and flags\nOS-6883 viona needs design prose\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nApproved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\n","createdOn":1523321675,"lastUpdated":1523558672,"open":false,"status":"MERGED","comments":[{"timestamp":1523321675,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1523401743,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1523401761,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1523401895,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4."},{"timestamp":1523402743,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\n(2 comments)\n\nI still want to go through this more carefully, but here are a couple initial comments"},{"timestamp":1523404704,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 5."},{"timestamp":1523404730,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1523478992,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1523482082,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1523484379,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1523495563,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 6."},{"timestamp":1523495579,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1523495602,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 7: Patch Set 6 was rebased."},{"timestamp":1523538122,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1523538944,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 7:\n\n(1 comment)"},{"timestamp":1523540947,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 7:\n\n(1 comment)"},{"timestamp":1523544944,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1523554547,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 8: Patch Set 7 was rebased."},{"timestamp":1523557296,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 8:\n\nTesting notes added to the ticket (OS-6874)"},{"timestamp":1523557788,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 8: Integration-Approval+1"},{"timestamp":1523558587,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 9: Commit message was updated."},{"timestamp":1523558672,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"9","revision":"4dae3ebd73596b3ad87cb2e26db5cafbe2c3b053","parents":["a28d61273630ea91db52781164653b222503e9b6"],"ref":"refs/changes/92/3792/9","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1523558587,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523538122,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523544944,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1523557788,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"SUBM","value":"1","grantedOn":1523558672,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":16,"deletions":-10},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":277,"deletions":-49}],"sizeInsertions":293,"sizeDeletions":-59},"patchSets":[{"number":"1","revision":"586dc245b7a5931f3c897f038ad7b95fe0f6293b","parents":["8d41f5f3d16da9a63c6c2f929235e8a3655430c4"],"ref":"refs/changes/92/3792/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1523321675,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":11,"deletions":-8},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":101,"deletions":-48}],"sizeInsertions":112,"sizeDeletions":-56},{"number":"2","revision":"07aca7c068c2365a755ec7d451857ff7e89f1c7f","parents":["8d41f5f3d16da9a63c6c2f929235e8a3655430c4"],"ref":"refs/changes/92/3792/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1523401743,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":11,"deletions":-8},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":272,"deletions":-49}],"sizeInsertions":283,"sizeDeletions":-57},{"number":"3","revision":"bb72c6c0af229f47d295c78ab4d84b35c162e5d9","parents":["9f9eb51579cad092cf3b3070d80becbe3355cc3d"],"ref":"refs/changes/92/3792/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1523401761,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":11,"deletions":-8},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":272,"deletions":-49}],"sizeInsertions":283,"sizeDeletions":-57},{"number":"4","revision":"3add9a6bbfac8f370392a073005be0c52e75c0e0","parents":["9f9eb51579cad092cf3b3070d80becbe3355cc3d"],"ref":"refs/changes/92/3792/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1523401895,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":143,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"sets the"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":143,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":162,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"remove"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":162,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Fixed and reworded some of the trailing sentences."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":11,"deletions":-8},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":272,"deletions":-49}],"sizeInsertions":283,"sizeDeletions":-57},{"number":"5","revision":"37f35b9fef984016a3002ad2796c26d1123cd562","parents":["9f9eb51579cad092cf3b3070d80becbe3355cc3d"],"ref":"refs/changes/92/3792/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1523404704,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523478992,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":178,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I\u0027m not a big fan of a goto in a situation like this.  Maybe:\n\nwhile ((error \u003d ioctl(...)) !\u003d 0) {\n        if (errno !\u003d EINTR) {\n                WPRINTF();\n                return;\n        }\n}\nsc-\u003evsc_pfn[ring] \u003d 0;"},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":178,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Works for me."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":958,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"What about:\n\nSuppose viona_ioctl(VNA_IOC_DELETE) is called (by zhyve, I think) and while that is running zhyve crashes or `zoneadm halt` is issued.  This causes immediate death of zhyve, which I think will lead to viona_close().   The viona_ioctl() eventually completes and then the thread calling viona_close() gets the lock at 949, then panics at 963.\n\nBut maybe I\u0027m mistaken about how fd\u0027s are closed as a process is forcibly torn down."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":958,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"If VNA_IOC_DELETE sneaks in first (prior to process exit), it _must_ complete, as it has no bail-outs for signals or whatever.  In that case, the \u0027ss_link \u003d\u003d NULL\u0027 test at L951 will pass and we\u0027ll never make it here during viona_close()"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":958,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Adding a comment below to help clarify."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":11,"deletions":-8},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":273,"deletions":-49}],"sizeInsertions":284,"sizeDeletions":-57},{"number":"6","revision":"33bb2c5d42251e5bfe744503996c939343c4bbe3","parents":["9f9eb51579cad092cf3b3070d80becbe3355cc3d"],"ref":"refs/changes/92/3792/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1523495563,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":16,"deletions":-10},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":277,"deletions":-49}],"sizeInsertions":293,"sizeDeletions":-59},{"number":"7","revision":"70fbbe860d918eef3e1d89077416491e288eb0d3","parents":["b69f4bed85ad0bc7cab4782cf2398bee183d4a0f"],"ref":"refs/changes/92/3792/7","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1523495602,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523538122,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523544944,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"comments":[{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":972,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"The viona_close() thread can now take ss-\u003ess_lock.  ss-\u003ess_link is still not NULL."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":972,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"viona_close() cannot race with an ioctl on that same resource.  The reference counting for pseudo devices prevents it."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":16,"deletions":-10},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":277,"deletions":-49}],"sizeInsertions":293,"sizeDeletions":-59},{"number":"8","revision":"eec72e644b190a0a11500824ca732c1cc6cce3f8","parents":["a28d61273630ea91db52781164653b222503e9b6"],"ref":"refs/changes/92/3792/8","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1523554547,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523538122,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523544944,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1523557788,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":16,"deletions":-10},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":277,"deletions":-49}],"sizeInsertions":293,"sizeDeletions":-59},{"number":"9","revision":"4dae3ebd73596b3ad87cb2e26db5cafbe2c3b053","parents":["a28d61273630ea91db52781164653b222503e9b6"],"ref":"refs/changes/92/3792/9","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1523558587,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523538122,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1523558672,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523544944,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1523557788,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":16,"deletions":-10},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":277,"deletions":-49}],"sizeInsertions":293,"sizeDeletions":-59}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}