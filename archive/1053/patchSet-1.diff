From 0db37c69b9d2e2e6abc7983334382ca271cf4daf Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Fri, 2 Dec 2016 22:48:32 +0000
Subject: [PATCH] MORAY-363 Validate index names

---
 lib/buckets/common.js | 31 +++++++++++++++++++++++++++++++
 1 file changed, 31 insertions(+)

diff --git a/lib/buckets/common.js b/lib/buckets/common.js
index fdc8d75..b00b9e7 100644
--- a/lib/buckets/common.js
+++ b/lib/buckets/common.js
@@ -40,8 +40,22 @@ var INDEX_TYPES = {
 // <= 63 characters in length
 var BUCKET_NAME_RE = /^[a-zA-Z]\w{0,62}$/;
 
+var INDEX_NAME_RE =
+    /^([_a-zA-Z][_a-zA-Z0-9]*[a-zA-Z0-9]|[a-zA-Z])$/;
+
 var RESERVED_BUCKETS = ['moray', 'search'];
 
+var RESERVED_INDEXES = [
+    '_etag',
+    '_id',
+    '_key',
+    '_mtime',
+    '_rver',
+    '_txn_snap',
+    '_value',
+    '_vnode'
+];
+
 
 ///--- API
 
@@ -131,6 +145,23 @@ function validateIndexes(schema) {
                                                'objects');
         }
 
+        if (!INDEX_NAME_RE.test(k)) {
+            throw new InvalidBucketConfigError(
+                'invalid index name "' + k + '"');
+        }
+
+        var kLC = k.toLowerCase();
+
+        if (RESERVED_INDEXES.indexOf(kLC) !== -1) {
+            throw new InvalidBucketConfigError(
+                'index name "' + k + '" is reserved for use by Moray');
+        }
+
+        if (/^_*moray/.test(kLC)) {
+            throw new InvalidBucketConfigError(
+                'index names cannot start with "moray": "' + k + '"');
+        }
+
         sub = schema[k];
         subKeys = Object.keys(sub);
         for (j = 0; j < subKeys.length; j++) {
-- 
2.21.0

