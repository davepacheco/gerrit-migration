{"project":"joyent/sdcadm","branch":"master","topic":"rfd163","id":"I13f9943778220a8d81677985144e01eb62110bfd","number":"6160","subject":"TRITON-1319 need firewall-logger agent Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/6160","commitMessage":"TRITON-1319 need firewall-logger agent\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1556188982,"lastUpdated":1560191738,"open":false,"status":"MERGED","comments":[{"timestamp":1556188982,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1556188987,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 1645263b9b5e97d917ecad0aaf08062a7ae0aff3\n    \n    TRITON-1319 need firewall-logger agent"},{"timestamp":1556189121,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nTrent, can you take a look at this one? I\u0027ve been using the stuff you already built for procedures with an agent oriented version of add service.\n\nThe agent service itself is having some issues, but that\u0027s a rust thing Mike Zeller should be fixing in parallel."},{"timestamp":1556204990,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nA build made of a branch based into the current change is available at the experimental channel: 861dd4a6-676b-11e9-ae98-6758fb5ba3bb"},{"timestamp":1556266873,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1556266877,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit c43f07d169b8c08743f853407164dbbbf6279038\n    \n    TRITON-1319 need firewall-logger agent"},{"timestamp":1556668905,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1557325521,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nTodd, can you take a look? I\u0027m pretty sure Trent will try to find the time to take a look too so ..."},{"timestamp":1557346201,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 2:\n\n(6 comments)\n\nLGTM - minor nits spotted :)"},{"timestamp":1557499129,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3."},{"timestamp":1557499134,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 6c0c9167c8c3cbf0cf246dde966f317e063a263b\n    \n    TRITON-1319 need firewall-logger agent"},{"timestamp":1557499167,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1557499469,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4."},{"timestamp":1557499474,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit ed5d3b9f899016b1fb96c1b65bbe8fdab5312e81\n    \n    Applied Todd\u0027s suggested fixes"},{"timestamp":1557499505,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1557499555,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\n(6 comments)\n\nThanks for taking a look Todd!"},{"timestamp":1557508699,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1557508712,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 4: -Integration-Approval"},{"timestamp":1558049702,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\n(3 comments)\n\nA start at a review. I haven\u0027t finished reviewing https://cr.joyent.us/#/c/6160/4/lib/procedures/add-agent-service.js yet. This looks great so far."},{"timestamp":1558052248,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\n(4 comments)"},{"timestamp":1558113167,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Topic set to rfd163"},{"timestamp":1558117206,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 5."},{"timestamp":1558117212,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 81055cc9a3295642a3836da772e125c637ae51e4\n    \n    Applied Todd\u0027s suggested fixes\n    \n    commit 6c0c9167c8c3cbf0cf246dde966f317e063a263b\n    \n    TRITON-1319 need firewall-logger agent"},{"timestamp":1558117243,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\n(7 comments)\n\nTrent, all the suggested changes applied"},{"timestamp":1558117245,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1558118088,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 6."},{"timestamp":1558118093,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit e875b73230d17fc7e1b67669ff59b4c72a51685c\n    \n    Applied Todd\u0027s suggested fixes\n    \n    commit ba4305ecc3c882ea1410d2fd3c5bf94b1c8c0880\n    \n    TRITON-1319 need firewall-logger agent"},{"timestamp":1558118123,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1558118714,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6:\n\n(5 comments)"},{"timestamp":1558364419,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 7."},{"timestamp":1558364424,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 7:\n\nNew commits:\n    \n    commit 3e53716656c01f30b7bd936fc19200f3c29eafb1\n    \n    Applied Todd\u0027s suggested fixes\n    \n    commit ba4305ecc3c882ea1410d2fd3c5bf94b1c8c0880\n    \n    TRITON-1319 need firewall-logger agent"},{"timestamp":1558364457,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1558366056,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\n(4 comments)\n\nDone with the suggested changes Trent. Thanks again!"},{"timestamp":1558636783,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 7:\n\n(2 comments)\n\nIt would also be nice to rename \"lib/post-setup/firewall-logger.js\" to \"lib/post-setup/firewall-logger-agent.js\"."},{"timestamp":1559295708,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 8."},{"timestamp":1559295714,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 8:\n\nNew commits:\n    \n    commit 6923243827048638581af5cc7a3bfb43528e63a3\n    \n    Applied latest suggestions from Trent\n    \n    commit 025347810e893aed20ccf1d8488335f7a4244a14\n    \n    Applied Todd\u0027s suggested fixes\n    \n    commit 3bc2124797d98cc2dc6b52ec10663eb9df14c03f\n    \n    TRITON-1319 need firewall-logger agent"},{"timestamp":1559295755,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1559296478,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 9."},{"timestamp":1559296482,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 9:\n\nNew commits:\n    \n    commit 4dba0e7cf66692c66e114db9c61c1be3110e1c34\n    \n    Applied latest suggestions from Trent\n    \n    commit ef3bb3a8e85d1a7ee8f2dfd18f6aec7ffb241e3d\n    \n    Applied Todd\u0027s suggested fixes\n    \n    commit 8694955a1b101d300f98e5f4e3d32bd0abe0e82d\n    \n    TRITON-1319 need firewall-logger agent"},{"timestamp":1559296512,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1559296534,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 9:\n\n(2 comments)\n\nOk Trent, done as suggested with server.agents and verified that the procedure will be smart enough to look for servers with missing agent or different agent versions"},{"timestamp":1559908102,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 9:\n\nFolks, this is the last pending issue to call every triton related change for cloud firewall logging done. Mind to take a final look and eventually re-stamp?"},{"timestamp":1559908556,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 10."},{"timestamp":1559908561,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 10:\n\nNew commits:\n    \n    commit 0266a09e14d23cc5a15a0c9b930509f2020e97e4\n    \n    Applied latest suggestions from Trent\n    \n    commit 0d07ccd1f7b993554f06757aa4f22e7eebb29a86\n    \n    Applied Todd\u0027s suggested fixes\n    \n    commit 773f436407053d7d80e7a129775733af602d5030\n    \n    TRITON-1319 need firewall-logger agent"},{"timestamp":1559908593,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1560176319,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 11."},{"timestamp":1560176326,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 11:\n\nNew commits:\n    \n    commit d0d8708a7e161b258579114b5e0fdca08e59701c\n    \n    Applied latest suggestions from Trent\n    \n    commit 184f7655381c119dd9881249f368c7b7b0c3f7b2\n    \n    Applied Todd\u0027s suggested fixes\n    \n    commit e305d7185de12f92662e0741c6480292fcc1709d\n    \n    TRITON-1319 need firewall-logger agent"},{"timestamp":1560176359,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1560191283,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 11: Code-Review+1 Integration-Approval+1\n\n(1 comment)\n\none nit is all.\n\nWFM. Tested in my coal: \n- ran the post-setup and the service and agent was installed (it went into maint, but that is a firewall-agent-logger bug)\n- uninstalled the agent via `sdc-cnapi /servers/$(sysinfo | json UUID)/uninstall-agents -X POST -d\u0027{\"agents\": [\"firewall-logger-agent\"]}\u0027`\n- ran the post-setup again and it reinstalled the agent\n- ran the post-setup again and it said \"Nothing to do.\""},{"timestamp":1560191569,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 12."},{"timestamp":1560191574,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 12:\n\nNew commits:\n    \n    commit a25820bb84ad12d28f97cf6cb5e5262858823cba\n    \n    Applied latest suggestions from Trent\n    \n    commit 184f7655381c119dd9881249f368c7b7b0c3f7b2\n    \n    Applied Todd\u0027s suggested fixes\n    \n    commit e305d7185de12f92662e0741c6480292fcc1709d\n    \n    TRITON-1319 need firewall-logger agent"},{"timestamp":1560191608,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1560191706,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 12: Code-Review+1 Integration-Approval+1"},{"timestamp":1560191738,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"12","revision":"13f9943778220a8d81677985144e01eb62110bfd","parents":["102b66efc066378a972e32289ea858b66851f5e2"],"ref":"refs/changes/60/6160/12","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1560191569,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560191608,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1560191706,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1560191706,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1560191738,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/firewall-logger-agent.js","type":"ADDED","insertions":147,"deletions":0},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/procedures/add-agent-service.js","type":"ADDED","insertions":592,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":751,"sizeDeletions":-5},"patchSets":[{"number":"1","revision":"c22420621e5b32bec81a13d8e6bc8200a766c3f2","parents":["7b8b7e1075ad2d46510e65a1c57842a3e7070052"],"ref":"refs/changes/60/6160/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1556188982,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/firewall-logger.js","type":"ADDED","insertions":147,"deletions":0},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/procedures/add-agent-service.js","type":"ADDED","insertions":622,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":775,"sizeDeletions":-3},{"number":"2","revision":"603721d7c13421844f325e7e358f442aa5a490cb","parents":["7b8b7e1075ad2d46510e65a1c57842a3e7070052"],"ref":"refs/changes/60/6160/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1556266873,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556668905,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/post-setup/firewall-logger.js","line":114,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Why \u0027first\u0027 instance? Isn\u0027t it all instances?"},{"file":"lib/post-setup/firewall-logger.js","line":114,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Good call. It should."},{"file":"lib/procedures/add-agent-service.js","line":78,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"s/to/for ?"},{"file":"lib/procedures/add-agent-service.js","line":78,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/add-agent-service.js","line":79,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Not sure this partial sentence is needed (just drop it?)."},{"file":"lib/procedures/add-agent-service.js","line":79,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/add-agent-service.js","line":386,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Missing a fullstop \u0027.\u0027 at the end of this sentence."},{"file":"lib/procedures/add-agent-service.js","line":386,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done!"},{"file":"lib/procedures/add-agent-service.js","line":435,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Make sure prepare *was* run before execute:"},{"file":"lib/procedures/add-agent-service.js","line":435,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/add-service.js","line":405,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Not sure why this is plural, should it not be getServer?"},{"file":"lib/procedures/add-service.js","line":405,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Indeed."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/firewall-logger.js","type":"ADDED","insertions":147,"deletions":0},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/procedures/add-agent-service.js","type":"ADDED","insertions":622,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":780,"sizeDeletions":-4},{"number":"3","revision":"b35d30284cedbff659f8d6e5581bdfe178a8ba04","parents":["f3ab2b54fba9f58b3ee7cd39c0e1083bb6c14442"],"ref":"refs/changes/60/6160/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1557499129,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557499167,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/firewall-logger.js","type":"ADDED","insertions":147,"deletions":0},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/procedures/add-agent-service.js","type":"ADDED","insertions":622,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":780,"sizeDeletions":-4},{"number":"4","revision":"ab9696cf418f145a10afd18e586cbb8c8f826f62","parents":["f3ab2b54fba9f58b3ee7cd39c0e1083bb6c14442"],"ref":"refs/changes/60/6160/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1557499469,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557499505,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557508699,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"comments":[{"file":"lib/post-setup/firewall-logger.js","line":104,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"If we think the system can handle a higher concurrency easily, it would be good to bump this default to something higher. In a DC with ~800 servers I\u0027d imagine this can take a LONG time.\n\nPerhaps bump to 10 to start? I don\u0027t have great reasoning, other than I suspect IMGAPI can handle 10 simultaneous downloads of the image from servers just fine."},{"file":"lib/post-setup/firewall-logger.js","line":104,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Ok, let\u0027s go for it"},{"file":"lib/post-setup/index.js","line":83,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Can we call this `sdcadm post-setup firewall-logger-agent`, please? I.e. the same name as the image and service."},{"file":"lib/post-setup/index.js","line":83,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/add-agent-service.js","line":390,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Does this still try to do work if all these servers already ahve the current agent image deployed?"},{"file":"lib/procedures/add-agent-service.js","line":390,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Yes. Until we have all the remaining pieces of rfd 82 completed, I don\u0027t think we have a reliable way to know that."},{"file":"lib/procedures/add-agent-service.js","line":390,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Hrm... I thought we *did* trust CNAPI server.agents now.\nAnyway, this could be a separate change I suppose. It *will* be frustrating for operators of a large DC to have to retry the agent install on *all* servers if an earlier attempt failed part way.\n\nI think it would be very helpful to have it exclude servers (at least by default) where `server.agents` says that the expected image is installed."},{"file":"lib/procedures/add-agent-service.js","line":390,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Ok, let\u0027s trust SAPI\u0027s info if we got the required image_uuid and server_uuid from the respective CNs"},{"file":"lib/procedures/add-agent-service.js","line":398,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"If you want, this could ust be \"summarize\". The reason we have prefixes on these in a lot of the procedures is back from when we used to have all the Procedure subclasses defined in the same file."},{"file":"lib/procedures/add-agent-service.js","line":398,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Sold!"},{"file":"lib/procedures/add-agent-service.js","line":526,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Any reason to not use `cnapi.waitTask`? That could help reduce the polling and not have the 5s artificial delay between polling if you get unlucky and a task completes just after the GetTask call."},{"file":"lib/procedures/add-agent-service.js","line":526,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Good call, much better that way."},{"file":"lib/procedures/add-agent-service.js","line":603,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps `VError.errorFromList()` which will do the MultiError thing if length \u003e 1, otherwise will just use the first error. Granted this isn\u0027t hte same \"MultiError\" class defined in errors.MultiError, but `sdcadm`s mainline handles both and VError.errorFromList is already used in other parts of sdcadm."},{"file":"lib/procedures/add-agent-service.js","line":603,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Sounds good to me."},{"file":"package.json","line":4,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"You *could* bump minor ver if you like (new feature), but *totally* doesn\u0027t matter."},{"file":"package.json","line":4,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Yeah, not big deal"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/firewall-logger.js","type":"ADDED","insertions":147,"deletions":0},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/procedures/add-agent-service.js","type":"ADDED","insertions":622,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":780,"sizeDeletions":-4},{"number":"5","revision":"d1ea7876567e0d10a68010d96a774224f2d273a3","parents":["f3ab2b54fba9f58b3ee7cd39c0e1083bb6c14442"],"ref":"refs/changes/60/6160/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1558117206,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558117245,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/firewall-logger.js","type":"ADDED","insertions":147,"deletions":0},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/procedures/add-agent-service.js","type":"ADDED","insertions":613,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":771,"sizeDeletions":-4},{"number":"6","revision":"fd7831be7cd181193e045b6b7a3cde449e07e01c","parents":["7c9ae7157ddbca6a1d9ac6c4f7e7395f1541a898"],"ref":"refs/changes/60/6160/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1558118088,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558118123,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"CHANGES.md","line":15,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: update to `-agent`"},{"file":"CHANGES.md","line":15,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/post-setup/firewall-logger.js","line":12,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: missing hyphen"},{"file":"lib/post-setup/firewall-logger.js","line":12,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/post-setup/index.js","line":83,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"You know I\u0027d love for this file to be renamed as well. ;)"},{"file":"lib/procedures/add-agent-service.js","line":433,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: ditto on the prefix for this and other functions if you want"},{"file":"lib/procedures/add-agent-service.js","line":433,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/firewall-logger.js","type":"ADDED","insertions":147,"deletions":0},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/procedures/add-agent-service.js","type":"ADDED","insertions":613,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":771,"sizeDeletions":-4},{"number":"7","revision":"4b70fe0ab36174e0d9487f3fcd447caf3ef15411","parents":["7c9ae7157ddbca6a1d9ac6c4f7e7395f1541a898"],"ref":"refs/changes/60/6160/7","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1558364419,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558364457,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/procedures/add-agent-service.js","line":371,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This code block is trusting the *SAPI agent instance \"image_uuid\"* values are updated when the firewall-logger-agent is updated. I\u0027m not sure that is the case. \n\nI\u0027d suggested earlier that we should look at the \"agents\" array on the CNAPI server objects.\n\nYou can pass `serverExtras: [\u0027agents\u0027]` to the `steps.servers.selectServers` call to have the \"agents\" array populated on the returned `servers`."},{"file":"lib/procedures/add-agent-service.js","line":371,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Ok, done as suggested, which has more sense than what I understood through previous CRs and our mattermost conversation"},{"file":"lib/procedures/add-agent-service.js","line":374,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"That isn\u0027t right. Are you able to test this code path in say, nightly-1 to verify that re-running \u0027sdcadm post-setup firewall-logger-agent\u0027 will:\n\n1. re-install the agent on just the subset of servers that are missing it. E.g. if you install on all of them and then manually remove it from one of them and ensure CNAPI $server.agents gets updated. That CNAPI server object updfate should happen as part of CNAPI ServerUninstallAgents (https://github.com/joyent/sdc-cnapi/blob/master/docs/index.md#serveruninstallagents-post-serversserver_uuiduninstall-agents)\n\n2. report that it has no work to do if the agent is installed on all servers."},{"file":"lib/procedures/add-agent-service.js","line":374,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I don\u0027t think this applies anymore with the change we made above."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/firewall-logger.js","type":"ADDED","insertions":147,"deletions":0},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/procedures/add-agent-service.js","type":"ADDED","insertions":623,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":781,"sizeDeletions":-4},{"number":"8","revision":"631631b77268702ffd1761e59a383504f45cd3aa","parents":["c49d4befc538b2367826f01934bf25469a420f00"],"ref":"refs/changes/60/6160/8","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1559295708,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559295755,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/firewall-logger-agent.js","type":"ADDED","insertions":147,"deletions":0},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/procedures/add-agent-service.js","type":"ADDED","insertions":592,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":751,"sizeDeletions":-5},{"number":"9","revision":"f2428c6294a6da61a3f1ff6f5c3014a7193cf63c","parents":["f6730ba615dde2b3c1421bbba3bf755b25197490"],"ref":"refs/changes/60/6160/9","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1559296478,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559296512,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":3,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/firewall-logger-agent.js","type":"ADDED","insertions":147,"deletions":0},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/procedures/add-agent-service.js","type":"ADDED","insertions":592,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":750,"sizeDeletions":-5},{"number":"10","revision":"f50633c960ecd01512bae4bf91d17bc7aa8e3c86","parents":["c59a4d581d1f04888524dc2f70f24b92d50bbf44"],"ref":"refs/changes/60/6160/10","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1559908556,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559908593,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/firewall-logger-agent.js","type":"ADDED","insertions":147,"deletions":0},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/procedures/add-agent-service.js","type":"ADDED","insertions":592,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":751,"sizeDeletions":-5},{"number":"11","revision":"cb18e65dd9de477b27daf6d761df1e756d756c55","parents":["102b66efc066378a972e32289ea858b66851f5e2"],"ref":"refs/changes/60/6160/11","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1560176319,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560176359,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1560191283,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1560191283,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"lib/post-setup/firewall-logger-agent.js","line":136,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: This should be two separate lines."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/firewall-logger-agent.js","type":"ADDED","insertions":147,"deletions":0},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/procedures/add-agent-service.js","type":"ADDED","insertions":592,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":751,"sizeDeletions":-5},{"number":"12","revision":"13f9943778220a8d81677985144e01eb62110bfd","parents":["102b66efc066378a972e32289ea858b66851f5e2"],"ref":"refs/changes/60/6160/12","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1560191569,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560191608,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1560191706,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1560191706,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1560191738,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/firewall-logger-agent.js","type":"ADDED","insertions":147,"deletions":0},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/procedures/add-agent-service.js","type":"ADDED","insertions":592,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":751,"sizeDeletions":-5}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}