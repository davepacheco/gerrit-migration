{"project":"joyent/sdc-hermes","branch":"master","id":"I9e0fa93835c77400f773624ef657dd4aed6751a9","number":"6009","subject":"TRITON-1291 hermes translation of customer_uuid to manta user Reviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e Approved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e","owner":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"url":"https://cr.joyent.us/6009","commitMessage":"TRITON-1291 hermes translation of customer_uuid to manta user\nReviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\nApproved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\n","createdOn":1553516052,"lastUpdated":1555434683,"open":false,"status":"MERGED","comments":[{"timestamp":1553516052,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 1."},{"timestamp":1553516053,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 3e156941e400704c1aa648a4eab186c5e6198c40\n    \n    translate customer uuid to account"},{"timestamp":1553516114,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1553516187,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 1:\n\nWill add testing notes shortly"},{"timestamp":1553533464,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1: Code-Review+1\n\nCode looks good so far Dylan, happy to give this a try with your test notes!"},{"timestamp":1553779131,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 2."},{"timestamp":1553779132,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 4fcf66d182e174d586f95e71671432df7acf0b9a\n    \n    make sure customer_uuid property is included in logset"},{"timestamp":1553779192,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1553779389,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 3."},{"timestamp":1553779448,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1553779466,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 3:\n\nI built a branch for TRITON-1291 that can be tested by running\n\n`sdcadm up sdc@eecb7e2e-3f50-4ecd-86be-e6ea268d9fbc -C experimental`\n\nIf your sdc zone isn\u0027t setup to use manta you\u0027ll need to follow these directions https://github.com/joyent/sdc-sdc/blob/master/docs/index.md#uploading-sdc-log-data-to-manta\n\nYou\u0027ll need to add the firewall logger logset which can be done by logging into the sdc zone and updating /opt/smartdc/hermes/etc/logsets.json to include\n\n  {\n    \"name\": \"firewall_logs\",\n    \"search_dirs\": [ \"/var/log/firewall\" ],\n    \"regex\": \"^/var/log/firewall/([0-9a-f]{8}\\\\-[0-9a-f]{4}\\\\-[0-9a-f]{4}\\\\-[0-9a-f]{4}\\\\-[0-9a-f]{12})/([0-9a-f]{8}\\\\-[0-9a-f]{4}\\\\-[0-9a-f]{4}\\\\-[0-9a-f]{4}\\\\-[0-9a-f]{12})/([0-9]+)-([0-9]+)-([0-9]+)T([0-9]+):([0-9]+):([0-9]+)\\\\.log.gz$\",\n    \"manta_path\": \"/%U/reports/firewall-logs/$2/#y/#m/#d/#y-#m-#dT#H:#M:#S.log.gz\",\n    \"customer_uuid\": \"$1\",\n    \"date_string\": {\n      \"y\": \"$3\", \"m\": \"$4\", \"d\": \"$5\",\n      \"H\": \"$6\", \"M\": \"$7\", \"S\": \"$8\"\n    },\n    \"date_adjustment\": \"-1H\",\n    \"debounce_time\": 600,\n    \"retain_time\": 0,\n    \"zones\": [\n      \"global\"\n    ]\n  }\n\nFor testing purposes, it might be helpful to remove all other logsets except for this one. I found that on my CoaL setup, the hermes-actor was trying to initiate too many connections with manta at once, leading to endless 500 errors.\n\nFrom inside the sdc-zone, run `svcadm restart hermes` to expedite the process of pushing out the new logsets to the actor\n\nI wrote a quick and dirty script to create a couple users and write log files for them that will be picked up by the firewall logs logset.\n\nhttps://gist.github.com/dyep49/42966d00b73bb74f09afd588d96b7612\n\nIt can take a few minutes for the hermes-actor to pickup the logs, but they should be successfully uploaded to manta at the appropriate paths as per rfd 163"},{"timestamp":1553786725,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\nShouldn\u0027t we try to get this running from the logarchiver zone instead?"},{"timestamp":1555331341,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 3:\n\nA logarchiver image was built using these changes. To test:\n\nProvision a logarchiver instance if it doesn\u0027t exist\n\n```\nsdcadm post-setup logarchiver -C experimental -i 96efc930-b24f-4037-b1a2-0d0c2f659d1b\n```\n\nIf it does, update it\n```\nsdcadm up logarchiver@96efc930-b24f-4037-b1a2-0d0c2f659d1b -C experimental\n\n```\n\nI wrote a quick script that will create a couple users and generate firewall log files in the appropriate locations\n\nhttps://gist.github.com/dyep49/42966d00b73bb74f09afd588d96b7612\n\nIt\u0027ll take a minute for the agent to look sweep for log files, but once it does, it should upload them to manta"},{"timestamp":1555426403,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1\n\nLooking great so far!"},{"timestamp":1555434669,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1555434683,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dylan Yep"}],"currentPatchSet":{"number":"4","revision":"9e0fa93835c77400f773624ef657dd4aed6751a9","parents":["f607e55d1902dca6a3e97b1d7d72071a3be0ec93"],"ref":"refs/changes/09/6009/4","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1555434669,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1553779448,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555426403,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1555426403,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1555434683,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"actor/actor.js","type":"MODIFIED","insertions":16,"deletions":-2},{"file":"actor/lib/logsets.js","type":"MODIFIED","insertions":32,"deletions":-3},{"file":"actor/lib/worker.js","type":"MODIFIED","insertions":56,"deletions":-43},{"file":"etc/config.json.sample","type":"MODIFIED","insertions":3,"deletions":0},{"file":"hermes.js","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"lib/logsets.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"sapi_manifests/hermes/template","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":122,"sizeDeletions":-52},"patchSets":[{"number":"1","revision":"c138da0698a2d6bbd8583b853062a8b72367456b","parents":["f607e55d1902dca6a3e97b1d7d72071a3be0ec93"],"ref":"refs/changes/09/6009/1","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1553516052,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1553516114,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553533464,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"actor/actor.js","type":"MODIFIED","insertions":16,"deletions":-2},{"file":"actor/lib/logsets.js","type":"MODIFIED","insertions":32,"deletions":-3},{"file":"actor/lib/worker.js","type":"MODIFIED","insertions":56,"deletions":-43},{"file":"etc/config.json.sample","type":"MODIFIED","insertions":3,"deletions":0},{"file":"hermes.js","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"sapi_manifests/hermes/template","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":120,"sizeDeletions":-51},{"number":"2","revision":"b24aee75ca2f29f266c500cc41fa36dd5fb548fb","parents":["f607e55d1902dca6a3e97b1d7d72071a3be0ec93"],"ref":"refs/changes/09/6009/2","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1553779131,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1553779192,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":".gitmodules","type":"ADDED","insertions":4,"deletions":0},{"file":"actor/actor.js","type":"MODIFIED","insertions":16,"deletions":-2},{"file":"actor/lib/logsets.js","type":"MODIFIED","insertions":32,"deletions":-3},{"file":"actor/lib/worker.js","type":"MODIFIED","insertions":56,"deletions":-43},{"file":"etc/config.json.sample","type":"MODIFIED","insertions":3,"deletions":0},{"file":"hermes.js","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"lib/logsets.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"sapi_manifests/hermes/template","type":"MODIFIED","insertions":3,"deletions":0},{"file":"sdc-hermes","type":"ADDED","insertions":1,"deletions":0}],"sizeInsertions":127,"sizeDeletions":-52},{"number":"3","revision":"b2045fb5ce25570ca70c1d72c5a81fa21ed6fe3f","parents":["f607e55d1902dca6a3e97b1d7d72071a3be0ec93"],"ref":"refs/changes/09/6009/3","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1553779389,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1553779448,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555426403,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1555426403,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"actor/actor.js","type":"MODIFIED","insertions":16,"deletions":-2},{"file":"actor/lib/logsets.js","type":"MODIFIED","insertions":32,"deletions":-3},{"file":"actor/lib/worker.js","type":"MODIFIED","insertions":56,"deletions":-43},{"file":"etc/config.json.sample","type":"MODIFIED","insertions":3,"deletions":0},{"file":"hermes.js","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"lib/logsets.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"sapi_manifests/hermes/template","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":122,"sizeDeletions":-52},{"number":"4","revision":"9e0fa93835c77400f773624ef657dd4aed6751a9","parents":["f607e55d1902dca6a3e97b1d7d72071a3be0ec93"],"ref":"refs/changes/09/6009/4","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1555434669,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1553779448,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555426403,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1555426403,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1555434683,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"actor/actor.js","type":"MODIFIED","insertions":16,"deletions":-2},{"file":"actor/lib/logsets.js","type":"MODIFIED","insertions":32,"deletions":-3},{"file":"actor/lib/worker.js","type":"MODIFIED","insertions":56,"deletions":-43},{"file":"etc/config.json.sample","type":"MODIFIED","insertions":3,"deletions":0},{"file":"hermes.js","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"lib/logsets.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"sapi_manifests/hermes/template","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":122,"sizeDeletions":-52}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}]}