From 9e64dd3256b37c9bb4e3c13dec44d8d6ae394d9b Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Tue, 22 Jan 2019 16:40:22 -0800
Subject: [PATCH] TRITON-1109 fix kthxbai-caused warnings during 'npm ls
 --json' in config-agent

---
 .kthxbai     |  2 +-
 CHANGES.md   | 11 ++++++++++-
 Makefile     | 10 ++++++++--
 package.json |  3 +--
 4 files changed, 20 insertions(+), 6 deletions(-)

diff --git a/.kthxbai b/.kthxbai
index 0ef650f..8a7f9bf 100644
--- a/.kthxbai
+++ b/.kthxbai
@@ -32,7 +32,7 @@
 # TODO: Not sure all of these are safely removable.
 sdc-clients/tools
 sdc-clients/lib/*.javascript
-sdc-clients/lib/{amon,assertions,ca,cache,cnapi,dsapi,fwapi,imgapi,napi,papi,vmapi,usageapi}.js
+sdc-clients/lib/{amon,assertions,ca,cache,cnapi,fwapi,imgapi,napi,papi,vmapi,usageapi}.js
 sdc-clients/node_modules/{bunyan,clone,http-signature,libuuid,smartdc-auth,ufds,verror}
 
 # hogan.js
diff --git a/CHANGES.md b/CHANGES.md
index 9ef9fe4..f8fe11c 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -1,5 +1,14 @@
 # sdc-config-agent changelog
 
+## 1.8.3
+
+- TRITON-1109 kthxbai usage changes to avoid build warnings due to TOOLS-2043.
+- TOOLS-2043 Change to new engbld system.
+
+## 1.8.2
+
+- TOOLS-2117 Bump sdcnode to v6.15.1
+
 ## 1.8.1
 
 - TRITON-691 update config-agent's node to v6
@@ -37,7 +46,7 @@
 
 ## 1.6.0
 
-- [AGENT-1086] Support network per rack Manta deployments by allowing 
+- [AGENT-1086] Support network per rack Manta deployments by allowing
   nic_tags with \<tag>_rackNN suffixes to override nic_tags with the same \<tag>
   (e.g "manta_rack99" overrides "manta").
 
diff --git a/Makefile b/Makefile
index 2e23f9e..feae48b 100644
--- a/Makefile
+++ b/Makefile
@@ -50,7 +50,13 @@ include ./deps/eng/tools/mk/Makefile.smf.defs
 #
 .PHONY: all
 all: $(SMF_MANIFESTS) | $(NPM_EXEC)
-	$(NPM) install && $(NODE) ./node_modules/.bin/kthxbai
+	$(NPM) install
+
+.PHONY: kthxbai
+kthxbai:
+	# Use global-style to not leak sub-deps of kthxbai in node_modules top-level.
+	$(NPM) --global-style install kthxbai@~0.4.0
+	$(NODE) ./node_modules/.bin/kthxbai
 
 DISTCLEAN_FILES+=node_modules $(NAME)-*.manifest
 
@@ -67,7 +73,7 @@ RELEASE_MANIFEST := $(NAME)-pkg-$(STAMP).manifest
 RELSTAGEDIR     := /tmp/$(NAME)-$(STAMP)
 
 .PHONY: release
-release: all deps docs $(SMF_MANIFESTS)
+release: all kthxbai docs $(SMF_MANIFESTS)
 	@echo "Building $(RELEASE_TARBALL)"
 	@mkdir -p $(RELSTAGEDIR)/$(NAME)/build
 	cp -r \
diff --git a/package.json b/package.json
index 5430382..9880d25 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "config-agent",
     "description": "SmartDataCenter Config Agent",
-    "version": "1.8.2",
+    "version": "1.8.3",
     "author": "Joyent (joyent.com)",
     "dependencies": {
         "assert-plus": "1.0.0",
@@ -10,7 +10,6 @@
         "cmdln": "3.4.0",
         "hogan.js": "git+https://github.com/joyent/hogan.js#7d34ba7",
         "jsprim": "2.0.0",
-        "kthxbai": "^0.4.0",
         "mkdirp": "0.5.1",
         "once": "1.3.2",
         "optimist": "0.6.1",
-- 
2.21.0

