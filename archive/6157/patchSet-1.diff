From 020d68fedf8fc208cf75a266d05826c7de8a1886 Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Wed, 24 Apr 2019 10:40:09 -0700
Subject: [PATCH] TRITON-1632 vmapi nodeunit upgrade broke test output scraping

---
 test/runtests | 46 +++-------------------------------------------
 1 file changed, 3 insertions(+), 43 deletions(-)

diff --git a/test/runtests b/test/runtests
index 315be05..9960a0c 100755
--- a/test/runtests
+++ b/test/runtests
@@ -207,48 +207,8 @@ if [[ -n "$opt_test_pattern" ]]; then
 fi
 
 # Run the tests.
-retval=0
 if [[ -n "$test_files" ]]; then
-    if [[ $opt_reporter == "tap" ]]; then
-        VMAPI_IP=$VMAPI_IP CNAPI_IP=$CNAPI_IP NAPI_IP=$NAPI_IP \
-        PATH=$NODE_INSTALL/bin:$PATH $NODEUNIT --reporter \
-        $opt_reporter $test_files | tee $OUTPUT_DIR/vmapi.tap
-    else
-        VMAPI_IP=$VMAPI_IP CNAPI_IP=$CNAPI_IP NAPI_IP=$NAPI_IP \
-        PATH=$NODE_INSTALL/bin:$PATH $NODEUNIT --reporter \
-        $opt_reporter $test_files; retval=$?
-    fi
-fi
-
-
-if [[ $opt_reporter == "tap" ]]; then
-    echo ""
-    echo "# test output:"
-    ls $OUTPUT_DIR/*.tap
-
-    # Colored summary of results (borrowed from smartos-live.git/src/vm/run-tests).
-    echo ""
-    echo "# test results:"
-
-    end_time=$(date +%s)
-    elapsed=$((${end_time} - ${start_time}))
-
-    tests=$(grep "^# tests [0-9]" $OUTPUT_DIR/*.tap | cut -d ' ' -f3 | xargs | tr ' ' '+' | bc)
-    passed=$(grep "^# pass  [0-9]" $OUTPUT_DIR/*.tap | tr -s ' ' | cut -d ' ' -f3 | xargs | tr ' ' '+' | bc)
-    [[ -z ${tests} ]] && tests=0
-    [[ -z ${passed} ]] && passed=0
-    fail=$((${tests} - ${passed}))
-
-    echo "# Completed in ${elapsed} seconds."
-    echo -e "# \033[32mPASS: ${passed} / ${tests}\033[39m"
-    if [[ ${fail} -gt 0 ]]; then
-        echo -e "# \033[31mFAIL: ${fail} / ${tests}\033[39m"
-    fi
-    echo ""
-
-    if [[ ${tests} != ${passed} ]]; then
-        exit 1
-    fi
-else
-    exit $retval
+    VMAPI_IP=$VMAPI_IP CNAPI_IP=$CNAPI_IP NAPI_IP=$NAPI_IP \
+    PATH=$NODE_INSTALL/bin:$PATH $NODEUNIT --reporter \
+    $opt_reporter $test_files
 fi
-- 
2.21.0

