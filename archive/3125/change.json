{"project":"joyent/sdc-booter","branch":"master","id":"I2cc4a102ac8bd3822d450ad2788f0af328b23077","number":"3125","subject":"TRITON-29 booter: hn-netfile cannot find \u0027admin\u0027 NIC using aggrs Reviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e Approved by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e","owner":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"url":"https://cr.joyent.us/3125","commitMessage":"TRITON-29 booter: hn-netfile cannot find \u0027admin\u0027 NIC using aggrs\nReviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\nApproved by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\n","createdOn":1513651408,"lastUpdated":1522275514,"open":false,"status":"MERGED","comments":[{"timestamp":1513651408,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 1."},{"timestamp":1513651410,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit baca1683e25bce3516315211954633d9acad8409\n    \n    find admin nic on aggrs as well"},{"timestamp":1513651435,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513651548,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\ntesting notes:\n- this worked for me in us-east-3b, where the aggrs issue was hit\n- this also works for the servers in nightly-1 that do NOT use aggrs, e.g.:\n\n```\n[root@81c8b9ef-0222-4a86-9fd5-f567744ef0ed (nightly-1:dhcpd0) ~]# hn-netfile cdf455d4-1ccf-11e4-b4e6-002590e4f08c\n{\n  \"nictags\": [\n    {\n      \"mtu\": 1500,\n      \"name\": \"external\",\n      \"uuid\": \"b7a9efd7-0618-4ac2-83bb-79b2238db36b\",\n      \"mac\": \"90:e2:ba:69:f4:9d\"\n    },\n    {\n      \"mtu\": 9000,\n      \"name\": \"sdc_underlay\",\n      \"uuid\": \"12de9b76-1feb-4f58-aca4-1b32acae53ce\",\n      \"mac\": \"90:e2:ba:69:f4:9d\"\n    },\n    {\n      \"mtu\": 1500,\n      \"name\": \"mantanat\",\n      \"uuid\": \"64636dc4-b3ee-419b-8510-ec396660ac75\",\n      \"mac\": \"90:e2:ba:69:f4:9d\"\n    },\n    {\n      \"mtu\": 1500,\n      \"name\": \"manta\",\n      \"uuid\": \"b108c42d-a224-48e5-896a-93037bcf5c40\",\n      \"mac\": \"90:e2:ba:69:f4:9d\"\n    },\n    {\n      \"mtu\": 1500,\n      \"name\": \"admin\",\n      \"uuid\": \"bfe390ba-7c00-4762-b6e6-1e388739281d\",\n      \"mac\": \"90:e2:ba:69:f4:9c\"\n    }\n  ],\n  \"resolvers\": [\n    \"172.25.1.11\",\n    \"8.8.8.8\",\n    \"8.8.4.4\"\n  ],\n  \"routes\": {},\n  \"vnics\": [\n    {\n      \"belongs_to_type\": \"server\",\n      \"belongs_to_uuid\": \"cdf455d4-1ccf-11e4-b4e6-002590e4f08c\",\n      \"mac\": \"90:e2:ba:69:f4:9c\",\n      \"owner_uuid\": \"930896af-bf8c-48d4-885c-6573a94b1853\",\n      \"primary\": false,\n      \"state\": \"provisioning\",\n      \"created_timestamp\": \"2017-12-18T05:58:22.533Z\",\n      \"modified_timestamp\": \"2017-12-18T06:16:58.365Z\",\n      \"ip\": \"172.25.1.38\",\n      \"mtu\": 1500,\n      \"netmask\": \"255.255.255.0\",\n      \"nic_tag\": \"admin\",\n      \"resolvers\": [\n        \"172.25.1.11\"\n      ],\n      \"vlan_id\": 0,\n      \"network_uuid\": \"03f0674c-fe8e-461a-8345-242dd9075fa4\",\n      \"nic_tags_provided\": [\n        \"admin\"\n      ]\n    },\n    {\n      \"belongs_to_type\": \"server\",\n      \"belongs_to_uuid\": \"cdf455d4-1ccf-11e4-b4e6-002590e4f08c\",\n      \"mac\": \"90:b8:d0:23:2a:6c\",\n      \"owner_uuid\": \"930896af-bf8c-48d4-885c-6573a94b1853\",\n      \"primary\": false,\n      \"state\": \"provisioning\",\n      \"created_timestamp\": \"2017-12-18T06:51:28.601Z\",\n      \"modified_timestamp\": \"2017-12-18T06:51:28.601Z\",\n      \"ip\": \"172.31.1.7\",\n      \"mtu\": 9000,\n      \"netmask\": \"255.255.255.0\",\n      \"nic_tag\": \"sdc_underlay\",\n      \"resolvers\": [],\n      \"vlan_id\": 2701,\n      \"network_uuid\": \"318451bf-7cea-43fe-b15f-864464ecf059\",\n      \"underlay\": true,\n      \"overlay_nic_tags_provided\": [\n        \"sdc_overlay\"\n      ]\n    },\n    {\n      \"belongs_to_type\": \"server\",\n      \"belongs_to_uuid\": \"cdf455d4-1ccf-11e4-b4e6-002590e4f08c\",\n      \"mac\": \"90:b8:d0:8c:67:ba\",\n      \"owner_uuid\": \"930896af-bf8c-48d4-885c-6573a94b1853\",\n      \"primary\": false,\n      \"state\": \"provisioning\",\n      \"created_timestamp\": \"2017-12-18T19:46:31.651Z\",\n      \"modified_timestamp\": \"2017-12-18T19:46:31.651Z\",\n      \"ip\": \"172.26.1.107\",\n      \"gateway\": \"172.26.1.1\",\n      \"mtu\": 1500,\n      \"netmask\": \"255.255.255.0\",\n      \"nic_tag\": \"external\",\n      \"resolvers\": [\n        \"8.8.8.8\",\n        \"8.8.4.4\"\n      ],\n      \"vlan_id\": 3301,\n      \"network_uuid\": \"07865227-70b0-48ae-ac6d-70453143cbce\"\n    },\n    {\n      \"belongs_to_type\": \"server\",\n      \"belongs_to_uuid\": \"cdf455d4-1ccf-11e4-b4e6-002590e4f08c\",\n      \"mac\": \"90:b8:d0:d4:6f:be\",\n      \"owner_uuid\": \"930896af-bf8c-48d4-885c-6573a94b1853\",\n      \"primary\": false,\n      \"state\": \"provisioning\",\n      \"created_timestamp\": \"2017-12-18T06:56:05.505Z\",\n      \"modified_timestamp\": \"2017-12-18T06:56:05.505Z\",\n      \"ip\": \"172.27.1.5\",\n      \"mtu\": 1500,\n      \"netmask\": \"255.255.255.0\",\n      \"nic_tag\": \"manta\",\n      \"resolvers\": [],\n      \"routes\": {},\n      \"vlan_id\": 3601,\n      \"network_uuid\": \"4747b26a-288e-425a-a769-b226156ef6bf\"\n    }\n  ],\n  \"dns_domain\": \"joyent.us\",\n  \"hostname\": \"S12612524404885\",\n  \"nictag_rules\": {\n    \"sdc_overlay\": \"-e vxlan -s svp -p svp/host\u003dportolan.nightly-1.joyent.us -p svp/underlay_ip\u003d172.31.1.7 -p vxlan/listen_ip\u003d172.31.1.7 -p mtu\u003d8500\"\n  },\n  \"aggregations\": []\n}\n```"},{"timestamp":1513655510,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1522275396,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1: Code-Review+1 Integration-Approval+1"},{"timestamp":1522275470,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 2."},{"timestamp":1522275471,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit eb2dddd3aa25070a93f7905d512361bdfa800c28\n    \n    find admin nic on aggrs as well"},{"timestamp":1522275498,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1522275505,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1"},{"timestamp":1522275514,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Trent Mick"}],"currentPatchSet":{"number":"2","revision":"2cc4a102ac8bd3822d450ad2788f0af328b23077","parents":["1cfe422f3527886b93caceca34753b85bc88d83e"],"ref":"refs/changes/25/3125/2","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1522275470,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522275498,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522275505,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522275505,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"SUBM","value":"1","grantedOn":1522275514,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"bin/hn-netfile","type":"MODIFIED","insertions":85,"deletions":-14}],"sizeInsertions":85,"sizeDeletions":-14},"patchSets":[{"number":"1","revision":"2e450f95bfbe417a6e4658fbe5807b7531aaa064","parents":["5f665800fdbd42846bc7ee83a9fd356c59babb8f"],"ref":"refs/changes/25/3125/1","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1513651408,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522275396,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522275396,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513651435,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/hn-netfile","line":275,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I wonder if it would be better to use mod_clients.napiGetNics here, and then have a selectAdminNic function that runs just before genNetFile, which can then reference .nics and .aggrs?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/hn-netfile","type":"MODIFIED","insertions":85,"deletions":-14}],"sizeInsertions":85,"sizeDeletions":-14},{"number":"2","revision":"2cc4a102ac8bd3822d450ad2788f0af328b23077","parents":["1cfe422f3527886b93caceca34753b85bc88d83e"],"ref":"refs/changes/25/3125/2","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1522275470,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522275505,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522275505,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522275498,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1522275514,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"bin/hn-netfile","type":"MODIFIED","insertions":85,"deletions":-14}],"sizeInsertions":85,"sizeDeletions":-14}],"allReviewers":[{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}]}