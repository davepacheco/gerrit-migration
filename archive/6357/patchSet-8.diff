From 7134ad7d96fa5abca7e7910b8be457783e2aab9e Mon Sep 17 00:00:00 2001
From: Orlando Vazquez <ovazquez@gmail.com>
Date: Mon, 27 May 2019 12:26:31 -0700
Subject: [PATCH] TRITON-1703 cn-agent should accept rate limiting flag for
 migrate sync

---
 .../smartos/bin/machine-migrate-send.js       | 21 ++++++++++++-------
 package.json                                  |  2 +-
 2 files changed, 15 insertions(+), 8 deletions(-)

diff --git a/lib/backends/smartos/bin/machine-migrate-send.js b/lib/backends/smartos/bin/machine-migrate-send.js
index b06a3ab..1aca528 100644
--- a/lib/backends/smartos/bin/machine-migrate-send.js
+++ b/lib/backends/smartos/bin/machine-migrate-send.js
@@ -31,6 +31,7 @@ var SERVER_CLOSE_TIMEOUT = 60 * 1000; // 1 minute
 var SNAPSHOT_NAME_PREFIX = 'vm-migration-';
 var SYNC_ABORT_MSG = 'Sync was aborted';
 var currentProgress = 0;
+var MEGABITS_TO_BYTES = 1000 * 1000 / 8;
 var gSyncHandler = null;
 var stopProcess = false;
 var tcpServer;
@@ -160,6 +161,8 @@ function SyncHandler(opts, event, socket) {
     this.pendingCallbacks = {};
     this.syncAborted = false;
 
+    this.zfs_send_mbps_limit = opts.payload.zfs_send_mbps_limit;
+
     // This is the main context for each dataset sync operation.
     this.datasets = {};
     this.datasets[this.vm.zfs_filesystem] = {
@@ -1025,16 +1028,20 @@ SyncHandler.prototype.startSync = function _syncHandleRunSync(ctx, callback) {
         }
     });
 
-    // XXX: TODO: Rate should come from inputs.
-    var rate;
-    // rate = 1 * 1024 * 1024; // 1 MB/sec
-    // rate = 1 * 128 * 1024; // 128 KB/sec
-
     // Limit how much "zfs send" data we send through the socket.
-    if (rate) {
-        self.throttle = new streamThrottle.Throttle({rate: rate});
+    if (self.zfs_send_mbps_limit) {
+        log.info('startSync: config.zfs_send_mbps_limit is set, ' +
+            'sending at %d mbps',
+            self.zfs_send_mbps_limit);
+        self.throttle = new streamThrottle.Throttle({
+            // convert value to B/sec
+            rate: self.zfs_send_mbps_limit * MEGABITS_TO_BYTES
+        });
         zfsSend.stdout.pipe(self.throttle).pipe(ctx.receiverSocket);
     } else {
+        log.info('startSync: config.zfs_send_mbps_limit not set, ' +
+            'sending with no bandwidth limit',
+            self.zfs_send_mbps_limit);
         zfsSend.stdout.pipe(ctx.receiverSocket);
     }
 
diff --git a/package.json b/package.json
index c271dca..3036109 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "cn-agent",
   "description": "Triton Compute Node Agent",
-  "version": "2.12.4",
+  "version": "2.12.5",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

