From 12fd8f12220d7cdbeb860141303cac6975a480cc Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Tue, 7 Feb 2017 13:56:04 -0800
Subject: [PATCH] CNS-195 error handling mixups in dns-server.js

---
 lib/dns-server.js | 21 ++++++++++++---------
 1 file changed, 12 insertions(+), 9 deletions(-)

diff --git a/lib/dns-server.js b/lib/dns-server.js
index bc9a23b..03510b1 100644
--- a/lib/dns-server.js
+++ b/lib/dns-server.js
@@ -528,19 +528,22 @@ DNSServer.prototype.getAllZones = function (r, cb) {
 	var zs = Object.keys(this.config.forward_zones);
 
 	r.keys('zone:*.arpa', function (err, keys) {
-		if (err || keys === null)
-			return;
-
-		for (var i = 0; i < keys.length; ++i) {
-			var k = keys[i].split(':')[1];
-			zs.push(k);
+		if (!err && keys !== null) {
+			for (var i = 0; i < keys.length; ++i) {
+				var k = keys[i].split(':')[1];
+				zs.push(k);
+			}
 		}
 
 		vasync.forEachParallel({
 			func: getZoneSerial,
 			inputs: zs
 		}, function (err2, res) {
-			cb(err2, res.successes);
+			if (err2) {
+				cb(err2);
+				return;
+			}
+			cb(null, res.successes);
 		});
 
 		function getZoneSerial(z, scb) {
@@ -548,8 +551,8 @@ DNSServer.prototype.getAllZones = function (r, cb) {
 			r.get(zk, function (err3, serStr) {
 				var res = {};
 				res.zone = z;
-				if (err) {
-					scb(err);
+				if (err3) {
+					scb(err3);
 					return;
 				}
 				if (serStr === null) {
-- 
2.21.0

