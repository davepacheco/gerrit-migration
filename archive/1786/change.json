{"project":"joyent/smartos-live","branch":"master","id":"Ica872d492b5ce6e20c8b8dbc794400c0603f1de0","number":"1786","subject":"OS-6053 work around logadm bugs by removing bogus KVM log entries for destroyed VMs Reviewed by: Dave Eddy \u003cdave.eddy@joyent.com\u003e","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/1786","commitMessage":"OS-6053 work around logadm bugs by removing bogus KVM log entries for destroyed VMs\nReviewed by: Dave Eddy \u003cdave.eddy@joyent.com\u003e\n","createdOn":1492034034,"lastUpdated":1511575549,"open":false,"status":"MERGED","comments":[{"timestamp":1492034034,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1492034035,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit bd96513eba3448b8c06bedf5b8d35421359861bc\n    \n    add support for cleaning up stale logadm entries"},{"timestamp":1492034071,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510875208,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1510905935,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1511200533,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1511206315,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1511206988,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1511235967,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 2."},{"timestamp":1511235968,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 131019c0072a3eb222a2d74b9333e8bf0b9d2a60\n    \n    implement changes suggested in review\n    \n    commit 9eae1454024bdb9cc2f3fc9e01aff02569d135b1\n    \n    OS-6053 work around logadm bugs by removing bogus KVM log entries for destroyed VMs"},{"timestamp":1511235991,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3: Patch Set 2 was rebased"},{"timestamp":1511236007,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1511236030,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1511241521,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)\n\ncode overall looks good to me minus one small nit."},{"timestamp":1511333083,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 4."},{"timestamp":1511333085,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit b558f7ab72b7fa29db07084b7c10078a81b37913\n    \n    fix nit found in CR"},{"timestamp":1511333093,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1511333126,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1511333127,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1511333134,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1511371984,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1511575549,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Josh Wilsdon"}],"currentPatchSet":{"number":"5","revision":"1d55b897d363f99cb7d4070166ca9433f0c14274","parents":["76abff3cfdad511f7d0bfe57c1a2b5913afc7b5b"],"ref":"refs/changes/86/1786/5","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1511333093,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1511333134,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1511371984,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1511371984,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"SUBM","value":"1","grantedOn":1511575549,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/vm/sbin/rotate-kvm-logs.sh","type":"MODIFIED","insertions":21,"deletions":-1}],"sizeInsertions":21,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"aa96e4da04d64114ae74b96480bfd90301b820de","parents":["37fa0b13a2503039ea0e9ba785f1951785d941ad"],"ref":"refs/changes/86/1786/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1492034034,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1492034071,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/vm/sbin/rotate-kvm-logs.sh","line":105,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"I\u0027d prefer this to be a while loop to process the input line-by-line\n\n\n awk \u0027/^\\/zones\\/.*\\/root\\/tmp\\/vm.log/ { print $1 }\u0027 /var/logadm/timestamps \\|\n     while read -r vmlog; do\n        ...\n     done"},{"file":"src/vm/sbin/rotate-kvm-logs.sh","line":105,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Do you have a reasoning for this? Not challenging, just trying to understand. I guess it\u0027s because the grep might include filenames with spaces if somehow a zonename had spaces and had previously rotated its log?"},{"file":"src/vm/sbin/rotate-kvm-logs.sh","line":105,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"So yes, `for` loops are intended to loop over every argument seen after the `in` keywoad.  Because of this, it\u0027ll work for the `grep` command so long as the filenames don\u0027t have any whitespace in them (spaces, tabs, or newlines specifically).\n\n\nHowever, the main reason to prefer a line-by-line while loop is to match the intent of the grep command and the timestamps file.  The timestamps file is separated by newlines, and grep (and awk) work on a line-by-line basis, so using a `while read line` loop in bash makes the most sense to continue the line-by-line processing.\n\n\nAnother interesting thing to consider here is when using the `for x in $(...)` construct, the entire subcommand must finish running and all of its output stored in memory before the for loop can begin processing the input, whereas the `while read line` can process input as it comes in in a streaming fashion."},{"file":"src/vm/sbin/rotate-kvm-logs.sh","line":105,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Thanks for the explanation. That\u0027s about what I expected. I\u0027m going to change this to the while loop."},{"file":"src/vm/sbin/rotate-kvm-logs.sh","line":108,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"quote the variable to avoid word-splitting - using {..} in this context has no effect.\n\n\n  dirname\u003d$(dirname \"$vmlog\")"},{"file":"src/vm/sbin/rotate-kvm-logs.sh","line":108,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Good point on the quoting here wrt word splitting. I\u0027ll add that.\n\nHowever, just because {} has no effect doesn\u0027t seem to be a good reason not to do it. Whitespace has no effect and yet we add it. We (some of us) also add { } on if conditions that have a single statement in order to be more consistent.\n\nIs there an actual problem with always using ${var}? It seems to me this is more flexible since there are some cases when you need ${} and no cases that I\u0027m aware of where it causes problems. However there *are* cases where *not* having {} causes problems. So, for the sake of consistency I always use them.\n\nIf you can come up with a problem that might be caused by using ${vmlog} here, I\u0027m happy to learn (and change it). Otherwise, I\u0027ll stick to the thing that works consistently everywhere. :)"},{"file":"src/vm/sbin/rotate-kvm-logs.sh","line":108,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"\"$foo\" and \"${foo}\" in 99% of the situations have no functional difference, and you should be safe to always prefer using curly braces if you choose.  Like you mentioned, you could potentially run into issues where using curly braces are necessary, but you can never run into a situation where omitting curly braces is problematic.\n\n\nPersonally, the reason I omit curly braces and only use them when strictly necessary is simply because that: because I know when they are necessary.\n\n\nUsing curly braces everywhere, just like quoting every variable expansion, is a safe practice - but falls under the \"when in doubt\" category.  I can loosely compare this to JavaScript by saying all variables should be wrapped in parenthesis.  While this technically doesn\u0027t hurt anything, it isn\u0027t necessary.  For example, I see these as similar (albeit a contrived example).\n\n echo \"testing $dir/$file\"\n console.log(\u0027testing \u0027 + dir + \u0027/\u0027 + file);\n\nand\n\n echo \"testing ${dir}/${file}\"\n console.log(\u0027testing \u0027 + (dir) + \u0027/\u0027 + (file));\n\n\nTo summarize, this really just becomes a matter of preference, since using curly braces (like the parenthesis in JavaScript) will never result in unexpected or bad behavior."},{"file":"src/vm/sbin/rotate-kvm-logs.sh","line":108,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I think the parenthesis around the variables isn\u0027t a perfect example, because I don\u0027t know of cases where a variable name is required to have parenthesis.\n\nI think a better example is semicolons in Javascript. There are some cases where semicolons are required and some where they are optional. If you know the magic, you can include them only where they\u0027re required. However, our code at Joyent includes semicolons even where they\u0027re *not* necessary, for consistency. And because always using semicolons always works, whereas always *not* using semicolons sometimes doesn\u0027t work.\n\nAll that said, I\u0027m fine leaving this as a personal preference thing. Thanks for your explanation though! :)"},{"file":"src/vm/sbin/rotate-kvm-logs.sh","line":108,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Ah yes, that\u0027s a way better analogy.  Sounds good to me!"},{"file":"src/vm/sbin/rotate-kvm-logs.sh","line":109,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"you can drop the {...} here\n\n\n if [[ ! -d $dirname ]]; then"},{"file":"src/vm/sbin/rotate-kvm-logs.sh","line":110,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"quote the variable and drop the curly braces\n\n  logadm -r \"$vmlog\""},{"file":"src/vm/sbin/rotate-kvm-logs.sh","line":110,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"again: thanks! quoting here is a good point."},{"file":"src/vm/sbin/rotate-kvm-logs.sh","line":111,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"nit: curly braces are unnecessary"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/sbin/rotate-kvm-logs.sh","type":"MODIFIED","insertions":21,"deletions":-1}],"sizeInsertions":21,"sizeDeletions":-1},{"number":"2","revision":"cc71374171509448504a4829fc6e71f200530c7f","parents":["f881d616c90f8aadceea775718696e0f4f8d0a34"],"ref":"refs/changes/86/1786/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1511235967,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1511236007,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/sbin/rotate-kvm-logs.sh","type":"MODIFIED","insertions":21,"deletions":-1}],"sizeInsertions":21,"sizeDeletions":-1},{"number":"3","revision":"5062ef989adad0473a619df324c4f460e14a96c2","parents":["76abff3cfdad511f7d0bfe57c1a2b5913afc7b5b"],"ref":"refs/changes/86/1786/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1511235991,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1511236030,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1511241521,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"comments":[{"file":"src/vm/sbin/rotate-kvm-logs.sh","line":111,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"nit: I\u0027d prefer if the log line went above the call to `logadm`.  This way, if `logadm` fails for any reason, the failure message will be below the message saying \"removing stale logadm entry\""},{"file":"src/vm/sbin/rotate-kvm-logs.sh","line":111,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"good point, thanks!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/sbin/rotate-kvm-logs.sh","type":"MODIFIED","insertions":21,"deletions":-1}],"sizeInsertions":21,"sizeDeletions":-1},{"number":"4","revision":"ca872d492b5ce6e20c8b8dbc794400c0603f1de0","parents":["f881d616c90f8aadceea775718696e0f4f8d0a34"],"ref":"refs/changes/86/1786/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1511333083,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1511333126,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/vm/sbin/rotate-kvm-logs.sh","type":"MODIFIED","insertions":21,"deletions":-1}],"sizeInsertions":21,"sizeDeletions":-1},{"number":"5","revision":"1d55b897d363f99cb7d4070166ca9433f0c14274","parents":["76abff3cfdad511f7d0bfe57c1a2b5913afc7b5b"],"ref":"refs/changes/86/1786/5","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1511333093,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1511333134,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1511575549,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1511371984,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1511371984,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/vm/sbin/rotate-kvm-logs.sh","type":"MODIFIED","insertions":21,"deletions":-1}],"sizeInsertions":21,"sizeDeletions":-1}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}]}