From d7e11aa0851fe033e86d4dee762a2e94430bc90f Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Wed, 12 Oct 2016 12:05:24 -0700
Subject: [PATCH] MANTA-3002 muskie should use cueball for mahi connections

---
 main.js                        |  8 ++++++++
 package.json                   |  3 ++-
 sapi_manifests/muskie/template | 17 +++++++++++++++++
 3 files changed, 27 insertions(+), 1 deletion(-)

diff --git a/main.js b/main.js
index fdd8181..e467457 100644
--- a/main.js
+++ b/main.js
@@ -28,6 +28,7 @@ var restify = require('restify');
 var vasync = require('vasync');
 var medusa = require('./lib/medusa');
 var keyapi = require('keyapi');
+var cueball = require('cueball');
 
 var app = require('./lib');
 
@@ -48,6 +49,7 @@ var LOG = bunyan.createLogger({
     } ],
     serializers: restify.bunyan.serializers
 });
+var AGENT;
 var MAHI;
 var MARLIN;
 var KEYAPI;
@@ -200,6 +202,10 @@ function usage(parser, message)
     process.exit(2);
 }
 
+function createCueballHttpAgent(cfg) {
+    AGENT = new cueball.HttpAgent(cfg);
+}
+
 function createPickerClient(cfg) {
     var opts = {
         connectTimeout: cfg.connectTimeout,
@@ -251,6 +257,7 @@ function createAuthCacheClient(options) {
     options.log = log;
 
     options.typeTable = options.typeTable || apertureConfig.typeTable || {};
+    options.agent = AGENT;
 
     MAHI = mahi.createClient(options);
 }
@@ -396,6 +403,7 @@ function version() {
 (function main() {
     var cfg = configure();
 
+    createCueballHttpAgent(cfg.cueballHttpAgent);
     createMarlinClient(cfg.marlin);
     createPickerClient(cfg.storage);
     createAuthCacheClient(cfg.auth);
diff --git a/package.json b/package.json
index 92996ea..ef1f6c2 100644
--- a/package.json
+++ b/package.json
@@ -14,6 +14,7 @@
         "backoff": "2.3.0",
         "bunyan": "0.22.1",
         "bunyan-syslog": "0.2.2",
+        "cueball": "1.1.1",
         "dashdash": "1.3.2",
         "deep-equal": "0.0.0",
         "dtrace-provider": "0.2.8",
@@ -24,7 +25,7 @@
         "libuuid": "0.1.2",
         "lru-cache": "2.3.1",
         "lstream": "0.0.4",
-        "mahi": "git+ssh://git@github.com:joyent/node-mahi.git#master",
+        "mahi": "2.0.1",
         "marlin": "git+ssh://git@github.com:joyent/manta-marlin.git#master",
         "mime": "1.2.11",
         "moray": "git+ssh://git@github.com:joyent/node-moray.git#master",
diff --git a/sapi_manifests/muskie/template b/sapi_manifests/muskie/template
index 2ad4ca3..a663967 100644
--- a/sapi_manifests/muskie/template
+++ b/sapi_manifests/muskie/template
@@ -31,6 +31,23 @@
       "expiry": 30
     }
   },
+  "cueballHttpAgent": {
+    "resolver": ["nameservice.{{DOMAIN_NAME}}"],
+    "initialDomains": [
+      "{{AUTH_SERVICE}}"
+    ],
+    "spares": 4,
+    "maximum": 20,
+    "recovery": {
+      "default": {
+        "timeout": 2000,
+        "maxTimeout": 10000,
+        "retries": 5,
+        "delay": 250,
+        "maxDelay": 2000
+      }
+    }
+  },
   "medusa": {
     "moray": {
       "host": "{{ELECTRIC_MORAY}}",
-- 
2.21.0

