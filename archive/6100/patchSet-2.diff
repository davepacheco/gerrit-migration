From 37eecc30418067ec5ba43f76f4af5d5c505fe007 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <jwilsdon@joyent.com>
Date: Thu, 11 Apr 2019 11:03:55 -0700
Subject: [PATCH] OS-7735 vmadmd should not break and go into maintenance when
 a VM exists that had a delete failure

---
 src/vm/node_modules/VM.js | 9 +++++++++
 src/vm/sbin/vmadmd.js     | 8 ++++++++
 2 files changed, 17 insertions(+)

diff --git a/src/vm/node_modules/VM.js b/src/vm/node_modules/VM.js
index 683fa2fe..30c25b74 100644
--- a/src/vm/node_modules/VM.js
+++ b/src/vm/node_modules/VM.js
@@ -16860,6 +16860,15 @@ exports.update = function (uuid, payload, options, callback)
                     }
                 }
 
+                if (disks.length === 0) {
+                    log.info({
+                        brand: vmobj.brand,
+                        uuid: uuid
+                    }, 'no disks to create, skipping createVolumes');
+                    cb();
+                    return;
+                }
+
                 // add the bits of payload createVolumes() needs.
                 p = {
                     add_disks: disks,
diff --git a/src/vm/sbin/vmadmd.js b/src/vm/sbin/vmadmd.js
index 4a8b3213..4d293465 100755
--- a/src/vm/sbin/vmadmd.js
+++ b/src/vm/sbin/vmadmd.js
@@ -2606,6 +2606,14 @@ function main()
                                 }
                             }
 
+                            if (upgrade_payload.update_nics.length === 0) {
+                                log.debug({
+                                    vm_uuid: vmobj.uuid
+                                }, 'no nics to update, skipping VM.update()');
+                                finishUpgrade(vmobj);
+                                return;
+                            }
+
                             log.info('updating ' + vmobj.uuid + ' with: '
                                 + JSON.stringify(upgrade_payload));
 
-- 
2.21.0

