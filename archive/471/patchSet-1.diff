From e28f1bbf654cd0a315b027324b6799fc454ab18f Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Thu, 15 Sep 2016 16:02:21 +0000
Subject: [PATCH] FWAPI-257 Upgrading a CN set up before June 2013 broken by
 FWAPI-239

---
 src/fw/lib/locker.js | 32 +++++++++++++++++++++++++++++++-
 1 file changed, 31 insertions(+), 1 deletion(-)

diff --git a/src/fw/lib/locker.js b/src/fw/lib/locker.js
index 01450ace..0a181372 100644
--- a/src/fw/lib/locker.js
+++ b/src/fw/lib/locker.js
@@ -32,13 +32,43 @@ var mod_lockfd = require('lockfd');
 
 // --- Globals
 
+var FW_DIR_PATH = '/var/fw';
 var FW_LOCK_FILE = '/var/fw/.lockfile';
+var FW_MODE = 0755;
 
 
 // --- Internal functions
 
+
+/**
+ * Opening the lock file should normally be fine, but in the odd event that we
+ * are trying for the first time on a system initially set up with a pre-June
+ * 2013 platform, when the /var/fw directory started shipping with the platform,
+ * and there've never been any rules on this system, then we need to take care
+ * of creating the directory.
+ */
+function tryOpen(callback) {
+    fs.open(FW_LOCK_FILE, 'w+', FW_MODE, function (err, fd) {
+        if (!err || err.code !== 'ENOENT') {
+            callback(err, fd);
+            return;
+        }
+
+        try {
+            fs.mkdirSync(FW_DIR_PATH, FW_MODE);
+            fd = fs.openSync(FW_LOCK_FILE, 'w+', FW_MODE);
+        } catch (_) {
+            callback(err);
+            return;
+        }
+
+        callback(null, fd);
+    });
+}
+
+
 function acquireLock(operation, callback) {
-    fs.open(FW_LOCK_FILE, 'w+', function (err, fd) {
+    tryOpen(function (err, fd) {
         if (err) {
             callback(err);
             return;
-- 
2.21.0

