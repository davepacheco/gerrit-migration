From 612b0d734be50e424bf477b99c63eecae23ec3a5 Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Sat, 19 Aug 2017 00:30:38 +0000
Subject: [PATCH] MANTA-3368 MPU commit does not return the computed MD5

---
 lib/uploads/commit.js   |  1 +
 package.json            |  4 +--
 test/mpu/commit.test.js | 59 +++++++++++++++++++++++++++++++++++++++++
 test/mpu/helper.js      |  4 +--
 4 files changed, 64 insertions(+), 4 deletions(-)

diff --git a/lib/uploads/commit.js b/lib/uploads/commit.js
index a3976d2..9b60375 100644
--- a/lib/uploads/commit.js
+++ b/lib/uploads/commit.js
@@ -519,6 +519,7 @@ function commit(req, res, next) {
             }, 'commit: completed');
 
             res.setHeader('Location', p);
+            res.setHeader('Computed-MD5', md5);
             res.send(201);
             next();
         }
diff --git a/package.json b/package.json
index b255931..ea869c3 100644
--- a/package.json
+++ b/package.json
@@ -34,7 +34,7 @@
         "moray": "3.1.1",
         "once": "1.3.0",
         "restify": "2.6.3",
-        "vasync": "1.4.3",
+        "vasync": "^1.5.0",
         "verror": "^1.9.0",
         "watershed": "0.3.0",
         "xtend": "2.1.1"
@@ -42,7 +42,7 @@
     "devDependencies": {
         "smartdc": "7.3.1",
         "strsplit": "1.0.0",
-        "manta": "4.3.0",
+        "manta": "4.5.0",
         "nodeunit": "0.9.1",
         "node-uuid": "1.4.1"
     },
diff --git a/test/mpu/commit.test.js b/test/mpu/commit.test.js
index d968219..1d76314 100644
--- a/test/mpu/commit.test.js
+++ b/test/mpu/commit.test.js
@@ -113,6 +113,65 @@ test('commit upload: one part', function (t) {
     });
 });
 
+test('commit upload: commit content md5 match', function (t) {
+    var self = this;
+    vasync.waterfall([
+        function (callback) {
+            self.createUpload(self.path, null, function (err) {
+                if (ifErr(t, err, 'created upload')) {
+                    callback(err);
+                } else {
+                    callback(null);
+                }
+            });
+        },
+        function (callback) {
+            self.writeTestObject(self.uploadId, 0, function (err, res) {
+                if (ifErr(t, err, 'uploaded part')) {
+                    callback(err);
+                } else {
+                    t.ok(res);
+                    t.checkResponse(res, 204);
+                    callback(null, res.headers.etag);
+                }
+            });
+        },
+        function (etag, callback) {
+            self.commitUpload(self.uploadId, [etag], function (err, res) {
+                if (ifErr(t, err, 'commited upload')) {
+                    callback(err);
+                } else {
+                    t.ok(res);
+                    t.ok(res.headers);
+                    t.ok(res.headers['computed-md5']);
+                    if (res === undefined || res.headers == undefined) {
+                        callback(new Error('commit upload missing res'));
+                        return;
+                    }
+                    callback(null, res.headers['computed-md5']);
+                }
+            });
+        },
+        function (computedMd5, callback) {
+            self.client.info(self.path, function (err, info) {
+                if (ifErr(t, err, 'got object info')) {
+                    callback(err);
+                } else {
+                    t.ok(info, 'failed to get object info');
+                    if (info) {
+                        var headers = info.headers || {};
+                        t.equal(computedMd5, helper.TEXT_MD5);
+                        t.equal(computedMd5, headers['content-md5']);
+                    }
+                    callback(null);
+                }
+            });
+        }
+    ], function () {
+        t.end();
+    });
+});
+
 
 test('commit upload: already commited, same set of parts', function (t) {
     var self = this;
diff --git a/test/mpu/helper.js b/test/mpu/helper.js
index 7a71f53..06d07bf 100644
--- a/test/mpu/helper.js
+++ b/test/mpu/helper.js
@@ -337,12 +337,12 @@ function commitUploadHelper(id, etags, subuser, cb) {
         account: self.client.user
     };
 
-    client.commitUpload(id, etags, opts, function (err) {
+    client.commitUpload(id, etags, opts, function (err, res) {
         if (err) {
             cb(err);
         } else {
             self.uploadFinalized = true;
-            cb();
+            cb(null, res);
         }
     });
 }
-- 
2.21.0

