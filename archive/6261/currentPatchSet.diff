From 0fbd8f79e6f8f5b53671c17618341d15a3a7bcaa Mon Sep 17 00:00:00 2001
From: Mike Gerdts <mike.gerdts@joyent.com>
Date: Wed, 15 May 2019 22:23:03 +0000
Subject: [PATCH] OS-5176 vmadm stop and reboot may propagate improper error

---
 src/vm/node_modules/VM.js | 29 ++++++++++++++---------------
 1 file changed, 14 insertions(+), 15 deletions(-)

diff --git a/src/vm/node_modules/VM.js b/src/vm/node_modules/VM.js
index f8431444..9f5ffbac 100644
--- a/src/vm/node_modules/VM.js
+++ b/src/vm/node_modules/VM.js
@@ -17487,26 +17487,27 @@ function doShutdownStop(vmobj, options, callback)
             .features.shutdown_cmd.split(' '));
     }
     async.series([
-        function (cb) {
+        function zloginShutdown(cb) {
             traceExecFile('/usr/sbin/zlogin', args, log, 'zlogin-shutdown',
                 function (err, stdout, stderr) {
 
                 if (err) {
-                    log.error({
+                    log.info({
                         err: err,
                         stdout: stdout,
                         stderr: stderr
-                    }, 'zlogin for ' + vmobj.zonename + ' exited with code '
-                        + err.code + ': ' + err.message);
-                    cb(err);
-                    return;
+                    }, 'Ignoring error: zlogin for ' + vmobj.zonename
+                        + ' exited with code ' + err.code + ': ' + err.message);
+                } else {
+                    log.debug({stdout: stdout, stderr: stderr},
+                        'zlogin claims to have worked');
                 }
-
-                log.debug({stdout: stdout, stderr: stderr},
-                    'zlogin claims to have worked');
                 cb();
             });
-        }, function (cb) {
+        }, function waitInstalled(cb) {
+            exports.waitForZoneState(vmobj, 'installed',
+                {timeout: STOP_TIMEOUT}, cb);
+        }, function zonecfgNoAutoboot(cb) {
             zonecfg(vmobj.uuid, [unset_autoboot], {log: log},
                 function (err, fds) {
 
@@ -18037,12 +18038,10 @@ function doReboot(vmobj, options, callback)
             traceExecFile('/usr/sbin/zlogin', args, log, 'zlogin-shutdown',
                 function (err, stdout, stderr) {
                 if (err) {
-                    log.error({'err': err, 'stdout': stdout,
-                        'stderr': stderr}, 'zlogin for ' + vmobj.zonename
-                        + ' exited with code' + err.code + ': '
+                    log.info({'err': err, 'stdout': stdout,
+                        'stderr': stderr}, 'Ignoring error: zlogin for '
+                        + vmobj.zonename + ' exited with code' + err.code + ': '
                         + err.message);
-                    cb(err);
-                    return;
                 }
                 cb();
             });
-- 
2.21.0

