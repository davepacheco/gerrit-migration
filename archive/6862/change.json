{"project":"joyent/illumos-joyent","branch":"master","id":"I1cc204b97b9317e681958da0e91abeb27bcc6f82","number":"6862","subject":"OS-7975 bhyve should require exactly one primary nic Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Approved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e","owner":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"url":"https://cr.joyent.us/6862","commitMessage":"OS-7975 bhyve should require exactly one primary nic\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nApproved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\n","createdOn":1567496484,"lastUpdated":1567718019,"open":false,"status":"MERGED","comments":[{"timestamp":1567496484,"reviewer":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"message":"Uploaded patch set 1."},{"timestamp":1567519442,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1567572397,"reviewer":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1567572436,"reviewer":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"message":"Uploaded patch set 2."},{"timestamp":1567602991,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1567609793,"reviewer":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1567611319,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1567638405,"reviewer":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"message":"Uploaded patch set 3."},{"timestamp":1567638450,"reviewer":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1567684896,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3:\n\n(1 comment)\n\nAlmost there!  :)"},{"timestamp":1567693382,"reviewer":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1567693401,"reviewer":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"message":"Uploaded patch set 4."},{"timestamp":1567693672,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4: Code-Review+1\n\nLooks great!  Once you have verified that you have a clean build with this latest code and that it still works as intended, I\u0027ll +1 the IA."},{"timestamp":1567706038,"reviewer":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"message":"Patch Set 4:\n\nUpdated OS-7975 with the testing information."},{"timestamp":1567716725,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1567717980,"reviewer":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1567718019,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Mohamed Khalfella"}],"currentPatchSet":{"number":"5","revision":"1cc204b97b9317e681958da0e91abeb27bcc6f82","parents":["5a02003f48844ffada03336634b28edaff8574ec"],"ref":"refs/changes/62/6862/5","uploader":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"createdOn":1567717980,"author":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1567693672,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1567716725,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"SUBM","value":"1","grantedOn":1567718019,"by":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":9,"deletions":-2}],"sizeInsertions":9,"sizeDeletions":-2},"patchSets":[{"number":"1","revision":"861e2bea0241d39e9483a985a227374efa12cdf1","parents":["85cbce56b9ab1ce24ffeab318cb4c2b3ac67023c"],"ref":"refs/changes/62/6862/1","uploader":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"createdOn":1567496484,"author":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/lib/brand/bhyve/zone/boot.c","line":400,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"This behavior is not consistent with vmadm(1M).\n\n       nics.*.primary\n\n           This option selects which NICÂ´s default gateway and nameserver values\n           will be used for this VM. If a VM has any nics, there must always be\n           exactly one primary.  Setting a new primary will unset the old. Trying\n           to set two nics to primary is an error.\n\nIf none of the NICs has primary\u003dtrue, we should print an error and return -1.\n\nIf we use pick a NIC (likely first or last), it would seem the order is deterministic.  However, adding or removing a NIC or even changing properties on NICs could cause the order of the NICs to change.  This would mean that changing some property (e.g. mtu) could cause an unexplained change in the routing behavior of the instance.  While loosening the existing rules could be convenient in some cases, it leads to other cases where we would be better off \"failing fast\"."},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","line":400,"reviewer":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"message":"Thank you Mike for the detailed feedback. I have updated the code to fail if no primary interface has been specified."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":13,"deletions":-5}],"sizeInsertions":13,"sizeDeletions":-5},{"number":"2","revision":"ddde3927c85ec3c418681c58f0b8e4fd5ad4d88d","parents":["1ed9823d08fd2b08c4d4f0d9a57075899d36b295"],"ref":"refs/changes/62/6862/2","uploader":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"createdOn":1567572436,"author":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/lib/brand/bhyve/zone/boot.c","line":400,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"A single \"primary\" net is required."},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","line":400,"reviewer":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"message":"I kind of agree with you in changing this comment. However, if we put this way, it means no one can provision an instance _without_ network interfaces. I don\u0027t know how an instance like this would be useful, but I _think_ the system should allow the user to do it."},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","line":400,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"fair"},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","line":434,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Rather than the changes above (380, 393, 427 - 432), you could put a single check outside the for loop.\n\nif (primary \u003d\u003d NULL) { /* error, return -1 */ }"},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","line":434,"reviewer":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"message":"If we put it outside the loop, the user won\u0027t be able to provision an instance without network interfaces."},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","line":434,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Doesn\u0027t the check at 386 handle this case?  Does it need to also strcmp(nets, \"\") to check for an environment variable that is present but contains an empty list?"},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","line":434,"reviewer":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"message":"the check in 386 doesn\u0027t handle the case when nets is an empty string. I added strcmp(nets, \"\") as you suggested, and took the primary check outside the loop."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":12,"deletions":-3}],"sizeInsertions":12,"sizeDeletions":-3},{"number":"3","revision":"1cf3da4aed257f7404051fe18cc3cef58b7b4b96","parents":["245c8cb8fe488fd25dea7e61885def4612759829"],"ref":"refs/changes/62/6862/3","uploader":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"createdOn":1567638405,"author":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/lib/brand/bhyve/zone/boot.c","line":430,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"This will now fit on one line - no need to split the string."},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","line":430,"reviewer":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"message":"fixed."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":10,"deletions":-2}],"sizeInsertions":10,"sizeDeletions":-2},{"number":"4","revision":"65294ed2cdc03ab5daf93b7ad97f0683063b1e01","parents":["5a02003f48844ffada03336634b28edaff8574ec"],"ref":"refs/changes/62/6862/4","uploader":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"createdOn":1567693401,"author":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1567693672,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1567716725,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":9,"deletions":-2}],"sizeInsertions":9,"sizeDeletions":-2},{"number":"5","revision":"1cc204b97b9317e681958da0e91abeb27bcc6f82","parents":["5a02003f48844ffada03336634b28edaff8574ec"],"ref":"refs/changes/62/6862/5","uploader":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"createdOn":1567717980,"author":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1567693672,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1567716725,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"SUBM","value":"1","grantedOn":1567718019,"by":{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":9,"deletions":-2}],"sizeInsertions":9,"sizeDeletions":-2}],"allReviewers":[{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Mohamed Khalfella","email":"khalfella@gmail.com","username":"khalfella"}]}