commit 33f15c2b03233e3baab16ac9ec2ef7444f22daef (refs/changes/75/4975/1)
Author: Rui Loura <rui@joyent.com>
Date:   2018-10-18T17:18:37+00:00 (12 months ago)
    
    TRITON-841 Add “Admin IP” and “admin_ip” to sysinfo output

diff --git a/src/node_modules/net-boot-config.js b/src/node_modules/net-boot-config.js
index 2c1842b5..b5429e86 100644
--- a/src/node_modules/net-boot-config.js
+++ b/src/node_modules/net-boot-config.js
@@ -214,6 +214,15 @@ function configValues(callback) {
             if (nic.ip) {
                 vals[iface + '_ip'] = nic.ip;
                 ipKeys.push(iface + '_ip');
+
+                /*
+                 * The net-physical script will plumb all IPs assigned to
+                 * variables of the format <interface>_ip.  So we use
+                 * "admin_ipaddr" here.
+                 */
+                if (tag === admin_tag) {
+                    vals.admin_ipaddr = nic.ip;
+                }
             }
 
             if (nic.gateway) {
diff --git a/src/sysinfo b/src/sysinfo
index 8f1a3f72..efbc959c 100644
--- a/src/sysinfo
+++ b/src/sysinfo
@@ -546,6 +546,12 @@ function get_admin_nic_tag()
     eval "Admin_NIC_Tag=${fields[1]}"
 }
 
+function get_admin_ip()
+{
+    prop=$(net_conf_grep "^admin_ipaddr=")
+    fields=(${prop//=/ })
+    eval "Admin_IP=${fields[1]}"
+}
 
 function get_nic_tags()
 {
@@ -696,6 +702,7 @@ Bhyve_Max_Vcpus=${Bhyve_Max_Vcpus}
 HVM_API='${HVM_API}'
 Nic_Tags=${NicTagList}
 Admin_NIC_Tag=${Admin_NIC_Tag}
+Admin_IP=${Admin_IP}
 Setup='${Setup_complete}'
 END
     else
@@ -834,6 +841,7 @@ END
   "CPU Virtualization": "${CPU_Virtualization}",
   "CPU Physical Cores": ${CPU_Count},
   "Admin NIC Tag": "${Admin_NIC_Tag}",
+  "Admin IP": "${Admin_IP}",
 END
     else
         echo "  \"ZFS Quota\": \"${QUOTA}\","
@@ -1025,6 +1033,7 @@ get_system_type
 get_hostname
 get_aggregation_mappings
 get_overlay_nic_tags
+get_admin_ip
 get_admin_nic_tag
 get_nic_tags
 get_smartos_network_interfaces
