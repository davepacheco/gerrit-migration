{"project":"joyent/illumos-joyent","branch":"master","id":"I6c1c2b4046b9166c9fc628449fc1c48808710d46","number":"6948","subject":"OS-8007 want PORT_SOURCE_DEVICE for device-specific port events","owner":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"url":"https://cr.joyent.us/6948","commitMessage":"OS-8007 want PORT_SOURCE_DEVICE for device-specific port events\n","createdOn":1569940635,"lastUpdated":1570642548,"open":true,"status":"NEW","comments":[{"timestamp":1569940635,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 1."},{"timestamp":1570642548,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(12 comments)"}],"currentPatchSet":{"number":"1","revision":"6c1c2b4046b9166c9fc628449fc1c48808710d46","parents":["e8ca64c9181e83f77a26f216e68e0ad8407a94c0"],"ref":"refs/changes/48/6948/1","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1569940635,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/man/man3c/port_associate.3c","line":159,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"nit, s/in in/in /"},{"file":"usr/src/man/man3c/port_create.3c","line":109,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I\u0027m unclear on the fork semantics of device ports, given that we cache the pid. For example, a child can\u0027t dissociate a port."},{"file":"usr/src/uts/common/fs/portfs/port.c","line":85,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"this is missing PORT_SOURCE_DEV"},{"file":"usr/src/uts/common/fs/portfs/port.c","line":194,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"this is missing PORT_SOURCE_DEV"},{"file":"usr/src/uts/common/fs/portfs/port.c","line":239,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"this is missing PORT_SOURCE_DEV"},{"file":"usr/src/uts/common/fs/portfs/port_dev.c","line":19,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"We could do with a rationale here: I\u0027m guessing something just pointing out that poll+ioctl means a lot of hand-written infrastructure better served by a port source"},{"file":"usr/src/uts/common/fs/portfs/port_dev.c","line":99,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"nit, missing space after \u0027the\u0027"},{"file":"usr/src/uts/common/fs/portfs/port_dev.c","line":157,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"the naming here is pretty confusing:\n\nport_dev_hash_get() - get the hash table\nport_dev_hash_destroy() - destroy the hash table\nport_dev_hash_delete() - internal helper to remove an *item* from the hash\nport_dev_hash_find*() - find an *item* in the hash\nport_dev_hash_insert() - insert an item into the hash\n\nCould we maybe rename the first two? port_dev_hashtable_ maybe? Or remove _hash_ from the others?"},{"file":"usr/src/uts/common/fs/portfs/port_dev.c","line":210,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"it\u0027s kind of nasty that we have to manage our own lists here. \nWhy aren\u0027t we using mod_hash_create_extended() with a key type of object+pid ?"},{"file":"usr/src/uts/common/fs/portfs/port_dev.c","line":380,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I\u0027m not following the \"sizeof (port_dev_t *)\" here, is that from a previous version?"},{"file":"usr/src/uts/common/fs/portfs/port_dev.c","line":644,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"We don\u0027t hold the device in any way while we have active\nassociations. What is stopping the device from detaching here while such ports are active? Can\u0027t -\u003ep_ops become stale then?\n\nBasically, I don\u0027t understand the relationship between a particular driver\u0027s minor device lifetime, and the lifetime of a particular port associated with it, and the user objects associated on top."},{"file":"usr/src/uts/common/os/port_subr.c","line":522,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"This was changed, but :536 and co wasn\u0027t. Can we do one or the either, and get rid of :517-:518"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/man/man3c/port_associate.3c","type":"MODIFIED","insertions":49,"deletions":-7},{"file":"usr/src/man/man3c/port_create.3c","type":"MODIFIED","insertions":14,"deletions":-5},{"file":"usr/src/uts/common/fs/portfs/port.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/fs/portfs/port_dev.c","type":"ADDED","insertions":653,"deletions":0},{"file":"usr/src/uts/common/fs/portfs/port_fop.c","type":"MODIFIED","insertions":10,"deletions":-35},{"file":"usr/src/uts/common/os/port_subr.c","type":"MODIFIED","insertions":30,"deletions":-4},{"file":"usr/src/uts/common/sys/port.h","type":"MODIFIED","insertions":17,"deletions":-2},{"file":"usr/src/uts/common/sys/port_kernel.h","type":"MODIFIED","insertions":39,"deletions":-3},{"file":"usr/src/uts/intel/portfs/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/sparc/portfs/Makefile","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":825,"sizeDeletions":-59},"patchSets":[{"number":"1","revision":"6c1c2b4046b9166c9fc628449fc1c48808710d46","parents":["e8ca64c9181e83f77a26f216e68e0ad8407a94c0"],"ref":"refs/changes/48/6948/1","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1569940635,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/man/man3c/port_associate.3c","line":159,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"nit, s/in in/in /"},{"file":"usr/src/man/man3c/port_create.3c","line":109,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I\u0027m unclear on the fork semantics of device ports, given that we cache the pid. For example, a child can\u0027t dissociate a port."},{"file":"usr/src/uts/common/fs/portfs/port.c","line":85,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"this is missing PORT_SOURCE_DEV"},{"file":"usr/src/uts/common/fs/portfs/port.c","line":194,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"this is missing PORT_SOURCE_DEV"},{"file":"usr/src/uts/common/fs/portfs/port.c","line":239,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"this is missing PORT_SOURCE_DEV"},{"file":"usr/src/uts/common/fs/portfs/port_dev.c","line":19,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"We could do with a rationale here: I\u0027m guessing something just pointing out that poll+ioctl means a lot of hand-written infrastructure better served by a port source"},{"file":"usr/src/uts/common/fs/portfs/port_dev.c","line":99,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"nit, missing space after \u0027the\u0027"},{"file":"usr/src/uts/common/fs/portfs/port_dev.c","line":157,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"the naming here is pretty confusing:\n\nport_dev_hash_get() - get the hash table\nport_dev_hash_destroy() - destroy the hash table\nport_dev_hash_delete() - internal helper to remove an *item* from the hash\nport_dev_hash_find*() - find an *item* in the hash\nport_dev_hash_insert() - insert an item into the hash\n\nCould we maybe rename the first two? port_dev_hashtable_ maybe? Or remove _hash_ from the others?"},{"file":"usr/src/uts/common/fs/portfs/port_dev.c","line":210,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"it\u0027s kind of nasty that we have to manage our own lists here. \nWhy aren\u0027t we using mod_hash_create_extended() with a key type of object+pid ?"},{"file":"usr/src/uts/common/fs/portfs/port_dev.c","line":380,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I\u0027m not following the \"sizeof (port_dev_t *)\" here, is that from a previous version?"},{"file":"usr/src/uts/common/fs/portfs/port_dev.c","line":644,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"We don\u0027t hold the device in any way while we have active\nassociations. What is stopping the device from detaching here while such ports are active? Can\u0027t -\u003ep_ops become stale then?\n\nBasically, I don\u0027t understand the relationship between a particular driver\u0027s minor device lifetime, and the lifetime of a particular port associated with it, and the user objects associated on top."},{"file":"usr/src/uts/common/os/port_subr.c","line":522,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"This was changed, but :536 and co wasn\u0027t. Can we do one or the either, and get rid of :517-:518"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/man/man3c/port_associate.3c","type":"MODIFIED","insertions":49,"deletions":-7},{"file":"usr/src/man/man3c/port_create.3c","type":"MODIFIED","insertions":14,"deletions":-5},{"file":"usr/src/uts/common/fs/portfs/port.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/fs/portfs/port_dev.c","type":"ADDED","insertions":653,"deletions":0},{"file":"usr/src/uts/common/fs/portfs/port_fop.c","type":"MODIFIED","insertions":10,"deletions":-35},{"file":"usr/src/uts/common/os/port_subr.c","type":"MODIFIED","insertions":30,"deletions":-4},{"file":"usr/src/uts/common/sys/port.h","type":"MODIFIED","insertions":17,"deletions":-2},{"file":"usr/src/uts/common/sys/port_kernel.h","type":"MODIFIED","insertions":39,"deletions":-3},{"file":"usr/src/uts/intel/portfs/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/sparc/portfs/Makefile","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":825,"sizeDeletions":-59}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}]}