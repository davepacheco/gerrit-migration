From e924c3f58949eb3fa1092abf292caeefa94186e9 Mon Sep 17 00:00:00 2001
From: Julien Gilli <julien.gilli@joyent.com>
Date: Wed, 13 Sep 2017 16:49:22 -0400
Subject: [PATCH] VOLAPI-80 tools/setup/setup.sh should support upgrading core
 services to versions built from master

---
 tools/setup/setup.sh | 18 ++++++++++++++----
 1 file changed, 14 insertions(+), 4 deletions(-)

diff --git a/tools/setup/setup.sh b/tools/setup/setup.sh
index 84b74df..cefca55 100644
--- a/tools/setup/setup.sh
+++ b/tools/setup/setup.sh
@@ -216,10 +216,15 @@ function get_latest_img_uuid
 {
     local image_name=$1
     local branch_pattern=$2
+    local update_channel_name="dev"
     local latest_branch_img_uuid
 
+    if [ "$branch_pattern" != "master" ]; then
+        update_channel_name="experimental"
+    fi
+
     latest_branch_img_uuid=$(/opt/smartdc/bin/updates-imgadm -H -C \
-        experimental list name=$image_name | grep $branch_pattern | \
+        "$update_channel_name" list name=$image_name | grep $branch_pattern | \
         tail -1 | cut -d ' ' -f 1)
 
     echo "$latest_branch_img_uuid"
@@ -229,15 +234,20 @@ function upgrade_core_service_to_latest_branch_image
 {
     local core_service_name=$1
     local branch_name=$2
-
+    local update_channel_name="dev"
     local latest_img_uuid
 
     echo "Making sure $core_service_name core zone is up to date..."
 
+    if [ "$branch_name" != "master" ]; then
+        update_channel_name="experimental"
+    fi
+
     latest_img_uuid=$(get_latest_img_uuid "$core_service_name" "$branch_name")
     if [ "x$latest_img_uuid" != "x" ]; then
         echo "Updating $core_service_name to image ${latest_img_uuid}"
-        sdcadm up -y -C experimental "$core_service_name@$latest_img_uuid"
+        sdcadm up -y -C "$update_channel_name" \
+            "$core_service_name@$latest_img_uuid"
     else
         fatal "Could not find latest $core_service_name version built from"\
             "branch $branch_name"
@@ -291,7 +301,7 @@ upgrade_core_service_to_latest_branch_image "cloudapi" "tritonnfs"
 
 # The VOLAPI service may have been already enabled by "sdcadm experimental
 # volapi" but the VOLAPI zone may need to be updated to the latest version.
-upgrade_core_service_to_latest_branch_image "volapi" "tritonnfs"
+upgrade_core_service_to_latest_branch_image "volapi" "master"
 
 # Needed to add additional programs in the HN's GZ, such as sdc-volapi
 upgrade_gz_tools_to_latest_branch_image tritonnfs
-- 
2.21.0

