commit 03331581d74ae37a8878dddcd006986a60d5f669 (refs/changes/18/1818/2)
Author: David Pacheco <dap@joyent.com>
Date:   2017-04-24T16:54:56-07:00 (2 years, 5 months ago)
    
    MANTA-3224 authcache crashes on malformed requests

diff --git a/docs/index.md b/docs/index.md
index a85db17..29aff7d 100644
--- a/docs/index.md
+++ b/docs/index.md
@@ -9,7 +9,7 @@ apisections: Task Control API
     file, You can obtain one at http://mozilla.org/MPL/2.0/.
 -->
 <!--
-    Copyright (c) 2014, Joyent, Inc.
+    Copyright (c) 2017, Joyent, Inc.
 -->
 
 # Mahi
@@ -41,6 +41,7 @@ The account object.
 | Code | HTTP Status Code | Description |
 | ---- | ---------------- | ----------- |
 | AccountDoesNotExistError | 404 | No account exists with the given login |
+| BadRequestError | 400 | "login" was not specified |
 | RedisError | 500 | Error contacting redis |
 
 ### Example
@@ -147,6 +148,7 @@ The user object.
 | Code | HTTP Status Code | Description |
 | ---- | ---------------- | ----------- |
 | AccountDoesNotExistError | 404 | No account exists with the given account login |
+| BadRequestError | 400 | "account" or "login" was not specified |
 | UserDoesNotExistError | 404 | No user with the given login exists under the given account |
 | RedisError | 500 | Error contacting redis |
 
@@ -339,6 +341,7 @@ name. Check for undefined.
 | Code | HTTP Status Code | Description |
 | ---- | ---------------- | ----------- |
 | AccountDoesNotExist | 404 | No account exists with the given login |
+| BadRequestError | 400 | "account" was not specified |
 | RedisError | 500 | Error contacting redis |
 
 ### Examples
diff --git a/lib/server/server.js b/lib/server/server.js
index 33a562d..e1c8031 100644
--- a/lib/server/server.js
+++ b/lib/server/server.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
@@ -263,6 +263,13 @@ function createServer(opts) {
 function getAccountUuid(req, res, next) {
     var account = req.params.account || req.params.login;
     req.log.debug({account: account}, 'getAccountUuid handler: entered');
+
+    if (!account) {
+        setImmediate(next,
+            new restify.BadRequestError('"account" is required'));
+        return;
+    }
+
     lib.getAccountUuid({
         account: account,
         log: req.log,
@@ -319,6 +326,12 @@ function getUserUuid(req, res, next) {
         accountid: accountUuid,
         user: user
     }, 'getUserUuid handler: entered');
+
+    if (!user) {
+        setImmediate(next, new restify.BadRequestError('"user" is required'));
+        return;
+    }
+
     lib.getUuid({
         accountUuid: accountUuid,
         name: user,
@@ -390,7 +403,9 @@ function getRoles(req, res, next) {
 
 function getName(req, res, next) {
     var uuids = req.params.uuid || /* deprecated */ req.params.uuids;
-    if (uuids && !Array.isArray(uuids)) {
+    if (!uuids) {
+        uuids = [];
+    } else if (!Array.isArray(uuids)) {
         uuids = [uuids];
     }
     req.log.debug({uuids: uuids}, 'getName handler: entered');
@@ -450,6 +465,12 @@ function getUuid(req, res, next) {
         names: names
     }, 'getUuid handler: entered');
 
+    if (!account) {
+        setImmediate(next,
+            new restify.BadRequestError('"account" is required'));
+        return;
+    }
+
     lib.getAccountUuid({
         account: account,
         log: req.log,
diff --git a/test/server.test.js b/test/server.test.js
index 8b7f69b..2f260a9 100644
--- a/test/server.test.js
+++ b/test/server.test.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 var Server = require('../lib/server/server.js').Server;
@@ -251,3 +251,43 @@ test('generate lookup', function (t) {
         t.end();
     });
 });
+
+test('/accounts: missing arguments', function (t) {
+    this.client.get('/accounts', function (err, req, res, obj) {
+        t.equal(err.restCode, 'BadRequestError');
+        t.equal(obj.code, 'BadRequestError');
+        t.end();
+    });
+});
+
+test('/users: missing argument (account)', function (t) {
+    this.client.get('/users', function (err, req, res, obj) {
+        t.equal(err.restCode, 'BadRequestError');
+        t.equal(obj.code, 'BadRequestError');
+        t.end();
+    });
+});
+
+test('/users: missing argument (user)', function (t) {
+    this.client.get('/users?account=banks', function (err, req, res, obj) {
+        t.equal(err.restCode, 'BadRequestError');
+        t.equal(obj.code, 'BadRequestError');
+        t.end();
+    });
+});
+
+test('/names: missing arguments', function (t) {
+    this.client.get('/names', function (err, req, res, obj) {
+        t.ok(!err);
+        t.deepEqual(obj, {});
+        t.end();
+    });
+});
+
+test('/uuids: missing arguments', function (t) {
+    this.client.get('/uuids', function (err, req, res, obj) {
+        t.equal(err.restCode, 'BadRequestError');
+        t.equal(obj.code, 'BadRequestError');
+        t.end();
+    });
+});
