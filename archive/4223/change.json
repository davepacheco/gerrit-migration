{"project":"joyent/illumos-joyent","branch":"master","id":"I88b7f8b0d2ce2d1d224879a20f7d36427c5b7707","number":"4223","subject":"OS-7012 bhyve wedged in vlapic cyclics OS-7016 vmx ctx ops should inform VMRESUME OS-6957 clean up unused mutex type from bhyve Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Reviewed by: Hans Rosenfeld \u003chans.rosenfeld@joyent.com\u003e Approved by: Hans Rosen","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/4223","commitMessage":"OS-7012 bhyve wedged in vlapic cyclics\nOS-7016 vmx ctx ops should inform VMRESUME\nOS-6957 clean up unused mutex type from bhyve\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nReviewed by: Hans Rosenfeld \u003chans.rosenfeld@joyent.com\u003e\nApproved by: Hans Rosenfeld \u003chans.rosenfeld@joyent.com\u003e\n","createdOn":1529007180,"lastUpdated":1536850902,"open":false,"status":"MERGED","comments":[{"timestamp":1529007180,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1529071666,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(2 comments)\n\nWith interrupts disabled:\n\nvmx_run-\u003evmx_inject_interrupts-\u003evatpic_pending_intr-\u003eVATPIC_LOCK()\nalso vatpic_intr_accepted\n\ncan now sleep."},{"timestamp":1529335787,"reviewer":{"name":"Max Bruning","email":"max@joyent.com","username":"max123"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1529346816,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\nThanks, jlevon, for pointing out those chains.  It looks like both the vATPIC and vCPU locks fall prey to that issue under vmx_inject_interrupts.  I\u0027m going to try to separate the vATPIC operations out, but it might require some serious rework."},{"timestamp":1529348660,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1: Code-Review-1"},{"timestamp":1531431286,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1531431292,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: -Code-Review"},{"timestamp":1532708537,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1533552769,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1533683655,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1533684287,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1533723566,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1533723593,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1535052788,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4."},{"timestamp":1535052987,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1535053121,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1535055365,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\nAdded some test notes to the jira ticket."},{"timestamp":1535696964,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1536811558,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1536811651,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1536850902,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"6","revision":"88b7f8b0d2ce2d1d224879a20f7d36427c5b7707","parents":["76683f77aeee2619b447d8ea5843399835fbc586"],"ref":"refs/changes/23/4223/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1536811651,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535053121,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535696964,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1535696964,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"SUBM","value":"1","grantedOn":1536850902,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"usr/src/compat/freebsd/sys/mutex.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":226,"deletions":-8},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.h","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":9,"deletions":-6}],"sizeInsertions":245,"sizeDeletions":-16},"patchSets":[{"number":"1","revision":"d1ed9208ef653173e3fdb2fb480b0a0601189da0","parents":["c2d375cdcb04122f97908079581dda41a08c0d07"],"ref":"refs/changes/23/4223/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1529007180,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1529348660,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/compat/freebsd/sys/mutex.h","line":36,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"thank you!"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","line":300,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I think it\u0027s worth noting that \"mtx_lock_spin()\" will degrade to adaptive lock in our wrappers. It\u0027s easy to see how that could confuse the casual browser."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","line":305,"reviewer":{"name":"Max Bruning","email":"max@joyent.com","username":"max123"},"message":"This assumes mtx_init is not called at high interrupt level.  May want to assert that it is not, or at least note it."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/compat/freebsd/sys/mutex.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":21,"deletions":-6},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.h","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":9,"deletions":-6}],"sizeInsertions":40,"sizeDeletions":-14},{"number":"2","revision":"19bc8f79c69a7fb2cfc5fa9b83ae64bed5dc3243","parents":["a14a61c954e512b21fc1be4a408e945f7f15df17"],"ref":"refs/changes/23/4223/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1531431286,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533552769,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"comments":[{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","line":1510,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Are we OK here to not re-read VMCS_ENTRY_INTR_INFO if we hit line 1478?\n\nIn this new version, you\u0027re effectively looking at entryinfo, and as per :1472, this *has* to have VMCS_INTR_VALID set?"},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","line":1510,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"In short, yes.  Any changes we make to VMCS_ENTRY_INTR_INFO after L1451 are done by updating the contents of \u0027info\u0027 and then writing it into the vmcs."},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","line":1510,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Hmm, so I suppose the logic is that if we do hit :1478, then it\u0027s OK to drop into the cantinject case, and hopefully take the pending intr from entryinfo before coming around again to catch the next one?"},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","line":1510,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Yeah.  The cantinject logic will kick us out of the VMX context as soon as possible after injecting the now-queued event."},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","line":1569,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"ditto"},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","line":1569,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"same as above"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/compat/freebsd/sys/mutex.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":227,"deletions":-7},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.h","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":9,"deletions":-6}],"sizeInsertions":246,"sizeDeletions":-15},{"number":"3","revision":"20a68e6971d49b8b363660d4f6a270531b4ab861","parents":["757454db6669c1186f60bc625510c1b67217aae6"],"ref":"refs/changes/23/4223/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1533684287,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533552769,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533723593,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/compat/freebsd/sys/mutex.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":227,"deletions":-7},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.h","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":9,"deletions":-6}],"sizeInsertions":246,"sizeDeletions":-15},{"number":"4","revision":"3156f0d9ba552c71c5678fd3303681e1d7900848","parents":["e79c50557fdcaf68635086f55afd817419c78661"],"ref":"refs/changes/23/4223/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1535052788,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535696964,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1535696964,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535053121,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/compat/freebsd/sys/mutex.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":226,"deletions":-8},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.h","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":9,"deletions":-6}],"sizeInsertions":245,"sizeDeletions":-16},{"number":"5","revision":"94c9191ab3da17761fd732e40d0da74df3be0a8a","parents":["76683f77aeee2619b447d8ea5843399835fbc586"],"ref":"refs/changes/23/4223/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1536811558,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535696964,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1535696964,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535053121,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/compat/freebsd/sys/mutex.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":226,"deletions":-8},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.h","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":9,"deletions":-6}],"sizeInsertions":245,"sizeDeletions":-16},{"number":"6","revision":"88b7f8b0d2ce2d1d224879a20f7d36427c5b7707","parents":["76683f77aeee2619b447d8ea5843399835fbc586"],"ref":"refs/changes/23/4223/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1536811651,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1536850902,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535696964,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1535696964,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535053121,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"usr/src/compat/freebsd/sys/mutex.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":226,"deletions":-8},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.h","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":9,"deletions":-6}],"sizeInsertions":245,"sizeDeletions":-16}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}]}