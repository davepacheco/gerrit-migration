{"project":"joyent/boray","branch":"master","id":"I57267bbb358a42f361959ff83d2c8530ef03b1f3","number":"6579","subject":"MANTA-4397 SAPI configuration for boray","owner":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"url":"https://cr.joyent.us/6579","commitMessage":"MANTA-4397 SAPI configuration for boray\n","createdOn":1562706854,"lastUpdated":1562783885,"open":false,"status":"MERGED","comments":[{"timestamp":1562706854,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 1."},{"timestamp":1562706860,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 1b13436bebc2bd48d788d5ebb465c3c8e9ab7bec\n    \n    MANTA-4397 SAPI configuration for boray"},{"timestamp":1562706954,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562711048,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 2."},{"timestamp":1562711051,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 04c405c33cf3ab816583a2fe2e3806a62349ffd7\n    \n    Update a few database defaults to more appropriate values"},{"timestamp":1562711161,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562714704,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 2:\n\n(5 comments)\n\nLooks good! I have a few nits and a few questions, but nothing major."},{"timestamp":1562726985,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1562727076,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 3."},{"timestamp":1562727078,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit e46bc4a03cbb2ff88fb0f0ae45167080a9705e2f\n    \n    Address review feedback"},{"timestamp":1562727132,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1562727171,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562782857,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 3:\n\n(3 comments)\n\nLooks good, except for a stray comma -- see below :D"},{"timestamp":1562783775,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 4."},{"timestamp":1562783777,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 9ebc93279010158c3a50bc551cc17a244e3f11aa\n    \n    Remove extra comman in copyright header"},{"timestamp":1562783867,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1562783874,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562783885,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Kelly McLaughlin"}],"currentPatchSet":{"number":"4","revision":"57267bbb358a42f361959ff83d2c8530ef03b1f3","parents":["e9aff72cf1afb5e2ddd902e9e63957bd7557832f"],"ref":"refs/changes/79/6579/4","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1562783775,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562783867,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1562783867,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562783874,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1562783885,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":7,"deletions":-4},{"file":"sapi_manifests/boray/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/boray/template","type":"MODIFIED","insertions":121,"deletions":-2},{"file":"smf/manifests/boray.xml.in","type":"MODIFIED","insertions":6,"deletions":-3}],"sizeInsertions":135,"sizeDeletions":-10},"patchSets":[{"number":"1","revision":"3fd5657d4df1a2e6be573164c803ffc90469c188","parents":["e9aff72cf1afb5e2ddd902e9e63957bd7557832f"],"ref":"refs/changes/79/6579/1","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1562706854,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562706954,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"sapi_manifests/boray/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/boray/template","type":"MODIFIED","insertions":121,"deletions":-2},{"file":"smf/manifests/boray.xml.in","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":131,"sizeDeletions":-8},{"number":"2","revision":"29a350b2110e11c143cd98a2fe0a175d141d7720","parents":["e9aff72cf1afb5e2ddd902e9e63957bd7557832f"],"ref":"refs/changes/79/6579/2","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1562711048,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562711161,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"boot/setup.sh","line":10,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Copyright should be changed to RFD-compliant form:\n\n\"Copyright 2019 Joyent, Inc.\""},{"file":"boot/setup.sh","line":10,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Done"},{"file":"sapi_manifests/boray/template","line":35,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"We need to get this port into a `metricPorts` mdata variable so the metrics will get picked up by cmon-agent. This is slightly tricky, because the port could change if the sapi variable is updated, and the mdata must be kept in sync.\n\nThere\u0027s a precedent for accomplishing this with a small transient smf service. We should be able to closely follow this commit to pgstatsmon here: https://github.com/joyent/pgstatsmon/commit/aa333c020dc3f145dccec85535b0e80985eff67b\n\nI\u0027m fine with this work being done as a follow-up ticket.\n\nThe alternative is to not make the metric port configurable via sapi. Then, we could just mdata-put the static metric port value in boot/setup.sh. Some other manta services follow this pattern."},{"file":"sapi_manifests/boray/template","line":35,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"I guess I\u0027m inclined to follow the pgstatsmon pattern and keep it configurable, but also to handle that in a separate ticket. What do you think about that plan?"},{"file":"sapi_manifests/boray/template","line":35,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"That sounds good to me."},{"file":"smf/manifests/boray.xml.in","line":10,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Copyright should be RFD-compliant here too."},{"file":"smf/manifests/boray.xml.in","line":10,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Done"},{"file":"smf/manifests/boray.xml.in","line":46,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Most other services use absolute paths here, I think. Is there a reason why the path was changed to relative?"},{"file":"smf/manifests/boray.xml.in","line":46,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"I copied this from what moray does. I checked muskie, moray, and electric-moray and they all seem to use the working directory with relative file path pattern."},{"file":"smf/manifests/boray.xml.in","line":46,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Fair enough! Fine to leave it as-is, then."},{"file":"smf/manifests/boray.xml.in","line":48,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Does the boray process need to run as root? I\u0027m inclined to avoid it if necessary.\n\nLooking at moray\u0027s smf manifest, for example, the moray process runs as \"nobody\" -- maybe that\u0027s a pattern to follow?"},{"file":"smf/manifests/boray.xml.in","line":48,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Good catch. I copied what electric-moray was doing in this case, but I think the moray method makes more sense."},{"file":"smf/manifests/boray.xml.in","line":48,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"sapi_manifests/boray/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/boray/template","type":"MODIFIED","insertions":121,"deletions":-2},{"file":"smf/manifests/boray.xml.in","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":131,"sizeDeletions":-8},{"number":"3","revision":"edb198745bd79c5c4e5a51f72e1199d5277fa889","parents":["e9aff72cf1afb5e2ddd902e9e63957bd7557832f"],"ref":"refs/changes/79/6579/3","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1562727076,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562727171,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"smf/manifests/boray.xml.in","line":10,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Nittiest of nits: this comma should be removed. Sorry to be so pedantic!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":7,"deletions":-4},{"file":"sapi_manifests/boray/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/boray/template","type":"MODIFIED","insertions":121,"deletions":-2},{"file":"smf/manifests/boray.xml.in","type":"MODIFIED","insertions":6,"deletions":-3}],"sizeInsertions":135,"sizeDeletions":-10},{"number":"4","revision":"57267bbb358a42f361959ff83d2c8530ef03b1f3","parents":["e9aff72cf1afb5e2ddd902e9e63957bd7557832f"],"ref":"refs/changes/79/6579/4","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1562783775,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562783874,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562783867,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1562783867,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}},{"type":"SUBM","value":"1","grantedOn":1562783885,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":7,"deletions":-4},{"file":"sapi_manifests/boray/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/boray/template","type":"MODIFIED","insertions":121,"deletions":-2},{"file":"smf/manifests/boray.xml.in","type":"MODIFIED","insertions":6,"deletions":-3}],"sizeInsertions":135,"sizeDeletions":-10}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}]}