{"project":"joyent/illumos-joyent","branch":"master","id":"Ia3617bfdbdbcbba554954ad494a51d512981c472","number":"4502","subject":"OS-7069 zone hang during shutdown after interface address conflict Reviewed by: Cody Peter Mello \u003cmelloc@joyent.com\u003e Reviewed by: Jason King \u003cjbk@joyent.com\u003e Approved by: Cody Peter Mello \u003cmelloc@joyent.com\u003e","owner":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"url":"https://cr.joyent.us/4502","commitMessage":"OS-7069 zone hang during shutdown after interface address conflict\nReviewed by: Cody Peter Mello \u003cmelloc@joyent.com\u003e\nReviewed by: Jason King \u003cjbk@joyent.com\u003e\nApproved by: Cody Peter Mello \u003cmelloc@joyent.com\u003e\n","createdOn":1531194245,"lastUpdated":1541711140,"open":false,"status":"MERGED","comments":[{"timestamp":1531194245,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 1."},{"timestamp":1531234904,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 2."},{"timestamp":1531236600,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1531237791,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1531409548,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1531417474,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 3."},{"timestamp":1531762777,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1531865611,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 5."},{"timestamp":1531865841,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 6."},{"timestamp":1532096829,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1532473617,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 7."},{"timestamp":1532476018,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1533259253,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 7:\n\n(1 comment)"},{"timestamp":1533260670,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 7:\n\n(1 comment)"},{"timestamp":1533261067,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 8."},{"timestamp":1533261296,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 9."},{"timestamp":1533261495,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 9:\n\nOne KEBE question needs answering by reviewers."},{"timestamp":1533743077,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 9: Code-Review+1\n\nENXIO is ok for me, though at the same time, it\u0027s not a strongly held opinion (i.e. if others have a better answer I\u0027m fine with that as well)."},{"timestamp":1536280502,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 9:\n\nThis fix is on hold, because it\u0027s possible this code will be re-rewhacked by Cody."},{"timestamp":1538540003,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 9:\n\nIs the fix still on-hold or should reviewers take another crack at it?"},{"timestamp":1538571684,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 9:\n\n\u003e Is the fix still on-hold or should reviewers take another crack at\n \u003e it?\n\nAFAIK it\u0027s still on hold because the root-cause (OS-4683) needs rewriting.  (Maybe it should be backed out?)"},{"timestamp":1538572873,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 9:\n\nOK.  I wanted to make sure it wasn\u0027t languishing in the CR queue."},{"timestamp":1541621036,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 9:\n\n(1 comment)"},{"timestamp":1541623037,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 10."},{"timestamp":1541623069,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 10:\n\nLost KEBE comment."},{"timestamp":1541623909,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 10: Code-Review+1"},{"timestamp":1541710652,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 10:\n\nTesting notes updated on bug report."},{"timestamp":1541710923,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 10: Code-Review+1 Integration-Approval+1"},{"timestamp":1541711128,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 11: Commit message was updated."},{"timestamp":1541711140,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dan McDonald"}],"currentPatchSet":{"number":"11","revision":"a3617bfdbdbcbba554954ad494a51d512981c472","parents":["4fe7f4c3234fc70dbf4f005babab2d326b83098e"],"ref":"refs/changes/02/4502/11","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1541711128,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541623909,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541710923,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1541710923,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"SUBM","value":"1","grantedOn":1541711140,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip_if.c","type":"MODIFIED","insertions":32,"deletions":-7}],"sizeInsertions":32,"sizeDeletions":-7},"patchSets":[{"number":"1","revision":"a8844e693827790a0c4d4710605ac2b629cdff1e","parents":["eebde15ca4eb2442e9bbce950bbf9782b60ec1a5"],"ref":"refs/changes/02/4502/1","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1531194245,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip_if.c","type":"MODIFIED","insertions":7,"deletions":-4}],"sizeInsertions":7,"sizeDeletions":-4},{"number":"2","revision":"4cd87558a6c9f51e7c18ddf4b63745b21fb09f48","parents":["dfa251baee6acce9cec959acd5d35e272bca75ae"],"ref":"refs/changes/02/4502/2","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1531234904,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/inet/ip/ip_if.c","line":12788,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Should we perhaps be checking this under ill_lock above and caching that status?"},{"file":"usr/src/uts/common/inet/ip/ip_if.c","line":12788,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"ILL_CONDEMNED is write-once, and never reverts.  Caching doesn\u0027t help, and may exacerbate something I mention below:"},{"file":"usr/src/uts/common/inet/ip/ip_if.c","line":12797,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This might be clearer if it was combined into one big if-statement with disable-\u003esend and reset-\u003esend-\u003ewait bodies that integrate an updated comment from above?\n\nYour call"},{"file":"usr/src/uts/common/inet/ip/ip_if.c","line":12797,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"It\u0027s *possible*, but highly unlikely because of the call chain and the ILL_WRITER() checks, for ILL_CONDEMNED to get switched on between the first check and the second.  The second ILL_CONDEMNED check is the heart of this bugfix: i.e. Don\u0027t cv_wait() on something that can never be signalled.  I want the second check in case that race ever happens."},{"file":"usr/src/uts/common/inet/ip/ip_if.c","line":12797,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Without checking ill_state_flags under ill_lock, isn\u0027t all of this logic inherently racy?  Say the flags change immediately after any one of those conditionals, before the body has been able to execute.  Is the control flow at risk then?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip_if.c","type":"MODIFIED","insertions":7,"deletions":-4}],"sizeInsertions":7,"sizeDeletions":-4},{"number":"3","revision":"aceca587e089571c5ee2a6bbd2ad7c5ab4d71e27","parents":["d638c6316f2021e055ef3b139f99aa5989c122d0"],"ref":"refs/changes/02/4502/3","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1531417474,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip_if.c","type":"MODIFIED","insertions":21,"deletions":-5}],"sizeInsertions":21,"sizeDeletions":-5},{"number":"4","revision":"74270046e5f2273dc2aea08ed31c4a89616f2de3","parents":["251183602619045ad135f45b198a24867b0b1299"],"ref":"refs/changes/02/4502/4","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1531762777,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"TRIVIAL_REBASE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip_if.c","type":"MODIFIED","insertions":21,"deletions":-5}],"sizeInsertions":21,"sizeDeletions":-5},{"number":"5","revision":"f61f6a81d4c9b0d25d33a0312fb8eba3ddad8205","parents":["251183602619045ad135f45b198a24867b0b1299"],"ref":"refs/changes/02/4502/5","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1531865611,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip_if.c","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":11,"sizeDeletions":-1},{"number":"6","revision":"af895321dff467ac52169f0a507275e476a45970","parents":["251183602619045ad135f45b198a24867b0b1299"],"ref":"refs/changes/02/4502/6","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1531865841,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1532096829,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip_if.c","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":11,"sizeDeletions":-1},{"number":"7","revision":"cf236d370644c15cc62cc2a9984fe06cfa76132e","parents":["5b6d8a45d43cad27424fe3742fc5420e5e621038"],"ref":"refs/changes/02/4502/7","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1532473617,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1532476018,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}}],"comments":[{"file":"usr/src/uts/common/inet/ip/ip_if.c","line":1401,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Is it possible for another thread to set ILL_CONDEMNED between lines 1400 and 1401 executing?  If so, the ipsq_enter call will return B_FALSE and trip the verify."},{"file":"usr/src/uts/common/inet/ip/ip_if.c","line":1401,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"It is possible.\n\nThis is called in two places: ill_dl_{up,down}().  The down it doesn\u0027t matter if ipsq_enter returns FALSE or not, the caller just wants this function to return.  In up, if ipsq_enter() fails, then clearly someone raced us to unplumb the NIC while it was being plumbed.\n\nWe can alter ill_capability_wait() to return a boolean_t, where B_FALSE happens only if ipsq_enter() failed.  down() won\u0027t care, but up() can then return ENXIO or some other meaningful errno."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip_if.c","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":11,"sizeDeletions":-1},{"number":"8","revision":"9616e75680879daaf4bc063bd4d2cca7d78ff0d5","parents":["5ea2876c4c5ed6cd7890ab3ee48d6e0522b67e6d"],"ref":"refs/changes/02/4502/8","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1533261067,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip_if.c","type":"MODIFIED","insertions":30,"deletions":-7}],"sizeInsertions":30,"sizeDeletions":-7},{"number":"9","revision":"ed236e32df8d41d11851d5f7dad67e567562227f","parents":["5ea2876c4c5ed6cd7890ab3ee48d6e0522b67e6d"],"ref":"refs/changes/02/4502/9","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1533261296,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533743077,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"comments":[{"file":"usr/src/uts/common/inet/ip/ip_if.c","line":14756,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"ENXIO seems fine to me. (It\u0027s what ill_dl_bind_err may be set to below, too.)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip_if.c","type":"MODIFIED","insertions":32,"deletions":-7}],"sizeInsertions":32,"sizeDeletions":-7},{"number":"10","revision":"76c7d7efea700ecb2b4e0988227fa8c5c5e7a8fe","parents":["4fe7f4c3234fc70dbf4f005babab2d326b83098e"],"ref":"refs/changes/02/4502/10","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1541623037,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541710923,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1541710923,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541623909,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip_if.c","type":"MODIFIED","insertions":32,"deletions":-7}],"sizeInsertions":32,"sizeDeletions":-7},{"number":"11","revision":"a3617bfdbdbcbba554954ad494a51d512981c472","parents":["4fe7f4c3234fc70dbf4f005babab2d326b83098e"],"ref":"refs/changes/02/4502/11","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1541711128,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541710923,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1541710923,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541623909,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"SUBM","value":"1","grantedOn":1541711140,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip_if.c","type":"MODIFIED","insertions":32,"deletions":-7}],"sizeInsertions":32,"sizeDeletions":-7}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}]}