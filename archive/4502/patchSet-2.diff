commit 4cd87558a6c9f51e7c18ddf4b63745b21fb09f48 (refs/changes/02/4502/2)
Author: Dan McDonald <danmcd@joyent.com>
Date:   2018-07-10T11:01:23-04:00 (1 year, 3 months ago)
    
    OS-7069 zone hang during shutdown after interface address conflict

diff --git a/usr/src/uts/common/inet/ip/ip_if.c b/usr/src/uts/common/inet/ip/ip_if.c
index c4b60daa68..a7e8cc3734 100644
--- a/usr/src/uts/common/inet/ip/ip_if.c
+++ b/usr/src/uts/common/inet/ip/ip_if.c
@@ -22,8 +22,8 @@
  * Copyright (c) 1991, 2010, Oracle and/or its affiliates. All rights reserved.
  * Copyright (c) 1990 Mentat Inc.
  * Copyright (c) 2013 by Delphix. All rights reserved.
- * Copyright (c) 2016, Joyent, Inc. All rights reserved.
  * Copyright (c) 2014, OmniTI Computer Consulting, Inc. All rights reserved.
+ * Copyright 2018, Joyent, Inc.
  */
 
 /*
@@ -12787,11 +12787,14 @@ ill_dl_down(ill_t *ill)
 		 */
 		if (ill->ill_state_flags & ILL_CONDEMNED)
 			ill_capability_dld_disable(ill);
-		ill_capability_reset(ill, B_FALSE);
+		else
+			ill_capability_reset(ill, B_FALSE);
 		ill_dlpi_send(ill, mp);
 
-		/* Wait for the capability reset to finish */
-		ill_capability_wait(ill);
+		if (!(ill->ill_state_flags & ILL_CONDEMNED)) {
+			/* Wait for the capability reset to finish */
+			ill_capability_wait(ill);
+		}
 	}
 }
 
