{"project":"joyent/sdcadm","branch":"master","id":"I44f9366c6f233a50c1d952237eb5c5f2769a3148","number":"3794","subject":"TRITON-315 unit tests for removeOldCNToolsTarballs Reviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e","owner":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"url":"https://cr.joyent.us/3794","commitMessage":"TRITON-315 unit tests for removeOldCNToolsTarballs\nReviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\n","createdOn":1523384294,"lastUpdated":1530264339,"open":false,"status":"MERGED","comments":[{"timestamp":1523384294,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 1."},{"timestamp":1523384327,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(3 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1523384359,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1523384677,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 2:\n\n(5 comments)"},{"timestamp":1523391006,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1523393638,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(5 comments)"},{"timestamp":1523456891,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 2:\n\nPedro, this is a proof of concept for what smaller \"unit\" tests for sdcadm (or really any project) might look like."},{"timestamp":1523464700,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\n(4 comments)\n\nI like the idea. Indeed, I\u0027ve been wanting unit tests and mocks for a long long time. Current sdcadm test suite is taking 40\u0027 to run, and that\u0027s when we\u0027re lucky and there is no failure.\n\nAnyway, I\u0027ve seen mock-fs in use, and can be handy. But what about the APIs? I think most of the times we want to mock API calls here and there. Have you done some research on this field Chris? any reasonably decent tool to do that?"},{"timestamp":1523475469,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 2:\n\n(2 comments)\n\nYour right that testing the API boundaries is a big problem.  I think eventually each api will need to provide it\u0027s own test double for dependent services to use.  JoshW wrote up some of his initial thoughts on what he calls \"functional\" tests here https://github.com/joyent/triton-dev/blob/master/docs/thoughts-on-testing.md and suggested that a FakeMoray might be a one avenue of attack."},{"timestamp":1523577821,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1526666951,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\n\u003e (1 comment)\n\nChris: if you rebase the change to latest sdcadm master, make check should actually pass once I\u0027ve updated to use ESLint with EcmaScript 6 features.\n\nRegarding the node version, I think we should use node v6 instead of node v4, specially regarding having no surprises using \"const\". Looking at https://node.green it seems that going for v6 is a lot safer."},{"timestamp":1527798622,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 3."},{"timestamp":1527798630,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n json: error: input is not JSON: Expected \u0027,\u0027 instead of \u0027\"\u0027 at line 40, column 5:\n             \"mock-fs\": \"4.4.x\",\n         ....^\n version is: { name: sdcadm, description: Administer a SmartDataCenter (SDC) standup, version: 1.18.0, author: Joyent (joyent.com), private: true, dependencies: { assert-plus: ^1.0.0, async: 0.2.9, backoff: 2.5.0, bunyan: 1.8.12, cmdln: 4.2.1, cueball: 2.4.0, extsprintf: ^1.3.0, joyent-schemas: git+https://github.com/joyent/schemas.git#385e6eb, jsprim: 1.2.2, kthxbai: ~0.4.0, lockfd: 1.2.1, mkdirp: 0.3.5, node-uuid: 1.4.1, once: 1.3.0, progbar: 1.1.0, read: 1.0.5, restify-clients: 1.4.0, sdc-clients: 10.3.0, semver: 5.4.1, strsplit: 1.0.0, tabula: 1.9.0, tape: 3.5.0, ufds: 1.3.0, urclient: 1.2.0, vasync: ^1.6.4, verror: ^1.10.0, wf-client: 0.3.0 }, devDependencies: { marked-man: 0.1.4, eslint: 4.13.1, eslint-plugin-joyent: ~2.0.0 mock-fs: 4.4.x, tap: ^12.0.1 }, engines: { node: \u003e\u003d0.10 }, license: MPL-2.0 }\n json: error: input is not JSON: Expected \u0027,\u0027 instead of \u0027\"\u0027 at line 40, column 5:\n             \"mock-fs\": \"4.4.x\",\n         ....^\n package.json version does not match CHANGES.md\n Makefile:109: recipe for target \u0027check-version\u0027 failed\n gmake: *** [check-version] Error 1"},{"timestamp":1527798772,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 4."},{"timestamp":1527798782,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n version is: 1.18.0\n Version check ok.\n ESLINT_VER\u003d$(/tmp/repo//tmp/repo/build/node/bin/node -e \u0027console.log(require(\"./package.json\").devDependencies[\"eslint\"] || \"\")\u0027) \u0026\u0026 \\\n     ESLINT_JOY_VER\u003d$(/tmp/repo//tmp/repo/build/node/bin/node -e \u0027console.log(require(\"./package.json\").devDependencies[\"eslint-plugin-joyent\"] || \"\")\u0027) \u0026\u0026 \\\n     [[ -n $ESLINT_VER \u0026\u0026 -n $ESLINT_JOY_VER ]] \u0026\u0026 \\\n     PATH\u003d/tmp/repo//tmp/repo/build/node/bin:/opt/local/sbin:/opt/local/bin:/usr/gnu/bin:/usr/bin:/usr/sbin:/bin:/sbin:/home/build/javascriptlint/build/install:/home/build/jsstyle node /tmp/repo//tmp/repo/build/node/bin/npm install --no-save eslint@$ESLINT_VER eslint-plugin-joyent@$ESLINT_JOY_VER \u0026\u0026 \\\n     touch node_modules/.bin/eslint\n /bin/sh: line 1: /tmp/repo//tmp/repo/build/node/bin/node: not found\n tools/mk/Makefile.deps:66: recipe for target \u0027node_modules/.bin/eslint\u0027 failed\n gmake: *** [node_modules/.bin/eslint] Error 127"},{"timestamp":1527798842,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 3:\n\nThis should more closely resemble the latest thinking at https://github.com/joyent/node-triton-package-boilerplate/pull/5\n\nI didn\u0027t pull in the STAMP changes because getting it to work with the lockfd and kthxbai was looking tangled.  So `make test-unit` won\u0027t figure out it\u0027s deps, it needs to be proceeded by the node modules being installed."},{"timestamp":1529437924,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 5."},{"timestamp":1529437934,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n version is: 1.18.0\n Version check ok.\n ESLINT_VER\u003d$(/tmp/repo//tmp/repo/build/node/bin/node -e \u0027console.log(require(\"./package.json\").devDependencies[\"eslint\"] || \"\")\u0027) \u0026\u0026 \\\n     ESLINT_JOY_VER\u003d$(/tmp/repo//tmp/repo/build/node/bin/node -e \u0027console.log(require(\"./package.json\").devDependencies[\"eslint-plugin-joyent\"] || \"\")\u0027) \u0026\u0026 \\\n     [[ -n $ESLINT_VER \u0026\u0026 -n $ESLINT_JOY_VER ]] \u0026\u0026 \\\n     PATH\u003d/tmp/repo//tmp/repo/build/node/bin:/opt/local/sbin:/opt/local/bin:/usr/gnu/bin:/usr/bin:/usr/sbin:/bin:/sbin:/home/build/javascriptlint/build/install:/home/build/jsstyle node /tmp/repo//tmp/repo/build/node/bin/npm install --no-save eslint@$ESLINT_VER eslint-plugin-joyent@$ESLINT_JOY_VER \u0026\u0026 \\\n     touch node_modules/.bin/eslint\n /bin/sh: line 1: /tmp/repo//tmp/repo/build/node/bin/node: not found\n tools/mk/Makefile.deps:66: recipe for target \u0027node_modules/.bin/eslint\u0027 failed\n gmake: *** [node_modules/.bin/eslint] Error 127"},{"timestamp":1529439117,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 6."},{"timestamp":1529439157,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529439369,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 6:\n\n(1 comment)\n\nI believe this is ready to look at again."},{"timestamp":1530129474,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6:\n\n(8 comments)"},{"timestamp":1530133199,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 6:\n\n(4 comments)"},{"timestamp":1530138744,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6:\n\n(3 comments)"},{"timestamp":1530214033,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 7."},{"timestamp":1530214034,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 6:\n\n(4 comments)"},{"timestamp":1530214069,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1530219704,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 8: Patch Set 7 was rebased"},{"timestamp":1530219739,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8:\n\n\"make check\" passed ok"},{"timestamp":1530224903,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 8: Code-Review+1 Integration-Approval+1"},{"timestamp":1530264242,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 9: Patch Set 8 was rebased"},{"timestamp":1530264275,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9:\n\n\"make check\" passed ok"},{"timestamp":1530264327,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 10: Commit message was updated."},{"timestamp":1530264333,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 10: Code-Review+1 Integration-Approval+1"},{"timestamp":1530264339,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"10","revision":"dae7b327d1c9e26dba254b68d5f53a8753cd5f69","parents":["fea83b339f6fdf3be7f16d09541446c73aee7bdd"],"ref":"refs/changes/94/3794/10","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1530264327,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530214069,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530224903,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530224903,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530264333,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530264333,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1530264339,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":8,"deletions":-6},{"file":".nycrc","type":"ADDED","insertions":18,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":19,"deletions":-3},{"file":"lib/cli/do_update_gz_tools.js","type":"MODIFIED","insertions":3,"deletions":-22},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/steps/usbkey.js","type":"ADDED","insertions":43,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"ADDED","insertions":107,"deletions":0}],"sizeInsertions":201,"sizeDeletions":-31},"patchSets":[{"number":"1","revision":"69c49a3b2b4511d3ceb0d858c1728a75ba1ca2b2","parents":["fb179c09ff4131e781cdbdd372496f44db462ca0"],"ref":"refs/changes/94/3794/1","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1523384294,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1523384327,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/sdcadm.js","line":1528,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: next"},{"file":"lib/sdcadm.js","line":1528,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: _"},{"file":"test/unit/steps/usbkey.test.js","line":23,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: bad_prop_id"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":2,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":14,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":3,"deletions":-20},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/steps/usbkey.js","type":"ADDED","insertions":45,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/unit/steps/usbkey.test.js","type":"ADDED","insertions":108,"deletions":0}],"sizeInsertions":182,"sizeDeletions":-21},{"number":"2","revision":"748789f51ffe48628ead36b9b13845e6c1638e2d","parents":["fb179c09ff4131e781cdbdd372496f44db462ca0"],"ref":"refs/changes/94/3794/2","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1523384359,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1523384327,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"Makefile","line":29,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"We use https://istanbul.js.org/ in a handful of places, but it seems like they changed the name  of the cli utility at some point\n\nhttps://istanbul.js.org/"},{"file":"Makefile","line":75,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I\u0027m not trying to lay a strong claim to naming or convention here."},{"file":"Makefile","line":75,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"FWIW, in node-triton I\u0027ve called this the `test-unit` target. sdc-docker.git uses `make test` for running unit tests."},{"file":"lib/sdcadm.js","line":1528,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Should make sure this replacement passes arg.progress through:\n\n1. add `arg: {progress: progress}` to the vasync.pipeline above; and\n2. this should just be `steps.usbkey.removeOldCNToolsTarballs` without the `(_, next)`."},{"file":"lib/steps/index.js","line":40,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Pending TRITON-313"},{"file":"test/unit/steps/usbkey.test.js","line":17,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"That are many many npm modules to allow absolte-to-the-project-root imports.  Do we have a favorite?"},{"file":"test/unit/steps/usbkey.test.js","line":17,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I don\u0027t think it is too gross. Having some separate module to add sugar around `require` strikes me initially as overkill.\n\nWe could drop one \"../\" by not having a separate test/unit/*steps*/ subdir.  E.g. instead have \"test/unit/steps-usbkey.test.js\"?"},{"file":"test/unit/steps/usbkey.test.js","line":21,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I go back to the sdc-docker test suite for examples, because that is when I felt out tape the most. E.g. https://github.com/joyent/sdc-docker/blob/master/test/integration/cli-affinity.test.js#L38-L53  has the \"t\" and \"tt\" naming convention that I might have started."},{"file":"test/unit/steps/usbkey.test.js","line":21,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"+1 on this"},{"file":"test/unit/steps/usbkey.test.js","line":22,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"You could:\n\n1. make this `outer.test` (or `tt.test` if you follow the naming convention in sdc-docker tests) to create a subtest per https://github.com/substack/tape#ttestname-opts-cb\n\n2. then IIUC the final `outer.end()` below isn\u0027t necessary? At least that\u0027s the case for sdc-docekr example: https://github.com/joyent/sdc-docker/blob/master/test/integration/cli-affinity.test.js#L150   I don\u0027t recall if I traced through the tape code to grok whether that `outer.end()` can be elided.\n\n\nNotes:\n- I\u0027m not sure if there is a downside to have `test()` calls inside an outer `test()` and *not* doing subtests. E.g. is test serialization still guaranteed?\n\n- Nesting sets of tests can be helpful for self-documenting more related tests. Also, it can be used to put some shared options on that set of tests: a skip (e.g.: https://github.com/joyent/node-triton/blob/master/test/integration/cli-volumes-size.test.js#L27-L36), or a timeout."},{"file":"test/unit/steps/usbkey.test.js","line":23,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"jsl:ignore doesn\u0027t seem to be enough to keep jsl from  choking on this node v4 syntax :-("},{"file":"test/unit/steps/usbkey.test.js","line":23,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Hrm... that would force an earlier hand in moving to eslint for this repo. I\u0027m fine with doing so, but I think the changes for the new linter should be done in a separate commit to separate signal and noise."},{"file":"test/unit/steps/usbkey.test.js","line":23,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I\u0027ve been using Eslint as my local linter for VIM and still not sure it will buy this syntax with the version we\u0027re using by default at Joyent. Anyway, I\u0027ll take a look"},{"file":"test/unit/steps/usbkey.test.js","line":80,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"This is a personal opinion, but I\u0027d say this is an \"abuse\" of constants declaration, specially when you\u0027re creating variables which are the result of the execution of a function which, additionally, may bring different results depending on the system status."},{"file":"test/unit/steps/usbkey.test.js","line":80,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I  agree that it doesn\u0027t feel ideal that \"const\" was chosen as the keyword for constant references instead of a constant value.  Java uses \"final\" which has a somewhat less baggage, but if Java were created today would  I think have constant references be the default behavior.  Is there another way in node to indicate to both humans and the runtime that a reference is immutable?"},{"file":"test/unit/steps/usbkey.test.js","line":82,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I guess I would not have bother nested these two under `test(\u0027prune\u0027, function (tt) {`.  The consts uses for the `fakeFiles` setup could just be one level up."},{"file":"test/unit/steps/usbkey.test.js","line":97,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Chris, I\u0027ve seen you\u0027ve used this twice. Can I assume any advantage regarding just using `forEach`? Just curious."},{"file":"test/unit/steps/usbkey.test.js","line":97,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I\u0027m still in the learning stage with node idioms.  A for loop seemed to me the most straightforward or boring way to do it.\n\nI think there is a performance difference in general, but that\u0027s not important here and I didn\u0027t consider it at the time."},{"file":"test/unit/steps/usbkey.test.js","line":97,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Whereever we are using node v4 at least, using \"for-of\" sounds good to me.  Node 0.10 doesn\u0027t supprot `for-of`. `[...].forEach` can be slower, if that matters (it doesn\u0027t here).\n\nIn node 0.10, using `for (i \u003d 0; i \u003c arr.length; i++) { ... }` is more labourious. Likewise for `for (idx in arr) { var item \u003d arr[idx]; ... }`."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":2,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":14,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":3,"deletions":-20},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/steps/usbkey.js","type":"ADDED","insertions":45,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/unit/steps/usbkey.test.js","type":"ADDED","insertions":108,"deletions":0}],"sizeInsertions":182,"sizeDeletions":-21},{"number":"3","revision":"dfdbd2cde09f2c229e4941f5d58b3823cd99e5f5","parents":["39aad99285cd9bd845f2f91601d8e8c3216c0d0f"],"ref":"refs/changes/94/3794/3","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1527798622,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1527798630,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":2,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":14,"deletions":0},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/steps/usbkey.js","type":"ADDED","insertions":45,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"ADDED","insertions":108,"deletions":0}],"sizeInsertions":172,"sizeDeletions":0},{"number":"4","revision":"d2562828a58301963b0f718e2e392078904c632d","parents":["39aad99285cd9bd845f2f91601d8e8c3216c0d0f"],"ref":"refs/changes/94/3794/4","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1527798772,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1527798782,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":8,"deletions":-6},{"file":".nycrc","type":"ADDED","insertions":18,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":24,"deletions":-3},{"file":"lib/cli/do_update_gz_tools.js","type":"MODIFIED","insertions":3,"deletions":-22},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/steps/usbkey.js","type":"ADDED","insertions":43,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"test/unit/steps/usbkey.test.js","type":"ADDED","insertions":108,"deletions":0}],"sizeInsertions":208,"sizeDeletions":-32},{"number":"5","revision":"cfb6bbbb99f67ff06038caec1c59a09a272e663e","parents":["09a6a8757e372323de717dd63d13e12049950839"],"ref":"refs/changes/94/3794/5","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1529437924,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1529437934,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":8,"deletions":-6},{"file":".nycrc","type":"ADDED","insertions":18,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":23,"deletions":-3},{"file":"lib/cli/do_update_gz_tools.js","type":"MODIFIED","insertions":3,"deletions":-22},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/steps/usbkey.js","type":"ADDED","insertions":43,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"ADDED","insertions":107,"deletions":0}],"sizeInsertions":205,"sizeDeletions":-31},{"number":"6","revision":"2933bd16a531fd47491c988ab7c38e03b8f56b07","parents":["09a6a8757e372323de717dd63d13e12049950839"],"ref":"refs/changes/94/3794/6","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1529439117,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529439157,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"Makefile","line":24,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I had defined this as $(TOP)/build, but that causes check-eslint to explode due to:\nhttps://github.com/joyent/eng/blob/master/tools/mk/Makefile.node_prebuilt.defs#L112\nhttps://github.com/joyent/eng/blob/master/tools/mk/Makefile.node_prebuilt.defs#L159\n\nI\u0027m not sure if $(TOP)/build, ./build, or build is ultimately more correct."},{"file":"Makefile","line":24,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Can\u0027t we just drop this? It is defined in Makefile.targ."},{"file":"Makefile","line":24,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I\u0027m not entirely clear on how the definitions interact, but without this line I\u0027m not observing a build directory being created."},{"file":"Makefile","line":24,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Hrm, perhaps that is because Makefile.targ is only imported below?\n\nWait Makefile.node_prebuilt.defs also defines BUILD, so I\u0027m confused. To be honest, I dislike the over-parameterization of these Makefile includes. I\u0027d be fine with just \"build\" used everywhere rather than a var.\n\nI\u0027ll drop any complaints about this line. ;)"},{"file":"Makefile","line":24,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I\u0027m not sure in this case it\u0027s so much over-parameterization as the relationships being under-documented."},{"file":"Makefile","line":26,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I realize now that \"TAP\" is a bad var name to use here, because node-tap uses \"TAP\u003d1\" as a signal to emit TAP output:\n\n```\n$ TAP\u003d1 ./node_modules/.bin/tap --jobs\u003d4 test/unit/**/*.test.js\nTAP version 13\nok 1 - test/unit/steps/usbkey.test.js # time\u003d304.552ms {\n    # Subtest: removeOldCNToolsTarballs\n        # Subtest: empty\n...\n```\n\nHowever, with TAP used for the node-tap script in this Makefile, we can\u0027t use that config signal:\n\n```\n$ make TAP\u003d1 test-unit\n1 --jobs\u003d4 --output-file\u003dbuild/test.unit.tap test/unit/**/*.test.js\n/bin/sh: 1: command not found\nmake: *** [test-unit] Error 127\n```"},{"file":"Makefile","line":26,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Would FOO_EXEC be the convention to follow?"},{"file":"Makefile","line":26,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think it would be fine. In the eng.git Makefiles, \"FOO_EXEC\" seems to be used for just the path to the script/executable, whereas \"FOO\" is the command line including options and perhaps the interpreter (e.g. \".../bin/node\") to use to invoke it."},{"file":"Makefile","line":56,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"NPM_ENV is defined as being envvars. If used, it needs to be before \"$(NPM)\". E.g.: https://github.com/joyent/eng/blob/master/tools/mk/Makefile.node_modules.targ#L30"},{"file":"Makefile","line":56,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Done"},{"file":"Makefile","line":63,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Are these empty targets necessary?"},{"file":"Makefile","line":63,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Without having a dependency on node_modules or STAMP_NODE_MODULES I think they are vestigial."},{"file":"Makefile","line":63,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Done"},{"file":"Makefile","line":66,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Was this necessary for something?"},{"file":"Makefile","line":66,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"So the build directory exists before the unit test or coverage goals try to write to files there."},{"file":"Makefile","line":66,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Ah, duh, I\u0027d missed the ref to BUILD for the \"test-unit\" target."},{"file":"Makefile","line":77,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Given that the deps required for this (tap and mockfs) are not included with sdcadm installs, I was going to ask how these are meant to be run. However, these are just for unit tests and, at least currently, not run by `runtests`, so I guess we are good here."},{"file":"Makefile","line":83,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027d indent one more level for the continued line."},{"file":"lib/steps/usbkey.js","line":8,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: \"Copyright (c) 2018, Joyent, Inc.\" per https://github.com/joyent/eng/blob/master/docs/index.md#copyright"},{"file":"lib/steps/usbkey.js","line":8,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Sure. But now I\u0027m going to create a ticket to be consistent about the (c) in Triton-y repos."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":8,"deletions":-6},{"file":".nycrc","type":"ADDED","insertions":18,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":23,"deletions":-3},{"file":"lib/cli/do_update_gz_tools.js","type":"MODIFIED","insertions":3,"deletions":-22},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/steps/usbkey.js","type":"ADDED","insertions":43,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"ADDED","insertions":107,"deletions":0}],"sizeInsertions":205,"sizeDeletions":-31},{"number":"7","revision":"44f9366c6f233a50c1d952237eb5c5f2769a3148","parents":["09a6a8757e372323de717dd63d13e12049950839"],"ref":"refs/changes/94/3794/7","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1530214033,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530214069,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":8,"deletions":-6},{"file":".nycrc","type":"ADDED","insertions":18,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":19,"deletions":-3},{"file":"lib/cli/do_update_gz_tools.js","type":"MODIFIED","insertions":3,"deletions":-22},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/steps/usbkey.js","type":"ADDED","insertions":43,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"ADDED","insertions":107,"deletions":0}],"sizeInsertions":201,"sizeDeletions":-31},{"number":"8","revision":"9b36e2a69f939096f94104d9b4a6aad6e631ba31","parents":["ea39aeca8a39b78bfecea2864c9e2a4cd8502249"],"ref":"refs/changes/94/3794/8","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1530219704,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530214069,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530224903,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530224903,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":8,"deletions":-6},{"file":".nycrc","type":"ADDED","insertions":18,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":19,"deletions":-3},{"file":"lib/cli/do_update_gz_tools.js","type":"MODIFIED","insertions":3,"deletions":-22},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/steps/usbkey.js","type":"ADDED","insertions":43,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"ADDED","insertions":107,"deletions":0}],"sizeInsertions":201,"sizeDeletions":-31},{"number":"9","revision":"5325162860e1cfefac811cbbfc7004593709bbfd","parents":["fea83b339f6fdf3be7f16d09541446c73aee7bdd"],"ref":"refs/changes/94/3794/9","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1530264242,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530214069,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530224903,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530224903,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":8,"deletions":-6},{"file":".nycrc","type":"ADDED","insertions":18,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":19,"deletions":-3},{"file":"lib/cli/do_update_gz_tools.js","type":"MODIFIED","insertions":3,"deletions":-22},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/steps/usbkey.js","type":"ADDED","insertions":43,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"ADDED","insertions":107,"deletions":0}],"sizeInsertions":201,"sizeDeletions":-31},{"number":"10","revision":"dae7b327d1c9e26dba254b68d5f53a8753cd5f69","parents":["fea83b339f6fdf3be7f16d09541446c73aee7bdd"],"ref":"refs/changes/94/3794/10","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1530264327,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530214069,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530224903,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530224903,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530264333,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530264333,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1530264339,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":8,"deletions":-6},{"file":".nycrc","type":"ADDED","insertions":18,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":19,"deletions":-3},{"file":"lib/cli/do_update_gz_tools.js","type":"MODIFIED","insertions":3,"deletions":-22},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/steps/usbkey.js","type":"ADDED","insertions":43,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"ADDED","insertions":107,"deletions":0}],"sizeInsertions":201,"sizeDeletions":-31}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}]}