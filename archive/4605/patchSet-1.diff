From 529fccc0849dc844339d54249d5e593542abbe28 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Mon, 30 Jul 2018 20:45:31 -0700
Subject: [PATCH] TRITON-643 drop "parameters" field from CloudAPI MachineAudit
 action objects

---
 lib/audit.js     |  1 -
 lib/datasets.js  |  6 +-----
 lib/machines.js  | 33 +++++++++++----------------------
 lib/metadata.js  |  9 +++------
 lib/nics.js      |  6 ++----
 lib/resources.js |  3 +--
 lib/snapshots.js |  9 +++------
 lib/tags.js      | 12 ++++--------
 package.json     |  2 +-
 9 files changed, 26 insertions(+), 55 deletions(-)

diff --git a/lib/audit.js b/lib/audit.js
index 09d534e..bf92439 100644
--- a/lib/audit.js
+++ b/lib/audit.js
@@ -81,7 +81,6 @@ function translate(job) {
     j.action = translateAction(job);
     if (job.params.context) {
         j.caller = job.params.context.caller;
-        j.parameters = job.params.context.parameters;
     } else {
         j.caller = {
             type: 'operator'
diff --git a/lib/datasets.js b/lib/datasets.js
index 7053fff..05106a2 100644
--- a/lib/datasets.js
+++ b/lib/datasets.js
@@ -676,11 +676,7 @@ function del(req, res, next) {
         req.account.uuid,
         {
             headers: {
-                'x-request-id': req.getId(),
-                'x-joyent-context': JSON.stringify({
-                    caller: req._auditCtx,
-                    params: req.params
-                })
+                'x-request-id': req.getId()
             }
         },
         function (err) {
diff --git a/lib/machines.js b/lib/machines.js
index 6e6a51f..4ebc4fa 100644
--- a/lib/machines.js
+++ b/lib/machines.js
@@ -1413,8 +1413,7 @@ function create(req, res, next) {
     opts.owner_uuid = customer;
     // Audit:
     opts.context = {
-        caller: req._auditCtx,
-        params: reqParams
+        caller: req._auditCtx
     };
 
     var pipeline = [];
@@ -1876,8 +1875,7 @@ function start(req, res, next) {
         creator_uuid: req.account.uuid,
         // Audit:
         context: {
-            caller: req._auditCtx,
-            params: req.params
+            caller: req._auditCtx
         }
     }, {
         log: req.log,
@@ -1905,8 +1903,7 @@ function stop(req, res, next) {
         creator_uuid: req.account.uuid,
         // Audit:
         context: {
-            caller: req._auditCtx,
-            params: req.params
+            caller: req._auditCtx
         }
     }, {
         log: req.log,
@@ -1934,8 +1931,7 @@ function reboot(req, res, next) {
         creator_uuid: req.account.uuid,
         // Audit:
         context: {
-            caller: req._auditCtx,
-            params: req.params
+            caller: req._auditCtx
         }
     }, {
         log: req.log,
@@ -2034,8 +2030,7 @@ function resize(req, res, next) {
     }
     // Audit:
     params.context = {
-        caller: req._auditCtx,
-        params: req.params
+        caller: req._auditCtx
     };
     return req.sdc.vmapi.updateVm(params, {
         log: req.log,
@@ -2084,8 +2079,7 @@ function rename(req, res, next) {
         creator_uuid: req.account.uuid,
         // Audit:
         context: {
-            caller: req._auditCtx,
-            params: req.params
+            caller: req._auditCtx
         },
         payload: {
             alias: req.params.name
@@ -2121,8 +2115,7 @@ function enable_deletion_protection(req, res, next) {
         creator_uuid: req.account.uuid,
         // Audit:
         context: {
-            caller: req._auditCtx,
-            params: params
+            caller: req._auditCtx
         },
         payload: {
             indestructible_zoneroot: true
@@ -2158,8 +2151,7 @@ function disable_deletion_protection(req, res, next) {
         creator_uuid: req.account.uuid,
         // Audit:
         context: {
-            caller: req._auditCtx,
-            params: params
+            caller: req._auditCtx
         },
         payload: {
             indestructible_zoneroot: false
@@ -2199,8 +2191,7 @@ function enable_firewall(req, res, next) {
         },
         // Audit:
         context: {
-            caller: req._auditCtx,
-            params: req.params
+            caller: req._auditCtx
         }
     }, {
         log: req.log,
@@ -2237,8 +2228,7 @@ function disable_firewall(req, res, next) {
         },
         // Audit:
         context: {
-            caller: req._auditCtx,
-            params: req.params
+            caller: req._auditCtx
         }
     }, {
         log: req.log,
@@ -2301,8 +2291,7 @@ function del(req, res, next) {
             creator_uuid: customer,
             // Audit:
             context: {
-                caller: req._auditCtx,
-                params: req.params
+                caller: req._auditCtx
             }
         }, {
             log: req.log,
diff --git a/lib/metadata.js b/lib/metadata.js
index e79fdf8..36e5f72 100644
--- a/lib/metadata.js
+++ b/lib/metadata.js
@@ -58,8 +58,7 @@ function add(req, res, next) {
     });
 
     meta.context = {
-        caller: req._auditCtx,
-        params: req.params
+        caller: req._auditCtx
     };
 
     var pipeline = [
@@ -283,8 +282,7 @@ function del(req, res, next) {
         creator_uuid: req.account.uuid,
         // Audit:
         context: {
-            caller: req._auditCtx,
-            params: req.params
+            caller: req._auditCtx
         }
     }, key, {
         headers: {
@@ -343,8 +341,7 @@ function delAll(req, res, next) {
             creator_uuid: req.account.uuid,
             // Audit:
             context: {
-                caller: req._auditCtx,
-                params: req.params
+                caller: req._auditCtx
             }
         }, {
             headers: {
diff --git a/lib/nics.js b/lib/nics.js
index b74f280..530ba2d 100644
--- a/lib/nics.js
+++ b/lib/nics.js
@@ -109,8 +109,7 @@ function addNic(req, res, next) {
     var networkArg  = req.params.network;
     var origin      = req.params.origin || 'cloudapi';
     var context = {
-        caller: req._auditCtx,
-        params: req.params
+        caller: req._auditCtx
     };
 
     if (!networkArg) {
@@ -531,8 +530,7 @@ function removeNic(req, res, next) {
     var ownerUuid = req.account.uuid;
     var headers   = { 'x-request-id': req.getId() };
     var context   = {
-        caller: req._auditCtx,
-        params: req.params
+        caller: req._auditCtx
     };
 
     if (!mac.match(MAC_RE)) {
diff --git a/lib/resources.js b/lib/resources.js
index aa654e2..99e4e94 100644
--- a/lib/resources.js
+++ b/lib/resources.js
@@ -344,8 +344,7 @@ function saveResource(req, cb) {
                 creator_uuid: req.account.uuid,
                 // Audit:
                 context: {
-                    caller: req._auditCtx,
-                    params: req.params
+                    caller: req._auditCtx
                 }
             };
 
diff --git a/lib/snapshots.js b/lib/snapshots.js
index 3ea4949..16de578 100644
--- a/lib/snapshots.js
+++ b/lib/snapshots.js
@@ -115,8 +115,7 @@ function create(req, res, next) {
         origin: params.origin || 'cloudapi',
         // Audit:
         context: {
-            caller: req._auditCtx,
-            params: params
+            caller: req._auditCtx
         }
     }, {
         headers: {
@@ -161,8 +160,7 @@ function boot(req, res, next) {
         origin: params.origin || 'cloudapi',
         // Audit:
         context: {
-            caller: req._auditCtx,
-            params: params
+            caller: req._auditCtx
         }
     }, {
         headers: {
@@ -271,8 +269,7 @@ function del(req, res, next) {
         origin: params.origin || 'cloudapi',
         // Audit:
         context: {
-            caller: req._auditCtx,
-            params: params
+            caller: req._auditCtx
         }
     }, {
         headers: {
diff --git a/lib/tags.js b/lib/tags.js
index 2ca4696..71f9878 100644
--- a/lib/tags.js
+++ b/lib/tags.js
@@ -50,8 +50,7 @@ function add(req, res, next) {
     });
 
     tags.context = {
-        caller: req._auditCtx,
-        params: req.params
+        caller: req._auditCtx
     };
 
     var pipeline = [
@@ -145,8 +144,7 @@ function replace(req, res, next) {
     });
 
     tags.context = {
-        caller: req._auditCtx,
-        params: req.params
+        caller: req._auditCtx
     };
 
     vmapi.setMetadata('tags', tags, {
@@ -258,8 +256,7 @@ function del(req, res, next) {
         creator_uuid: req.account.uuid,
         // Audit:
         context: {
-            caller: req._auditCtx,
-            params: req.params
+            caller: req._auditCtx
         }
     }, encodeURIComponent(t), {
         headers: {
@@ -298,8 +295,7 @@ function delAll(req, res, next) {
         creator_uuid: req.account.uuid,
         // Audit:
         context: {
-            caller: req._auditCtx,
-            params: req.params
+            caller: req._auditCtx
         }
     }, {
         headers: {
diff --git a/package.json b/package.json
index 7196e93..c8925f6 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "cloudapi",
     "description": "SmartDataCenter CloudAPI",
-    "version": "9.2.0",
+    "version": "9.2.1",
     "author": "Joyent (joyent.com)",
     "private": true,
     "engines": {
-- 
2.21.0

