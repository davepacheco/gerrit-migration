From 31a6be7c41b0c5249458f42159cde3f17dad4d12 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Fri, 6 Oct 2017 16:21:28 -0700
Subject: [PATCH] ZAPI-802 drop pointless templating of VMAPI's SMF manifest

---
 Makefile                                  |  2 +-
 boot/configure.sh                         | 10 +++-------
 boot/setup.sh                             |  2 ++
 smf/manifests/{vmapi.xml.in => vmapi.xml} |  6 +++---
 4 files changed, 9 insertions(+), 11 deletions(-)
 rename smf/manifests/{vmapi.xml.in => vmapi.xml} (88%)

diff --git a/Makefile b/Makefile
index e086f33..a7c34a9 100644
--- a/Makefile
+++ b/Makefile
@@ -47,7 +47,7 @@ JSL_CONF_NODE	 = tools/jsl.node.conf
 JSL_FILES_NODE   = server.js $(JS_FILES)
 JSSTYLE_FILES	 = server.js $(JS_FILES)
 JSSTYLE_FLAGS    = -o indent=4,doxygen,unparenthesized-return=0
-SMF_MANIFESTS_IN	 = smf/manifests/vmapi.xml.in
+SMF_MANIFESTS	 = smf/manifests/vmapi.xml
 
 include ./tools/mk/Makefile.defs
 ifeq ($(shell uname -s),SunOS)
diff --git a/boot/configure.sh b/boot/configure.sh
index 5f8e578..2394362 100755
--- a/boot/configure.sh
+++ b/boot/configure.sh
@@ -7,16 +7,12 @@
 #
 
 #
-# Copyright (c) 2014, Joyent, Inc.
+# Copyright (c) 2017, Joyent, Inc.
 #
 
 export PS4='[\D{%FT%TZ}] ${BASH_SOURCE}:${LINENO}: ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
 set -o xtrace
-
-echo "Updating SMF manifest"
-$(/opt/local/bin/gsed -i"" -e "s/@@PREFIX@@/\/opt\/smartdc\/vmapi/g" /opt/smartdc/vmapi/smf/manifests/vmapi.xml)
-
-echo "Importing vmapi.xml"
-/usr/sbin/svccfg import /opt/smartdc/vmapi/smf/manifests/vmapi.xml
+set -o errexit
+set -o pipefail
 
 exit 0
diff --git a/boot/setup.sh b/boot/setup.sh
index 64e1697..c960151 100755
--- a/boot/setup.sh
+++ b/boot/setup.sh
@@ -33,6 +33,8 @@ chown -R nobody:nobody /opt/smartdc/vmapi
 echo "" >>/root/.profile
 echo "export PATH=\$PATH:/opt/smartdc/vmapi/build/node/bin:/opt/smartdc/vmapi/node_modules/.bin" >>/root/.profile
 
+/usr/sbin/svccfg import /opt/smartdc/vmapi/smf/manifests/vmapi.xml
+
 echo "Adding log rotation"
 # Log rotation.
 sdc_log_rotation_add config-agent /var/svc/log/*config-agent*.log 1g
diff --git a/smf/manifests/vmapi.xml.in b/smf/manifests/vmapi.xml
similarity index 88%
rename from smf/manifests/vmapi.xml.in
rename to smf/manifests/vmapi.xml
index 8a696d2..8cc477f 100644
--- a/smf/manifests/vmapi.xml.in
+++ b/smf/manifests/vmapi.xml
@@ -7,7 +7,7 @@
 -->
 
 <!--
-    Copyright (c) 2014, Joyent, Inc.
+    Copyright (c) 2017, Joyent, Inc.
 -->
 
 <service_bundle type="manifest" name="vmapi">
@@ -27,12 +27,12 @@
     <exec_method
       type="method"
       name="start"
-      exec="@@NODE@@ --abort_on_uncaught_exception @@PREFIX@@/server.js &amp;"
+      exec="/opt/smartdc/vmapi/build/node/bin/node --abort_on_uncaught_exception /opt/smartdc/vmapi/server.js &amp;"
       timeout_seconds="30">
       <method_context working_directory="/opt/smartdc/vmapi">
         <method_credential user="nobody" group="nobody" privileges="basic,net_privaddr"/>
         <method_environment>
-          <envvar name="PATH" value="/opt/nodejs/bin:/usr/local/bin:/opt/local/bin:/usr/bin:/usr/sbin:/bin"/>
+          <envvar name="PATH" value="/usr/local/bin:/opt/local/bin:/usr/bin:/usr/sbin:/bin"/>
           <envvar name="LD_PRELOAD_32" value="/usr/lib/extendedFILE.so.1" />
         </method_environment>
       </method_context>
-- 
2.21.0

