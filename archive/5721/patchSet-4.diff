From 0615dd459720adf400dac3ef0b93f5ec0ed256d1 Mon Sep 17 00:00:00 2001
From: dyep <dyep49@gmail.com>
Date: Tue, 12 Mar 2019 11:17:02 -0700
Subject: [PATCH] TRITON-1247 CloudAPI GetPackage and ListPackages should
 return `flexible_disk` and `disks` for bhyve packages

---
 docs/index.md         | 82 ++++++++++++++++++++++++-------------------
 lib/packages.js       | 16 ++++++++-
 package.json          |  2 +-
 test/packages.test.js | 39 ++++++++++++++++++--
 4 files changed, 99 insertions(+), 40 deletions(-)

diff --git a/docs/index.md b/docs/index.md
index 752a474..3836c72 100644
--- a/docs/index.md
+++ b/docs/index.md
@@ -922,6 +922,10 @@ Note that a `Triton-Datacenter-Name` response header was added in 9.2.0.
 
 The section describes API changes in CloudAPI versions.
 
+## 9.4.3
+- [ListPackages](#ListPackages) and [GetPackage](#GetPackage) include the
+  `flexible_disk` and `disks` attributes if they exist
+
 ## 9.4.2
 - The disks.\*.uuid parameter was renamed to disks.\*.id. This change impacts
   [CreateMachine](#CreateMachine), [GetMachine](#GetMachine), and
@@ -4188,16 +4192,17 @@ Provides a list of packages available in this datacenter.
 
 * The following are all optional inputs:
 
-**Field**  | **Type** | **Description**
----------- | -------- | ---------------
-name       | String   | The "friendly" name for this package
-memory     | Number   | How much memory will by available (in MiB)
-disk       | Number   | How much disk space will be available (in MiB)
-swap       | Number   | How much swap space will be available (in MiB)
-lwps       | Number   | Maximum number of light-weight processes (threads) allowed
-vcpus      | Number   | Number of vCPUs for this package
-version    | String   | The version of this package
-group      | String   | The group this package belongs to
+**Field**     | **Type** | **Description**
+------------- | -------- | ---------------
+name          | String   | The "friendly" name for this package
+memory        | Number   | How much memory will by available (in MiB)
+disk          | Number   | How much disk space will be available (in MiB)
+swap          | Number   | How much swap space will be available (in MiB)
+lwps          | Number   | Maximum number of light-weight processes (threads) allowed
+vcpus         | Number   | Number of vCPUs for this package
+version       | String   | The version of this package
+group         | String   | The group this package belongs to
+flexible_disk | Boolean  | Whether this is a flexible_disk package
 
 When any values are provided for one or more of the aforementioned inputs, the
 retrieved packages will match all of them.
@@ -4211,19 +4216,22 @@ package name.
 
 An array of objects, of the form:
 
-**Field**  | **Type** | **Description**
----------- | -------- | ---------------
-id         | UUID     | Unique id for this package
-name       | String   | The "friendly" name for this package
-memory     | Number   | How much memory will by available (in MiB)
-disk       | Number   | How much disk space will be available (in MiB)
-swap       | Number   | How much swap space will be available (in MiB)
-lwps       | Number   | Maximum number of light-weight processes (threads) allowed
-vcpus      | Number   | Number of vCPUs for this package
-version    | String   | The version of this package
-group      | String   | The group this package belongs to
-description | String  | A human-friendly description about this package
-default    | Boolean  | (deprecated) Whether this is the default package in this datacenter
+**Field**     | **Type** | **Description**
+------------- | -------- | ---------------
+id            | UUID     | Unique id for this package
+name          | String   | The "friendly" name for this package
+memory        | Number   | How much memory will by available (in MiB)
+disk          | Number   | How much disk space will be available (in MiB)
+swap          | Number   | How much swap space will be available (in MiB)
+lwps          | Number   | Maximum number of light-weight processes (threads) allowed
+vcpus         | Number   | Number of vCPUs for this package
+version       | String   | The version of this package
+group         | String   | The group this package belongs to
+description   | String   | A human-friendly description about this package
+disks         | Array    | The disks this package contains (Allowed when flexible_disk is `true`)
+flexible_disk | Boolean  | Whether this is a flexible_disk package (bhyve only)
+default       | Boolean  | (deprecated) Whether this is the default package in this datacenter
+
 
 ### Errors
 
@@ -4292,19 +4300,21 @@ Gets a package by `name` or `id`.
 
 ### Returns
 
-**Field**  | **Type** | **Description**
----------- | -------- | ---------------
-id         | UUID     | Unique id for this package
-name       | String   | The "friendly" name for this package
-memory     | Number   | How much memory will by available (in MiB)
-disk       | Number   | How much disk space will be available (in MiB)
-swap       | Number   | How much swap space will be available (in MiB)
-lwps       | Number   | Maximum number of light-weight processes (threads) allowed
-vcpus      | Number   | Number of vCPUs for this package
-version    | String   | The version of this package
-group      | String   | The group this package belongs to
-description | String  | A human-friendly description about this package
-default    | Boolean  | (deprecated) Whether this is the default package in this datacenter
+**Field**     | **Type** | **Description**
+------------- | -------- | ---------------
+id            | UUID     | Unique id for this package
+name          | String   | The "friendly" name for this package
+memory        | Number   | How much memory will by available (in MiB)
+disk          | Number   | How much disk space will be available (in MiB)
+swap          | Number   | How much swap space will be available (in MiB)
+lwps          | Number   | Maximum number of light-weight processes (threads) allowed
+vcpus         | Number   | Number of vCPUs for this package
+version       | String   | The version of this package
+group         | String   | The group this package belongs to
+description   | String   | A human-friendly description about this package
+disks         | Array    | The disks this package contains (Allowed when flexible_disk is `true`)
+flexible_disk | Boolean  | Whether this is a flexible_disk package (bhyve only)
+default       | Boolean  | (deprecated) Whether this is the default package in this datacenter
 
 ### Errors
 
diff --git a/lib/packages.js b/lib/packages.js
index e6e2c79..9c62b9d 100644
--- a/lib/packages.js
+++ b/lib/packages.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -51,6 +51,16 @@ function translate(req, pkg) {
         version: pkg.version
     };
 
+    if (pkg.brand === 'bhyve') {
+        if (pkg.flexible_disk !== undefined) {
+            p.flexible_disk = pkg.flexible_disk;
+        }
+
+        if (pkg.disks) {
+            p.disks = pkg.disks;
+        }
+    }
+
     return p;
 }
 
@@ -233,6 +243,10 @@ function list(req, res, next) {
         opts.group = params.group;
     }
 
+    if (req.params.flexible_disk) {
+        opts.flexible_disk = params.flexible_disk;
+    }
+
     opts.active = true;
     opts.owner_uuids = req.account.uuid;
 
diff --git a/package.json b/package.json
index 9139542..1af2d0a 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "cloudapi",
     "description": "SmartDataCenter CloudAPI",
-    "version": "9.4.2",
+    "version": "9.4.3",
     "author": "Joyent (joyent.com)",
     "private": true,
     "engines": {
diff --git a/test/packages.test.js b/test/packages.test.js
index d498d01..2a5c999 100644
--- a/test/packages.test.js
+++ b/test/packages.test.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 var util = require('util');
@@ -74,11 +74,23 @@ var SDC_512_BHYVE_BRAND = {
     zfs_io_priority: 10
 };
 
+var SDC_512_BHYVE_FLEX = Object.assign({}, SDC_512_BHYVE_BRAND, {
+    disks: [
+        {},
+        {size: 512},
+        {size: 'remaining'}
+    ],
+    flexible_disk: true,
+    name: 'sdc_128_bhyve_flex_disks',
+    uuid: 'eaec9227-ad21-4cbe-a0ab-15cfa9b360f1'
+});
+
 var CLIENTS;
 var CLIENT;
 var SERVER;
 
 var CREATED_SDC_512_BHYVE_BRAND = false;
+var CREATED_SDC_512_BHYVE_FLEX = false;
 var PAPI_VERSION;
 var VIEWABLE_PACKAGE_NAMES;
 var VIEWABLE_PACKAGE_UUIDS;
@@ -186,6 +198,17 @@ test('setup', function (t) {
                     CREATED_SDC_512_BHYVE_BRAND = true;
                     createPackage(SDC_512_BHYVE_BRAND, cb);
                 },
+                function _add512BhyveFlex(_, cb) {
+                    // 7.2.0 added support for pkg.flexible_disk and pkg.disks
+                    if (semver.lt(PAPI_VERSION, '7.2.0')) {
+                        t.ok(true, 'skipping "flexible_disk" test');
+                        cb();
+                        return;
+                    }
+
+                    CREATED_SDC_512_BHYVE_FLEX = true;
+                    createPackage(SDC_512_BHYVE_FLEX, cb);
+                },
                 function _listPackages(_, cb) {
                     var accUuid;
 
@@ -281,6 +304,13 @@ test('search packages by brand', function _searchBrand(t) {
 });
 
 
+test('search packages by flexible_disk', function (t) {
+    searchAndCheck('flexible_disk=true', t, function (pkg) {
+        t.equal(pkg.flexible_disk, true);
+    });
+});
+
+
 test('search packages by name', function (t) {
     searchAndCheck('name=' + SDC_512.name, t, function (pkg) {
         t.equal(pkg.name, SDC_512.name);
@@ -414,7 +444,6 @@ test('GetPackage 404', function (t) {
 
 
 test('teardown', function _teardown(t) {
-
     function deletePackage(pkg, cb) {
         common.deletePackage(CLIENT, pkg, function _onDel(err) {
             t.ifError(err, 'delete package ' + pkg.uuid +
@@ -435,6 +464,12 @@ test('teardown', function _teardown(t) {
                     return;
                 }
                 deletePackage(SDC_512_BHYVE_BRAND, cb);
+            }, function _delete512BhyveFlex(_, cb) {
+                if (!CREATED_SDC_512_BHYVE_FLEX) {
+                    cb();
+                    return;
+                }
+                deletePackage(SDC_512_BHYVE_FLEX, cb);
             }
         ]
     }, function _onDeleted(err) {
-- 
2.21.0

