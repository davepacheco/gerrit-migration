From 3919e613aa422e7ac5dc4e512224c6f19eb9f863 Mon Sep 17 00:00:00 2001
From: dyep <dyep49@gmail.com>
Date: Tue, 5 Mar 2019 19:25:44 -0800
Subject: [PATCH] TRITON-1247 CloudAPI GetPackage and ListPackages should
 return `flexible_disk` and `disks` for bhyve packages

---
 docs/index.md         | 10 ++++++++++
 lib/packages.js       | 14 +++++++++++++-
 package.json          |  2 +-
 test/packages.test.js | 39 +++++++++++++++++++++++++++++++++++++--
 4 files changed, 61 insertions(+), 4 deletions(-)

diff --git a/docs/index.md b/docs/index.md
index 752a474..d13986f 100644
--- a/docs/index.md
+++ b/docs/index.md
@@ -922,6 +922,10 @@ Note that a `Triton-Datacenter-Name` response header was added in 9.2.0.
 
 The section describes API changes in CloudAPI versions.
 
+## 9.4.3
+- [ListPackages](#ListPackages) and [GetPackage](#GetPackage) include the
+  `flexible_disk` and `disks` attributes if they exist
+
 ## 9.4.2
 - The disks.\*.uuid parameter was renamed to disks.\*.id. This change impacts
   [CreateMachine](#CreateMachine), [GetMachine](#GetMachine), and
@@ -4198,6 +4202,7 @@ lwps       | Number   | Maximum number of light-weight processes (threads) allow
 vcpus      | Number   | Number of vCPUs for this package
 version    | String   | The version of this package
 group      | String   | The group this package belongs to
+flexible_disk | Boolean   | Whether this is a flexible_disk package
 
 When any values are provided for one or more of the aforementioned inputs, the
 retrieved packages will match all of them.
@@ -4223,8 +4228,11 @@ vcpus      | Number   | Number of vCPUs for this package
 version    | String   | The version of this package
 group      | String   | The group this package belongs to
 description | String  | A human-friendly description about this package
+disks      | Array    | The disks this package contains (Allowed when flexible_disk is `true`)
+flexible_disk | Boolean | Whether this is a flexible_disk package (bhyve only)
 default    | Boolean  | (deprecated) Whether this is the default package in this datacenter
 
+
 ### Errors
 
 For all possible errors, see [CloudAPI HTTP Responses](#cloudapi-http-responses).
@@ -4304,6 +4312,8 @@ vcpus      | Number   | Number of vCPUs for this package
 version    | String   | The version of this package
 group      | String   | The group this package belongs to
 description | String  | A human-friendly description about this package
+disks      | Array    | The disks this package contains (Allowed when flexible_disk is `true`)
+flexible_disk | Boolean | Whether this is a flexible_disk package (bhyve only)
 default    | Boolean  | (deprecated) Whether this is the default package in this datacenter
 
 ### Errors
diff --git a/lib/packages.js b/lib/packages.js
index e6e2c79..0d8c796 100644
--- a/lib/packages.js
+++ b/lib/packages.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -51,6 +51,14 @@ function translate(req, pkg) {
         version: pkg.version
     };
 
+    if (pkg.brand === 'bhyve') {
+        p.flexible_disk = pkg.flexible_disk;
+
+        if (pkg.disks) {
+            p.disks = pkg.disks;
+        }
+    }
+
     return p;
 }
 
@@ -233,6 +241,10 @@ function list(req, res, next) {
         opts.group = params.group;
     }
 
+    if (req.params.flexible_disk) {
+        opts.flexible_disk = params.flexible_disk;
+    }
+
     opts.active = true;
     opts.owner_uuids = req.account.uuid;
 
diff --git a/package.json b/package.json
index 9139542..1af2d0a 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "cloudapi",
     "description": "SmartDataCenter CloudAPI",
-    "version": "9.4.2",
+    "version": "9.4.3",
     "author": "Joyent (joyent.com)",
     "private": true,
     "engines": {
diff --git a/test/packages.test.js b/test/packages.test.js
index d498d01..2a5c999 100644
--- a/test/packages.test.js
+++ b/test/packages.test.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 var util = require('util');
@@ -74,11 +74,23 @@ var SDC_512_BHYVE_BRAND = {
     zfs_io_priority: 10
 };
 
+var SDC_512_BHYVE_FLEX = Object.assign({}, SDC_512_BHYVE_BRAND, {
+    disks: [
+        {},
+        {size: 512},
+        {size: 'remaining'}
+    ],
+    flexible_disk: true,
+    name: 'sdc_128_bhyve_flex_disks',
+    uuid: 'eaec9227-ad21-4cbe-a0ab-15cfa9b360f1'
+});
+
 var CLIENTS;
 var CLIENT;
 var SERVER;
 
 var CREATED_SDC_512_BHYVE_BRAND = false;
+var CREATED_SDC_512_BHYVE_FLEX = false;
 var PAPI_VERSION;
 var VIEWABLE_PACKAGE_NAMES;
 var VIEWABLE_PACKAGE_UUIDS;
@@ -186,6 +198,17 @@ test('setup', function (t) {
                     CREATED_SDC_512_BHYVE_BRAND = true;
                     createPackage(SDC_512_BHYVE_BRAND, cb);
                 },
+                function _add512BhyveFlex(_, cb) {
+                    // 7.2.0 added support for pkg.flexible_disk and pkg.disks
+                    if (semver.lt(PAPI_VERSION, '7.2.0')) {
+                        t.ok(true, 'skipping "flexible_disk" test');
+                        cb();
+                        return;
+                    }
+
+                    CREATED_SDC_512_BHYVE_FLEX = true;
+                    createPackage(SDC_512_BHYVE_FLEX, cb);
+                },
                 function _listPackages(_, cb) {
                     var accUuid;
 
@@ -281,6 +304,13 @@ test('search packages by brand', function _searchBrand(t) {
 });
 
 
+test('search packages by flexible_disk', function (t) {
+    searchAndCheck('flexible_disk=true', t, function (pkg) {
+        t.equal(pkg.flexible_disk, true);
+    });
+});
+
+
 test('search packages by name', function (t) {
     searchAndCheck('name=' + SDC_512.name, t, function (pkg) {
         t.equal(pkg.name, SDC_512.name);
@@ -414,7 +444,6 @@ test('GetPackage 404', function (t) {
 
 
 test('teardown', function _teardown(t) {
-
     function deletePackage(pkg, cb) {
         common.deletePackage(CLIENT, pkg, function _onDel(err) {
             t.ifError(err, 'delete package ' + pkg.uuid +
@@ -435,6 +464,12 @@ test('teardown', function _teardown(t) {
                     return;
                 }
                 deletePackage(SDC_512_BHYVE_BRAND, cb);
+            }, function _delete512BhyveFlex(_, cb) {
+                if (!CREATED_SDC_512_BHYVE_FLEX) {
+                    cb();
+                    return;
+                }
+                deletePackage(SDC_512_BHYVE_FLEX, cb);
             }
         ]
     }, function _onDeleted(err) {
-- 
2.21.0

