{"project":"joyent/node-zookeeper-client","branch":"joyent","topic":"manta-4172","id":"Id04ad19572303771ca081b5f025e62add4651a2b","number":"5778","subject":"MANTA-4172 zk client ping timeouts not working Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/5778","commitMessage":"MANTA-4172 zk client ping timeouts not working\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1552428515,"lastUpdated":1553207754,"open":false,"status":"MERGED","comments":[{"timestamp":1552428515,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1552428595,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1552434207,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(5 comments)"},{"timestamp":1552586259,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1552586309,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\nThe biggest problem here is that there is no logger in the zk client, and no easy way to get one in there today (we don\u0027t even have a dep on bunyan to make our own, either). We could do the work to plumb one up but I think it\u0027s worthy of a separate ticket (and if we do it we should make it log a bunch of other stuff too not just this)"},{"timestamp":1552586522,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1552586528,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 4."},{"timestamp":1552607160,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1552689270,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1552689598,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1552950986,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 5."},{"timestamp":1552951076,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1552953578,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5: Code-Review+1\n\n(1 comment)"},{"timestamp":1553043688,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 6."},{"timestamp":1553043766,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1553202672,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 7."},{"timestamp":1553202864,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1553202978,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 7: Integration-Approval+1\n\nGiven the lack of serious automated testing in this area, I think the manual testing you\u0027ve done is good.  It does indeed seem like this is a strict improvement, so I think we should get this integrated even though the library itself is still not perfect."},{"timestamp":1553204511,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 8: Commit message was updated."},{"timestamp":1553205336,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"},{"timestamp":1553207754,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Topic set to manta-4172"}],"currentPatchSet":{"number":"8","revision":"5648492a6a1d4b980a39a6afe84bb7c8d165d3dc","parents":["4954df0ca00ef69a08f3f0ccd0270e356608946a"],"ref":"refs/changes/78/5778/8","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1553204511,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553202864,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553202978,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1553205336,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGELOG.md","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/ConnectionManager.js","type":"MODIFIED","insertions":149,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":156,"sizeDeletions":-2},"patchSets":[{"number":"1","revision":"a5e70ee2fddebedfc7ee9523d6b1c8a3a6489b2b","parents":["4954df0ca00ef69a08f3f0ccd0270e356608946a"],"ref":"refs/changes/78/5778/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1552428515,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/ConnectionManager.js","type":"MODIFIED","insertions":85,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":86,"sizeDeletions":-1},{"number":"2","revision":"bf87e18e49501bc5efccd5ce8d22d02b8e5f0b8d","parents":["4954df0ca00ef69a08f3f0ccd0270e356608946a"],"ref":"refs/changes/78/5778/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1552428595,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","comments":[{"file":"lib/ConnectionManager.js","line":115,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This deserves a comment. I think it\u0027s a little bit weird to see this. After some additional discussion I now understand that we\u0027re basically putting a global on an exported value because that\u0027s the easiest to obtain from a production system; however, I think this deserves to be documented."},{"file":"lib/ConnectionManager.js","line":115,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Comment added."},{"file":"lib/ConnectionManager.js","line":425,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is it worth logging something somewhere for future us that we explicitly were the ones that killed the socket rather than some issue with the underlying socket? Perhaps including which ping initiated this?"},{"file":"lib/ConnectionManager.js","line":425,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"No logger (see general notes). Adding a notation on the object though so you can see it in the debugger more clearly."},{"file":"lib/ConnectionManager.js","line":527,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"It\u0027s probably worth a comment here reminding readers of a couple things. I\u0027m not sure all of these are true:\n\n* The self.pings array has older pings that we\u0027ve sent and have already been processed.\n* That we expect a pong for every ping, which is why the first in the first of these in the queue is the one we should care about."},{"file":"lib/ConnectionManager.js","line":527,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Done"},{"file":"lib/ConnectionManager.js","line":534,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"When would we get a ping response but have no outstanding pings? Wouldn\u0027t that suggest something rather odd is going on? Could this be because we end up with some kind of interleaving of execution where by we have unprocessed data that a timer fires so we mark it killed, but it no longer corresponds to that?\n\nShould we log about such a rare condition?"},{"file":"lib/ConnectionManager.js","line":549,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"It looks like this\u0027ll remove entries we haven\u0027t received or haven\u0027t been killed yet."},{"file":"lib/ConnectionManager.js","line":549,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/ConnectionManager.js","type":"MODIFIED","insertions":89,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":90,"sizeDeletions":-1},{"number":"3","revision":"c200b9593b152bd28da0b343830b21aaf2f10b91","parents":["4954df0ca00ef69a08f3f0ccd0270e356608946a"],"ref":"refs/changes/78/5778/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1552586259,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/ConnectionManager.js","type":"MODIFIED","insertions":117,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":118,"sizeDeletions":-1},{"number":"4","revision":"0bd8dee26487d5f972707854f65ccb78e88bba03","parents":["4954df0ca00ef69a08f3f0ccd0270e356608946a"],"ref":"refs/changes/78/5778/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1552586528,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1552607160,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"comments":[{"file":"lib/ConnectionManager.js","line":553,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Should we bump a counter so that if we ever have a bug that we suspect might be related to the ping code, we can tell if this ever happened?"},{"file":"lib/ConnectionManager.js","line":553,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Could this happen also if we received a spurious (or duplicate) ping response?  In that case, it\u0027s a good call not to crash.  (A counter would still be nice...)"},{"file":"lib/ConnectionManager.js","line":553,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Ok, I\u0027m adding a counter that we can bump here, and a few other places."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/ConnectionManager.js","type":"MODIFIED","insertions":122,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":123,"sizeDeletions":-1},{"number":"5","revision":"216de3180e05e596835b23f41ecf6e2f1d8a00c6","parents":["4954df0ca00ef69a08f3f0ccd0270e356608946a"],"ref":"refs/changes/78/5778/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1552950986,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1552953578,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"comments":[{"file":"lib/ConnectionManager.js","line":219,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Worth tracking the number of times we\u0027ve entered a state in the stats?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/ConnectionManager.js","type":"MODIFIED","insertions":146,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":147,"sizeDeletions":-1},{"number":"6","revision":"8464f9fed60ce8205ccd11595dcecc9f16e6c269","parents":["4954df0ca00ef69a08f3f0ccd0270e356608946a"],"ref":"refs/changes/78/5778/6","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1553043688,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553043766,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/ConnectionManager.js","type":"MODIFIED","insertions":149,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":150,"sizeDeletions":-1},{"number":"7","revision":"d04ad19572303771ca081b5f025e62add4651a2b","parents":["4954df0ca00ef69a08f3f0ccd0270e356608946a"],"ref":"refs/changes/78/5778/7","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1553202672,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553202864,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553202978,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGELOG.md","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/ConnectionManager.js","type":"MODIFIED","insertions":149,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":156,"sizeDeletions":-2},{"number":"8","revision":"5648492a6a1d4b980a39a6afe84bb7c8d165d3dc","parents":["4954df0ca00ef69a08f3f0ccd0270e356608946a"],"ref":"refs/changes/78/5778/8","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1553204511,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553202864,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1553205336,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553202978,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGELOG.md","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/ConnectionManager.js","type":"MODIFIED","insertions":149,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":156,"sizeDeletions":-2}],"allReviewers":[{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}