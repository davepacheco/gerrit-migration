{"project":"joyent/illumos-joyent","branch":"master","id":"Iec2ec1db378810bd80cc6f84538435dba3bc9d4f","number":"2811","subject":"OS-6408 Chelsio T6 perf improvements","owner":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"url":"https://cr.joyent.us/2811","commitMessage":"OS-6408 Chelsio T6 perf improvements\n","createdOn":1508349272,"lastUpdated":1523901317,"open":false,"status":"ABANDONED","comments":[{"timestamp":1508349272,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 1."},{"timestamp":1508350092,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1508375407,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\n(14 comments)\n\nTwo overall themes:\n\n1.) Someone believes the code is self-documenting.  I disagree.\n\n2.) If this code is used on *BSD or other platforms, I don\u0027t have a problem with using the BSD netinet/* definitions of headers and what-not.  If this is illumos/solaris-specific, I\u0027d prefer the headers in inet/* be used instead."},{"timestamp":1523901317,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Abandoned\n\nUltimately, this current strategy isn\u0027t going to work because it ends up forcing LRO on for all connections, regardless of whether or not the clients can accept it. As such, this might break a KVM guest on a vnd device for example, as it\u0027d receive a packet much larger than it had negotiated."}],"currentPatchSet":{"number":"1","revision":"ec2ec1db378810bd80cc6f84538435dba3bc9d4f","parents":["fbf515b2ad3675e210bb520b4b32cac85a0eb529"],"ref":"refs/changes/11/2811/1","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1508349272,"author":{"name":"Vishal Kulkarni","email":"vishal@chelsio.com","username":""},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/Makefile.files","line":2001,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Over 80 cols with 8-space tabs?"},{"file":"usr/src/uts/common/io/cxgbe/t4nex/adapter.h","line":146,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Typically we use ipha_t from $SRC/uts/common/inet/ for IP headers.  Unless, of course, this is something designed to be cross-platform.  (Similar to the strict-cstyle exemption...)\n\nAlso, I assume there\u0027s no LRO for IPv6..."},{"file":"usr/src/uts/common/io/cxgbe/t4nex/adapter.h","line":400,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Nix trailing space"},{"file":"usr/src/uts/common/io/cxgbe/t4nex/adapter.h","line":934,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Illumos continuation style?"},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":61,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"NIT:  KM_SLEEP allocations never return NULL."},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":78,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"NIT:  \"!\u003d NULL\"..."},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":85,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"For readability, could we do 0xffff instead?"},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":89,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"There are comment tricks (/* LINTED */) for the end of these do-while(0) expressions."},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":115,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Readability:  CR above this?"},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":121,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"See comment in adapter.h file."},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":152,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Same thing here... if this is portable, then stick with the BSD header definitions.  If it\u0027s not, use the native illumos TCP/IP definitions."},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":208,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Is this hotpath enough to consider inline?"},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":215,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Wish we had some summaries up top."},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":283,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"No caller of this function cares about any result beyond 0 or not-0.  Is the return of errno supposed to assist merely in DTrace FBT (which MAY be a good enough answer)?"},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":340,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Looks like we accept only TCP Timestamps.  Comments explaining what is and isn\u0027t LRO-happy would be appreciated.  Same portability/native questions apply here."},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":361,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Hmmm... linear search... could this be a problem for a destination with many on-link peers (think SAN, e.g.)?"},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":371,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"0xfffff?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/Makefile.files","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/io/cxgbe/cxgbe/cxgbe.c","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/io/cxgbe/t4nex/adapter.h","type":"MODIFIED","insertions":55,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","type":"ADDED","insertions":479,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_nexus.c","type":"MODIFIED","insertions":16,"deletions":-13},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_sge.c","type":"MODIFIED","insertions":80,"deletions":-13}],"sizeInsertions":632,"sizeDeletions":-28},"patchSets":[{"number":"1","revision":"ec2ec1db378810bd80cc6f84538435dba3bc9d4f","parents":["fbf515b2ad3675e210bb520b4b32cac85a0eb529"],"ref":"refs/changes/11/2811/1","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1508349272,"author":{"name":"Vishal Kulkarni","email":"vishal@chelsio.com","username":""},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/Makefile.files","line":2001,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Over 80 cols with 8-space tabs?"},{"file":"usr/src/uts/common/io/cxgbe/t4nex/adapter.h","line":146,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Typically we use ipha_t from $SRC/uts/common/inet/ for IP headers.  Unless, of course, this is something designed to be cross-platform.  (Similar to the strict-cstyle exemption...)\n\nAlso, I assume there\u0027s no LRO for IPv6..."},{"file":"usr/src/uts/common/io/cxgbe/t4nex/adapter.h","line":400,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Nix trailing space"},{"file":"usr/src/uts/common/io/cxgbe/t4nex/adapter.h","line":934,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Illumos continuation style?"},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":61,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"NIT:  KM_SLEEP allocations never return NULL."},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":78,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"NIT:  \"!\u003d NULL\"..."},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":85,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"For readability, could we do 0xffff instead?"},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":89,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"There are comment tricks (/* LINTED */) for the end of these do-while(0) expressions."},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":115,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Readability:  CR above this?"},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":121,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"See comment in adapter.h file."},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":152,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Same thing here... if this is portable, then stick with the BSD header definitions.  If it\u0027s not, use the native illumos TCP/IP definitions."},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":208,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Is this hotpath enough to consider inline?"},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":215,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Wish we had some summaries up top."},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":283,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"No caller of this function cares about any result beyond 0 or not-0.  Is the return of errno supposed to assist merely in DTrace FBT (which MAY be a good enough answer)?"},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":340,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Looks like we accept only TCP Timestamps.  Comments explaining what is and isn\u0027t LRO-happy would be appreciated.  Same portability/native questions apply here."},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":361,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Hmmm... linear search... could this be a problem for a destination with many on-link peers (think SAN, e.g.)?"},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","line":371,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"0xfffff?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/Makefile.files","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/io/cxgbe/cxgbe/cxgbe.c","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/io/cxgbe/t4nex/adapter.h","type":"MODIFIED","insertions":55,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_lro.c","type":"ADDED","insertions":479,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_nexus.c","type":"MODIFIED","insertions":16,"deletions":-13},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_sge.c","type":"MODIFIED","insertions":80,"deletions":-13}],"sizeInsertions":632,"sizeDeletions":-28}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}]}