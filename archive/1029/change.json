{"project":"joyent/sdc-vm-agent","branch":"master","id":"I59616277cb6796289d8e391a0a086472be6d31b2","number":"1029","subject":"AGENT-1049 vm-agent blows up when VM is deleted while loading","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/1029","commitMessage":"AGENT-1049 vm-agent blows up when VM is deleted while loading\n","createdOn":1480541122,"lastUpdated":1486094898,"open":false,"status":"MERGED","comments":[{"timestamp":1480541122,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1480541123,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 88945272259b35a228c1b67937247cfccf1fadcd\n    \n    don\u0027t blow up when VM is deleted while loading"},{"timestamp":1480541196,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485908039,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1485911287,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1485982699,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1485987888,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 3."},{"timestamp":1485987889,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 9d5a724526fbdc434fdbb1dd23c6766c4438201c\n    \n    fix copyright"},{"timestamp":1485987933,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485990319,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 4."},{"timestamp":1485990321,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 3e7d3a35e90de6b28dfe9d53436e33a1281989e9\n    \n    address review feedback"},{"timestamp":1485990368,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485990598,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 5."},{"timestamp":1485990599,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 818af32265a559221358a555070555ab40db71ec\n    \n    make it more clear how to clean up from both cases"},{"timestamp":1485990621,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1485990651,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485990929,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1485991569,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 6."},{"timestamp":1485991571,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit e5fede19e8cdc088657aeafcd679fba5d0d3dc19\n    \n    update wording to explain a little more about why we don\u0027t update VMAPI"},{"timestamp":1485991622,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485993015,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1486067456,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1486087223,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1486094898,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Josh Wilsdon"}],"currentPatchSet":{"number":"6","revision":"59616277cb6796289d8e391a0a086472be6d31b2","parents":["bfdd351fd904ee84f5416a35993f44728a27e11b"],"ref":"refs/changes/29/1029/6","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1485991569,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485991622,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485993015,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486067456,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1486087223,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1486094898,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/vm-agent.js","type":"MODIFIED","insertions":90,"deletions":-16}],"sizeInsertions":90,"sizeDeletions":-16},"patchSets":[{"number":"1","revision":"6914d28140935a2587243e97f6f5c041c4869d9b","parents":["bfdd351fd904ee84f5416a35993f44728a27e11b"],"ref":"refs/changes/29/1029/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1480541122,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1480541196,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485908039,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"comments":[{"file":"lib/vm-agent.js","line":276,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Can we add a mention of why we don\u0027t do that?"},{"file":"lib/vm-agent.js","line":276,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"It has been suggested separately that we remove this suggestion and instead focus on what the possible cases are here. Is that acceptable?"},{"file":"lib/vm-agent.js","line":276,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Absolutely."},{"file":"lib/vm-agent.js","line":286,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is VmNotFound a bit confusing? Since the VM was deleted, it would be correct for it to \"not be found\". Maybe \"VmNotTracked\" or something that is more specific to VM agent specifically not having seen that VM would be less confusing?"},{"file":"lib/vm-agent.js","line":286,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I\u0027m not sure \"VmNotTracked\" is more descriptive than VmNotFound... What do you think about VmMissed to indicate that it disappeared before we could load it? The concern I have with NotTracked is that to me it seems to indicate intention. I.e. That we \u0027re not tracking it on purpose (more like do not inventory) rather than we wanted to load it but it disappeared before the load could succeed."},{"file":"lib/vm-agent.js","line":286,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"\"VmMissed\" sounds good to me. Would \"VmCreationMissed\" be even clearer?"},{"file":"lib/vm-agent.js","line":289,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Potential nit: would it make the code clearer to have just one return statement? We have:\n\n\"\nif (doNotInventory()) {\n  loadErr \u003d new Error(...);\n  next(loadErr);\n  return;\n}\n\nif (vmInLastSeen()) {\n} else {\n  loadErr \u003d ...;\n}\n\nnext(loadErr);\nreturn;\n\"\n\nWould it be clearer instead to have the following:\n\"\nif (doNotInventory()) {\n  loadErr \u003d new Error(...);\n} else if (!vmInLastSeen()) {\n  loadErr \u003d ...;\n} else {\n  // set state to destroyed\n}\n\nnext(loadErr);\nreturn;\n\"\n?"},{"file":"lib/vm-agent.js","line":289,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"yep. sure."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/vm-agent.js","type":"MODIFIED","insertions":23,"deletions":-9}],"sizeInsertions":23,"sizeDeletions":-9},{"number":"2","revision":"9a412d712b4d574c9a2d85f678824eb419173661","parents":["bfdd351fd904ee84f5416a35993f44728a27e11b"],"ref":"refs/changes/29/1029/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1485982699,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1480541196,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485908039,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/vm-agent.js","type":"MODIFIED","insertions":23,"deletions":-9}],"sizeInsertions":23,"sizeDeletions":-9},{"number":"3","revision":"ac6186891fd6ed82c638915835ca1ceb28ad9df5","parents":["bfdd351fd904ee84f5416a35993f44728a27e11b"],"ref":"refs/changes/29/1029/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1485987888,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485987933,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/vm-agent.js","type":"MODIFIED","insertions":24,"deletions":-10}],"sizeInsertions":24,"sizeDeletions":-10},{"number":"4","revision":"91be5d19077c75600357a2d2998ec72ba6948029","parents":["bfdd351fd904ee84f5416a35993f44728a27e11b"],"ref":"refs/changes/29/1029/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1485990319,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485990368,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/vm-agent.js","line":271,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Nit: maybe add why we can\u0027t tell VMAPI anything about this VM? My understanding is that it\u0027s because we would overwrite it with incomplete data since the PutVm(s) endpoint overrides data?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/vm-agent.js","type":"MODIFIED","insertions":65,"deletions":-16}],"sizeInsertions":65,"sizeDeletions":-16},{"number":"5","revision":"446558ea8e990f9f5900b4e9b660e5e6af670159","parents":["bfdd351fd904ee84f5416a35993f44728a27e11b"],"ref":"refs/changes/29/1029/5","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1485990598,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485990651,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/vm-agent.js","type":"MODIFIED","insertions":67,"deletions":-16}],"sizeInsertions":67,"sizeDeletions":-16},{"number":"6","revision":"59616277cb6796289d8e391a0a086472be6d31b2","parents":["bfdd351fd904ee84f5416a35993f44728a27e11b"],"ref":"refs/changes/29/1029/6","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1485991569,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485991622,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1486094898,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485993015,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1486087223,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486067456,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/vm-agent.js","type":"MODIFIED","insertions":90,"deletions":-16}],"sizeInsertions":90,"sizeDeletions":-16}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}]}