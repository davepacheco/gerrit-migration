From 7a7dacd6245b4d3565e9ec6f855271c2e22e62d0 Mon Sep 17 00:00:00 2001
From: James Nugent <james@joyent.com>
Date: Thu, 8 Jun 2017 18:58:52 -0500
Subject: [PATCH] OS-6174 Want ability to select admin NIC on boot based on
 available NICs

---
 overlay/generic/lib/svc/method/net-physical | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/overlay/generic/lib/svc/method/net-physical b/overlay/generic/lib/svc/method/net-physical
index 7fbae783..683360d0 100644
--- a/overlay/generic/lib/svc/method/net-physical
+++ b/overlay/generic/lib/svc/method/net-physical
@@ -498,6 +498,18 @@ if smf_is_globalzone; then
     setup_mtu
 
     # Setup admin NIC
+
+    # If there is no NIC with the admin tag, and the config has
+    # admin_nic_autoselect=true, designate the first NIC reported
+    # by dladm for admin use. This is useful in environments where
+    # the NICs are known to change beneath us.
+    if [[ "${CONFIG_admin_nic_autoselect}" == "true" ]] \
+        && ! nictagadm exists admin ; then
+        nictagadm add admin "$(dladm show-phys -m -p -o address | head -n1)"
+        nictagadm list
+        SYSINFO_NIC_admin=$(dladm show-phys -m -p -o link | head -n1)
+    fi
+
     if [[ -z "${SYSINFO_NIC_admin}" ]]; then
         echo "ERROR: admin NIC not found, unable to bring up admin network."
         exit ${SMF_EXIT_ERR_CONFIG}
-- 
2.21.0

