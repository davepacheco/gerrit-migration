From c6524af3dc76aba8bc6e647f4f8fc01afe61e424 Mon Sep 17 00:00:00 2001
From: Marsell Kukuljevic <marsell@joyent.com>
Date: Sat, 11 Feb 2017 21:15:47 +0800
Subject: [PATCH] PUBAPI-1363: AddNic doesn't work properly with fabrics.
 Reviewed by: Trent Mick <trent.mick@joyent.com>

---
 lib/nics.js       | 1 +
 test/common.js    | 2 +-
 test/nics.test.js | 6 +++++-
 3 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/lib/nics.js b/lib/nics.js
index 47a5358..2f8c8a2 100644
--- a/lib/nics.js
+++ b/lib/nics.js
@@ -301,6 +301,7 @@ function addNic(req, res, next) {
         req.sdc.napi.provisionNic(network.uuid, {
             belongs_to_uuid: vmUuid,
             belongs_to_type: 'zone',
+            cn_uuid: serverUuid,
             owner_uuid: ownerUuid,
             state: 'provisioning',
             origin: origin,
diff --git a/test/common.js b/test/common.js
index 9ea766a..7f5f1e9 100644
--- a/test/common.js
+++ b/test/common.js
@@ -57,7 +57,7 @@ var PASSWD = 'secret123';
 var DEFAULT_CFG = path.join(__dirname, '..', '/etc/cloudapi.cfg');
 
 var LOG = new bunyan.createLogger({
-    level: process.env.LOG_LEVEL || 'info',
+    level: process.env.LOG_LEVEL || 'warn',
     name: 'sdccloudapitest',
     stream: process.stderr,
     serializers: restify.bunyan.serializers
diff --git a/test/nics.test.js b/test/nics.test.js
index 5612063..221b1f2 100644
--- a/test/nics.test.js
+++ b/test/nics.test.js
@@ -708,8 +708,11 @@ function removeNic(t, instId, nic) {
     });
 }
 
+
 function waitTilNicDeleted(t, apiPath) {
-    var count = 30;
+    // Sometimes NICs take a very long time to delete due to long-reboot
+    // times that some zones experience
+    var count = 120;
 
     function check() {
         count--;
@@ -1487,6 +1490,7 @@ test('nics', function (tt) {
         });
     });
 
+
     tt.test('  Remove NIC using network pool', function (t) {
         removeNic(t, fixtures.instId, instNic);
     });
-- 
2.21.0

