commit 376fd6a7e0b69e6678372a3e41ca1872cc11a0c2 (refs/changes/52/852/1)
Author: Bryan Cantrill <bryan@joyent.com>
Date:   2016-11-05T05:45:34+00:00 (2 years, 11 months ago)
    
    TOOLS-1602 v8plus dies when C constructors generate exceptions

diff --git a/v8plus_objectwrap.cc b/v8plus_objectwrap.cc
index eadd345..62cd05a 100644
--- a/v8plus_objectwrap.cc
+++ b/v8plus_objectwrap.cc
@@ -234,6 +234,16 @@ v8plus::ObjectWrap::~ObjectWrap()
 	v8plus_module_defn_t *mdp =
 	    reinterpret_cast<v8plus_module_defn_t *>(_defn);
 
+	if (_c_impl == NULL) {
+		/*
+		 * If the pointer is NULL, it means we are in the ObjectWrap
+		 * destructor after the C constructor indicated an exception.
+		 * In this case, we don't call the C destructor -- and indeed
+		 * _defn is uninitialized so we must not attempt to use it.
+		 */
+		return;
+	}
+
 	mdp->vmd_dtor(_c_impl);
 	(void) _objhash.erase(_c_impl);
 }
