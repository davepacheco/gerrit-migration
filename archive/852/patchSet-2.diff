From 9913eb7196e456d87f1caa3c522cd5653c4e4677 Mon Sep 17 00:00:00 2001
From: Bryan Cantrill <bryan@joyent.com>
Date: Sat, 5 Nov 2016 06:09:28 +0000
Subject: [PATCH] TOOLS-1602 v8plus dies when C constructors generate
 exceptions

---
 CHANGES.md           |  5 +++++
 package.json         |  7 ++++---
 v8plus_objectwrap.cc | 10 ++++++++++
 3 files changed, 19 insertions(+), 3 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index ffaf79f..e802ed5 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -1,5 +1,10 @@
 # v8plus Change History
 
+## 1.0.1
+
+A minor bug fix that allows C constructors to indicate an exception without
+inducing a core dump.
+
 ## 1.0.0
 
 This is the first major release of *v8plus*.  Throughout its development
diff --git a/package.json b/package.json
index 9dbe585..2b92e16 100644
--- a/package.json
+++ b/package.json
@@ -1,10 +1,11 @@
 {
-	"author": "Keith M Wesolowski <keith.wesolowski@joyent.com>",
+	"author": "Keith 'The Mayor' Wesolowski <keith.wesolowski@joyent.com>",
 	"name": "v8plus",
 	"description": "utility environment for writing addons in C",
-	"version": "1.0.0",
+	"version": "1.0.1",
 	"contributors": [
-		"Joshua M. Clulow <jmc@joyent.com>"
+		"Joshua M. Clulow <jmc@joyent.com>",
+		"Bryan Cantrill <bryan@joyent.com>"
 	],
 	"repository": {
 		"type": "git",
diff --git a/v8plus_objectwrap.cc b/v8plus_objectwrap.cc
index eadd345..62cd05a 100644
--- a/v8plus_objectwrap.cc
+++ b/v8plus_objectwrap.cc
@@ -234,6 +234,16 @@ v8plus::ObjectWrap::~ObjectWrap()
 	v8plus_module_defn_t *mdp =
 	    reinterpret_cast<v8plus_module_defn_t *>(_defn);
 
+	if (_c_impl == NULL) {
+		/*
+		 * If the pointer is NULL, it means we are in the ObjectWrap
+		 * destructor after the C constructor indicated an exception.
+		 * In this case, we don't call the C destructor -- and indeed
+		 * _defn is uninitialized so we must not attempt to use it.
+		 */
+		return;
+	}
+
 	mdp->vmd_dtor(_c_impl);
 	(void) _objhash.erase(_c_impl);
 }
-- 
2.21.0

