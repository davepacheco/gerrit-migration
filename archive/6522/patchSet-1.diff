From 1194c26ba6c29839e205c9c5294ce4d312e7d02a Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Fri, 28 Jun 2019 20:28:52 +0200
Subject: [PATCH] TRITON-1775 Flexible disk and disks values should be
 displayed on the vm#view page for Bhyve VMs

---
 www/js/components/pages/vm/disks-row.hbs | 16 +++++++
 www/js/components/pages/vm/disks.hbs     | 29 +++++++++++++
 www/js/components/pages/vm/disks.js      | 53 ++++++++++++++++++++++++
 www/js/components/pages/vm/index.jsx     | 30 +++++++++++++-
 4 files changed, 127 insertions(+), 1 deletion(-)
 create mode 100644 www/js/components/pages/vm/disks-row.hbs
 create mode 100644 www/js/components/pages/vm/disks.hbs
 create mode 100644 www/js/components/pages/vm/disks.js

diff --git a/www/js/components/pages/vm/disks-row.hbs b/www/js/components/pages/vm/disks-row.hbs
new file mode 100644
index 00000000..da9729ff
--- /dev/null
+++ b/www/js/components/pages/vm/disks-row.hbs
@@ -0,0 +1,16 @@
+<!--
+    This Source Code Form is subject to the terms of the Mozilla Public
+    License, v. 2.0. If a copy of the MPL was not distributed with this
+    file, You can obtain one at http://mozilla.org/MPL/2.0/.
+-->
+
+<!--
+    Copyright 2019 Joyent, Inc.
+-->
+<td></td>
+<td>{{uuid}}</td>
+<td>{{size}}</td>
+<td>{{pci_slot}}</td>
+<td>{{boot}}</td>
+<td>{{model}}</td>
+<td></td>
diff --git a/www/js/components/pages/vm/disks.hbs b/www/js/components/pages/vm/disks.hbs
new file mode 100644
index 00000000..af278515
--- /dev/null
+++ b/www/js/components/pages/vm/disks.hbs
@@ -0,0 +1,29 @@
+
+<!--
+    This Source Code Form is subject to the terms of the Mozilla Public
+    License, v. 2.0. If a copy of the MPL was not distributed with this
+    file, You can obtain one at http://mozilla.org/MPL/2.0/.
+-->
+
+<!--
+    Copyright 2019 Joyent, Inc.
+-->
+
+<h3>Disks</h3>
+
+<table class="table">
+  <thead>
+    <tr>
+      <th style="width: 20px"></th>
+      <th>Disk</th>
+      <th style="width: 120px;">size</th>
+      <th style="width: 120px;">pci_slot</th>
+      <th style="width: 120px;">boot</th>
+      <th style="width: 120px;">model</th>
+      <th></th>
+    </tr>
+  </thead>
+
+  <tbody></tbody>
+
+</table>
diff --git a/www/js/components/pages/vm/disks.js b/www/js/components/pages/vm/disks.js
new file mode 100644
index 00000000..e361ba07
--- /dev/null
+++ b/www/js/components/pages/vm/disks.js
@@ -0,0 +1,53 @@
+
+/*
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+/*
+ * Copyright 2019 Joyent, Inc.
+ */
+
+var Backbone = require('backbone');
+var Disks = Backbone.Collection.extend({});
+
+var DiskRowTemplate = require('./disks-row.hbs');
+var DiskRow = Backbone.Marionette.ItemView.extend({
+    tagName: 'tr',
+    template: DiskRowTemplate,
+    events: {
+    },
+    initialize: function (options)  {
+        // Override list initialization
+    }
+});
+
+var DisksView = Backbone.Marionette.CompositeView.extend({
+    template: require('./disks.hbs'),
+    itemView: DiskRow,
+    itemViewContainer: 'tbody',
+    attributes: {
+        id: 'vm-discs'
+    },
+    events: {
+    },
+
+    initialize: function (options)  {
+        this.vm = options.vm;
+        this.collection = new Disks(this.vm.get('disks'));
+    },
+
+    templateHelpers: function() {
+        var self = this;
+        return {
+            disks: function() {
+                return self.collection;
+            }
+        };
+    },
+
+});
+
+
+module.exports = DisksView;
diff --git a/www/js/components/pages/vm/index.jsx b/www/js/components/pages/vm/index.jsx
index 196cea95..288d0d1b 100644
--- a/www/js/components/pages/vm/index.jsx
+++ b/www/js/components/pages/vm/index.jsx
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 'use strict';
@@ -33,6 +33,7 @@ var FWRulesList = require('./fwrules-list');
 var FWRulesForm = require('./fwrules-form');
 var SnapshotsList = require('./snapshots');
 var NicsList = require('./nics');
+var DisksList = require('./disks');
 
 
 var Metadata =  require('./metadata');
@@ -120,6 +121,8 @@ var VMPage = React.createClass({
             quota = vm.quota;
         }
 
+        var flexible_disk_size = vm.flexible_disk_size ? vm.flexible_disk_size/1024 : null;
+
         var ips;
         if (vm.nics.length) {
             ips = vm.nics.map(function (nic) {
@@ -220,6 +223,20 @@ var VMPage = React.createClass({
                                 </td>
                             </tr>
 
+                            {vm.brand === 'bhyve' ?
+                            <tr>
+                                <th>Flexible Disk</th>
+                                <td>
+                                    <span className="vm-flexible-disk">
+                                        <div className="vm-disk-quota-kvm">
+                                            {flexible_disk_size} GB
+                                        </div>
+                                    </span>
+                                </td>
+                            </tr>
+                            : null
+                            }
+
                             <tr>
                               <th>IP Addresses</th>
                               <td>
@@ -337,6 +354,17 @@ var VMPage = React.createClass({
                 </div>
             </section>
 
+            {vm.brand === 'kvm' || vm.brand === 'bhyve' ?
+            <section>
+                <div className="row">
+                    <div className="col-md-12">
+                        <div className="disks-region">
+                            <BB view={new DisksList({vm: new VMModel(this.state.vm)})} />
+                        </div>
+                    </div>
+                </div>
+            </section>
+            : null }
 
             <section>
                 <div className="row">
-- 
2.21.0

