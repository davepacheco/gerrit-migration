From 6045f20f33087992596d7b2e1759cd32e68df1b8 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Wed, 7 Jun 2017 09:50:05 -0700
Subject: [PATCH] MON-362 test-amon failure: "could not determie the
 sdc-smartos image UUID" Reviewed by: Julien Gilli <julien.gilli@joyent.com>
 Approved by: Julien Gilli <julien.gilli@joyent.com>

---
 test/prep.js | 26 ++++++++++++--------------
 1 file changed, 12 insertions(+), 14 deletions(-)

diff --git a/test/prep.js b/test/prep.js
index 6744f93..58e9a9e 100644
--- a/test/prep.js
+++ b/test/prep.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /**
@@ -55,7 +55,7 @@ var ufdsClient;
 var amontestzone; // the test zone to use
 var headnodeUuid;
 var amonZoneUuid;
-var smartosImageUuid;
+var testImageUuid;
 var externalNetworkUuid;
 var testPackageUuid;
 var gzIp;
@@ -276,20 +276,18 @@ function getHeadnodeUuid(next) {
 }
 
 
-function getSmartosDatasetUuid(next) {
-    // No DSAPI in the DC yet, so hack it.
-    log('# Get "smartos" image UUID.');
-    exec('ls -1 /usbkey/datasets/sdc-smartos-*.*manifest | head -n1 '
-                    + '| xargs cat | json uuid',
-             function (err, stdout, stderr) {
+function getTestImageUuid(next) {
+    log('# Get a test image UUID (use the latest "amon" image origin)');
+    exec('sdc-imgadm list name=amon --latest -j | json 0.origin',
+            function (err, stdout, stderr) {
         if (err) {
             return next(err);
         }
-        smartosImageUuid = stdout.trim();
-        if (!smartosImageUuid) {
-            next(new Error('could not determie the sdc-smartos image UUID'));
+        testImageUuid = stdout.trim();
+        if (!testImageUuid) {
+            next(new Error('could not find a test image UUID'));
         }
-        log('# "smartos" dataset UUID is "%s".', smartosImageUuid);
+        log('# testImageUuid: %s', testImageUuid);
         next();
     });
 }
@@ -347,7 +345,7 @@ function createAmontestzone(next) {
         log('# Create a test zone for ulrich.');
         vmapiClient.createVm({
                 owner_uuid: ulrich.uuid,
-                image_uuid: smartosImageUuid,
+                image_uuid: testImageUuid,
                 server_uuid: headnodeUuid,
                 brand: 'joyent',
                 billing_id: testPackageUuid,
@@ -455,7 +453,7 @@ async.series([
         ldapClientUnbind,
         ufdsClientUnbind,
         getHeadnodeUuid,
-        getSmartosDatasetUuid,
+        getTestImageUuid,
         getExternalNetworkUuid,
         getTestPackageUuid,
         createAmontestzone,
-- 
2.21.0

