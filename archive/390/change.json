{"project":"joyent/sdcadm","branch":"master","id":"Ie98ed967f1662f002126cf8e0c996f2255578995","number":"390","subject":"TOOLS-1538 sdcadm should not throw ENOENT when checking for sdc-usbkey Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/390","commitMessage":"TOOLS-1538 sdcadm should not throw ENOENT when checking for sdc-usbkey\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nReviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\n","createdOn":1472623454,"lastUpdated":1473183449,"open":false,"status":"MERGED","comments":[{"timestamp":1472623454,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1472623492,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1472623674,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1472623726,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1472623777,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3."},{"timestamp":1472623819,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1472664780,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3: Code-Review+1\n\nThis looks okay.  There\u0027s a lot of duplicated, non-trivial code.  It seems like it might be useful to have a utility function to abstract the common pattern of checking for tool A to do something, using tool A if it\u0027s there, but falling back to tool B if it\u0027s not."},{"timestamp":1472740830,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\n\u003e This looks okay.  There\u0027s a lot of duplicated, non-trivial code. \n \u003e It seems like it might be useful to have a utility function to\n \u003e abstract the common pattern of checking for tool A to do something,\n \u003e using tool A if it\u0027s there, but falling back to tool B if it\u0027s not.\n\nDefinitely! This is mostly a workaround to try to avoid fs.exists, which is deprecated\nin upcoming node versions. I\u0027ve been wondering about a similar function which would\nuse fs.stat, and return the stat object only when the file exists. Something like\nthe following:\n\n                function fsStatIfExists(fname, cb) {\n                    var stat;\n\n                    fs.stat(fname, function (er, st) {\n                        if (er) {\n                            if (er.code \u003d\u003d\u003d \u0027ENOENT\u0027) {\n                                cb();\n                            } else {\n                                cb(er);\n                            }\n                            return;\n                        }\n                        if (st.isFile()) {\n                            stat \u003d st;\n                        }\n\n                        cb(null, stat);\n                    });\n                }\n\nThoughts?"},{"timestamp":1472746766,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n\u003e fsStatIfExists\n\nSure, or just a fsExists utility that looks just like `fs.exists` or perhaps with a callback signature like `function (err, exists)` where the `err` is always null. I.e. more what the original deprecating ticket wanted. Any of the three would be an improvment. :)"},{"timestamp":1472834177,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1472834233,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1473175724,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1473178460,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1473178674,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 6:\n\n\u003e Uploaded patch set 6: Commit message was updated.\n\nI already checked that it\u0027s fine for IA testing just by renaming sdc-usbkey to something else. Example output of such update at the JIRA issue.\n\nI\u0027ve also opened a new issue https://devhub.joyent.com/jira/browse/TOOLS-1543 to add the mentioned utility function using fs stat to check when a file exists. The reason for a separated issue is that I think we should also replace all the occurrences of `fs.exists` with such thing."},{"timestamp":1473183124,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1473183449,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"6","revision":"e98ed967f1662f002126cf8e0c996f2255578995","parents":["333d1f70b553e9c5b0fadd5a32b297a76a18748d"],"ref":"refs/changes/90/390/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1473178460,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472623819,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1472664780,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1473183124,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1473183449,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":33,"deletions":-9}],"sizeInsertions":33,"sizeDeletions":-9},"patchSets":[{"number":"1","revision":"9270a13eea4a20ae0a1c040d6db77deefbeed482","parents":["ae70eb1382c3c613c83d1f51500440b1e932494c"],"ref":"refs/changes/90/390/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1472623454,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1472623492,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/common.js","line":1344,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: missing semicolon"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":31,"deletions":-8}],"sizeInsertions":31,"sizeDeletions":-8},{"number":"2","revision":"bd730951069ec168cbbe4fb490b0d40069e4408a","parents":["ae70eb1382c3c613c83d1f51500440b1e932494c"],"ref":"refs/changes/90/390/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1472623674,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472623726,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":31,"deletions":-8}],"sizeInsertions":31,"sizeDeletions":-8},{"number":"3","revision":"e43f5e6d7ae1d81ec4fa96596f5739c698b70ab2","parents":["ae70eb1382c3c613c83d1f51500440b1e932494c"],"ref":"refs/changes/90/390/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1472623777,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1472664780,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472623819,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":33,"deletions":-9}],"sizeInsertions":33,"sizeDeletions":-9},{"number":"4","revision":"fcc15409f996c0ed803718cdaddcf821494f3315","parents":["28cfd7326210e57a2eba8a01f662c04898c11d3d"],"ref":"refs/changes/90/390/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1472834177,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1472664780,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472623819,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":33,"deletions":-9}],"sizeInsertions":33,"sizeDeletions":-9},{"number":"5","revision":"4925693adc97490f1f55f560133438764ed7a2cb","parents":["333d1f70b553e9c5b0fadd5a32b297a76a18748d"],"ref":"refs/changes/90/390/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1473175724,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1472664780,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472623819,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":33,"deletions":-9}],"sizeInsertions":33,"sizeDeletions":-9},{"number":"6","revision":"e98ed967f1662f002126cf8e0c996f2255578995","parents":["333d1f70b553e9c5b0fadd5a32b297a76a18748d"],"ref":"refs/changes/90/390/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1473178460,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1472664780,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1473183124,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472623819,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1473183449,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":33,"deletions":-9}],"sizeInsertions":33,"sizeDeletions":-9}],"allReviewers":[{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}