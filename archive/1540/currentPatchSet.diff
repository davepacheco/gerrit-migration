From 4be75d0b8468fd70b75b05a8cb9a0aeffce3eca6 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Mon, 20 Feb 2017 17:07:59 +0100
Subject: [PATCH] WORKFLOW-214 node-workflow tests broken since WORKFLOW-205

---
 README.md                  | 11 ++++++-----
 test/helper.js             | 27 +++++++++++++--------------
 test/moray-backend.test.js | 21 +++++++++------------
 3 files changed, 28 insertions(+), 31 deletions(-)

diff --git a/README.md b/README.md
index 0ed1207..b159f5d 100644
--- a/README.md
+++ b/README.md
@@ -5,7 +5,7 @@
 -->
 
 <!--
-    Copyright (c) 2016, Joyent, Inc.
+    Copyright 2017 Joyent, Inc.
 -->
 
 # node-workflow-moray-backend
@@ -256,7 +256,7 @@ properly loading the module on init.
 
 ## Issues
 
-See [node-workflow issues](https://github.com/kusor/node-workflow/issues) for
+See [node-workflow issues](https://github.com/joyent/node-workflow/issues) for
 general workflow issues, and visit [SDC](http://github.com/joyent/sdc) or
 [Manta](http://github.com/joyent/manta) specific issues.
 
@@ -286,7 +286,8 @@ or for extra verbosity:
         pre text NOT NULL,
         post text NOT NULL,
         options text,
-        mtime timestamp without time zone DEFAULT now() NOT NULL
+        mtime timestamp without time zone DEFAULT now() NOT NULL,
+        reindex_active text
     );
 
 
@@ -295,7 +296,7 @@ or for extra verbosity:
     [root@headnode (coal) ~] sdc-login moray
     [root@... (coal:moray0) ~]# cd /opt/smartdc/moray/
     [root@... (coal:moray0) /opt/smartdc/moray]# cp etc/config.json etc/config.test.json
-    [root@... (coal:moray0) /opt/smartdc/moray]# cp smf/manifests/moray.xml smf/manifests/moray-test.xml
+    [root@... (coal:moray0) /opt/smartdc/moray]# cp smf/manifests/moray-2021.xml smf/manifests/moray-test.xml
 
 Then, you need to modify SMF to make this moray test instance to use our `moray_test` db
 and listen into a different port:
@@ -377,7 +378,7 @@ COAL this means your moray URL will be `http://10.99.99.17:2222`.
 
 ## LICENSE
 
-Copyright (c) 2014, Joyent, Inc.
+Copyright 2017 Joyent, Inc.
 
 This Source Code Form is subject to the terms of the Mozilla Public
 License, v. 2.0. If a copy of the MPL was not distributed with this
diff --git a/test/helper.js b/test/helper.js
index 0155ce3..385c511 100644
--- a/test/helper.js
+++ b/test/helper.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017 Joyent, Inc.
  */
 
 var path = require('path'),
@@ -21,20 +21,19 @@ module.exports = {
         if (!config) {
             config = JSON.parse(fs.readFileSync(cfg_file, 'utf-8'));
         }
-        config.extra_fields = {
-            wf_jobs: {
-                foo: {
-                    type: 'string',
-                    index: true,
-                    unique: false
-                },
-                bar: {
-                    type: 'string',
-                    index: true,
-                    unique: false
-                }
-            }
+        config.backend.opts.extra_fields.wf_jobs.foo = {
+            type: 'string',
+            index: true,
+            unique: false
         };
+        config.backend.opts.extra_fields.wf_jobs.bar = {
+            type: 'string',
+            index: true,
+            unique: false
+        };
+
+        config.api.job_extra_params.push('foo');
+        config.api.job_extra_params.push('bar');
         return config;
     }
 };
diff --git a/test/moray-backend.test.js b/test/moray-backend.test.js
index 43d71a2..2bfc85c 100644
--- a/test/moray-backend.test.js
+++ b/test/moray-backend.test.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright 2017 Joyent, Inc.
  */
 
 var test = require('tap').test,
@@ -65,7 +65,6 @@ test('buckets created', function (t) {
         backend.client.getBucket(bu, function (err, bucket) {
             t.ifError(err);
             t.ok(bucket);
-            // console.log(util.inspect(bucket, false, 8, true));
         });
     });
     t.end();
@@ -173,8 +172,8 @@ test('create job', function (t) {
     factory.job({
         workflow: aWorkflow.uuid,
         target: '/foo/bar',
+        foo: 'bar',
         params: {
-            foo: 'bar',
             chicken: 'arise!'
         },
         locks: 'something$'
@@ -203,8 +202,8 @@ test('duplicated job target', function (t) {
     factory.job({
         workflow: aWorkflow.uuid,
         target: '/foo/bar',
+        foo: 'bar',
         params: {
-            foo: 'bar',
             chicken: 'arise!'
         }
     }, function (err, job) {
@@ -218,8 +217,8 @@ test('locked job target', function (t) {
     factory.job({
         workflow: aWorkflow.uuid,
         target: '/foo/something',
+        foo: 'bar',
         params: {
-            foo: 'bar',
             chicken: 'arise!'
         }
     }, function (err, job) {
@@ -234,8 +233,8 @@ test('job with different params', function (t) {
     factory.job({
         workflow: aWorkflow.uuid,
         target: '/foo/bar',
+        foo: 'bar',
         params: {
-            foo: 'bar',
             chicken: 'egg'
         }
     }, function (err, job) {
@@ -401,8 +400,8 @@ test('unlocked job target', function (t) {
     factory.job({
         workflow: aWorkflow.uuid,
         target: '/foo/something',
+        foo: 'bar',
         params: {
-            foo: 'bar',
             chicken: 'arise!'
         }
     }, function (err, job) {
@@ -582,11 +581,9 @@ test('get all jobs searching by params', function (t) {
 });
 
 
-test('get some jobs searching by params', function (t) {
+test('get all jobs searching by invalid params', function (t) {
     backend.getJobs({foo: 'bar', chicken: 'arise!'}, function (err, jobs) {
-        t.ifError(err, 'get all jobs error');
-        t.ok(jobs, 'jobs ok');
-        t.equal(jobs.length, 2);
+        t.ok(err, 'get jobs with unexpected params');
         t.end();
     });
 });
@@ -727,8 +724,8 @@ test('WORKFLOW-180: job failed with error object', function (t) {
         factory.job({
             workflow: workflow.uuid,
             target: '/foo/baz',
+            foo: 'foo',
             params: {
-                foo: 'foo',
                 chicken: 'egg'
             }
         }, function (err2, aJob) {
-- 
2.21.0

