From 493c2681cf880c46ec76857aad1bc80af4075638 Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Thu, 12 Apr 2018 04:09:26 +0000
Subject: [PATCH] TRITON-183 Server NICs in NAPI cannot have "underlay" updated
 to "true" Reviewed by: Nick Zivkovic <nick.zivkovic@joyent.com> Approved by:
 Nick Zivkovic <nick.zivkovic@joyent.com>

---
 lib/models/nic/common.js         |  2 +-
 lib/models/nic/update.js         |  1 +
 test/integration/fabrics.test.js | 43 +++++++++++++++++++++++++++++++-
 3 files changed, 44 insertions(+), 2 deletions(-)

diff --git a/lib/models/nic/common.js b/lib/models/nic/common.js
index 71f4c7e..4ec7a2a 100644
--- a/lib/models/nic/common.js
+++ b/lib/models/nic/common.js
@@ -427,7 +427,7 @@ function validateUnderlayServer(opts, params, _parsedParams, callback) {
     if (params.belongs_to_type !== undefined) {
         belongs_to_type = params.belongs_to_type;
     } else {
-        belongs_to_type = opts.existingNic.belongs_to_type;
+        belongs_to_type = opts.existingNic.params.belongs_to_type;
     }
     if (params.underlay && belongs_to_type !== 'server') {
         callback(errors.invalidParam('underlay',
diff --git a/lib/models/nic/update.js b/lib/models/nic/update.js
index 0688761..a45e7eb 100644
--- a/lib/models/nic/update.js
+++ b/lib/models/nic/update.js
@@ -55,6 +55,7 @@ var UPDATE_PARAMS = [
     'primary',
     'reserved',
     'state',
+    'underlay',
     'vlan_id'
 ];
 
diff --git a/test/integration/fabrics.test.js b/test/integration/fabrics.test.js
index cc2f31f..4339e50 100644
--- a/test/integration/fabrics.test.js
+++ b/test/integration/fabrics.test.js
@@ -859,7 +859,8 @@ test('provision server nics', function (t) {
         });
     });
 
-    t.test('REAL_NETS[0]: fail to provision underlay NIC', function (t2) {
+    t.test('REAL_NETS[0]: fail to provision underlay NIC (bad belongs_to_type)',
+        function (t2) {
         mod_nic.provision(t2, {
             fillInMissing: true,
             net: REAL_NETS[0].uuid,
@@ -951,6 +952,46 @@ test('provision server nics', function (t) {
 });
 
 
+test('Convert normal server NIC into underlay NIC', function (t) {
+    var server = mod_uuid.v4();
+    var nic;
+
+    t.test('Provision server NIC', function (t2) {
+        mod_nic.provision(t2, {
+            fillInMissing: true,
+            net: REAL_NETS[0].uuid,
+            params: {
+                belongs_to_type: 'server',
+                belongs_to_uuid: server,
+                owner_uuid: ADMIN_OWNER
+            },
+            exp: mod_net.addNetParams(REAL_NETS[0], {
+                belongs_to_type: 'server',
+                belongs_to_uuid: server,
+                owner_uuid: ADMIN_OWNER
+            })
+        });
+    });
+
+    t.test('Update server NIC to underlay=true', function (t2) {
+        nic = mod_nic.lastCreated();
+        t.ok(nic, 'have last created nic');
+        t.ok(!nic.underlay, 'nic is not underlay=true');
+
+        mod_nic.update(t2, {
+            mac: nic.mac,
+            ignore: [ 'modified_timestamp' ],
+            params: {
+                underlay: true
+            },
+            exp: mod_jsprim.mergeObjects(nic, {
+                underlay: true
+            })
+        });
+    });
+});
+
+
 test('provision zone nics', function (t) {
 
     var nicTags = [
-- 
2.21.0

