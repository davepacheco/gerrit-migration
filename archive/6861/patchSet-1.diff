From 4e9ee900bd97bd1657dccc3a529751372b4c4b7d Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Mon, 2 Sep 2019 09:53:17 +0000
Subject: [PATCH] OS-7977 -fno-shrink-wrap shouldn't be specified for gcc4
 build

---
 Makefile | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/Makefile b/Makefile
index e478192..cee6818 100644
--- a/Makefile
+++ b/Makefile
@@ -108,7 +108,6 @@ KERNEL_CFLAGS = \
 	$(ALWAYS_CFLAGS) \
 	-m64 \
 	-mcmodel=kernel \
-	-fno-shrink-wrap \
 	-g \
 	-O \
 	-fno-inline \
@@ -119,6 +118,14 @@ KERNEL_CFLAGS = \
 	-std=gnu99 \
 	-mno-red-zone
 
+#
+# Fix fbt entry probes.
+#
+ifneq ($(PRIMARY_COMPILER_VER),4)
+KERNEL_CFLAGS += \
+	-fno-shrink-wrap
+endif
+
 USER_CFLAGS = \
 	-finline \
 	-gdwarf-2 \
-- 
2.21.0

